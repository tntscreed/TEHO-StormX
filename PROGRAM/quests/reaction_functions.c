
ref		sld, rCharacter;
int     iTemp, i; // нужно для вычислений любых целых (нации)
float   locx, locy, locz;
string  sTemp; // любые строки для вычислений
bool    bOk;

/////////////////////////////////////////////////////////////////////////////////////////////////////////
////  разное с оптимизации   начало
/////////////////////////////////////////////////////////////////////////////////////////////////////////

//освободить флаг на дачу миниквестов
void SmallQuests_free(string qName)
{
	pchar.questTemp.different = "free";
}
//вернуть тип губернаторов обратно в sit после боевки
void MayorSitBack(string qName) 
{
	iTemp = GetCharacterIndex(Pchar.quest.MayorSitBack.mayorId)
	if (iTemp > 0)
	{
		sld = &characters[iTemp];
		sld.location = Pchar.quest.MayorSitBack.locationName;
		sld.location.group = "sit";
		sld.location.locator = Pchar.quest.MayorSitBack.locatorName;
		LAi_SetHuberTypeNoGroup(sld);
		RemoveCharacterEquip(sld, BLADE_ITEM_TYPE);
		RemoveCharacterEquip(sld, GUN_ITEM_TYPE);
	}
}

void SeekShip_Stay(string qName)
{
	sld = &characters[sti(pchar.quest.(qName).Idx)];
	LAi_SetStayType(sld);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////
////  разное с оптимизации   конец
/////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////
///------------------------------------------Макроквесты------------------------------------------------
/////////////////////////////////////////////////////////////////////////////////////////////////////////

///----------------------------Голландский Гамбит, часть 1 - за Голландию-------------------------------

//--------------------------------------------1 задание-----------------------------------------------
void HWICofficerTalk(string qName)//говорилка офицера
{
	sld = characterFromId("HWIC_officer");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void HWICofficerTalkReturn(string qName)//возврат говорилки
{
	pchar.quest.HWIC_officer.win_condition.l1 = "location";
	pchar.quest.HWIC_officer.win_condition.l1.location = "Villemstad_houseS3";
	pchar.quest.HWIC_officer.function = "HWICofficerTalk";
}

void Create_Baltazar()//создание торговца
{
	AddQuestRecord("Holl_Gambit", "1-1");
	ReOpenQuestHeader("Holl_Gambit"); // лесник чтобы вышел из архива																					  
	SetFunctionTimerCondition("Create_BaltazarOver", 0, 0, 2, false); //таймер
	sld = GetCharacter(NPC_GenerateCharacter("Baltazar", "trader_2", "man", "man", 5, HOLLAND, -1, true, "quest"));
	FantomMakeSmallSailor(sld, SHIP_FLEUT, "", CANNON_TYPE_CANNON_LBS12, 10+rand(5), 10+rand(5), 10+rand(5), 10+rand(5), 15+rand(5));
    SetFantomParamFromRank(sld, 5, true); 
	sld.name = "Baltazar";
	sld.lastname = "Ridderbok";
	sld.greeting = "captain_trader";
	sld.AnalizeShips = true;
	SetCharacterGoods(sld, GOOD_FOOD, 222);
	SetCharacterGoods(sld, GOOD_SUGAR, 1600);
	LAi_SetCitizenType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_portoffice", "goto", "goto1");
	sld.dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
	sld.dialog.currentnode = "Baltazar";
}

void Create_BaltazarOver(string qName)//не пошли на стрелку - ждать никто не будет
{
	AddQuestRecord("Holl_Gambit", "1-2");
	CloseQuestHeader("Holl_Gambit");
	sld = characterFromId("Baltazar");
	LAi_CharacterDisableDialog(sld); // 170712
	sld.lifeday = 0;
	DeleteAttribute(pchar, "questTemp.HWIC.Holl");//еще можно взять иные варианты
	pchar.questTemp.HWIC.Fail1 = "true";
}

void Baltazar_ConvoyOver(string qName)//опоздали
{
	pchar.quest.BaltazarConvoy_fail.over = "yes";//снять прерывание
	AddQuestRecord("Holl_Gambit", "1-4");
	CloseQuestHeader("Holl_Gambit");
	sld = characterFromId("Baltazar");
	RemoveCharacterCompanion(Pchar, characterFromID("Baltazar"));
	sld.lifeday = 0;
	DeleteAttribute(pchar, "questTemp.HWIC.Holl");//еще можно взять иные варианты
	pchar.questTemp.HWIC.Fail1 = "true";
}

void Baltazar_fail(string qName)//утонул Бальтазар
{
	pchar.quest.Baltazar_ConvoyOver.over = "yes";//снять прерывание
	if (CheckAttribute(pchar, "questTemp.HWIC.Holl.BaltazarAttack")) pchar.quest.BaltazarConvoy_Attack.over = "yes";//снять прерывание, если не было атаки
	AddQuestRecord("Holl_Gambit", "1-5");
	CloseQuestHeader("Holl_Gambit");
	ChangeCharacterComplexReputation(pchar,"nobility", -2); 
	ChangeCharacterNationReputation(pchar, HOLLAND, -2);
	ChangeOfficersLoyality("bad_all", 1);
	DeleteAttribute(pchar, "questTemp.HWIC.Holl");//еще можно взять иные варианты
	pchar.questTemp.HWIC.Fail1 = "true";
}

void Baltazar_complete(string qName)//прибыли в порт
{
	pchar.quest.Baltazar_ConvoyOver.over = "yes";//снять прерывание
	pchar.quest.BaltazarConvoy_fail.over = "yes";//снять прерывание
	chrDisableReloadToLocation = true;
	bDisableFastReload = true;
	RemoveCharacterCompanion(Pchar, characterFromID("Baltazar"));
	GetCharacterPos(pchar, &locx, &locy, &locz);
	sld = characterFromId("Baltazar");
	sld.lifeday = 0;
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "Marigo_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	sld.dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
	sld.dialog.currentnode = "Baltazar_5";
	sld.greeting = "captain_complete_1";
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	AddComplexSeaExpToScill(50, 50, 50, 0, 50, 0, 0);
	AddCharacterExpToSkill(pchar, "Fortune", 30);//везение
}

void BaltazarPirateGlobalCreate()//на глобальной карте
{
    ref sld;
    string sCapId = "FollowerHWIC0"; // patch
    string sGroup = "Sea_" + sCapId + "1";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	SelectLevelWarShipParameter();//автолевеллинг
    for (int i = 1; i <= 2; i++)
    {
        sld = GetCharacter(NPC_GenerateCharacter(sCapId + i, "mercen_"+(rand(27)+1), "man", "man", sti(PChar.rank)+MOD_SKILL_ENEMY_RATE/2, PIRATE, 10, true, "hunter"));
		SetRandomNameToCharacter(sld);
		SetRandomNameToShip(sld);
		if (i == 1)
		{
			sld.name = "" + GetName( NAMETYPE_ORIG, pchar.questTemp.HWIC.Holl.PirateName, NAME_NOM) + "";
			sld.lastname = "";
		}
		sld.Ship.Type = GenerateShipExt(iGlobalTemp, 1, sld);
		SetBaseShipData(sld);
		int hcrew = GetMaxCrewQuantity(sld);
		SetCrewQuantity(sld, hcrew);
		SetCrewQuantityFull(sld);
        sld.AlwaysEnemy = true;
        sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
        sld.mapEnc.type = "war";
		sld.mapEnc.worldMapShip = "quest_ship";
        sld.mapEnc.Name = "" + GetName( NAMETYPE_ORIG, pchar.questTemp.HWIC.Holl.PirateName, NAME_NOM) + "";
        Group_AddCharacter(sGroup, sCapId + i);
    }
    Group_SetGroupCommander(sGroup, sCapId+ "1");
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
	Map_CreateCoolWarrior("", sCapId + "1", 10);
}

void BaltazarPirateSeaCreate(string qName)//на боевой карте
{
	ref sld;
	DeleteAttribute(pchar, "questTemp.HWIC.Holl.BaltazarAttack");
	Island_SetReloadEnableGlobal("SentMartin", false);//на остров нельзя
	bQuestDisableMapEnter = true;//и на карту тоже нельзя
	Group_FindOrCreateGroup("Baltazar_Attack");
	SelectLevelWarShipParameter();//автолевеллинг
    for (int i = 1; i <= 2; i++)
    {
        sld = GetCharacter(NPC_GenerateCharacter("BaltPirate_"+i, "mercen_"+(rand(27)+1), "man", "man", sti(PChar.rank)+MOD_SKILL_ENEMY_RATE/2, PIRATE, 10, true, "hunter"));
		FantomMakeSmallSailor(sld, iGlobalTemp, "", iTotalTemp, 10+rand(5), 10+rand(5), 10+rand(5), 10+rand(5), 15+rand(5));
		FantomMakeCoolFighter(sld, sti(PChar.rank)+MOD_SKILL_ENEMY_RATE/2, 30, 30, sTotalTemp, "pistol2", "grapeshot", 30);
		if (i == 1)
		{
			sld.name = "" + GetName( NAMETYPE_ORIG, pchar.questTemp.HWIC.Holl.PirateName, NAME_NOM) + "";
			sld.lastname = "";
		}
        sld.AlwaysEnemy = true;
        sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
        Group_AddCharacter("Baltazar_Attack", "BaltPirate_"+i);
    }
    Group_SetGroupCommander("Baltazar_Attack", "BaltPirate_1");
	Group_SetTaskAttack("Baltazar_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("Baltazar_Attack", PLAYER_GROUP);
	Group_SetAddress("Baltazar_Attack", "SentMartin", "", "");
	Group_LockTask("Baltazar_Attack");
    
    pchar.quest.BaltazarAttack_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.BaltazarAttack_AfterBattle.win_condition.l1.group = "Baltazar_Attack";
	pchar.quest.BaltazarAttack_AfterBattle.function = "Baltazar_Attack_AfterBattle";
}

void Baltazar_Attack_AfterBattle(string qName)//после боя
{
	Island_SetReloadEnableGlobal("SentMartin", true);
	bQuestDisableMapEnter = false;
	DoQuestCheckDelay("sea_victory", 1.5);
}

//------------------------------------------1а задание---------------------------------------------
void SantiagoTripOver(string qName)//просрочили - значит, присвоили сундуки, примерно накажем
{
	AddQuestRecord("Holl_Gambit", "1-47");
	CloseQuestHeader("Holl_Gambit");
	ChangeCharacterComplexReputation(pchar, "nobility", -10);
	ChangeCharacterHunterScore(PChar, "holhunter", 100); //начислить НЗГ
	ChangeCharacterHunterScore(PChar, "spahunter", 100); //начислить НЗГ
	DeleteAttribute(pchar, "questTemp.HWIC.Holl");//еще можно взять иные варианты
	pchar.questTemp.HWIC.Fail1 = "true";
}

void SantiagoTrip_Attack(string qName)//подкраулили
{
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	LAi_LocationFightDisable(&Locations[FindLocation("Santiago_town")], true); // Addon 2016-1 Jason пиратская линейка
	int iRank = 12+MOD_SKILL_ENEMY_RATE/2;
	int iScl = 20+MOD_SKILL_ENEMY_RATE*2;
	sld = GetCharacter(NPC_GenerateCharacter("SantiagoEnemy1", "mercen_10", "man", "man", iRank, SPAIN, -1, true, "quest"));
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_06", "pistol1", "bullet", iScl);
	sld.dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
	sld.dialog.currentnode = "Santiago_Trip";
	sld.greeting = "hambit_other_1";
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	LAi_SetActorType(sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "Santiago_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void SantiagoTripInHouse(string qName)//телепорт
{
	LAi_LocationFightDisable(&Locations[FindLocation("Santiago_town")], false); // Addon 2016-1 Jason пиратская линейка
	bDisableFastReload = false;
	pchar.GenQuestBox.Santiago_HouseSp2_Room = true;
	pchar.GenQuestBox.Santiago_HouseSp2_Room.box1.items.slave_01 = 1;
	pchar.GenQuestBox.Santiago_HouseSp2_Room.box1.items.potion1 = 2;
	DoQuestReloadToLocation("Santiago_HouseSp2_Room", "barmen", "bar2", "SantiagoTripTalkToMC");
	LocatorReloadEnterDisable("Santiago_HouseSp2_Room", "reload1", true);//закрыть выход
	//обчистим карманы ГГ
	ref location = &Locations[FindLocation("Santiago_HouseSp2")];
	aref arItems, boxItems;
	ref rItem, sld;
	string sName;
	makearef(arItems, PChar.items);
	makearef(boxItems, location.box1.items);
	int iItemsNum = GetAttributesNum(arItems);
	for(int i=0; i<iItemsNum; i++)
	{
		sName = GetAttributeName(GetAttributeN(arItems, i));
		rItem = ItemsFromID(sName);
		if (rItem.ItemType != "QUESTITEMS")
		{
			boxItems.(sName) = PChar.items.(sName);
		}
	}
	location.box1.money = sti(PChar.money);	
	location.box1 = Items_MakeTime(GetTime(), GetDataDay(), GetDataMonth(), GetDataYear());
	RemoveAllCharacterItems(PChar, true);
}

void SantiagoTrip_wait(string qName)//
{
	DoQuestFunctionDelay("SantiagoTrip_Migel", 10.0);
	InterfaceStates.Buttons.Save.enable = false;//запретить сохраняться
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
}

void SantiagoTrip_Migel(string qName)//создаем Мигеля
{
	int iRank = 12+MOD_SKILL_ENEMY_RATE;
	sld = GetCharacter(NPC_GenerateCharacter("SantiagoEnemy2", "mercen_17", "man", "man", iRank, SPAIN, -1, true, "quest"));
	FantomMakeCoolFighter(sld, iRank, 10, 10, "blade_05", "", "bullet", iRank);
	sld.name = "Miguel";
	sld.lastname = "";
	sld.dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
	sld.dialog.currentnode = "Santiago_Trip_12";
	sld.greeting = "hambit_other_3";
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	ChangeCharacterAddressGroup(sld, "Santiago_HouseSp2_Room", "reload", "reload1");
	LAi_SetActorType(sld);
	LAi_ActorDialogDelay(sld, pchar, "", 1.0);
}

void SantiagoTripSecondTalk(string qName)//драка внизу
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	chrDisableReloadToLocation = true;
	sld = characterFromId("SantiagoEnemy1");
	sld.dialog.currentnode = "Santiago_Trip_14";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

//-----------------------------------------2 задание-----------------------------------------------
void Create_Longway(string qName)//создаем Лонгвэя
{
	sld = characterFromId("Longway");
	LAi_SetActorType(sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "Villemstad_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	GetMeifengToCharacter(pchar);//сажаем на Мейфенг
}

void JacobOnMainOver(string qName)//просрочили на стрелку
{
	if (pchar.questTemp.HWIC.Holl == "JacobInRoom")
	{
		sld = characterFromId("JacobBerg");
		sld.lifeday = 0;
		pchar.quest.MirageAttack_DieHard.win_condition.l1 = "MapEnter";
	    pchar.quest.MirageAttack_DieHard.function = "MC_GoAway";
	}
	if(IsEntity(&worldMap)) DoQuestFunctionDelay("MC_GoAway", 0.1);
	else
	{
		pchar.quest.MirageAttack_DieHard.win_condition.l1 = "MapEnter";
	    pchar.quest.MirageAttack_DieHard.function = "MC_GoAway";
	}
}

void Create_JacobVanBerg()//создаем Якоба ван Берга
{
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE/2;
	sld = characterFromId("JacobBerg");
	sld.rank = iRank;
    FantomMakeCoolFighter(sld, iRank, 20, 20, "blade_14", "pistol1", "bullet", 50);
    sld.DontClearDead = true;
	sld.SaveItemsForDead = true;
	GiveItem2Character(sld, "JacobJournal");
	GiveItem2Character(sld, "clock1");
	GiveItem2Character(sld, "recipe_totem_13");
	GiveItem2Character(sld, "totem_13");
	LAi_SetCitizenType(sld);
	ChangeCharacterAddressGroup(sld, pchar.questTemp.HWIC.Holl.JacobCity+"_tavern_upstairs", "goto", "goto1");
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.questTemp.HWIC.Holl.JacobCity+"_tavern_upstairs")], true);
}

void Jacob_Journal(string qName)//журнал Якоба ван Берга - все записи отражаем в документах
{
	chrDisableReloadToLocation = false;
	AddQuestRecordInfo("JacobVanBerg_Journal", "1");
	AddQuestRecord("Holl_Gambit", "1-11");
	pchar.quest.Jacob_Island.win_condition.l1 = "location";
	pchar.quest.Jacob_Island.win_condition.l1.location = "Cumana";
	pchar.quest.Jacob_Island.function = "Create_Mirage";
	pchar.questTemp.HWIC.Holl.Width = "true";// нашли широту острова
}

void Create_Mirage(string qName)//создаем 'Мираж'
{
	AddQuestRecord("Holl_Gambit", "1-12");
	ref sld;
	int iRank = 13+MOD_SKILL_ENEMY_RATE/2;
	Island_SetReloadEnableGlobal(pchar.questTemp.HWIC.Holl.JacobIsland, false);//на остров нельзя
	Group_FindOrCreateGroup("Mirage");
	Group_SetType("Mirage", "pirate");
	sld = GetCharacter(NPC_GenerateCharacter("MirageCap", "mercen_"+(rand(10)+1), "man", "man", iRank, PIRATE, -1, false, "quest"));
	FantomMakeSmallSailor(sld, SHIP_MIRAGE, "Mirage", CANNON_TYPE_CANNON_LBS20, 40+rand(10), 30+rand(20), 30+rand(20), 30+rand(15), 25+rand(25));
	FantomMakeCoolFighter(sld, iRank, 20, 20, "blade_10", "pistol2", "grapeshot", 30);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.DontRansackCaptain = true;
	sld.AlwaysFriend = true;
	SetCharacterPerk(sld, "MusketsShoot");
	sld.AnalizeShips = true;
	RealShips[sti(sld.Ship.Type)].ship.upgrades.hull = 3;//замшелый корпус
	SetShipSailsFromFile(sld, "ships/parus_torn.tga");
	SetSailsColor(sld, 8);//черный рваный парус
    Group_AddCharacter("Mirage", "MirageCap");
	Group_SetGroupCommander("Mirage", "MirageCap");
	Group_SetTaskNone("Mirage");//нет задачи
	Group_SetAddress("Mirage", "Cumana", "quest_ships", "Quest_ship_6");
    
    pchar.quest.MirageAttack_Abordage.win_condition.l1 = "Character_Capture";
	pchar.quest.MirageAttack_Abordage.win_condition.l1.character = "MirageCap";
	pchar.quest.MirageAttack_Abordage.function = "Mirage_Attack_Win";//взяли на абордаж
	pchar.quest.MirageAttack_Sink.win_condition.l1 = "Character_sink";
	pchar.quest.MirageAttack_Sink.win_condition.l1.character = "MirageCap";
	pchar.quest.MirageAttack_Sink.function = "Mirage_Attack_Fail";//потопили, а нельзя было
}

void Mirage_Attack_Fail(string qName)//потопили Мираж - провал
{
	Island_SetReloadEnableGlobal(pchar.questTemp.HWIC.Holl.JacobIsland, true);
	pchar.quest.MirageAttack_Abordage.over = "yes";
	AddQuestRecord("Holl_Gambit", "1-13");
	pchar.quest.MirageAttack_DieHard.win_condition.l1 = "MapEnter";
    pchar.quest.MirageAttack_DieHard.function = "MC_GoAway";
	pchar.questTemp.HWIC.Holl = "MirageFail";
}

void Mirage_Attack_Win(string qName)//после боя - проверяем корабли
{
	pchar.GenQuest.DontPartition = true; // отключить дележ
	Island_SetReloadEnableGlobal(pchar.questTemp.HWIC.Holl.JacobIsland, true);
	pchar.quest.MirageAttack_Sink.over = "yes";
	int iNum = 0;
	for(i = 0; i < COMPANION_MAX; i++)
	{
		int iTemp = GetCompanionIndex(PChar, i);
		if(iTemp > 0)
		{
			sld = GetCharacter(iTemp);
			if(sti(RealShips[sti(sld.ship.type)].basetype) == SHIP_MIRAGE || sti(RealShips[sti(sld.ship.type)].basetype) == SHIP_MAYFANG) iNum++;
		}
	}
	if (iNum != 2)
	{
		pchar.quest.MirageAttack_DieHard.win_condition.l1 = "MapEnter";
	    pchar.quest.MirageAttack_DieHard.function = "MC_GoAway";
		pchar.questTemp.HWIC.Holl = "MirageFail";//потеряли один из кораблей - провал
	}
	else
	{
		AddQuestRecord("Holl_Gambit", "1-14");
		pchar.questTemp.HWIC.Holl = "MirageTake";
		AddComplexSeaExpToScill(80, 50, 50, 130, 80, 80, 0);
		AddCharacterExpToSkill(pchar, "Fortune", 100);//везение
		SetFunctionTimerCondition("MirageConvoyOver", 0, 0, 15, false);
	}
	DoQuestCheckDelay("sea_victory", 1.5);
}

void MirageConvoyOver(string qName)//не пошел в Виллемстад с Миражом - значит, провалил
{
	pchar.questTemp.HWIC.Holl = "lateVillemstad";
	if(IsEntity(&worldMap)) DoQuestFunctionDelay("MC_GoAway", 0.1);
	else
	{
		pchar.quest.MirageAttack_DieHard.win_condition.l1 = "MapEnter";
	    pchar.quest.MirageAttack_DieHard.function = "MC_GoAway";
	}
}

void MC_GoAway(string qName)//провалил задание - в лодку и в плавание
{
	aref arOldMapPos;
	makearef(arOldMapPos, worldMap.old);
	
	if (CheckAttribute(pchar, "questTemp.HWIC.Holl"))
	{
		Pchar.questTemp.FiringOfficerIDX = GetCharacterIndex("Longway");
		DeleteAttribute(pchar, "questTemp.HWIC.HollEquip");
	}
	if (CheckAttribute(pchar, "questTemp.HWIC.Eng"))
	{
		Pchar.questTemp.FiringOfficerIDX = GetCharacterIndex("Knippel");
		DeleteAttribute(pchar, "questTemp.HWIC.EngEquip");
	}
	sld = &Characters[sti(Pchar.questTemp.FiringOfficerIDX)];
	CheckForReleaseOfficer(sti(Pchar.questTemp.FiringOfficerIDX));
	RemovePassenger(Pchar, sld);
	RemoveCharacterCompanion(pchar, sld);
	LAi_SetCitizenType(sld);
    DeleteAttribute(sld, "Payment");
	DeleteAttribute(Pchar, "questTemp.FiringOfficerIDX");//удаляем из офицеров
	WdmPrepareMapForAbordage(arOldMapPos);
	MakeCloneShipDeck(pchar, true);//клон палубы
	LAi_LocationFightDisable(&Locations[FindLocation("Ship_deck")], true);
	DoReloadFromWorldMapToLocation("Ship_deck", "goto", "goto1");
	LAi_LockFightMode(pchar, true);
	ChangeCharacterAddressGroup(sld, "Ship_deck", "goto", "goto2");
	LAi_SetActorType(sld);
	if (CheckAttribute(pchar, "questTemp.HWIC.Holl")) sld.dialog.Filename = "Quest\HollandGambit\Longway.c";
	if (CheckAttribute(pchar, "questTemp.HWIC.Eng")) sld.dialog.Filename = "Quest\HollandGambit\Knippel.c";
	sld.dialog.currentnode = "MC_GoAway";
	sld.greeting = ""; // озвучка напрямую
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	pchar.quest.Munity = "";//чтобы не выскочил без разговора
	DeleteAttribute(pchar, "questTemp.HWIC.TakeQuestShip");//ПУ откроем
}

void Jacob_RemoveShip()//удаление корабля
{
	if(sti(RealShips[sti(pchar.ship.type)].basetype) == sti(pchar.questTemp.HWIC.Holl.ShipType))
	{
		pchar.Ship.Type = GenerateShipExt(SHIP_TARTANE, true, pchar);
		pchar.Ship.name = "Boat";
		SetBaseShipData(pchar);
		SetCrewQuantityOverMax(PChar, 0);//сажаем на тартану
	}
	else
	{
		for(i = 1; i < COMPANION_MAX; i++)
		{
			int iTemp = GetCompanionIndex(PChar, i);
			if(iTemp > 0)
			{
				sld = GetCharacter(iTemp);
				if(sti(RealShips[sti(sld.ship.type)].basetype) == sti(pchar.questTemp.HWIC.Holl.ShipType))
				{
					pchar.questTemp.HWIC.Holl.CompanionIndex = sld.Index;
					sld = GetCharacter(sti(pchar.questTemp.HWIC.Holl.CompanionIndex));
					RemoveCharacterCompanion(PChar, sld);
					AddPassenger(PChar, sld, false);
				}
			}
		}
    }
	Pchar.questTemp.FiringOfficerIDX = GetCharacterIndex("Longway");
	sld = &Characters[sti(Pchar.questTemp.FiringOfficerIDX)];
	CheckForReleaseOfficer(sti(Pchar.questTemp.FiringOfficerIDX));
	RemovePassenger(Pchar, sld);
	RemoveCharacterCompanion(pchar, sld);
    DeleteAttribute(sld, "Payment");
	DeleteAttribute(Pchar, "questTemp.FiringOfficerIDX");//удаляем из офицеров
}

//---------------------------------------3 задание--------------------------------------------------------
void ToAntiguaOver(string qName)//потеряли слишком много времени
{
	DeleteAttribute(pchar, "questTemp.HWIC.TakeQuestShip");//ПУ откроем
	pchar.questTemp.HWIC.Holl = "end";
	pchar.questTemp.HWIC.Detector = "holl_fail";
	AddQuestRecord("Holl_Gambit", "1-15_1");
	CloseQuestHeader("Holl_Gambit");
	ChangeCharacterHunterScore(PChar, "holhunter", 100); //начислить НЗГ
}

void PrepareToFleetwoodAttack(string qName)//пришли на Доминику, а подлого китайца нет
{
	if (!CheckAttribute(pchar, "questTemp.HWIC.Holl.Repeat")) AddQuestRecord("Holl_Gambit", "1-18");
	if (sti(RealShips[sti(pchar.ship.type)].basetype) != SHIP_MIRAGE || GetCompanionQuantity(pchar) > 1)
	{//пришли не на том, или с эскадрой - фигвам, а не Флитвуд, круговое прерывание, пока не выполним условия
		pchar.quest.Fleetwood_Return.win_condition.l1 = "MapEnter";
		pchar.quest.Fleetwood_Return.function = "ReturnFleetwoodBreak";
	}
	else
	{
		Island_SetReloadEnableGlobal("Dominica", false);//на остров нельзя			
		bQuestDisableMapEnter = true;
		DoQuestFunctionDelay("CreateFleetwoodOnMap", 15.0);
	}
}

void ReturnFleetwoodBreak(string qName)//второй раз, третий, четвертый... пока не дойдет
{
	pchar.quest.toDominica.win_condition.l1 = "location";
	pchar.quest.toDominica.win_condition.l1.location = "Dominica";
	pchar.quest.toDominica.function = "PrepareToFleetwoodAttack";
	pchar.questTemp.HWIC.Holl.Repeat = "true";
}

void CreateFleetwoodOnMap(string qName)//подгружаем в море энкаунтер Флитвуда
{
	DeleteAttribute(pchar, "questTemp.HWIC.Holl.Repeat");
	int iRank = 15+MOD_SKILL_ENEMY_RATE/2;
	Group_FindOrCreateGroup("Fleetwood_Attack");
	sld = characterFromId("Fleetwood");
	FantomMakeSmallSailor(sld, SHIP_VALCIRIA, "Valkyrie", CANNON_TYPE_CANNON_LBS20, 40+rand(10), 35+rand(20), 35+rand(20), 30+rand(15), 35+rand(25));
	FantomMakeCoolFighter(sld, iRank, 30, 30, "blade_14", "pistol3", "grapeshot", 50);
	GiveItem2Character(sld, "FleetwoodJournal");
	GiveItem2Character(sld, "sand_clock");
	sld.DontClearDead = true;
	sld.SaveItemsForDead = true;
	GiveItem2Character(sld, "spyglass3");
	sld.AlwaysEnemy = true;
	sld.DontRansackCaptain = true;
	sld.Coastal_Captain = true; //не ссорить нации
	sld.AnalizeShips = true;
	SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("Fleetwood_Attack", "Fleetwood");
    Group_SetGroupCommander("Fleetwood_Attack", "Fleetwood");
	Group_SetTaskAttack("Fleetwood_Attack", PLAYER_GROUP);
	Group_SetAddress("Pirate_Attack", "Dominica", "", "");
    Group_LockTask("Fleetwood_Attack");
	SetCharacterRelationBoth(sti(sld.index), GetMainCharacterIndex(), RELATION_ENEMY);
	Sea_LoginGroupCurrentSea("Fleetwood_Attack");
	log_info("Valkyrie is on the horizon!");
	PlaySound("interface\_EvEnemy1.wav");
	
	pchar.quest.FleetwoodAttack_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.FleetwoodAttack_AfterBattle.win_condition.l1.group = "Fleetwood_Attack";
	pchar.quest.FleetwoodAttack_AfterBattle.function = "Fleetwood_AfterBattle";
	//прерывание на Мейфенг у Кюрасао ставим тут
	pchar.quest.Fleetwood_Complete.win_condition.l1 = "location";
	pchar.quest.Fleetwood_Complete.win_condition.l1.location = "Curacao";
	pchar.quest.Fleetwood_Complete.function = "CreateEmptyMeifeng";
}

void Fleetwood_AfterBattle(string qName)//потопили Флитвуда - острова теперь не найти
{
	DeleteAttribute(pchar, "questmaplock");
	bQuestDisableMapEnter = false;
	Island_SetReloadEnableGlobal("Dominica", true);//на остров можно	
	if (pchar.questTemp.HWIC.Holl != "FleetwoodCapture")
	{
		Group_DeleteGroup("Fleetwood_Attack");
		AddQuestRecord("Holl_Gambit", "1-19");
		pchar.questTemp.HWIC.Holl = "FleetwoodSink";
	}
	DoQuestCheckDelay("sea_victory", 1.5);
}

void FleetwoodJournalFind(string qName)//журнал Флитвуда
{
	pchar.GenQuest.DontPartition = true; // отключить дележ
	pchar.quest.FleetwoodAttack_AfterBattle.over = "yes";
	pchar.quest.FleetwoodAttack_DieHard.over = "yes";
	Group_DeleteGroup("Fleetwood_Attack");
	if(CheckCharacterItem(pchar, "FleetwoodJournal"))
	{
		AddQuestRecord("Holl_Gambit", "1-20");
		AddQuestRecordInfo("Fleetwood_Journal", "1");
		pchar.questTemp.HWIC.Holl.Longitude = "true";//нашли долготу острова
	}
	else AddQuestRecord("Holl_Gambit", "1-21");//не нашли журнал - олухи
	AddComplexSeaExpToScill(100, 60, 60, 150, 100, 100, 0);
	AddCharacterExpToSkill(pchar, "Fortune", 100);//везение
}

void CreateEmptyMeifeng(string qName)//Мейфенг без китайца в порту Виллемстада
{
	Island_SetReloadEnableGlobal("Dominica", true);//patch-7
	Group_FindOrCreateGroup("Meifeng_Empty");
	sld = GetCharacter(NPC_GenerateCharacter("MeifengCap", "off_hol_2", "man", "man", 40, HOLLAND, -1, true, "quest"));
	sld.name = "Hainrih";
	sld.lastname = "Claus";
	FantomMakeSmallSailor(sld, SHIP_MAYFANG, "Meifeng", CANNON_TYPE_CANNON_LBS20, 90+rand(10), 80+rand(20), 80+rand(20), 80+rand(15), 75+rand(25));
	SetFantomParamFromRank(sld, 40, true); 
	Character_SetAbordageEnable(sld, false);//нельзя абордировать
	sld.AnalizeShips = true;
	SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("Meifeng_Empty", "MeifengCap");
	Group_SetGroupCommander("Meifeng_Empty", "MeifengCap");
	Group_SetAddress("Meifeng_Empty", "Curacao", "Islandships1", "ship_2");
	AddQuestRecord("Holl_Gambit", "1-22");
	pchar.quest.Meifeng_fail.win_condition.l1 = "NPC_Death";
	pchar.quest.Meifeng_fail.win_condition.l1.character = "MeifengCap";
	pchar.quest.Meifeng_fail.function = "HollGambit_failed";//для особо умных
}

void HollGambit_failed(string qName)//если у кого-то хватит наглости
{
	Group_DeleteGroup("Meifeng_Empty");
	ChangeCharacterComplexReputation(pchar, "nobility", -10);
	ChangeCharacterHunterScore(PChar, "holhunter", 100); //начислить НЗГ
	AddQuestRecord("Holl_Gambit", "1-23");
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Holl = "end";
	pchar.questTemp.HWIC.Detector = "holl_fail";
}

void Lucas_ExangeShip()//обмен корабля
{
	if(sti(RealShips[sti(pchar.ship.type)].basetype) == SHIP_MIRAGE)
	{
		GetMeifengToCharacter(pchar);//даем Мейфенг навсегда - ну неужели эти корабельные обмены окончены? 
	}
	else
	{
		for(i = 1; i < COMPANION_MAX; i++)
		{
			int iTemp = GetCompanionIndex(PChar, i);
			if(iTemp > 0)
			{
				sld = GetCharacter(iTemp);
				if(sti(RealShips[sti(sld.ship.type)].basetype) == SHIP_MIRAGE)
				{
					pchar.questTemp.HWIC.Holl.CompanionIndex = sld.Index;
					sld = GetCharacter(sti(pchar.questTemp.HWIC.Holl.CompanionIndex));
					GetMeifengToCharacter(sld);//сажаем на Мейфенг
				}
			}
		}
	}
}

void GetMeifengToCharacter(ref rChar)//сажаем на Мейфенг
{
	rChar.Ship.Type = GenerateShipExt(SHIP_MAYFANG, true, rChar);
	rChar.Ship.name = "Meifeng";
	SetBaseShipData(rChar);
	rChar.Ship.Cannons.Type = CANNON_TYPE_CANNON_LBS20;
	SetCrewQuantityFull(rChar);
	AddCrewMorale(rChar, 50);
	ChangeCrewExp(rChar, "Sailors", 30);
	ChangeCrewExp(rChar, "Cannoners", 30);
	ChangeCrewExp(rChar, "Soldiers", 30);
	SetCharacterGoods(rChar, GOOD_BALLS, 200);
	SetCharacterGoods(rChar, GOOD_GRAPES, 300);
	SetCharacterGoods(rChar, GOOD_KNIPPELS, 300);
	SetCharacterGoods(rChar, GOOD_BOMBS, 500);
	SetCharacterGoods(rChar, GOOD_FOOD, 500);
	SetCharacterGoods(rChar, GOOD_POWDER, 800);
	SetCharacterGoods(rChar, GOOD_WEAPON, 300);
	SetCharacterGoods(rChar, GOOD_MEDICAMENT, 150);
}

void AwardFromFromLucas(string qName)//церемония награждения
{
	bDisableFastReload = true;
	sld = characterFromId("hol_guber");
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_townhall", "goto", "governor1");
	sld = characterFromId("Lucas");
	sld.dialog.currentnode = "LucasAward";
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_townhall", "goto", "goto3");
	for (i=1; i<=3; i++)
	{
		ref chr = GetCharacter(NPC_GenerateCharacter("LucasGuard_"+i, "sold_hol_1"+i, "man", "man", 35, HOLLAND, -1, false, "soldier"));
		FantomMakeCoolFighter(chr, 35, 90, 90, "blade_10", "pistol3", "grapeshot", 200);//группа альфа
		LAi_SetActorType(chr);
		if (i == 3) ChangeCharacterAddressGroup(chr, "Villemstad_townhall", "goto", "goto1");
		else ChangeCharacterAddressGroup(chr, "Villemstad_townhall", "goto", "goto"+(i+3));
		LAi_ActorTurnToCharacter(chr, pchar);
	}
	LAi_SetActorType(pchar);
	LAi_ActorFollow(pchar, sld, "ActorDialog_Any2Pchar", -1);
	LAi_ActorTurnToCharacter(sld, pchar);
    SetActorDialogAny2Pchar(sld.id, "", 0.0, 0.0);
}

//-------------------------------------------4 задание--------------------------------------------------------
void Create_Joakim(string qName)//создаем Жоакима
{
	sld = characterFromId("Joakim");
	GetCharacterPos(pchar, &locx, &locy, &locz);
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_town", "goto", LAi_FindNearestLocator("goto", locx, locy, locz));
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	//хозяйка дома
	sld = GetCharacter(NPC_GenerateCharacter("Landlady", "women_7", "woman", "towngirl", 5, HOLLAND, -1, false, "quest"));
	LAi_SetOwnerType(sld);
	sld.Dialog.Filename = "Quest\HollandGambit\Joakim.c";
	sld.dialog.currentnode = "Landlady";
	ChangeCharacterAddressGroup(sld, "Villemstad_houseSp1", "goto", "goto1");
}

void JoakimTalk(string qName)//Жоаким в комнате
{
	sld = characterFromId("Joakim");
	sld.Dialog.Filename = "Quest\HollandGambit\Joakim.c";
	if (CheckAttribute(pchar, "questTemp.HWIC.Holl")) sld.dialog.currentnode = "JoakimSeekSkull_3";
	else sld.dialog.currentnode = "JoakimSeekSkull_8";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void CheckIslandCoordinates()//проверка наличия координат острова у ГГ
{
	if (CheckAttribute(pchar, "questTemp.HWIC.Holl.Width") && CheckAttribute(pchar, "questTemp.HWIC.Holl.Longitude"))
	{
		AddQuestRecord("Holl_Gambit", "1-28");
		pchar.questTemp.HWIC_Coordinates = "true"; //атрибут координат на поиск острова через каюту
	}
	else
	{
		pchar.questTemp.HWIC.Holl = "NotFindAbbyIsland";
		AddQuestRecord("Holl_Gambit", "1-29");
	}
}

void PrepareSearchingFor()//подготовка-сценка
{
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_SetBarmanType(pchar);
	DoQuestCheckDelay("TalkSelf_Quest", 15.0);
}

void SearchingForIslandOnMap()//подготовим остров к посещению
{
	pchar.questTemp.HWIC.Isladecoche = "true"; // Addon 2016-1 Jason Пиратская линейка; флаг - Исла де Коче найден
	DeleteAttribute(pchar, "questTemp.HWIC_FindIsland"); // 021012
	chrDisableReloadToLocation = false;//открыть локацию
	AddQuestRecord("Holl_Gambit", "3-60");
	i = FindIsland("IslaDeCoche");
	Islands[i].visible = true;
	Islands[i].reload_enable = true;
	if (CheckAttribute(pchar, "questTemp.HWIC.Holl") || CheckAttribute(pchar, "questTemp.HWIC.Self"))
	{
		pchar.GenQuestBox.IslaDeCoche_Grot = true;
		pchar.GenQuestBox.IslaDeCoche_Grot.box1.money = 200000;
		pchar.GenQuestBox.IslaDeCoche_Grot.box1.items.jewelry5 = 100;
		pchar.GenQuestBox.IslaDeCoche_Grot.box1.items.SkullAztec = 1;
	}
	if (CheckAttribute(pchar, "questTemp.HWIC.Eng"))
	{
		pchar.GenQuestBox.IslaDeCoche_Grot = true;
		pchar.GenQuestBox.IslaDeCoche_Grot.box1.items.GastonHead = 1;//бошка бармена
	}
	LAi_SetPlayerType(pchar);
	pchar.quest.Abby_IslandSea.win_condition.l1 = "location";
	pchar.quest.Abby_IslandSea.win_condition.l1.location = "IslaDeCoche";
	pchar.quest.Abby_IslandSea.function = "IslaDeCocheInSea";//на выход в локацию острова
	pchar.quest.Abby_IslandGrot.win_condition.l1 = "location";
	pchar.quest.Abby_IslandGrot.win_condition.l1.location = "IslaDeCoche_Grot";
	pchar.quest.Abby_IslandGrot.function = "IslaDeCocheInGrot";//на посещение грота
	if (CheckAttribute(pchar, "questTemp.HWIC.Holl"))
	{
		pchar.quest.Abby_IslandSkullAztec.win_condition.l1 = "item";
		pchar.quest.Abby_IslandSkullAztec.win_condition.l1.item = "SkullAztec";
		pchar.quest.Abby_IslandSkullAztec.function = "SkullAztec_Find";//на нахождение черепа
	}
	if (CheckAttribute(pchar, "questTemp.HWIC.Eng"))
	{
		pchar.quest.Abby_IslandFight.win_condition.l1 = "locator";
		pchar.quest.Abby_IslandFight.win_condition.l1.location = "IslaDeCoche_Grot";
		pchar.quest.Abby_IslandFight.win_condition.l1.locator_group = "box";
		pchar.quest.Abby_IslandFight.win_condition.l1.locator = "box1";
		pchar.quest.Abby_IslandFight.function = "BoomInGrot";//на взрыв и создание монстра
	}
	if (CheckAttribute(pchar, "questTemp.HWIC.Self"))
	{
		pchar.quest.Abby_IslandBattle.win_condition.l1 = "item";
		pchar.quest.Abby_IslandBattle.win_condition.l1.item = "SkullAztec";
		pchar.quest.Abby_IslandBattle.function = "BattleInGrot";//на бойцов ван Берга
	}
}

void IslaDeCocheInSea(string qName)//вышли у острова
{
	AddQuestRecord("Holl_Gambit", "1-30");
	LAi_LocationDisableOfficersGen("IslaDeCoche_Grot", true);//офицеров в грот не пускать
	LAi_LocationDisableMonGenTimer("IslaDeCoche_Grot", 3); //монстров не генерить
}

void IslaDeCocheInGrot(string qName)//вошли в грот
{
	PlaySound("interface\notebook.wav");
	Log_info("Here is the grotto. I should look for Solomon's stash here.");
}

void SkullAztec_Find(string qName)//нашли схрон и череп
{
	AddQuestRecord("Holl_Gambit", "1-31");
	pchar.questTemp.HWIC.Holl = "AbbyFindScull";//а теперь к Соломону
	LAi_LocationDisableOfficersGen("IslaDeCoche_Grot", false);//офицеров пускать
}

void DeleteJoakimFromRoom(string qName)//закрыть комнату Жоакима и пусть там сидит
{
	sld = characterFromId("Landlady");
	sld.Dialog.Filename = "Quest\HollandGambit\Joakim.c";
	sld.dialog.currentnode = "Landlady_1";
	sld = characterFromId("Joakim");
	ChangeCharacterAddressGroup(sld, "none", "", "");
}

//-------------------------------------------5 задание-----------------------------------------------------
void GiveTaskMerdok(string qName)//посыльный на последнее задание
{
	LocatorReloadEnterDisable("Villemstad_town", "reload1_back", true);
	LocatorReloadEnterDisable("Villemstad_town", "reload2_back", true);
	LocatorReloadEnterDisable("Villemstad_town", "gate_back", true);
	bDisableFastReload = true;
	sld = GetCharacter(NPC_GenerateCharacter("HollQuestOff", "off_hol_2", "man", "man", 20, HOLLAND, 0, false, "quest"));
    sld.Dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
	sld.dialog.currentnode = "HollQuest_Officer";
    FantomMakeCoolFighter(sld, 20, 20, 20, "blade_12", "pistol3", "grapeshot", 50);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void MerdokInUndergroundCave(string qName)//установим Мердока и Тонзага в подземелье
{
	sld = characterFromId("Bridgetown_tavernkeeper");
	sld.model = "barmen_3";
	sld.name = "Harry";
	sld.lastname = "Fletcher";//перерисуем бармена Бриджтауна
	sld.greeting = "barmen_1";
	LAi_group_Delete("EnemyFight");
	LAi_LocationDisableMonGenTimer("SentJons_TownCave", 3); //монстров не генерить
	LocatorReloadEnterDisable("SentJons_TownCave", "reload2", true);//выход сразу закроем
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретим драться
	sld = characterFromId("Merdok");
	sld.greeting = "merdok_6";
	FantomMakeCoolFighter(sld, 20, 50, 50, "blade_27", "pistol6", "bullet", 100); // приз - саксенфедер 090912
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	GiveItem2Character(sld, "Drugstore_keys");//ключи
	LAi_SetStayType(sld);
	ChangeCharacterAddressGroup(sld, "SentJons_TownCave", "item", "berglar1");
	//помощник Мердока - Тонзаг
	sld = characterFromId("Tonzag");	
	FantomMakeCoolFighter(sld, 30, 70, 70, "blade_07", "pistol6", "bullet", 150);
	LAi_SetStayType(sld);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	ChangeCharacterAddressGroup(sld, "SentJons_TownCave", "reload", "reload1_back");
	pchar.quest.Merdok_Fight.win_condition.l1 = "locator";
	pchar.quest.Merdok_Fight.win_condition.l1.location = "SentJons_TownCave";
	pchar.quest.Merdok_Fight.win_condition.l1.locator_group = "item";
	pchar.quest.Merdok_Fight.win_condition.l1.locator = "berglar1";
	pchar.quest.Merdok_Fight.function = "MerdokPrepareFight";
	pchar.GenQuestBox.SentJons_HouseF3 = true;
	pchar.GenQuestBox.SentJons_HouseF3.box1.money = 25000;
	pchar.GenQuestBox.SentJons_HouseF3.box1.items.MerdokArchive = 1;//архив
}

void MerdokPrepareFight(string qName)//подготовка к бою
{
	sld = characterFromId("Merdok");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void FindMerdokKey(string qName)//теперь у нас есть ключ
{
	LocatorReloadEnterDisable("SentJons_TownCave", "reload2", false);//выход откроем // patch-9
	if (CheckAttribute(pchar, "questTemp.HWIC.Eng"))
	{
	AddQuestRecord("Holl_Gambit", "2-27");
	CloseQuestHeader("Holl_Gambit");
		pchar.questTemp.HWIC.Detector = "eng_win";
	}
	pchar.quest.Merdok_Door.win_condition.l1 = "locator";
	pchar.quest.Merdok_Door.win_condition.l1.location = "SentJons_TownCave";
	pchar.quest.Merdok_Door.win_condition.l1.locator_group = "reload";
	pchar.quest.Merdok_Door.win_condition.l1.locator = "reload1_back";
	pchar.quest.Merdok_Door.function = "OpenDungeDoor";//на локатор входа в дом
	pchar.quest.Jino_Door.win_condition.l1 = "locator";
	pchar.quest.Jino_Door.win_condition.l1.location = "SentJons_HouseF3";
	pchar.quest.Jino_Door.win_condition.l1.locator_group = "reload";
	pchar.quest.Jino_Door.win_condition.l1.locator = "reload4";
	pchar.quest.Jino_Door.function = "OpenRoomDoor";//на локатор комнаты Джино
}

void OpenDungeDoor(string qName)//вошли в локатор двери дома
{
	PlaySound("interface\key.wav");//щелк!
	LocatorReloadEnterDisable("SentJons_TownCave", "reload1_back", false);//откроем дверь в дом
	LocatorReloadEnterDisable("SentJons_HouseF3", "reload2", false);//откроем дверь в подвал из дома
	LocatorReloadEnterDisable("SentJons_town", "HouseF3", false);//аптеку откроем
}

void OpenRoomDoor(string qName)//вошли в локатор комнаты дома
{
	PlaySound("interface\key.wav");//щелк!
	LocatorReloadEnterDisable("SentJons_HouseF3", "reload4", false);//откроем дверь в комнату
}

void FindMerdokBook(string qName)//нашли архив
{
	PlaySound("interface\important_item.wav");
	if (CheckAttribute(pchar, "questTemp.HWIC.Holl")) AddQuestRecord("Holl_Gambit", "1-39");
	if (CheckAttribute(pchar, "questTemp.HWIC.Eng")) AddQuestRecord("Holl_Gambit", "2-24");
	pchar.GenQuestBox.SentJons_TownCave = true;
	pchar.GenQuestBox.SentJons_TownCave.box2.items.Cipher = 1;//а шифр генерим только счас
	pchar.quest.Merdok_Cipher.win_condition.l1 = "item";
	pchar.quest.Merdok_Cipher.win_condition.l1.item = "Cipher";
	pchar.quest.Merdok_Cipher.function = "FindMerdokCipher";//и сразу прерывание на него
}

void FindMerdokCipher(string qName)//нашли шифр
{
	AddCharacterExpToSkill(pchar, "Fortune", 200);//везение
	AddCharacterExpToSkill(pchar, "Sneak", 200);//скрытность
	if (CheckAttribute(pchar, "questTemp.HWIC.Holl"))
	{
		AddQuestRecord("Holl_Gambit", "1-40");
		AddQuestRecordInfo("Merdok_Archive", "1");
	}
	if (CheckAttribute(pchar, "questTemp.HWIC.Eng"))
	{
		AddQuestRecord("Holl_Gambit", "2-26");
		AddQuestRecordInfo("Merdok_Archive", "2");
	}
}

void LucasQuit(string qName)//уберем Лукаса
{
	if (GetCharacterIndex("Lucas") != -1) // 021012
	{
		sld = characterFromId("Lucas");
		sld.lifeday = 0;
	}
	sld = GetCharacter(NPC_GenerateCharacter("HWICBoss", "off_hol_3", "man", "man", 35, HOLLAND, -1, false, "quest"));
	FantomMakeCoolFighter(sld, 35, 100, 100, "blade_17", "pistol5", "bullet", 200);
	sld.Dialog.Filename = "Quest\HollandGambit\HWIC_Office.c"; // 021012
	sld.dialog.currentnode = "HWIC_Boss";
	sld.standUp = true;
	LAi_SetHuberType(sld);
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "Villemstad_houseS3_residence", "sit", "sit1");
	LAi_group_MoveCharacter(sld, "HOLLAND_CITIZENS");//заменим главу ГВИК
}

///----------------------------Голландский Гамбит, часть 2 - за Англию-------------------------------

//--------------------------------------------1 задание-----------------------------------------------

void HWICSilverConvoyInWorld()//создаем серебряный конвой
{
	string sCapId = "SilverCap";
    string sGroup = "Sea_" + sCapId + "1";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	pchar.questTemp.HWIC.Eng.SlvQty = 1800 + rand(500);
	int iRank = 13+MOD_SKILL_ENEMY_RATE;
	int iScl = MOD_SKILL_ENEMY_RATE*2+30;
	for (int i = 1; i <= 3; i++)
    {
		sld = GetCharacter(NPC_GenerateCharacter(sCapId + i, "citiz_41", "man", "man", iRank, HOLLAND, 15, true, "soldier"));
		SetRandomNameToCharacter(sld);
		SetRandomNameToShip(sld);
		switch (i)
		{
			case 1: iTemp = SHIP_XebekVML; break;
			case 2: iTemp = SHIP_EASTINDIAMAN; break;
			case 3: iTemp = SHIP_SCHOONER_W; break;
		}
		sld.Ship.Type = GenerateShipExt(iTemp, 1, sld);
		SetBaseShipData(sld);
		SetCaptanModelByEncType(sld, "war");
		int hcrew = GetMaxCrewQuantity(sld);
		SetCrewQuantity(sld, hcrew);
		SetCrewQuantityFull(sld);
		sld.AlwaysEnemy = true;
		sld.DontRansackCaptain = true;
		sld.Coastal_Captain = true; //не ссорить нации
		sld.lifeDay = 15;
		sld.AnalizeShips = true;
		sld.WatchFort = true; //видеть форты
		sld.skill.Sailing = iScl+rand(10);
		sld.skill.Defence = iScl+rand(10);
		sld.skill.Accuracy = iScl+rand(10);
		sld.skill.Cannons = iScl+rand(10);
		sld.Ship.Crew.Morale = iScl+10;
		sld.Ship.Crew.Exp.Sailors = iScl;
		sld.Ship.Crew.Exp.Cannoners = iScl;
		sld.Ship.Crew.Exp.Soldiers = iScl;
		SetCharacterPerk(sld, "HullDamageUp");
		SetCharacterPerk(sld, "SailsDamageUp");
		SetCharacterPerk(sld, "CrewDamageUp");
		SetCharacterPerk(sld, "CriticalShoot");
		if (MOD_SKILL_ENEMY_RATE > 6) SetCharacterPerk(sld, "MusketsShoot");
		SetCharacterPerk(sld, "AdvancedBattleState");
		SetCharacterPerk(sld, "ShipTurnRateUp");
		SetCharacterPerk(sld, "ShipSpeedUp");
		DeleteAttribute(sld, "SinkTenPercent");
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		if (i == 2) SetCharacterGoods(sld, GOOD_SILVER, sti(pchar.questTemp.HWIC.Eng.SlvQty));//положить в трюм серебро
		sld.mapEnc.type = "war";
		sld.mapEnc.worldMapShip = "quest_ship";
        sld.mapEnc.Name = "silver convoy";
        Group_AddCharacter(sGroup, sCapId + i);
	}
	Group_SetGroupCommander(sGroup, sCapId+ "1");
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
	Map_CreateTrader("Shore22", "Shore41", sCapId + "1", 15);//запуск энкаунтера
	
	pchar.quest.SilverConvoy_Abordage.win_condition.l1 = "Character_Capture";
	pchar.quest.SilverConvoy_Abordage.win_condition.l1.character = "SilverCap2";
	pchar.quest.SilverConvoy_Abordage.function = "SilverConvoy_AfterBattle";//взяли на абордаж
	pchar.quest.SilverConvoy_Sink.win_condition.l1 = "Character_sink";
	pchar.quest.SilverConvoy_Sink.win_condition.l1.character = "SilverCap2";
	pchar.quest.SilverConvoy_Sink.function = "SilverConvoy_AfterBattle";//потопили
}

void SilverConvoy_AfterBattle(string qName)//после боя
{
	pchar.GenQuest.DontPartition = true; // отключить дележ
	pchar.quest.HollConvoy_Over.over = "yes";
	pchar.questTemp.HWIC.Eng = "TakeHollConvoy";
	AddComplexSeaExpToScill(150, 150, 150, 150, 150, 150, 0);
	DoQuestCheckDelay("sea_victory", 1.5);
	ChangeCharacterComplexReputation(pchar, "fame", 1);
}

void HollConvoy_Over(string qName)//опоздали или не нашли конвой
{
	pchar.quest.SilverConvoy_Abordage.over = "yes";
	pchar.quest.SilverConvoy_Sink.over = "yes";
	AddQuestRecord("Holl_Gambit", "2-2");
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Fail2 = "true";
	DeleteAttribute(pchar, "questTemp.HWIC.Eng");//зачищаем для возможности отката к голландскому варианту
}

void HollConvoy_Remove()//удаляем товар и корабль
{
	RemoveCharacterGoods(pchar, GOOD_SILVER, sti(pchar.questTemp.HWIC.Eng.SlvQty));
	//удаляем ост-индца
	if(sti(RealShips[sti(pchar.ship.type)].basetype) == SHIP_EASTINDIAMAN)
	{
		pchar.Ship.Type = GenerateShipExt(SHIP_TARTANE, true, pchar);
		pchar.Ship.name = "Boat";
		SetBaseShipData(pchar);
		SetCrewQuantityOverMax(PChar, 0);//сажаем на тартану
	}
	else
	{
		for(i = 1; i < COMPANION_MAX; i++)
		{
			int iTemp = GetCompanionIndex(PChar, i);
			if(iTemp > 0)
			{
				ref chr = GetCharacter(iTemp);
				if(sti(RealShips[sti(chr.ship.type)].basetype) == SHIP_EASTINDIAMAN)
				{
					pchar.questTemp.HWIC.Eng.CompanionIndex = chr.Index;
					sld = GetCharacter(sti(pchar.questTemp.HWIC.Eng.CompanionIndex));
				}
			}
		}
		RemoveCharacterCompanion(PChar, sld);
		AddPassenger(PChar, sld, false);//удалим тока 1 последний в списке ОИ - пусть будет хоть так
	}
}

//--------------------------------------------2 задание-----------------------------------------------

void Knippel_GoTown(string qName)//шагаем по городу
{
	sld = characterFromId("Knippel");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "houseSP3", "SentJons_houseSP3", "goto", "goto1", "OpenFleetwoodDoor", -1);
	pchar.quest.Knippel_Inside.win_condition.l1 = "location";
	pchar.quest.Knippel_Inside.win_condition.l1.location = "SentJons_houseSP3";
	pchar.quest.Knippel_Inside.function = "Knippel_InHouse";
}

void Knippel_InHouse(string qName)//заходим в дом
{
	sld = characterFromId("Knippel");
	sld.dialog.currentnode = "InFleetwoodHouse";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void GetValckiriaToCharacter(ref rChar)//сажаем на Валькирию
{
	rChar.Ship.Type = GenerateShipExt(SHIP_VALCIRIA, true, rChar);
	rChar.Ship.name = "Valkyrie";
	SetBaseShipData(rChar);
	rChar.Ship.Cannons.Type = CANNON_TYPE_CANNON_LBS20;
	SetCrewQuantityFull(rChar);
	AddCrewMorale(rChar, 100);
	ChangeCrewExp(rChar, "Sailors", 100);
	ChangeCrewExp(rChar, "Cannoners", 100);
	ChangeCrewExp(rChar, "Soldiers", 100);
	SetCharacterGoods(rChar, GOOD_BALLS, 200);
	SetCharacterGoods(rChar, GOOD_GRAPES, 300);
	SetCharacterGoods(rChar, GOOD_KNIPPELS, 300);
	SetCharacterGoods(rChar, GOOD_BOMBS, 500);
	SetCharacterGoods(rChar, GOOD_FOOD, 500);
	SetCharacterGoods(rChar, GOOD_POWDER, 1000);
	SetCharacterGoods(rChar, GOOD_WEAPON, 300);
	SetCharacterGoods(rChar, GOOD_MEDICAMENT, 180);
}

void KnippelToOfficer(string qName)//Книппель идет офицером
{
	sld = characterFromId("Knippel");
	sld.dialog.currentnode = "Knippel_ToOfficer";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void GotoBridgetownOver(string qName)//просрочили выполнить задание
{
	if (pchar.questTemp.HWIC.Eng == "SeekVanBerg")
	{
		sld = characterFromId("JacobBerg");
		sld.lifeday = 0;
		Group_DeleteGroup("Sea_1");
	}
	if(IsEntity(&worldMap)) DoQuestFunctionDelay("MC_GoAway", 0.1);
	else
	{
		pchar.quest.MirageAttack_DieHard.win_condition.l1 = "MapEnter";
	    pchar.quest.MirageAttack_DieHard.function = "MC_GoAway";
	}
}

void VanBergAttackCheck(string qName)//проверка соблюдения условий
{
	if (sti(RealShips[sti(pchar.ship.type)].basetype) != SHIP_VALCIRIA || GetCompanionQuantity(pchar) > 1) FailVanBergInWorld();
	else CreateVanBergInWorld();
}

void FailVanBergInWorld()//не создаем ван Берга, если сильно умные
{
	log_testinfo("ВАН БЕРГ ПОТЕРЯН!!!");
	pchar.questTemp.HWIC.Eng = "VanBergFailInWorld";
	DoQuestFunctionDelay("GotoBridgetownOver", 5.0);
}

void CreateVanBergInWorld()//запускаем Ван Берга на карте
{
	int iRank = 15+MOD_SKILL_ENEMY_RATE;
    string sCapId = "JacobBerg";
    string sGroup = "Sea_" + sCapId + "1";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	sld = characterFromId("JacobBerg");
	FantomMakeCoolSailor(sld, SHIP_MIRAGE, "Mirage", CANNON_TYPE_CANNON_LBS20, 60, 60, 60);
	FantomMakeCoolFighter(sld, iRank, 60, 60, "blade_14", "pistol1", "bullet", 100);
	GiveItem2Character(sld, "JacobJournal");
	GiveItem2Character(sld, "sand_clock");
	GiveItem2Character(sld, "recipe_totem_13");
	GiveItem2Character(sld, "totem_13");
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	sld.AlwaysEnemy = true;
	sld.DontRansackCaptain = true;
	sld.WatchFort = true; //видеть форты
	sld.Ship.Mode = "pirate";
	RealShips[sti(sld.Ship.Type)].ship.upgrades.hull = 3;//замшелый корпус
	SetShipSailsFromFile(sld, "ships/parus_torn.tga");
	SetSailsColor(sld, 8);//черный рваный парус
	sld.AnalizeShips = true;
	sld.mapEnc.type = "war";
	sld.mapEnc.worldMapShip = "quest_ship";
	sld.mapEnc.Name = "Mirage";
	SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter(sGroup, sCapId);
    Group_SetGroupCommander(sGroup, sCapId);
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
	Map_CreateCoolWarrior("Shore37", sCapId, -1);
	
	pchar.quest.JacobAttack_Abordage.win_condition.l1 = "Character_Capture";
	pchar.quest.JacobAttack_Abordage.win_condition.l1.character = sCapId;
	pchar.quest.JacobAttack_Abordage.function = "Jacob_Attack_Win";//взяли на абордаж
	pchar.quest.JacobAttack_Sink.win_condition.l1 = "Character_sink";
	pchar.quest.JacobAttack_Sink.win_condition.l1.character = sCapId;
	pchar.quest.JacobAttack_Sink.function = "Jacob_Attack_Fail";//потопили, а нельзя было
	pchar.quest.Jacob_Journal.win_condition.l1 = "item";
	pchar.quest.Jacob_Journal.win_condition.l1.item = "JacobJournal";
	pchar.quest.Jacob_Journal.function = "JacobJournalFind";//на журнал Ван Берга
}

void Jacob_Attack_Fail(string qName)//потопили Мираж - провал
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Log_Testinfo("Ван Берг утонул!");
	pchar.quest.JacobAttack_Abordage.over = "yes";
	AddQuestRecord("Holl_Gambit", "2-14");
	pchar.quest.MirageAttack_DieHard.win_condition.l1 = "MapEnter";
    pchar.quest.MirageAttack_DieHard.function = "MC_GoAway";
	pchar.questTemp.HWIC.Eng = "MirageFail";
}

void Jacob_Attack_Win(string qName)//после боя - проверяем корабли
{
	DoQuestCheckDelay("sea_victory", 1.5);
	ChangeCharacterComplexReputation(pchar, "fame", 1);
	Log_Testinfo("Ван Берг абордирован!");
	pchar.quest.JacobAttack_Sink.over = "yes";
	int iNum = 0;
	for(i = 0; i < COMPANION_MAX; i++)
	{
		int iTemp = GetCompanionIndex(PChar, i);
		if(iTemp > 0)
		{
			sld = GetCharacter(iTemp);
			if(sti(RealShips[sti(sld.ship.type)].basetype) == SHIP_MIRAGE || sti(RealShips[sti(sld.ship.type)].basetype) == SHIP_VALCIRIA) iNum++;
		}
	}
	if (iNum != 2)
	{
		pchar.quest.MirageAttack_DieHard.win_condition.l1 = "MapEnter";
	    pchar.quest.MirageAttack_DieHard.function = "MC_GoAway";
		pchar.questTemp.HWIC.Eng = "MirageFail";//потеряли один из кораблей - провал
	}
	else
	{
		pchar.questTemp.HWIC.Eng = "MirageTake";
		SetFunctionTimerCondition("ToAntiguaMirageOver", 0, 0, 15, false); //ставим таймер
		AddComplexSeaExpToScill(100, 100, 100, 100, 100, 100, 0);
		AddCharacterExpToSkill(pchar, "Fortune", 50);//везение
	}
}

void JacobJournalFind(string qName)//нашли журнал
{
	AddQuestRecord("Holl_Gambit", "2-15");
	AddQuestRecordInfo("JacobVanBerg_Journal", "2");
	AddCharacterExpToSkill(pchar, "Fortune", 50);//везение
}

void ToAntiguaMirageOver(string qName)//если не пошел на Антигуа с Миражом
{
	DoQuestFunctionDelay("GotoBridgetownOver", 1.0);
}

void Fleetwood_RemoveShip()//удаление корабля
{
	if(sti(RealShips[sti(pchar.ship.type)].basetype) == sti(pchar.questTemp.HWIC.Eng.ShipType))
	{
		pchar.Ship.Type = GenerateShipExt(SHIP_TARTANE, true, pchar);
		pchar.Ship.name = "Boat";
		SetBaseShipData(pchar);
		SetCrewQuantityOverMax(PChar, 0);//сажаем на тартану
	}
	else
	{
		for(i = 1; i < COMPANION_MAX; i++)
		{
			int iTemp = GetCompanionIndex(PChar, i);
			if(iTemp > 0)
			{
				ref sld = GetCharacter(iTemp);
				if(sti(RealShips[sti(sld.ship.type)].basetype) == sti(pchar.questTemp.HWIC.Eng.ShipType))
				{
					pchar.questTemp.HWIC.Eng.CompanionIndex = sld.Index;
					sld = GetCharacter(sti(pchar.questTemp.HWIC.Eng.CompanionIndex));
					RemoveCharacterCompanion(PChar, sld);
					AddPassenger(PChar, sld, false);
				}
			}
		}
	}
	Pchar.questTemp.FiringOfficerIDX = GetCharacterIndex("Knippel");
	sld = &Characters[sti(Pchar.questTemp.FiringOfficerIDX)];
	CheckForReleaseOfficer(sti(Pchar.questTemp.FiringOfficerIDX));
	RemovePassenger(Pchar, sld);
	RemoveCharacterCompanion(pchar, sld);
    DeleteAttribute(sld, "Payment");
	DeleteAttribute(Pchar, "questTemp.FiringOfficerIDX");//удаляем Книппеля из офицеров
	sld = characterFromId("Knippel");
	ChangeCharacterAddressGroup(sld, "SentJons_houseH1", "goto", "goto1");//Книппеля домой
}

//--------------------------------------------3 задание-----------------------------------------------

void BoomInGrot(string qName)//взрыв
{
	if (CheckAttribute(pchar, "IsMushketer")) SetMainCharacterToMushketer("", false); // patch-5
	chrDisableReloadToLocation = true;
	CreateLocationParticles("ShipExplode", "box", "box1", 1.0, 0, 0, "boom");
	CreateLocationParticles("blast_inv", "box", "box1", 1.0, 0, 0, "");
	CreateLocationParticles("blast_dirt", "box", "box1", 1.0, 0, 0, "");
	CreateFireParticles("box", "box1");
	LAi_SetActorType(Pchar);
	LAi_ActorAnimation(Pchar, "jump", "SitInGrot", 1.0);
	ChangeCharacterAddressGroup(Pchar, "IslaDeCoche_Grot", "monsters", "monster2");
	Pchar.chr_ai.hp = stf(Pchar.chr_ai.hp)/3;
	PlaySound("People fight\Death_NPC_08.wav");
}

void StandUpInGrot(string qName)//поднимаемся на ноги
{
	LAi_SetActorType(Pchar);
	LAi_ActorAnimation(Pchar, "Ground_StandUp", "", 3.5);
	CreateLocationParticles("large_smoke", "monsters", "monster1", 1.15, 0, 0, "");
	DoQuestFunctionDelay("CreateChavinavyMonster", 3.5);
}

void CreateChavinavyMonster(string qName)//драка с монстром
{
	LAi_group_Delete("EnemyFight");
	PlaySound("ambient\horror\horror2.wav");
	LAi_SetStayType(Pchar);
	sld = GetCharacter(NPC_GenerateCharacter("Chavinavi", "Chavinavi_1", "man", "skeleton", 20+MOD_SKILL_ENEMY_RATE*3, PIRATE, -1, false, "quest"));
	FantomMakeCoolFighter(sld, 20+MOD_SKILL_ENEMY_RATE*3, 70, 70, "topor_01", "pistol6", "bullet", MOD_SKILL_ENEMY_RATE*60);
	sld.name = "Chavinavy";
	sld.lastname = "";
	sld.greeting = "";
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	sld.monster = true; // признак нежити
	sld.MultiFighter = 1.0+MOD_SKILL_ENEMY_RATE/20; // мультифайтер
	ChangeCharacterAddressGroup(sld, "IslaDeCoche_Grot", "monsters", "monster1");
	LAi_SetActorType(sld);
	LAi_ActorAnimation(sld, "Ground_sitting", "MonsterStandUp", 1.0);
}

void HeadBarmen_Find(string qName)//нашли бошку, теперь можно выходить
{
	chrDisableReloadToLocation = false;
	AddQuestRecord("Holl_Gambit", "2-19");
	pchar.questTemp.HWIC.Eng = "toAntigua";//назад к Флитвуду
	LAi_LocationDisableOfficersGen("IslaDeCoche_Grot", false);//офицеров пускать
	SetFunctionTimerCondition("Caleuche_StartTotal", 0, 0, 120, false); // таймер на Калеуче
}

//--------------------------------------------4 задание-----------------------------------------------
void HWICEng_toBarbadosOver(string qName)//опоздали до Барбадоса или Кюрасао
{
	LocatorReloadEnterDisable("SentJons_town", "houseSP3", true);//закрыть дом Флитвуда
	LocatorReloadEnterDisable("SentJons_town", "HouseF3", false);//открыть аптеку
	LocatorReloadEnterDisable("SentJons_town", "basement1_back", false);//открыть подземелье
	pchar.quest.Knippel_Shore.over = "yes";//снять прерывание
	sld = characterFromId("Knippel");
	sld.lifeday = 0;
	AddQuestRecord("Holl_Gambit", "2-20");
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Eng = "end";
	pchar.questTemp.HWIC.Detector = "eng_fail";
}

void KnippelOnCuracao(string qName)//Книппель на Кюрасао
{
	sld = characterFromId("Knippel");
	ChangeCharacterAddressGroup(sld, "Shore24", "goto", "goto1");
	sld.dialog.currentnode = "OnCuracao";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void CreateHollandShorePatrol(string qName)//патруль, драться необязательно
{
	Group_FindOrCreateGroup("HollPatrol_Attack");
	if (Whr_IsDay()) iTemp = SHIP_CORVETTE + rand(makeint(SHIP_POLACRE - SHIP_CORVETTE)); 
	else iTemp = SHIP_BRIG + rand(makeint(SHIP_GALEON_L - SHIP_BRIG)); 
    for (int i = 1; i <= 3; i++)
    {
        sld = GetCharacter(NPC_GenerateCharacter("PatrolCap_"+i, "off_hol_"+(rand(5)+1), "man", "man", 20, HOLLAND, 3, true, "hunter"));
		FantomMakeSmallSailor(sld, iTemp, "", CANNON_TYPE_CANNON_LBS20, 40+rand(10), 40+rand(15), 40+rand(15), 50+rand(15), 45+rand(15));
		FantomMakeCoolFighter(sld, 20, 50, 50, "blade_10", "pistol1", "bullet", 70);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
        sld.AlwaysEnemy = true;
        sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
        Group_AddCharacter("HollPatrol_Attack", "PatrolCap_"+i);
    }
    Group_SetGroupCommander("HollPatrol_Attack", "PatrolCap_1");
	Group_SetTaskAttack("HollPatrol_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("HollPatrol_Attack", PLAYER_GROUP);
	Group_SetAddress("HollPatrol_Attack", "Curacao", "", "");
	Group_LockTask("HollPatrol_Attack");
	
	pchar.quest.Merdok_inCave.win_condition.l1 = "location";
	pchar.quest.Merdok_inCave.win_condition.l1.location = "SentJons_TownCave";
	pchar.quest.Merdok_inCave.function = "MerdokInUndergroundCaveEng";
	LAi_LocationDisableOfficersGen("SentJons_TownCave", true);//офицеров в шахту не пускать
}

//---------------------------------------------4 задание---------------------------------------------------
void MerdokInUndergroundCaveEng(string qName)//установим Мердока в подземелье
{
	LAi_group_Delete("EnemyFight");
	LAi_LocationDisableMonGenTimer("SentJons_TownCave", 3); //монстров не генерить
	LocatorReloadEnterDisable("SentJons_TownCave", "reload2", true);//выход сразу закроем
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретим драться
	sld = characterFromId("Merdok");
	sld.greeting = "merdok_3";
	FantomMakeCoolFighter(sld, 20, 60, 60, "blade_14", "pistol3", "bullet", 100);
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	GiveItem2Character(sld, "MerdokArchive");//архив
	GiveItem2Character(sld, "MC_Letter");//письмо
	ChangeItemDescribe("MC_Letter", "itmdescr_MC_Letter3");
	GiveItem2Character(sld, "NPC_Letter");//конверт с картой клада
	ChangeItemDescribe("NPC_Letter", "itmdescr_NPC_Letter3");
	LAi_SetStayType(sld);
	ChangeCharacterAddressGroup(sld, "SentJons_TownCave", "item", "berglar1");
	pchar.quest.Merdok_Fight.win_condition.l1 = "locator";
	pchar.quest.Merdok_Fight.win_condition.l1.location = "SentJons_TownCave";
	pchar.quest.Merdok_Fight.win_condition.l1.locator_group = "item";
	pchar.quest.Merdok_Fight.win_condition.l1.locator = "berglar1";
	pchar.quest.Merdok_Fight.function = "MerdokPrepareFight";
	sld = ItemsFromID("MerdokArchive");
	sld.price = 100;
}

void CreateLucasBonanza(string qName)//создадим клад Лукаса и поставим прерывание
{
	chrDisableReloadToLocation = false;//открыть локацию
	DeleteAttribute(pchar, "GenQuest.NoDelBody");
	AddQuestRecordInfo("LetterToMerdok", "1");
	pchar.GenQuestBox.Caiman_Grot = true;
	pchar.GenQuestBox.Caiman_Grot.box1.money = 200000;
	pchar.GenQuestBox.Caiman_Grot.box1.items.Drugstore_keys = 1;//ключ
	pchar.quest.Lucas_Attack.win_condition.l1 = "location";
	pchar.quest.Lucas_Attack.win_condition.l1.location = "Caiman";
	pchar.quest.Lucas_Attack.function = "CreateLucasOnMeifeng";
	pchar.quest.Merdok_Key.win_condition.l1 = "item";
	pchar.quest.Merdok_Key.win_condition.l1.item = "Drugstore_keys";
	pchar.quest.Merdok_Key.function = "FindMerdokKey";//прерывание на ключ
}

//--------------------------------------5 задание----------------------------------------------------
void CreateLucasOnMeifeng(string qName)//создадим Лукаса на Мейфенг
{
	Island_SetReloadEnableGlobal("Caiman", false);//на остров нельзя
	bQuestDisableMapEnter = true; // patch-4
	Group_FindOrCreateGroup("Lucas_Attack");
	sld = characterFromId("Lucas");
	FantomMakeSmallSailor(sld, SHIP_MAYFANG, "Meifeng", CANNON_TYPE_CANNON_LBS20, 100, 70, 70, 90, 70);
	FantomMakeCoolFighter(sld, 25, 70, 70, "blade_30", "pistol5", "bullet", 100); // приз - офицерский катлас
    sld.AlwaysEnemy = true;
    sld.DontRansackCaptain = true;
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	GiveItem2Character(sld, "spyglass3"); // 160912
	sld.AnalizeShips = true;
	if (GetCompanionQuantity(pchar) > 1) sld.Abordage.Enable = false;//теперь попробуй взять компаньоном
	SetCharacterPerk(sld, "MusketsShoot");
	sld.ship.Crew.Morale = 100;
	sld.Ship.Crew.Exp.Sailors = 100;
	sld.Ship.Crew.Exp.Cannoners = 100;
	sld.Ship.Crew.Exp.Soldiers = 100;
	Group_AddCharacter("Lucas_Attack", "Lucas");
	Group_SetGroupCommander("Lucas_Attack", "Lucas");
	Group_SetTaskAttack("Lucas_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("Lucas_Attack", PLAYER_GROUP);
	Group_SetAddress("Lucas_Attack", "Caiman", "", "");
	Group_LockTask("Lucas_Attack");
	pchar.quest.LucasAttack_Abordage.win_condition.l1 = "Group_Death";
	pchar.quest.LucasAttack_Abordage.win_condition.l1.group = "Lucas_Attack";
	pchar.quest.LucasAttack_Abordage.function = "Lucas_Attack_Win";
}

void Lucas_Attack_Win(string qName)//победа
{
	DoQuestCheckDelay("sea_victory", 1.5);
	bQuestDisableMapEnter = false; // patch-4
	Group_DeleteGroup("Lucas_Attack");
	AddQuestRecord("Holl_Gambit", "2-25");
	Island_SetReloadEnableGlobal("Caiman", true);
	RemoveItems(PChar, "NPC_Letter", 1);
	RemoveItems(PChar, "MC_Letter", 1);//подчистим предметы
	AddComplexSeaExpToScill(150, 150, 150, 150, 150, 150, 0);
	SetFunctionTimerCondition("LucasQuit", 0, 0, 10, false); // 021012
	ChangeCharacterComplexReputation(pchar, "fame", 5);
}

///----------------------------Голландский Гамбит, часть 3 - против всех-------------------------------

//--------------------------------------------1 задание-----------------------------------------------
void CreateFernandoOnLand(string qName)//испанец в городе
{
	pchar.questTemp.HWIC.Self = "FernandoCreated";
	sld = GetCharacter(NPC_GenerateCharacter("HWICFernando", "Rodriges", "man", "man", 20, SPAIN, 1, false, "quest"));
	FantomMakeCoolFighter(sld, 20, 50, 50, "blade_09", "pistol1", "bullet", 50);
	sld.name = "Fernando";
	sld.lastname = "Rodriges";
	sld.greeting = "hambit_other_5";
	sld.dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
	sld.dialog.currentnode = "Fernando";
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	GiveItem2Character(sld, "Finger");//палец
	GiveItem2Character(sld, "jewelry7");//голубой янтарь
	GiveItem2Character(sld, "totem_05");//железный пуп
	GiveItem2Character(sld, "amulet_1"); //щит Нгомбо
	sld.money = 18250;
	LAi_SetCitizenType(sld);
	LAi_SetCheckMinHP(sld, (LAi_GetCharacterHP(sld) - 1), false, "Fernando_FightInPort");//сработает на атаку
	LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
	ChangeCharacterAddressGroup(sld, pchar.questTemp.HWIC.Self.SpainCity +"_town", "patrol", "patrol1");
}

void CreateFernandoOnSea(string qName)//испанец на море
{
	pchar.questTemp.HWIC.Self = "FernandoCreated";
	Island_SetReloadEnableGlobal(pchar.questTemp.HWIC.Self.FernandoIslandID, false);//на остров нельзя
	Group_FindOrCreateGroup("Fernando_Attack");
	Group_SetType("Fernando_Attack", "war");
	sld = GetCharacter(NPC_GenerateCharacter("HWICFernando", "Rodriges", "man", "man", 20, SPAIN, -1, false, "quest"));
	FantomMakeSmallSailor(sld, SHIP_BRIGANTINE, "", CANNON_TYPE_CANNON_LBS16, 45, 40, 40, 50, 50);
	FantomMakeCoolFighter(sld, 20, 50, 50, "blade_09", "pistol1", "bullet", 150);
	sld.name = "Fernando";
	sld.lastname = "Rodriges";
	sld.greeting = "hambit_other_5";
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	GiveItem2Character(sld, "Finger");//палец
	GiveItem2Character(sld, "jewelry7");//голубой янтарь
	GiveItem2Character(sld, "totem_05");//железный пуп
	GiveItem2Character(sld, "amulet_1"); //щит Нгомбо
	sld.DontRansackCaptain = true; 
	sld.AnalizeShips = true;
	sld.money = 18250;
	Group_AddCharacter("Fernando_Attack", "HWICFernando");

	Group_SetGroupCommander("Fernando_Attack", "HWICFernando");
	Group_SetTaskRunaway("Fernando_Attack", PLAYER_GROUP);//пусть погоняется
	Group_SetAddress("Fernando_Attack", pchar.questTemp.HWIC.Self.FernandoIslandID, "quest_ships", "Quest_ship_6");
	Group_LockTask("Fernando_Attack");
	
    pchar.quest.HWICFernando_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.HWICFernando_AfterBattle.win_condition.l1.group = "Fernando_Attack";
	pchar.quest.HWICFernando_AfterBattle.function = "Fernando_AfterBattle";
	pchar.quest.HWICFernando_DieHard.win_condition.l1 = "MapEnter";
    pchar.quest.HWICFernando_DieHard.function = "Fernando_DieHard";
}

void Fernando_AfterBattle(string qName)//победа
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.TargetFernandoOver.over = "yes";
	pchar.quest.HWICFernando_DieHard.over = "yes";
	Island_SetReloadEnableGlobal(pchar.questTemp.HWIC.Self.FernandoIslandID, true);
	Group_DeleteGroup("Fernando_Attack");
	pchar.questTemp.HWIC.Self = "FernandoDie";
	AddQuestRecord("Holl_Gambit", "3-6");
	AddComplexSeaExpToScill(50, 50, 50, 50, 50, 50, 0);
}

void Fernando_DieHard(string qName)//ушли или не догнали
{
	pchar.quest.TargetFernandoOver.over = "yes";
	pchar.quest.HWICFernando_AfterBattle.over = "yes";
	Island_SetReloadEnableGlobal(pchar.questTemp.HWIC.Self.FernandoIslandID, true);
	Group_DeleteGroup("Fernando_Attack");
	sld = characterFromId("HWICFernando");
	sld.lifeday = 0;
	AddQuestRecord("Holl_Gambit", "3-7");
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Fail3 = "true";
	DeleteAttribute(pchar, "questTemp.HWIC.Self");//зачищаем для возможности отката к иному варианту
}

void Fernando_died(string qName)//клиент готов
{
	chrDisableReloadToLocation = false;
	pchar.questTemp.HWIC.Self = "FernandoDie";
	pchar.quest.TargetFernandoOver.over = "yes";
	AddQuestRecord("Holl_Gambit", "3-5");
	AddComplexSelfExpToScill(50, 50, 50, 50);
}

void TargetFernandoOver(string qName)//опоздали
{
	if (pchar.questTemp.HWIC.Self == "KillFernando") pchar.quest.HWIC_Fernando.over = "yes";
	if (pchar.questTemp.HWIC.Self == "FernandoCreated")
	{
		sld = characterFromId("HWICFernando");
		LAi_SetImmortal(sld, true);
		sld.lifeday = 0;
		LAi_CharacterDisableDialog(sld);
	}
	AddQuestRecord("Holl_Gambit", "3-4");
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Fail3 = "true";
	DeleteAttribute(pchar, "questTemp.HWIC.Self");//зачищаем для возможности отката к иному варианту
}

//--------------------------------------------2 задание----------------------------------------------
void CreateFleetwoodSoldiers()//солдаты в доме Флитвуда
{
	for (i=1; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Fleetwood_sold_"+i, "sold_eng_"+i, "man", "man", 35, ENGLAND, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, 35, 80, 80, "blade_11", "pistol6", "bullet", 150);//подразделение альфа
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		TakeNItems(sld, "potion2", 2);
		LAi_SetWarriorType(sld);
		if (i == 1)
		{
			LAi_SetHP(sld, 500, 500);
			LAi_warrior_DialogEnable(sld, true);
			sld.greeting = "soldier";
			sld.Dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
			sld.dialog.currentnode = "Fleetwood_soldier";
		}
		ChangeCharacterAddressGroup(sld, "SentJons_houseSP3", "goto", "goto"+i);
		LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
	}
}

void Fleetwood_Soldier(string qName)//get out!
{
	sld = characterFromId("Fleetwood_sold_1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void FleetwoodJournalOver(string qName)//провалили по срокам
{
	pchar.quest.Fleetwood_Journal.over = "yes";//снять прерывание на ключ, а вот солдат в доме оставлю
	RemoveItems(PChar, "key3", 1);
	AddQuestRecord("Holl_Gambit", "3-11");
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Detector = "self_fail";
}

void FleetwoodHouseEnter(string qName)//открываем дверь
{
	LAi_LocationFightDisable(&Locations[FindLocation("SentJons_houseSP3")], false);//можно драться
	pchar.quest.Fleetwood_Soldier.over = "yes";
	PlaySound("interface\key.wav");//щелк!
	pchar.questTemp.HWIC.Self.Theft = "true";//атрибут вторжения
	for (i=2; i<=4; i++)
	{
		sld = characterFromId("Fleetwood_sold_"+i);
		sld.lifeday = 0;//уберем лишних солдеров
	}
	sld = characterFromId("Fleetwood_sold_1");
	LAi_SetStayType(sld);
	LAi_SetHP(sld, 10, 500);
	sld.dialog.currentnode = "Theft_soldier";
	GiveItem2Character(sld, "key2");
	ChangeCharacterAddressGroup(sld, "SentJons_houseSP3", "barmen", "bar2");
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	RemoveItems(PChar, "key3", 1);
	DoQuestReloadToLocation("SentJons_houseSP3", "reload", "reload1", "");
	pchar.quest.Fleetwood_Room.win_condition.l1 = "item";
	pchar.quest.Fleetwood_Room.win_condition.l1.item = "key2";
	pchar.quest.Fleetwood_Room.win_condition.l2 = "locator";
	pchar.quest.Fleetwood_Room.win_condition.l2.location = "SentJons_houseSP3";
	pchar.quest.Fleetwood_Room.win_condition.l2.locator_group = "reload";
	pchar.quest.Fleetwood_Room.win_condition.l2.locator = "reload2";
	pchar.quest.Fleetwood_Room.function = "FindRoomKey";
}

void FindRoomKey(string qName)//открываем дверь
{
	PlaySound("interface\key.wav");//щелк!
	LocatorReloadEnterDisable("SentJons_houseSP3", "reload2", false);//комнату откроем
	pchar.quest.Fleetwood_Book.win_condition.l1 = "item";
	pchar.quest.Fleetwood_Book.win_condition.l1.item = "FleetwoodJournal";
	pchar.quest.Fleetwood_Book.win_condition.l2 = "location";
	pchar.quest.Fleetwood_Book.win_condition.l2.location = "SentJons_houseSP3";
	pchar.quest.Fleetwood_Book.function = "FirstFloorFight";
}

void FirstFloorFight(string qName)//драка в доме
{
	pchar.quest.FleetwoodJournalOver.over = "yes"; //снять таймер
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запрет драки до разговора
	for (i=1; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Attack_sold_"+i, "sold_eng_"+i, "man", "man", 20, ENGLAND, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, 20, 50, 50, "blade_10", "pistol6", "bullet", 50);//подразделение альфа
		LAi_SetWarriorType(sld);
		if (i == 4)
		{
			LAi_warrior_DialogEnable(sld, true);
			sld.greeting = "soldier_arest";
			sld.Dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
			sld.dialog.currentnode = "Attack_soldier";
		}
		ChangeCharacterAddressGroup(sld, "SentJons_houseSP3", "goto", "goto"+i);
		LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
	}
	sld = characterFromId("Attack_sold_4");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void SJ_StreetFight(string qName)//драка на улице - Тонзаг в помощь
{
	chrDisableReloadToLocation = true;
	pchar.GenQuest.Notsearchbody = true;//запрет обыска трупов
	for (i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Attack2_sold_"+i, "sold_eng_"+i, "man", "man", 20, ENGLAND, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, 20, 60, 60, "blade_19", "pistol4", "bullet", 60);//подразделение альфа
		LAi_SetWarriorType(sld);
		ChangeCharacterAddressGroup(sld, "SentJons_town", "goto", "goto1");
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	sld = characterFromId("Tonzag");
	LAi_SetWarriorType(sld);
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "SentJons_town", "patrol", "patrol10");
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "MC_deafenning");
}

void InMerdokHouse(string qName)//телепорт в аптеку
{
	DoQuestReloadToLocation("SentJons_HouseF3_Room2", "barmen", "bar1", "MerdokTalkToMC");
	RemoveItems(PChar, "key2", 1);
	RemoveItems(PChar, "FleetwoodJournal", 1);
	DeleteAttribute(pchar, "GenQuest.Notsearchbody");//снять запрет обыска трупов
	sld = characterFromId("Merdok");
	sld.greeting = "";
}

void TonzagMeeting(string qName)//встреча друзей
{
	sld = characterFromId("Tonzag");
	sld.Dialog.Filename = "Quest\HollandGambit\Tonzag.c";
	sld.dialog.currentnode = "First time";
	ChangeCharacterAddressGroup(sld, "SentJons_town", "patrol", "patrol14");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

//-----------------------------------------3 задание----------------------------------------------------
void Wait_FleetwoodOver(string qName)//не пришел за 12 дней, хотя срок был - неделя
{
	pchar.questTemp.HWIC.Self = "HWICSelf_fail";
}

void HuntKnippelOver(string qName)//опоздал за Чарли
{
	pchar.quest.Hunt_Knippel.over = "yes"; //снять прерывание
	AddQuestRecord("Holl_Gambit", "3-17");
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Self = "end";
	pchar.questTemp.HWIC.Detector = "self_fail";
}

void CreateKnippelShip(string qName)//создаем бригантину Чарли
{
	pchar.quest.HuntKnippelOver.over = "yes";//снять таймер
	Island_SetReloadEnableGlobal("Curacao", false);//на остров нельзя
	Group_FindOrCreateGroup("Knippel_Attack");
	Group_SetType("Knippel_Attack", "war");
	sld = characterFromId("Knippel");
	sld.nation = HOLLAND;
	FantomMakeSmallSailor(sld, SHIP_BRIGANTINE, "Zeekalf", CANNON_TYPE_CULVERINE_LBS18, 45, 90, 85, 30, 80);
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	sld.DontRansackCaptain = true; 
	sld.AnalizeShips = true;
	sld.Alwaysenemy = true;
	sld.Coastal_Captain = true;
	SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("Knippel_Attack", "Knippel");
	Group_SetGroupCommander("Knippel_Attack", "Knippel");
	Group_SetTaskRunaway("Knippel_Attack", PLAYER_GROUP);//пусть погоняется
	Group_SetAddress("Knippel_Attack", "Curacao", "", "");
	Group_SetPursuitGroup("Knippel_Attack", PLAYER_GROUP);
	Group_LockTask("Knippel_Attack");
	
    pchar.quest.Knippel_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Knippel_AfterBattle.win_condition.l1.group = "Knippel_Attack";
	pchar.quest.Knippel_AfterBattle.function = "Knippel_AfterBattle";
	pchar.quest.Knippel_DieHard.win_condition.l1 = "MapEnter";
    pchar.quest.Knippel_DieHard.function = "Knippel_DieHard";
}

void Knippel_AfterBattle(string qName)//реакция на победу
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Island_SetReloadEnableGlobal("Curacao", true);
	if(pchar.questTemp.HWIC.Self != "KnippelPrisoner")
	{
	    pchar.quest.Knippel_DieHard.over = "yes";
		Group_DeleteGroup("Knippel_Attack");
		AddQuestRecord("Holl_Gambit", "3-18");
		CloseQuestHeader("Holl_Gambit");
		pchar.questTemp.HWIC.Self = "end";
		pchar.questTemp.HWIC.Detector = "self_fail";
		Log_TestInfo("КНИППЕЛЬ УТОНУЛ!");
	}
	else
	{
		Log_TestInfo("КНИППЕЛЬ В ТРЮМЕ!");
		AddComplexSeaExpToScill(100, 100, 100, 200, 100, 100, 0);
		AddComplexSelfExpToScill(60, 60, 60, 60);
		AddCharacterExpToSkill(pchar, "Fortune", 100);//везение
		ref chr = GetCharacter(NPC_GenerateCharacter("KnippelClone", "Kneepel", "man", "man_B", 25, ENGLAND, -1, false, "quest"));
		chr.name = "Charlie";
		chr.lastname = "Knippel";
		LAi_SetGroundSitType(chr);
		ChangeCharacterAddressGroup(chr, "My_Deck", "rld", "aloc3");
		chr.Dialog.Filename = "Quest\HollandGambit\Knippel.c";
		chr.Dialog.CurrentNode = "Knippel_prisoner";
		for (i=1; i<=2; i++)
		{
			sld = GetCharacter(NPC_GenerateCharacter("Sailor_"+i, "citiz_"+(30+i), "man", "man", 25, pchar.nation, -1, false, "soldier"));
			LAi_SetStayType(sld);
			LAi_CharacterDisableDialog(sld);
			if (i == 1) ChangeCharacterAddressGroup(sld, "My_Deck", "rld", "aloc2");
			else ChangeCharacterAddressGroup(sld, "My_Deck", "rld", "loc3");
		}
		sld = GetCharacter(NPC_GenerateCharacter("Sailor_3", "citiz_36", "man", "man", 25, pchar.nation, -1, false, "soldier"));
		sld.name 	= "Alonso";
		sld.lastname = "";
		sld.greeting = "hambit_other_4";
		sld.Dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
		sld.dialog.currentnode = "Sailor_deck";
		ChangeCharacterAddressGroup(sld, "My_Deck", "goto", "goto1");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void Knippel_DieHard(string qName)//ушел на карту
{
	Island_SetReloadEnableGlobal("Curacao", true);
	pchar.quest.Knippel_AfterBattle.over = "yes"; //снять прерывание
	Group_DeleteGroup("Knippel_Attack");
	AddQuestRecord("Holl_Gambit", "3-19");
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Self = "end";
	pchar.questTemp.HWIC.Detector = "self_fail";
	sld = characterFromId("Knippel");	
	sld.lifeday = 0; 
}

void AbigileGoToShipOver(string qName)//просрочили забрать Аби
{
	pchar.quest.Abigile_Kidnap.over = "yes"; //снять прерывание
	pchar.questTemp.HWIC.Self = "AbigileNextDayOver";
	sld = characterFromId("Abigile");
	sld.lifeday = 0;
}

void AbigileGoToShip(string qName)//забираем Аби
{
	pchar.questTemp.HWIC.Self = "AbigileNextDay";
	sld = characterFromId("Abigile");
	ChangeCharacterAddressGroup(sld, "Villemstad_houseSP2", "goto", "goto2");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

//удаление Книппеля, Лонгвэя и Абигайль, если геймер затянул прохождение
void RemoveAbigileOver(string qName)//удаление Абигайль
{
	pchar.quest.Abigile_died.over = "yes";//снять прерывание на убийство Аби
	sld = characterFromId("Abigile");
	RemovePassenger(Pchar, sld);
	sld.lifeday = 0;
	AddQuestRecord("Holl_Gambit", "3-67");
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Self = "end";
	pchar.questTemp.HWIC.Detector = "self_fail";
	Log_Info("Abigail died of calenture!");
}

void RemoveKnippelOver(string qName)//удаление Книппеля (клона в трюме)
{
	sld = characterFromId("KnippelClone");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld.lifeday = 0;
	for (i=1; i<=3; i++)//уберем охрану
	{
		sld = characterFromId("Sailor_"+i);
		sld.lifeday = 0;
		ChangeCharacterAddressGroup(sld, "none", "", "");
	}
	AddQuestRecord("Holl_Gambit", "3-68");
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Self = "end";
	pchar.questTemp.HWIC.Detector = "self_fail";
	Log_Info("Charlie Knippel died of wounds!");
}

void RemoveLongwayOver(string qName)//удаление Лонгвэя (клона в трюме)
{
	sld = characterFromId("LongwayClone");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld.lifeday = 0;
	for (i=1; i<=3; i++)//уберем охрану
	{
		sld = characterFromId("Sailor_"+i);
		sld.lifeday = 0;
		ChangeCharacterAddressGroup(sld, "none", "", "");
	}
	if (pchar.questTemp.HWIC.Self == "GotoGuadeloupe")
	{
	AddQuestRecord("Holl_Gambit", "3-71");
	Log_Info("Longway died of calenture!");
	}
	else
	{
	AddQuestRecord("Holl_Gambit", "3-70");
	Log_Info("Longway died of wounds!");
	}
	if (CheckShipTypeInSquadron(SHIP_MAYFANG) > 0)//если есть шебека - отберем
		{
			pchar.quest.Remove_Meifeng.win_condition.l1 = "Location_Type";
			pchar.quest.Remove_Meifeng.win_condition.l1.location_type = "town";
			pchar.quest.Remove_Meifeng.function = "RemoveMeifeng";
		}
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Self = "end";
	pchar.questTemp.HWIC.Detector = "self_fail";
}

void AbigileDied(string qName)//для отморозков, решивших пострелять по Аби
{
	sld = characterFromId("Abigile");
	sld.lifeday = 0;
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Self = "end";
	pchar.questTemp.HWIC.Detector = "self_fail";
	ChangeCharacterComplexReputation(pchar, "nobility", -30);
	ChangeCharacterHunterScore(PChar, "holhunter", 50);
}

//-------------------------------------------4 задание------------------------------------------------
void MC_writeLetterGo(string qName)//пишем письмо
{
	SetLaunchFrameFormParam("An hour passed...", "", 0, 5);
	LaunchFrameForm();
	WaitDate("", 0, 0, 0, 1, 10); //крутим время
	RecalculateJumpTable();
	DoQuestFunctionDelay("MC_writeLetterDone", 5.0);
}

void MC_writeLetterDone(string qName)//написали письмо
{
	GiveItem2Character(pchar, "MC_Letter");
	AddQuestRecordInfo("LetterToFleetwood", "1");
	pchar.questTemp.HWIC.Self = "LetterToFleetwood";
	LAi_SetPlayerType(pchar);
	ChangeCharacterAddressGroup(pchar, "SentJons_HouseF3", "goto", "goto4");
	sld = characterFromId("Merdok");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	//уберем табурет
	sld = ItemsFromID("lcheer");
	sld.shown = false;
	sld.startLocation = "none";
	sld.startLocator = "";
}

void CreateDrunckardInTavern()//создаем пьянтоса
{
	pchar.questTemp.HWIC.Self = "LetterToDrunkard";
	FreeSitLocator("Sentjons_tavern", "sit_front1");
	sld = GetCharacter(NPC_GenerateCharacter("Drunkard", "panhandler_6", "man", "man", 10, ENGLAND, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 10, 10, 10, "topor_1", "pistol3", "bullet", 50);
	RemoveAllCharacterItems(sld, true);
	sld.name = "Jack";
	sld.lastname = "Harrison";
	sld.dialog.FileName = "Quest\HollandGambit\OtherNPC.c";
	sld.dialog.currentnode = "Drunkard";
	sld.greeting = "poorman_male";
	LAi_SetSitType(sld);
	LAi_SetImmortal(sld, true);
	LAi_SetLoginTime(sld, 16.0, 21.0);
	ChangeCharacterAddressGroup(sld, "Sentjons_tavern", "sit", "sit_front1");
}

void DrunkardReturnToTavern(string qName)//пьянтос идет назад в таверну
{
	sld = characterFromId("Drunkard");
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "SentJons_town", "reload", "houseSP3");
	LAi_ActorGoToLocation(sld, "reload", "reload4_back", "SentJons_tavern", "reload", "reload1", "DrunkardSitInTavern", -1);	
}

void Fleetwood_meetingOver(string qName)//не пришли на встречу вовремя
{
	pchar.quest.Fleetwood_meetingShore.over = "yes";
	pchar.quest.Abigile_died.over = "yes";//снять прерывание на убийство Аби
	AddQuestRecord("Holl_Gambit", "3-29");
	sld = characterFromId("Abigile");
	sld.lifeday = 0;//убираем Аби
	pchar.questTemp.HWIC.Self = "end";
	pchar.questTemp.HWIC.Detector = "self_fail";
	CloseQuestHeader("Holl_Gambit");
}

void InTerksShore(string qName)//пришли на Теркс в бухту
{
	if (pchar.location.from_sea == "Shore57")
	{
		pchar.quest.Fleetwood_meetingOver.over = "yes";//снять таймер
		SetFunctionTimerCondition("Fleetwood_ShoreOver", 0, 0, 5, false);//новый таймер, чтобы не занимался ерундой
		AddQuestRecord("Holl_Gambit", "3-33");
		for (i=1; i<=7; i++)//организуем засаду
		{
			sld = GetCharacter(NPC_GenerateCharacter("OwrSailor_"+i, "citiz_"+(30+i), "man", "man", 20, sti(pchar.nation), -1, false, "soldier"));
			FantomMakeCoolFighter(sld, 20, 40, 40, "blade_14", "pistol1", "bullet", 70);
			DeleteAttribute(sld, "SaveItemsForDead");
			DeleteAttribute(sld, "DontClearDead");
			LAi_SetStayType(sld);
			LAi_CharacterDisableDialog(sld);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
			if (i == 1 || i == 2 || i == 3) ChangeCharacterAddressGroup(sld, "Shore56", "smugglers", "smuggler0"+i);
			if (i == 4 || i == 5) ChangeCharacterAddressGroup(sld, "Shore56", "goto", "goto"+(8+i));
			if (i == 6 || i == 7) ChangeCharacterAddressGroup(sld, "Shore56", "goto", "goto"+(13-i));
		}
		pchar.quest.Fleetwood_Login.win_condition.l1 = "Timer";
		pchar.quest.Fleetwood_Login.win_condition.l1.date.hour  = sti(GetTime()+rand(6));
		pchar.quest.Fleetwood_Login.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 1);
		pchar.quest.Fleetwood_Login.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 1);
		pchar.quest.Fleetwood_Login.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 1);
		pchar.quest.Fleetwood_Login.win_condition.l2 = "location";
		pchar.quest.Fleetwood_Login.win_condition.l2.location = "Shore56";
		pchar.quest.Fleetwood_Login.function = "CreateFleetwoodInShore";
	}
	else
	{
		pchar.questTemp.HWICMC = "Fleetwood";
		DoQuestCheckDelay("TalkSelf_Quest", 1.0);
	}
}

void Fleetwood_repeatShore(string qName)//если пришли не туда или тупые сильно
{
	pchar.quest.Fleetwood_meetingShore.win_condition.l1 = "location";
	pchar.quest.Fleetwood_meetingShore.win_condition.l1.location = "Shore56";
	pchar.quest.Fleetwood_meetingShore.function = "InTerksShore";//дубль два(три, четыре...)
}

void Fleetwood_ShoreOver(string qName)//если страдали фигней, а не делом занимались, для особо упоротых
{
	pchar.quest.Fleetwood_Login.over = "yes";
	pchar.quest.Abigile_died.over = "yes";//снять прерывание на убийство Аби
	AddQuestRecord("Holl_Gambit", "3-30");
	sld = characterFromId("Abigile");
	sld.lifeday = 0;//убираем Аби
	for (i=1; i<=7; i++)
	{
		sld = characterFromId("OwrSailor_"+i);
		sld.lifeday = 0;//убираем засаду
	}
	pchar.questTemp.HWIC.Self = "end";
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Detector = "self_fail";
}

void CreateFleetwoodInShore(string qName)//явился Флитвуд
{
	if (pchar.location.from_sea == "Shore57")
	{
		LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретим драться
		chrDisableReloadToLocation = true;//закрыть локацию
		ref chr = characterFromId("Fleetwood");
		FantomMakeCoolFighter(chr, 25, 70, 70, "blade_14", "pistol3", "bullet", 100);//крутой парень
		chr.SaveItemsForDead = true;
		chr.DontClearDead = true;
		chr.dialog.currentnode = "InTerksShore";
		chr.greeting = "fleetwood_3";
		LAi_SetStayType(chr);
		ChangeCharacterAddressGroup(chr, "Shore56", "goto", "goto10");
		for (i=1; i<=3; i++)//офицеры
		{
			sld = GetCharacter(NPC_GenerateCharacter("FlOfficer_"+i, "sold_eng_"+i, "man", "man", 20, ENGLAND, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, 20, 40, 40, "blade_13", "pistol3", "bullet", 70);
			DeleteAttribute(sld, "SaveItemsForDead");
			DeleteAttribute(sld, "DontClearDead");
			LAi_SetStayType(sld);
			LAi_CharacterDisableDialog(sld);
			ChangeCharacterAddressGroup(sld, "Shore56", "officers", "sea_"+i);
		}
	}
}

void CreateValkiriaBrig(string qName)//создаем Валькирию без Флитвуда
{
	Island_SetReloadEnableGlobal("Terks", false);//на остров нельзя
	bQuestDisableMapEnter = true;//на карту тоже
	Group_FindOrCreateGroup("Val_Attack");
	Group_SetType("Val_Attack", "war");
	sld = GetCharacter(NPC_GenerateCharacter("ValCap", "off_eng_4", "man", "man", 25, ENGLAND, -1, true, "quest"));
	FantomMakeSmallSailor(sld, SHIP_VALCIRIA, "Valkyrie", CANNON_TYPE_CANNON_LBS20, 50, 60, 60, 60, 60);
	sld.DontRansackCaptain = true; 
	sld.AnalizeShips = true;
	sld.Alwaysenemy = true;
	sld.Coastal_Captain = true;
	SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("Val_Attack", "ValCap");
	Group_SetGroupCommander("Val_Attack", "ValCap");
	Group_SetTaskAttack("Val_Attack", PLAYER_GROUP);
	Group_SetAddress("Val_Attack", "Terks", "quest_ships", "quest_ship_1");
	Group_LockTask("Val_Attack");
	
    pchar.quest.Val_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Val_AfterBattle.win_condition.l1.group = "Val_Attack";
	pchar.quest.Val_AfterBattle.function = "Valkiria_AfterBattle";
}

void Valkiria_AfterBattle(string qName)//после боя - неважно, потопил или взял
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Group_DeleteGroup("Val_Attack");
	Island_SetReloadEnableGlobal("Terks", true);
	bQuestDisableMapEnter = false;
	AddQuestRecord("Holl_Gambit", "3-32");
	pchar.questTemp.HWIC.Self = "FleetwoodDied";
}

void TonzagMeetingInDange(string qName)//Тонзаг в подземелье
{
	sld = characterFromId("Tonzag");
	ChangeCharacterAddressGroup(sld, "SentJons_TownCave", "item", "berglar1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

//----------------------------------------------5 задание---------------------------------------------------
void HWICCureerOnMapOver(string qName)//не перехватили курьера
{
	pchar.quest.HWICCureer_AfterBattle.over = "yes"; //снять прерывание
	pchar.quest.Abigile_died.over = "yes";//снять прерывание на убийство Аби
	Group_DeleteGroup("Sea_CureerCap1");
	AddQuestRecord("Holl_Gambit", "3-37");
	sld = characterFromId("Abigile");
	sld.lifeday = 0;//убираем Аби
	RemoveItems(PChar, "MC_Letter", 1);
	pchar.questTemp.HWIC.Self = "end";
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Detector = "self_fail";
}

void CreateHWICCureerOnMap(string qName)//энкаунтер курьера на карте
{
    string sGroup = "Sea_CureerCap1";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	sld = GetCharacter(NPC_GenerateCharacter("CureerCap", "citiz_41", "man", "man", 20, HOLLAND, 15, true, "quest"));
	FantomMakeSmallSailor(sld, SHIP_BRIGANTINE, "Hoop", CANNON_TYPE_CANNON_LBS16, 50, 45, 45, 50, 60);
	SetCaptanModelByEncType(sld, "war");
	SetRandomNameToCharacter(sld);
	LAi_SetHP(sld, 100+MOD_SKILL_ENEMY_RATE*30, 100+MOD_SKILL_ENEMY_RATE*30);
		sld.AlwaysEnemy = true;
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.Coastal_Captain = true; //не ссорить нации
		sld.Ship.Crew.Morale = MOD_SKILL_ENEMY_RATE*10;
		sld.Ship.Crew.Exp.Sailors = MOD_SKILL_ENEMY_RATE*10;
		sld.Ship.Crew.Exp.Cannoners = MOD_SKILL_ENEMY_RATE*10;
		sld.Ship.Crew.Exp.Soldiers = MOD_SKILL_ENEMY_RATE*10;
		UpgradeShipParameter(sld, "SpeedRate");
		UpgradeShipParameter(sld, "Capacity");
		UpgradeShipParameter(sld, "WindAgainstSpeed");
		UpgradeShipParameter(sld, "TurnRate");
		if (MOD_SKILL_ENEMY_RATE > 4) TakeNItems(sld, "potion2", 3);
		SetCharacterPerk(sld, "HullDamageUp");
		SetCharacterPerk(sld, "SailsDamageUp");
		SetCharacterPerk(sld, "CrewDamageUp");
		SetCharacterPerk(sld, "CriticalShoot");
		SetCharacterPerk(sld, "MusketsShoot");
		SetCharacterPerk(sld, "AdvancedBattleState");
		SetCharacterPerk(sld, "ShipDefenseProfessional");
		SetCharacterPerk(sld, "LongRangeShoot");
		SetCharacterPerk(sld, "ShipTurnRateUp");
		SetCharacterPerk(sld, "ShipSpeedUp");
		DeleteAttribute(sld, "SinkTenPercent");
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.mapEnc.type = "war";
		sld.mapEnc.worldMapShip = "quest_ship";
        sld.mapEnc.Name = "brigantine 'Hoop'";
        Group_AddCharacter(sGroup, "CureerCap");
	Group_SetGroupCommander(sGroup, "CureerCap");
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
	Map_CreateTrader("Shore41", "Shore39", "CureerCap", 16);//запуск энкаунтера - до Мартиники, до Кюрасао нельзя
	pchar.quest.HWICCureer_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.HWICCureer_AfterBattle.win_condition.l1.group = sGroup;
	pchar.quest.HWICCureer_AfterBattle.function = "HWICCureer_AfterBattle";
}

void HWICCureer_AfterBattle(string qName)//утопили курьера
{
	pchar.quest.HWICCureerOnMapOver.over = "yes";
	pchar.quest.Abigile_died.over = "yes";//снять прерывание на убийство Аби
	Group_DeleteGroup("Sea_CureerCap1");
	Log_testInfo("КУРЬЕР УТОНУЛ!");
	AddQuestRecord("Holl_Gambit", "3-38");
	sld = characterFromId("Abigile");
	sld.lifeday = 0;//убираем Аби
	RemoveItems(PChar, "MC_Letter", 1);
	pchar.questTemp.HWIC.Self = "end";
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Detector = "self_fail";
}

void CuracaoExploring(string qName)//на Кюрасао
{
	//Мейфенг с китайцем в порту
	AddQuestRecord("Holl_Gambit", "3-40");
	Group_FindOrCreateGroup("Meifeng_Empty");
	Group_SetType("Meifeng_Empty", "pirate");//тип группы
	sld = characterFromId("Longway");
	FantomMakeSmallSailor(sld, SHIP_MAYFANG, "Meifeng", CANNON_TYPE_CANNON_LBS20, 50, 65, 65, 50, 90);
	Character_SetAbordageEnable(sld, false);//нельзя абордировать
	sld.AnalizeShips = true;
	SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("Meifeng_Empty", "Longway");
	Group_SetGroupCommander("Meifeng_Empty", "Longway");
	Group_SetAddress("Meifeng_Empty", "Curacao", "Islandships1", "ship_2");
	pchar.quest.Meifeng_fail.win_condition.l1 = "NPC_Death";
	pchar.quest.Meifeng_fail.win_condition.l1.character = "Longway";
	pchar.quest.Meifeng_fail.function = "HollGambitSelf_failed";//для особо умных
	//подготовим Виллемстад к посещению ГГ
	LocatorReloadEnterDisable("Villemstad_town", "reload3_back", true);//закрыть вход в резиденцию
	LocatorReloadEnterDisable("Villemstad_town", "reloadR1", true);//закрыть боковой вход в резиденцию
	sld = characterFromId("hol_guber");
	LAi_SetStayType(sld);
	sld.Dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
	sld.dialog.currentnode = "MatiasBek";
	ChangeCharacterAddressGroup(sld, "Villemstad_prison", "goto", "goto9");//Бека - в тюрьму
	sld = characterFromId("Lucas");
	LAi_SetHuberType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_townhall", "sit", "sit1");//Лукаса - на место губера
	sld = &characters[GetCharacterbyLocation("Villemstad_town", "soldiers", "soldier1")];
    sld.Dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
	sld.dialog.currentnode = "QuestGuard";
    sld.protector = true;
    sld.protector.CheckAlways = 1;//всегда проверять
    LAi_RemoveLoginTime(sld);
    LoginCharacter(sld, "Villemstad_town");//квестовый стражник
}

void HollGambitSelf_failed(string qName)//если у кого-то хватит наглости
{
	if (pchar.questTemp.HWIC.Self == "LetterToLucasSent")
	{
		Group_DeleteGroup("Meifeng_Empty");
		AddQuestRecord("Holl_Gambit", "3-41");
		ChangeCharacterHunterScore(PChar, "holhunter", 100); //начислить НЗГ
	}
	if (pchar.questTemp.HWIC.Self == "MeetingStivesant")
	{
		Group_DeleteGroup("Stivesant_Halleon");
		AddQuestRecord("Holl_Gambit", "3-42");
		ChangeCharacterHunterScore(PChar, "holhunter", 100); //начислить НЗГ
	}
	if (pchar.questTemp.HWIC.Self == "WayWithStivesant")
	{
		Group_DeleteGroup("Stivesant_Halleon");
		AddQuestRecord("Holl_Gambit", "3-43");
	}
	pchar.quest.Abigile_died.over = "yes";//снять прерывание на убийство Аби
	sld = characterFromId("Abigile");
	sld.lifeday = 0;//убираем Аби
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Self = "end";
	pchar.questTemp.HWIC.Detector = "self_fail";
}

void CreateMeifengOnMap(string qName)//энкаунтер Мейфенг на карте
{
    string sGroup = "Sea_Meifeng1";
	Group_FindOrCreateGroup(sGroup);
	Group_SetType(sGroup, "pirate");//тип группы
	sld = characterFromId("Longway");
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Alwaysenemy = true; // 260912
	sld.Coastal_Captain = true;
	sld.Ship.Mode = "pirate";
	Character_SetAbordageEnable(sld, true);//можно абордировать
	sld.mapEnc.type = "war";
	sld.mapEnc.worldMapShip = "quest_ship";
	sld.mapEnc.Name = "'Meifeng'";
	Group_AddCharacter(sGroup, "Longway");
	
	Group_SetGroupCommander(sGroup, "Longway");
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
	Map_CreateTrader("Shore22", "Shore39", "Longway", 10);//запуск энкаунтера - до Мартиники
	
	pchar.quest.Meifeng_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Meifeng_AfterBattle.win_condition.l1.group = sGroup;
	pchar.quest.Meifeng_AfterBattle.function = "Meifeng_AfterBattle";
}

void Meifeng_AfterBattle(string qName)//реакция на победу
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.QuestShipsTerms_Over.over = "yes"; //снять таймер
	if (CheckShipTypeInSquadron(SHIP_MAYFANG) > 0) pchar.questTemp.HWIC.TakeQuestShip = "true";
	if(pchar.questTemp.HWIC.Self != "LongwayPrisoner")
	{
		Group_DeleteGroup("Sea_Meifeng1");
		AddQuestRecord("Holl_Gambit", "3-46");
		CloseQuestHeader("Holl_Gambit");
		pchar.quest.Abigile_died.over = "yes";//снять прерывание на убийство Аби
		sld = characterFromId("Abigile");
		sld.lifeday = 0;
		sld = characterFromId("Longway");
		sld.lifeday = 0;
		pchar.questTemp.HWIC.Self = "end";
		pchar.questTemp.HWIC.Detector = "self_fail";
		Log_TestInfo("ЛОНГВЭЙ УТОНУЛ!");
		//проверим на захват компаньоном
		if (CheckShipTypeInSquadron(SHIP_MAYFANG) > 0)
		{
			pchar.quest.Remove_Meifeng.win_condition.l1 = "Location_Type";
			pchar.quest.Remove_Meifeng.win_condition.l1.location_type = "town";
			pchar.quest.Remove_Meifeng.function = "RemoveMeifeng";
		}
	}
	else
	{
		pchar.GenQuest.DontPartition = true; // отключить дележ
		Log_TestInfo("ЛОНГВЭЙ В ТРЮМЕ!");
		AddComplexSeaExpToScill(150, 150, 150, 200, 150, 150, 0);
		AddComplexSelfExpToScill(60, 60, 60, 60);
		ref chr = GetCharacter(NPC_GenerateCharacter("LongwayClone", "Longway", "man", "man", 20, HOLLAND, -1, false, "quest"));
		chr.name = "Longway";
		chr.lastname = "";
		LAi_SetStayType(chr);
		ChangeCharacterAddressGroup(chr, "My_Deck", "rld", "aloc3");
		chr.Dialog.Filename = "Quest\HollandGambit\Longway.c";
		chr.Dialog.CurrentNode = "Longway_prisoner";
		for (i=1; i<=2; i++)
		{
			sld = characterFromId("Sailor_"+i);	
			LAi_SetStayType(sld);
			LAi_CharacterDisableDialog(sld);
			if (i == 1) ChangeCharacterAddressGroup(sld, "My_Deck", "rld", "aloc2");
			else ChangeCharacterAddressGroup(sld, "My_Deck", "rld", "loc3");
		}
		sld = characterFromId("Sailor_3");
		sld.Dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
		sld.dialog.currentnode = "Sailor_deck_5";
		ChangeCharacterAddressGroup(sld, "My_Deck", "goto", "goto1");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void LongwayInShore(string qName)//Лонгвэй в бухте
{
	chrDisableReloadToLocation = true;
	sld = characterFromId("LongwayClone");
	sld.dialog.currentnode = "Longway_prisoner_10";
	ChangeCharacterAddressGroup(sld, "Shore31", "goto", "goto8");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	for (i=1; i<=3; i++)//уберем охрану китайца
	{
		sld = characterFromId("Sailor_"+i);
		sld.lifeday = 0;
	}
	LAi_LocationFightDisable(&Locations[FindLocation("Shore31")], true);//запрет драки
	locations[FindLocation("Shore31")].DisableEncounters = true; //энкаутеры закрыть
}

void CreatePiterHalleon(string qName)//галеон Стайвесанта
{
	Group_FindOrCreateGroup("Stivesant_Halleon");
	sld = GetCharacter(NPC_GenerateCharacter("Stivesant", "huber_1", "man", "man_B", 35, HOLLAND, 9, false, "quest"));
	FantomMakeSmallSailor(sld, SHIP_GALEON_H, "Frederic", CANNON_TYPE_CANNON_LBS24, 100, 100, 100, 100, 100);
	FantomMakeCoolFighter(sld, 35, 90, 90, "blade_15", "pistol5", "bullet", 250);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.name = "Peter";
	sld.lastname = "Stuyvesant";
	sld.greeting = "Stivesant"; 
	Character_SetAbordageEnable(sld, false);//нельзя абордировать
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	SetCharacterPerk(sld, "MusketsShoot");
	if(sti(RealShips[sti(pchar.ship.type)].basetype) != SHIP_MAYFANG || GetCompanionQuantity(pchar) > 2) sld.AlwaysEnemy = true;
	Group_AddCharacter("Stivesant_Halleon", "Stivesant");
	Group_SetGroupCommander("Stivesant_Halleon", "Stivesant");
	Group_SetAddress("Stivesant_Halleon", "Nevis", "quest_ships", "quest_ship_1");
	pchar.quest.Piter_fail.win_condition.l1 = "NPC_Death";
	pchar.quest.Piter_fail.win_condition.l1.character = "Stivesant";
	pchar.quest.Piter_fail.function = "HollGambitSelf_failed";//для особо умных
}

void QuestShipsTerms_Over(string qName)//провал по срокам - вертаем Виллемстад в норму и зачищаем неписей
{
	if (pchar.questTemp.HWIC.Self == "AttackMeifeng")//упустили Мейфенг
	{
		pchar.quest.Meifeng_AfterBattle.over = "yes";
		Group_DeleteGroup("Sea_Meifeng1");
		AddQuestRecord("Holl_Gambit", "3-47");
		sld = characterFromId("Longway");
		sld.lifeday = 0;
	}
	if (pchar.questTemp.HWIC.Self == "MeetingStivesant")//упустили галеон Стайвесанта
	{
		pchar.quest.Seek_Piter.over = "yes"; //снять прерывание
		pchar.quest.Piter_fail.over = "yes"; //снять прерывание
		AddQuestRecord("Holl_Gambit", "3-50");
		if (CheckShipTypeInSquadron(SHIP_MAYFANG) > 0)//если есть шебека - отберем
		{
			pchar.quest.Remove_Meifeng.win_condition.l1 = "Location_Type";
			pchar.quest.Remove_Meifeng.win_condition.l1.location_type = "town";
			pchar.quest.Remove_Meifeng.function = "RemoveMeifeng";
		}
	}
	if (pchar.questTemp.HWIC.Self == "WayWithStivesant")//не пошли как нормальные люди на Кюрасао
	{
		pchar.quest.Piter_fail.over = "yes"; //снять прерывание
		RemoveCharacterCompanion(pchar, characterFromID("Stivesant"));
		AddQuestRecord("Holl_Gambit", "3-51");
		sld = characterFromId("Stivesant");
		sld.lifeday = 0;
		pchar.quest.Remove_Meifeng.win_condition.l1 = "Location_Type";
		pchar.quest.Remove_Meifeng.win_condition.l1.location_type = "town";
		pchar.quest.Remove_Meifeng.function = "RemoveMeifeng";
	}
	CloseQuestHeader("Holl_Gambit");
	pchar.quest.Abigile_died.over = "yes";//снять прерывание на убийство Аби
	sld = characterFromId("Abigile");
	sld.lifeday = 0;
	pchar.questTemp.HWIC.Self = "end";
	pchar.questTemp.HWIC.Detector = "self_fail";
	LocatorReloadEnterDisable("Villemstad_town", "reload3_back", false);//открыть вход в резиденцию
	LocatorReloadEnterDisable("Villemstad_town", "reloadR1", false);//открыть боковой вход в резиденцию
	sld = characterFromId("Lucas");
	sld.lifeday = 0;
	sld = characterFromId("hol_guber");
	sld.Dialog.Filename = "Common_Mayor.c";
	sld.dialog.currentnode = "First time";
	LAi_SetHuberType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_townhall", "sit", "sit1");
}
	
void RemoveMeifeng(string qName)//удалить Мейфенг, если провалил квест
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = GetCharacter(NPC_GenerateCharacter("TempOffGuard", "off_hol_4", "man", "man", 35, HOLLAND, 0, false, "soldier"));
	FantomMakeCoolFighter(sld, 35, 90, 90, "blade_14", "pistol3", "grapeshot", 200);//группа альфа
	sld.Dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
	sld.dialog.currentnode = "TempOffGuard";
	LAi_SetImmortal(sld, true);//защита от дурака
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	for (i=1; i<=3; i++)
	{
		ref chr = GetCharacter(NPC_GenerateCharacter("TempGuard_"+i, "sold_hol_1"+i, "man", "man", 35, HOLLAND, 0, false, "soldier"));
		FantomMakeCoolFighter(chr, 35, 90, 90, "blade_14", "pistol3", "grapeshot", 200);//группа альфа
		LAi_SetImmortal(chr, true);//защита от дурака
		ChangeCharacterAddressGroup(chr, pchar.location, "goto", "goto1");
		LAi_CharacterDisableDialog(chr);//запрет диалога
		LAi_SetActorType(chr);
		LAi_ActorFollow(chr, sld, "", -1);
	}
}
	
void StivesantOnStreet(string qName)//прибыли в Виллемстад
{
	bDisableFastReload = true;
	LocatorReloadEnterDisable("Villemstad_town", "reload1_back", true);
	LocatorReloadEnterDisable("Villemstad_town", "reload2_back", true);
	LocatorReloadEnterDisable("Villemstad_town", "reload5_back", true);
	LocatorReloadEnterDisable("Villemstad_town", "reload10_back", true);
	LocatorReloadEnterDisable("Villemstad_town", "gate_back", true);//чтобы не сбежал
	pchar.quest.Piter_fail.over = "yes"; //снять прерывание
	pchar.quest.Terms_Over.over = "yes"; //снять таймер
	RemoveCharacterCompanion(pchar, characterFromID("Stivesant"));
	sld = characterFromId("Stivesant");
	sld.Dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
	sld.dialog.currentnode = "Stivesant";
	LAi_SetImmortal(sld, true);//защита от дурака
	ChangeCharacterAddressGroup(sld, "Villemstad_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	for (i=1; i<=5; i++)
	{
		ref chr = GetCharacter(NPC_GenerateCharacter("StivesantGuard_"+i, "sold_hol_1"+i, "man", "man", 35, HOLLAND, -1, false, "soldier"));
		FantomMakeCoolFighter(chr, 35, 90, 90, "blade_14", "pistol3", "grapeshot", 200);//группа альфа
		LAi_SetImmortal(chr, true);//защита от дурака
		ChangeCharacterAddressGroup(chr, "Villemstad_town", "patrol", "patrol20");
		LAi_SetActorType(chr);
		LAi_ActorFollow(chr, sld, "", -1);
	}
}
	
void InVillemstadResidense(string qName)//вошли в резиденцию
{
	sld = characterFromId("Stivesant");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocator(sld, "goto", "goto3", "", -1.0);
	LAi_SetActorType(pchar);
	LAi_ActorGoToLocator(pchar, "goto", "goto4", "PiterTalkWithLucas", -1.0);
}

void SecondDayInVillemstad(string qName)//увели Лукаса в тюрьму
{
	sld = characterFromId("Stivesant");
	sld.Dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
	sld.dialog.currentnode = "Stivesant_10";
	LAi_SetActorType(sld);
	LAi_SetPlayerType(PChar);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void OpenResidenceDoor(string qName)//откроем двери
{
	LocatorReloadEnterDisable("Villemstad_town", "reload3_back", false);//открыть вход в резиденцию
	LocatorReloadEnterDisable("Villemstad_town", "reloadR1", false);//открыть боковой вход в резиденцию
	pchar.quest.Award_Give.win_condition.l1 = "location";
	pchar.quest.Award_Give.win_condition.l1.location = "Villemstad_townhall";
	pchar.quest.Award_Give.function = "AwardFromPiterAndBek";
}
	
void AwardFromPiterAndBek(string qName)//церемония награждения
{
	sld = characterFromId("hol_guber");
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_townhall", "goto", "governor1");
	sld = characterFromId("Stivesant");
	sld.dialog.currentnode = "Stivesant_14";
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_townhall", "goto", "goto3");
	for (i=1; i<=3; i++)
	{
		ref chr = characterFromId("StivesantGuard_"+i);
		LAi_SetActorType(chr);
		if (i == 3) ChangeCharacterAddressGroup(chr, "Villemstad_townhall", "goto", "goto1");
		else ChangeCharacterAddressGroup(chr, "Villemstad_townhall", "goto", "goto"+(i+3));
		LAi_ActorTurnToCharacter(chr, pchar);
	}
	LAi_SetActorType(pchar);
	LAi_ActorFollow(pchar, sld, "ActorDialog_Any2Pchar", -1);
	LAi_ActorTurnToCharacter(sld, pchar);
    SetActorDialogAny2Pchar(sld.id, "", 0.0, 0.0);
}
	
void PiterStivesantRemove(string qName)//чистим Стайвесанта
{
	sld = characterFromId("Stivesant");
	sld.location	= "none";
	sld.lifeday = 0;
	sld = characterFromId("hol_guber");
	LAi_SetHuberType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_townhall", "sit", "sit1");
}

//----------------------------------------------6 задание--------------------------------------------------
void AbiGoInVillemstad(string qName)//провожаем Аби домой	
{
	sld = characterFromId("Abigile");
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_town", "quest", "quest1");
	LAi_ActorFollowEverywhere(sld, "", -1);
	pchar.quest.AbiReturn_InHome.win_condition.l1 = "location";
	pchar.quest.AbiReturn_InHome.win_condition.l1.location = "Villemstad_houseSp2";
	pchar.quest.AbiReturn_InHome.function = "AbiInHouse";
	RemovePassenger(Pchar, sld);
}
	
void AbiInHouse(string qName)//Аби дома
{
	sld = characterFromId("Abigile");
	LAi_SetActorType(sld);
	LAi_ActorTurnToCharacter(sld, characterFromID("Solomon"));
	ChangeCharacterAddressGroup(sld, "Villemstad_houseSp2", "goto", "goto2");
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	pchar.quest.Abigile_died.over = "yes";//снять прерывание на убийство Аби
}
	
void CreateTradeFleut(string qName)//флейт Тоффа Келлера
{
	Group_FindOrCreateGroup("Keller_Fleut");
	Group_SetType("Keller_Fleut", "trade");//тип группы
	sld = GetCharacter(NPC_GenerateCharacter("Keller", "trader_2", "man", "man", 20, HOLLAND, 5, false, "quest"));
	FantomMakeSmallSailor(sld, SHIP_FLEUT, "Leiden", CANNON_TYPE_CANNON_LBS12, 50, 40, 40, 60, 60);
	FantomMakeCoolFighter(sld, 20, 30, 30, "blade_08", "pistol3", "grapeshot", 50);
	sld.name = "Toff";
	sld.lastname = "Keller";
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	Character_SetAbordageEnable(sld, false);//нельзя абордировать
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "trade";
	SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("Keller_Fleut", "Keller");
	Group_SetGroupCommander("Keller_Fleut", "Keller");
	Group_SetAddress("Keller_Fleut", "Trinidad", "quest_ships", "quest_ship_6");
	pchar.quest.Keller_fail.win_condition.l1 = "NPC_Death";
	pchar.quest.Keller_fail.win_condition.l1.character = "Keller";
	pchar.quest.Keller_fail.function = "AbiIsland_failed";//для особо тупых
}	
	
void AbiIsland_failed(string qName)//если у кого-то нет моска
{
	Group_DeleteGroup("Keller_Fleut");
	AddQuestRecord("Holl_Gambit", "");
	ChangeCharacterHunterScore(PChar, "holhunter", 30); //начислить НЗГ
	CloseQuestHeader("Holl_Gambit");
	pchar.questTemp.HWIC.Self = "end";
	pchar.questTemp.HWIC.Detector = "self_fail";
}
	
void BattleInGrot(string qName)//напали ванберговцы в пещере
{
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться 300912
	for (i=1; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("vanberg_sold_"+i, "citiz_"+(40+i), "man", "man", 15, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, 15, 40, 40, "blade_04", "pistol3", "bullet", 70);
		if (i == 1) 
		{
			sld.Dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
			sld.dialog.currentnode = "vanberg_sold";
			sld.greeting = "hunter";
			ChangeCharacterAddressGroup(sld, "IslaDeCoche_Grot", "reload", "reload1");
		}
		else
		{
			LAi_CharacterDisableDialog(sld);
			ChangeCharacterAddressGroup(sld, "IslaDeCoche_Grot", "monsters", "monster1");
		}
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}
	
void CreateVanbergSailors(string qName)//напали ванберговцы в бухте
{
	chrDisableReloadToLocation = true;
	for (i=1; i<=5; i++)//5 солдат
	{
		sld = GetCharacter(NPC_GenerateCharacter("vanberg_sailor_"+i, "citiz_"+(i+43), "man", "man", 15, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, 15, 40, 40, "blade_10", "pistol6", "bullet", 50);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		ChangeCharacterAddressGroup(sld, pchar.location.from_sea, "goto", "goto"+(i+3));
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	for (i=1; i<=3; i++)//3 мушкетера
	{
		sld = GetCharacter(NPC_GenerateCharacter("vanberg_mushketer_"+i, "mush_ctz_"+(6+i), "man", "mushketer", 20, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, 20, 50, 50, "", "mushket1", "cartridge", 50);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		ChangeCharacterAddressGroup(sld, pchar.location.from_sea, "goto", "goto"+i);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "PrepareVanbergInSea");
}
	
void CreateVanbergInSea(string qName)//Якоб ван Берг у острова
{
	Island_SetReloadEnableGlobal("IslaDeCoche", false);//на остров нельзя
	bQuestDisableMapEnter = true;//на карту тоже
	Group_FindOrCreateGroup("Mirage");
	Group_SetType("Mirage", "pirate");//тип группы
	sld = characterFromId("JacobBerg");
	FantomMakeCoolSailor(sld, SHIP_MIRAGE, "Mirage", CANNON_TYPE_CANNON_LBS20, 70, 70, 70);
	FantomMakeCoolFighter(sld, 30, 80, 80, "topor_04", "pistol5", "bullet", 150); // приз - секира 090912
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	GiveItem2Character(sld, "spyglass3");
	GiveItem2Character(sld, "recipe_totem_13");
	GiveItem2Character(sld, "totem_13");
	sld.Ship.Mode = "pirate";
	if (GetCompanionQuantity(pchar) > 1) sld.Abordage.Enable = false;//теперь попробуй взять компаньоном
	RealShips[sti(sld.Ship.Type)].ship.upgrades.hull = 3;//замшелый корпус
	SetShipSailsFromFile(sld, "ships/parus_torn.tga");
	SetSailsColor(sld, 8);//черный рваный парус
	sld.ship.Crew.Morale = 100;
	sld.Ship.Crew.Exp.Sailors = 100;
	sld.Ship.Crew.Exp.Cannoners = 100;
	sld.Ship.Crew.Exp.Soldiers = 100;
	SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("Mirage", "JacobBerg");
	Group_SetGroupCommander("Mirage", "JacobBerg");
	Group_SetTaskAttack("Mirage", PLAYER_GROUP);
	Group_SetPursuitGroup("Mirage", PLAYER_GROUP);
	Group_SetAddress("Mirage", "IslaDeCoche", "", "");
	Group_LockTask("Mirage");
	
	pchar.quest.Mirage_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Mirage_AfterBattle.win_condition.l1.group = "Mirage";
	pchar.quest.Mirage_AfterBattle.function = "Mirage_AfterBattle";
}	
	
void Mirage_AfterBattle(string qName)//после боя
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Island_SetReloadEnableGlobal("IslaDeCoche", true);
	bQuestDisableMapEnter = false;
	Group_DeleteGroup("Mirage");
	AddQuestRecord("Holl_Gambit", "3-63");
	pchar.questTemp.HWIC.Self = "VanbergDestroyed";
	AddComplexSeaExpToScill(200, 200, 200, 200, 200, 200, 0);
	SetFunctionTimerCondition("MakeAbiPoor", 0, 0, 30, false); //даем месяц сроку, чтобы вернул деньги Аби
}
	
//-----------------------------------------эпилог-----------------------------------------------
void GoFromAbiRoom(string qName)//телепорт из комнаты Аби
{
	DoQuestReloadToLocation("Villemstad_houseSp2", "reload", "reload2", "");
	LocatorReloadEnterDisable("Villemstad_houseSp2", "reload1", true);
	pchar.quest.Solomon_talk.win_condition.l1 = "locator";
	pchar.quest.Solomon_talk.win_condition.l1.location = "Villemstad_houseSp2";
	pchar.quest.Solomon_talk.win_condition.l1.locator_group = "reload";
	pchar.quest.Solomon_talk.win_condition.l1.locator = "reload1";
	pchar.quest.Solomon_talk.function = "SolomonTalk";
}	
	
void SolomonTalk(string qName)//благодарности Соломона
{
	sld = characterFromId("Solomon");
	sld.dialog.currentnode = "Solomon_thanks";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}
	
void MakeAbiPoor(string qName)//Аби и Соломон остались без гроша
{
	sld = characterFromId("Solomon");
	sld.dialog.currentnode = "Solomon_poor";
	FreeSitLocator("Villemstad_tavern", "sit_front1");
	LAi_SetSitType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_tavern", "sit", "sit_front1");
	sld = characterFromId("Abigile");
	sld.dialog.currentnode = "Abigile_Poor";
	LAi_SetOwnerType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_townhallRoom", "goto", "goto1");
	sld = GetCharacter(NPC_GenerateCharacter("Abihouselady", "women_8", "woman", "towngirl", 5, HOLLAND, -1, false, "quest"));
	LAi_SetOwnerType(sld);
	sld.Dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
	sld.dialog.currentnode = "Abihouselady";
	ChangeCharacterAddressGroup(sld, "Villemstad_houseSp2", "goto", "goto1");
	log_info("You didn't return money to Abigail thus making her a beggar");
	ChangeCharacterComplexReputation(pchar, "nobility", -20);
}

//---------------------------------- выходки Абрахама Нормана ---------------------------------------------
void Norman_ChangeFesivalFace()
{
	sld = characterFromId("Norman");
	ChangeCharacterAddressGroup(sld, "Pirates_town", "goto", "goto1"); // patch
	sld.model = "Norman_2";
	sld.dialog.currentnode = "norman_fes";
	sld.greeting = "Norman_2";
	SetFunctionTimerCondition("Norman_ChangeUsualFace", 0, 0, 1, false);
}

void Norman_ChangeUsualFace(string qName)
{
	sld = characterFromId("Norman");
	ChangeCharacterAddressGroup(sld, "Pirates_town", "goto", "goto1"); // patch
	sld.model = "Norman_1";
	sld.dialog.currentnode = "norman_us";
	sld.greeting = "Norman_1";
}
	
///////////////////////////////////////////////////////////////////////////////////////////////////////////	
///Jason----------------------------Бремя гасконца - макроквест Шарля де Мора-----------------------------
///////////////////////////////////////////////////////////////////////////////////////////////////////////
void Sharlie_enterSoldiers()//арестовывающие солдаты
{
	chrDisableReloadToLocation = true;//закрыть локацию
	for (i=1; i<=3; i++)
    {
        sld = GetCharacter(NPC_GenerateCharacter("ShSold"+i, "sold_fra_"+i, "man", "man", 20, FRANCE, 0, true, "soldier"));
		SetFantomParamFromRank(sld, 20, true);         
		LAi_SetWarriorType(sld); 
		LAi_warrior_DialogEnable(sld, false);
        ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
    }
    sld = GetCharacter(NPC_GenerateCharacter("ShOfficer", "off_fra_3", "man", "man", 30, FRANCE, 0, true, "soldier"));
	SetFantomParamFromRank(sld, 30, true);
	sld.Dialog.Filename = "Quest\Sharlie\OtherNPC.c";
	sld.dialog.currentnode = "Sharlie_arest";
	sld.greeting = "soldier_arest";
    LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
	LAi_ActorDialog(sld, pchar, "", 1.0, 0);
}

void Puancie_InJail(string qName)//Пуанси в тюрьме
{
    sld = characterFromID("Puancie");
	LAi_SetActorType(sld);
    LAi_ActorGoToLocator(sld, "goto", "goto23", "", -1);
	DoQuestFunctionDelay("Puancie_InJailTalk", 3.0);
}

void Puancie_InJailTalk(string qName)//Пуанси в тюрьме
{
    sld = characterFromID("Puancie");
	LAi_SetActorType(sld);
    LAi_ActorDialog(sld, pchar, "", 0, 0);
}

void Sharlie_PardonOver(string qName)//извинений больше нет
{
    DeleteAttribute(pchar, "questTemp.Sharlie.Pardon");
}

void Sharlie_BenuaMaltie(string qName)//в церкви наутро
{
    sld = characterFromId("Benua");
	sld.dialog.currentnode = "Benua_maltie";
}

void Sharlie_enterMaltie()//мальтийский рыцарь
{
	chrDisableReloadToLocation = true;//закрыть локацию
    sld = GetCharacter(NPC_GenerateCharacter("Sh_Maltie", "off_Malt_2", "man", "man", 30, FRANCE, -1, true, "soldier"));
	SetFantomParamFromRank(sld, 30, true);
	sld.Dialog.Filename = "Quest\Sharlie\OtherNPC.c";
	sld.dialog.currentnode = "Sharlie_maltie";
	sld.greeting = "patrol";
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	LAi_SetImmortal(sld, true);
    LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, pchar.location, "quest", "quest1");
	LAi_ActorDialog(sld, pchar, "", 1.0, -1);
}

void Sharlie_BenuaLoanTime(string qName)//займ у Бенуа // Addon 2016-1 Jason пиратская линейка 1
{
	if (!CheckAttribute(pchar, "questTemp.Sharlie.BenuaLoan")) return;
    pchar.questTemp.Sharlie.BenuaLoan.Late = "true";
	log_info("Срок вашего займа у аббата Бенуа истек!");
}

//------------------------------------------мини-квесты для сбора денег---------------------------------------
//найти помощника для торговца
void Sharlie_CreateStorehelper()//создаем помощника торговца
{
	sld = GetCharacter(NPC_GenerateCharacter("Storehelper", "Fugitive", "man", "man", 10, FRANCE, 3, true, "soldier"));
	SetFantomParamFromRank(sld, 10, true);
	sld.Dialog.Filename = "Quest\Sharlie\StartMiniQuests.c";
	sld.name = "Gralam";
	sld.lastname = "Lavua";
	sld.greeting = "town_pirate";
	LAi_SetImmortal(sld, true);
	LAi_group_MoveCharacter(sld, "PIRATE_CITIZENS");
	switch (sti(pchar.questTemp.Sharlie.Storehelper.Chance))
	{
		case 0: //в таверне
			sld.dialog.currentnode = "Storehelper";
			LAi_SetSitType(sld);
			FreeSitLocator("LeFransua_tavern", "sit3");
			ChangeCharacterAddressGroup(sld, "LeFransua_tavern", "sit", "sit3");
		break;
		
		case 1: //в городе
			sld.dialog.currentnode = "Storehelper_4";
			LAi_SetCitizenType(sld);
			sld.City = "LeFransua";
			ChangeCharacterAddressGroup(sld, "LeFransua_town", "goto", "goto14");
			LAi_SetLoginTime(sld, 6.0, 21.99);
		break;
		
		case 2: //в магазине
			sld.dialog.currentnode = "Storehelper_8";
			LAi_SetOwnerType(sld);
			ChangeCharacterAddressGroup(sld, "LeFransua_store", "goto", "goto1");
		break;
	}
	SetFunctionTimerCondition("StorehelperOver", 0, 0, 3, false); 
}

void StorehelperOver(string qName)
{
	DeleteAttribute(pchar, "questTemp.Sharlie.Storehelper");
	CloseQuestHeader("SharlieA");
}

void Storehelper_hire(string qName)//кандидаты
{
	for (i=1; i<=3; i++)
    {
		sld = GetCharacter(NPC_GenerateCharacter("Newstorehelper_"+i, "citiz_"+(23+i), "man", "man", 10, FRANCE, 1, true, "soldier"));
		SetFantomParamFromRank(sld, 10, true);
		sld.Dialog.Filename = "Quest\Sharlie\StartMiniQuests.c";
		sld.dialog.currentnode = "Newstorehelper_"+i;
		sld.greeting = "town_pirate";
		LAi_SetActorType(sld);
		LAi_group_MoveCharacter(sld, "PIRATE_CITIZENS");
		ChangeCharacterAddressGroup(sld, "LeFransua_tavern", "reload", "reload1_back");
		LAi_ActorGoToLocator(sld, "goto", "goto2", "Newstorehelper_ready", 10);
	}
}

void NewstorehelperAddOver(string qName)//не отвел в город
{
	pchar.quest.storehelper4.over = "yes"; //снять прерывание
	sld = characterFromId(pchar.questTemp.Sharlie.Storehelper.id);
	sld.lifeday = 0;
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload2_back", "none", "", "", "", 10.0);
	DeleteAttribute(pchar, "questTemp.Sharlie.Storehelper");
	ChangeCharacterComplexReputation(pchar, "nobility", -3);
	CloseQuestHeader("SharlieA");
}

void NewstorehelperAddKill(string qName)//сам прибил
{
	pchar.quest.storehelper4.over = "yes"; //снять прерывание
	DeleteAttribute(pchar, "questTemp.Sharlie.Storehelper");
	ChangeCharacterComplexReputation(pchar, "nobility", -10);
	CloseQuestHeader("SharlieA");
}

void NewstorehelperAdd(string qName)//добавляем в спутники
{
	sld = characterFromId(pchar.questTemp.Sharlie.Storehelper.id);
	LAi_SetActorType(sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "LeFransua_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_ActorFollowEverywhere(sld, "", -1);
	pchar.quest.storehelper3.win_condition.l1 = "Timer";
	pchar.quest.storehelper3.win_condition.l1.date.hour  = sti(GetTime()+12);
	pchar.quest.storehelper3.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 0);
	pchar.quest.storehelper3.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 0);
	pchar.quest.storehelper3.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 0);
	pchar.quest.storehelper3.function = "NewstorehelperAddOver";
	pchar.quest.storehelper4.win_condition.l1 = "location";
	pchar.quest.storehelper4.win_condition.l1.location = "FortFrance_store";
	pchar.quest.storehelper4.function = "NewstorehelperRegard";
	//для дикарей
	pchar.quest.storehelper0.win_condition.l1 = "NPC_Death";
	pchar.quest.storehelper0.win_condition.l1.character = pchar.questTemp.Sharlie.Storehelper.id;
	pchar.quest.storehelper0.function = "NewstorehelperAddKill";
}

void NewstorehelperRegard(string qName)//пришли в магазин
{
	pchar.quest.storehelper3.over = "yes";
	pchar.quest.storehelper0.over = "yes";
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId(pchar.questTemp.Sharlie.Storehelper.id);
	sld.dialog.currentnode = "Newstorehelper_regard";
	LAi_SetActorType(sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "FortFrance_store", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void StorehelperFinal(string qName)//спустя час
{
	pchar.questTemp.Sharlie.Storehelper = "final";
	log_Testinfo("можно идти в магазин");
}

//привезти ром контрабандой для бармена
void Rum_CreateBarkas(string qName)//баркас у пирса
{
	log_info("The boat is waiting for you at the pier now");
	AddQuestRecord("SharlieB", "7");
	pchar.Ship.Type = GenerateShipExt(SHIP_TARTANE, true, pchar);
	pchar.Ship.name = "Boat";
	SetBaseShipData(pchar);
	NullCharacterGoods(pchar);
	AddCharacterGoods(pchar, GOOD_FOOD, 10);
	AddCharacterGoods(pchar, GOOD_MEDICAMENT, 10);
	ref shTo = &RealShips[sti(Pchar.Ship.Type)];
	shTo.SpeedRate = 13.0;
	SetCrewQuantityOverMax(PChar, 5);
	pchar.Ship.Crew.Exp.Sailors = 50;
	pchar.quest.Sharlie_rum1.win_condition.l1 = "location";
	pchar.quest.Sharlie_rum1.win_condition.l1.location = "Martinique";
	pchar.quest.Sharlie_rum1.function = "Rum_FindLugger";
	//установить радиус доплыть до на остров
	i = FindIsland("Martinique");
	Islands[i].EffectRadius = 3000-MOD_SKILL_ENEMY_RATE*100;
}

void Rum_CreateBarkasOver(string qName)//опоздали
{
	pchar.Ship.Type = SHIP_NOTUSED;
	pchar.quest.Sharlie_rum.over = "yes";
	AddQuestRecord("SharlieB", "3");
	CloseQuestHeader("SharlieB");
	DeleteAttribute(pchar, "questTemp.Sharlie.Rum");
}

void Rum_FindLugger(string qName)//вышли в море - ставим люггер
{
	Weather.Wind.Speed = 16.0;
	pchar.wind.speed = Weather.Wind.Speed;
	fWeatherSpeed = stf(Weather.Wind.Speed);//халява первого выхода
	LAi_LocationFightDisable(&Locations[FindLocation("Deck_Near_Ship")], true);//запретить драться
	pchar.quest.Rum_CreateBarkasOver.over = "yes"; //снять таймер
	Group_FindOrCreateGroup("Rum_CapGroup");
	Group_SetType("Rum_CapGroup", "pirate");//тип группы
	sld = GetCharacter(NPC_GenerateCharacter("Rum_Cap", "mercen_5", "man", "man", 20, FRANCE, 5, true, "quest"));
	FantomMakeSmallSailor(sld, SHIP_LUGGER, "Ghost", CANNON_TYPE_CANNON_LBS3, 50, 45, 45, 40, 45);
	FantomMakeCoolFighter(sld, 20, 50, 50, "blade_05", "pistol1", "bullet", 100);
	sld.Dialog.Filename = "Quest\Sharlie\StartMiniQuests.c";
	sld.dialog.currentnode = "Rum_Cap";
	sld.greeting = "captain";
	LAi_SetImmortal(sld, true);
	Group_AddCharacter("Rum_CapGroup", "Rum_Cap");
    Group_SetGroupCommander("Rum_CapGroup", "Rum_Cap");
	Group_SetAddress("Rum_CapGroup", "Martinique", "Quest_Ships", "Quest_Ship_10");
	pchar.quest.Sharlie_rum2.win_condition.l1 = "Timer";
	pchar.quest.Sharlie_rum2.win_condition.l1.date.hour  = 5.0;
	pchar.quest.Sharlie_rum2.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 1);
	pchar.quest.Sharlie_rum2.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 1);
	pchar.quest.Sharlie_rum2.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 1);
	pchar.quest.Sharlie_rum2.function = "Rum_FindLuggerOver";
}

void Rum_FindLuggerOver(string qName)//не нашли
{
	Log_Info("You are too late for the meeting!");
	PlaySound("interface\notebook.wav");
	sld = characterFromId("Rum_Cap");
	sld.dialog.currentnode = "Rum_Cap_Over";
	pchar.quest.Sharlie_rum3.win_condition.l1 = "Location_Type";
	pchar.quest.Sharlie_rum3.win_condition.l1.location_type = "town";
	pchar.quest.Sharlie_rum3.function = "Rum_RemoveBarkas";
	AddQuestRecord("SharlieB", "2");
}

void Rum_RemoveBarkas(string qName)//удаляем баркас
{
	int i = FindIsland("Martinique");
	DeleteAttribute(Islands[i], "EffectRadius");
	Group_DeleteGroup("Rum_CapGroup");
	pchar.Ship.Type = SHIP_NOTUSED;
	DeleteAttribute(pchar, "questTemp.Sharlie.Rum");
	CloseQuestHeader("SharlieB");
	i = FindLocation("Fortfrance_town");
	setCharacterShipLocation(pchar, GetCityFrom_Sea(locations[i].fastreload));
	setWDMPointXZ(GetCityFrom_Sea(locations[i].fastreload));
}

void Rum_CarrierEnter()//погрузка
{
	SetLaunchFrameFormParam("An hour passed..."+ NewStr() +"Rum was loaded on your boat", "", 0, 5);
	LaunchFrameForm();
	WaitDate("", 0, 0, 0, 1, 10); //крутим время
	RecalculateJumpTable();
	DoQuestCheckDelay("Rum_CapGoodbye", 1.0);
}

void Rum_RemoveRum(string qName)//высадились в Ле Франсуа
{
	chrDisableReloadToLocation = true;
	i = FindIsland("Martinique");
	DeleteAttribute(Islands[i], "EffectRadius");
	Islands[i].EffectRadius = 5000;
	Group_DeleteGroup("Rum_CapGroup");
	pchar.Ship.Type = SHIP_NOTUSED;
	for (i=1; i<=3; i++)
    {
		sld = GetCharacter(NPC_GenerateCharacter("Rum_Carrier2_"+i, "citiz_"+(21+i), "man", "man", 5, FRANCE, 1, true, "soldier"));
		SetFantomParamFromRank(sld, 10, true);
		if (i != 1) LAi_CharacterDisableDialog(sld);
		sld.Dialog.Filename = "Quest\Sharlie\StartMiniQuests.c";
		sld.dialog.currentnode = "Rum_Carrier";
		sld.greeting = "smuggler";
		LAi_SetImmortal(sld, true);
		LAi_SetActorType(sld);
		ChangeCharacterAddressGroup(sld, "LeFransua_port", "goto", "goto11");
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

//доставить девочку из борделя дворянину
void Sharlie_CreateGigoloMan()//ставим дворянина и прерывание на джунгли
{
	sld = GetCharacter(NPC_GenerateCharacter("GigoloMan", "Guide_2", "man", "man", 25, FRANCE, 5, true, "soldier"));
	SetFantomParamFromRank(sld, 25, true);
	sld.Dialog.Filename = "Quest\Sharlie\StartMiniQuests.c";
	sld.dialog.currentnode = "GigoloMan";
	sld.greeting = "noble_male";
	sld.talker = 9;
	LAi_SetLoginTime(sld, 6.0, 21.0);
	LAi_SetImmortal(sld, true);
	LAi_SetCitizenType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	ChangeCharacterAddressGroup(sld, "Fortfrance_town", "goto", "goto1");
	//устанавливаем прерывание на джунгли
	pchar.quest.Jungle_jew.win_condition.l1 = "location";
	pchar.quest.Jungle_jew.win_condition.l1.location = "Martinique_jungle_01";
	pchar.quest.Jungle_jew.function = "Junglejew_CreateIndians";
}

void Sharlie_CreateGigoloGirl()//ставим девочку
{
	sld = GetCharacter(NPC_GenerateCharacter("GigoloGirl", "women_24", "woman", "towngirl", 3, FRANCE, -1, false, "soldier"));
	sld.name = "Lutisse";
	sld.lastname = "Montane";
	sld.City = "Fortfrance";
	sld.CityType = "horse";
	LAi_SetLoginTime(sld, 23.0, 0.0);
	sld.Dialog.Filename = "Quest\Sharlie\StartMiniQuests.c";
	sld.dialog.currentnode = "GigoloGirl";
	sld.greeting = "whore";
	LAi_SetImmortal(sld, true);
	LAi_SetCitizenType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	ChangeCharacterAddressGroup(sld, "Fortfrance_Brothel", "goto", "goto1");
}

void Sharlie_GigoloGirlOver(string qName)//нет прогулкам под луной
{
	sld = characterFromId("GigoloGirl");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "reload9_back", "Fortfrance_Brothel", "goto", "goto1", "GigoloGirl_SetCitizen", 20.0);
}

void Sharlie_GiveGigoloGirl(string qName)//
{
	sld = characterFromId("GigoloGirl");
	sld.dialog.currentnode = "GigoloGirl_3";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Captive_Timer(string qName)//ставим ступенчатое прерывание на бухту - иначе вылет
{
	pchar.quest.Sharlie_captive1.win_condition.l1 = "location";
	pchar.quest.Sharlie_captive1.win_condition.l1.location = "Shore39";
	pchar.quest.Sharlie_captive1.function = "Captive_CreatePirates";
}

//освободить испанца для ростовщика
void Captive_CreatePirates(string qName)//устанавливаем пиратусов
{
	int iRank = MOD_SKILL_ENEMY_RATE;
	pchar.quest.Captive_CreatePiratesOver.over = "yes";//снять таймер
	if (pchar.location.from_sea == "Shore39")
	{
		AddQuestRecord("SharlieD", "2");
		CloseQuestHeader("SharlieD");
		DeleteAttribute(pchar, "questTemp.Sharlie.Captive");
		pchar.questTemp.Sharlie = "bankskipermoney";
	}
	else
	{
		LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
		chrDisableReloadToLocation = true;//закрыть локацию
		LAi_group_Delete("EnemyFight");
		int n = makeint(MOD_SKILL_ENEMY_RATE/2);
		if (n <= 1) n = 2;
		for (i=1; i<=n; i++)
		{
			sld = GetCharacter(NPC_GenerateCharacter("CaptivePirate_"+i, "citiz_"+(40+i), "man", "man", iRank, PIRATE, -1, false, "soldier"));
			SetFantomParamFromRank(sld, iRank, true);
			sld.Dialog.Filename = "Quest\Sharlie\StartMiniQuests.c";
			sld.dialog.currentnode = "CaptivePirate";
			sld.greeting = "town_pirate";
			LAi_SetStayType(sld);
			sld.talker = 9;
			LAi_group_MoveCharacter(sld, "EnemyFight");
			if (i == 1 || i == 2 || i == 3) ChangeCharacterAddressGroup(sld, "Shore39", "smugglers", "smuggler0"+i);
			if (i == 4) ChangeCharacterAddressGroup(sld, "Shore39", "goto", "goto3");
			if (i == 5)
			{
				ChangeCharacterAddressGroup(sld, "Shore39", "goto", "goto5");
				LAi_CharacterDisableDialog(sld);
			}
		}
		ref chr = GetCharacter(NPC_GenerateCharacter("CaptiveSpain", "q_spa_Ingenier", "man", "man", iRank+MOD_SKILL_ENEMY_RATE/2, SPAIN, -1, false, "quest"));
		SetFantomParamFromRank(chr, iRank+MOD_SKILL_ENEMY_RATE/2, true);
		RemoveCharacterEquip(chr, BLADE_ITEM_TYPE);
		RemoveCharacterEquip(chr, GUN_ITEM_TYPE);
		LAi_CharacterDisableDialog(chr);
		LAi_SetStayType(chr);
		ChangeCharacterAddressGroup(chr, "Shore39", "smugglers", "smugglerload");
		pchar.quest.Sharlie_captive2.win_condition.l1 = "NPC_Death";
		pchar.quest.Sharlie_captive2.win_condition.l1.character = "CaptiveSpain";
		pchar.quest.Sharlie_captive2.function = "Captive_failed";
	}
}

void Captive_CreatePiratesOver(string qName)//просрочили
{
	pchar.quest.Sharlie_captive.over = "yes";//снять прерывание
	pchar.quest.Sharlie_captive1.over = "yes";//снять прерывание
	AddQuestRecord("SharlieD", "3");
	CloseQuestHeader("SharlieD");
	DeleteAttribute(pchar, "questTemp.Sharlie.Captive");
	pchar.questTemp.Sharlie = "bankskipermoney";
}

void Captive_failed(string qName)//убили испанца, хотя это маловероятно
{
	chrDisableReloadToLocation = false;
	AddQuestRecord("SharlieD", "4");
	CloseQuestHeader("SharlieD");
	DeleteAttribute(pchar, "questTemp.Sharlie.Captive");
	pchar.questTemp.Sharlie = "bankskipermoney";
}

void CaptiveSpain_reload(string qName)//телепорт, если ночь на дворе
{
	PlaySound("Interface\knock.wav");
	DoQuestReloadToLocation("Fortfrance_bank", "reload", "reload1", "");
}

//драгоценность с мертвого вора
void Junglejew_CreateIndians(string qName)//ставим индейцев
{
	for (i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("JunglejewInd_"+i, "canib_"+(i+4), "man", "man", 5, PIRATE, 0, true, "soldier"));
		SetFantomParamFromRank(sld, 5, true);
		LAi_SetImmortal(sld, true);
		LAi_SetActorType(sld);
		ChangeCharacterAddressGroup(sld, "Martinique_jungle_01", "goto", "goto13");
		LAi_ActorRunToLocation(sld, "reload", "reload3_back", "none", "", "", "", -1);
	}
	sld = GetCharacter(NPC_GenerateCharacter("JunglejewVict", "citiz_49", "man", "man", 5, PIRATE, 0, true, "soldier"));
	RemoveAllCharacterItems(sld, true);
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	sld.money = 560;
	TakeNItems(sld, "jewelry25", 1);
	TakeNItems(sld, "jewelry44", 1);
	TakeNItems(sld, "jewelry46", 1);
	TakeNItems(sld, "Mineral7", 1);
	TakeNItems(sld, "Mineral10", 1);
	TakeNItems(sld, "potion1", 2);
	ChangeCharacterAddressGroup(sld, "Martinique_jungle_01", "goto", "goto13");
	LAi_SetStayType(sld);
	DoQuestFunctionDelay("Junglejew_KillVictim", 4.0);
}

void Junglejew_KillVictim(string qName)//
{
	sld = characterFromId("JunglejewVict");
	LAi_KillCharacter(sld);
	pchar.quest.Jungle_jew1.win_condition.l1 = "item";
	pchar.quest.Jungle_jew1.win_condition.l1.item = "jewelry25";
	pchar.quest.Jungle_jew1.function = "Junglejew_Findjew";
}

void Junglejew_Findjew(string qName)//нашли драгоценность
{
	pchar.questTemp.Sharlie.Junglejew = "find";
	AddQuestRecord("SharlieE", "1");
}

//спасение дочери горожанина
void RescueDaughter_CreateProsper()//создаем Проспера
{
	sld = GetCharacter(NPC_GenerateCharacter("RD_Prosper", "Prospero_mush", "man", "mushketer", 10, FRANCE, -1, true, "soldier"));
	SetFantomParamFromRank(sld, 10, true);
	GiveItem2Character(sld, "unarmed");
	sld.equip.blade = "unarmed";
	GiveItem2Character(sld, "mushket1");
	EquipCharacterbyItem(sld, "mushket1");
	sld.MushketType = "mushket1";
	sld.MushketBulletType = "bullet";
	TakeNItems(sld, "bullet", 50);
	AddItems(sld, "gunpowder", 50);
	TakeNItems(sld, "potion1", 5);
	LAi_SetCharacterUseBullet(sld, "bullet");
	LAi_SetHP(sld, 150, 150);
	SetSelfSkill(sld, 10, 10, 10, 100, 50);
	SetCharacterPerk(sld, "Gunman");
	SetCharacterPerk(sld, "BasicDefense");
	sld.MusketerDistance = 20;
	sld.SuperShooter = true;
	sld.name = "Prosper";
	sld.lastname = "Trubal";
	sld.Dialog.Filename = "Quest\Sharlie\StartMiniQuests.c";
	sld.dialog.currentnode = "Prosper";
	sld.greeting = "prosper";
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	LAi_SetStayType(sld);
	ChangeCharacterAddressGroup(sld, "Fortfrance_town", "quest", "quest2");
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	//таймер на просрочку
	pchar.quest.Sharlie_RescueDaughter.win_condition.l1 = "Timer";
	pchar.quest.Sharlie_RescueDaughter.win_condition.l1.date.hour  = sti(GetTime()+2);
	pchar.quest.Sharlie_RescueDaughter.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 0);
	pchar.quest.Sharlie_RescueDaughter.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 0);
	pchar.quest.Sharlie_RescueDaughter.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 0);
	pchar.quest.Sharlie_RescueDaughter.function = "RescueDaughter_Over";
}

void RescueDaughter_Over(string qName)//опоздали
{
	sld = characterFromId("RD_Prosper");
	sld.lifeday = 0;
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "gate_back", "none", "", "", "", 10.0);
	AddQuestRecord("SharlieF", "2");
	CloseQuestHeader("SharlieF");
}

void RescueDaughter_CaveOver(string qName)//не пошли к пещере
{
	sld = characterFromId("RD_Prosper");
	sld.lifeday = 0;
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload2_back", "none", "", "", "", 10.0);
	AddQuestRecord("SharlieF", "4");
	CloseQuestHeader("SharlieF");
	ChangeCharacterComplexReputation(pchar, "nobility", -5);
	ChangeCharacterComplexReputation(pchar, "authority", -3);
}

void RescueDaughter_NearCave(string qName)//джунгли-4
{
	LocatorReloadEnterDisable("Martinique_jungle_04", "reload2_back", true);
	pchar.quest.Sharlie_RescueDaughter3.win_condition.l1 = "locator";
	pchar.quest.Sharlie_RescueDaughter3.win_condition.l1.location = "Martinique_jungle_04";
	pchar.quest.Sharlie_RescueDaughter3.win_condition.l1.locator_group = "reload";
	pchar.quest.Sharlie_RescueDaughter3.win_condition.l1.locator = "reload2_back";
	pchar.quest.Sharlie_RescueDaughter3.function = "RescueDaughter_Advice";
}

void RescueDaughter_Advice(string qName)//у входа в пещеру
{
	sld = characterFromId("RD_Prosper");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	pchar.quest.Sharlie_RescueDaughter4.win_condition.l1 = "location";
	pchar.quest.Sharlie_RescueDaughter4.win_condition.l1.location = "Martinique_CaveEntrance";
	pchar.quest.Sharlie_RescueDaughter4.function = "RescueDaughter_CreateIndiansLand";
}

void RescueDaughter_CreateIndiansLand(string qName)//бой с индеями у пещеры
{
	int iRank = MOD_SKILL_ENEMY_RATE*2-2;
	pchar.quest.Sharlie_RescueDaughter2.over = "yes"; //снять прерывание
	//закрываем локаторы
	LocatorReloadEnterDisable("Martinique_CaveEntrance", "reload1_back", true);
	LocatorReloadEnterDisable("Martinique_CaveEntrance", "reload2_back", true);
	sld = characterFromId("RD_Prosper");
	ChangeCharacterAddressGroup(sld, "Martinique_CaveEntrance", "officers", "reload2_1");
	LAi_SetImmortal(sld, false);
	LAi_SetWarriorType(sld);
	sld.MusketerDistance = 0;
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	for (i=1; i<=3; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("RD_Ind_"+i, "canib_"+i, "man", "man", iRank, PIRATE, 0, true, "soldier"));
		SetFantomParamFromRank(sld, iRank, true);
		GiveItem2Character(sld, "slave_02");
		EquipCharacterbyItem(sld, "slave_02");
		RemoveCharacterEquip(sld, GUN_ITEM_TYPE);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		ChangeCharacterAddressGroup(sld, "Martinique_CaveEntrance", "officers", "reload1_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "RescueDaughter_KillIndiansLand");
	LAi_SetFightMode(pchar, true);
}

void RescueDaughter_CreateIndiansGrot(string qName)//бой с индеями в гроте
{
	int iRank = MOD_SKILL_ENEMY_RATE*2-2;
	LocatorReloadEnterDisable("Martinique_CaveEntrance", "reload2_back", false);
	chrDisableReloadToLocation = true;//закрыть локацию
	if (!CheckAttribute(pchar, "questTemp.Sharlie.RescueDaughter.KillProsper"))
	{
		sld = characterFromId("RD_Prosper");
		LAi_SetWarriorType(sld);
		sld.MusketerDistance = 0;
		ChangeCharacterAddressGroup(sld, "Martinique_Grot", "reload", "reload1_back");
	}
	ref rItm = ItemsFromID("fire");
	rItm.shown = true;
	rItm.startLocation = "Martinique_Grot";
	rItm.startLocator = "fire";
	CreateFireParticles("goto", "fire"); //костер
	//Селина
	sld = GetCharacter(NPC_GenerateCharacter("RD_Selina", "Selena", "woman", "towngirl", 1, FRANCE, -1, true, "quest"));
	SetFantomParamFromRank(sld, 1, true);
	sld.name = "Selina";
	sld.lastname = "Trubal";
	sld.Dialog.Filename = "Quest\Sharlie\StartMiniQuests.c";
	sld.greeting = "rapers_girl_2";
	LAi_SetImmortal(sld, true);
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "Martinique_Grot", "goto", "goto2");
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	//Жильберт
	sld = GetCharacter(NPC_GenerateCharacter("RD_Jilberte", "citiz_17", "man", "man", 5, FRANCE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 5, 5, 5, "", "", "", 10);
	sld.name = "Gilbert";
	sld.lastname = "Cursee";
	sld.Dialog.Filename = "Quest\Sharlie\StartMiniQuests.c";
	sld.dialog.currentnode = "Jilberte";
	LAi_SetImmortal(sld, true);
	LAi_SetActorType(sld);
	LAi_ActorSetLayMode(sld);
	ChangeCharacterAddressGroup(sld, "Martinique_Grot", "monsters", "monster3");
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	//индеи
	for (i=1; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("RD_IndCave_"+i, "canib_"+(i+1), "man", "man", iRank, PIRATE, 0, true, "soldier"));
		SetFantomParamFromRank(sld, iRank, true);
		RemoveAllCharacterItems(sld, true);
		GiveItem2Character(sld, "slave_02");
		EquipCharacterbyItem(sld, "slave_02");
		if (i == 4)
		{
			sld.SaveItemsForDead = true;
			sld.DontClearDead = true;
			TakeNItems(sld, "indian_3", 1);
			TakeNItems(sld, "cannabis1", 2);
			TakeNItems(sld, "potion3", 1);
		}
		else
		{
			DeleteAttribute(sld, "SaveItemsForDead");
			DeleteAttribute(sld, "DontClearDead");
		}
		ChangeCharacterAddressGroup(sld, "Martinique_Grot", "goto", "ass"+i);
		LAi_SetActorType(sld);
		LAi_ActorAnimation(sld, "Ground_sitting", "RescueDaughter_IndFight", 1.5);
	}
}

void RescueDaughter_GoHome(string qName)//проводим домой
{
	chrDisableReloadToLocation = true;//закрыть локацию
	if (CheckAttribute(pchar, "questTemp.Sharlie.RescueDaughter.KillProsper"))
	{
		sld = characterFromId("RD_Selina");
		sld.dialog.currentnode = "Selina_8";
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
	else
	{
		sld = characterFromId("RD_Prosper");
		sld.dialog.currentnode = "Prosper_20";
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
	pchar.quest.Sharlie_RescueDaughter6.win_condition.l1 = "location";
	pchar.quest.Sharlie_RescueDaughter6.win_condition.l1.location = "Fortfrance_town";
	pchar.quest.Sharlie_RescueDaughter6.function = "RescueDaughter_Final";
}

void RescueDaughter_Final(string qName)//пришли в город
{
	chrDisableReloadToLocation = true;//закрыть локацию
	if (CheckAttribute(pchar, "questTemp.Sharlie.RescueDaughter.KillProsper"))
	{
		sld = characterFromId("RD_Selina");
		sld.dialog.currentnode = "Selina_11";
		ChangeCharacterAddressGroup(sld, "Fortfrance_town", "goto", "goto7");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
	else
	{
		sld = characterFromId("RD_Prosper");
		sld.dialog.currentnode = "Prosper_23";
		ChangeCharacterAddressGroup(sld, "Fortfrance_town", "goto", "goto7");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
		sld = characterFromId("RD_Selina");
		ChangeCharacterAddressGroup(sld, "Fortfrance_town", "goto", "goto7");
	}
	sld = characterFromId("RD_Jilberte");
	sld.dialog.currentnode = "Jilberte_4";
	ChangeCharacterAddressGroup(sld, "Fortfrance_town", "reload", "reload4_back");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

//<-- мини-квесты для сбора денег

void SharlieSeabattle_agent(string qName)//пиратский агент
{
	int iRank = MOD_SKILL_ENEMY_RATE+3;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = GetCharacter(NPC_GenerateCharacter("Seabattle_pirate", "citiz_46", "man", "man", iRank, PIRATE, -1, false, "soldier"));
	SetFantomParamFromRank(sld, iRank, true);
	FantomMakeSmallSailor(sld, SHIP_WAR_TARTANE, "", CANNON_TYPE_CANNON_LBS3, 15, 10, 15, 10, 10);
	sld.Dialog.Filename = "Quest\Sharlie\OtherNPC.c";
	sld.Dialog.currentnode = "Seabattle_pirate";
	sld.name = "Wolter";
	sld.lastname = "Catcher";
	sld.greeting = "town_pirate";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "Fortfrance_town", "goto", LAi_FindNearestLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void SharlieSeabattle_ship(string qName)
{
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	AddQuestRecord("Sharlie", "17");
	Island_SetReloadEnableGlobal("Martinique", false);
	bQuestDisableMapEnter = true;
	Group_FindOrCreateGroup("Pirate_Attack");
	Group_AddCharacter("Pirate_Attack", "Seabattle_pirate");
	Group_SetType("Pirate_Attack", "pirate");
	if (MOD_SKILL_ENEMY_RATE > 6)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Seabattle_pirate_1", "citiz_45", "man", "man", 10, PIRATE, -1, false, "soldier"));
		SetFantomParamFromRank(sld, 10, true);
		FantomMakeSmallSailor(sld, SHIP_WAR_TARTANE, "", CANNON_TYPE_CANNON_LBS3, 20, 25, 25, 30, 30);
		Group_AddCharacter("Pirate_Attack", "Seabattle_pirate_1");
	}
	Group_SetGroupCommander("Pirate_Attack", "Seabattle_pirate");
	Group_SetAddress("Pirate_Attack", "Martinique", "quest_ships", "quest_ship_5");
	Group_SetTaskAttack("Pirate_Attack", PLAYER_GROUP);
	Group_LockTask("Pirate_Attack");
	pchar.quest.SharlieSea_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.SharlieSea_AfterBattle.win_condition.l1.group = "Pirate_Attack";
	pchar.quest.SharlieSea_AfterBattle.function = "SharlieSea_AfterBattle";
}

void Sharlie_SkiperTalk(string qName)//штурман в каюте
{
    sld = characterFromId("Folke");
	if (pchar.questTemp.Sharlie.Ship == "sloop") sld.dialog.currentnode = "Folke_7";
	else sld.dialog.currentnode = "Folke_6";
	ChangeCharacterAddressGroup(sld, "My_Cabin_Small", "rld", "aloc1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void SharlieSea_AfterBattle(string qName)//после боя
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Island_SetReloadEnableGlobal("Martinique", true);
	bQuestDisableMapEnter = false;
	bDisableFastReload = false;
	DeleteAttribute(pchar, "GenQuest.CannotWait");
	i = FindColony("Fortfrance");
	DeleteAttribute(colonies[i], "DontSetShipInPort");//ставить корабли
	bNoEatNoRats  = false; // включаем еду и крыс
	Group_DeleteGroup("Pirate_Attack");
	AddQuestRecord("Sharlie", "18");
	pchar.questTemp.Sharlie = "fadey";//к Фадею на Гваделупу
}

void FreeTichingituOver(string qName)//удаляем Тичингиту
{
	DeleteAttribute(pchar, "questTemp.Sharlie.Tichingitu");
	if (CheckCharacterItem(pchar, "letter_1")) RemoveItems(pchar, "letter_1", 1); // 170712
}

void SetTichingituJail()//ставим Тичингиту
{
	sld = GetCharacter(NPC_GenerateCharacter("Tichingitu", "maskog", "man", "man", 1, FRANCE, 10, false, "quest"));
	sld.name = "Tichingitu"; // 270912
	sld.lastname = "";
	sld.greeting = "Tichingitu";
    sld.Dialog.Filename = "Quest\Sharlie\Tichingitu.c";
	sld.dialog.currentnode = "Tichingitu";
	sld.rank = 12;
	LAi_SetHP(sld, 140.0, 140.0);
	SetSPECIAL(sld, 4, 9, 5, 5, 10, 8, 8);
	SetSelfSkill(sld, 30, 30, 30, 50, 20);
    SetShipSkill(sld, 5, 5, 2, 5, 1, 2, 1, 1, 10);
	SetCharacterPerk(sld, "Energaiser");
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "BasicDefense");
	SetCharacterPerk(sld, "CriticalHit");
	SetCharacterPerk(sld, "Gunman");
	GiveItem2Character(sld, "unarmed");
	sld.equip.blade = "unarmed";
	sld.equip.gun = "";
	ChangeCharacterAddressGroup(sld, "BasTer_prison", "goto", "goto9");
	LAi_SetStayType(sld);
	LAi_SetImmortal(sld, true); // 170712
}

void Sharlie_GambitStage(string qName)//переход на голландский гамбит
{
	pchar.questTemp.Sharlie = "gambitstage";
	sld = characterFromId("Mishelle");	
	sld.greeting = "mishelle_2"; 
}

void Persian_FindSkimitar(string qName)// скимитар 021012
{
	DeleteAttribute(pchar, "questTemp.Persian.skimitar");
}

void Persian_CirassLamport(string qName)// плетеный доспех
{
	pchar.questTemp.Persian = "cirass";
	SetFunctionTimerCondition("Persian_CirassLamportOver", 0, 0, 16, false); // таймер
}

void Persian_CirassLamportOver(string qName)// просрочка
{
	pchar.questTemp.Persian = "end";
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////	
///Jason------------------------------------- Карибские нравы ----------------------------------------
///////////////////////////////////////////////////////////////////////////////////////////////////////////
void Sharlie_TrialOver(string qName)// пропустил сроки
{
	DeleteAttribute(pchar, "questTemp.Trial");
}

void Trial_StartLine(string qName)// начало линейки
{
	sld = GetCharacter(NPC_GenerateCharacter("Lecrua", "trader_8", "man", "man", 10, FRANCE, -1, true, "citizen"));
	SetFantomParamFromRank(sld, 10, true);
	sld.name = "Gerar";
	sld.lastname = "Lecrua";
	sld.dialog.FileName = "Quest\Sharlie\Trial.c";
	sld.dialog.currentnode = "Lecrua";
	sld.greeting = "captain_trader";
	LAi_SetStayType(sld);
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "baster_store", "goto", "goto4");
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	SetFunctionTimerCondition("Trial_LineOver", 0, 0, 1, false); // таймер
}

void Trial_LineOver(string qName)// пропустил сроки
{
	sld = characterFromId("Lecrua");
	LAi_CharacterDisableDialog(sld);//запрет диалога
	sld.lifeday = 0;
	AddQuestRecord("Trial", "2");
	CloseQuestHeader("Trial");
	DeleteAttribute(pchar, "questTemp.Trial");
}

void Trial_LecruaHide(string qName)// 
{
	sld = characterFromId("Lecrua");
	ChangeCharacterAddressGroup(sld, "none", "", "");
}

void Trial_FrahtFail(string qName)// провалил 1 задание
{
	sld = characterFromId("Lecrua");
	sld.lifeday = 0;
	AddQuestRecord("Trial", "5");
	CloseQuestHeader("Trial");
	DeleteAttribute(pchar, "questTemp.Trial");
	ChangeCharacterNationReputation(pchar, FRANCE, -12);
}

void Trial_CreateFlorianFrigate(string qName)// ставим фрегат Флориана Шоке
{
	Group_FindOrCreateGroup("Florian_group");
	Group_SetType("Florian_group", "war");//тип группы
	sld = GetCharacter(NPC_GenerateCharacter("Florian", "off_fra_3", "man", "man", 40, FRANCE, -1, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_FRIGATE, "Warlike", CANNON_TYPE_CANNON_LBS24, 105, 105, 105);
	FantomMakeCoolFighter(sld, 40, 100, 100, "blade_13", "pistol1", "bullet", 250);
	sld.name = "Florian";
	sld.lastname = "Shoke";
	sld.dialog.FileName = "Quest\Sharlie\Trial.c";
	sld.DeckDialogNode = "florian_deck";
	sld.greeting = "captain";
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "war";
	sld.DontHitInStorm = true; //не ломается в шторм
	sld.Abordage.Enable = false;
	sld.SinkTenPercent = false;
	sld.AlwaysSandbankManeuver = true;
	sld.MultiFighter = 2.5; // мультифайтер
	sld.ship.Crew.Morale = 100;
	sld.Ship.Crew.Exp.Sailors = 100;
	sld.Ship.Crew.Exp.Cannoners = 100;
	sld.Ship.Crew.Exp.Soldiers = 100;
	SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("Florian_group", "Florian");
	Group_SetGroupCommander("Florian_group", "Florian");
	Group_SetTaskNone("Florian_group");
	Group_SetAddress("Florian_group", "Portobello", "quest_ships", "quest_ship_8");
	Group_LockTask("Florian_group");
	
	pchar.quest.Trial_Florian_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Trial_Florian_AfterBattle.win_condition.l1.group = "Florian_group";
	pchar.quest.Trial_Florian_AfterBattle.function = "Trial_FlorianAfterBattle";
}

void Trial_CannonFail(string qName)// провалил 2 задание
{
	pchar.quest.Trial_cannon.over = "yes"; 
	sld = characterFromId("Lecrua");
	sld.lifeday = 0;
	AddQuestRecord("Trial", "8");
	CloseQuestHeader("Trial");
	DeleteAttribute(pchar, "questTemp.Trial");
	ChangeCharacterNationReputation(pchar, FRANCE, -15);
}

void Trial_FlorianAfterBattle(string qName)// напал на Флориана Шоке
{
	bQuestDisableMapEnter = false;
	sld = characterFromId("Lecrua");
	sld.lifeday = 0;
	AddQuestRecord("Trial", "9");
	CloseQuestHeader("Trial");
	DeleteAttribute(pchar, "questTemp.Trial");
	ChangeCharacterNationReputation(pchar, FRANCE, -60);
}

void Trial_TakeCannons()// выгрузка
{
	SetLaunchFrameFormParam("Three hours passed..."+ NewStr() +"The cannons were loaded on the frigate", "", 0, 5);
	LaunchFrameForm();
	WaitDate("", 0, 0, 0, 3, 10); //крутим время
	RecalculateJumpTable();
	DoQuestFunctionDelay("Trial_TakeCannonsEnd", 1.0);
}

void Trial_TakeCannonsEnd()// 
{
	RemoveCharacterGoods(pchar, GOOD_CANNON_24, 15);
	sld = characterFromId("Florian");
	sld.dialog.currentnode = "florian_deck_4";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", 1.0, -1);
}

void Trial_RemoveFlorian(string qName)// трем Флориана
{
	if (GetCharacterIndex("Florian") != -1)
	{
		pchar.quest.Trial_Florian_AfterBattle.over = "yes"; //снять прерывание
		sld = characterFromId("Florian");
		sld.DontDeskTalk = true;
		sld.lifeday = 0;
	}
}

void Trial_SpyTimeOver(string qName) //время на шпионаж вышло
{
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle"); // patch-7
	DoQuestFunctionDelay("Trial_RemoveFlorian", 0.5);
	AddQuestRecord("Trial", "18");
	CloseQuestHeader("Trial");
	DeleteAttribute(pchar, "questTemp.Trial");
}

void Trial_TavernEnterSoldiers() //неверный путь в таверне
{	
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+5;
	for (i=1; i<=3; i++)
    {
        sld = GetCharacter(NPC_GenerateCharacter("TTSold"+i, "sold_spa_"+(rand(1)+1), "man", "man", iRank, SPAIN, 0, true, "soldier"));
		SetFantomParamFromRank(sld, iRank, true);         
		LAi_SetWarriorType(sld); 
		LAi_warrior_DialogEnable(sld, false);
        LAi_group_MoveCharacter(sld, "EnemyFight");
        ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
    }
    sld = GetCharacter(NPC_GenerateCharacter("TTOfficer", "off_spa_"+(rand(1)+1), "man", "man", iRank, SPAIN, 0, true, "quest"));
	FantomMakeCoolFighter(sld, iRank, iRank+30, iRank+30, "blade_19", "pistol3", "grapeshot", 50);
	sld.name = "Arthuro";
	sld.lastname = "Cascos";
	sld.dialog.FileName = "Quest\Sharlie\Trial.c";
	sld.dialog.currentnode = "tavern_officer";
	sld.greeting = "soldier_arest";
    LAi_SetActorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
	LAi_ActorDialog(sld, pchar, "", 1.0, 0);
	
	sld = characterFromId("Florian");
	sld.DeckDialogNode = "florian_failspy";
	pchar.questTemp.Trial = "spy_fail";
}

void Trial_Spyfail_NextStage(string qName)//активируем следующий квест, если попался шпионом
{
	sld = characterFromId("Florian");
	sld.DeckDialogNode = "florian_17";
}

void Trial_SetPoormanInPort(string qName)//ставим нищеброда
{
	sld = characterFromId("PortoBello_Poorman");
	sld.dialog.currentnode = "trial_6";
	ChangeCharacterAddressGroup(sld, "Portobello_town", "reload", "reload5");
	LAi_SetStayType(sld);
}

void Trial_CreatePueblaBarqueInWorld()//запускаем барк 'Пуэбла' на карте
{
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE/2;
	int iScl = MOD_SKILL_ENEMY_RATE+3*sti(pchar.rank);
    string sCapId = "PueblaCap";
    string sGroup = "Sea_" + sCapId + "1";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	sld = GetCharacter(NPC_GenerateCharacter(sCapId, "off_spa_"+(rand(1)+1), "man", "man", iRank, SPAIN, 3, true, "soldier"));
	FantomMakeSmallSailor(sld, SHIP_BARQUE, "Puebla", CANNON_TYPE_CANNON_LBS6, iScl+10, iScl, iScl, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_14", "pistol1", "bullet", iScl*2);
	SetCharacterPerk(sld, "HullDamageUp");
	SetCharacterPerk(sld, "SailsDamageUp");
	SetCharacterPerk(sld, "CrewDamageUp");
	SetCharacterPerk(sld, "BasicBattleState");
	SetCharacterPerk(sld, "AdvancedBattleState");
	SetCharacterPerk(sld, "ShipSpeedUp");
	SetCharacterPerk(sld, "ShipTurnRateUp");
	AddCharacterGoods(sld, GOOD_POWDER, 2000); // patch-6
	sld.AlwaysEnemy = true;
	sld.DontRansackCaptain = true;
	sld.Ship.Mode = "war";
	sld.AnalizeShips = true;
	sld.mapEnc.type = "war";
	sld.mapEnc.worldMapShip = "quest_ship";
	sld.mapEnc.Name = "'Puebla'";
	Group_AddCharacter(sGroup, sCapId);
    Group_SetGroupCommander(sGroup, sCapId);
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
	Map_CreateTrader("Shore25", "Portobello", sld.id, 3);
	// --> 170712
	pchar.quest.Trial_Puebla_barque_Check.win_condition.l1 = "Group_Death";
	pchar.quest.Trial_Puebla_barque_Check.win_condition.l1.group = sGroup;
	pchar.quest.Trial_Puebla_barque_Check.function = "Trial_Pueblabarque_Check";
	
	//на захват либо потопление абордажем
	pchar.quest.Trial_Puebla_barque_abordage.win_condition.l1 = "Character_Capture";
	pchar.quest.Trial_Puebla_barque_abordage.win_condition.l1.character = "PueblaCap";
	pchar.quest.Trial_Puebla_barque_abordage.function = "Trial_Pueblabarque_AfterBattle";//взяли на абордаж
	//на потопление орудиями
	pchar.quest.Trial_Puebla_barque_Sink.win_condition.l1 = "Character_sink";
	pchar.quest.Trial_Puebla_barque_Sink.win_condition.l1.character = "PueblaCap";
	pchar.quest.Trial_Puebla_barque_Sink.function = "Trial_Pueblabarque_AfterBattle";//потопили
}

void Trial_Pueblabarque_AfterBattle(string qName)// уничтожили
{
	DoQuestCheckDelay("sea_victory", 1.5);
	AddQuestRecord("Trial", "21");
	pchar.questTemp.Trial = "next_round";
	sld = characterFromId("BasTer_trader");
	sld.quest.trial_usurer = true;
	pchar.questTemp.Trial.PueblaDie = "true";
	AddComplexSeaExpToScill(50, 50, 50, 50, 50, 50, 0);
	ChangeCharacterNationReputation(pchar, SPAIN, -3);
	ChangeCharacterComplexReputation(pchar, "fame", 1);
}

void Trial_Pueblabarque_Check(string qName)// истекло время энкаунтера или уничтожен
{
	SetFunctionTimerCondition("Trial_Pueblabarque_Result", 0, 0, 1, false); // таймер
}

void Trial_Pueblabarque_Result(string qName) // результаты
{
	Group_DeleteGroup("Sea_PueblaCap1");
  pchar.quest.Trial_Puebla_barque_abordage.over = "yes"; // mitrokosta фикс двойной награды за пуэблу
	pchar.quest.Trial_Puebla_barque_Sink.over = "yes";
	if (CheckAttribute(pchar, "questTemp.Trial.PueblaDie")) // уничтожен
	{
		return;
	}
	else // упущен
	{
	sld = characterFromId("Lecrua");
	sld.lifeday = 0;
	AddQuestRecord("Trial", "20");
	CloseQuestHeader("Trial");
	DeleteAttribute(pchar, "questTemp.Trial");
}
} // <-- 170712

///////////////////////////////////////////////////////////////////////////////////////////////////////////	
///Jason-------------------------------------Пиратская Сага-----------------------------------------------
///////////////////////////////////////////////////////////////////////////////////////////////////////////
void Gladis_SetHome(string qName)//ставим Глэдис домой
{
	sld = characterFromId("Gladis");
	ChangeCharacterAddressGroup(sld, "SantaCatalina_houseSp3", "goto", "goto1");
	LAi_SetOwnerType(sld);
}

void Helena_AntiguaOver(string qName)//провал квеста по срокам
{
	pchar.quest.Saga_createDonovan.over = "yes";//снять возможное прерывание на корвет Донована
	pchar.quest.Saga_createJimmy.over = "yes"; //снять возможное прерывание на Джимми
	sld = characterFromId("Gladis");
	sld.dialog.currentnode = "Helena_die";
	AddQuestRecord("Saga", "2");
	CloseQuestHeader("Saga");
	DeleteAttribute(pchar, "questTemp.Saga");
	// Левассера - к барьеру!
	sld = characterFromId("Tortuga_Mayor");
	LAi_LoginInCaptureTown(sld, true);
	pchar.questTemp.Sharlie.Hardcore_Tortuga = "true";
}

void Saga_CreateJimmy(string qName)//ставим Джимми
{
	int iRank = 18+MOD_SKILL_ENEMY_RATE;
	int iScl = 50;
	sld = GetCharacter(NPC_GenerateCharacter("SagaJimmy" , "mercen_16", "man", "man", iRank, PIRATE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_10", "pistol6", "bullet", iScl);
	sld.name = "Jimmy";
	sld.lastname = "Higgins";
	sld.dialog.FileName = "Quest\Saga\OtherNPC.c";
	sld.dialog.currentnode = "Jimmy";
	sld.greeting = "town_pirate";
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	LAi_SetOwnerType(sld);
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "FortOrange_House1", "goto", "goto1");
}

void Saga_createDonovan(string qName)//ставим корвет Донована
{
	pchar.quest.Helena_AntiguaOver.over = "yes";// снять таймер
	AddQuestRecord("Saga", "7");
	Island_SetReloadEnableGlobal("Antigua", false);//на остров нельзя
	Group_FindOrCreateGroup("DonovanGroup");
	Group_SetType("DonovanGroup", "war");//тип группы
	int iRank = 18+MOD_SKILL_ENEMY_RATE;
	int iScl = 55;
	sld = GetCharacter(NPC_GenerateCharacter("Donovan", "Donovan", "man", "man", iRank, ENGLAND, -1, true, "quest"));
	FantomMakeSmallSailor(sld, SHIP_CORVETTE, "Arbutus", CANNON_TYPE_CANNON_LBS20, 70, iScl, iScl+5, iScl+10, iScl+5);
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_22", "pistol6", "bullet", iScl*2); // 300912
	sld.name = "Arthur";
	sld.lastname = "Donovan";
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.SaveItemsForDead = true; // сохранять на трупе вещи
	sld.DontClearDead = true; // 300912
	sld.Ship.Mode = "war";
	sld.AlwaysEnemy = true;
	SetCharacterPerk(sld, "MusketsShoot");
	SetCharacterPerk(sld, "HullDamageUp");
	SetCharacterPerk(sld, "SailsDamageUp");
	SetCharacterPerk(sld, "CrewDamageUp");
	SetCharacterPerk(sld, "CriticalShoot");
	SetCharacterPerk(sld, "BasicBattleState");
	SetCharacterPerk(sld, "AdvancedBattleState");
	SetCharacterPerk(sld, "ShipDefenseProfessional");
	SetCharacterPerk(sld, "ShipSpeedUp");
	SetCharacterPerk(sld, "ShipTurnRateUp");
	SetCharacterPerk(sld, "Doctor1");
	Group_AddCharacter("DonovanGroup", "Donovan");
	Group_SetGroupCommander("DonovanGroup", "Donovan");
	if (sti(pchar.rank > 17) && MOD_SKILL_ENEMY_RATE > 4)
	{
		sld = GetCharacter(NPC_GenerateCharacter("DonovanHelper", "off_eng_2", "man", "man", 25, ENGLAND, 2, true, "quest"));
		FantomMakeSmallSailor(sld, SHIP_FRIGATE, "", CANNON_TYPE_CANNON_LBS24, 80, 65, 75, 80, 65);
		FantomMakeCoolFighter(sld, 25, 70, 70, "blade_15", "pistol6", "bullet", 200);
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.Ship.Mode = "war";
		sld.AlwaysEnemy = true;
		SetCharacterPerk(sld, "MusketsShoot");
		SetCharacterPerk(sld, "HullDamageUp");
		SetCharacterPerk(sld, "SailsDamageUp");
		SetCharacterPerk(sld, "CrewDamageUp");
		SetCharacterPerk(sld, "CriticalShoot");
		SetCharacterPerk(sld, "BasicBattleState");
		SetCharacterPerk(sld, "AdvancedBattleState");
		SetCharacterPerk(sld, "ShipDefenseProfessional");
		SetCharacterPerk(sld, "ShipSpeedUp");
		SetCharacterPerk(sld, "ShipTurnRateUp");
		SetCharacterPerk(sld, "Doctor1");
		Group_AddCharacter("DonovanGroup", "DonovanHelper");
		Group_SetGroupCommander("DonovanGroup", "DonovanHelper");
	}
	Group_SetTaskNone("DonovanGroup");//нет задачи
	Group_SetAddress("DonovanGroup", "Antigua", "quest_ships", "quest_ship_"+(3+rand(4)));
	Group_LockTask("DonovanGroup");
	
	pchar.quest.Donovan_AfterBattle.win_condition.l1 = "NPC_Death";
	pchar.quest.Donovan_AfterBattle.win_condition.l1.character = "Donovan";
	pchar.quest.Donovan_AfterBattle.function = "Donovan_AfterBattle";
	pchar.quest.Donovan_DieHard.win_condition.l1 = "MapEnter";
	pchar.quest.Donovan_DieHard.function = "Donovan_DieHard";
}

void Donovan_AfterBattle(string qName)//после боя
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.Donovan_DieHard.over = "yes";
	if (CheckAttribute(pchar, "questTemp.Saga.Takehelen"))//абордировали
	{
		bQuestDisableMapEnter = true;//закрыть карту
		int iShipType = GetCharacterShipType(pchar);
		ref rShip = GetRealShip(iShipType);
		sTemp = "My_" + rShip.CabinType;
		sld = characterFromId("Helena");
		sld.dialog.currentnode = "After_boarding";
		ChangeCharacterAddressGroup(sld, sTemp, "rld", "aloc0");
		LAi_SetStayType(sld);
		AddPassenger(pchar, sld, false);
		SetCharacterRemovable(sld, false);
		AddQuestRecord("Saga", "10");
		AddComplexSeaExpToScill(150, 100, 100, 200, 100, 100, 0);
	}
	else
	{
		Island_SetReloadEnableGlobal("Antigua", true);//на остров можно
		sld = characterFromId("Gladis");
		sld.dialog.currentnode = "Helena_die";
		AddQuestRecord("Saga", "9");
		CloseQuestHeader("Saga");
		DeleteAttribute(pchar, "questTemp.Saga");
		// Левассера - к барьеру!
		sld = characterFromId("Tortuga_Mayor");
		LAi_LoginInCaptureTown(sld, true);
		pchar.questTemp.Sharlie.Hardcore_Tortuga = "true";
	}
}

void Donovan_DieHard(string qName)//сбежал
{
	Island_SetReloadEnableGlobal("Antigua", true);//на остров можно
	pchar.quest.Donovan_AfterBattle.over = "yes";
	Group_DeleteGroup("DonovanGroup");
	sld = characterFromId("Gladis");
	sld.dialog.currentnode = "Helena_die";
	AddQuestRecord("Saga", "8");
	CloseQuestHeader("Saga");
	DeleteAttribute(pchar, "questTemp.Saga");
	// Левассера - к барьеру!
	sld = characterFromId("Tortuga_Mayor");
	LAi_LoginInCaptureTown(sld, true);
	pchar.questTemp.Sharlie.Hardcore_Tortuga = "true";
}

void Saga_returnBlueveld(string qName)//возвращение в Блювельд
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Helena");
	RemovePassenger(Pchar, sld);
	sld.dialog.currentnode = "Return_blueveld";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "Santacatalina_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Helena_ReturnOver(string qName)//чтобы не тянул c переходом
{
	sld = characterFromId("Helena");
	RemovePassenger(Pchar, sld);
	sld.lifeday = 0;
	sld = characterFromId("Gladis");
	sld.dialog.currentnode = "Gladis_exit";
	AddQuestRecord("Saga", "12");
	CloseQuestHeader("Saga");
	DeleteAttribute(pchar, "questTemp.Saga");
	log_info("Helen McArthur died of calenture!");
	pchar.quest.Saga_returnBlueveld.over = "yes"; //Desperado фикс блокировки Блювельда
	// Левассера - к барьеру!
	sld = characterFromId("Tortuga_Mayor");
	LAi_LoginInCaptureTown(sld, true);
	pchar.questTemp.Sharlie.Hardcore_Tortuga = "true";
}

void Saga_CreateGonsalesA(string qName)	//ставим Гонсалеса
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = GetCharacter(NPC_GenerateCharacter("SagaGonsalesA" , "citiz_19", "man", "man", 12, SPAIN, 2, true, "soldier"));
	SetFantomParamFromRank(sld, 12, true);
	sld.name = "Enrique";
	sld.lastname = "Gonzales";
	sld.dialog.FileName = "Quest\Saga\OtherNPC.c";
	sld.dialog.currentnode = "GonsalesA";
	sld.greeting = "citizen_male";
	LAi_SetOwnerType(sld);
	LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
	ChangeCharacterAddressGroup(sld, "Cartahena_houseF2", "goto", "goto1");
}

void Saga_CreateGonsalesB(string qName)	//ставим Гонсалеса
{
	sld = GetCharacter(NPC_GenerateCharacter("SagaGonsalesB", "citiz_41", "man", "man", 15, SPAIN, -1, true, "soldier"));
	FantomMakeCoolFighter(sld, 15, 40, 40, "blade_10", "pistol1", "bullet", 50);
	sld.name = "Enrique";
	sld.lastname = "Galliardo";
	sld.dialog.FileName = "Quest\Saga\OtherNPC.c";
	sld.dialog.currentnode = "GonsalesB";
	sld.greeting = "town_pirate";
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	LAi_SetWarriorType(sld);
	LAi_SetLoginTime(sld, 6.0, 21.0);
	ChangeCharacterAddressGroup(sld, "Cartahena_town", "quest", "quest2");
}

void Saga_SetOrtega() //ставим клон Ортеги, а настоящего смотрителя прячем
{
	sld = characterFromId("Cartahena_Lightman");
	sld.location = "none";
	sld = GetCharacter(NPC_GenerateCharacter("SagaOrtega", "keeper_1", "man", "man_B", 20, SPAIN, -1, true, "soldier"));
	FantomMakeCoolFighter(sld, 20, 50, 50, "", "pistol1", "bullet", 50);
	string sBlade = GetBestGeneratedItem("blade_10");
	GiveItem2Character(sld, sBlade);
	sld.equip.blade = sBlade;
	sld.name = "Alvares";
	sld.lastname = "Ortega";
	sld.dialog.FileName = "Quest\Saga\OtherNPC.c";
	sld.dialog.currentnode = "Ortega";
	sld.greeting = "lighthouseman_2";
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	LAi_SetOwnerType(sld);
	LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "Mayak11_Lighthouseroom", "barmen", "bar2");
}

void Saga_LightmanReturn(string qName)//вертаем назад смотрителя маяка Картахены
{
	sld = characterFromId("Cartahena_Lightman");
	sld.location = "Mayak11_Lighthouseroom";
	sld.location.group = "barmen";
	sld.location.locator = "bar2";
	sld.model = "citiz_32";
	sld.model.animation = "man";
	sld.name = "Juan";
	sld.lastname = "Peres";
	sld.dialog.currentnode = "First time";
}

void Saga_CreateTrapBandos(string qName)//ловушка - бандиты у маяка
{
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	int n = makeint(MOD_SKILL_ENEMY_RATE/3);
	int iRank = 20+MOD_SKILL_ENEMY_RATE;
	int iScl = 55;
	for (i=1; i<=3+n; i++)
	{
		if (i == 1) 
		{	
			sld = GetCharacter(NPC_GenerateCharacter("sagatrap_sold_"+i, "mush_ctz_"+(rand(2)+7), "man", "mushketer", iRank, PIRATE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, 80, "", "mushket1", "cartridge", iScl*2);
			sld.Dialog.Filename = "Quest\Saga\OtherNPC.c";
			sld.dialog.currentnode = "saga_trap";
			sld.greeting = "hunter";
			ChangeCharacterAddressGroup(sld, "mayak11", "reload", "reload1");
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("sagatrap_sold_"+i, "citiz_"+(40+i), "man", "man", iRank, PIRATE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_04", "pistol1", "bullet", iScl*2);
			LAi_CharacterDisableDialog(sld);
			ChangeCharacterAddressGroup(sld, "mayak11", "reload", "reload1");
		}
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

//------------------------------------------телепортация-------------------------------------------
void Dolly_TeleportStart()
{
	PlaySound("interface\notebook.wav");
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "camera", "dolly");
	if (CheckAttribute(pchar, "questTemp.Saga.BaronReturn") && pchar.questTemp.Saga.BaronReturn == "first_teleport") LAi_ActorAnimation(pchar, "afraid", "OpenTheDoors", 1.2);
	for (i=1; i<=8; i++)
	{
		CreateLocationParticles("shadowstar", "item", "torch"+i, 1.15, 0, 0, "");
	}
	CreateLocationParticles("shadowstar", "camera", "dolly", 1.15, 0, 0, "");
	DoQuestFunctionDelay("Dolly_TeleportContinue_1", 7.0);
	if (sGlobalTemp == "dolly2") PlayStereoOGG("music_teleport");
	else SetMusic("music_teleport");
}

void Dolly_TeleportContinue_1(string qName)
{
	for (i=1; i<=8; i++)
	{
		switch (sGlobalTemp)
		{
			case "dolly1":
				PlaySound("Weather\Thunder_01.wav");
				CreateLocationParticles("torch", "item", "torch"+i, 1.15, 0, 0, "");
			break;
			
			case "dolly2": 
				CreateLocationParticles("fountain", "item", "torch"+i, 1.15, 0, 0, "");
				CreateLocationParticles("fountain", "item", "torch"+i, 1.15, 0, 0, "");
				CreateLocationParticles("fishblue", "item", "dolly2", 1.15, 0, 0, "");
				CreateLocationParticles("fountain", "item", "dolly2", 1.15, 0, 0, "");
				CreateLocationParticles("fountain", "item", "dolly2", 1.15, 0, 0, "");
				CreateLocationParticles("Splash", "item", "dolly2", 2.2, 0, 0, "");
				PlaySound("Sea Battles\bolshoy_vsplesk_001.wav");
				PlaySound("Weather\fontan_001.wav");
			break;
			
			case "dolly3":
				CreateLocationParticles("smoke", "item", "torch"+i, 1.15, 0, 0, "");
				CreateLocationParticles("torch", "camera", "dolly", 1.15, 0, 0, "");
				PlaySound("Ambient\Teno_inside\big_ring.wav");
			break;
		}
	}
	DoQuestFunctionDelay("Dolly_TeleportContinue_2", 7.0);
}

void Dolly_TeleportContinue_2(string qName)
{
	switch (sGlobalTemp)
	{
		case "dolly1":
			CreateLocationParticles("large_smoke", "item", "dolly1", 1.15, 0, 0, "");
			CreateLocationParticles("shipfire", "item", "dolly1", 1.15, 0, 0, "");
	PlaySound("Weather\koster_001.wav");
		break;
		
		case "dolly2":
			CreateLocationParticles("bubbles", "item", "dolly2", 2.0, 0, 0, "");
			PlaySound("Sea Battles\bolshoy_vsplesk_003.wav");
			PlaySound("Weather\fontan_001.wav");
		break;
		
		case "dolly3": 
			CreateLocationParticles("large_smoke", "item", "dolly3", 1.15, 0, 0, "");
			PlaySound("Weather\Thunder_03.wav");
		break;
	}
	DoQuestFunctionDelay("Dolly_TeleportContinue_3", 6.0);
}

void Dolly_TeleportContinue_3(string qName)
{
	switch (sGlobalTemp)
	{
		case "dolly1": LAi_ActorGoToLocation(pchar, "item", "dolly1", "none", "", "", "", 1.0); break;
		case "dolly2": 
			LAi_ActorGoToLocation(pchar, "", "", "none", "", "", "", 1.0); 
		break;
		case "dolly3":
			LAi_ActorGoToLocation(pchar, "", "", "none", "", "", "", 1.0);
			CreateLocationParticles("large_smoke", "item", "dolly3", 1.15, 0, 0, "");
		break;
	}
	PlaySound("Ambient\Teno_inside\teleporter.wav");
	DoQuestFunctionDelay("Dolly_TeleportContinue_4", 8.0);
	if (CheckAttribute(pchar, "questTemp.Dolly_Tieyasal")) // 210812
	{
		// офицеры
		for(i=1; i<=3; i++)
		{
			int idx = GetOfficersIndex(pchar, i);
			if(idx < 0) continue;
			sld = &Characters[idx];
			if (CheckAttribute(sld, "quest.Tieyasal") && sld.quest.Tieyasal == "teleport")
			{
				ChangeCharacterAddressGroup(sld, "none", "", "");
				sld.quest.teleportation = true;
			}
		}
	}
}

void Dolly_TeleportContinue_4(string qName)
{
	if (CheckAttribute(pchar, "questTemp.Dolly_Tieyasal")) // 190812
	{
		DoQuestReloadToLocation("Tenochtitlan", "reload", "reload1", "Tieyasal_TeleportArrive");
		return;
	}
	switch (sGlobalTemp)
	{
		case "dolly1":
			DoQuestReloadToLocation("LostShipsCity_town", "quest", "teleport1", "LSC_TeleportArrive");
		break;
		
		case "dolly2":
			DoQuestReloadToLocation("Indian_town", "quest", "teleport1", "Dominica_TeleportArrive");
		break;
		
		case "dolly3": 
			DoQuestReloadToLocation("Pearl_jungle_03", "goto", "goto4", "Pearl_TeleportArrive");
		break;
	}
}

void Dolly_TeleportConsequences() // последствия телепорта
{
	Pchar.chr_ai.hp = stf(Pchar.chr_ai.hp)/3; // 2/3 жизни сносим
	AddCharacterHealth(pchar, -45); //сносим здоровье
	pchar.chr_ai.poison = 500; // травим
	if (stf(pchar.Health.HP) <= 1) LAi_KillCharacter(pchar);
}
//<-- телепортация

void Saga_BaronsQuestsGo(string qName)//старт квестов пиратских баронов
{
	pchar.questTemp.Saga = "baronsquests";
	SetFunctionTimerCondition("Saga_TimeOver", 0, 0, 365, false);//таймер на провал Саги по времени
}

//------------------------------------------возвращение барона-----------------------------------------------

void Saga_DannyMeeting(string qName)//знакомство с Даниэль
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Danielle");
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "SantaCatalina_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Saga_CreateSnakeEye()// создаем Змеиного Глаза - шамана
{
	sld = GetCharacter(NPC_GenerateCharacter("SnakeEye", "Shaman", "man", "man_B", 20, PIRATE, -1, true, "native"));
	SetFantomParamFromRank(sld, 10, true);
	sld.name = "Snake Eye";
	sld.lastname = "";
	sld.dialog.FileName = "Quest\Saga\SnakeEye.c";
	sld.dialog.currentnode = "SnakeEye";
	sld.greeting = "SnakeEye";
	LAi_SetGroundSitTypeNoGroup(sld);
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "Miskito_shack2", "quest", "quest1");
}

void Saga_DannyTalk(string qName)// говорилка Даниэль
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Danielle");
	switch (sld.quest.talk)
	{
		case "dolly": sld.dialog.currentnode = "Dolly"; break; //Даниэль показывает истукана
		case "SnakeEye": sld.dialog.currentnode = "SnakeEye"; break; //разговор с Даниэль в деревне мискито
		case "teleport": sld.dialog.currentnode = "teleport"; break; //перед полночью
		case "shadowstar": sld.dialog.currentnode = "shadowstar"; break; //перед телепортацией
		case "failcenturion": sld.dialog.currentnode = "failcenturion"; break; //потопили Центурион
	}
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Saga_NatanPrepareTreatment(string qName)// ставим Натана и Даниэль в деревню
{
	LocatorReloadEnterDisable("Miskito_village", "reload1", true);
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	sld = characterFromId("Danielle");
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "Miskito_village", "reload", "reload1");
	LAi_ActorFollowEverywhere(sld, "", -1);
	sld = characterFromId("Nathaniel");
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "Miskito_village", "reload", "reload1");
	LAi_ActorFollowEverywhere(sld, "", -1);
}

void Saga_NatanTreatment(string qName)// Даниэль после сдачи Натана на лечение
{
	LocatorReloadEnterDisable("Miskito_village", "reload1", false);
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], false);
	sld = characterFromId("Danielle");
	sld.dialog.currentnode = "treatment";
	LAi_SetActorType(sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

//------------------------------------------нахождение в ГПК (Локо-Риферте)----------------------------------
void LSC_CreateCrabGuard() // крабик-охранник
{
	sld = GetCharacter(NPC_GenerateCharacter("CrabGuard", "crabBig", "crab", "crabBig", 40+(MOD_SKILL_ENEMY_RATE), PIRATE, 0, false, "quest"));
	sld.name = "Giant crab";
	sld.lastname = "";
	GiveItem2Character(sld, "unarmed");
	EquipCharacterbyItem(sld, "unarmed");
	int iTemp = 100+MOD_SKILL_ENEMY_RATE*15+sti(pchar.rank)*5;
	LAi_SetHP(sld, iTemp, iTemp);
	if (MOD_SKILL_ENEMY_RATE > 2) sld.MultiFighter = stf(MOD_SKILL_ENEMY_RATE/2.5);
	sld.animal = true;
	SetCharacterPerk(sld, "BasicDefense");
	SetCharacterPerk(sld, "AdvancedDefense");
	SetCharacterPerk(sld, "CriticalHit");
	LAi_SetActorType(sld);
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	GiveItem2Character(sld, "jewelry52");
	ChangeCharacterAddressGroup(sld, "LostShipsCity_town", "reload", "reload2");
	DoQuestFunctionDelay("LSC_CrabAttack", 6.5);
}

void LSC_CrabAttack(string qName)// нападение краба по прибытии
{
	sld = characterFromId("CrabGuard");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "LSC_CrabGuardDie");
}

void LSC_OpenSanAvgustinDoors()// открыть наружные двери Сан-Августина
{
	for (int i=1; i<=8; i++)
	{
		if (i == 2 || i == 7) continue;
 		LocatorReloadEnterDisable("LostShipsCity_town", "reload"+i, false);
	}
}

void LSC_CloseSanAvgustinDoors()// закрыть наружные двери Сан-Августина
{
	for (int i=1; i<=8; i++)
	{
 		LocatorReloadEnterDisable("LostShipsCity_town", "reload"+i, true);
	}
}

void LSC_OpenTartarusDoors()// открыть наружные двери Тартаруса
{
	LocatorReloadEnterDisable("LostShipsCity_town", "reload51", false);
	LocatorReloadEnterDisable("LostShipsCity_town", "reload52", false);
}

void LSC_CloseTartarusDoors()// закрыть наружные двери Тартаруса
{
	LocatorReloadEnterDisable("LostShipsCity_town", "reload51", true);
	LocatorReloadEnterDisable("LostShipsCity_town", "reload52", true);
}

// ---------------------------------вариант прохождения R: стрелок--------------------------------------------
void LSC_CreatePantryGuard(string qName)// арест, если полез в трюм
{
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.questTemp.LSC = "prison"; // меняем флаг
	LSC_OpenSanAvgustinDoors(); // открываем Сан-Августин
	LSC_OpenTartarusDoors(); // открываем Тартарус снаружи
	LocatorReloadEnterDisable("TartarusPrison", "reload1", true);
	LocatorReloadEnterDisable("TartarusPrison", "reload2", true); // закрываем Тартарус изнутри
	LocatorReloadEnterDisable("LostShipsCity_town", "reload60", true);
	LocatorReloadEnterDisable("LostShipsCity_town", "reload61", true); // закрываем вход к Мэри
	pchar.quest.LSC_findMary.over = "yes"; //снять прерывание на Мэри
	int iRank = 18+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 60;
	for (i=1; i<=5; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("PantryGuard_"+i, "mush_ctz_7", "man", "mushketer", iRank, PIRATE, 0, true, "quest"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "bullet", iScl+50);
			sld.dialog.Filename = "Quest\LSC\OtherNPC.c";
			sld.dialog.currentnode = "PantryGuard";	
			sld.greeting = "HUNTER"; 
			ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto1");
		}
		else
		{	
			sld = GetCharacter(NPC_GenerateCharacter("PantryGuard_"+i, "citiz_4"+(i+3), "man", "man", iRank, PIRATE, 0, true, "quest"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_10", "pistol4", "bullet", iScl+50);
			LAi_CharacterDisableDialog(sld);
			ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto"+(i+1));
		}
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
	}
}

void LSC_GotoPrison(string qName)// в тюрьму на Тартарус
{
	DoFunctionReloadToLocation("TartarusPrison", "quest", "reload1", "LSC_TalkWithCapper");
	bDisableCharacterMenu = true;//лочим Ф2
	InterfaceStates.Buttons.Save.enable = false;//запретить сохраняться
	//обчистим карманы ГГ
	ref location = &Locations[FindLocation("SanAugustineResidence")];
	aref arItems, boxItems;
	ref rItem;
	string sName;
	makearef(arItems, PChar.items);
	makearef(boxItems, location.private1.items);
	int iItemsNum = GetAttributesNum(arItems);
	for(int i=0; i<iItemsNum; i++)
	{
		sName = GetAttributeName(GetAttributeN(arItems, i));
		rItem = ItemsFromID(sName);
		if (rItem.ItemType != "QUESTITEMS")
		{
			boxItems.(sName) = PChar.items.(sName);
		}
	}
	location.private1.money = sti(PChar.money);	
	location.private1 = Items_MakeTime(GetTime(), GetDataDay(), GetDataMonth(), GetDataYear());
	RemoveAllCharacterItems(PChar, true);
	RemoveItems(pchar, "letter_svenson", 1);
	AddQuestRecord("BaronReturn", "6");
	LSC_SetChimisetInJail();
	// кладем письмо в сундук
	ref rloc = &Locations[FindLocation("TartarusPrison")];
	rloc.private2.items.letter_chad = 1;
}

void LSC_TalkWithCapper()// разговор с Каппером - подготовка
{
	//ставим охранников-пиратов
	int iRank = 20+MOD_SKILL_ENEMY_RATE+2;
	int iScl = 60;
	for (i=1; i<=3; i++)
	{
		if (i == 3)
		{
			sld = GetCharacter(NPC_GenerateCharacter("ChadGuard_"+i, "mush_ctz_8", "man", "mushketer", iRank, PIRATE, -1, true, "quest"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "bullet", iScl+50);
			sld.dialog.Filename = "Quest\LSC\OtherNPC.c";
			sld.dialog.currentnode = "ChadGuard";	
			sld.greeting = "HUNTER"; 
			sld.MusketerDistance = 0;
			ChangeCharacterAddressGroup(sld, "Tartarusprison", "goto", "goto6");
		}
		else
		{	
			sld = GetCharacter(NPC_GenerateCharacter("ChadGuard_"+i, "citiz_4"+(i+6), "man", "man", iRank, PIRATE, -1, true, "quest"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_21", "pistol4", "bullet", iScl+50);
			sld.dialog.Filename = "Quest\LSC\OtherNPC.c";
			sld.dialog.currentnode = "ChadGuard";
			ChangeCharacterAddressGroup(sld, "Tartarusprison", "goto", "goto"+i);
		LAi_SetWarriorType(sld);
		LAi_warrior_SetStay(sld, true);
		LAi_warrior_DialogEnable(sld, true);
		LAi_SetCheckMinHP(sld, LAi_GetCharacterHP(sld)-1, true, "LSC_ChadGuardAttack_Fail");
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
	}
	}
	sld = characterFromId("Capper");
	sld.dialog.currentnode = "Chimiset";
	sld.cirassId = Items_FindItemIdx("cirass1");
	LAi_SetActorType(pchar);
	DoQuestFunctionDelay("LSC_TalkWithCapperGo", 2.0);
	GiveItem2Character(sld, "key_capper");
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	// двери к Мэри и Дональду Гринспи закрываем
	LocatorReloadEnterDisable("LostShipsCity_town", "reload60", true);
	LocatorReloadEnterDisable("LostShipsCity_town", "reload61", true);
	LocatorReloadEnterDisable("LostShipsCity_town", "reload48", true);
}

void LSC_TalkWithCapperGo(string qName)// разговор с Каппером - старт
{
	sld = characterFromId("Capper");
	LAi_ActorDialogNow(pchar, sld, "", -1);
}

void LSC_SetChimisetInJail()// Чимисет в клетке
{
	sld = characterFromId("Chimiset");
	sld.dialog.currentnode = "KillChad";
	LAi_SetStayTypeNoGroup(sld);
	ChangeCharacterAddressGroup(sld, "Tartarusprison", "quest", "prison1");
	LAi_SetCheckMinHP(sld, LAi_GetCharacterHP(sld)-1, true, "LSC_Chimiset_ActivateDialog");
	ref rItm = ItemsFromID("crowbar");
	rItm.shown = true;
	rItm.startLocation = "Tartarusprison";
	rItm.startLocator = "qitem";
}

void LSC_Fightfail_Final(string qName)// завалили колдуна
{
	sld = characterFromId("Capper");
	sld.dialog.currentnode = "Fightfail_Final";
}

void LSC_ChadGuardAttack(string qName)// драка с Чадом и охраной
{
	sld = CharacterFromID("ChadGuard_1");
	sld.dialog.currentnode = "ChadGuard_Attack";
	LAi_SetActorType(sld);
	LAi_ActorDialogNow(sld, pchar, "", -1);
}

void LSC_LetterChad_Find(string qName)// нашли письмо
{
	pchar.quest.LSC_TartarusExit1.win_condition.l1 = "locator";
	pchar.quest.LSC_TartarusExit1.win_condition.l1.location = "Tartarusprison";
	pchar.quest.LSC_TartarusExit1.win_condition.l1.locator_group = "reload";
	pchar.quest.LSC_TartarusExit1.win_condition.l1.locator = "reload1";
	pchar.quest.LSC_TartarusExit1.win_condition.l2 = "item";
	pchar.quest.LSC_TartarusExit1.win_condition.l2.item = "key_capper";
	pchar.quest.LSC_TartarusExit1.function = "LSC_TartarusExit1_Open";
	pchar.quest.LSC_TartarusExit2.win_condition.l1 = "locator";
	pchar.quest.LSC_TartarusExit2.win_condition.l1.location = "Tartarusprison";
	pchar.quest.LSC_TartarusExit2.win_condition.l1.locator_group = "reload";
	pchar.quest.LSC_TartarusExit2.win_condition.l1.locator = "reload2";
	pchar.quest.LSC_TartarusExit2.win_condition.l2 = "item";
	pchar.quest.LSC_TartarusExit2.win_condition.l2.item = "key_capper";
	pchar.quest.LSC_TartarusExit2.function = "LSC_TartarusExit2_Open";
	pchar.quest.LSC_TartarusExit.win_condition.l1 = "ExitFromLocation";
	pchar.quest.LSC_TartarusExit.win_condition.l1.location = "Tartarusprison";
	pchar.quest.LSC_TartarusExit.function = "LSC_TartarusExit";
	AddQuestRecord("SharkHunt", "5");
}

void LSC_TartarusExit1_Open(string qName)// открываем двери
{
	PlaySound("interface\key.wav");
	LocatorReloadEnterDisable("Tartarusprison", "reload1", false);
}

void LSC_TartarusExit2_Open(string qName)// открываем двери
{
	PlaySound("interface\key.wav");
	LocatorReloadEnterDisable("Tartarusprison", "reload2", false);
}

void LSC_TartarusExit(string qName)// Чимисета к себе на корабль
{
	sld = characterFromId("Chimiset");
	sld.dialog.currentnode = "Chimiset_1";
	ChangeCharacterAddressGroup(sld, "ProtectorFisher", "sit", "sit1");
	LAi_SetHuberType(sld);
	sld = characterFromId("Dodson");
	sld.dialog.currentnode = "Chad_die"; // ноду Акуле
	sld.quest.takeitems = "true"; // на возврат вещей
}

void LSC_EddyTalk(string qName)// Эдди к разговору
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Eddy");
	sld.dialog.currentnode = "Friend";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void LSC_CreateAdolfClone()// ставим клона Адольфа
{
	int iRank = 20+MOD_SKILL_ENEMY_RATE+5;
	int iScl = 50;
	sld = GetCharacter(NPC_GenerateCharacter("LSC_Adolf_Clon", "Adolf", "man", "man", iRank, PIRATE, -1, true, "quest"));
	sld.name = "Adolf";
	sld.lastname = "Barbier";
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_09", "pistol6", "bullet", iScl*2);
	sld.dialog.filename   = "Quest\LSC\Citizen\LSC_Adolf.c";
	sld.dialog.currentnode = "Adolf";
	sld.greeting = "marginal";
	sld.cirassId = Items_FindItemIdx("cirass1");
	LAi_RemoveLoginTime(sld);
	LAi_SetLoginTime(sld, 19.0, 23.0);
	LAi_SetSitType(sld);
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	GiveItem2Character(sld, "key_gun"); // ключ от сундука со штуцером
	GiveItem2Character(sld, "letter_chad"); //письмо
	ChangeItemDescribe("letter_chad", "itmdescr_letter_adolf");
	ChangeCharacterAddressGroup(sld, "SantaFlorentinaShipInside4", "sit", "sit1");
}

void LSC_AdolfLetter(string qName)// нашли письмо
{
	chrDisableReloadToLocation = false;//открыть локацию
	AddQuestRecord("SharkHunt", "16");
	// ставим прерывание на полночь
	SetFunctionTimerCondition("LSC_CyclopCheck", 0, 0, 1, false); 
}

void LSC_CyclopCheck(string qName)// проверяем, где находится ГГ в полночь
{
	if (pchar.location == "SantaFlorentinaShipInside4") LSC_SetMaryNCyclopInCabin();
	else
	{
		pchar.quest.LSC_CyclopWait.win_condition.l1 = "location";
		pchar.quest.LSC_CyclopWait.win_condition.l1.location = "SantaFlorentinaShipInside4";
		pchar.quest.LSC_CyclopWait.function = "LSC_MaryNCyclopWait";
		pchar.quest.LSC_CyclopWaitOver.win_condition.l1 = "HardHour";
		pchar.quest.LSC_CyclopWaitOver.win_condition.l1.hour = 3.00;
		pchar.quest.LSC_CyclopWaitOver.function = "LSC_MaryNCyclopWaitOver";
	}
}

void LSC_SetMaryNCyclopInCabin() // Мэри и Циклоп входят
{
	chrDisableReloadToLocation = true;//закрыть локацию
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 70;
	// Мэри
	sld = characterFromId("Mary");
	LAi_SetHP(sld, 280+iScl, 280+iScl); // усилим
	if (MOD_SKILL_ENEMY_RATE > 7) sld.MultiFighter = 1.5; // мультифайтер
	sld.cirassId = Items_FindItemIdx("cirass1");
	GiveItem2Character(sld, "letter_chad_1");
	sld.dialog.currentnode = "Cabin";
	sld.greeting = "mary_4";
	ChangeCharacterAddressGroup(sld, "SantaFlorentinaShipInside4", "reload", "reload1");
	LAi_SetActorType(sld);
	LAi_CharacterDisableDialog(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	// Марчелло
	sld = characterFromId("Marchello");
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_21", "pistol6", "bullet", iScl*2+70);
	sld.cirassId = Items_FindItemIdx("cirass1");
	sld.dialog.currentnode = "Cabin";
	if (MOD_SKILL_ENEMY_RATE > 7) sld.MultiFighter = 1.5; // мультифайтер
	ChangeCharacterAddressGroup(sld, "SantaFlorentinaShipInside4", "reload", "reload2");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void LSC_MaryNCyclopWait(string qName) // Мэри и Циклоп ждут
{
	pchar.quest.LSC_CyclopWaitOver.over = "yes"; //снять прерывание
	chrDisableReloadToLocation = true;//закрыть локацию
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 70;
	// Мэри
	sld = characterFromId("Mary");
	sld.greeting = "mary_4";
	LAi_SetHP(sld, 280+iScl, 280+iScl); // усилим
	if (MOD_SKILL_ENEMY_RATE > 7) sld.MultiFighter = 1.5; // мультифайтер
	sld.cirassId = Items_FindItemIdx("cirass1");
	GiveItem2Character(sld, "letter_chad_1");
	sld.dialog.currentnode = "Cabin";
	ChangeCharacterAddressGroup(sld, "SantaFlorentinaShipInside4", "barmen", "bar1");
	LAi_SetActorType(sld);
	LAi_CharacterDisableDialog(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	// Марчелло
	sld = characterFromId("Marchello");
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_21", "pistol6", "bullet", iScl*2+70);
	sld.cirassId = Items_FindItemIdx("cirass1");
	sld.dialog.currentnode = "Cabin_A";
	if (MOD_SKILL_ENEMY_RATE > 7) sld.MultiFighter = 1.5; // мультифайтер
	ChangeCharacterAddressGroup(sld, "SantaFlorentinaShipInside4", "goto", "goto6");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void LSC_MaryNCyclopWaitOver(string qName) // Мэри и Циклоп не дождались - тем хуже для геймера
{
	pchar.quest.LSC_CyclopWait.over = "yes"; //снять прерывание
	pchar.quest.LSC_CyclopAttack.win_condition.l1 = "location";
	pchar.quest.LSC_CyclopAttack.win_condition.l1.location = "LostShipsCity_town";
	pchar.quest.LSC_CyclopAttack.function = "LSC_MaryNCyclopAttack";
}

void LSC_MaryNCyclopAttack(string qName) // Мэри делает замануху на Эву
{
	pchar.questTemp.Saga.SharkHunt.TownAttack = "true";
	int iScl = 80;
	// Мэри
	sld = characterFromId("Mary");
	sld.greeting = "mary_2";
	LAi_SetHP(sld, 280+iScl, 280+iScl); // усилим
	if (MOD_SKILL_ENEMY_RATE > 7) sld.MultiFighter = 1.5; // мультифайтер
	sld.cirassId = Items_FindItemIdx("cirass1");
	GiveItem2Character(sld, "letter_chad_1");
	sld.dialog.currentnode = "Town";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "LostShipsCity_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void LSC_MaryLetter(string qName)// нашли письмо
{
	chrDisableReloadToLocation = false;//открыть локацию
	AddQuestRecord("SharkHunt", "18");
	AddQuestRecordInfo("Chad_Mary_letter", "1");
	pchar.questTemp.Saga.SharkHunt = "find"; //флаг - покушение предотвращено
	sld = characterFromId("Dodson");
	sld.dialog.currentnode = "Mary_Die"; //даем ноду Акуле
}

// ---------------------------------вариант прохождения N: гоп-стоп------------------------------------------

void LSC_TartarusEntrance1_Open(string qName)// открываем двери
{
	PlaySound("interface\key.wav");
	LocatorReloadEnterDisable("LostShipsCity_town", "reload51", false);
}

void LSC_TartarusEntrance2_Open(string qName)// открываем двери
{
	PlaySound("interface\key.wav");
	LocatorReloadEnterDisable("LostShipsCity_town", "reload52", false);
}

void LSC_GotoShark(string qName)// посланник Акулы
{
	sld = GetCharacter(NPC_GenerateCharacter("LSC_SharkCureer", "citiz_44", "man", "man", 20, PIRATE, -1, true, "soldier"));
	FantomMakeCoolFighter(sld, 20, 50, 50, "blade_10", "pistol6", "bullet", 100);
	sld.dialog.FileName = "Quest\LSC\OtherNPC.c";
	sld.dialog.currentnode = "SharkCureer";
	sld.greeting = "town_pirate";
	LAi_SetImmortal(sld, true);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	sld = characterFromId("Chimiset");
	sld.lifeday = 0; // убираем Чимисета
	// прячем Чада
	sld = characterFromId("Capper");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	// на его место ставим нового тюремщика
	sld = GetCharacter(NPC_GenerateCharacter("LSC_Prisonboss", "citiz_48", "man", "man", 30, PIRATE, -1, true, "soldier"));
	FantomMakeCoolFighter(sld, 30, 50, 50, "blade_16", "pistol4", "bullet", 200);
	sld.dialog.FileName = "Quest\LSC\OtherNPC.c";
	sld.dialog.currentnode = "Prisonboss";
	sld.greeting = "town_pirate";
	ChangeCharacterAddressGroup(sld, "TartarusPrison", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_LocationFightDisable(&Locations[FindLocation("TartarusPrison")], true);//запретить драться в Тартарусе
	// закрываем дверь к Эдди
	LocatorReloadEnterDisable("LostShipsCity_town", "reload33", true);
	// пускаем слухи
	AddSimpleRumourCityTip("Ходят слухи, что тюремщик адмирала, Чад Каппер, бесследно исчез. Может, Акула дал ему секретное задание?", "LostShipsCity", 2, 2, "LSC", "");
	AddSimpleRumourCityTip("Представляете, Чад Каппер, тюремщик, куда-то пропал, сразу после убийства колдуна ривадос. Странно, правда?", "LostShipsCity", 2, 2, "LSC", "");
	AddSimpleRumourCityTip("Слышали новость? Колдуна ривадос, старого Чимисета, зарубили в тюрьме в его клетке. Говорят, это сделали люди адмирала. Черный Эдди просто в ярости...", "LostShipsCity", 2, 2, "LSC", "");
	AddSimpleRumourCityTip("Убит колдун ривадос, Чимисет. Подозревают, как ни странно, не нарвалов, а людей Акулы. Ривадос очень злы на адмирала...", "LostShipsCity", 5, 2, "LSC", "");
	AddSimpleRumourCityTip("Тюрьма адмирала превращается в место убийств: сначала - Алан Милроу, теперь - Чимисет. Да, адмирал жестко расправляется со своими противниками.", "LostShipsCity", 5, 2, "LSC", "");
}

void LSC_MeetingSharkAugustine(string qName)// Акула в полночь на Сан-Августине - готовим Каролину
{
	sld = characterFromId("Dodson");
	sld.dialog.currentnode = "Caroline";
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "LostShipsCity_town", "goto", "goto11_2"); // найти локатор
	LAi_SetStayTypeNoGroup(sld);
	sld = characterFromId("Facio");
	ChangeCharacterAddressGroup(sld, "none", "", ""); // спрячем Фацио
	ref rloc = &Locations[FindLocation("CarolineBank")];
	rloc.private1.items.letter_chad_1 = 1;
	ChangeItemDescribe("letter_chad_1", "itmdescr_letter_facio");
	sld = ItemsFromID("key_facio");
	sld.shown = true;
	sld.startLocation = "CarolineBank";
	sld.startLocator = "key1"; //положим ключ на стол
	// если ГГ не явится
	pchar.quest.LSC_MeetingAugustineOver.win_condition.l1 = "Timer";
	pchar.quest.LSC_MeetingAugustineOver.win_condition.l1.date.hour  = 1.00;
	pchar.quest.LSC_MeetingAugustineOver.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 0);
	pchar.quest.LSC_MeetingAugustineOver.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 0);
	pchar.quest.LSC_MeetingAugustineOver.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 0);
	pchar.quest.LSC_MeetingAugustineOver.function = "LSC_MeetingAugustineOver";
}

void LSC_MeetingAugustineOver(string qName)// не пришли к Акуле
{
	sld = characterFromId("Dodson");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload25", "none", "", "", "LSC_SharkDie", -1);
}

void LSC_CarolineEnter(string qName)// входим в Каролину
{
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.quest.LSC_MeetingAugustineOver.over = "yes"; //снять прерывание
	LocatorReloadEnterDisable("LostShipsCity_town", "reload25", true);
	sld = characterFromId("Dodson");
	sld.dialog.currentnode = "caroline_2";
	LAi_SetActorType(sld);
	LAi_SetActorType(pchar);
	LAi_ActorFollow(pchar, sld, "ActorDialog_Any2Pchar", -1);
	LAi_ActorTurnToCharacter(sld, pchar);
	SetActorDialogAny2Pchar(sld.id, "", 0.0, 0.0);
}

void LSC_FacioReturn(string qName)// вертаем Фацио
{
	sld = characterFromId("Facio");
	sld.dialog.currentnode = "First time";
	ChangeCharacterAddressGroup(sld, "CarolineBank", "sit", "sit1");
	LAi_SetSitType(sld);
	LAi_group_MoveCharacter(sld, "LSC_CITIZEN");
	ref location = &Locations[FindLocation("CarolineBank")];
	location.private1.key = "key3"; // запираем сундук
}

void LSC_FindLetterFacio(string qName)// нашли письмо Фацио
{
	sld = characterFromId("Grinspy");
	sld.dialog.currentnode = "shark"; // ноду Дональду Гринспи
	AddQuestRecord("SharkHunt", "25");
	AddQuestRecordInfo("Letter_Facio", "1");
}

// ---------------------------------вариант прохождения M: Мэри------------------------------------------
void LSC_FindMary(string qName)// ГГ круто повезло - он нашел Мэри!
{
	pchar.questTemp.LSC = "mary";
	LocatorReloadEnterDisable("CeresSmithy", "reload6", true);
	LocatorReloadEnterDisable("CeresSmithy", "reload7", true); // закрываем выходы
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], false);//разрешить драться
	LocatorReloadEnterDisable("LostShipsCity_town", "reload2", true); //закрываем кладовку со стороны моря
	pchar.quest.LSC_entry_pantry.over = "yes"; //снять прерывание на арест
	// устанавливаем врагов
	for (i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("EnemyMary_"+i, "citiz_58", "man", "man", 5, PIRATE, -1, true, "soldier"));
		LAi_SetHP(sld, 300, 300); 
		SetSelfSkill(sld, 60, 60, 60, 50, 60);
		SetRandSPECIAL(sld);
		SetCharacterPerk(sld, "BasicDefense");
		SetCharacterPerk(sld, "AdvancedDefense");
		SetCharacterPerk(sld, "CriticalHit");
		SetCharacterPerk(sld, "SwordplayProfessional");
		GiveItem2Character(sld, "blade_10");
		sld.equip.blade = "blade_10";
		GiveItem2Character(sld, "pistol1");
		EquipCharacterbyItem(sld, "pistol1");
		GiveItem2Character(sld, "cirass1");
		EquipCharacterbyItem(sld, "cirass1");
		LAi_SetCharacterUseBullet(sld, "bullet");
		TakeNItems(sld, "bullet", 50);
		AddItems(sld, "gunpowder", 50);
		TakeNItems(sld, "potion2", 3);
		LAi_SetWarriorType(sld);
		LAi_CharacterDisableDialog(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
		ChangeCharacterAddressGroup(sld, "CeresSmithy", "barmen", "bar"+i);
	}
	// Мэри в отдельную группу
	sld = characterFromId("Mary");
	sld.greeting = "mary_1";
	GiveItem2Character(sld, "letter_chad_1");
	LAi_group_Register("TMP_FRIEND"); // спецгруппа
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "Tmp_friend");
	// установим отношения
	LAi_group_SetRelation("EnemyFight", "Tmp_friend", LAI_GROUP_ENEMY);
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_SetRelation("Tmp_friend", LAI_GROUP_PLAYER, LAI_GROUP_FRIEND);
	LAi_group_FightGroups("EnemyFight", "Tmp_friend", true);
	LAi_group_SetCheck("EnemyFight", "LSC_EnemiesMaryDie");
}

void LSC_DieMaryletter(string qName) //Мэри убита - нашли письмо на ней, но лучше переиграть, Элен ее не стоит))
{
	LocatorReloadEnterDisable("CeresSmithy", "reload6", false);
	LocatorReloadEnterDisable("CeresSmithy", "reload7", false); // открываем выходы
	AddQuestRecord("SharkHunt", "30");
	AddQuestRecordInfo("Chad_Mary_letter", "2");
}

void LSC_AxelReturnStore(string qName) // вертаем Акселя на место
{
	sld = characterFromId("Axel");
	LAi_SetOwnerType(sld);
	ChangeCharacterAddressGroup(sld, "EsmeraldaStoreBig", "barmen", "stay");
	LAi_group_MoveCharacter(sld, "LSC_NARVAL");
}

void LSC_WhiskeyPoison_exit(string qName) // вышли на улицы - запускаем таймер
{
	DoQuestFunctionDelay("LSC_WhiskeyPoisonAlready", 15.0);
}

void LSC_WhiskeyPoisonAlready(string qName) // виски отравлен
{
	log_testinfo("Если вы сейчас не на 'Эве' - то Чад успел отравить виски");
	pchar.questTemp.LSC.Whiskey_poison = "true";
}

void LSC_WhiskeyPoison_SF(string qName) // на Санта-Флорентину - наиболее ожидаемый вариант
{
	pchar.questTemp.LSC.Attack = true; // обработка в АИ
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.questTemp.LSC.Florentina = "true"; // был на Флорентине
	sld = CharacterFromID("LSC_Adolf");
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "SantaFlorentinaShipInside4", "goto", "goto2");
	sld.SaveItemsForDead = true; 
	sld.DontClearDead = true;
	LAi_SetImmortal(sld, false);
	RemoveAllCharacterItems(sld, true);
	GiveItem2Character(sld, "key_gun"); // ключ от сундука со штуцером
	DoQuestFunctionDelay("LSC_KillAdolf_SF", 2.0); // убить Адольфа
	// ставим толстого нарвала
	int iRank = 22+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 80;
	sld = GetCharacter(NPC_GenerateCharacter("LSC_AdolfKiller", "citiz_58", "man", "man", iRank, PIRATE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_13", "pistol4", "bullet", iScl*2);
	sld.cirassId = Items_FindItemIdx("cirass1");
	if (MOD_SKILL_ENEMY_RATE > 7) sld.MultiFighter = 1.5; // мультифайтер
	LAi_SetWarriorType(sld);
	LAi_warrior_SetStay(sld, true);
	LAi_warrior_DialogEnable(sld, false);
	ChangeCharacterAddressGroup(sld, "SantaFlorentinaShipInside4", "goto", "goto2");
	GiveItem2Character(sld, "letter_chad");
	ChangeItemDescribe("letter_chad", "itmdescr_letter_adolf_1");
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
}

void LSC_KillAdolf_SF(string qName) // убить Адольфа
{
	sld = CharacterFromID("LSC_Adolf");
	LAi_KillCharacter(sld);
}

void LSC_letterAdolf_SF(string qName) // нашли письмо на нарвале
{
	chrDisableReloadToLocation = false;//открыть локацию
	AddQuestRecord("SharkHunt", "38");
	if (!CheckAttribute(pchar, "questTemp.LSC.Dodson_poison") && !CheckAttribute(pchar, "questTemp.LSC.Dodson_warning")) // не было разговора и не предупрежден
	{
		sld = CharacterFromID("Dodson");
		sld.dialog.currentnode = "poison";
		LAi_SetGroundSitTypeNoGroup(sld);
		ChangeCharacterAddressGroup(sld, "SanAugustineResidence", "goto", "goto10"); // Акула отравился
	}
}

void LSC_WhiskeyPoison_AE(string qName) // на Эве
{
	pchar.quest.LSC_Whiskeypoison_SF.over = "yes"; //снять прерывание на Флорентину, если осталось
	pchar.questTemp.LSC.Attack = true; // обработка в АИ
	chrDisableReloadToLocation = true;//закрыть локацию
	LocatorReloadEnterDisable("LostShipsCity_town", "reload20", false);
	LocatorReloadEnterDisable("LostShipsCity_town", "reload24", false);// открываем вход к Фацио
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 60;
	// ставим Чада
	sld = CharacterFromID("Capper");
	sld.dialog.currentnode = "Aeva_attack";
	sld.cirassId = Items_FindItemIdx("cirass1");
	LAi_SetActorType(sld);
	GiveItem2Character(sld, "rat_poison"); // мышьяк
	GiveItem2Character(sld, "key_capper"); // ключ от Тартаруса
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true; 
	ChangeCharacterAddressGroup(sld, "AvaShipInside3", "quest", "quest4");
	// нарвалы
	for (i=1; i<=3; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("ChadNarval_"+i, "citiz_5"+(i+3), "man", "man", iRank, PIRATE, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_19", "pistol4", "bullet", iScl*2);
		sld.cirassId = Items_FindItemIdx("cirass1");
		LAi_SetActorType(sld);
		LAi_CharacterDisableDialog(sld);
		ChangeCharacterAddressGroup(sld, "AvaShipInside3", "quest", "quest"+i);
	}
	if (!CheckAttribute(pchar, "questTemp.LSC.Whiskey_poison")) // виски не успели отравить
	{
		// ставим Фацио
		pchar.questTemp.LSC.Whiskey_clear = "true";
		sld = CharacterFromID("Facio");
		sld.dialog.currentnode = "whiskey";
		sld.greeting = "facio_2";
		sld.quest.poisonnode = 2;
		LAi_SetStayType(sld);
		LAi_SetImmortal(sld, true);
		ChangeCharacterAddressGroup(sld, "AvaShipInside3", "quest", "quest5");
		sld = CharacterFromID("Capper");
		GiveItem2Character(sld, "cask_whisky"); // бочонок чистого виски
		sld.dialog.currentnode = "Aeva_attack_2";
	}
	else
	{
		if (!CheckAttribute(pchar, "questTemp.LSC.Dodson_poison")  && !CheckAttribute(pchar, "questTemp.LSC.Dodson_warning")) // не было разговора
		{
			sld = CharacterFromID("Dodson");
			sld.dialog.currentnode = "poison";
			ChangeCharacterAddressGroup(sld, "SanAugustineResidence", "goto", "goto10"); // Акула отравился
			LAi_SetGroundSitTypeNoGroup(sld);
		}
	}
}

void LSC_SetCyclop_Fl(string qName) // Циклопа на Флерон - вар. если не уберег Мэри
{
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 70;
	pchar.questTemp.LSC.Attack = true; // обработка в АИ
	sld = characterFromId("Marchello");
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_21", "pistol4", "bullet", iScl+50);
	sld.cirassId = Items_FindItemIdx("cirass1");
	if (MOD_SKILL_ENEMY_RATE > 7) sld.MultiFighter = 1.8; // мультифайтер
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "FleuronTavern", "rld", "stay2");
}

void LSC_CheckEnemyDistance() // расчет дистанции до локатора с НПС на Флорентине, Эве, Флероне и Диффиндуре
{
	float fdist;
	if (pchar.location == "SantaFlorentinaShipInside4")
	{
		if (GetCharacterDistByLoc(pchar, "goto", "goto2", &fdist))
		{
			if (fdist < 5.0) LSC_SF_NarvalAttack();
		}
	}
	if (pchar.location == "AvaShipInside3")
	{
		if (GetCharacterDistByLoc(pchar, "quest", "quest3", &fdist))
		{
			if (fdist < 7.0) LSC_Aeva_CapperGo();
		}
	}
	if (pchar.location == "FleuronTavern")
	{
		if (GetCharacterDistByLoc(pchar, "rld", "stay2", &fdist))
		{
			if (fdist < 3.0) LSC_Fleuron_CyclorAttack();
		}
	}
	if (pchar.location == "FernandaDiffIndoor")
	{
		if (GetCharacterDistByLoc(pchar, "goto", "goto1", &fdist))
		{
			if (fdist < 5.0) LSC_NatanielSeeDaniel();
		}
	}
}

void LSC_SF_NarvalAttack() // атакует нарвал у трупа Адольфа
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], false);//разрешить драться
	DeleteAttribute(pchar, "questTemp.LSC.Attack");
	sld = CharacterFromID("LSC_AdolfKiller");
	LAi_group_MoveCharacter(sld, "EnemyFight");
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "LSC_AdolfKillerDie");
}

void LSC_Aeva_CapperGo() // старт разговора Каппера - итог - бой
{
	DeleteAttribute(pchar, "questTemp.LSC.Attack");
	sld = CharacterFromID("Capper");
	LAi_SetActorType(sld);
	LAi_ActorDialogNow(sld, pchar, "", -1);
}

void LSC_Fleuron_CyclorAttack() // Циклоп атакует
{
	DeleteAttribute(pchar, "questTemp.LSC.Attack");
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], false);//разрешить драться
	sld = CharacterFromID("Marchello");
	if (MOD_SKILL_ENEMY_RATE > 7) sld.MultiFighter = 1.5; // мультифайтер
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "LSC_CyclopDie_Fl");
}

void LSC_RescueMary(string qName) // бежим на помощь Мэри
{
	pchar.questTemp.LSC.RescueMary = "true";
	pchar.questTemp.NoFast = true; // запрет ускорения
	SetShowTimer(100.0); // не так уж и много - поспешим!
	DoQuestFunctionDelay("LSC_SetAlarmMusic", 1.0);
	chrDisableReloadToLocation = true; // закрыть локацию
	InterfaceStates.Buttons.Save.enable = false; //запретить сохраняться
	bDisableFastReload = true;//на всяк случай продублирую
	pchar.GenQuest.CannotWait = true;//и это тоже
	pchar.quest.LSC_runtoMary.win_condition.l1 = "locator";
	pchar.quest.LSC_runtoMary.win_condition.l1.location = "LostShipsCity_town";
	pchar.quest.LSC_runtoMary.win_condition.l1.locator_group = "reload";
	pchar.quest.LSC_runtoMary.win_condition.l1.locator = "reload60";
	pchar.quest.LSC_runtoMary.function = "LSC_enterMaryCabin";
}

void LSC_SetAlarmMusic(string qName) // бежим по городу, не путаемся в фалдах камзола и не спотыкаемся :)
{
	SetMusic("music_teleport");
	log_info("Red Mary is in danger. You have only 100 seconds to find and help her!");
	PlaySound("interface\notebook.wav");
}

void LSC_enterMaryCabin(string qName) // входим в каюту к Мэри
{
	DoQuestReloadToLocation("CeresSmithy", "reload", "reload6", "LSC_CyclopInMaryCabin");
}

void LSC_RescueMaryFail() // опоздал к Мэри... лучше переигрывай!
{
	AddQuestRecord("SharkHunt", "49");
	pchar.questTemp.LSC.FailMary = "true";
}

void LSC_ContinueAfterMaryCabin() // завершающая функция
{
	pchar.questTemp.Saga.SharkHunt = "whiskey_final"; // меняем флаг
	InterfaceStates.Buttons.Save.enable = true; //разрешить сохраняться
	chrDisableReloadToLocation = false;//открыть локацию
	if (!CheckAttribute(pchar, "questTemp.LSC.Whiskey_clear")) // если виски был отравлен
	{
		pchar.quest.LSC_WhiskeyStoryFinal.win_condition.l1 = "location";
		pchar.quest.LSC_WhiskeyStoryFinal.win_condition.l1.location = "LostShipsCity_town";
		pchar.quest.LSC_WhiskeyStoryFinal.function = "LSC_WhiskeyStoryFinal"; // адмирал зовет
	}
	// вместо Чада ставим нового тюремщика
	sld = GetCharacter(NPC_GenerateCharacter("LSC_Prisonboss", "citiz_48", "man", "man", 30, PIRATE, -1, true, "soldier"));
	FantomMakeCoolFighter(sld, 30, 50, 50, "blade_16", "pistol4", "bullet", 200);
	sld.dialog.FileName = "Quest\LSC\OtherNPC.c";
	sld.dialog.currentnode = "Prisonboss_M";
	sld.greeting = "town_pirate";
	ChangeCharacterAddressGroup(sld, "TartarusPrison", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_LocationFightDisable(&Locations[FindLocation("TartarusPrison")], true);//запретить драться в Тартарусе
	LSC_OpenTartarusDoors();// открыть наружные двери Тартаруса
	sld = CharacterFromID("Facio");
	sld.dialog.currentnode = "First time";
	sld.greeting = "facio_1";
}

// --> штучки с Мэри
void LSC_MaryLove() // провести ночь с Мэри в LSC
{
	pchar.GenQuest.FrameLockEsc = true;
	LSC_MaryLoveWaitTime();
	SetMusic("music_romantic");
	SetLaunchFrameFormParam("", "", 0, 28);
	SetLaunchFrameFormPic("loading\inside\censored1.tga");
	PlayStereoSound("sex\sex"+(rand(9)+1)+".wav");
    LaunchFrameForm();
	AddCharacterHealth(pchar, 12); // Мэри восстанавливает здоровье лучше всех и без бальзама
	LAi_SetCurHPMax(pchar);
	DoQuestFunctionDelay("LSC_MaryLoveMorning", 28.0);
}

void LSC_MaryEveneng() // провести вечер+ночь с Мэри в LSC
{
	pchar.GenQuest.FrameLockEsc = true;
	SetMusic("music_romantic");
	sld = characterFromId("Mary");
	ChangeCharacterAddressGroup(sld, "CeresSmithy", "sit", "sit3");
	LAi_SetSitType(sld);
	ChangeCharacterAddressGroup(pchar, "CeresSmithy", "sit", "sit4");
	LAi_SetSitType(pchar);
	DoQuestFunctionDelay("LSC_MaryLoveStart", 14.0);
}

void LSC_MaryLoveStart(string qName) // к функции выше
{
	sld = characterFromId("Mary");
	LAi_SetOwnerType(sld);
	LAi_SetPlayerType(pchar);
	ChangeCharacterAddressGroup(sld, "CeresSmithy", "goto", "goto11");
	ChangeCharacterAddressGroup(pchar, "CeresSmithy", "goto", "goto10"); // на обрыв эскейпом
	LSC_MaryLoveWaitTime();
	SetLaunchFrameFormParam("", "", 0, 14);
	SetLaunchFrameFormPic("loading\inside\censored1.tga");
	PlayStereoSound("sex\sex"+(rand(9)+1)+".wav");
    LaunchFrameForm();
	AddCharacterHealth(pchar, 12); // Мэри восстанавливает здоровье лучше всех и без бальзама
	LAi_SetCurHPMax(pchar);
	DoQuestFunctionDelay("LSC_MaryLoveMorning", 14.0);
}

void LSC_MaryTavern(string qName) // посидеть в таверне с Мэри в LSC
{
	SetMusic("spa_music_tavern");
	AddMoneyToCharacter(pchar, -500);
	DoQuestCheckDelay("LSC_MaryTavernReturn", 32.5);
}

void LSC_MaryLoveWaitTime() // перемотка времени
{
	int iTime, iAddTime;
	iTime = sti(environment.time);
	if (iTime >= 21) iAddTime = 24 - iTime + 7;
	if (iTime < 7) iAddTime = 7 - iTime;
	if (iTime >= 7 && iTime < 21) iAddTime = 24  + 7 - iTime;
	StoreDayUpdate();
	WaitDate("",0,0,0,iAddtime,5);
	RecalculateJumpTable();
	RefreshWeather();
	RefreshLandTime();
}

void LSC_MaryLoveMorning(string qName) // завершение функций выше
{
	sld = characterFromId("Mary");
	sld.dialog.currentnode = "LSC_love_morning";
	ChangeCharacterAddressGroup(sld, "CeresSmithy", "goto", "goto11");
	ChangeCharacterAddressGroup(pchar, "CeresSmithy", "goto", "goto10");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}
	// --> палаш 'Нарвал' для Мэри
void LSC_NarvalFerrum(string qName) // нашли гигантский кусок метеорита
{
	AddQuestRecord("LSC", "20");
	AddCharacterExpToSkill(pchar, "Fortune", 100);//везение
}	
	
void LSC_NarvalBladeForMary(string qName) // палаш готов
{
	sld = characterFromId("Mary");
	sld.quest.narval_blade = "true";
	sld = characterFromId("Schmidt");
	sld.quest.narval_blade = "ready";
	sld.dialog.currentnode = "Jurgen";
	log_testinfo("Палаш готов!");
}

void LSC_GotoPresentMary(string qName) // идем к Юргену
{
	LocatorReloadEnterDisable("CeresSmithy", "reload5", false);
	LocatorReloadEnterDisable("CeresSmithy", "reload6", false);
	LAi_SetActorType(pchar);
	sld = characterFromId("Mary");
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "LostShipsCity_town", "reload", "reload62");
	LAi_ActorGoToLocator(sld, "reload", "reload65", "LSC_EnterPresentMary", -1);
	LAi_ActorFollow(pchar, sld, "", -1);
}
// <-- штучки с Мэри

void LSC_SetDexterAdmiral(string qName) // Декстера - в адмиралы
{
	sld = characterFromId("Dexter");
	sld.dialog.currentnode = "admiral_7";
	ChangeCharacterAddressGroup(sld, "SanAugustineResidence", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "LSC_SHARK");
}

void LSC_WhiskeyStoryFinal(string qName) // посланник от адмирала
{
	sld = GetCharacter(NPC_GenerateCharacter("LSC_SharkCureer", "citiz_44", "man", "man", 20, PIRATE, -1, true, "soldier"));
	FantomMakeCoolFighter(sld, 20, 50, 50, "blade_10", "pistol6", "bullet", 100);
	sld.dialog.FileName = "Quest\LSC\OtherNPC.c";
	sld.dialog.currentnode = "SharkCureer_3";
	sld.greeting = "town_pirate";
	LAi_SetImmortal(sld, true);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "LostShipsCity_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	if (!CheckAttribute(pchar, "questTemp.Saga.DodsonDie"))
	{
		sld = characterFromId("Dodson");
		sld.dialog.currentnode = "whyskey_final";
		LAi_SetHuberType(sld);
		ChangeCharacterAddressGroup(sld, "SanAugustineResidence", "sit", "sit1");
		LAi_CharacterEnableDialog(sld);
		sld = characterFromId("Dexter");
		sld.dialog.currentnode = "plan";
		LAi_SetHuberType(sld);
		ChangeCharacterAddressGroup(sld, "SanAugustineResidence", "sit", "sit4");
		LAi_CharacterDisableDialog(sld);
	}
}

void LSC_WhiskeyStoryFinal_1(string qName) // к адмиралу
{
	sld = characterFromId("Dodson");
	sld.dialog.currentnode = "whyskey_final";
	LAi_SetHuberType(sld);
	ChangeCharacterAddressGroup(sld, "SanAugustineResidence", "sit", "sit1");
	LAi_CharacterEnableDialog(sld);
	sld = characterFromId("Dexter");
	sld.dialog.currentnode = "plan";
	LAi_SetHuberType(sld);
	ChangeCharacterAddressGroup(sld, "SanAugustineResidence", "sit", "sit4");
	LAi_CharacterDisableDialog(sld);
}

//-------------------------------------общая для всех вариантов часть----------------------------------------

void LSC_SetWhiteBoy()// ставим Оле
{
	sld = characterFromId("Ole");
	sld.dialog.currentnode = "store";
	ChangeCharacterAddressGroup(sld, "EsmeraldaStoreBig", "goto", "goto1");
	LAi_SetStayTypeNoGroup(sld);
	LAi_SetLoginTime(sld, 10.0, 17.0);
}

void LSC_PrepareUnderwater_Check(string qName)// ремонт водолазного костюма - проверка
{
	log_Testinfo("Костюм починен!");
	pchar.questTemp.LSC = "underwater_check";
}

void LSC_PrepareUnderwater(string qName)// готовы к первому погружению
{
	log_Testinfo("К погружению готовы!");
	pchar.questTemp.LSC = "underwater_prepare";
}

void LSC_takeUnderwater(string qName)// выдача скафандра
{
	GiveItem2Character(pchar, "underwater"); 
	PlaySound("interface\notebook.wav");
	Log_Info("You have received a diving suit");
}

void LSC_underwaterDeathTimer(string qName) // время нахождения под водой истекло
{
	GameOver("land");
}

void LSC_FindUnderwaterDolly(string qName) // нашли статую
{
	pchar.questTemp.LSC.FindDolly = "true";
	pchar.questTemp.Saga.BaronReturn = "second_teleport";
	ref rLoc = &Locations[FindLocation("underwater")];
	if (CheckAttribute(rLoc, "canteleport"))
	{
		AddQuestRecord("LSC", "12");
		if (CheckAttribute(pchar, "questTemp.LSC.MaryBye")) AddQuestUserData("LSC", "sText", "Wait! I should talk to Mary before leaving the Island. She won't forgive me if I dissappear without warning her."); 
	}
	else
	{
		AddQuestRecord("LSC", "13");
		if (CheckAttribute(pchar, "questTemp.LSC.MaryBye")) AddQuestUserData("LSC", "sText", "But I should talk to Mary before leaving the Island. She won't forgive me if I dissappear without warning her."); 
	}
	AddCharacterExpToSkill(pchar, "Fortune", 100);//везение
}

void LSC_ReadyUnderwater(string qName)// готовы к погружениям
{
	log_Testinfo("К погружению готовы!");
	pchar.questTemp.LSC.UW_ready = "true";
}

// --> борьба с дикими геймерами
void LSC_GameOverPrison(string qName) 
{
	DoQuestCheckDelay("hide_weapon", 0.5);//убрать оружие
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	sld = characterFromId("Dexter");
	sld.dialog.currentnode = "LSC_GameOverPrison";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "LostShipsCity_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetImmortal(sld, true);
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	for (i=1; i<=5; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("DexterGuard_"+i, "mush_ctz_7", "man", "mushketer", 40, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, 40, 100, 100, "", "mushket1", "bullet", 200);
		LAi_CharacterDisableDialog(sld);
		GetCharacterPos(pchar, &locx, &locy, &locz);
		ChangeCharacterAddressGroup(sld, "LostShipsCity_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
		LAi_SetImmortal(sld, true);
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}
// <-- борьба с дикими геймерами

// -------------------------------------------- мини-квесты LSC --------------------------------------------
// --> пей до дна
void LSC_DrinkOver(string qName) // просрочил
{
	sld = characterFromId("LSC_Leonard");
	sld.dialog.currentnode = "First time";
	AddQuestRecord("LSC_Drink", "7");
	CloseQuestHeader("LSC_Drink");
	DeleteAttribute(pchar, "questTemp.LSC.Drink");
}

void LSC_DrinkDelete(string qName) // подчистка квеста
{
	log_Testinfo("Зачищаем квест");
	sld = characterFromId("Facio");
	sld.dialog.currentnode = "First time";
	ChangeCharacterAddressGroup(sld, "CarolineBank", "sit", "sit1");
	LAi_SetSitType(sld);
	LAi_group_MoveCharacter(sld, "LSC_CITIZEN");
	sld = characterFromId("LSC_Leonard");
	sld.dialog.currentnode = "First time";
	ChangeCharacterAddressGroup(sld, "FleuronTavern", "sit", "sit5");
	LAi_SetSitType(sld);
	LAi_group_MoveCharacter(sld, "LSC_CITIZEN");
	DeleteAttribute(pchar, "questTemp.LSC.Drink");
	if (CheckAttribute(pchar, "GenQuest.CamShuttle")) DeleteAttribute(pchar, "GenQuest.CamShuttle");
	CloseQuestHeader("LSC_Drink");
}

void LSC_DrinkPrepare(string qName) // подготовка Фацио и Леонарда
{
	sld = characterFromId("Facio");
	sld.dialog.currentnode = "drink_8";
	ChangeCharacterAddressGroup(sld, "FleuronTavern", "goto", "goto1");
	LAi_SetStayTypeNoGroup(sld);
	sld = characterFromId("LSC_Leonard");
	ChangeCharacterAddressGroup(sld, "FleuronTavern", "goto", "goto2");
	LAi_SetStayTypeNoGroup(sld);
	sld = ItemsFromID("potionrum");
	sld.shown = true;
	sld.startLocation = "FleuronTavern";
	sld.startLocator = "bottle";
}

void LSC_DrinkGo(string qName) // бухалово
{
	InterfaceStates.Buttons.Save.enable = false;
	bDisableCharacterMenu = true;//лоченые интерфейсы
	SetMusic("spa_music_tavern");
	locCameraRotateAroundHero(0.0, 2.0, 0.0, 0.005, 0.0, 2.0, 0.0, 1700);
	DoQuestFunctionDelay("LSC_DrinkResult", 32.5);
	if(!IsEquipCharacterByArtefact(pchar, "totem_01"))
	{
		if (sti(pchar.questTemp.LSC.Drink.Chance) > 80) pchar.questTemp.LSC.Drink.Result = 1;
		else pchar.questTemp.LSC.Drink.Result = 2;
	}
	else pchar.questTemp.LSC.Drink.Result = 0;
}

void LSC_DrinkResult(string qName) // итоги
{
	locCameraResetState();
	InterfaceStates.Buttons.Save.enable = true;
	bDisableCharacterMenu = false;//лоченые интерфейсы
	ref chr = characterFromId("LSC_Leonard");
	LAi_SetActorType(chr);
	LAi_Fade("", "");
	switch (sti(pchar.questTemp.LSC.Drink.Result))
	{
		case 0: // тотем помог
			sld = characterFromId("Facio");
			LAi_SetActorType(sld);
			LAi_ActorSetSitMode(sld);
			LAi_ActorAnimation(sld, "Sit_Death", "OpenTheDoors", 2.7);
			chr.dialog.currentnode = "result_0";
			pchar.GenQuest.CamShuttle = 1;
		break;
		
		case 1: // обыграл, но нажрался
			sld = characterFromId("Facio");
			LAi_SetActorType(sld);
			LAi_ActorSetSitMode(sld);
			LAi_ActorAnimation(sld, "Sit_Death", "OpenTheDoors", 2.7);
			chr.dialog.currentnode = "result_1";
			pchar.GenQuest.CamShuttle = 3;
		break;
		
		case 2: // ужрался
			LAi_SetActorType(pchar);
			LAi_ActorSetSitMode(pchar);
			LAi_ActorAnimation(pchar, "Sit_Death", "OpenTheDoors", 2.7);
			chr.dialog.currentnode = "result_2";
			pchar.GenQuest.CamShuttle = 4;
		break;
	}
	DoQuestFunctionDelay("LSC_DrinkResult_1", 2.7);
	pchar.questTemp.LSC.Drink = "result";
	WaitDate("",0,0,0,3,5);
}

void LSC_DrinkResult_1(string qName) // итоги-1
{
	LAi_SetPlayerType(pchar);
	ref chr = characterFromId("Carpentero");
	sld = characterFromId("Facio");
	if (sti(pchar.questTemp.LSC.Drink.Result) < 2)
	{
		LAi_SetLayType(sld);
		ChangeCharacterAddressGroup(sld, "FleuronTavern", "quest", "lay1");
		sld.dialog.currentnode = "drunk";
		chr.quest.drink = "win";
		Achievment_SetStat(pchar, 70, 1); // ugeen 2016
	}
	else
	{
		sld.dialog.currentnode = "First time";
		ChangeCharacterAddressGroup(sld, "CarolineBank", "sit", "sit1");
		LAi_SetSitType(sld);
		LAi_group_MoveCharacter(sld, "LSC_CITIZEN");
		chr.quest.drink = "fail";
	}
	sld = ItemsFromID("potionrum");
	sld.shown = false;
	DoQuestReloadToLocation("FleuronTavern", "goto", "goto1", "LSC_DrinkLeonardTalk");
}

void LSC_DrinkClearChest()
{

}
// <-- пей до дна

// --> тайна Санта-Люсии
void LSC_RingOver(string qName) // чистка квеста
{
	sld = characterFromId("LSC_Rishard");
	sld.dialog.currentnode = "First time";
	ChangeCharacterAddressGroup(sld, "FleuronTavern", "sit", "sit2");
	LAi_SetSitType(sld);
	LAi_group_MoveCharacter(sld, "LSC_CITIZEN");
	if (!CheckAttribute(sld, "quest.ring_final")) AddQuestRecord("LSC_Ring", "2");
	CloseQuestHeader("LSC_Ring");
}

void LSC_RingStart(string qName) // готовы
{
	sld = characterFromId("LSC_Rishard");
	sld.dialog.currentnode = "ring_10";
	LAi_RemoveLoginTime(sld);
	ChangeCharacterAddressGroup(sld, "LostShipsCity_town", "quest", "ring");
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, "TMP_FRIEND");
}

void LSC_RingEnter(string qName) // входим
{
	pchar.quest.LSC_Ring_Over.over = "yes"; //снять прерывание
	SetLaunchFrameFormParam("An hour passed..."+ NewStr() +"You have reached the shipwreck", "", 0, 6);//табличка
	LaunchFrameForm();
	WaitDate("", 0, 0, 0, 1, 10); //крутим время
	RecalculateJumpTable();
	DoQuestFunctionDelay("LSC_RingReload", 5.5);
}

void LSC_RingReload(string qName) // телепорт
{
	DoQuestReloadToLocation("ExternalRingInside", "reload", "reload1", "LSC_RingEnterInside");
}

void LSC_RingRishardTalk(string node) // говорилка Ришарда
{
	sld = characterFromId("LSC_Rishard");
	sld.dialog.currentnode = node;
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void LSC_RingSetItems() // раскладка итемзов
{
	for (i=1; i<=3; i++)
	{
		sld = ItemsFromID("purse"+i);
		sld.shown = true;
		sld.startLocation = "ExternalRingInside";
		sld.startLocator = "item"+i;
	}
}

void LSC_RingDeleteItemsBoxes(string qName)
{
	ref loc;
	aref arBox;
	string sName;
	for(int i=0; i<MAX_LOCATIONS; i++)
	{				
		loc = &locations[i];
		if (loc.id == "ExternalRingDeck" || loc.id == "ExternalRingInside" || loc.id == "ExternalRingCabin1")
		{	
			for(int n=1; n<=MAX_HANDLED_BOXES; n++)
			{
				sName = "private" + n;
				if (CheckAttribute(loc, sName))
				{					
					makearef(arBox, loc.(sName));
					DeleteAttribute(arBox, "items");
					arBox.items = "";
				}
				else break;
			}
		}
	}
	pchar.GenQuestBox.ExternalRingInside = true;
	pchar.GenQuestBox.ExternalRingInside.box1.items.jewelry5 = 1;
}
// <-- тайна Санта-Люсии

// --> Блудный сын - похождения Оле Кристиансена
void LSC_CheckOlePearl()
{
	sld = characterFromId("Ole");
	if (CheckAttribute(sld, "pearl_date") && GetNpcQuestPastDayParam(sld, "pearl_date") >= 20)
	{
		chrDisableReloadToLocation = true;//закрыть локацию
		if (sti(sld.quest.pearlqty) < 11) sld.dialog.currentnode = "givemepearl";
		else sld.dialog.currentnode = "mother";
		GetCharacterPos(pchar, &locx, &locy, &locz);
		ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void LSC_OleGoHome(string qName) // ставим в дом Оле
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Ole");
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto1");
	LAi_ActorTurnToCharacter(sld, characterFromID("Agnes"));
	sld = characterFromId("Agnes");
	sld.dialog.currentnode = "agnes_9";
	LAi_SetActorType(sld);
	LAi_ActorDialogDelay(sld, pchar, "", 1.5);
}

void LSC_OleReturnHome(string qName) // активируем диалоги
{
	LocCameraResetState();
	LAi_SetPlayerType(PChar);
	sld = characterFromId("Ole");
	sld.dialog.currentnode = "home_2";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void LSC_OleAgnesRegard(string qName) // открываем дом
{
	sld = characterFromId("Ole");
	sld.dialog.currentnode = "final";
	LAi_SetStayType(sld);
	ChangeCharacterAddressGroup(sld, "Marigo_houseSp2", "goto", "goto1");
	LAi_group_MoveCharacter(sld, "HOLLAND_CITIZENS");
	LocatorReloadEnterDisable("Marigo_town", "houseSp2", false);
}
// <-- блудный сын

//------------------------------------------- возвращение на LSC -------------------------------------------
void LSC_ReturnJackmanAttack(string qName) //наймиты Джекмана атакуют
{
	log_Testinfo("Пираты Джекмана атакуют!");
	int iRank = 25+MOD_SKILL_ENEMY_RATE;
	int iScl = 60;
	Group_DeleteGroup("Jkm_Attack");
	Group_FindOrCreateGroup("Jkm_Attack");
    for (int i = 1; i <= 3; i++)
    {
		SelectLevelWarShipParameter();//автолевеллинг
        sld = GetCharacter(NPC_GenerateCharacter("Saga_JkmPirate_"+i, "mercen_"+(rand(27)+1), "man", "man", iRank, PIRATE, 2, true, "hunter"));
		FantomMakeSmallSailor(sld, iGlobalTemp, "", iTotalTemp, iScl, iScl, iScl, iScl, iScl);
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, sTotalTemp, "pistol3", "grapeshot", iScl*2);
        Group_AddCharacter("Jkm_Attack", "Saga_JkmPirate_"+i);
    }
    Group_SetGroupCommander("Jkm_Attack", "Saga_JkmPirate_1");
	Group_SetTaskAttack("Jkm_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("Jkm_Attack", PLAYER_GROUP);
	Group_SetAddress("Jkm_Attack", "Beliz", "", "");
	Group_LockTask("Jkm_Attack");
}

void LSC_ReturnCheckShips(string qName) //проверяем правильность кораблей и наличие лоции
{
	if (LSC_CheckShips()) // 270912
	{
		if (CheckCharacterItem(pchar, "LSC_navigation_map"))
		{
			Island_SetReloadEnableGlobal("LostShipsCity", true);//открыть остров, если был закрыт
			log_Testinfo("Проверка пройдена!!");
		}
		else
		{
			Island_SetReloadEnableGlobal("LostShipsCity", false);//закрыть остров
			PlaySound("interface\notebook.wav");
			log_info("You can not pass through the Island's reefs without sailing directions!");
		}
	}
	else
	{
		Island_SetReloadEnableGlobal("LostShipsCity", false);//закрыть остров
		PlaySound("interface\notebook.wav");
		log_info("You can not come close to the Island - your ships are too big!");
	}
	pchar.quest.LSC_checkships_repeat.win_condition.l1 = "MapEnter";
	pchar.quest.LSC_checkships_repeat.function = "LSC_ReturnCheckShipsRepeat";
}

void LSC_ReturnCheckShipsRepeat(string qName) //установка повтора проверки
{
	log_Testinfo("Повтор проверки LSC установлен");
	pchar.quest.return_LSC.win_condition.l1 = "location";
	pchar.quest.return_LSC.win_condition.l1.location = "LostShipsCity";
	pchar.quest.return_LSC.function = "LSC_ReturnCheckShips";
}

void LSC_ReturnMain(string qName) //возвращение в Эдем
{
	// раздаем ноды всем ключевым персонажам
	if (GetCharacterIndex("Dodson") != -1)
	{
		// Акулу ставим стоймя, Декстера - садим в кресло. Теперь он адмирал.
		sld = characterFromId("Dodson");
		sld.dialog.currentnode = "return"; // Акула
		ChangeCharacterAddressGroup(sld, "SanAugustineResidence", "goto", "goto10");
		LAi_SetWarriorType(sld);
		LAi_warrior_SetStay(sld, true);
		LAi_warrior_DialogEnable(sld, true); 
		sld = characterFromId("Dexter");
		sld.dialog.currentnode = "return"; // Декстер
		sld.greeting = "dexter_3"; 
		ChangeCharacterAddressGroup(sld, "SanAugustineResidence", "sit", "sit1");
		LAi_SetHuberType(sld);
	}
	if (GetCharacterIndex("Mary") != -1)
	{
		sld = characterFromId("Mary");
		sld.dialog.currentnode = "return"; 
		LAi_SetActorType(sld);
		ChangeCharacterAddressGroup(sld, "LostShipsCity_town", "quest", "quest1"); // Мэри - встречает
	}
	if (GetCharacterIndex("Dodson") == -1)
	{
		sld = characterFromId("Dexter");
		sld.dialog.currentnode = "return_A"; // Декстер
	}
	sld = characterFromId("Ole");
	if (CheckCharacterItem(pchar, "keys_skel"))
	{
		LAi_RemoveLoginTime(sld);
		sld.dialog.currentnode = "return";
		LAi_SetActorType(sld);
		ChangeCharacterAddressGroup(sld, "LostShipsCity_town", "quest", "quest2"); // Оле - встречает
	}
	else sld.dialog.currentnode = "ole_3"; 
	pchar.questTemp.LSC = "return"; // флаг - вернулся
	// ставим Даниэль
	sld = characterFromId("Danielle");
	sld.dialog.currentnode = "nathaniel"; 
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "LostShipsCity_town", "reload", "reload1_back");
	LAi_ActorDialog(sld, pchar, "", -1, 0); // Даниэль начинает
	// запреты
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.CannotWait = true;//запрет ожидания
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	// устанавливаем повторную атаку пиратов Джекмана
	pchar.quest.return_LSC_attack.over = "yes"; //снять прерывание, если проскочил
	pchar.quest.return_LSC_attack1.win_condition.l1 = "location";
	pchar.quest.return_LSC_attack1.win_condition.l1.location = "Beliz";
	pchar.quest.return_LSC_attack1.function = "LSC_ReturnJackmanAttack"; // атака наймитов Джекмана
}

void LSC_DannyAndNatan(string qName) //Даниэль и Натаниэль... любовь и все такое
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Nathaniel");
	sld.greeting = "Nathaniel";
	LAi_SetActorType(sld);
	pchar.questTemp.LSC.Attack = true; // обработка в АИ
	sld = characterFromId("Danielle");
	ChangeCharacterAddressGroup(sld, "FernandaDiffIndoor", "reload", "reload1");
	LAi_SetActorType(sld);
	LAi_ActorFollowEverywhere(sld, "", -1);
}

void LSC_NatanielSeeDaniel() // встретились... 
{
	DeleteAttribute(pchar, "questTemp.LSC.Attack");
	StartQuestMovie(true, true, true);
	sld = characterFromId("Nathaniel");
	sld.dialog.currentnode = "danny";
	LAi_SetActorType(sld);
	LAi_ActorDialogNow(sld, pchar, "", -1);
}

void LSC_SetNatanPassenger(string qName) // Натаниэля в пассажиры
{
	sld = characterFromId("Nathaniel");
	sld.location = "none";
	AddPassenger(pchar, sld, false);
	SetCharacterRemovable(sld, false);
	sld = characterFromId("Danielle");
	LAi_SetOfficerType(sld);
	sld.dialog.currentnode = "Danielle_officer";
}

void LSC_ClearFoodStorage(string qName) // чистим склады с продовольствием
{
	sld = characterFromId("Dexter");
	sld.quest.foodqty = rand(1000);
}

void LSC_DodsonSC(string qName) // высаживаем Акулу в Санта-Каталине
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Dodson");
	sld.dialog.currentnode = "return_5";
	RemovePassenger(Pchar, sld);
	ChangeCharacterAddressGroup(sld, "Santacatalina_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}
//-------------------------------------------искушение Барбазона---------------------------------------------

void Saga_BarbTemptationOver(string qName)//не пошли за шелком
{
	pchar.quest.BarbTemptation.over = "yes"; //снять прерывание
	AddQuestRecord("BarbTemptation", "4");
	pchar.questTemp.Saga.BarbTemptation = "give_silk";
	//пусть ищет шелк, где хочет - так будет лучше, чем валить квест сразу
}

void Saga_BarbTemptationBarkas(string qName)//устанавливаем рыбацкий баркас
{
	Group_FindOrCreateGroup("BarbBarkas");
	Group_SetType("BarbBarkas", "trade");//тип группы
	sld = GetCharacter(NPC_GenerateCharacter("BarbCapBarkas", "citiz_25", "man", "man", 10, HOLLAND, -1, true, "marginal"));
	FantomMakeCoolFighter(sld, 10, 20, 20, "blade_05", "pistol1", "bullet", 50);
	FantomMakeCoolSailor(sld, SHIP_TARTANE, "", CANNON_TYPE_NONECANNON, 5, 5, 5);
	sld.dialog.FileName = "Quest\Saga\OtherNPC.c";
	sld.dialog.currentnode = "BarbCapBarkas";
	sld.DeckDialogNode = "BarbCapBarkas";
	sld.DontRansackCaptain = true;
	sld.Ship.Mode = "trade";
	NullCharacterGoods(sld);
	SetCharacterGoods(sld, GOOD_SHIPSILK, 90);
	Group_AddCharacter("BarbBarkas", "BarbCapBarkas");
	Group_SetGroupCommander("BarbBarkas", "BarbCapBarkas");
	Group_SetTaskNone("BarbBarkas");
	Group_SetAddress("BarbBarkas", "SentMartin", "quest_ships", "quest_ship_6");
	Group_LockTask("BarbBarkas");
	
	pchar.quest.BarbBarkas_Sink.win_condition.l1 = "Character_sink";
	pchar.quest.BarbBarkas_Sink.win_condition.l1.character = "BarbCapBarkas";
	pchar.quest.BarbBarkas_Sink.function = "Saga_BarbBarkasFail";//потопили
	pchar.quest.BarbBarkas_Abordage.win_condition.l1 = "Character_Capture";
	pchar.quest.BarbBarkas_Abordage.win_condition.l1.character = "BarbCapBarkas";
	pchar.quest.BarbBarkas_Abordage.function = "Saga_BarbBarkasBoarding";//взяли на абордаж
}

void Saga_BarbBarkasFail(string qName)// утопили баркас
{
	pchar.quest.Saga_BarbTemptationOver.over = "yes"; //снять таймер
	pchar.quest.BarbBarkas_Abordage.over = "yes"; //снять прерывание
	AddQuestRecord("BarbTemptation", "3");
	pchar.questTemp.Saga.BarbTemptation = "give_silk";
	ChangeCharacterComplexReputation(pchar, "nobility", -5);
	ChangeCharacterNationReputation(pchar, HOLLAND, -5);
}

void Saga_BarbBarkasBoarding(string qName)// абордировали баркас
{
	pchar.quest.Saga_BarbTemptationOver.over = "yes"; //снять таймер
	pchar.quest.BarbBarkas_Sink.over = "yes"; //снять прерывание
	AddQuestRecord("BarbTemptation", "5");
	pchar.questTemp.Saga.BarbTemptation = "give_silk";
	ChangeCharacterComplexReputation(pchar, "nobility", -5);
	ChangeCharacterNationReputation(pchar, HOLLAND, -5);
}

void Saga_BarbBarkasSilk()//погрузка шелка
{
	SetLaunchFrameFormParam("An hour passed..."+ NewStr() +"Silk was loaded on your vessel", "", 0, 5);
	LaunchFrameForm();
	WaitDate("", 0, 0, 0, 1, 10); //крутим время
	RecalculateJumpTable();
	DoQuestFunctionDelay("Saga_BarbBarkasBye", 5.5);
}

void Saga_BarbBarkasBye(string qName)//уходим
{
	pchar.quest.Saga_BarbTemptationOver.over = "yes"; //снять таймер
	sld = characterFromId("BarbCapBarkas");
	sld.dialog.currentnode = "BarbCapBarkas_5";
	RemoveCharacterGoods(sld, GOOD_SHIPSILK, 90);
	SetCharacterGoods(pchar, GOOD_SHIPSILK, 90);
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", 1.0, -1);
}

void Saga_CreateMorelle() //создаем Мореля
{
	sld = GetCharacter(NPC_GenerateCharacter("Morelle", "citiz_22", "man", "man", 10, PIRATE, -1, true, "quest"));
	RemoveAllCharacterItems(sld, true);
	sld.name = "Simon";
	sld.lastname = "Morelle";
	sld.dialog.FileName = "Quest\Saga\OtherNPC.c";
	sld.dialog.currentnode = "Morelle";
	sld.greeting = "town_pirate";
	LAi_SetStayType(sld);
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "Marigo_prison", "goto", "goto9");
}

void Saga_SetMorelGoods(string qName) //тайник Мореля
{
	Log_Info("You have discovered Morel's hidden stash");
	Log_Info("Goods were loaded on the ship");
	PlaySound("interface\notebook.wav");
	AddCharacterGoods(pchar, GOOD_SHIPSILK, 30); 
	AddCharacterGoods(pchar, GOOD_EBONY, 50); 
	AddCharacterGoods(pchar, GOOD_MAHOGANY, 60);
	AddCharacterGoods(pchar, GOOD_TOBACCO, 100);
	AddCharacterGoods(pchar, GOOD_COFFEE, 150);
	AddCharacterGoods(pchar, GOOD_CHOCOLATE, 350);
	AddCharacterExpToSkill(pchar, "Fortune", 100);//везение
	//int n = Findlocation("Shore40");
	//DeleteAttribute(&locations[n], "models.always.Roll");
}

void Saga_SetJuniorInCharles() //создаем Валета
{
	int iRank = 22+MOD_SKILL_ENEMY_RATE+5;
	int iScl = 65;
	sld = GetCharacter(NPC_GenerateCharacter("Valet", "Valet", "man", "man", iRank, PIRATE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_18", "pistol6", "bullet", iScl*2);
	sld.name = "David";
	sld.lastname = "Fackman";
	sld.dialog.FileName = "Quest\Saga\OtherNPC.c";
	sld.dialog.currentnode = "valet";
	sld.greeting = "Valet";
	if (MOD_SKILL_ENEMY_RATE > 5) sld.MultiFighter = 1.8; // мультифайтер
	LAi_SetStayType(sld);
	ChangeCharacterAddressGroup(sld, "Charles_houseH1", "barmen", "stay");
	GiveItem2Character(sld, "letter_chad");
	ChangeItemDescribe("letter_chad", "itmdescr_letter_valet");
	GiveAdmiralMapToCharacter(sld, 9);
	sld.SaveItemsForDead = true; 
	sld.DontClearDead = true; 
}

void Saga_FindValetLetter(string qName) //нашли письмо Валета
{
	chrDisableReloadToLocation = false;
	AddQuestRecord("BarbTemptation", "8");
	AddQuestRecordInfo("Letter_valet", "1");
	pchar.quest.Saga_SetPolacre_Marlin.win_condition.l1 = "location";
	pchar.quest.Saga_SetPolacre_Marlin.win_condition.l1.location = "Nevis";
	pchar.quest.Saga_SetPolacre_Marlin.function = "Saga_SetPolacreMarlin";
}

void Saga_SetPolacreMarlin(string qName) //ставим полакр Марлин
{
	RemoveItems(pchar, "letter_chad", 1);
	int iRank = 20+MOD_SKILL_ENEMY_RATE;
	int iScl = 60;
	Island_SetReloadEnableGlobal("Nevis", false);//на остров нельзя
	bQuestDisableMapEnter = true; //закрываем карту
	pchar.GenQuest.MapClosedNoBattle = true; // patch
	Group_FindOrCreateGroup("Ship_Marlin");
	Group_SetType("Ship_Marlin", "pirate");//тип группы
	sld = GetCharacter(NPC_GenerateCharacter("Cap_Marlin", "mercen_27", "man", "man", iRank, ENGLAND, -1, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_POLACRE, "Marlin", CANNON_TYPE_CULVERINE_LBS18, iScl, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_18", "pistol6", "bullet", iScl*2+70);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "pirate";
	sld.ship.Crew.Morale = MOD_SKILL_ENEMY_RATE*6+20;
	sld.Ship.Crew.Exp.Sailors = MOD_SKILL_ENEMY_RATE*6+20;
	sld.Ship.Crew.Exp.Cannoners = MOD_SKILL_ENEMY_RATE*6+20;
	sld.Ship.Crew.Exp.Soldiers = MOD_SKILL_ENEMY_RATE*6+40;
	sld.Coastal_Captain = true; 
	sld.DontDeskTalk = true;
	if (MOD_SKILL_ENEMY_RATE > 7) sld.MultiFighter = 1.5; // мультифайтер
	SetCharacterPerk(sld, "MusketsShoot");
	UpgradeShipParameter(sld, "TurnRate");//маневренность
	UpgradeShipParameter(sld, "HP");//корпус
	Group_AddCharacter("Ship_Marlin", "Cap_Marlin");
	Group_SetGroupCommander("Ship_Marlin", "Cap_Marlin");
	Group_SetTaskNone("Ship_Marlin");//нет задачи
	Group_SetAddress("Ship_Marlin", "Nevis", "quest_ships", "quest_ship_"+(3+rand(4)));
	Group_LockTask("Ship_Marlin");
	
	pchar.quest.Marlin_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Marlin_AfterBattle.win_condition.l1.group = "Ship_Marlin";
	pchar.quest.Marlin_AfterBattle.function = "Saga_CheckMarlinAfterBattle";
}

void Saga_CheckMarlinAfterBattle(string qName) //проверяем полакр Марлин после боя
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Group_DeleteGroup("Ship_Marlin");
	Island_SetReloadEnableGlobal("Nevis", true);
	bQuestDisableMapEnter = false; 
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle"); // patch
	int iMar = 0;
	for(i = 0; i < COMPANION_MAX; i++)
	{
		iTemp = GetCompanionIndex(pchar, i);
		if(iTemp > 0)
		{
			sld = GetCharacter(iTemp);
			if(sti(RealShips[sti(sld.ship.type)].basetype) == SHIP_POLACRE && sld.ship.name == "Marlin") iMar = 1;
		}
	} // есть ли у нас Марлин
	if (iMar == 1) // есть
	{
		pchar.questTemp.Saga.BarbTemptation.Marlin = "true";
		AddQuestRecord("BarbTemptation", "9");
		AddCharacterExpToSkill(pchar, "Grappling", 200);//абордаж
	}
	else AddQuestRecord("BarbTemptation", "10");
	LocatorReloadEnterDisable("LaVega_town", "reload6", true); // закрываем вход к Маркусу
	// прерывание на Теркс
	pchar.quest.Saga_Vensan_brigantine.win_condition.l1 = "location";
	pchar.quest.Saga_Vensan_brigantine.win_condition.l1.location = "Terks";
	pchar.quest.Saga_Vensan_brigantine.function = "Saga_CheckVensanBrigantine";
	AddComplexSeaExpToScill(100, 100, 100, 0, 100, 100, 0);
}

void Saga_CheckVensanBrigantine(string qName) // проверка правильности выполнения
{
	if (!Saga_CheckMarlinShip())
	{
		Log_TestInfo("Проверка НЕ пройдена!");
		if (!CheckAttribute(pchar, "questTemp.Saga.BarbTemptation.Marlin_Repeat")) AddQuestRecord("BarbTemptation", "11");
		pchar.quest.Saga_Vensan_brigantine1.win_condition.l1 = "MapEnter";
		pchar.quest.Saga_Vensan_brigantine1.function = "Saga_CheckVensanBrigantineRepeat";
	}
	else
	{
		Log_TestInfo("Проверка пройдена!");
		AddQuestRecord("BarbTemptation", "12");
		bQuestDisableMapEnter = true; //закрываем карту
		pchar.GenQuest.MapClosedNoBattle = true; // patch
		// устанавливаем бригантину Венсана
		Group_FindOrCreateGroup("Ship_Vensan");
		Group_SetType("Ship_Vensan", "pirate");//тип группы
		sld = GetCharacter(NPC_GenerateCharacter("Cap_Vensan", "mercen_20", "man", "man", 20, ENGLAND, -1, true, "quest"));
		FantomMakeCoolSailor(sld, SHIP_BRIGANTINE, "Separator", CANNON_TYPE_CANNON_LBS16, 50, 50, 50);
		sld.FaceId = 333; // пустой кораблик
		sld.name = "";
		sld.lastname = "";
		sld.ShipEnemyDisable  = true;
		sld.AlwaysFriend = true;
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		SetCrewQuantityOverMax(sld, 30);
		sld.Ship.Mode = "pirate";
		ref realShip = GetRealShip(GetCharacterShipType(sld));
		realShip.lowpolycrew = 0; // убрать матросиков с палубы корабля
		Group_AddCharacter("Ship_Vensan", "Cap_Vensan");
		Group_SetGroupCommander("Ship_Vensan", "Cap_Vensan");
		Group_SetTaskNone("Ship_Vensan");//нет задачи
		Group_SetAddress("Ship_Vensan", "Terks", "ships", "l4");
		Group_LockTask("Ship_Vensan");
		// прерывание на высадку в Южный залив
		pchar.quest.Saga_DestroyTrap.win_condition.l1 = "location";
		pchar.quest.Saga_DestroyTrap.win_condition.l1.location = "Shore57";
		pchar.quest.Saga_DestroyTrap.function = "Saga_DestroyVensanTrap";
	}
}

void Saga_CheckVensanBrigantineRepeat(string qName) // повтор проверки
{
	pchar.quest.Saga_Vensan_brigantine.win_condition.l1 = "location";
	pchar.quest.Saga_Vensan_brigantine.win_condition.l1.location = "Terks";
	pchar.quest.Saga_Vensan_brigantine.function = "Saga_CheckVensanBrigantine";
	pchar.questTemp.Saga.BarbTemptation.Marlin_Repeat = "true";
}

void Saga_CreateCapnCrewVensan() // палуба бригантины венсана
{
	// усадим Венсана
	sld = GetCharacter(NPC_GenerateCharacter("Vensan", "Vensan", "man", "man", 20, ENGLAND, -1, true, "quest"));
	sld.name = "Bernar";
	sld.lastname = "Vensan";
	sld.dialog.FileName = "Quest\Saga\OtherNPC.c";
	sld.dialog.currentnode = "vensan";
	sld.greeting = "vensan";
	if (!CheckAttribute(pchar, "questTemp.Saga.BarbTemptation.Vensan_canfree")) LAi_CharacterDisableDialog(sld);
	RemoveAllCharacterItems(sld, true);
	LAi_SetImmortal(sld, true);
	LAi_SetGroundSitTypeNoGroup(sld);
	ChangeCharacterAddressGroup(sld, "Deck_Near_Ship", "reload", "reload1");
	// разложим его матросов
	for(i = 1; i <= 8; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Vens_sailor_"+i, "citiz_3"+i, "man", "man", 20, ENGLAND, -1, true, "quest"));
		RemoveAllCharacterItems(sld, true);
		ChangeCharacterAddressGroup(sld, "Deck_Near_Ship", "goto", "goto"+i);
		LAi_SetActorType(sld);
		LAi_ActorSetLayMode(sld);
	}
	if (!CheckAttribute(pchar, "questTemp.Saga.BarbTemptation.Vensan_canfree")) DoQuestFunctionDelay("Saga_BrigantineBoom", 5.0); // бум!!
}

void Saga_BrigantineBoom(string qName) // залез на бригантину не вовремя
{
	PlayStereoSound("Sea Battles\Vzriv_fort_001.wav");
	for(i = 1; i <= 9; i++)
	{
		CreateLocationParticles("shipfire", "goto", "goto"+i, 0.5, 0, 0, "Explode");
		CreateLocationParticles("blast_inv", "goto", "goto"+i, 1.0, 0, 0, "");
		CreateLocationParticles("blast_dirt", "goto", "goto"+i, 1.0, 0, 0, "");
	}
	LAi_KillCharacter(pchar);
}

void Saga_BrigantineDetonate(string qName) // сюрприз для особо упоротых
{
	PlayStereoSound("Sea Battles\Vzriv_fort_001.wav");
		PlayStereoSound("Sea Battles\vzriv_pogreb_002.wav")
	sld = characterFromId("Cap_Vensan");
	Ship_Detonate(sld, true, true); 
	Ship_Detonate(pchar, true, true); 
}

void Saga_DestroyVensanTrap(string qName) // учиняем массовую драку в заливе
{
	chrDisableReloadToLocation = true;//закрыть локацию
	int iRank = 22+MOD_SKILL_ENEMY_RATE;
	int iScl = 55;
	// устанавливаем врагов
	// мушкетеры
	int m = makeint(MOD_SKILL_ENEMY_RATE/2);
	if (m < 2) m = 2;
	for (i=1; i<=m; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Saga_TrapMush_"+i, "mush_ctz_"+(rand(2)+7), "man", "mushketer", iRank, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank+2, iScl+5, iScl+5, "", "mushket1", "cartridge", iScl*2);
		sld.MusketerDistance = 0;
		ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	// солдаты
	for (i=1; i<=3; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Saga_TrapSold_"+i, "citiz_4"+i, "man", "man", iRank, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_10", "pistol3", "grapeshot", iScl*2);
		ChangeCharacterAddressGroup(sld, pchar.location, "smugglers", "smuggler"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	// подкрепление
	for (i=1; i<=7; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Saga_TrapSoldAdd_"+i, "citiz_4"+(i+3), "man", "man", iRank, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank+2, iScl+5, iScl+5, "blade_21", "pistol1", "bullet", iScl*2);
		ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto7");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	// устанавливаем наших
	// мушкетеры
	for (i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Saga_OwrMush_"+i, "mush_ctz_"+(rand(2)+4), "man", "mushketer", iRank, PIRATE, 1, false, "soldier")); // 291112
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
		ChangeCharacterAddressGroup(sld, pchar.location, "rld", "loc2");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	// солдаты
	for (i=1; i<=5; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Saga_OwrSold_"+i, "citiz_3"+i, "man", "man", iRank, PIRATE, 1, false, "soldier")); // 291112
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_10", "pistol3", "grapeshot", iScl*2);
		ChangeCharacterAddressGroup(sld, pchar.location, "rld", "loc1");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Saga_VensanTrapDestroyed");
	AddDialogExitQuest("MainHeroFightModeOn");
}

void Saga_CreateVensanEnemyes(string qName) // устанавливаем Бродягу и Упыря
{
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle"); // patch пускай ручками гребет вокруг острова
	Island_SetReloadEnableGlobal("Terks", false);//закрыть остров
	AddQuestRecord("BarbTemptation", "14");
	pchar.nation = FRANCE; // принудительно
	int iRank = 20+MOD_SKILL_ENEMY_RATE;
	int iScl = 55;
	Group_FindOrCreateGroup("Ship_VensanEnemy");
	Group_SetType("Ship_VensanEnemy", "pirate");//тип группы
	// устанавливаем корвет Бродяги
	sld = GetCharacter(NPC_GenerateCharacter("Saga_Vagrant", "mercen_26", "man", "man", iRank, ENGLAND, -1, true, "quest")); // patch
	FantomMakeSmallSailor(sld, SHIP_CORVETTE, "Cuttlefish", CANNON_TYPE_CULVERINE_LBS18, iScl, iScl, iScl, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_13", "pistol5", "bullet", iScl*2);
	sld.name = "Vagrant";
	sld.lastname = "";
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "pirate";
	sld.DontDeskTalk = true;
	if (MOD_SKILL_ENEMY_RATE > 7) sld.MultiFighter = 1.5; // мультифайтер
	Group_AddCharacter("Ship_VensanEnemy", "Saga_Vagrant");
	SetCharacterRelationBoth(sti(sld.index), GetMainCharacterIndex(), RELATION_FRIEND); // тестить
	//SetNationRelation2MainCharacter(PIRATE, RELATION_FRIEND); // 300912
	// устанавливаем фрегат Упыря
	sld = GetCharacter(NPC_GenerateCharacter("Saga_vampire", "mercen_25", "man", "man", iRank+5, ENGLAND, -1, true, "quest")); // patch
	FantomMakeCoolSailor(sld, SHIP_FRIGATE, "Merciless", CANNON_TYPE_CANNON_LBS24, iScl+5, iScl+5, iScl+5);
	FantomMakeCoolFighter(sld, iRank+5, iScl+15, iScl+15, "blade_14", "pistol5", "bullet", iScl*2+100);
	sld.name = "Vampire";
	sld.lastname = "";
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "pirate";
	sld.DontDeskTalk = true;
	if (MOD_SKILL_ENEMY_RATE > 7) sld.MultiFighter = 1.5; // мультифайтер
	Group_AddCharacter("Ship_VensanEnemy", "Saga_vampire");
	SetCharacterRelationBoth(sti(sld.index), GetMainCharacterIndex(), RELATION_FRIEND); // тестить
	Group_SetGroupCommander("Ship_VensanEnemy", "Saga_Vagrant");
	Group_SetTaskNone("Ship_VensanEnemy");//нет задачи
	Group_SetAddress("Ship_VensanEnemy", "Terks", "Islandships1", "ship_2");
	Group_LockTask("Ship_VensanEnemy");
	
	pchar.quest.Vensan_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Vensan_AfterBattle.win_condition.l1.group = "Ship_VensanEnemy";
	pchar.quest.Vensan_AfterBattle.function = "Saga_VensanAfterBattle";
	
}

void Saga_CheckVensanEnemyes() // анализируем ГГ - обработка в АИ
{
	bool bOk = false;
	if (CheckAttribute(pchar, "questTemp.Saga.BarbTemptation.Marlin") && pchar.ship.name == "Marlin" && GetSummonSkillFromName(pchar, SKILL_SNEAK)*isEquippedArtefactUse(pchar, "indian_11", 1.0, 1.15) > (10+rand(35))) bOk = true;
	if (!CheckAttribute(pchar, "questTemp.Saga.BarbTemptation.Marlin") && pchar.ship.name == "Marlin" && GetSummonSkillFromName(pchar, SKILL_SNEAK)*isEquippedArtefactUse(pchar, "indian_11", 1.0, 1.15) > (10+rand(85))) bOk = true;
	if (!bOk)
	{
		log_info("Pirates recognized your true identity!");
		DeleteAttribute(pchar, "questTemp.Saga.BarbTemptation.Bomb"); // если было
		pchar.questTemp.Saga.BarbTemptation.vensan_attack = "true";
		sld = characterFromId("Saga_Vagrant");
		sld.AlwaysEnemy = true;
		sld = characterFromId("Saga_vampire");
		sld.AlwaysEnemy = true;
		SetCharacterRelationBoth(sti(GetCharacterIndex("Saga_Vagrant")), GetMainCharacterIndex(), RELATION_ENEMY);
		SetCharacterRelationBoth(sti(GetCharacterIndex("Saga_vampire")), GetMainCharacterIndex(), RELATION_ENEMY);
		Group_SetTaskAttack("Ship_VensanEnemy", PLAYER_GROUP);
		Group_LockTask("Ship_VensanEnemy");
		UpdateRelations();
		RefreshBattleInterface();
		AddCharacterExpToSkill(pchar, "Sneak", 200);
	}
}

void Saga_VagrantVampireAttack() // пальнули через прицел
{
	DeleteAttribute(pchar, "questTemp.Saga.BarbTemptation.Bomb"); // если было
	pchar.questTemp.Saga.BarbTemptation.vensan_attack = "true";
	sld = characterFromId("Saga_Vagrant");
	sld.AlwaysEnemy = true;
	sld = characterFromId("Saga_vampire");
	sld.AlwaysEnemy = true;
	SetCharacterRelationBoth(sti(GetCharacterIndex("Saga_Vagrant")), GetMainCharacterIndex(), RELATION_ENEMY);
	SetCharacterRelationBoth(sti(GetCharacterIndex("Saga_vampire")), GetMainCharacterIndex(), RELATION_ENEMY);
	Group_SetTaskAttack("Ship_VensanEnemy", PLAYER_GROUP);
	Group_LockTask("Ship_VensanEnemy");
	UpdateRelations();
	RefreshBattleInterface();
}

void Saga_HitSeaBomb() // ставим бомбу под фрегат - обработка в АИ
{
	float fTemp = 100.0;
	DeleteAttribute(pchar, "questTemp.Saga.BarbTemptation.Bomb");
	PlaySound("Ships\jakor_002.wav");
	log_info("Mine has been dropped!");
	if(iArcadeSails == 1) fTemp = 40.0;
	AISeaGoods_AddGood(pchar, "powder", "barrel_treasure", fTemp-10.0, 1);
	DoQuestFunctionDelay("Saga_HitSeaBomb_Detonate", fTemp);
	log_info("You have only "+sti(fTemp)+" to get away!");
}

void Saga_HitSeaBomb_Detonate(string qName) // капут фрегату
{
	pchar.questTemp.Saga.BarbTemptation.BombFire = "true";
	sld = characterFromId("Saga_vampire");
	Ship_Detonate(sld, true, true); // ба-бах!!!
	PlaySound("Sea Battles\Vzriv_fort_001.wav");
	PlaySound("Sea Battles\vzriv_pogreb_002.wav");
	PlaySound("Sea Battles\vzriv_pogreb_002.wav");
	if (Ship_GetDistance2D(GetMainCharacter(), sld) < 200) Saga_SeaBombFail();
	sld = characterFromId("Saga_Vagrant");
	sld.AlwaysEnemy = true;
	SetCharacterRelationBoth(sti(GetCharacterIndex("Saga_Vagrant")), GetMainCharacterIndex(), RELATION_ENEMY);
	Group_SetTaskAttack("Ship_VensanEnemy", PLAYER_GROUP);
	Group_LockTask("Ship_VensanEnemy");
	UpdateRelations();
	RefreshBattleInterface();
	AddCharacterExpToSkill(pchar, "Sneak", 400);
}

void Saga_SeaBombFail() // а если ГГ не удрал - то и ему тоже
{
	log_info("You failed to avoid the explosion!");
	Ship_Detonate(pchar, true, true); // ба-бах!!!
	PlayStereoSound("Sea Battles\Vzriv_fort_001.wav");
	PlayStereoSound("Sea Battles\vzriv_pogreb_002.wav");
}

void Saga_VensanAfterBattle(string qName) // уничтожили врагов
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Group_DeleteGroup("Ship_VensanEnemy");
	Island_SetReloadEnableGlobal("Terks", true);
	bQuestDisableMapEnter = false;
	// чистим за собой
	pchar.quest.Saga_VensanClear.win_condition.l1 = "MapEnter";
	pchar.quest.Saga_VensanClear.function = "Saga_VensanClear";
	if (CheckCharacterItem(pchar, "letter_chad_1"))
	{
		AddQuestRecord("BarbTemptation", "16");
		pchar.questTemp.Saga.BarbTemptation = "islatesoro";
		// ставим прерывание на Исла-Тесоро
		pchar.quest.Saga_AttackJackman.win_condition.l1 = "location";
		pchar.quest.Saga_AttackJackman.win_condition.l1.location = "Bermudes";
		pchar.quest.Saga_AttackJackman.function = "Saga_CheckJackmanBermudes";
	}
	else
	{
		AddQuestRecord("BarbTemptation", "17");
		pchar.questTemp.Saga.BarbTemptation = "danielle"; // даю еще один шанс
	}
	if (CheckAttribute(pchar, "questTemp.Saga.BarbTemptation.BombFire")) AddQuestUserData("BarbTemptation", "sText", "Yeah, we didn't go greedy on gunpowder there! Boomed so loud that they have probably heard it even at Tortuga. The frigate got her powder supplies detonated and her captain went to the bottom along with his ship in no time.");
	AddComplexSeaExpToScill(150, 150, 150, 150, 150, 150, 0);
}

void Saga_VensanClear(string qName) // подчищаем ненужные группы и НПС
{
	Group_DeleteGroup("Ship_Vensan");
	sld = characterFromId("Vensan");
	sld.lifeday = 0;
	for (i=1; i<=8; i++)
	{
		sld = characterFromId("Vens_sailor_"+i);
		sld.lifeday = 0;
	}
}

void Saga_CheckJackmanBermudes(string qName) // Джекман
{
	if (!Saga_CheckMarlinShip())
	{
		Log_TestInfo("Проверка НЕ пройдена!");
		if (!CheckAttribute(pchar, "questTemp.Saga.BarbTemptation.Jackman_Repeat")) AddQuestRecord("BarbTemptation", "19");
		pchar.quest.Saga_AttackJackman1.win_condition.l1 = "MapEnter";
		pchar.quest.Saga_AttackJackman1.function = "Saga_CheckJackmanBermudesRepeat";
	}
	else
	{
		string sTemp;
		Log_TestInfo("Проверка пройдена!");
// --> mitrokosta письмо выбрасываем за ненадобностью
    if(CheckCharacterItem(pchar, "letter_chad_1")) {
      RemoveItems(pchar, "letter_chad_1", 1);
    }
// <--
		Island_SetReloadEnableGlobal("Bermudes", false);//закрыть остров
		bQuestDisableMapEnter = true; //закрываем карту
		pchar.nation = FRANCE; // принудительно
		// Даниэль делаем бессмертной
		sld = characterFromId("Danielle");
		LAi_SetCheckMinHP(sld, 10, true, ""); // скрытое бессмертие
		// устанавливаем фрегат Джекмана
		Group_FindOrCreateGroup("Jackman_Frigate");
		Group_SetType("Jackman_Frigate", "pirate");//тип группы
		int iRank = 25+MOD_SKILL_ENEMY_RATE;
		int iScl = 90;
		int iCannon = CANNON_TYPE_CANNON_LBS32;
		if (sti(pchar.rank) < 15 || MOD_SKILL_ENEMY_RATE < 7) iCannon = CANNON_TYPE_CANNON_LBS24;
		sld = characterFromId("Jackman");
		sld.nation = ENGLAND;
		FantomMakeSmallSailor(sld, SHIP_FRIGATE_H, "Centurion", iCannon, iScl, iScl, iScl, iScl, iScl);
		SetCharacterPerk(sld, "CriticalShoot");
		SetCharacterPerk(sld, "LongRangeShoot");
		SetCharacterPerk(sld, "CannonProfessional");
		SetCharacterPerk(sld, "ShipDefenseProfessional");
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_21", "pistol5", "bullet", iScl*2+100);
		LAi_SetImmortal(sld, false);
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.Ship.Mode = "mercenary";
		sld.SaveItemsForDead = true;
		sld.DontClearDead = true;
		GiveItem2Character(sld, "spyglass4");
		sld.DontDeskTalk = true;
		SetCharacterRelationBoth(sti(sld.index), GetMainCharacterIndex(), RELATION_FRIEND); // тестить
		sld.ship.Crew.Morale = 50+MOD_SKILL_ENEMY_RATE*5;
		sld.Ship.Crew.Exp.Sailors = 50+MOD_SKILL_ENEMY_RATE*5;
		sld.Ship.Crew.Exp.Cannoners = 50+MOD_SKILL_ENEMY_RATE*5;
		sld.Ship.Crew.Exp.Soldiers = 50+MOD_SKILL_ENEMY_RATE*5; // крутизна невероятная
		if (MOD_SKILL_ENEMY_RATE > 4) 
		{
			SetCharacterPerk(sld, "MusketsShoot");
			sld.MultiFighter = 1.8; // мультифайтер
		}
		Group_AddCharacter("Jackman_Frigate", "Jackman");
		Group_SetGroupCommander("Jackman_Frigate", "Jackman");
		Group_SetTaskNone("Jackman_Frigate");//нет задачи
		Group_SetAddress("Jackman_Frigate", "Bermudes", "quest_ships", "quest_ship_8");
		Group_LockTask("Jackman_Frigate");
		
		//на захват либо потопление абордажем
		pchar.quest.Saga_JackmanAbordage.win_condition.l1 = "Character_Capture";
		pchar.quest.Saga_JackmanAbordage.win_condition.l1.character = "Jackman";
		pchar.quest.Saga_JackmanAbordage.function = "Saga_JackmanAbordage";//взяли на абордаж
		//на потопление орудиями
		pchar.quest.Saga_JackmanSink.win_condition.l1 = "Character_sink";
		pchar.quest.Saga_JackmanSink.win_condition.l1.character = "Jackman";
		pchar.quest.Saga_JackmanSink.function = "Saga_JackmanSink";//потопили
		
		//военный совет
		if (CheckAttribute(pchar, "questTemp.Saga.BarbTemptation.BombFire")) // если юзал бомбу
		{
			if (pchar.questTemp.Saga.BarbTemptation.adviser == "Mary")
			{
				if (GetCharacterIndex("Mary") != -1)
				{
					sld = characterFromId("Mary");
					sTemp = "Wait! It won't hurt to ask for Mary's advice, she did help with the bomb last time! Her bright head may produce some idea again...";
					sld.quest.fugas = "true";
				}
				else sTemp = "Eh, I wish Mary were here... She would have made something up for sure...";
			}
			else
			{
				sld = characterFromId("Helena");
				sTemp = "Wait! It won't hurt to ask for Helen's advice, she did help with the bomb last time! Her bright head may produce some idea again...";
				sld.quest.fugas = "true";
			}
		}
		else sTemp = "";
		AddQuestRecord("BarbTemptation", "20");
		AddQuestUserData("BarbTemptation", "sText", sTemp);
	}
}

void Saga_CheckJackmanBermudesRepeat(string qName) // повтор проверки
{
	pchar.quest.Saga_AttackJackman.win_condition.l1 = "location";
	pchar.quest.Saga_AttackJackman.win_condition.l1.location = "Bermudes";
	pchar.quest.Saga_AttackJackman.function = "Saga_CheckJackmanBermudes";
	pchar.questTemp.Saga.BarbTemptation.Jackman_Repeat = "true";
}

void Saga_CheckJackmanFrigate() // анализируем ГГ - обработка в АИ
{
	// Джекмана обмануть сложнее
	bool bOk = false;
	if (CheckAttribute(pchar, "questTemp.Saga.BarbTemptation.Marlin") && pchar.ship.name == "Marlin" && GetSummonSkillFromName(pchar, SKILL_SNEAK)*isEquippedArtefactUse(pchar, "indian_11", 1.0, 1.15) > (10+rand(50))) bOk = true;
	if (!CheckAttribute(pchar, "questTemp.Saga.BarbTemptation.Marlin") && pchar.ship.name == "Marlin" && GetSummonSkillFromName(pchar, SKILL_SNEAK)*isEquippedArtefactUse(pchar, "indian_11", 1.0, 1.15) > (20+rand(100))) bOk = true;
	if (!bOk)
	{
		log_info("Pirates recognized your true identity!");
		sld = characterFromId(pchar.questTemp.Saga.BarbTemptation.adviser);
		DeleteAttribute(sld, "quest.fugas");
		sld = characterFromId("Jackman");
		sld.AlwaysEnemy = true;
		SetCharacterRelationBoth(sti(GetCharacterIndex("Jackman")), GetMainCharacterIndex(), RELATION_ENEMY);
		Group_SetTaskAttack("Jackman_Frigate", PLAYER_GROUP);
		Group_LockTask("Jackman_Frigate");
		UpdateRelations();
		RefreshBattleInterface();
		AddCharacterExpToSkill(pchar, "Sneak", 250);//скрытность
	}
}

void Saga_CenturionAttack() // пальнули через прицел
{
	sld = characterFromId(pchar.questTemp.Saga.BarbTemptation.adviser);
	DeleteAttribute(sld, "quest.fugas");
	DeleteAttribute(pchar, "questTemp.Saga.BarbTemptation.Fugas");
	sld = characterFromId("Jackman");
	sld.AlwaysEnemy = true;
	SetCharacterRelationBoth(sti(GetCharacterIndex("Jackman")), GetMainCharacterIndex(), RELATION_ENEMY);
	Group_SetTaskAttack("Jackman_Frigate", PLAYER_GROUP);
	Group_LockTask("Jackman_Frigate");
	UpdateRelations();
	RefreshBattleInterface();
}

void Saga_HitSeaFugas() // бросаем фугас - обработка в АИ
{
	float fTemp = 25.0;
	if(iArcadeSails == 1) fTemp = 10.0;
	DeleteAttribute(pchar, "questTemp.Saga.BarbTemptation.Fugas");
	for (i=1; i<=10; i++)
	{
		PlayStereoSound("Sea Battles\udar_metal_002.wav");
	}
	log_info("Charges have been thrown!");
	DoQuestFunctionDelay("Saga_HitSeaFugas_Detonate", fTemp);
	log_info("Charges will explode in  "+sti(fTemp)+" seconds!");
}

void Saga_HitSeaFugas_Detonate(string qName) // фугасом по пиратам
{
	float fTemp = 16.0;
	if(iArcadeSails == 1) fTemp = 7.0;
	pchar.questTemp.Saga.BarbTemptation.FugasFire = "true";
	sld = characterFromId("Jackman");
	for (i=1; i<=10; i++)
	{
		Ship_Detonate(sld, false, false); // ба-бах!!!
		PlayStereoSound("Sea Battles\vzriv_pogreb_002.wav");
		PlayStereoSound("Sea Battles\sdavl_kriki_005.wav");
	}
	int iCrew = makeint(sti(sld.Ship.Crew.Quantity)*0.67); 
	SetCrewQuantityOverMax(sld, iCrew); // сносим треть команды
	sld.ship.HP = makeint(sti(sld.ship.HP)*0.9); // портим корпус
	AddCrewMorale(sld, -30); // команда врага деморализована внезапным и подлым нападением
	ChangeCrewExp(sld, "Sailors", -30);
	ChangeCrewExp(sld, "Cannoners", -30);
	ChangeCrewExp(sld, "Soldiers", -50); // перебили много наемников
	AddCrewMorale(pchar, 20); // а у наших - наоборот
	DoQuestFunctionDelay("Saga_HitSeaFugas_DetonateReaction", fTemp);
	AddCharacterExpToSkill(pchar, "Sneak", 500);//скрытность
}

void Saga_HitSeaFugas_DetonateReaction(string qName) // Джекман атакует
{
	PlayStereoSound("Voice\Russian\EvilPirates01.wav");
	sld = characterFromId("Jackman");
	sld.AlwaysEnemy = true;
	SetCharacterRelationBoth(sti(GetCharacterIndex("Jackman")), GetMainCharacterIndex(), RELATION_ENEMY);
	Group_SetTaskAttack("Jackman_Frigate", PLAYER_GROUP);
	Group_LockTask("Jackman_Frigate");
	UpdateRelations();
	RefreshBattleInterface();
	AddQuestRecord("BarbTemptation", "22");
}

// Jason: у меня не съехала крыша. Просто в абордажной локации прерывания не отрабатываются.
void Saga_CheckJackmanCabinItems(string qName) // проверяем наличие квестовых предметов
{
	if (CheckCharacterItem(pchar, "splinter_nh") && CheckCharacterItem(pchar, "map_half_blaze") && CheckCharacterItem(pchar, "letter_parol") && CheckCharacterItem(pchar, "witches_hammer")) DoQuestFunctionDelay("Saga_CanReloadFromJackmanCabin", 0.5);
	else DoQuestFunctionDelay("Saga_CheckJackmanCabinRepeat", 0.5);
}

void Saga_CheckJackmanCabinRepeat(string qName) // проверка каждые 3 секунды
{
	DoQuestFunctionDelay("Saga_CheckJackmanCabinItems", 2.5);
}

void Saga_CanReloadFromJackmanCabin(string qName) // собрали все квестовые предметы
{
	log_Testinfo("Выход открыт!");
	RemoveItems(pchar, "map_half_beatriss", 1);
	RemoveItems(pchar, "map_half_blaze", 1);
	GiveItem2Character(pchar, "map_sharp_full");
	DeleteAttribute(pchar, "GenQuest.CannotReloadBoarding"); // можно выходить
}

void Saga_JackmanSink(string qName) // провал Саги
{
	// неписи для остановки: Свенсон, Даниэль, Натаниэль, Элен, Тиракс, Барбазон, Марлоу
	Group_DeleteGroup("Jackman_Frigate");
	Island_SetReloadEnableGlobal("Bermudes", true);
	bQuestDisableMapEnter = false;
	AddQuestRecord("Saga", "23");
	DeleteAttribute(pchar, "questTemp.Saga.BarbTemptation");
	DeleteAttribute(pchar, "GenQuest.LigaAttack"); // киллеры Лиги деактивированы
	LocatorReloadEnterDisable("LaVega_town", "reload6", false); // открываем вход к Маркусу
	Saga_CenturionFail(); // остановочная функция
}

void Saga_JackmanAbordage(string qName) // победили Джекмана
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Group_DeleteGroup("Jackman_Frigate");
	Island_SetReloadEnableGlobal("Bermudes", true);
	bQuestDisableMapEnter = false;
	DeleteAttribute(pchar, "GenQuest.CannotTakeShip");
	DeleteAttribute(pchar, "GenQuest.LigaAttack"); // киллеры Лиги деактивированы
	AddQuestRecord("BarbTemptation", "24");
	LocatorReloadEnterDisable("LaVega_town", "reload6", false); // открываем вход к Маркусу
	pchar.questTemp.Saga.BarbTemptation = "terrax"; // посещение трех баронов
	// поставим прерывание на Барбазона
	pchar.quest.Saga_storming_group.win_condition.l1 = "location";
	pchar.quest.Saga_storming_group.win_condition.l1.location = "LeFransua_Exittown";
	pchar.quest.Saga_storming_group.function = "Saga_CreateStormingGroup";
	pchar.quest.Saga_storming_group1.win_condition.l1 = "location";
	pchar.quest.Saga_storming_group1.win_condition.l1.location = "LeFransua_port";
	pchar.quest.Saga_storming_group1.win_condition = "WalkByFoot";
	ChangeCharacterComplexReputation(pchar, "fame", 3);
}

void Saga_CreateStormingGroup(string qName) // к Барбазону
{
	bDisableFastReload = true;//закрыть переход
	pchar.quest.Saga_storming_group1.over = "yes"; //снять прерывание если не отработало
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	LAi_LocationFightDisable(&Locations[FindLocation("LeFransua_town")], true);//запретить драться
	LocatorReloadEnterDisable("LeFransua_Exittown", "reload1_back", true);
	LocatorReloadEnterDisable("LeFransua_Exittown", "reload2_back", true);
	// мушкетеры
	for (i=1; i<=5; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Saga_SGM_"+i, "mush_ctz_"+(rand(2)+4), "man", "mushketer", 25, sti(pchar.nation), -1, false, "soldier"));
		FantomMakeCoolFighter(sld, 25, 80, 100, "", "mushket1", "cartridge", 100);
		ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto3");
		LAi_SetActorType(sld);
		LAi_ActorFollowEverywhere(sld, "", -1);
	}
	// солдаты
	for (i=1; i<=7; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Saga_SGS_"+i, "citiz_3"+i, "man", "man", 25, sti(pchar.nation), -1, false, "soldier"));
		FantomMakeCoolFighter(sld, 25, 80, 80, "blade_10", "pistol3", "grapeshot", 100);
		ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto1");
		LAi_SetActorType(sld);
		LAi_ActorFollowEverywhere(sld, "", -1);
	}
	pchar.quest.Saga_storming_group2.win_condition.l1 = "location";
	pchar.quest.Saga_storming_group2.win_condition.l1.location = "LeFransua_town";
	pchar.quest.Saga_storming_group2.function = "Saga_StormingGroup";
}

void Saga_StormingGroup(string qName) // поведение сопровождения
{
	for (i=1; i<=5; i++)
	{
		sld = characterFromId("Saga_SGM_"+i);
		LAi_SetActorType(sld);
		LAi_ActorRunToLocator(sld, "quest", "mush"+i, "", -1);
		DoQuestCheckDelay("Saga_StormingGroupTurn", 7.0);
	}
	for (i=1; i<=7; i++)
	{
		sld = characterFromId("Saga_SGS_"+i);
		LAi_SetWarriorType(sld);
		LAi_warrior_DialogEnable(sld, false);
	}
}

void Saga_DeleteStormingGroup(string qName) // удалить сопровождение
{
	for (i=1; i<=5; i++)
	{
		sld = characterFromId("Saga_SGM_"+i);
		sld.lifeday = 0;
	}
	for (i=1; i<=7; i++)
	{
		sld = characterFromId("Saga_SGS_"+i);
		sld.lifeday = 0;
	}
	bDisableFastReload = false;
	LAi_LocationFightDisable(&Locations[FindLocation("LeFransua_town")], false);
	LocatorReloadEnterDisable("LeFransua_Exittown", "reload1_back", false);
	LocatorReloadEnterDisable("LeFransua_Exittown", "reload2_back", false);
}

void Saga_GiveCalendar() // осколки собраны - завершаем квесты баронов
{
	pchar.questTemp.Saga = "calendar"; // обновляем флаг центрального квеста
	DeleteAttribute(pchar, "questTemp.Saga.SharkHunt");
	DeleteAttribute(pchar, "questTemp.Saga.BaronReturn");
	DeleteAttribute(pchar, "questTemp.Saga.BarbTemptation");
	CloseQuestHeader("BaronReturn");
	CloseQuestHeader("BarbTemptation");
	AddQuestRecord("Saga", "25");
}
// <-- искушение Барбазона

// переход к квестам Завещание и Тени
void Saga_MineBanditsDestroyed(string qName) // Свенсон взял рудник самостоятельно
{
	int n;
	n = Findlocation("mine_exit");
	DeleteAttribute(&locations[n], "models.always.Gun1");
	DeleteAttribute(&locations[n], "models.always.Gun2");
	DeleteAttribute(&locations[n], "mine_bandits");
	LocatorReloadEnterDisable("mine_exit", "reload1_back", false);
	n = Findlocation("mine_01");
	DeleteAttribute(&locations[n], "mine_bandits");
	LocatorReloadEnterDisable("mine_01", "reload3_back", false);
	pchar.questTemp.Saga = "mine"; // обновляем флаг
	sld = characterFromId("Svenson");
	ChangeCharacterAddressGroup(sld, "Santacatalina_houseS1_residence", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
}

void Saga_MineBanditsAttackOver(string qName) // не пришел к совместному началу атаки
{
	pchar.quest.Saga_MinePrepareAttack.over = "yes"; //снять прерывание
	SetFunctionTimerCondition("Saga_MineBanditsDestroyed", 0, 0, 6, false); // таймер
}

void Saga_ReturnFromMine(string qName) // взяли рудник вместе
{
	int n;
	n = Findlocation("mine_exit");
	DeleteAttribute(&locations[n], "models.always.Gun2");
	n = Findlocation("mine");
	DeleteAttribute(&locations[n], "models.always.Gun");
	pchar.questTemp.Saga = "mine_1"; // обновляем флаг
	sld = characterFromId("Svenson");
	sld.dialog.currentnode = "First time";
	ChangeCharacterAddressGroup(sld, "Santacatalina_houseS1_residence", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
}

// --------------------------------- атака рудника бандитов -------------------------------------------
void Saga_MineBanditsPrepareAttack(string qName) // идем на рудник со Свенсоном
{
	pchar.quest.Saga_MineBanditsAttackOver.over = "yes"; //снять прерывание
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.GenQuest.CannotWait = true;//запрет ожидания
	// ставим людей Свенсона - 2 офицера + 12 солдат и самого Свенсона
	int iRank = 22+MOD_SKILL_ENEMY_RATE+5;
	int iScl = 70;
	for (i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Svensons_off_"+i, "mercen_2"+(i+3), "man", "man", iRank, PIRATE, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank+8, iScl+8, iScl+8, "blade_21", "pistol6", "bullet", iScl*2+50);
		if (i == 1)
		{
			sld.name = "Randolf";
			sld.lastname = "Berns";
			LAi_SetCheckMinHP(sld, 10, true, "");
		}
		else
		{
			sld.name = "Gregory";
			sld.lastname = "Couper";
		}
		sld.dialog.FileName = "Quest\Saga\OtherNPC.c";
		sld.dialog.currentnode = "Svensons_off";
		sld.greeting = "off_quest";
		LAi_SetStayType(sld);
		ChangeCharacterAddressGroup(sld, "shore53", "soldiers", "soldier"+(i+12));
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	for (i=1; i<=12; i++)
	{
		if (i == 11 || i == 12)
		{
			sld = GetCharacter(NPC_GenerateCharacter("Svensons_sold_"+i, "mush_ctz_"+(i-4), "man", "mushketer", iRank, PIRATE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Svensons_sold_"+i, "citiz_"+(40+i), "man", "man", iRank, PIRATE, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_10","blade_11"), "pistol3", "grapeshot", iScl*2+50);
		}
		sld.dialog.FileName = "Quest\Saga\OtherNPC.c";
		sld.dialog.currentnode = "Svensons_sold";
		sld.greeting = "off_quest";
		LAi_SetStayType(sld);
		ChangeCharacterAddressGroup(sld, "shore53", "soldiers", "soldier"+i);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	sld = characterFromId("Svenson");
	LAi_SetImmortal(sld, false);
	LAi_SetCheckMinHP(sld, 10, true, "");
	sld.dialog.currentnode = "mine_attack";
	ChangeCharacterAddressGroup(sld, "shore53", "soldiers", "soldier15");
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	// ставим наших бойцов
	for (i=1; i<=8; i++)
	{
		if (i == 1 || i == 2)
		{
			sld = GetCharacter(NPC_GenerateCharacter("Ourmine_sold_"+i, "mush_ctz_"+(i+4), "man", "mushketer", iRank, PIRATE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Ourmine_sold_"+i, "citiz_"+(30+i), "man", "man", iRank, PIRATE, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_10","blade_11"), "pistol1", "bullet", iScl*2+50);
		}
		LAi_SetActorType(sld);
		ChangeCharacterAddressGroup(sld, "shore53", "goto", "goto"+i);
		LAi_ActorFollowEverywhere(sld, "", -1);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
}

void Saga_PrepareMineAttackTail(string qName) // 
{
	chrDisableReloadToLocation = true;//закрыть локацию
	ref chr = characterFromId("Svenson");
	LAi_CharacterEnableDialog(chr);//разрешение диалога
	if (CheckAttribute(chr, "quest.mine01")) chr.dialog.currentnode = "mine_attack_8";
	else
	{
		if (CheckAttribute(chr, "quest.mine02")) chr.dialog.currentnode = "mine_attack_13";
		else 
		{
			if (CheckAttribute(chr, "quest.mine03")) chr.dialog.currentnode = "mine_attack_17";
			else chr.dialog.currentnode = "mine_attack_3";
		}
	}
	LAi_SetActorType(chr);
	LAi_ActorDialog(chr, pchar, "", -1, 0);
	if (!CheckAttribute(chr, "quest.mine03"))
	{
		for (i=1; i<=11; i++)
		{
			sld = characterFromId("Svensons_sold_"+i);
			LAi_SetActorType(sld);
			LAi_ActorFollowEverywhere(sld, "", -1);
		}
	}
	for (i=1; i<=8; i++)
	{
		sld = characterFromId("Ourmine_sold_"+i);
		LAi_SetActorType(sld);
		LAi_ActorFollowEverywhere(sld, "", -1);
	}
}

void Saga_MineAttackTail(string qName) // 
{
	chrDisableReloadToLocation = true;//закрыть локацию
}

void Saga_SvensonMineexitAttack(string qName) // 
{
	sld = characterFromId("Svenson");
	LAi_CharacterEnableDialog(sld);//разрешение диалога
	ChangeCharacterAddressGroup(sld, "mine_exit", "reload", "reload2_back");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	for (i=1; i<=2; i++)
	{
		if (GetCharacterIndex("Svensons_off_"+i) != -1)
		{
			sld = characterFromId("Svensons_off_"+i);
			if (pchar.questTemp.Saga.MineAttack == "soldiers" && i == 2) continue;
			else
			{
				ChangeCharacterAddressGroup(sld, "mine_exit", "reload", "reload2_back");
				LAi_SetWarriorType(sld);
				LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
			}
		}
	}
	for (i=1; i<=8; i++)
	{
		sld = characterFromId("Ourmine_sold_"+i);
		ChangeCharacterAddressGroup(sld, "mine_exit", "reload", "reload2_back");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	if (LAi_group_GetTarget(pchar) <= 0)
	{
		DoQuestCheckDelay("hide_weapon", 1.5);
		DoQuestCheckDelay("Saga_BanditsDestroyed", 0.5);
		for (i=1; i<=8; i++)
		{
			sld = characterFromId("Ourmine_sold_"+i);
			LAi_CharacterDisableDialog(sld);
			LAi_SetActorType(sld);
			LAi_ActorDialog(sld, pchar, "", -1, 0);
		}
	}
}

void Saga_MineGunAttack(string qName) // устанавливаем орудие
{
	chrDisableReloadToLocation = true;//закрыть локацию
	bDisableCharacterMenu = true;//лоченые интерфейсы
	InterfaceStates.Buttons.Save.enable = false;//запретить сохраняться
	locCameraLockNearHero(-5.0, 2.0, -5.0, 1000, true);
	DoQuestCheckDelay("Saga_MineSetMusic", 0.8);
	ChangeCharacterAddressGroup(pchar, "mine", "soldiers", "commander");
	for (i=1; i<=8; i++)
	{
		if (GetCharacterIndex("Ourmine_sold_"+i) != -1)
		{
			sld = characterFromId("Ourmine_sold_"+i);
			ChangeCharacterAddressGroup(sld, "mine", "soldiers", "gunteam"+i);
			if (i == 1)
			{
				LAi_SetStayType(sld);
				LAi_group_MoveCharacter(sld, "TMP_FRIEND");
				sld.MusketerDistance = 0;
			}
			else LAi_SetActorType(sld);
		}
	}
	if (GetCharacterIndex("Svensons_sold_12") != -1 && pchar.questTemp.Saga.MineAttack == "soldiers")
	{
		sld = characterFromId("Svensons_sold_12");
		ChangeCharacterAddressGroup(sld, "mine", "soldiers", "gunteam11");
		LAi_SetActorType(sld);
	}
	sld = characterFromId("Svensons_off_1");
	sld.dialog.currentnode = "gunner";
	sld.greeting = " ";
	ChangeCharacterAddressGroup(sld, "mine", "soldiers", "gunner");
	LAi_SetActorType(sld);
	DoQuestFunctionDelay("Saga_MineGunAttackStart", 5.0);
	LAi_SetActorType(pchar);
	int iRank = 22+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 80;
	for (i=1; i<=6; i++) // ставим вражеских мушкетеров
	{
		sld = GetCharacter(NPC_GenerateCharacter("Mine_Bandos_05_"+i, "mush_ctz_"+(rand(2)+10), "man", "mushketer", iRank, PIRATE, 0, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank, 80, 80, "", "mushket1", "cartridge", iScl*2+50);
		sld.MusketerDistance = 0; 
		LAi_SetWarriorType(sld);
		ChangeCharacterAddressGroup(sld, "mine", "goto", "mush"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
}

void Saga_MineGunAttackStart(string qName)
{
	LAi_SetPlayerType(pchar);
	locCameraResetState();
	sld = characterFromId("Svensons_off_1");
	LAi_ActorDialogNow(sld, pchar, "", -1);
}

void Saga_MineFightLock(string qName)
{
	CreateLocationParticles("ShipExplode", "rld", "warrior", 0, 0, 0, "boom");
	CreateLocationParticles("blast_dirt", "rld", "warrior", 0, 0, 0, "");
	CreateLocationParticles("blast_inv", "rld", "warrior", 0, 0, 0, "");
	LAi_KillCharacter(pchar);
}

void Saga_MineAttackMines(string qName)
{
	DoQuestReloadToLocation("mine_mines", "reload", "reload1", "Saga_MineAttackMinesLock");
	int iRank = 22+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 70;
	LAi_group_Register("Mine_enemy");
	LAi_group_SetLookRadius("Mine_enemy", 20);
	LAi_group_SetHearRadius("Mine_enemy", 15);		
	LAi_group_SetHearRadius(LAI_GROUP_PLAYER, 5);
	for (i=1; i<=2; i++) // ставим вражеских мушкетеров
	{
		sld = GetCharacter(NPC_GenerateCharacter("Mine_Bandos_mines_"+i, "mush_ctz_"+(rand(2)+10), "man", "mushketer", iRank, PIRATE, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank, 60, 60, "", "mushket1", "cartridge", iScl*2+50);
		sld.MusketerDistance = 0; 
		LAi_SetWarriorType(sld);
		ChangeCharacterAddressGroup(sld, "mine_mines", "soldiers", "soldier"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "Mine_enemy");
	}
	for (i=3; i<=14; i++) // бандюки
	{
		if (i == 4 || i == 6 || i == 8) continue;
		sld = GetCharacter(NPC_GenerateCharacter("Mine_Bandos_mines_"+i, "citiz_"+(rand(9)+51), "man", "man", iRank, PIRATE, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_10", "pistol1", "bullet", iScl*2+50);
		ChangeCharacterAddressGroup(sld, "mine_mines", "goto", "goto"+i);
		LAi_SetWarriorType(sld);
		LAi_warrior_SetStay(sld, true);
		LAi_group_MoveCharacter(sld, "Mine_enemy");
	}
	for (i=1; i<=5; i++) // каторжники
	{
		sld = GetCharacter(NPC_GenerateCharacter("MineConvict_"+i, "prizon_"+(rand(7)+1), "man", "man_B", 10, PIRATE, 1, true, "native"));
		SetFantomParamFromRank(sld, 10, true);
		sld.dialog.Filename = "Quest\Saga\OtherNPC.c";
		sld.dialog.currentnode = "convict";
		sld.greeting = "convict";
		GiveItem2Character(sld, RandPhraseSimple("slave_01","topor_05"));
		EquipCharacterbyItem(sld, RandPhraseSimple("slave_01","topor_05"));
		ChangeCharacterAddressGroup(sld, "mine_mines", "monsters", "convict"+i);
		LAi_SetStayType(sld);
		LAi_group_MoveCharacter(sld, "TMP_FRIEND");
	}
}

void Saga_FindMineLetter(string qName)
{
	pchar.quest.Saga_MineAttack_09.win_condition.l1 = "location";
	pchar.quest.Saga_MineAttack_09.win_condition.l1.location = "mine";
	pchar.quest.Saga_MineAttack_09.function = "Saga_FindMineGold";
}

void Saga_FindMineGold(string qName)
{
	sld = characterFromId("Svenson");
	sld.dialog.currentnode = "mine_attack_37";
	ChangeCharacterAddressGroup(sld, "mine", "reload", "reload4");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}
// <-- атака рудника

// ----------------------------------------завещание Шарпа-----------------------------------------------
void Saga_GoldForLoxly(string qName) // нужны деньги для адвоката
{
	LocatorReloadEnterDisable("SantaCatalina_houseS1", "reload2", false); // открыть кабинет Свенсона
	LocatorReloadEnterDisable("Pirates_town", "reload3_back", false); // открыть резиденцию Исла Тесоро
	// садим Акулу в резиденцию
	if (!CheckAttribute(pchar, "questTemp.Saga.DodsonDie"))
	{
		sld = characterFromId("Dodson");
		sld.dialog.currentnode = "First time";
		ChangeCharacterAddressGroup(sld, "Pirates_townhall", "sit", "sit1");
		sld.standUp = true; //вставать и нападать на врага
		LAi_SetHuberType(sld);
		LAi_group_MoveCharacter(sld, "PIRATE_CITIZENS");
		LAi_SetImmortal(sld, true);
		sld.watchBoxes = true; 
	}
	else // садим Тиракса, а на его место - Бернара Венсана
	{
		sld = characterFromId("Terrax");
		ChangeCharacterAddressGroup(sld, "Pirates_townhall", "sit", "sit1");
		sld = characterFromId("Vensan");
		sld.dialog.FileName = "Mayor\LaVega_Mayor.c";
		sld.dialog.currentnode = "I_know_you_good";
		sld.greeting = "town_pirate";
		ChangeCharacterAddressGroup(sld, "LaVega_townhall", "sit", "sit1");
		sld.standUp = true; //вставать и нападать на врага
		LAi_SetHuberType(sld);
		LAi_group_MoveCharacter(sld, "PIRATE_CITIZENS");
		LAi_SetImmortal(sld, true);
		sld.watchBoxes = true; 
	}
}

void Saga_CreateMolliganInWorld()
{
	int iRank = 22+MOD_SKILL_ENEMY_RATE;
	int iScl = 70;
	int iCannon = CANNON_TYPE_CANNON_LBS24;
	int iDays = 15;
	if (sti(pchar.rank) < 15 || MOD_SKILL_ENEMY_RATE < 7) iCannon = CANNON_TYPE_CANNON_LBS20;
	sld = GetCharacter(NPC_GenerateCharacter("Molligan", "Molligan", "man", "man", iRank, ENGLAND, iDays, true, "quest"));
	sld.name = "Paul";
	sld.lastname = "Molligan";
	sld.Dialog.Filename = "Quest\Saga\OtherNPC.c";
	sld.DeckDialogNode = "Molligan";
	FantomMakeSmallSailor(sld, SHIP_EASTINDIAMAN, "Oyster", iCannon, iScl, iScl, iScl, iScl, iScl);
	SetCharacterPerk(sld, "CriticalShoot");
	SetCharacterPerk(sld, "LongRangeShoot");
	SetCharacterPerk(sld, "ShipDefenseProfessional");
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_13", "pistol1", "bullet", iScl*2+50);
	sld.Ship.Mode = "pirate";	
	sld.AlwaysSandbankManeuver = true;
	sld.AnalizeShips = true; 
	sld.DontRansackCaptain = true; 
	if (MOD_SKILL_ENEMY_RATE > 7) sld.MultiFighter = 1.5; // мультифайтер
	RealShips[sti(sld.Ship.Type)].ship.upgrades.hull = 1; //всегда первый - это будет важно потом
	SetCharacterGoods(sld, GOOD_EBONY, 50);
	SetCharacterGoods(sld, GOOD_MAHOGANY, 80);
	SetCharacterGoods(sld, GOOD_SANDAL, 100);//положить бакаут
	//в морскую группу кэпа
	string sGroup = "Molligan_Group";
	Group_FindOrCreateGroup(sGroup);
	Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
	Group_LockTask(sGroup);
	Group_AddCharacter(sGroup, sld.id);
	Group_SetGroupCommander(sGroup, sld.id);
	if (rand(1) == 0) sld.cityShore = "Shore55";
	else sld.cityShore = "Shore53";
	sld.mapEnc.type = "trade";
	//выбор типа кораблика на карте
	sld.mapEnc.worldMapShip = "quest_ship";
	sld.mapEnc.Name = "'Oyster'";
	Map_CreateTrader(sld.cityShore, "Bridgetown", sld.id, iDays);
	
	SetFunctionTimerCondition("Saga_MolliganInWorldOver", 0, 0, iDays+1, false);
	//на захват либо потопление абордажем
	pchar.quest.Saga_Molligan_Abordage.win_condition.l1 = "Character_Capture";
	pchar.quest.Saga_Molligan_Abordage.win_condition.l1.character = "Molligan";
	pchar.quest.Saga_Molligan_Abordage.function = "Saga_MolliganAbordage";//взяли на абордаж
	//на потопление орудиями
	pchar.quest.Saga_Molligan_Sink.win_condition.l1 = "Character_sink";
	pchar.quest.Saga_Molligan_Sink.win_condition.l1.character = "Molligan";
	pchar.quest.Saga_Molligan_Sink.function = "Saga_MolliganSink";//потопили
}		

void Saga_MolliganInWorldOver(string qName) // упустили Моллигана
{
	pchar.questTemp.Saga.Bakaut = "fail";
	AddQuestRecord("Testament", "4");
	pchar.questTemp.Saga = "removebakaut"; // флаг на адвоката
}

void Saga_MolliganAttack() // атака Моллигана - обработка в АИ
{
	log_info("Pole Molligan is attacking you!");
	PlaySound("interface\notebook.wav");
	sld = characterFromId("Molligan");
	sld.AlwaysEnemy = true;
	SetCharacterRelationBoth(sti(GetCharacterIndex("Molligan")), GetMainCharacterIndex(), RELATION_ENEMY);
	Group_SetTaskAttack("Molligan_Group", PLAYER_GROUP);
	Group_LockTask("Molligan_Group");
	UpdateRelations();
	RefreshBattleInterface();
}

void Saga_MolliganCriticalAttack() // атакуем Моллигана - обработка в АИ
{
	DeleteAttribute(pchar, "questTemp.Saga.Molligan.friend");
	log_info("A critical hit of chain shots!");
	sld = characterFromId("Molligan");
	PlayStereoSound("Sea Battles\sdavl_kriki_005.wav");
	int iCrew = makeint(sti(sld.Ship.Crew.Quantity)*0.67); 
	SetCrewQuantityOverMax(sld, iCrew); // сносим треть команды
	AddCrewMorale(sld, -20); // команда врага деморализована внезапным и подлым нападением
	sld.AlwaysEnemy = true;
	SetCharacterRelationBoth(sti(GetCharacterIndex("Molligan")), GetMainCharacterIndex(), RELATION_ENEMY);
	Group_SetTaskAttack("Molligan_Group", PLAYER_GROUP);
	Group_LockTask("Molligan_Group");
	UpdateRelations();
	RefreshBattleInterface();
}

void Saga_MolliganAbordage(string qName) //проверяем Устрицу после боя
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.Saga_MolliganInWorldOver.over = "yes"; //снять прерывание
	pchar.quest.Saga_Molligan_Sink.over = "yes"; //снять прерывание
	Group_DeleteGroup("Molligan_Group");
	int iUst = 0;
	string sTemp;
	for(i = 0; i < COMPANION_MAX; i++)
	{
		iTemp = GetCompanionIndex(PChar, i);
		if(iTemp > 0)
		{
			sld = GetCharacter(iTemp);
			if(sti(RealShips[sti(sld.ship.type)].basetype) == SHIP_EASTINDIAMAN && sld.ship.name == "Oyster") iUst = 1;
		}
	} // есть ли у нас Устрица
	if (iUst == 1) pchar.questTemp.Saga.Oyster = "true"; // есть
	if (CheckCharacterItem(pchar, "letter_parol")) // нашел записку
	{
		sTemp = "I have found a note with coordinates in Milligan's cabin. There is a mysterious buyer waiting. I can sail to him and, perhaps, make a good coin. Or I can deliver the cargo to Svensson.";
		pchar.quest.Saga_RozencraftWG.win_condition.l1 = "location";
		pchar.quest.Saga_RozencraftWG.win_condition.l1.location = "Trinidad";
		pchar.quest.Saga_RozencraftWG.function = "Saga_CheckRozencraftWG";
		SetFunctionTimerCondition("Saga_RozencraftWGOver", 0, 0, 8, false);
		sld = ItemsFromID("letter_parol");
		sld.price = 10;
	}
	else sTemp = "Time to return to Jan Svensson.";
	AddQuestRecord("Testament", "6");
	AddQuestUserData("Testament", "sText", sTemp);
	pchar.questTemp.Saga.Bakaut = "find";
	pchar.questTemp.Saga = "sellbakaut";
}

void Saga_MolliganSink(string qName) // потопили Моллигана
{
	pchar.quest.Saga_MolliganInWorldOver.over = "yes"; //снять прерывание
	pchar.quest.Saga_Molligan_Abordage.over = "yes"; //снять прерывание
	Group_DeleteGroup("Molligan_Group");
	pchar.questTemp.Saga.Bakaut = "fail";
	AddQuestRecord("Testament", "5");
	pchar.questTemp.Saga = "removebakaut"; // флаг на адвоката
}

void Saga_RozencraftWGOver(string qName) // снять Розенкрафта
{
	pchar.quest.Saga_RozencraftWG.over = "yes"; //снять прерывание
}

void Saga_RemoveOuster() //удаление Устрицы
{
	if(sti(RealShips[sti(pchar.ship.type)].basetype) == SHIP_EASTINDIAMAN && pchar.ship.name == "Oyster")
	{
		pchar.Ship.Type = GenerateShipExt(SHIP_TARTANE, true, pchar);
		pchar.Ship.name = "Boat";
		SetBaseShipData(pchar);
		SetCrewQuantityOverMax(PChar, 0);//сажаем на тартану
	}
	else
	{
		for(i = 1; i < COMPANION_MAX; i++)
		{
			int iTemp = GetCompanionIndex(PChar, i);
			if(iTemp > 0)
			{
				sld = GetCharacter(iTemp);
				if(sti(RealShips[sti(sld.ship.type)].basetype) == SHIP_EASTINDIAMAN && sld.ship.name == "Oyster")
				{
					pchar.GanQuest.CompanionIndex = sld.Index;
					sld = GetCharacter(sti(pchar.GanQuest.CompanionIndex));
					RemoveCharacterCompanion(PChar, sld);
					AddPassenger(PChar, sld, false);
				}
			}
		}
    }
}

void Saga_CheckRozencraftWG(string qName) // устанавливаем Розенкрафта
{
	int iUst = 0;
	for(i = 0; i < COMPANION_MAX; i++)
	{
		iTemp = GetCompanionIndex(PChar, i);
		if(iTemp > 0)
		{
			sld = GetCharacter(iTemp);
			if(sti(RealShips[sti(sld.ship.type)].basetype) == SHIP_EASTINDIAMAN && sld.ship.name == "Oyster") iUst = 1;
		}
	} // есть ли у нас Устрица
	// двойная защита от жухления геймеров
	if (iUst == 1 && CheckAttribute(pchar, "questTemp.Saga.Oyster")) pchar.questTemp.Saga.Oyster = "cantalk";
	Group_FindOrCreateGroup("Rozencraft_Group");
	Group_SetType("Rozencraft_Group", "war");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+10;
	if (iRank > 40) iRank = 40;
	int iScl = 100;
	sld = GetCharacter(NPC_GenerateCharacter("Rozencraft", "Rozencraft", "man", "man", iRank, HOLLAND, -1, true, "quest"));
	sld.name = "Mikhael";
	sld.lastname = "Rozencraft";
	sld.Dialog.Filename = "Quest\Saga\Rozencraft.c";
	sld.DeckDialogNode = "Rozencraft";
	FantomMakeSmallSailor(sld, SHIP_GALEON_H, "", CANNON_TYPE_CANNON_LBS32, iScl, iScl, iScl, iScl, iScl);
	SetCharacterPerk(sld, "CriticalShoot");
	SetCharacterPerk(sld, "LongRangeShoot");
	SetCharacterPerk(sld, "CannonProfessional");
	SetCharacterPerk(sld, "ShipDefenseProfessional");
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_21", "pistol5", "bullet", iScl*2+100);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "war";
	Character_SetAbordageEnable(sld, false);
	if (CheckAttribute(pchar, "questTemp.Saga.Oyster") && pchar.questTemp.Saga.Oyster == "cantalk") sld.AlwaysFriend = true;
	SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("Rozencraft_Group", "Rozencraft");
	Group_SetGroupCommander("Rozencraft_Group", "Rozencraft");
	Group_SetTaskNone("Rozencraft_Group");//нет задачи
	Group_SetAddress("Rozencraft_Group", "Trinidad", "quest_ships", "quest_ship_8");
	Group_LockTask("Rozencraft_Group");
	
	pchar.quest.Saga_Rozencraft_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Saga_Rozencraft_AfterBattle.win_condition.l1.group = "Rozencraft_Group";
	pchar.quest.Saga_Rozencraft_AfterBattle.function = "Saga_RozencraftAfterBattle";
	pchar.quest.Saga_Rozencraft_GetOut.win_condition.l1 = "MapEnter";
    pchar.quest.Saga_Rozencraft_GetOut.function = "Saga_RozencraftGetOut";
}

void Saga_RozencraftAfterBattle(string qName) //взял и напал зачем-то - накажем
{
	pchar.quest.Saga_Rozencraft_GetOut.over = "yes"; //снять прерывание
	Group_DeleteGroup("Rozencraft_Group");
	ChangeCharacterNationReputation(pchar, HOLLAND, -15);
	DeleteAttribute(pchar, "GenQuest.Bakaut"); // конец генератора
}

void Saga_RozencraftGetOut(string qName) //ушел на карту - галеон тоже ушел
{
	pchar.quest.Saga_Rozencraft_AfterBattle.over = "yes"; //снять прерывание
	Group_DeleteGroup("Rozencraft_Group");
}

void Saga_RemainGoldLoxly(string qName) // просрочили заплатить адвокату
{
	sld = characterFromId("Loxly");
	sld.dialog.currentnode = "saga_40";
	LocatorReloadEnterDisable("PortRoyal_town", "houseSp4", true); // закроем вход к Локсли
	ChangeCharacterNationReputation(pchar, ENGLAND, -10);
}

//----------------------------------------генератор торговли бакаутом-------------------------------------
void Bakaut_RozencraftDie(string qName) // убит квестодатель - нет квеста
{
	log_testinfo("Квестодатель убит - генератор деактивирован!");
	Group_DeleteGroup("Rozencraft_Group");
	DeleteAttribute(pchar, "GenQuest.Bakaut"); // конец генератора
}

void Bakaut_RozencraftRemove(string qName) // галеон ушел в одно из мест
{
	int i = rand(5);
	switch(i)
	{
		case 0: pchar.GenQuest.Bakaut.Island = "Curacao"; break;
		case 1: pchar.GenQuest.Bakaut.Island = "Cumana"; break;
		case 2: pchar.GenQuest.Bakaut.Island = "Hispaniola1"; break;
		case 3: pchar.GenQuest.Bakaut.Island = "Portobello"; break;
		case 4: pchar.GenQuest.Bakaut.Island = "Guadeloupe"; break;
		case 5: pchar.GenQuest.Bakaut.Island = "Cuba2"; break;
	}
	pchar.GenQuest.Bakaut.Value = rand(5)*10+50; // мин объем следующей поставки
	pchar.GenQuest.Bakaut.DaysQty = rand(15)+15; // сколько дней будет крейсировать после получения наводки
	Group_SetAddress("Rozencraft_Group", pchar.GenQuest.Bakaut.Island, "quest_ships", "quest_ship_"+(4+rand(4)));
	DeleteAttribute(pchar, "GenQuest.Bakaut.Info");
}

void Bakaut_SvensonAttrReturn(string qName) // вертаем атрибут Свенсону
{
	sld = characterFromId("Svenson");
	sld.quest.trade_bakaut = "true";
}
// <-- генератор торговли бакаутом

//----------------------------------------генератор торговли канатами---------------------------------021012
void Ropes_FadeyAttrReturn(string qName) // вертаем атрибут Фадею
{
	sld = characterFromId("Fadey");
	sld.quest.ropes = "true";
}

//----------------------------------------генератор торговли шелком---------------------------------161012
void Silk_TraderAttrReturn(string qName) // вертаем атрибут
{
	sld = characterFromId("HWICBoss");
	sld.quest.silk = "true";
}

// ----------------------------------------тени прошлого-----------------------------------------------
void Saga_SetBaldMaggy(string qName) // ставим плешивую мэгги
{
	bQuestDisableMapEnter = true;
	Group_FindOrCreateGroup("BaldMaggy_Group");
	Group_SetType("BaldMaggy_Group", "trade");
	sld = GetCharacter(NPC_GenerateCharacter("Benson", "trader_10", "man", "man", 15, ENGLAND, -1, false, "quest"));
	sld.name = "Jim";
	sld.lastname = "Benson";
	sld.Dialog.Filename = "Quest\Saga\OtherNPC.c";
	sld.DeckDialogNode = "Benson";
	FantomMakeCoolSailor(sld, SHIP_BARKENTINE, "Bald Maggy", CANNON_TYPE_CANNON_LBS12, 40, 40, 40);
	FantomMakeCoolFighter(sld, 15, 40, 40, "blade_10", "pistol1", "bullet", 50);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "trade";
	sld.Abordage.Enable = true;
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true; 
	LAi_SetImmortal(sld, true); // сплошная защита от дурака
	Group_AddCharacter("BaldMaggy_Group", "Benson");
	Group_SetGroupCommander("BaldMaggy_Group", "Benson");
	Group_SetTaskNone("BaldMaggy_Group");//нет задачи
	Group_SetAddress("BaldMaggy_Group", "Antigua", "quest_ships", "quest_ship_1");
	Group_LockTask("BaldMaggy_Group");
}

void Saga_SetBakerBoat(string qName) // ставим баркас с Бейкером - обработка в АИ
{
	bQuestDisableMapEnter = true;
	pchar.nation = FRANCE; // принудительно
	pchar.DisableChangeFlagMode = true; // запретить менять флаг
	pchar.questTemp.Saga.Shadows.Baker = "true";
	Group_FindOrCreateGroup("Baker_Group");
	Group_SetType("Baker_Group", "trade");
	sld = GetCharacter(NPC_GenerateCharacter("Baker_Cap", "trader_1", "man", "man", 10, ENGLAND, -1, false, "quest"));
	sld.name = "";
	sld.lastname = "";
	sld.FaceId = 333; // пустой кораблик
	FantomMakeCoolSailor(sld, SHIP_TARTANE, " ", CANNON_TYPE_NONECANNON, 10, 10, 10);
	SetCrewQuantityOverMax(sld, 0);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "trade";
	sld.DontDeskTalk = true;
	sld.Abordage.Enable = true;
	sld.ShipEnemyDisable = true; 
	SetCharacterRelationBoth(sti(sld.index), GetMainCharacterIndex(), RELATION_FRIEND); // тестить
	LAi_SetImmortal(sld, true); // сплошная защита от дурака
	sld.ship.masts.mast2 = 1;
	ref realShip = GetRealShip(GetCharacterShipType(sld));
	realShip.lowpolycrew = 0; // убрать матросиков с палубы корабля
	Group_AddCharacter("Baker_Group", "Baker_Cap");
	Group_SetGroupCommander("Baker_Group", "Baker_Cap");
	Group_SetTaskNone("Baker_Group");//нет задачи
	Group_SetAddress("Baker_Group", "Dominica", "quest_ships", "quest_ship_8");
	Group_LockTask("Baker_Group");
}

void Saga_BakerToCabin()
{
	DeleteAttribute(pchar, "questTemp.Saga.Shadows.Baker");
	DeleteAttribute(pchar, "DisableChangeFlagMode");
	Log_Info("Raymond Baker is onboard");
	PlaySound("interface\notebook.wav");
	AddQuestRecord("Shadows", "4");
	sld = GetCharacter(NPC_GenerateCharacter("Baker", "Baker", "man", "man_B", 1, ENGLAND, -1, false, "quest"));
	sld.name = "Raymond";
	sld.lastname = "Baсker";
	sld.greeting = "baker";
    sld.Dialog.Filename = "Quest\Saga\Baker.c";
	sld.dialog.currentnode = "baker";
	sld.rank = 28;
	LAi_SetHP(sld, 150, 150); 
	SetSelfSkill(sld, 20, 20, 70, 20, 40);
	SetShipSkill(sld, 20, 40, 10, 10, 15, 5, 8, 95, 50);
	SetSPECIAL(sld, 6, 6, 7, 6, 9, 6, 5);
	SetCharacterPerk(sld, "Doctor1");
	SetCharacterPerk(sld, "Doctor2");
	SetCharacterPerk(sld, "ShipSpeedUp");
	SetCharacterPerk(sld, "BasicCommerce");
	SetCharacterPerk(sld, "BasicDefense");
	SetCharacterPerk(sld, "CriticalHit");
	SetCharacterPerk(sld, "HardHitter");
	SetCharacterPerk(sld, "Gunman");
	GiveItem2Character(sld, "blade_11");
	sld.equip.blade = "blade_11";
	GiveItem2Character(sld, "pistol1");
	EquipCharacterbyItem(sld, "pistol1");
	LAi_SetCharacterUseBullet(sld, "bullet");
    TakeNItems(sld, "bullet", 20);
	AddItems(sld, "gunpowder", 20);
	int iShipType = GetCharacterShipType(pchar);
	ref rShip = GetRealShip(iShipType);
	sTemp = "My_" + rShip.CabinType;
	sld = characterFromId("Baker");
	ChangeCharacterAddressGroup(sld, sTemp, "rld", "aloc0");
	LAi_SetStayType(sld);
	AddPassenger(pchar, sld, false);
	SetCharacterRemovable(sld, false);
}
		
void Saga_JessikaIsland(string qName) // вышли на риф
{
	// ориентируем на день в обязательном порядке
	int iTime, iAddTime;
	iTime = sti(environment.time);
	if (iTime >= 21) iAddTime = 24 - iTime + 12;
	if (iTime < 7) iAddTime = 12 - iTime;
	if (iTime >= 7 && iTime < 21) iAddTime = 24  + 12 - iTime;
	StoreDayUpdate();
	WaitDate("",0,0,0,iAddtime,5);
	RecalculateJumpTable();
	RefreshWeather();
	RefreshLandTime();
	// разложим скелетов
	int iRank = 22+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 65;
	for (int i=1; i<=6; i++)
	{			
		sld = GetCharacter(NPC_GenerateCharacter("Reef_skeleton_"+i, "skel"+(rand(3)+1), "skeleton", "skeleton", iRank, PIRATE, -1, false, "quest"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_13", "", "", iScl);
		if (MOD_SKILL_ENEMY_RATE > 4) sld.cirassId = Items_FindItemIdx("cirass3");
		if (i > 5)
		{
			sld.cirassId = Items_FindItemIdx("cirass1");
			if (MOD_SKILL_ENEMY_RATE > 4)
			{
				float fMft = MOD_SKILL_ENEMY_RATE/10;
				sld.MultiFighter = 0.8+fMft; // мультифайтер
			}
		}
		LAi_SetActorType(sld);
		LAi_ActorSetLayMode(sld);
		ChangeCharacterAddressGroup(sld, "shore67", "quest", "skeleton"+i);
		LAi_SetImmortal(sld, true);
	}
	// заставим исследовать риф
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.GenQuest.CannotWait = true;//запрет ожидания
	pchar.quest.Saga_Jessika_Reef.win_condition.l1 = "locator";
	pchar.quest.Saga_Jessika_Reef.win_condition.l1.location = "shore67";
	pchar.quest.Saga_Jessika_Reef.win_condition.l1.locator_group = "quest";
	pchar.quest.Saga_Jessika_Reef.win_condition.l1.locator = "jessika";
	pchar.quest.Saga_Jessika_Reef.function = "Saga_JessikaReef";
}

void Saga_JessikaReef(string qName) // исследовали риф
{
	chrDisableReloadToLocation = false;
	DeleteAttribute(pchar, "GenQuest.CannotWait");//можно мотать время
	AddQuestRecord("Shadows", "7");
	// прерывание на ночь
	pchar.quest.Saga_Jessika_Stay.win_condition.l1 = "Hour";
	pchar.quest.Saga_Jessika_Stay.win_condition.l1.start.hour = 0.00;
	pchar.quest.Saga_Jessika_Stay.win_condition.l1.finish.hour = 2.00;
	pchar.quest.Saga_Jessika_Stay.win_condition.l2 = "location";
	pchar.quest.Saga_Jessika_Stay.win_condition.l2.location = "shore67";
	pchar.quest.Saga_Jessika_Stay.function = "Saga_CreateJessikaGhost";
}

void Saga_CreateJessikaGhost(string qName) // ставим Джессику
{
	ResetSoundScheme();
	ref chr = &Locations[FindLocation(pchar.location)];
	chr.type = "seashore";
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.GenQuest.CannotWait = true;//запрет ожидания
	sld = characterFromId("Svenson");
	if (CheckAttribute(sld, "quest.jessika")) DeleteAttribute(sld, "quest.jessika");
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = MOD_SKILL_ENEMY_RATE*6;
	int iAdd = MOD_SKILL_ENEMY_RATE*60;
	// ставим Джесс
	pchar.questTemp.Saga.Attack = true; // обработка в АИ
	pchar.questTemp.Saga.Jess_Fightstage = "first";
	sld = GetCharacter(NPC_GenerateCharacter("Jessika", "Ghost_1", "woman", "jess", 1, PIRATE, -1, false, "quest"));
	sld.name = "Jessica";
	sld.lastname = "Rose";
	sld.greeting = "jessika_0";
    sld.Dialog.Filename = "Quest\Saga\Jessika.c";
	sld.dialog.currentnode = "reef";
	sld.monster = true; // признак нежити
	sld.rank = 50;
	LAi_SetHP(sld, 250+iAdd, 250+iAdd); 
	SetSelfSkill(sld, 40+iScl, 40+iScl, 40+iScl, 40+iScl, 40+iScl);
	SetShipSkill(sld, 1, 50, 70, 70, 90, 50, 70, 50, 100);
	SetSPECIAL(sld, 10, 10, 10, 3, 3, 10, 10);
	if (MOD_SKILL_ENEMY_RATE > 4)
	{
		SetCharacterPerk(sld, "Energaiser");
		SetCharacterPerk(sld, "SwordplayProfessional");
		SetCharacterPerk(sld, "HardHitter");
	}
	float fMft = MOD_SKILL_ENEMY_RATE/10;
	sld.MultiFighter = 1.0+fMft; // мультифайтер
	SetCharacterPerk(sld, "BasicDefense");
	SetCharacterPerk(sld, "AdvancedDefense");
	SetCharacterPerk(sld, "CriticalHit");
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "Sliding");
	SetCharacterPerk(sld, "BladeDancer");
	SetCharacterPerk(sld, "Gunman");
	SetCharacterPerk(sld, "GunProfessional");
	SetCharacterPerk(sld, "ShipSpeedUp");
	SetCharacterPerk(sld, "ShipTurnRateUp");
	SetCharacterPerk(sld, "StormProfessional");
	SetCharacterPerk(sld, "WindCatcher");
	SetCharacterPerk(sld, "SailsMan");
	SetCharacterPerk(sld, "HullDamageUp");
	SetCharacterPerk(sld, "SailsDamageUp");
	SetCharacterPerk(sld, "SailsDamageUp");
	SetCharacterPerk(sld, "CrewDamageUp");
	SetCharacterPerk(sld, "CriticalShoot");
	SetCharacterPerk(sld, "LongRangeShoot");
	SetCharacterPerk(sld, "CannonProfessional");
	SetCharacterPerk(sld, "LongRangeGrappling");
	SetCharacterPerk(sld, "GrapplingProfessional");
	GiveItem2Character(sld, "blade_25");
	sld.equip.blade = "blade_25";
	sld.cirassId = Items_FindItemIdx("cirass1"); 
	if (MOD_SKILL_ENEMY_RATE < 5) sld.cirassId = Items_FindItemIdx("cirass3"); 
	GiveItem2Character(sld, "letter_beatriss"); // дать письмо
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	LAi_SetCheckMinHP(sld, 10, true, "Saga_JessikaFirstKick"); // первый фокус
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "shore67", "quest", "jessika");
}

void Saga_CheckEnemyDistance() // расчет дистанции до локатора с Джесс
{
	float fdist;
	if (pchar.location == "shore67")
	{
		if (pchar.questTemp.Saga.Jess_Fightstage == "first")
		{
			if (GetCharacterDistByLoc(pchar, "quest", "jessika", &fdist))
			{
				if (fdist < 1.5) Saga_JessikaAttack();
			}
		}
		if (pchar.questTemp.Saga.Jess_Fightstage == "next")
		{
			if (GetCharacterDistByLoc(pchar, "quest", sTotalTemp, &fdist))
			{
				if (fdist < iTotalTemp) Saga_JessikaTalkAttack();
			}
		}
	}
}

void Saga_JessikaAttack() // Джесс атакует - подраться придется в любом случае
{
	DeleteAttribute(pchar, "questTemp.Saga.Attack");
	sld = characterFromId("Jessika");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	SetMusic("music_teleport");
}

void Saga_JessikaTalkAttack() // переходы между стадиями
{
	DoQuestCheckDelay("hide_weapon", 0.5);//убрать оружие
	DeleteAttribute(pchar, "questTemp.Saga.Attack");
	SetMusic("music_teleport");
	sld = characterFromId("Jessika");
	LAi_SetActorType(sld);
	LAi_ActorDialogNow(sld, pchar, "", -1);
}

void Saga_JessFireStep(string qName) // сунулся в огонь
{
	LAi_KillCharacter(pchar);
}

void Saga_FindBeatrissLetter(string qName) // нашли письмо Беатрисс
{
	chrDisableReloadToLocation = false;//открыть локацию
	DeleteAttribute(pchar, "GenQuest.CannotWait");//можно мотать время
	AddQuestRecord("Shadows", "8");
	AddQuestRecordInfo("Letter_beatriss", "1");
	sld = ItemsFromID("letter_jess");
	sld.price = 1; // страницу можно выкладывать 270912 
}

void Saga_JessikaOnJamaica(string qName) // прибытие на Ямайку
{
	bQuestDisableMapEnter = true;//закрыть карту - чтобы не ушел
	pchar.GenQuest.MapClosedNoBattle = true;
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	sld = characterFromId("Jessika");
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "shore36", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Saga_JessikaShoreWait(string qName) // прерывание на итоговую встречу
{
	pchar.quest.Saga_Jessika_Final.win_condition.l1 = "Hour";
	pchar.quest.Saga_Jessika_Final.win_condition.l1.start.hour = 0.00;
	pchar.quest.Saga_Jessika_Final.win_condition.l1.finish.hour = 2.00;
	pchar.quest.Saga_Jessika_Final.win_condition.l2 = "location";
	pchar.quest.Saga_Jessika_Final.win_condition.l2.location = "shore36";
	pchar.quest.Saga_Jessika_Final.function = "Saga_JessikaOnJamaica";
}
// <-- Тени прошлого

// ------------------------------- деактивация Саги в случае провалов ---------------------------------------
void Saga_CenturionFail() // провал после потопления Центуриона
{
	// Даниэль - к разговору
	sld = characterFromId("Danielle");
	sld.quest.talk = "failcenturion";
	pchar.quest.Saga_Fail_centurion.win_condition.l1 = "Location_Type";
	pchar.quest.Saga_Fail_centurion.win_condition.l1.location_type = "town";
	pchar.quest.Saga_Fail_centurion.function = "Saga_DannyTalk";
	// Элен - к разговору
	sld = characterFromId("Helena");
	sld.quest.talk = "failcenturion";
	pchar.quest.Saga_Fail_centurion1.win_condition.l1 = "Location_Type";
	pchar.quest.Saga_Fail_centurion1.win_condition.l1.location_type = "town";
	pchar.quest.Saga_Fail_centurion1.function = "Saga_HelenaTalk";
	pchar.questTemp.Saga = "fail_centurion"; // для Свенсона
	// Левассера - к барьеру!
	sld = characterFromId("Tortuga_Mayor");
	LAi_LoginInCaptureTown(sld, true);
	pchar.questTemp.Sharlie.Hardcore_Tortuga = "true";
	// Jason Долго и счастливо
	pchar.questTemp.Saga.CenturionSink = "true";
}

void Saga_HelenaTalk(string qName) // говорилка Элен
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Helena");	
	switch (sld.quest.talk)
	{
		case "failcenturion": sld.dialog.currentnode = "failcenturion"; break; // потопили Центурион
		case "late_l1": sld.dialog.currentnode = "late_l1"; break; // проверка первая
		case "late_l2": sld.dialog.currentnode = "late_l2"; break; // проверка после квестов баронов
		case "late_l3": sld.dialog.currentnode = "late_l3"; break; // 3-6 проверки у адвоката
	}
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

// провал по времени
void Saga_TimeOver(string qName)//общий вызов провала по времени
{
	pchar.questTemp.Saga.Late = true; //атрибут - Сага провалена по времени
	// Левассера - к барьеру!
	sld = characterFromId("Tortuga_Mayor");
	LAi_LoginInCaptureTown(sld, true);
	pchar.questTemp.Sharlie.Hardcore_Tortuga = "true";
}

void Saga_ChangesIslatesoro() // вызов перестановки на Исла-Тесоро
{
	int i = FindColony("Pirates");
	colonies[i].nation = ENGLAND;
	string sColony = "Pirates_town";
	worldMap.labels.(sColony).icon = ENGLAND;
	ref rloc = &Locations[FindLocation("Pirates_town")];
	rloc.EngBase = true;
	LocatorReloadEnterDisable("Pirates_town", "reload3_back", false); // открыть резиденцию
	
	if (CheckAttribute(pchar, "questTemp.Saga.Jackman"))
	{
		LocatorReloadEnterDisable("FortOrange_town", "reload6", false); // открыть резиденцию Хоука
		// уберем Тиракса с Ла Веги и усадим туда Валета
		sld = characterFromId("Terrax");
		ChangeCharacterAddressGroup(sld, "none", "", "");
		sld.lifeday = 0;
		sld = GetCharacter(NPC_GenerateCharacter("Valet", "Valet", "man", "man", 30, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, 30, 100, 100, "blade_18", "pistol6", "bullet", 200);
		sld.name = "David";
		sld.lastname = "Fackman";
		sld.dialog.FileName = "Mayor\LaVega_Mayor.c";
		sld.dialog.currentnode = "First time";
		sld.greeting = "Valet";
		ChangeCharacterAddressGroup(sld, "LaVega_townhall", "sit", "sit1");
		sld.standUp = true; //вставать и нападать на врага
		LAi_SetHuberType(sld);
		LAi_group_MoveCharacter(sld, "PIRATE_CITIZENS");
		LAi_SetImmortal(sld, true);
		sld.watchBoxes = true; 
	}
	FreeSitLocator("Pirates_townhall", "sit1"); // убираем наместника кто там есть
	// садим офицера-наместника
	sld = GetCharacter(NPC_GenerateCharacter("Sharptown_comandante", "off_eng_6", "man", "man", 30, ENGLAND, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 30, 100, 100, "blade_21", "pistol5", "bullet", 200);
	sld.dialog.FileName = "Quest\Saga\OtherNPC.c";
	sld.dialog.currentnode = "First time";
	sld.greeting = "patrol";
	ChangeCharacterAddressGroup(sld, "Pirates_townhall", "sit", "sit1");
	sld.standUp = true; //вставать и нападать на врага
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
	LAi_SetImmortal(sld, true);
	sld.watchBoxes = true; 
	sld = characterFromId("Pirates_shipyarder");
	ChangeCharacterAddressGroup(sld, "none", "", ""); // Алексус ушел с Исла Тесоро
}

//--------------------------- встроенный мини-квест Корабль главы братства -----------------------------------
void AlexClock_Over(string qName) // хронометр Алекса - овертайм
{
	AddQuestRecord("alex_clock", "6");
	CloseQuestHeader("alex_clock");
	DeleteAttribute(pchar, "questTemp.AlexClock");
}

void AlexClock_Chest(string qName) // четыре разгвоздяя в подземелье
{
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation("Bermudes_Dungeon")], true);//запретить драться
	int iRank = 25+MOD_SKILL_ENEMY_RATE;
	int iScl = 60;
	for (int i=1; i<=4; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("Alexs_bandos_"+i, "mush_ctz_9", "man", "mushketer", iRank+2, PIRATE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl+5, iScl+5, "", "mushket2", "cartridge", iScl*2+100);
			ChangeCharacterAddressGroup(sld, "Bermudes_Dungeon", "monsters", "monster"+i);
			sld.Dialog.Filename = "Quest\Saga\OtherNPC.c";
			sld.dialog.currentnode = "Alexs_bandos";
			sld.greeting = "marginal"; 
			LAi_SetGuardianType(sld);
			sld.protector = true;
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Alexs_bandos_"+i, "citiz_"+(46+i), "man", "man", iRank, PIRATE, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_06","blade_10"), "pistol1", "bullet", iScl*2);
			ChangeCharacterAddressGroup(sld, "Bermudes_Dungeon", "monsters", "monster"+i);
			LAi_CharacterDisableDialog(sld);
			LAi_SetWarriorType(sld);
			LAi_warrior_SetStay(sld, true);
		}
	}
}

void AlexClock_FindChest(string qName) // нашли ларчик
{
	chrDisableReloadToLocation = false;
	LocatorReloadEnterDisable("Bermudes_Dungeon", "reload2_back", true);
	AddQuestRecord("alex_clock", "4");
	pchar.questTemp.AlexClock = "clock";
}

// --------------------------------- отношения с девушками - героинями Саги ---------------------------------
void Helena_SexReady(string qName) // Элен снова готова к сексу
{
	sld = characterFromId("Helena");	
	DeleteAttribute(sld, "quest.daily_sex");
}

// --> Красная Мэри вне LSC - пипец Карибам :) Тут отрабатываем ее поведение
void Mary_SexReady(string qName) // Мэри снова готова к сексу
{
	sld = characterFromId("Mary");	
	DeleteAttribute(sld, "quest.daily_sex");
	pchar.quest.Mary_giveme_sex.win_condition.l1 = "Timer";
	pchar.quest.Mary_giveme_sex.win_condition.l1.date.hour  = sti(GetTime());
	pchar.quest.Mary_giveme_sex.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 14);
	pchar.quest.Mary_giveme_sex.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 14);
	pchar.quest.Mary_giveme_sex.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 14);
	pchar.quest.Mary_giveme_sex.function = "Mary_GiveMeSex";
}

// требует секса, если давно не давал. Пока только в таверне
void Mary_GiveMeSex(string qName)
{
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.MaryBlock")) return; // fix 22-03-20
	pchar.quest.Mary_giveme_sex1.win_condition.l1 = "Location_Type";
	pchar.quest.Mary_giveme_sex1.win_condition.l1.location_type = "tavern";
	pchar.quest.Mary_giveme_sex1.function = "Mary_GetTalk";
	sld = characterFromId("Mary");
	sld.quest.iwantsex = true;
	sld.greeting = "mary_love";
}

void Mary_GetTalk(string qName) // говорилка Мэри
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Mary");
	if (CheckAttribute(sld, "quest.iwantsex")) sld.dialog.currentnode = "givemesex";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////
// ---------------------------------------- Суп из черепахи --------------------------------------------
/////////////////////////////////////////////////////////////////////////////////////////////////////////
void Terrapin_SetEnvoy(string qName) // посланник в таверне
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = GetCharacter(NPC_GenerateCharacter("TerrapinEnvoy", "citiz_44", "man", "man", 20, FRANCE, 0, true, "quest"));
	FantomMakeCoolFighter(sld, 20, 50, 50, "blade_10", "pistol3", "bullet", 100);
	sld.dialog.FileName = "Quest\Sharlie\Terrapin.c";
	sld.dialog.currentnode = "envoy";
	sld.greeting = "town_pirate";
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Terrapin_LevasserInCave(string qName) // ставим Левассера и свиту
{
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation("Tortuga_cave")], true);//запретить драться
	int iRank = 22+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 70;
	// сам Левассер
	sld = characterFromId("Tortuga_Mayor");
	sld.dialog.FileName = "Quest\Sharlie\Terrapin.c";
	sld.dialog.currentnode = "levasser_cave";
	sld.greeting = "Levasser";
	LAi_SetWarriorType(sld);
	LAi_warrior_SetStay(sld, true);
	LAi_warrior_DialogEnable(sld, true);
	ChangeCharacterAddressGroup(sld, "Tortuga_cave", "goto", "goto1");
	LAi_SetImmortal(sld, false);
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	// гарды
	for (int i=2; i<=4; i++)
	{		
		sld = GetCharacter(NPC_GenerateCharacter("TerrapinGuard"+i, "citiz_5"+i, "man", "man", iRank, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_21", RandPhraseSimple("pistol6","pistol4"), "bullet", iScl*2);
		ChangeCharacterAddressGroup(sld, "Tortuga_cave", "goto", "goto"+i);
		LAi_SetWarriorType(sld);
		LAi_warrior_SetStay(sld, true);
		LAi_warrior_DialogEnable(sld, false);
	}
}

void Terrapin_GotoWindow(string qName) // телепортируем через окошко на крыши
{
	LAi_group_Delete("EnemyFight");
	DoQuestReloadToLocation("Tortuga_Town", "reload", "tavernWindow", "");
	DoQuestFunctionDelay("Terrapin_TownAttack", 1.2);
	chrDisableReloadToLocation = true; // закрыть локацию
	InterfaceStates.Buttons.Save.enable = false; //запретить сохраняться
	LocatorReloadEnterDisable("Tortuga_tavern_upstairs", "reload1_back", false);//открыть комнату таверны patch-8
	setCharacterShipLocation(pchar, "Tortuga_town"));
	setWDMPointXZ("Tortuga_town"); // корабль на рейд
	// ставим горожанку
	sld = GetCharacter(NPC_GenerateCharacter("TerrapinRoofGirl", "women_15", "woman", "towngirl", 10, FRANCE, -1, true, "quest"));
	sld.dialog.FileName = "Quest\Sharlie\Terrapin.c";
	sld.dialog.currentnode = "roof_girl";
	sld.greeting = "rapers_girl_1";
	LAi_SetStayType(sld);
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "Tortuga_town", "quest", "roof");
	// прерывание на локатор с горожанкой
	pchar.quest.Terrapin_roof.win_condition.l1 = "locator";
	pchar.quest.Terrapin_roof.win_condition.l1.location = "Tortuga_town";
	pchar.quest.Terrapin_roof.win_condition.l1.locator_group = "quest";
	pchar.quest.Terrapin_roof.win_condition.l1.locator = "roof";
	pchar.quest.Terrapin_roof.function = "Terrapin_RoofGirl";
	// ставим Тибо в грот
	sld = characterFromId("Tibo");
	LAi_SetWarriorType(sld);
	LAi_warrior_SetStay(sld, true);
	LAi_warrior_DialogEnable(sld, true);
	ChangeCharacterAddressGroup(sld, "Tortuga_town", "quest", "grot1");
	pchar.questTemp.Terrapin.Attack = "true"; // обработка в АИ
	// создаем и ставим Кати в грот
	sld = GetCharacter(NPC_GenerateCharacter("Kathy", "Catherine", "woman", "woman", 10, ENGLAND, -1, true, "quest"));
	sld.dialog.FileName = "Quest\Sharlie\Terrapin.c";
	sld.dialog.currentnode = "kathy";
	sld.name = "Cathrin";
	sld.lastname = "Fox";
	LAi_CharacterDisableDialog(sld);
	LAi_SetStayType(sld);
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "Tortuga_town", "quest", "grot2");
	// ставим трех квестовых мушкетеров
	for (int i=1; i<=3; i++)
	{		
		sld = GetCharacter(NPC_GenerateCharacter("TerrapinMush"+i, "mush_fra_"+i, "man", "mushketer", 30, FRANCE, 1, true, "quest"));
		FantomMakeCoolFighter(sld, 30, 100, 100, "", "mushket1", "bullet", 200);
		ChangeCharacterAddressGroup(sld, "Tortuga_town", "quest", "mushketer"+i);
		LAi_SetWarriorType(sld);
		LAi_warrior_SetStay(sld, true);
		LAi_warrior_DialogEnable(sld, false);
		LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	}
	pchar.quest.Terrapin_roof1.win_condition.l1 = "locator";
	pchar.quest.Terrapin_roof1.win_condition.l1.location = "Tortuga_town";
	pchar.quest.Terrapin_roof1.win_condition.l1.locator_group = "quest";
	pchar.quest.Terrapin_roof1.win_condition.l1.locator = "shot1";
	pchar.quest.Terrapin_roof1.win_condition = "Terrapin_FirstShot";
	pchar.quest.Terrapin_roof2.win_condition.l1 = "locator";
	pchar.quest.Terrapin_roof2.win_condition.l1.location = "Tortuga_town";
	pchar.quest.Terrapin_roof2.win_condition.l1.locator_group = "quest";
	pchar.quest.Terrapin_roof2.win_condition.l1.locator = "shot3";
	pchar.quest.Terrapin_roof2.win_condition = "Terrapin_FirstShot";
	sTotalTemp = "1";
}

void Terrapin_TownAttack(string qName) // 
{
	sld = CharacterFromID("TerrapinMush1");
	LAi_group_Attack(sld, Pchar);
	SetNationRelation2MainCharacter(FRANCE, RELATION_ENEMY);
	DoQuestFunctionDelay("Terrapin_SetMusic", 0.2);
}

void Terrapin_SetMusic(string qName) // 
{
	SetMusic("music_q_battle");
}

void Terrapin_RoofGirl(string qName) // разговор с девушкой на балконе
{
	DoQuestCheckDelay("hide_weapon", 0.5);
	sld = characterFromId("TerrapinRoofGirl");
	LAi_SetActorType(sld);
	LAi_ActorDialogNow(sld, pchar, "", -1);
	LAi_SetImmortal(sld, false);
}

void Terrapin_CheckEnemyDistance() // расчет дистанции до Тибо
{
	float fdist;
	if (pchar.location == "Tortuga_town")
	{
		if (GetCharacterDistByLoc(pchar, "quest", "grot1", &fdist))
		{
			if (fdist < 13.0) Terrapin_TiboAttack();
		}
	}
}

void Terrapin_TiboAttack() // Тибо атакует
{
	DeleteAttribute(pchar, "questTemp.Terrapin.Attack");
	sld = characterFromId("Tibo");
	LAi_group_MoveCharacter(sld, "EnemyFight");
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Terrapin_TiboDied");
}

void Terrapin_OwrInGrot() // пришли свои
{
	LAi_SetPlayerType(pchar);
	sld = characterFromId("Kathy");
	LAi_SetActorType(sld);
	LAi_ActorFollow(sld, pchar, "", -1);
	if (CheckAttribute(pchar, "questTemp.LSC.Mary_officer") && GetCharacterIndex("Mary") != -1) sld = characterFromId("Mary");
	else 
	{
		if (CheckAttribute(pchar, "questTemp.Saga.Helena_officer") && GetCharacterIndex("Helena") != -1) sld = characterFromId("Helena");
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("TerrapinOurChar", "citiz_35", "man", "man", 20, FRANCE, 0, true, "quest"));
			FantomMakeCoolFighter(sld, 20, 50, 50, "blade_10", "pistol1", "bullet", 100);
			sld.dialog.FileName = "Quest\Sharlie\Terrapin.c";
		}
	}
	sld.dialog.currentnode = "terrapin_grot";
	ChangeCharacterAddressGroup(sld, "Tortuga_town", "reload", "reload_grot");
	LAi_SetActorType(sld);
	LAi_ActorDialogNow(sld, pchar, "", -1);
}

void Terrapin_GotoShip()
{
	sld = characterFromId("Kathy");
	sld.dialog.currentnode = "kathy_5";
	AddPassenger(pchar, sld, false);
	SetCharacterRemovable(sld, false);
	// снимаем часть запретов
	chrDisableReloadToLocation = false;//открыть локацию
	InterfaceStates.Buttons.Save.enable = true; //разрешить сохраняться
	SetNationRelation2MainCharacter(FRANCE, RELATION_FRIEND); // мирим
	LAi_LocationDisableOfficersGen("Tortuga_Town", false);//офицеров пускать
	DeleteAttribute(pchar, "GenQuest.Notsearchbody"); // снять запрет обыска
	DeleteAttribute(pchar, "questTemp.Terrapin.Room_close"); // пускать в комнату таверны
	// ставим прерывание на 'Вольтижер'
	pchar.quest.Terrapin_Rober_attack.win_condition.l1 = "location";
	pchar.quest.Terrapin_Rober_attack.win_condition.l1.location = "Tortuga";
	pchar.quest.Terrapin_Rober_attack.function = "Terrapin_RoberAttack";
	// прерывания на Кати
	pchar.quest.Terrapin_Kathy.win_condition.l1 = "location";
	pchar.quest.Terrapin_Kathy.win_condition.l1.location = "SentJons_town";
	pchar.quest.Terrapin_Kathy.function = "Terrapin_KathyGoHome";
	SetFunctionTimerCondition("Terrapin_KathyDie", 0, 0, 30, false); // таймер
	AddQuestRecord("Terrapin", "11");
}

void Terrapin_RoberAttack(string qName) // Мартэн атакуэ
{
	int n = Findlocation("Tortuga_town");
	locations[n].models.day.charactersPatch = "Margarita_patch_day"; 
	locations[n].models.night.charactersPatch = "Margarita_patch_night"; // подменяем патч для персонажа
	DeleteAttribute(pchar, "GenQuest.CannotWait");//можно мотать время
	int iRate = 40+MOD_SKILL_ENEMY_RATE*5;
	Island_SetReloadEnableGlobal("Tortuga", false);//на остров нельзя
	Group_FindOrCreateGroup("Rober_Group");
	Group_SetType("Rober_Group", "war");//тип группы
	sld = characterFromId("Rober");
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Coastal_Captain = true;
	sld.Ship.Mode = "pirate";
	sld.alwaysenemy = true;
	sld.ship.Crew.Morale = iRate;
	sld.Ship.Crew.Exp.Sailors = iRate;
	sld.Ship.Crew.Exp.Cannoners = iRate;
	sld.Ship.Crew.Exp.Soldiers = iRate;
	Group_AddCharacter("Rober_Group", "Rober");
	Group_SetGroupCommander("Rober_Group", "Rober");
	Group_SetTaskAttack("Rober_Group", PLAYER_GROUP);
	Group_SetAddress("Rober_Group", "Tortuga", "IslandShips1", "ship_2");
	Group_LockTask("Rober_Group");
	
	pchar.quest.Terrapin_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Terrapin_AfterBattle.win_condition.l1.group = "Rober_Group";
	pchar.quest.Terrapin_AfterBattle.function = "Terrapin_RoberAfterBattle";
	pchar.quest.Terrapin_DieHard.win_condition.l1 = "MapEnter";
	pchar.quest.Terrapin_DieHard.function = "Terrapin_RoberDieHard";
}

void Terrapin_RoberAfterBattle(string qName) // победили Мартэна
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.Terrapin_DieHard.over = "yes"; //снять прерывание
	Group_DeleteGroup("Rober_Group");
	if (CheckCharacterItem(pchar, "Cromvel_depeshe"))
	{
		AddQuestRecord("Terrapin", "13");
		// прерывание на эскадру Кромвеля
		pchar.quest.Terrapin_CromvelScuadron.win_condition.l1 = "Timer";
		pchar.quest.Terrapin_CromvelScuadron.win_condition.l1.date.hour  = sti(GetTime());
		pchar.quest.Terrapin_CromvelScuadron.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 64);
		pchar.quest.Terrapin_CromvelScuadron.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 64);
		pchar.quest.Terrapin_CromvelScuadron.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 64);
		pchar.quest.Terrapin_CromvelScuadron.function = "Terrapin_SetCromvelScuadron";
		AddCharacterExpToSkill(pchar, "Grappling", 350);
		AddComplexSelfExpToScill(250, 150, 150, 150);
	}
	else AddQuestRecord("Terrapin", "14");
	pchar.questTemp.Terrapin = "done";
	AddComplexSeaExpToScill(100, 150, 150, 0, 100, 100, 0);
	ChangeCharacterComplexReputation(pchar, "authority", 1);
	ChangeOfficersLoyality("good_all", 1);
}

void Terrapin_RoberDieHard(string qName) // ушли на карту
{
	pchar.quest.Terrapin_AfterBattle.over = "yes"; //снять прерывание
	Group_DeleteGroup("Rober_Group");
	AddQuestRecord("Terrapin", "12");
	pchar.questTemp.Terrapin = "done";
	ChangeCharacterComplexReputation(pchar, "authority", -3);
	ChangeOfficersLoyality("bad_all", 1);
}

void Terrapin_KathyDie(string qName) // не довезли Кати
{
	pchar.quest.Terrapin_Kathy.over = "yes"; //снять прерывание
	sld = characterFromId("Kathy");
	RemovePassenger(pchar, sld);
	sld.lifeday = 0;
	SetFunctionTimerCondition("Terrapin_ReturnFox", 0, 0, 3, false); // Фокса на место
	Log_Info("Catherine Fox died of calenture!");
	AddQuestRecord("Terrapin", "15");
}

void Terrapin_KathyGoHome(string qName) // отвезли Кати
{
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.quest.Terrapin_KathyDie.over = "yes"; //снять прерывание
	sld = characterFromId("Kathy");
	RemovePassenger(pchar, sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "SentJons_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Terrapin_ReturnFox(string qName) // Фокса на место
{
	sld = characterFromId("Fox");
	ChangeCharacterAddressGroup(sld, "SentJons_Roomtownhall", "sit", "sit1");
}

void Terrapin_SetFontene(string qName) // Фонтене на место
{
	sld = GetCharacter(NPC_GenerateCharacter("Tortuga_Mayor", "off_fra_5", "man", "man", 40, FRANCE, -1, true, "soldier"));
	sld.name = "chevalier Timoleon";
    sld.lastname = "de Fontene";
	sld.Dialog.Filename = "Common_Mayor.c";
	sld.dialog.currentnode = "First time";
	sld.greeting = "fra_gov_common";
	sld.quest.type = "hovernor";
	ChangeCharacterAddressGroup(sld, "Tortuga_townhall", "sit", "sit1");
	GiveItem2character(sld, "blade_17");
	EquipcharacterbyItem(sld, "blade_17");
	GiveItem2character(sld, "pistol5"); 
	EquipcharacterbyItem(sld, "pistol5");
	SetRandSPECIAL(sld);
    SetSelfSkill(sld, 100, 100, 100, 100, 100);
	SetShipSkill(sld, 80, 90, 90, 80, 90, 70, 60, 70, 50);
	sld.standUp = true;
	LAi_SetHuberType(sld);
	LAi_RemoveLoginTime(sld);
	LAi_group_Movecharacter(sld, "FRANCE_CITIZENS");
	LAi_SetImmortal(sld, true);
	LAi_LoginInCaptureTown(sld, false);
	LAi_NoRebirthDisable(sld);
}

void CreateGriffondor() // малый фрегат Гриффондор
{
	sld = GetCharacter(NPC_GenerateCharacter("GriffOfficer", "off_fra_2", "man", "man", 10, FRANCE, -1, true, "soldier"));
	SetFantomParamFromRank(sld, 10, true);
	FantomMakeSmallSailor(sld, SHIP_CORVETTE_QUEST, "Griffondor", CANNON_TYPE_CANNON_LBS24, 30, 30, 30, 30, 30);
	SetShipSkill(sld, 30, 40, 50, 50, 65, 40, 45, 48, 20);
	SetSelfSkill(sld, 20, 22, 18, 25, 30);
	sld.dialog.FileName = "Quest\Sharlie\OtherNPC.c";
	sld.dialog.currentnode = "griffondor_officer";
	sld.greeting = "patrol";
	SetCharacterPerk(sld, "BasicDefense");
	SetCharacterPerk(sld, "AdvancedDefense");
	SetCharacterPerk(sld, "Gunman");
	SetCharacterPerk(sld, "LongRangeGrappling");
	SetCharacterPerk(sld, "HullDamageUp");
	SetCharacterPerk(sld, "SailsDamageUp");
	SetCharacterPerk(sld, "CrewDamageUp");
	SetCharacterPerk(sld, "BasicBattleState");
	SetCharacterPerk(sld, "ShipSpeedUp");
	SetCharacterPerk(sld, "ShipTurnRateUp");
	SetCharacterPerk(sld, "StormProfessional");
	SetCharacterPerk(sld, "Doctor1");
	sld.ship.Crew.Morale = 100;
	sld.Ship.Crew.Exp.Sailors = 100;
	sld.Ship.Crew.Exp.Cannoners = 100;
	sld.Ship.Crew.Exp.Soldiers = 100;
	NullCharacterGoods(sld);
	AddCharacterGoods(sld, GOOD_BALLS, 700);
	AddCharacterGoods(sld, GOOD_GRAPES, 700);
	AddCharacterGoods(sld, GOOD_KNIPPELS, 700);
	AddCharacterGoods(sld, GOOD_BOMBS, 700);
	AddCharacterGoods(sld, GOOD_POWDER, 1000);
	AddCharacterGoods(sld, GOOD_FOOD, 1000);
	AddCharacterGoods(sld, GOOD_MEDICAMENT, 300);
	AddCharacterGoods(sld, GOOD_RUM, 200);
	AddCharacterGoods(sld, GOOD_PLANKS, 50);
	AddCharacterGoods(sld, GOOD_SAILCLOTH, 50);
}

void Terrapin_ReturnTibo(string qName) // Тибо на место
{
	sld = characterFromId("Tibo");
	sld.dialog.currentnode = "tibo_22";
	ChangeCharacterAddressGroup(sld, "Tortuga_houseS2", "barmen", "stay");
	LAi_SetOwnerType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	pchar.quest.Terrapin_tibo_call.win_condition.l1 = "Location_Type";
	pchar.quest.Terrapin_tibo_call.win_condition.l1.location_type = "seashore";
	pchar.quest.Terrapin_tibo_call.function = "Terrapin_TiboCall";
	sld = characterFromId("Rober");
	sld.lifeday = 0; // чистим Мартэна
}

void Terrapin_TiboCall(string qName) // засланец от Тибо
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = GetCharacter(NPC_GenerateCharacter("Tibo_sailor", "citiz_34", "man", "man", 10, FRANCE, 0, true, "quest"));
	SetFantomParamFromRank(sld, 10, true);
	sld.dialog.FileName = "Quest\Sharlie\Terrapin.c";
	sld.dialog.currentnode = "tibo_sailor";
	sld.greeting = "town_pirate";
	LAi_SetImmortal(sld, true);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Terrapin_TiboCallOver(string qName) // опоздали к Тибо
{
	sld = characterFromId("Tibo");
	sld.dialog.currentnode = "tibo_late";
}

void Terrapin_CreateRoberConvoy()//создаем испанский конвой
{
	int iRate = 20+MOD_SKILL_ENEMY_RATE*7;
	int iRank = 25+MOD_SKILL_ENEMY_RATE;
	float fMft = MOD_SKILL_ENEMY_RATE/10;
	string sCapId = "RoberCap";
    string sGroup = "Sea_" + sCapId + "1";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	for (int i = 1; i <= 3; i++)
    {
		sld = GetCharacter(NPC_GenerateCharacter(sCapId + i, "citiz_41", "man", "man", iRank, SPAIN, 22, true, "quest"));
		SetRandomNameToCharacter(sld);
		SetRandomNameToShip(sld);
		switch (i)
		{
			case 1: iTemp = SHIP_GALEON_H; break;
			case 2: iTemp = SHIP_GALEON_H; break;
			case 3: iTemp = SHIP_CORVETTE; break;
		}
		sld.Ship.Type = GenerateShipExt(iTemp, 1, sld);
		SetBaseShipData(sld);
		SetCaptanModelByEncType(sld, "war");
		sld.Ship.Mode = "war";
		if (i == 2)
		{
			sld.model = "Marten";
			sld.name = "Rober";
			sld.lastname = "Marten";
			sld.Ship.Mode = "pirate";
			sld.Ship.Name = "Инфанта";
			FantomMakeCoolFighter(sld, 30, 70, 70, "blade_19", "pistol5", "bullet", 150);
			sld.SaveItemsForDead = true;
			sld.DontClearDead = true;
			GiveItem2Character(sld, "Finger");
			ChangeItemDescribe("Finger", "itmdescr_finger_rober");
		}
		int hcrew = GetMaxCrewQuantity(sld);
		SetCrewQuantity(sld, hcrew);
		SetCrewQuantityFull(sld);
		sld.AlwaysEnemy = true;
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.skill.Sailing = iRate;
		sld.skill.Defence = iRate;
		sld.skill.Accuracy = iRate;
		sld.skill.Cannons = iRate;
		sld.Ship.Crew.Morale = iRate;
		sld.Ship.Crew.Exp.Sailors = iRate;
		sld.Ship.Crew.Exp.Cannoners = iRate;
		sld.Ship.Crew.Exp.Soldiers = iRate;
		TakeNItems(sld, "potion2", 1);
		TakeNItems(sld, "potion3", 2);
		SetCharacterPerk(sld, "Energaiser");
		SetCharacterPerk(sld, "BasicDefense");
		SetCharacterPerk(sld, "AdvancedDefense");
		SetCharacterPerk(sld, "CriticalHit");
		SetCharacterPerk(sld, "Tireless");
		SetCharacterPerk(sld, "HardHitter");
		SetCharacterPerk(sld, "Sliding");
		SetCharacterPerk(sld, "BladeDancer");
		SetCharacterPerk(sld, "SwordplayProfessional");
		SetCharacterPerk(sld, "Gunman");
		SetCharacterPerk(sld, "GunProfessional");
		SetCharacterPerk(sld, "MusketsShoot");
		SetCharacterPerk(sld, "LongRangeGrappling");
		SetCharacterPerk(sld, "GrapplingProfessional");
		SetCharacterPerk(sld, "HullDamageUp");
		SetCharacterPerk(sld, "SailsDamageUp");
		SetCharacterPerk(sld, "CrewDamageUp");
		SetCharacterPerk(sld, "CriticalShoot");
		SetCharacterPerk(sld, "LongRangeShoot");
		SetCharacterPerk(sld, "BasicBattleState");
		SetCharacterPerk(sld, "AdvancedBattleState");
		SetCharacterPerk(sld, "ShipDefenseProfessional");
		SetCharacterPerk(sld, "ShipSpeedUp");
		SetCharacterPerk(sld, "ShipTurnRateUp");
		SetCharacterPerk(sld, "WindCatcher");
		SetCharacterPerk(sld, "SailsMan");
		SetCharacterPerk(sld, "Doctor1");
		SetCharacterPerk(sld, "Doctor2");
		DeleteAttribute(sld, "SinkTenPercent");
		if (i == 2) SetCharacterGoods(sld, GOOD_ROPES, 50);//бонус
		sld.mapEnc.type = "war";
		sld.mapEnc.worldMapShip = "quest_ship";
        sld.mapEnc.Name = "spain convoy";
        Group_AddCharacter(sGroup, sCapId + i);
	}
	Group_SetGroupCommander(sGroup, sCapId+ "1");
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
	Map_CreateTrader("Caracas", "SantoDomingo", sCapId + "1", 22);//запуск энкаунтера
	
	pchar.quest.Terrapinconvoy_Abordage.win_condition.l1 = "Character_Capture";
	pchar.quest.Terrapinconvoy_Abordage.win_condition.l1.character = "RoberCap2";
	pchar.quest.Terrapinconvoy_Abordage.function = "Terrapinconvoy_AfterBattle";//взяли на абордаж
	pchar.quest.Terrapinconvoy_Sink.win_condition.l1 = "Character_sink";
	pchar.quest.Terrapinconvoy_Sink.win_condition.l1.character = "RoberCap2";
	pchar.quest.Terrapinconvoy_Sink.function = "Terrapinconvoy_AfterBattle";//потопили
	SetFunctionTimerCondition("Terrapinconvoy_failed", 0, 0, 23, false); // упустили
}

void Terrapinconvoy_AfterBattle(string qName)//после боя
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.Terrapinconvoy_failed.over = "yes";
	sld = characterFromId("Tibo");
	if (CheckCharacterItem(pchar, "Finger"))
	{
		sld.dialog.currentnode = "tibo_38";
		AddQuestRecord("Sharlie", "28");
		AddCharacterExpToSkill(pchar, "Grappling", 350);
		AddComplexSelfExpToScill(150, 150, 150, 150);
	}
	else
	{
		sld.dialog.currentnode = "tibo_over";
		AddQuestRecord("Sharlie", "29");
	}
	if (CheckCharacterItem(pchar, "Cromvel_depeshe"))
	{
		// прерывание на эскадру Кромвеля
		pchar.quest.Terrapin_CromvelScuadron.win_condition.l1 = "Timer";
		pchar.quest.Terrapin_CromvelScuadron.win_condition.l1.date.hour  = sti(GetTime());
		pchar.quest.Terrapin_CromvelScuadron.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 32);
		pchar.quest.Terrapin_CromvelScuadron.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 32);
		pchar.quest.Terrapin_CromvelScuadron.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 32);
		pchar.quest.Terrapin_CromvelScuadron.function = "Terrapin_SetCromvelScuadron";
	}
	AddComplexSeaExpToScill(200, 250, 250, 0, 200, 200, 0);
}

void Terrapinconvoy_failed(string qName)//опоздали или не нашли конвой
{
	pchar.quest.Terrapinconvoy_Abordage.over = "yes";
	pchar.quest.Terrapinconvoy_Sink.over = "yes";
	sld = characterFromId("Tibo");
	sld.dialog.currentnode = "tibo_over";
	AddQuestRecord("Sharlie", "30");
}

void Terrapin_LateBaster(string qName)//опоздали к Мартэну в Бас-тер
{
	AddQuestRecord("Terrapin", "16");
	Terrapin_LateDelete();
}

void Terrapin_LateTortuga(string qName)//опоздали на Тортугу
{
	sld = characterFromId("Tibo");
	sld.lifeday = 0;
	AddQuestRecord("Terrapin", "17");
	Terrapin_LateDelete();
}

void Terrapin_LateDungeon(string qName)//опоздали в подземелье
{
	pchar.quest.Terrapin_wait.over = "yes"; //снять прерывание
	pchar.quest.Terrapin_cave.over = "yes"; //снять прерывание
	pchar.quest.Terrapin_ReturnTibo.over = "yes"; //снять прерывание
	sld = characterFromId("Tibo");
	sld.lifeday = 0;
	AddQuestRecord("Terrapin", "18");
	Terrapin_LateDelete();
}

void Terrapin_LateDelete() //общее на все опоздания
{
	sld = characterFromId("Rober");
	sld.lifeday = 0;
	DeleteAttribute(pchar, "questTemp.Terrapin");
	CloseQuestHeader("Terrapin");
	// Левассера - к барьеру!
	sld = characterFromId("Tortuga_Mayor");
	LAi_LoginInCaptureTown(sld, true);
	pchar.questTemp.Sharlie.Hardcore_Tortuga = "true";
}

void Terrapin_SetCromvelScuadron(string qName) //эскадра Кромвеля прибыла
{
	if (CheckCharacterItem(pchar, "Cromvel_depeshe")) RemoveItems(pchar, "Cromvel_depeshe", 1);
	// создаем эскадру
	Group_FindOrCreateGroup("CromvelGroup");
	Group_SetType("CromvelGroup", "war");
	int iRank, iShip, iCannon;
	string sName;
	for (int i=1; i<=5; i++)
	{
		switch (i)
		{
			case 1:
				iShip = SHIP_LSHIP_ENG;
				iCannon = CANNON_TYPE_CULVERINE_LBS36;
				sName = "Victory";
			break;
			
			case 2:
				iShip = SHIP_LINESHIP;
				iCannon = CANNON_TYPE_CANNON_LBS32;
				sName = "Vindzor Castle";
			break;
			
			case 3:
				iShip = SHIP_FRIGATE_H;
				iCannon = CANNON_TYPE_CANNON_LBS32;
				sName = "Royal Katherine";
			break;
			
			case 4:
				iShip = SHIP_FRIGATE;
				iCannon = CANNON_TYPE_CANNON_LBS24;
				sName = "Loyal London";
			break;
			
			case 5:
				iShip = SHIP_POLACRE;
				iCannon = CANNON_TYPE_CANNON_LBS20;
				sName = "Haughty";
			break;
		}
		iRank = 20+MOD_SKILL_ENEMY_RATE+(15-i*3);
		sld = GetCharacter(NPC_GenerateCharacter("Cromvel_cap_"+i, "off_eng_"+(7-i), "man", "man", iRank, ENGLAND, 3, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, sName, iCannon, 55+(60-i*12), 55+(60-i*12), 55+(60-i*12));
		FantomMakeCoolFighter(sld, iRank, 52+(60-i*12), 52+(60-i*12), "blade_19", "pistol5", "bullet", 170+(100-i*20));
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.Ship.Mode = "war";
		sld.AlwaysEnemy = true;
		sld.ship.Crew.Morale = 50+(60-i*12);
		sld.Ship.Crew.Exp.Sailors = 50+(60-i*12);;
		sld.Ship.Crew.Exp.Cannoners = 50+(60-i*12);;
		sld.Ship.Crew.Exp.Soldiers = 50+(60-i*12);;
		if (i < 4) SetCharacterPerk(sld, "MusketsShoot");
		if (i < 5) SetRandGeraldSail(sld, ENGLAND);
		Group_AddCharacter("CromvelGroup", "Cromvel_cap_"+i);
	}
	Group_SetGroupCommander("CromvelGroup", "Cromvel_cap_1");
	Group_SetAddress("CromvelGroup", "IslaMona", "quest_ships", "quest_ship_1");
	Group_SetTaskNone("CromvelGroup"); // 280313
}

//----------------------------------------- защита Сен-Пьера --------------------------------------------
void DefendSP_PrepareMartinique(string qName) // готовим Мартинику
{
	int n = FindColony("Fortfrance");
	colonies[n].DontSetShipInPort = true;
	Island_SetReloadEnableGlobal("Martinique", false);//на остров нельзя
	bQuestDisableMapEnter = true;//на карту тоже
	// подменяем файл локаторов на выходе из города
	locations[FindLocation("FortFrance_ExitTown")].models.always.locators = "townExitYQuest_locators";
	// создаем испанскую эскадру
	Group_FindOrCreateGroup("MartiniqueQuestSiege");
	Group_SetType("MartiniqueQuestSiege", "war");
	int iRank, iShip, iCannon, hcrew;
	float fSpace, fDamage;
	string sName;
	for (int i=1; i<=5; i++)
	{
		switch (i)
		{
			case 1:
				iShip = SHIP_LSHIP_SPA;
				iCannon = CANNON_TYPE_CULVERINE_LBS36;
				sName = "San Felipe";
				fSpace = 1.0;
				fDamage = 1.0;
			break;
			
			case 2:
				iShip = SHIP_LINESHIP;
				iCannon = CANNON_TYPE_CANNON_LBS32;
				sName = "San Isidro";
				fSpace = 1.5;
				fDamage = 1.2;
			break;
			
			case 3:
				iShip = SHIP_GALEON_H;
				iCannon = CANNON_TYPE_CANNON_LBS32;
				sName = "Santa Magdalena";
				fSpace = 1.6;
				fDamage = 1.3;
			break;
			
			case 4:
				iShip = SHIP_GALEON_H;
				iCannon = CANNON_TYPE_CANNON_LBS24;
				sName = "Santa Anna";
				fSpace = 1.7;
				fDamage = 1.2;
			break;
			
			case 5:
				iShip = SHIP_XebekVML;
				iCannon = CANNON_TYPE_CANNON_LBS20;
				sName = "Apostle";
				fSpace = 1.0;
				fDamage = 1.0;
			break;
		}
		iRank = 10+2*MOD_SKILL_ENEMY_RATE+(15-i*3);
		sld = GetCharacter(NPC_GenerateCharacter("SPsiege_cap_"+i, "off_spa_"+(7-i), "man", "man", iRank, SPAIN, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, sName, iCannon, 40+(60-i*12), 40+(60-i*12), 40+(60-i*12));
		FantomMakeCoolFighter(sld, iRank, 40+(60-i*12), 40+(60-i*12), "blade_19", "pistol5", "bullet", 70+(100-i*20));
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysEnemy = true;
		sld.Coastal_Captain = true;
		sld.Ship.Mode = "war";
		hcrew = GetMaxCrewQuantity(sld);
		SetCrewQuantityOverMax(sld, sti(hcrew/fSpace));
		sld.ship.HP = makeint(sti(sld.ship.HP)/fDamage);
		sld.ship.Crew.Morale = MOD_SKILL_ENEMY_RATE*5+(60-i*12);
		sld.Ship.Crew.Exp.Sailors = MOD_SKILL_ENEMY_RATE*5+(60-i*12);
		sld.Ship.Crew.Exp.Cannoners = MOD_SKILL_ENEMY_RATE*5+(60-i*12);
		sld.Ship.Crew.Exp.Soldiers = MOD_SKILL_ENEMY_RATE*5+(60-i*12);
		if (i < 4 && MOD_SKILL_ENEMY_RATE > 2) SetCharacterPerk(sld, "MusketsShoot");
		if (i < 5) SetRandGeraldSail(sld, SPAIN);
		Group_AddCharacter("MartiniqueQuestSiege", "SPsiege_cap_"+i);
		Group_SetGroupCommander("MartiniqueQuestSiege", "SPsiege_cap_1");
		Group_SetAddress("MartiniqueQuestSiege", "Martinique", "quest_ships", "quest_ship_1");
		Group_SetTaskNone("MartiniqueQuestSiege");
		//Group_LockTask("MartiniqueQuestSiege");
	}
	DoQuestCheckDelay("DefendSP_VideoSiege", 1.5);
}

void DefendSP_CatchOurSoldiers()
{
	for (int i=0; i<=12; i++)
	{
		if (GetCharacterIndex("DefendSP_soldier_"+i) != -1)
		{
			sld = CharacterFromID("DefendSP_soldier_"+i);
			if (LAi_GetCharacterHP(sld) > 0)
			{
				LAi_SetActorType(sld);
				LAi_ActorFollowEverywhere(sld, "", -1);
				LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
			}
		}
	}
}

void DefendSP_OurSoldiersFight()
{
	for (int i=0; i<=12; i++)
	{
		if (GetCharacterIndex("DefendSP_soldier_"+i) != -1)
		{
			sld = CharacterFromID("DefendSP_soldier_"+i);
			LAi_SetWarriorType(sld);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
}

void DefendSP_SpainPatrol(string qName) // ставим испанский патруль в джунглях
{
	// устанавливаем патруль, 4 рыл+офицер+убегающий
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 60;
	for (int i=1; i<=5; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("DefendSP_spapatrol_"+i, "off_spa_1", "man", "man", iRank+5, SPAIN, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_15", "pistol6", "bullet", iScl*2+50);
			sld.dialog.FileName = "Quest\Sharlie\OtherNPC.c";
			sld.dialog.currentnode = "spain_patrol";
			sld.greeting = "patrol";
		}
		else
		{
			if (i == 2)
			{
				sld = GetCharacter(NPC_GenerateCharacter("DefendSP_spapatrol_"+i, "mush_spa_"+i, "man", "mushketer", iRank, SPAIN, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("DefendSP_spapatrol_"+i, "sold_spa_"+i, "man", "man", iRank, SPAIN, -1, true, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_12","blade_14"), "pistol1", "bullet", iScl*2);
			}
			LAi_CharacterDisableDialog(sld);
			if (i == 5) LAi_SetHP(sld, 150, 150); // убегающий
		}
		LAi_SetActorType(sld);
		ChangeCharacterAddressGroup(sld, "Martinique_jungle_01", "rld", "loc"+i);
		LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
		if (i == 1) LAi_ActorDialogDelay(sld, pchar, "", 1.5);
	}
}

void DefendSP_SpainAvanpost(string qName) // ставим испанцев у ворот
{
	// устанавливаем аванпост испанцев за городскими воротами, 6 солдат, 3 мушкетера, 1 офицер
	chrDisableReloadToLocation = true;//закрыть локацию
	int iRank = 22+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 60;
	int dist = 20;
	float hpm = 1.5;
	string locator = "aloc";
	if (CheckAttribute(pchar, "questTemp.Sharlie.DefendSP.GateAlarm"))
	{
		dist = 0;
		hpm = 1.0;
		locator = "loc";
	}
	for (int i=1; i<=10; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("DefendSP_spaavanpost_"+i, "off_spa_1", "man", "man", iRank+5, SPAIN, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_16", "pistol4", "bullet", iScl*2+50);
		}
		else
		{
			if (i > 1 && i < 5)
			{
				sld = GetCharacter(NPC_GenerateCharacter("DefendSP_spaavanpost_"+i, "mush_spa_"+i, "man", "mushketer", iRank, SPAIN, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket2", "cartridge", iScl*2);
				sld.MusketerDistance = dist;
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("DefendSP_spaavanpost_"+i, "sold_spa_"+i, "man", "man", iRank+5, SPAIN, -1, true, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_12","blade_14"), "pistol1", "bullet", iScl*2);
			}
		}
		LAi_CharacterDisableDialog(sld);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
		ChangeCharacterAddressGroup(sld, "FortFrance_ExitTown", "rld", locator+i);
		int hpl = LAi_GetCharacterHP(sld)/hpm;
		LAi_SetHP(sld, hpl, hpl);
	}
	DefendSP_OurSoldiersFight();
	if (CheckAttribute(pchar, "questTemp.Sharlie.DefendSP.GateAlarm"))
	{
		LAi_SetFightMode(pchar, true);
		LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
		LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
		LAi_group_SetCheck("EnemyFight", "DefendSP_SpaAvanpostDie");
	}
	else DoQuestCheckDelay("DefendSP_SpaAvanpostAttack", 2.0); // застали врасплох
}

void DefendSP_TownBattle(string qName) // городская боевка
{
	for (int i=6; i<=13; i++)
	{
		CreateLocationParticles("smoke", "goto", "goto"+i, 0, 0, 0, "");
	}
	ref chr;
	for(int n = 0; n < MAX_CHARACTERS; n++)
	{
		makeref(chr, Characters[n]);
		if (CheckAttribute(chr, "Merchant") && chr.city == "fortfrance")
		{
			chr.lifeday = 0;
			ChangeCharacterAddressGroup(chr, "none", "", "");
		}
	}
	chr = characterFromId("Fortfrance_Poorman");
	ChangeCharacterAddressGroup(chr, "none", "", "");
	chrDisableReloadToLocation = true;//закрыть локацию
	int iRank = 24+MOD_SKILL_ENEMY_RATE+5;
	int iScl = 60;
	// ставим французов
	for (i=1; i<=8; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("DefendSP_fratown_"+i, "off_fra_"+i, "man", "man", iRank+5, FRANCE, 1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_15", "pistol6", "bullet", iScl*2+50);
		}
		else
		{
			if (i >= 2 && i < 4)
			{
				sld = GetCharacter(NPC_GenerateCharacter("DefendSP_fratown_"+i, "mush_fra_"+i, "man", "mushketer", iRank, FRANCE, 1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("DefendSP_fratown_"+i, "sold_fra_"+i, "man", "man", iRank, FRANCE, 1, true, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_12","blade_14"), "pistol1", "bullet", iScl*2);
			}
		}
		LAi_CharacterDisableDialog(sld);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		ChangeCharacterAddressGroup(sld, "FortFrance_Town", "patrol", "patrol"+i);
	}
	// ставим испанцев
	for (i=1; i<=13+MOD_SKILL_ENEMY_RATE; i++)
	{
		if (i < 3)
		{
			sld = GetCharacter(NPC_GenerateCharacter("DefendSP_spatown_"+i, "off_spa_"+i, "man", "man", iRank+5, SPAIN, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_16", "pistol4", "bullet", iScl*2+50);
		}
		else
		{
			if (i >= 3 && i < 6)
			{
				sld = GetCharacter(NPC_GenerateCharacter("DefendSP_spatown_"+i, "mush_spa_"+i, "man", "mushketer", iRank, SPAIN, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("DefendSP_spatown_"+i, "sold_spa_"+(rand(15)+1), "man", "man", iRank, SPAIN, -1, true, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_12","blade_14"), "pistol1", "bullet", iScl*2);
			}
		}
		LAi_CharacterDisableDialog(sld);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
		ChangeCharacterAddressGroup(sld, "FortFrance_Town", "goto", "goto"+i);
	}
	DefendSP_OurSoldiersFight();
	LAi_SetFightMode(pchar, true);
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "DefendSP_SpaTownDie");
}

void DefendSP_GotoMatieBase(string qName) // телепорт в базу
{
	DoQuestReloadToLocation("FortFrance_Dungeon", "reload", "reload1", "");
}

void DefendSP_BaseBattle(string qName) // боевка на базе мальтийцев
{
	sld = characterFromId("Mishelle");
	sld.dialog.currentnode = "Base_fight";
	int iRank = 24+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 70;
	// ставим французов
	for (int i=1; i<=7; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("DefendSP_frabase_"+i, "off_Malt_1", "man", "man", iRank+5, FRANCE, 1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_07", "pistol5", "bullet", iScl*2+50);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("DefendSP_frabase_"+i, "sold_fra_"+(rand(7)+9), "man", "man", iRank, FRANCE, 1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_12","blade_14"), "pistol1", "bullet", iScl*2);
		}
		LAi_CharacterDisableDialog(sld);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		ChangeCharacterAddressGroup(sld, "FortFrance_Dungeon", "goto", "goto"+i);
	}
	// ставим испанцев
	for (i=1; i<=8+MOD_SKILL_ENEMY_RATE/2; i++)
	{
		if (i < 3)
		{
			sld = GetCharacter(NPC_GenerateCharacter("DefendSP_spabase_"+i, "off_spa_"+i, "man", "man", iRank+10, SPAIN, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_16", "pistol5", "bullet", iScl*2+50);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("DefendSP_spabase_"+i, "sold_spa_"+i, "man", "man", iRank, SPAIN, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_12","blade_14"), "pistol1", "bullet", iScl*2);
		}
		LAi_CharacterDisableDialog(sld);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
		ChangeCharacterAddressGroup(sld, "FortFrance_Dungeon", "soldiers", "soldier"+i);
	}
	DefendSP_OurSoldiersFight();
	LAi_SetFightMode(pchar, true);
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "DefendSP_SpaBaseDie");
}

void DefendSP_OpenMishelleCasemate()
{	
	if (CheckCharacterItem(pchar, "MaltieBase_keys"))
	{
		PlaySound("interface\key.wav");
		RemoveItems(pchar, "MaltieBase_keys", 1);
		DeleteAttribute(pchar, "questTemp.Sharlie.DefendSP.SeekKey");
		Log_info("Cage has been opened!");
		DoQuestFunctionDelay("DefendSP_MishelleFreedom", 2.0);
	}
	else
	{
		Log_SetStringToLog(XI_ConvertString("Box is closed"));
		PlaySound("interface\door_locked.wav");
	}
}

void DefendSP_MishelleFreedom(string qName)
{
	sld = characterFromId("Mishelle");
	LAi_CharacterEnableDialog(sld);
	sld.dialog.currentnode = "Base_afterfight_6";
	ChangeCharacterAddressGroup(sld, "FortFrance_Dungeon", "quest", "quest5");
	LAi_SetActorType(sld);
	LAi_ActorDialogDelay(sld, pchar, "", 1.0);
}

void DefendSP_CloseTown(string qName) // закрываем входы
{
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.quest.DefendSP_fort1.win_condition.l1 = "locator";
	pchar.quest.DefendSP_fort1.win_condition.l1.location = "FortFrance_Town";
	pchar.quest.DefendSP_fort1.win_condition.l1.locator_group = "reload";
	pchar.quest.DefendSP_fort1.win_condition.l1.locator = "gate_back";
	pchar.quest.DefendSP_fort1.function = "DefendSP_gotoExittown";
}

void DefendSP_gotoExittown(string qName) // телепорт за ворота
{
	DoQuestReloadToLocation("FortFrance_Exittown", "reload", "reload3", "DefendSP_PrepareFortAttack");
}

void DefendSP_FortBattle(string qName) // входим в фортовую локацию
{
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 70;
	for (int i=1; i<=7; i++)
	{
		sld = characterFromId("Mishelle");
		ChangeCharacterAddressGroup(sld, "FortFrance_fort", "rld", "loc0");
		sld = CharacterFromID("DefendSP_frafort_"+i);
		ChangeCharacterAddressGroup(sld, "FortFrance_fort", "rld", "loc0");
		LAi_SetActorType(sld);
		LAi_ActorFollowEverywhere(sld, "", -1);
	}
	for (i=1; i<=16; i++)
	{
		if (i > 13)
		{
			sld = GetCharacter(NPC_GenerateCharacter("DefendSP_spafort_"+i, "off_spa_"+i, "man", "man", iRank+10, SPAIN, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank+10, iScl+5, iScl+5, "blade_16", "pistol5", "bullet", iScl*2+100);
		}
		else
		{
			if (i >= 3 && i < 7)
			{
				sld = GetCharacter(NPC_GenerateCharacter("DefendSP_spafort_"+i, "mush_spa_"+i, "man", "mushketer", iRank, SPAIN, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2+20);
				sld.MusketerDistance = 0;
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("DefendSP_spafort_"+i, "sold_spa_"+i, "man", "man", iRank, SPAIN, -1, true, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_12","blade_14"), "pistol1", "bullet", iScl*2+30);
			}
		}
		LAi_CharacterDisableDialog(sld);
		LAi_SetStayType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
		if (i > 13) ChangeCharacterAddressGroup(sld, "FortFrance_fort", "patrol", "patrol0"+(16-i));
		else ChangeCharacterAddressGroup(sld, "FortFrance_fort", "soldiers", "soldier"+i);
	}
	pchar.quest.DefendSP_fort3.win_condition.l1 = "locator";
	pchar.quest.DefendSP_fort3.win_condition.l1.location = "FortFrance_fort";
	pchar.quest.DefendSP_fort3.win_condition.l1.locator_group = "quest";
	pchar.quest.DefendSP_fort3.win_condition.l1.locator = "detector";
	pchar.quest.DefendSP_fort3.function = "DefendSP_FortAttack";
}

void DefendSP_FortAttack(string qName) //атака форта
{
	PlaySound("interface\abordage_wining.wav");
	PlaySound("interface\abordage_wining.wav");
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Mishelle");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	for (int i=1; i<=7; i++)
	{
		sld = CharacterFromID("DefendSP_frafort_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	for (i=1; i<=16; i++)
	{
		sld = CharacterFromID("DefendSP_spafort_"+i);
		LAi_SetWarriorTypeNoGroup(sld);
	}
	LAi_SetFightMode(pchar, true);
	DefendSP_OurSoldiersFight();
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "DefendSP_SpaFortDie");
}

void DefendSP_BeforeSeaBattle(string qName) // убираем солдат наших, если остались
{
	for (int i=0; i<=12; i++)
	{
		if (GetCharacterIndex("DefendSP_soldier_"+i) != -1)
		{
			sld = CharacterFromID("DefendSP_soldier_"+i);
			sld.lifeday = 0;
		}
	}
	// переделываем коммандера и форт
	sld = CharacterFromID("FortFrance Fort Commander");
	sld.FaceId = 204;
	sld.name = "Michel";
	sld.lastname = "de Monper"; 
	sld.ShipEnemyDisable  = true;
	i = FindIsland("Martinique");
	Islands[i].reload.l2.fort.locators = "Martinique_fort1quest_locators";
}

void DefendSP_SeaBattle(string qName) //бой с испанской эскадрой
{
	Island_SetReloadEnableGlobal("Martinique", true);
	Group_SetAddress("MartiniqueQuestSiege", "Martinique", "quest_ships", "quest_ship_1");
	pchar.quest.DefendSP_sea2.win_condition.l1 = "Group_Death";
	pchar.quest.DefendSP_sea2.win_condition.l1.group = "MartiniqueQuestSiege";
	pchar.quest.DefendSP_sea2.function = "DefendSP_SeaAfterBattle";
}

void DefendSP_SeaAfterBattle(string qName) // уничтожили эскадру
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Group_DeleteGroup("MartiniqueQuestSiege");
	pchar.GenQuest.MapClosedNoBattle = true; // patch
	pchar.quest.DefendSP_sea3.win_condition.l1 = "location";
	pchar.quest.DefendSP_sea3.win_condition.l1.location = "FortFrance_town";
	pchar.quest.DefendSP_sea3.function = "DefendSP_Victory";
	AddQuestRecord("Sharlie", "38");
	AddComplexSeaExpToScill(1000, 1000, 1000, 1000, 1000, 1000, 0);
}

void DefendSP_Victory(string qName) // в городе
{
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle"); // patch
	LocatorReloadEnterDisable("FortFrance_town", "reload1_back", true);
	LocatorReloadEnterDisable("FortFrance_town", "reload2_back", true);
	LocatorReloadEnterDisable("FortFrance_town", "reload_gate", true);
	sld = characterFromId("Mishelle");
	sld.dialog.currentnode = "Victory";
	ChangeCharacterAddressGroup(sld, "FortFrance_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void DefendSP_AllClear(string qName) // чистим все по квесту
{
	ref loc;
	for (i=3; i<=10; i++) // открываем заведения
	{
		LocatorReloadEnterDisable("FortFrance_town", "reload"+i+"_back", false);
	}
	sld = characterFromId("FortFrance_usurer");
	ChangeCharacterAddressGroup(sld, "FortFrance_Bank", "barmen", "stay");
	LAi_SetOwnerType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS"); // patch-9
	int n = FindColony("Fortfrance");
	DeleteAttribute(colonies[n], "DontSetShipInPort");//ставить корабли
	// переделываем коммандера и форт
	sld = CharacterFromID("FortFrance Fort Commander");
	sld.FaceId = 5;
	sld.name = "Anry";
	sld.lastname = "Duble"; 
	DeleteAttribute(sld, "ShipEnemyDisable");
	n = FindIsland("Martinique");
	Islands[n].reload.l2.fort.locators = "Martinique_fort1_locators";
	// подменяем файл локаторов на выходе из города
	locations[FindLocation("FortFrance_ExitTown")].models.always.locators = "townExitY_locators";
	DeleteAttribute(&locations[FindLocation("FortFrance_Town")], "QuestCapture");
	DeleteAttribute(&locations[FindLocation("FortFrance_Fort")], "QuestCapture");
	DeleteAttribute(&locations[FindLocation("FortFrance_Dungeon")], "QuestCapture");
	sld = characterFromId("Fortfrance_Poorman");
	ChangeCharacterAddressGroup(sld, "FortFrance_Town", "goto", "goto4");
	DeleteAttribute(&locations[FindLocation("FortFrance_Town")], "hidden_fire");
	DeleteAttribute(&locations[FindLocation("FortFrance_Town")], "hidden_sound");
	DeleteAttribute(pchar, "questTemp.Sharlie.DefendSP");
}

void DefendSP_finaltalk(string qName) // разговор с аббатом
{
	pchar.questTemp.Sharlie = "benua_final";
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////	
// --------------------------------------- В поисках Стража Истины ------------------------------------
////////////////////////////////////////////////////////////////////////////////////////////////////////////
void GuardOT_ExitFrombase(string qName) // вышли из базы
{
	bQuestDisableMapEnter = false;//открыть карту
	sld = characterFromId("spa_baseprisoner");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	AddPassenger(pchar, sld, false);
	SetCharacterRemovable(sld, false);
	pchar.quest.GuardOT_cuba.win_condition.l1 = "location";
	pchar.quest.GuardOT_cuba.win_condition.l1.location = "shore12";
	pchar.quest.GuardOT_cuba.function = "GuardOT_ArriveCuba";
}

void GuardOT_ArriveCuba(string qName) // прибыли в бухту
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("spa_baseprisoner");
	sld.dialog.currentnode = "spa_prisoner_32";
	LAi_CharacterEnableDialog(sld);//разрешение диалога
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "shore12", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void GuardOT_CreateVinsentoAgent(string qName) // пришел посланец Винсенто
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = GetCharacter(NPC_GenerateCharacter("vinsentoagent", "citiz_22", "man", "man", 10, SPAIN, -1, true, "marginal"));
	SetFantomParamFromRank(sld, 10, true);
	sld.dialog.FileName = "Quest\Sharlie\Guardoftruth.c";
	sld.dialog.currentnode = "vinsentoagent";
	RemoveAllCharacterItems(sld, true);
	LAi_SetStayType(sld);
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "mayak9", "goto", LAi_FindFarFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void GuardOT_VinsentoLetterRead() // прочли письмо Винсенто
{
	AddQuestRecord("Guardoftruth", "6");
	pchar.questTemp.Guardoftruth = "portprince";
	sld = characterFromId("Santiago_Lightman");
	pchar.questTemp.Guardoftruth.LMname = GetFullName(sld); // имя смотрителя
}

void GuardOT_CreateTwoShips(string qName) // создаем галеон Гая и каракку торговца
{
	// галеон Гая Марше
	Group_FindOrCreateGroup("Marshe_group");
	Group_SetType("Marshe_group", "trade");//тип группы
	sld = GetCharacter(NPC_GenerateCharacter("GOT_boatsvanDega", "mercen_3", "man", "man", 15, FRANCE, -1, true, "soldier"));
	FantomMakeCoolSailor(sld, SHIP_GALEON_L, "Delicious", CANNON_TYPE_CANNON_LBS16, 50, 50, 50);
	SetFantomParamFromRank(sld, 15, true);
	sld.name = "boatswain Serge";
	sld.lastname = "Dega";
	sld.greeting = "captain";
	sld.Dialog.Filename = "Quest\Sharlie\Guardoftruth.c";
	sld.DeckDialogNode = "boatsvandega";
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "trade";
	RealShips[sti(sld.Ship.Type)].ship.upgrades.sails = 9;
	// грузим ваниль
	int iSpace = GetCharacterFreeSpace(sld, GOOD_CINNAMON);
	Fantom_SetCharacterGoods(sld, GOOD_CINNAMON, iSpace, 1);
	pchar.questTemp.Guardoftruth.VanilleQty = iSpace; // запомним
	// защита от дурака
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable  = true; //не обижаться на выстрелы
	LAi_SetImmortal(sld, true);
	Group_AddCharacter("Marshe_group", "GOT_boatsvanDega");
	Group_SetGroupCommander("Marshe_group", "GOT_boatsvanDega");
	Group_SetTaskNone("Marshe_group");
	Group_SetAddress("Marshe_group", "Guadeloupe", "quest_ships", "quest_ship_1");
	Group_LockTask("Marshe_group");
	
	// каракка испанского торговца под голландским флагом
	Group_FindOrCreateGroup("Gevarra_group");
	Group_SetType("Gevarra_group", "trade");//тип группы
	sld = GetCharacter(NPC_GenerateCharacter("GOT_Gevarra", "trader_5", "man", "man", 15, HOLLAND, -1, true, "soldier"));
	FantomMakeCoolSailor(sld, SHIP_CARACCA, "San Gregorio", CANNON_TYPE_CANNON_LBS12, 50, 50, 50);
	SetFantomParamFromRank(sld, 15, true);
	sld.name = "Carlos";
	sld.lastname = "Gevarra";
	sld.greeting = "captain";
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "trade";
	// защита от дурака
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable  = true; //не обижаться на выстрелы
	LAi_SetImmortal(sld, true);
	Group_AddCharacter("Gevarra_group", "GOT_Gevarra");
	Group_SetGroupCommander("Gevarra_group", "GOT_Gevarra");
	Group_SetTaskNone("Gevarra_group");
	Group_SetAddress("Gevarra_group", "Guadeloupe", "quest_ships", "quest_ship_2");
	Group_LockTask("Gevarra_group");
	// сажаем Марше в таверну
	sld = GetCharacter(NPC_GenerateCharacter("GOT_Marshe", "GayMarshe", "man", "man", 30, FRANCE, -1, true, "soldier"));
	SetFantomParamFromRank(sld, 30, true);
	sld.name = "Guy";
	sld.lastname = "Marshe";
	sld.dialog.FileName = "Quest\Sharlie\Guardoftruth.c";
	sld.dialog.currentnode = "marshe_tavern";
	LAi_SetLoginTime(sld, 7.0, 21.0);
	LAi_SetSitType(sld);
	LAi_SetImmortal(sld, true);
	FreeSitLocator("baster_tavern", "sit2");
	ChangeCharacterAddressGroup(sld, "baster_tavern", "sit", "sit2");
	// ваниль в магазине
	pchar.GenQuest.StoreGoods.StoreIdx = Baster_STORE;
	pchar.GenQuest.StoreGoods.Guardoftruth = true;
	// даем подсказку
	AddQuestRecord("Guardoftruth", "15");
}

void GuardOT_PrepareTrade(string qName) //
{
	sld = characterFromId("GOT_Gevarra");
	sld.DeckDialogNode = "gevarra_16";
}

void GuardOT_TradeComplete(string qName) // типо поторговали - насильно телепортируем ГГ на пляж Капстер
{
	DoQuestFunctionDelay("GuardOT_TradeCompleteNext", 2.0);
}

void GuardOT_TradeCompleteNext(string qName) // типо поторговали - насильно телепортируем ГГ на пляж Капстер
{
	pchar.quest.GuardOT_gotoshore.over = "yes"; //снять прерывание
	pchar.quest.GuardOT_gotoshore1.over = "yes"; //снять прерывание
	// ориентируем на вечер
	int iTime, iAddTime;
	iTime = sti(environment.time);
	if (iTime >= 21) iAddTime = 24 - iTime + 21;
	if (iTime < 7) iAddTime = 21 - iTime;
	if (iTime >= 7 && iTime < 21) iAddTime = 24  + 21 - iTime;
	SetLaunchFrameFormParam("A day passed..."+ NewStr() +"Vanilla was loaded on the carrack...", "", 0, 5);
	LaunchFrameForm();
	StoreDayUpdate();
	WaitDate("",0,0,1,iAddtime,5);
	RecalculateJumpTable();
	RefreshWeather();
	RefreshLandTime();
	DoQuestFunctionDelay("GuardOT_GotoBeach", 5.0);
	// совершаем перестановки
	sld = characterFromId("GOT_Marshe");
	LAi_RemoveLoginTime(sld);
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld = characterFromId("GOT_boatsvanDega");
	sld.DontDeskTalk = true;
	sld.name = "Guy";
	sld.lastname = "Marshe";
	sld.FaceId = 44;
	SetCrewQuantityOverMax(sld, 30);
	RemoveCharacterGoods(pchar, GOOD_CINNAMON, sti(pchar.questTemp.Guardoftruth.VanilleQty));
	sld = characterFromId("GOT_Gevarra");
	sld.lifeday = 0;
	Group_DeleteGroup("Gevarra_group");
}

void GuardOT_GotoBeach(string qName) // телепорт
{
	LocatorReloadEnterDisable("Shore29", "boat", true);
	DoQuestReloadToLocation("Shore29", "reload", "sea", "GuardOT_ArriveBeach");
	setCharacterShipLocation(pchar, "Shore29"));
	setWDMPointXZ("Shore29");
	pchar.questTemp.Guardoftruth = "shore";
}

void GuardOT_EnterInTown(string qName) // пришли в город
{
	chrDisableReloadToLocation = true;//закрыть локацию
	// запустим матросиков гулять
	for (int i=1; i<=15; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("marshe_sailor_"+i, "citiz_"+(rand(9)+31), "man", "man", 10, FRANCE, 1, true, "soldier"));
		SetFantomParamFromRank(sld, 10, true);
		sld.dialog.FileName = "Quest\Sharlie\Guardoftruth.c";
		sld.dialog.currentnode = "marshe_sailor";
		sld.greeting = "habitue";
		LAi_SetWarriorType(sld);
		LAi_warrior_DialogEnable(sld, true);
		ChangeCharacterAddressGroup(sld, "Baster_town", "goto", "goto"+i);
		LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	}
	DoQuestFunctionDelay("GuardOT_ManyDrunkSailors", 5.0);
}

void GuardOT_ManyDrunkSailors(string qName) // увидели все это безобразие
{
	chrDisableReloadToLocation = false;
	DeleteAttribute(&locations[FindLocation("Deck_Galeon_Ship")], "boarding");
	AddQuestRecord("Guardoftruth", "19");
	pchar.quest.GuardOT_marchtogaleon.win_condition.l1 = "locator";
	pchar.quest.GuardOT_marchtogaleon.win_condition.l1.location = "shore29";
	pchar.quest.GuardOT_marchtogaleon.win_condition.l1.locator_group = "reload";
	pchar.quest.GuardOT_marchtogaleon.win_condition.l1.locator = "boat";
	pchar.quest.GuardOT_marchtogaleon.function = "GuardOT_GotoGaleon";
	// заполним сундуки
	pchar.GenQuestBox.Deck_Galeon_Ship = true;
	pchar.GenQuestBox.Deck_Galeon_Ship.box1.money = 5221;
	pchar.GenQuestBox.Deck_Galeon_Ship.box1.items.gold_dublon = 28;
	pchar.GenQuestBox.Deck_Galeon_Ship.box1.items.chest_open = 6;
	pchar.GenQuestBox.Deck_Galeon_Ship.box1.items.chest = 1;
	pchar.GenQuestBox.Deck_Galeon_Ship.box2.items.totem_02 = 1;
	pchar.GenQuestBox.Deck_Galeon_Ship.box2.items.purse3 = 1;
	pchar.GenQuestBox.Deck_Galeon_Ship.box2.items.jewelry52 = 20;
	pchar.GenQuestBox.Deck_Galeon_Ship.box2.items.map_hisp = 1;
	pchar.GenQuestBox.Deck_Galeon_Ship.box3.money = 100000;
	pchar.GenQuestBox.Deck_Galeon_Ship.box3.items.obereg_8 = 1;
	pchar.GenQuestBox.Deck_Galeon_Ship.box3.items.jewelry14 = 2;
	pchar.GenQuestBox.Deck_Galeon_Ship.box3.items.jewelry21 = 3;
	pchar.GenQuestBox.Deck_Galeon_Ship.box3.items.potion7 = 1;
}

void GuardOT_GotoGaleon(string qName) // телепортируем на галеон
{
	for (int i=1; i<=20; i++)
	{
		if (GetCharacterIndex("caleuche_pcrew_"+i) != -1)
		{
			sld = characterFromId("caleuche_pcrew_"+i);
			sld.lifeday = 0;
		}
	} // предохранительный клапан
	LAi_LocationDisableOfficersGen("Deck_Galeon_Ship", false);
	DoQuestReloadToLocation("Deck_Galeon_Ship", "reload", "reload2", "GuardOT_ArriveGaleon");
}

void GuardOT_KickGuard(string qName) // тюк!
{
	int num = sti(pchar.questTemp.Guardoftruth.num);
	LAi_SetPlayerType(pchar);
	CreateLocationParticles("blood_big", "item", "kick"+num, 2.0, 0, 0, "");
	PlaySound("People\jump.wav");
	PlaySound("People Fight\Damage_NPC_0"+(rand(2)+4)+".wav");
	sld = characterFromId("GuardOT_galeonguard_"+num);
	LAi_RemoveCheckMinHP(sld);
	LAi_KillCharacter(sld);
	AddCharacterExpToSkill(pchar, "Sneak", 100);//скрытность
	AddCharacterExpToSkill(pchar, "Fortune", 100);//везение
}

void GuardOT_GaleonGuardFightAdd() // выбежала подмога
{
	PlaySound("interface\abordage_wining.wav");
	PlaySound("interface\abordage_wining.wav");
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 65;
	for (int i=1; i<=8; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("GuardOT_galeonguardadd_"+i, "citiz_"+(rand(9)+31), "man", "man", iRank, PIRATE, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_12", "pistol1", "bullet", iScl*2+50);
		ChangeCharacterAddressGroup(sld, "Deck_Galeon_Ship", "reload", "reload1");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "GaleonFight");
	}
	sld = GetCharacter(NPC_GenerateCharacter("GuardOT_galeonguardaddmush", "mush_ctz_"+(4+rand(2)), "man", "mushketer", iRank, PIRATE, -1, false, "soldier"));
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2+50);
	sld.MusketerDistance = 0;
	ChangeCharacterAddressGroup(sld, "Deck_Galeon_Ship", "goto", "mush");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "GaleonFight");
}

void GuardOT_ExitGaleon(string qName) // вышли с галеона
{
	Island_SetReloadEnableGlobal("Guadeloupe", false);
	SetFunctionTimerCondition("GuardOT_GuadeloupeOpen", 0, 0, 2, false); // таймер
	LocatorReloadEnterDisable("Shore29", "boat", false);
	DoQuestReloadToLocation("shore29", "reload", "sea", "OpenTheDoors");
	DeleteAttribute(pchar, "GenQuest.Notsearchbody");
	DeleteAttribute(pchar, "GenQuest.CannotWait");
	InterfaceStates.Buttons.Save.enable = true;
	bQuestDisableMapEnter = false;
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	sld = characterFromId("GOT_Marshe");
	DeleteAttribute(sld, "LifeDay");
	AddPassenger(pchar, sld, false);
	SetCharacterRemovable(sld, false);
	pchar.questTemp.Guardoftruth = "gotomayak";
	sld = characterFromId("GOT_boatsvanDega");
	sld.name = "";
	sld.lastname = "";
	sld.FaceId = 333;
	sld.lifeday = 1;
	AddQuestRecord("Guardoftruth", "20");
	pchar.quest.GuardOT_arrive_tomayak.win_condition.l1 = "Ship_location";
	pchar.quest.GuardOT_arrive_tomayak.win_condition.l1.location = "mayak9";
	pchar.quest.GuardOT_arrive_tomayak.function = "GuardOT_ArriveToMayak";
}

void GuardOT_GuadeloupeOpen(string qName) // открываем остров
{
	Island_SetReloadEnableGlobal("Guadeloupe", true);
}

void GuardOT_ArriveToMayak(string qName) // прибыли на маяк
{
	Group_DeleteGroup("Marshe_group"); // patch
	LocatorReloadEnterDisable("mayak9", "boat", true);
	sld = characterFromId("GOT_Marshe");
	RemovePassenger(pchar, sld);
	LAi_SetActorType(sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "mayak9", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_ActorFollowEverywhere(sld, "", -1);
	pchar.questTemp.Guardoftruth = "mayak";
}

void GuardOT_MayakNextStage(string qName) // идем за письмом
{
	pchar.questTemp.Guardoftruth = "mayak_next";
}

void GuardOT_VinsentoNextLetterRead() // прочли письмо Винсенто
{
	pchar.questTemp.Guardoftruth = "utensil";
	AddQuestRecord("Guardoftruth", "22");
}

void GuardOT_DominicaChest(string qName) // нашли сундук в бухте
{
	chrDisableReloadToLocation = true;//закрыть локацию
	string sTemp;
	if (pchar.location.from_sea == "shore27") sTemp = "boat";
	else sTemp = "reload2_back";
	pchar.quest.GuardOT_createhunters.win_condition.l1 = "locator";
	pchar.quest.GuardOT_createhunters.win_condition.l1.location = "shore27";
	pchar.quest.GuardOT_createhunters.win_condition.l1.locator_group = "reload";
	pchar.quest.GuardOT_createhunters.win_condition.l1.locator = sTemp;
	pchar.quest.GuardOT_createhunters.function = "GuardOT_CreateDominicaHunters";
	AddQuestRecord("Guardoftruth", "25");
	AddCharacterExpToSkill(pchar, "Fortune", 300);
}

void GuardOT_CreateDominicaHunters(string qName) // 
{
	DoQuestCheckDelay("hide_weapon", 1.0); // patch-9
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 50;
	for (i=1; i<=8; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("GuardOT_DH_"+i, "off_eng_"+i, "man", "man", iRank+5, ENGLAND, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_13", "pistol4", "bullet", iScl*2);
			sld.Dialog.Filename = "Quest\Sharlie\Guardoftruth.c";
			sld.dialog.currentnode = "dominica_hunter";
		}
		else
		{
			if (i >= 2 && i < 4)
			{
				sld = GetCharacter(NPC_GenerateCharacter("GuardOT_DH_"+i, "mush_eng_"+i, "man", "mushketer", iRank, ENGLAND, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "bullet", iScl*2);
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("GuardOT_DH_"+i, "sold_eng_"+i, "man", "man", iRank, ENGLAND, -1, true, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_12","blade_14"), "pistol1", "bullet", iScl*2);
			}
			LAi_CharacterDisableDialog(sld);
		}
		LAi_SetWarriorType(sld);
		ChangeCharacterAddressGroup(sld, "shore27", "quest", "LLquest1");
	}
	sld = characterFromId("GuardOT_DH_1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void GuardOT_FadeyTimer(string qName) // 
{
	pchar.questTemp.Guardoftruth.Baster_church = "find";
}

void GuardOT_InCaveEntrance(string qName) // ставим встречающего
{
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	locations[FindLocation("Cumana_Cave")].DisableEncounters = true; // patch
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 65;
	sld = GetCharacter(NPC_GenerateCharacter("GOT_bandos_0", "mush_ctz_9", "man", "mushketer", iRank, PIRATE, -1, true, "marginal"));
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
	sld.dialog.FileName = "Quest\Sharlie\Guardoftruth.c";
	sld.dialog.currentnode = "bandos_mush";
	ChangeCharacterAddressGroup(sld, "Cumana_CaveEntrance", "monsters", "monster1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void GuardOT_InCumanaCave(string qName) // 
{
	WaitDate("", 0, 0, 0, 1, 10); //fix 080812
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 50;
	sld = GetCharacter(NPC_GenerateCharacter("GOT_Bart", "mercen_21", "man", "man", iRank, PIRATE, -1, true, "marginal"));
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_07", "pistol1", "bullet", iScl*2);
	sld.dialog.FileName = "Quest\Sharlie\Guardoftruth.c";
	sld.dialog.currentnode = "barty";
	sld.name = "Barty";
	sld.lastname = "Flayer";
	sld.LSC_clan = true;
	LAi_SetCheckMinHP(sld, 10, true, "GuardOT_BartyEscape");
	LAi_SetStayType(sld);
	ChangeCharacterAddressGroup(sld, "Cumana_Cave", "quest", "quest0");
	for (i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("GOT_bandos_"+i, "citiz_4"+i, "man", "man", iRank, PIRATE, -1, true, "marginal"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_07", "pistol1", "bullet", iScl*2);
		sld.LSC_clan = true;
		LAi_CharacterDisableDialog(sld);
		LAi_SetStayType(sld);
		ChangeCharacterAddressGroup(sld, "Cumana_Cave", "quest", "quest"+i);
	}
}

void GuardOT_InCumanaCaveEnemyAdd() // добавляем противников
{
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 50;
	for (int i=3; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("GOT_bandos_"+i, "citiz_4"+i, "man", "man", iRank, PIRATE, -1, true, "marginal"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_07", "pistol1", "bullet", iScl*2);
		sld.LSC_clan = true;
		LAi_CharacterDisableDialog(sld);
		LAi_SetWarriorType(sld);
		ChangeCharacterAddressGroup(sld, "Cumana_Cave", "monsters", "monster"+(i+3));
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	sld = characterFromId("GOT_bandos_0");
	sld.MusketerDistance = 0;
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	ChangeCharacterAddressGroup(sld, "Cumana_Cave", "monsters", "monster1");
}

void GuardOT_SetOfficerCumanaCave(string qName) //
{
	for(int i=1; i<=3; i++)
	{
		int idx = GetOfficersIndex(pchar, i);
		if(idx < 0) continue;
		sld = &Characters[idx];
		ChangeCharacterAddressGroup(sld, "Cumana_Cave", "reload", "reload2");
	}
}

void GuardOT_MayakLastStage(string qName) // 
{
	pchar.questTemp.Guardoftruth = "inquisition";
}

void GuardOT_SetPadreVincento() // ставим отца Винсенто
{
	LAi_LocationFightDisable(&Locations[FindLocation("Santiago_Incquisitio")], true);//запретим шалить
	sld = GetCharacter(NPC_GenerateCharacter("Vincento", "vincento", "man", "man_B", 35, SPAIN, -1, true, "quest"));
	SetFantomParamFromRank(sld, 35, true);
	sld.name = "Father Vincento";
	sld.lastname = "";
	sld.dialog.FileName = "Quest\Sharlie\Vincento.c";
	sld.dialog.currentnode = "First time";
	sld.greeting = "vincento_1";
	RemoveAllCharacterItems(sld, true);
	LAi_SetHuberType(sld);
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "Santiago_Incquisitio", "sit", "armchair1");
	LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
}

void GuardOT_SetDiegoOnMayak(string qName) // ставим Диего
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);
	chrDisableReloadToLocation = true;//закрыть локацию
	// Диего, косит под офицера патруля
	sld = characterFromId("Diego");
	sld.name = "Pedro";
	sld.lastname = "Lopez";
	sld.dialog.FileName = "Quest\Sharlie\Diego.c";
	sld.dialog.currentnode = "patrol";
	sld.greeting = "patrol";
	LAi_SetImmortal(sld, true);
	LAi_SetActorType(sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "mayak1", "goto", LAi_FindFarFreeLocator("goto", locx, locy, locz));
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	// сопровождение
	for(int i=1; i<=3; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("GOT_spamayaksold_"+i, "sold_spa_"+i, "man", "man", 35, SPAIN, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, 35, 100, 100, "blade_13", "pistol1", "bullet", 100);
		LAi_CharacterDisableDialog(sld);
		LAi_SetActorType(sld);
		GetCharacterPos(pchar, &locx, &locy, &locz);
		ChangeCharacterAddressGroup(sld, "mayak1", "goto", LAi_FindFarFreeLocator("goto", locx, locy, locz));
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void GuardOT_SetSpaOfficerInTown(string qName) // ставим знакомца-офицера
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("spa_baseprisoner");
	sld.model = "q_spa_off_2";
	Characters_RefreshModel(sld);
	sld.dialog.currentnode = "spa_prisoner_39";
	GiveItem2Character(sld, "blade_13");
	sld.equip.blade = "blade_13";
	GiveItem2Character(sld, "pistol4");
	EquipCharacterbyItem(sld, "pistol4");
	TakeNItems(sld, "bullet", 50);
	TakeNItems(sld, "gunpowder", 50);
	TakeNItems(sld, "potion2", 10);
	LAi_SetCharacterUseBullet(sld, "bullet");
	LAi_SetActorType(sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "Santiago_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void GuardOT_SetBandosInTown(string qName) // напали бандосы
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);
	chrDisableReloadToLocation = true;//закрыть локацию
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 55;
	for(int i=1; i<=5; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("GOT_santiagoband_"+i, "citiz_58", "man", "man", iRank, SPAIN, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_06", "pistol5", "bullet", iScl*2);
		sld.Dialog.Filename = "Quest\Sharlie\guardoftruth.c";
		sld.Dialog.currentnode = "spa_hunter";
		sld.greeting = "hunter";
		if (i != 1) LAi_CharacterDisableDialog(sld);
		LAi_SetActorType(sld);
		GetCharacterPos(pchar, &locx, &locy, &locz);
		ChangeCharacterAddressGroup(sld, "Santiago_town", "goto", LAi_FindFarFreeLocator("goto", locx, locy, locz));
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void GuardOT_Cuba2Arrive(string qName) // вышли у Гаваны
{
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	AddQuestRecord("Guardoftruth", "46");
	pchar.quest.GuardOT_Batabano.win_condition.l1 = "location";
	pchar.quest.GuardOT_Batabano.win_condition.l1.location = "Shore13";
	pchar.quest.GuardOT_Batabano.function = "GuardOT_BatabanoArrive";
}

void GuardOT_BatabanoArrive(string qName) // в заливе Батабано
{
	LocatorReloadEnterDisable("Shore13", "boat", true);
	sld = CharacterFromID("Havana_tavernkeeper");
	sld.quest.batabano = true;
}

void GuardOT_SanAntonioPrepare(string qName) // ставим абордажную роту
{
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	// устанавливаем солдат ГГ, 9 рыл+офицер
	int iRank = 25+MOD_SKILL_ENEMY_RATE+5;
	int iScl = 60;
	for (int i=1; i<=10; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("GuardOT_Oursoldier_"+i, "mercen_25", "man", "man", iRank+5, FRANCE, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_13", "pistol4", "bullet", iScl*2+50);
			sld.dialog.FileName = "Quest\Sharlie\guardoftruth.c";
			sld.dialog.currentnode = "batabano_officer";
		}
		else
		{
			if (i == 2 || i == 3)
			{
				sld = GetCharacter(NPC_GenerateCharacter("GuardOT_Oursoldier_"+i, "mush_ctz_"+(4+rand(2)), "man", "mushketer", iRank, FRANCE, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("GuardOT_Oursoldier_"+i, "citiz_"+(31+rand(9)), "man", "man", iRank, FRANCE, -1, true, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_10","blade_11"), "pistol1", "bullet", iScl*2);
			}
			LAi_CharacterDisableDialog(sld);
		}
		ChangeCharacterAddressGroup(sld, "Shore13", "reload", "sea");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
}

void GuardOT_SanAntonio_Timer(string qName) // метка на время
{
	pchar.questTemp.Guardoftruth.SanAntonio = "true";
}

void GuardOT_SanantonioArrive(string qName) // высадка на мыс
{
	DoQuestFunctionDelay("GuardOT_CreateDiegoShoreGuard", 2.0);
}

void GuardOT_CreateDiegoShoreGuard(string qName) // гишпанцы вылезли из кустов
{
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "rld", "loc3");
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);
	chrDisableReloadToLocation = true;//закрыть локацию
	// ставим испанцев
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 60;
	for (int i=1; i<=13; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("GOT_spashore_"+i, "off_spa_"+i, "man", "man", iRank+5, SPAIN, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_16", "pistol4", "bullet", iScl*2+50);
			ChangeCharacterAddressGroup(sld, "Shore15", "quest", "quest2");
		}
		else
		{
			if (i >= 2 && i < 6)
			{
				sld = GetCharacter(NPC_GenerateCharacter("GOT_spashore_"+i, "mush_spa_"+i, "man", "mushketer", iRank, SPAIN, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
				ChangeCharacterAddressGroup(sld, "Shore15", "quest", "quest1");
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("GOT_spashore_"+i, "sold_spa_"+i, "man", "man", iRank, SPAIN, -1, true, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_12","blade_14"), "pistol1", "bullet", iScl*2);
				ChangeCharacterAddressGroup(sld, "Shore15", "reload", "reload1");
			}
		}
		LAi_SetActorType(sld);
		LAi_ActorRunToLocator(sld, "rld", "loc"+i, "", -1);
		DoQuestCheckDelay("GuardOT_DiegoShoreGuardReady", 5.0);
	}
}

void GuardOT_CreateDiegoShips(string qName) //
{
	// убираем за собой
	for (i=1; i<=10; i++)
	{
		if (GetCharacterIndex("GuardOT_Oursoldier_"+i) != -1)
		{
			sld = CharacterFromID("GuardOT_Oursoldier_"+i);
			sld.lifeday = 0;
		}
	}
	LocatorReloadEnterDisable("shore15", "reload1_back", false);
	Island_SetReloadEnableGlobal("Cuba2", false);//на остров нельзя
	Group_FindOrCreateGroup("Diegohaleon_group");
	Group_SetType("Diegohaleon_group", "war");//тип группы
	sld = GetCharacter(NPC_GenerateCharacter("Diegohaleon_cap", "off_spa_2", "man", "man", 35, SPAIN, -1, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_GALEON_H, "San Markos", CANNON_TYPE_CANNON_LBS32, 80, 80, 80);
	FantomMakeCoolFighter(sld, 35, 80, 80, "blade_15", "pistol5", "bullet", 150);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "war";
	sld.alwaysEnemy = true;
	sld.Coastal_Captain = true;
	sld.ship.Crew.Morale = MOD_SKILL_ENEMY_RATE*10;
	sld.Ship.Crew.Exp.Sailors = MOD_SKILL_ENEMY_RATE*10;
	sld.Ship.Crew.Exp.Cannoners = MOD_SKILL_ENEMY_RATE*10;
	sld.Ship.Crew.Exp.Soldiers = MOD_SKILL_ENEMY_RATE*10;
	if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("Diegohaleon_group", "Diegohaleon_cap");
	Group_SetGroupCommander("Diegohaleon_group", "Diegohaleon_cap");
	Group_SetTaskAttack("Diegohaleon_group", PLAYER_GROUP);
	Group_SetAddress("Diegohaleon_group", "Cuba2", "quest_ships", "quest_ship_5");
	Group_LockTask("Diegohaleon_group");
	
	pchar.quest.GuardOT_diegoGaleondie.win_condition.l1 = "Group_Death";
	pchar.quest.GuardOT_diegoGaleondie.win_condition.l1.group = "Diegohaleon_group";
	pchar.quest.GuardOT_diegoGaleondie.function = "GuardOT_DiegoGaleonAfterBattle";
}

void GuardOT_DiegoGaleonAfterBattle(string qName)
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Group_DeleteGroup("Diegohaleon_group");
	bQuestDisableMapEnter = false;
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	AddQuestRecord("Guardoftruth", "50");
	GuardOT_CreateDiegoLuggerInWorld();
	pchar.quest.GuardOT_diegoluggerstart.win_condition.l1 = "MapEnter";
	pchar.quest.GuardOT_diegoluggerstart.function = "GuardOT_LuggerClear";
	AddComplexSeaExpToScill(150, 150, 150, 150, 150, 150, 0);
}

void GuardOT_LuggerClear(string qName)
{
	pchar.nation = FRANCE; // принудительно
	Island_SetReloadEnableGlobal("Cuba2", true);
	questwdmLockReload = true;
	pchar.worldmapencountersoff = "1";
	pchar.quest.GuardOT_diegoGaleondie.win_condition.l1 = "Group_Death";
	pchar.quest.GuardOT_diegoGaleondie.win_condition.l1.group = "Diego_group";
	pchar.quest.GuardOT_diegoGaleondie.function = "GuardOT_CatocheEnter";
}

void GuardOT_CreateDiegoLuggerInWorld()
{
	sld = GetCharacter(NPC_GenerateCharacter("Diego_clone", "diego_1", "man", "man", 35, SPAIN, 3, true, "soldier"));
	FantomMakeCoolSailor(sld, SHIP_CAREERLUGGER, "Shadow", CANNON_TYPE_CANNON_LBS12, 100, 100, 100);
	FantomMakeCoolFighter(sld, 35, 100, 100, "blade_15", "pistol5", "bullet", 250);
	sld.FaceId = 203;
	sld.name = "Diego";
	sld.lastname = "de Montoya";
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "war";
	SetSailsColor(sld, 8);//черный парус
	// защита от дурака
	sld.Abordage.Enable = true;
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable  = true; //не обижаться на выстрелы
	LAi_SetImmortal(sld, true);
	// чит
	ref shTo = &RealShips[sti(sld.Ship.Type)];
	shTo.SpeedRate = 25.0;
	shTo.TurnRate = 80.0;
	//в морскую группу
	string sGroup = "Diego_group";
	Group_FindOrCreateGroup(sGroup);
	Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
	Group_LockTask(sGroup);
	Group_AddCharacter(sGroup, sld.id);
	Group_SetGroupCommander(sGroup, sld.id);
	sld.mapEnc.type = "trade";
	sld.mapEnc.worldMapShip = "quest_ship";
	sld.mapEnc.Name = "Carrier lugger 'Shadow'";
	Map_CreateCoolTrader("shore15", "shore6", sld.id, 2, 1.7);
}	

void GuardOT_CatocheEnter(string qName)
{
	Group_DeleteGroup("Diego_group");
	questwdmLockReload = false;
	pchar.worldmapencountersoff = "0";
	pchar.quest.GuardOT_CatocheArrive1.win_condition.l1 = "location";
	pchar.quest.GuardOT_CatocheArrive1.win_condition.l1.location = "Beliz";
	pchar.quest.GuardOT_CatocheArrive1.function = "GuardOT_CreateCatocheSquadron";
}

void GuardOT_CreateCatocheSquadron(string qName) // эскадра Диего
{
	AddQuestRecord("Guardoftruth", "51");
	Island_SetReloadEnableGlobal("Beliz", false); // закрыть остров
	bQuestDisableMapEnter = true; // закрыть карту
	pchar.nation = FRANCE; // принудительно
	pchar.DisableChangeFlagMode = true; // запретить менять флаг
	SetNationRelation2MainCharacter(SPAIN, RELATION_FRIEND);
	SetNationRelation2MainCharacter(FRANCE, RELATION_FRIEND);
	SetNationRelation2MainCharacter(ENGLAND, RELATION_NEUTRAL);
	// ставим люггер Диего
	Group_FindOrCreateGroup("camicadze_group");
	sld = GetCharacter(NPC_GenerateCharacter("GOT_camicadze", "off_spa_1", "man", "man", 35, SPAIN, 2, true, "soldier"));
	FantomMakeCoolSailor(sld, SHIP_CAREERLUGGER, "Shadow", CANNON_TYPE_CANNON_LBS12, 100, 100, 100);
	sld.FaceId = 333;
	sld.name = "";
	sld.lastname = "";
	ref realShip = GetRealShip(GetCharacterShipType(sld));
	realShip.lowpolycrew = 0; // убрать матросиков с палубы корабля
	SetCrewQuantityOverMax(sld, 0);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "war";
	sld.DontDeskTalk = true;
	SetSailsColor(sld, 8);//черный парус
	sld.Abordage.Enable = true;
	sld.ShipEnemyDisable  = true; //не обижаться на выстрелы
	AddCharacterGoods(sld, GOOD_POWDER, 1000);
	Group_AddCharacter("camicadze_group", "GOT_camicadze");
	Group_SetGroupCommander("camicadze_group", "GOT_camicadze");
	Group_SetTaskNone("camicadze_group");
	Group_SetAddress("camicadze_group", "Beliz", "quest_ships", "quest_ship_9");
	Group_LockTask("camicadze_group");
	// ставим эскадру Диего - ВК, 2 ТГ, шебека
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 60;
	int iShip, iCannon;
	Group_FindOrCreateGroup("Catoche_group");
	Group_SetType("Catoche_group", "war");//тип группы
	for (int i=1; i<=4; i++)
	{
		switch (i)
		{
			case 1:
				iShip = SHIP_LINESHIP;
				iCannon = CANNON_TYPE_CANNON_LBS32;
			break;
			
			case 2:
				iShip = SHIP_GALEON_H;
				iCannon = CANNON_TYPE_CANNON_LBS32;
			break;
			
			case 3:
				iShip = SHIP_GALEON_H;
				iCannon = CANNON_TYPE_CANNON_LBS24;
			break;
			
			case 4:
				iShip = SHIP_XebekVML;
				iCannon = CANNON_TYPE_CULVERINE_LBS18;
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("GOT_catochecap_"+i, "off_spa_"+i, "man", "man", iRank, SPAIN, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, iScl, iScl, iScl);
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_13", "pistol5", "bullet", iScl*2+50);
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.watchfort = true;
		sld.Ship.Mode = "war";
		sld.alwaysEnemy = true;
		sld.Coastal_Captain = true;
		sld.ship.Crew.Morale = MOD_SKILL_ENEMY_RATE*7+30;
		sld.Ship.Crew.Exp.Sailors = MOD_SKILL_ENEMY_RATE*7+30;
		sld.Ship.Crew.Exp.Cannoners = MOD_SKILL_ENEMY_RATE*7+30;
		sld.Ship.Crew.Exp.Soldiers = MOD_SKILL_ENEMY_RATE*7+30;
		if (MOD_SKILL_ENEMY_RATE > 4 && i < 3) SetCharacterPerk(sld, "MusketsShoot");
		Group_AddCharacter("Catoche_group", "GOT_catochecap_"+i);
	}
	Group_SetGroupCommander("Catoche_group", "GOT_catochecap_1");
	Group_SetTaskAttack("Catoche_group", PLAYER_GROUP);
	Group_SetAddress("Catoche_group", "Beliz", "quest_ships", "quest_ship_8");
	Group_LockTask("Catoche_group");
	
	pchar.quest.GuardOT_catocheshipsdie.win_condition.l1 = "Group_Death";
	pchar.quest.GuardOT_catocheshipsdie.win_condition.l1.group = "Catoche_group";
	pchar.quest.GuardOT_catocheshipsdie.function = "GuardOT_CatocheSquadronDie";
}

void GuardOT_CamicadzeBoom()
{
	log_info("Whole powder supply got exploded on 'Shadow'!")
	sld = characterFromId("GOT_camicadze");
	PostEvent(SHIP_BRANDER_DETONATE, 800, "l", sti(sld.index));
    PlaySound("Sea Battles\Vzriv_fort_001.wav");
	Ship_SetTaskNone(SECONDARY_TASK, sti(sld.index));
}

void GuardOT_CatocheSquadronDie(string qName) // прибили эскадру Диего
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.GenQuest.MapClosedNoBattle = true;
	Group_DeleteGroup("Catoche_group");
	AddQuestRecord("Guardoftruth", "52");
	Island_SetReloadEnableGlobal("Beliz", true);
	pchar.quest.GuardOT_catochecoast.win_condition.l1 = "location";
	pchar.quest.GuardOT_catochecoast.win_condition.l1.location = "shore6";
	pchar.quest.GuardOT_catochecoast.function = "GuardOT_CatocheCoastBattle";
	AddComplexSeaExpToScill(250, 250, 250, 250, 250, 250, 0);
}

void GuardOT_CatocheCoastBattle(string qName) // бой на берегу
{
	Group_DeleteGroup("camicadze_group");
	chrDisableReloadToLocation = true;
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 55;
	// наши
	for (int i=1; i<=15; i++)
	{
		if (i == 1 || i == 12)
		{
			sld = GetCharacter(NPC_GenerateCharacter("GuardOT_soldier_"+i, "mush_ctz_"+(4+rand(2)), "man", "mushketer", iRank, FRANCE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("GuardOT_soldier_"+i, "citiz_"+(31+rand(9)), "man", "man", iRank, FRANCE, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_10","blade_11"), "pistol1", "bullet", iScl*2);
		}
		LAi_CharacterDisableDialog(sld);
		LAi_SetWarriorType(sld);
		if (i < 8) ChangeCharacterAddressGroup(sld, "Shore6", "rld", "aloc1");
		else ChangeCharacterAddressGroup(sld, "Shore6", "rld", "aloc0");
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	// испанцы
	for (i=1; i<=10; i++)
	{
		if (i > 7)
		{
			sld = GetCharacter(NPC_GenerateCharacter("GuardOT_coastsoldier_"+i, "mush_spa_"+(1+rand(2)), "man", "mushketer", iRank, SPAIN, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
		}
		else
		{
			if (i == 1)
			{
				sld = GetCharacter(NPC_GenerateCharacter("GuardOT_coastsoldier_"+i, "off_spa_3", "man", "man", iRank+5, SPAIN, -1, true, "soldier"));
				FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_13", "pistol4", "bullet", iScl*2+50);
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("GuardOT_coastsoldier_"+i, "sold_spa_"+i, "man", "man", iRank, SPAIN, -1, true, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_10","blade_11"), "pistol1", "bullet", iScl*2);
			}
		}
		LAi_CharacterDisableDialog(sld);
		LAi_SetWarriorType(sld);
		if (i > 7)
		{
			ChangeCharacterAddressGroup(sld, "Shore6", "rld", "loc"+i);
			sld.MusketerDistance = 0;
		}
		else ChangeCharacterAddressGroup(sld, "Shore6", "rld", "loc1");
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "GuardOT_CoastalGuardDie");
	LAi_SetFightMode(pchar, true);
}

void GuardOT_CatchOurSoldiers() // собрать солдат
{
	for (int i=1; i<=15; i++)
	{
		if (GetCharacterIndex("GuardOT_soldier_"+i) != -1)
		{
			sld = CharacterFromID("GuardOT_soldier_"+i);
			if (LAi_GetCharacterHP(sld) > 0)
			{
				LAi_SetActorType(sld);
				LAi_ActorFollowEverywhere(sld, "", -1);
				LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
			}
		}
	}
}

void GuardOT_OurSoldiersFight() // приказ солдатам атаковать
{
	for (int i=1; i<=15; i++)
	{
		if (GetCharacterIndex("GuardOT_soldier_"+i) != -1)
		{
			sld = CharacterFromID("GuardOT_soldier_"+i);
			LAi_SetWarriorType(sld);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
}

void GuardOT_CreateExitFortGuard(string qName) // бой на выходе из форта
{
	chrDisableReloadToLocation = true;
	GuardOT_OurSoldiersFight();
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 50;
	// испанцы
	for (i=1; i<=10; i++)
	{
		if (i > 8)
		{
			sld = GetCharacter(NPC_GenerateCharacter("GuardOT_exitsoldier_"+i, "mush_spa_"+(1+rand(2)), "man", "mushketer", iRank, SPAIN, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
		}
		else
		{
			if (i == 1)
			{
				sld = GetCharacter(NPC_GenerateCharacter("GuardOT_exitsoldier_"+i, "off_spa_3", "man", "man", iRank+5, SPAIN, -1, true, "soldier"));
				FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_13", "pistol4", "bullet", iScl*2+50);
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("GuardOT_exitsoldier_"+i, "sold_spa_"+i, "man", "man", iRank, SPAIN, -1, true, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_10","blade_11"), "pistol1", "bullet", iScl*2);
			}
		}
		LAi_CharacterDisableDialog(sld);
		LAi_SetWarriorType(sld);
		if (i > 8) sld.MusketerDistance = 0;
		ChangeCharacterAddressGroup(sld, "Jungle_fort_exit", "rld", "loc"+i);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "GuardOT_ExitfortGuardDie");
	LAi_SetFightMode(pchar, true);
}

void GuardOT_CreateFortGuard(string qName) // бой внутри форта
{
	chrDisableReloadToLocation = true;
	GuardOT_OurSoldiersFight();
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 50;
	// испанцы
	for (i=1; i<=12; i++)
	{
		if (i > 8)
		{
			sld = GetCharacter(NPC_GenerateCharacter("GuardOT_fortsoldier_"+i, "mush_spa_"+(1+rand(2)), "man", "mushketer", iRank, SPAIN, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
		}
		else
		{
			if (i < 3)
			{
				sld = GetCharacter(NPC_GenerateCharacter("GuardOT_fortsoldier_"+i, "off_spa_3", "man", "man", iRank+5, SPAIN, -1, true, "soldier"));
				FantomMakeCoolFighter(sld, iRank+5, iScl+10, iScl+10, "blade_13", "pistol4", "bullet", iScl*2);
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("GuardOT_fortsoldier_"+i, "sold_spa_"+i, "man", "man", iRank, SPAIN, -1, true, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_10","blade_11"), "pistol1", "bullet", iScl*2);
			}
		}
		LAi_CharacterDisableDialog(sld);
		LAi_SetWarriorType(sld);
		if (i > 8) sld.MusketerDistance = 0;
		ChangeCharacterAddressGroup(sld, "Jungle_fort", "rld", "loc"+i);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "GuardOT_FortGuardDie");
	LAi_SetFightMode(pchar, true);
}

void GuardOT_SetDiegoFortInside(string qName) // бой в резиденции
{
	chrDisableReloadToLocation = true;
	InterfaceStates.Buttons.Save.enable = false;
	pchar.GenQuest.NoDelBody = true;
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 70;
	// испанцы
	int n = MOD_SKILL_ENEMY_RATE/2;
	for (int i=2; i<=n; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("GuardOT_ressoldier_"+i, "sold_spa_"+i, "man", "man", iRank, SPAIN, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_13","blade_10"), "pistol5", "bullet", iScl*2+50);
		LAi_CharacterDisableDialog(sld);
		LAi_SetWarriorType(sld);
		ChangeCharacterAddressGroup(sld, "Jungle_fort_ammo", "rld", "loc"+i);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	// мушкетер
	sld = GetCharacter(NPC_GenerateCharacter("GuardOT_resmushketer", "mush_spa_2", "man", "mushketer", 35, SPAIN, -1, false, "soldier"));
	FantomMakeCoolFighter(sld, 35, 95, 95, "", "mushket2", "cartridge", 100);
	sld.SaveItemsForDead = true; // сохранять на трупе вещи
	sld.DontClearDead = true; // не убирать труп через 200с
	sld.MusketerDistance = 0;
	LAi_SetWarriorType(sld);
	ChangeCharacterAddressGroup(sld, "Jungle_fort_ammo", "rld", "loc0");
	LAi_group_MoveCharacter(sld, "EnemyFight");
	// Диего
	sld = characterFromId("Diego");
	GiveItem2Character(sld, "skinmap");
	GiveItem2Character(sld, "recipe_totem_05");
	GiveItem2Character(sld, "totem_05");
	LAi_SetImmortal(sld, false);
	TargetAdmiralMapToCharacter(sld, "A_map_beliz"); // 260912
	sld.SaveItemsForDead = true; // сохранять на трупе вещи
	sld.DontClearDead = true; // не убирать труп через 200с
	LAi_SetWarriorType(sld);
	ChangeCharacterAddressGroup(sld, "Jungle_fort_ammo", "rld", "loc1");
	LAi_group_MoveCharacter(sld, "EnemyFight");
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "GuardOT_ResidenceGuardDie");
	LAi_SetFightMode(pchar, true);
}

void GuardOT_FindSkinmap(string qName) // нашли карту двух появлений
{
	chrDisableReloadToLocation = false;
	AddQuestRecord("Guardoftruth", "56");
	Island_SetReloadEnableGlobal("Beliz", true); // открыть остров
	bQuestDisableMapEnter = false; // открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	InterfaceStates.Buttons.Save.enable = true; // разрешить сохраняться
	DeleteAttribute(pchar, "GenQuest.NoDelBody");
	DeleteAttribute(pchar, "DisableChangeFlagMode");
	pchar.quest.GuardOT_meetingwilly.win_condition.l1 = "location";
	pchar.quest.GuardOT_meetingwilly.win_condition.l1.location = "shore6";
	pchar.quest.GuardOT_meetingwilly.function = "GuardOT_SetWillynArchy";
	pchar.quest.GuardOT_meetingwilly1.win_condition.l1 = "location";
	pchar.quest.GuardOT_meetingwilly1.win_condition.l1.location = "Beliz";
	pchar.quest.GuardOT_meetingwilly1.function = "GuardOT_SetWillySquadron";
	sld = CharacterFromID("Vincento");
	sld.dialog.currentnode = "First time";
	pchar.questTemp.Guardoftruth.Archy = "begin";
	AddCharacterExpToSkill(pchar, "Fortune", 300);
}

void GuardOT_SetWillynArchy(string qName) // на берегу нас встречают Вилли и Арчи
{
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);
	sld = CharacterFromID("Archy");
	LAi_CharacterDisableDialog(sld);
	ChangeCharacterAddressGroup(sld, "shore6", "reload", "sea");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	sld = CharacterFromID("Willy");
	sld.model = "willy_6";
	sld.dialog.currentnode = "catoche";
	ChangeCharacterAddressGroup(sld, "shore6", "rld", "aloc0");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void GuardOT_SetWillySquadron(string qName) // ставим эскадру Патерсона
{
	SetNationRelation2MainCharacter(SPAIN, RELATION_ENEMY);
	SetNationRelation2MainCharacter(FRANCE, RELATION_FRIEND);
	SetNationRelation2MainCharacter(ENGLAND, RELATION_NEUTRAL);
	AddQuestRecord("Guardoftruth", "58");
	Group_FindOrCreateGroup("Willy_group");
	Group_SetType("Willy_group", "war");//тип группы
	sld = CharacterFromID("Willy");
	FantomMakeCoolSailor(sld, SHIP_FRIGATE_L, "Fortune", CANNON_TYPE_CANNON_LBS24, 90, 90, 90);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.watchfort = true;
	sld.DontDeskTalk = true;
	sld.Ship.Mode = "mercenary";
	// защита от дурака, временно
	sld.Abordage.Enable = true;
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable  = true; //не обижаться на выстрелы
	LAi_SetImmortal(sld, true);
	sld.ship.Crew.Morale = 50+MOD_SKILL_ENEMY_RATE*5;
	sld.Ship.Crew.Exp.Sailors = 50+MOD_SKILL_ENEMY_RATE*5;
	sld.Ship.Crew.Exp.Cannoners = 50+MOD_SKILL_ENEMY_RATE*5;
	sld.Ship.Crew.Exp.Soldiers = 50+MOD_SKILL_ENEMY_RATE*5;
	if (MOD_SKILL_ENEMY_RATE > 2) SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("Willy_group", "Willy");
	int iShip, iCannon;
	for (int i=1; i<=4; i++)
	{
		switch (i)
		{
			case 1:
				iShip = SHIP_LINESHIP;
				iCannon = CANNON_TYPE_CANNON_LBS32;
			break;
			
			case 2:
				iShip = SHIP_FRIGATE_H;
				iCannon = CANNON_TYPE_CANNON_LBS24;
			break;
			
			case 3:
				iShip = SHIP_CORVETTE;
				iCannon = CANNON_TYPE_CANNON_LBS20;
			break;
			
			case 4:
				iShip = SHIP_POLACRE;
				iCannon = CANNON_TYPE_CULVERINE_LBS18;
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("Willy_cap_"+i, "mercen_"+(21+i), "man", "man", 46-(i*4), ENGLAND, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, 80, 80, 80);
		FantomMakeCoolFighter(sld, 30, 80, 80, "blade_21", "pistol5", "bullet", 150);
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.watchfort = true;
		sld.Ship.Mode = "mercenary";
		sld.Coastal_Captain = true; // 7-add
		// защита от дурака, временно
		sld.Abordage.Enable = true;
		sld.AlwaysFriend = true;
		sld.ShipEnemyDisable  = true; //не обижаться на выстрелы
		LAi_SetImmortal(sld, true);
		sld.ship.Crew.Morale = MOD_SKILL_ENEMY_RATE*7+30;
		sld.Ship.Crew.Exp.Sailors = MOD_SKILL_ENEMY_RATE*7+30;
		sld.Ship.Crew.Exp.Cannoners = MOD_SKILL_ENEMY_RATE*7+30;
		sld.Ship.Crew.Exp.Soldiers = MOD_SKILL_ENEMY_RATE*7+30;
		if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
		Group_AddCharacter("Willy_group", "Willy_cap_"+i);
	}
	Group_SetGroupCommander("Willy_group", "Willy");
	Group_SetTaskNone("Willy_group");
	Group_SetAddress("Willy_group", "Beliz", "quest_ships", "quest_ship_8");
	Group_LockTask("Willy_group");
}

void GuardOT_PrepareCreateBandosInCabin(string qName) // негодяи залезли в каюту
{
	bQuestDisableMapEnter = true;//закрыть карту
	Island_SetReloadEnableGlobal("Bermudes", false);//закрыть остров
	DoQuestFunctionDelay("GuardOT_CreateBandosInCabin", 2.5);
}

void GuardOT_CreateBandosInCabin(string qName) // негодяи засели в каюте
{
	pchar.GenQuest.DontSetCabinOfficer = true;
	int iShipType = GetCharacterShipType(pchar);
	ref rShip = GetRealShip(iShipType);
	string sTemp = "My_" + rShip.CabinType;
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 70;
	for(int i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("GOT_cabinband_"+i, "citiz_58", "man", "man", iRank, PIRATE, 1, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_06", "pistol4", "bullet", iScl*2+50);
		sld.Dialog.Filename = "Quest\Sharlie\guardoftruth.c";
		sld.Dialog.currentnode = "cabin_hunter";
		sld.greeting = "hunter";
		LAi_SetActorType(sld);
		if (i == 2) LAi_CharacterDisableDialog(sld);
		ChangeCharacterAddressGroup(sld, sTemp, "rld", "loc"+i);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
	chrDisableReloadToLocation = true;//закрыть локацию
	Sea_CabinStartNow();
}

void GuardOT_PortRoyalArrive(string qName)
{
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	AddQuestRecord("Guardoftruth", "63");
	pchar.quest.GuardOT_setarchy.win_condition.l1 = "location";
	pchar.quest.GuardOT_setarchy.win_condition.l1.location = "Portroyal_town";
	pchar.quest.GuardOT_setarchy.function = "GuardOT_SetArchyStreet";
}

void GuardOT_SetArchyStreet(string qName)
{
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.GenQuest.CannotWait = true;//запрет ожидания
	// ориентируем на день в обязательном порядке
	int iTime, iAddTime;
	iTime = sti(environment.time);
	if (iTime >= 21) iAddTime = 24-iTime+12;
	if (iTime < 7) iAddTime = 12-iTime;
	if (iTime >= 7 && iTime < 21) iAddTime = 24+12-iTime;
	StoreDayUpdate();
	WaitDate("",0,0,0,iAddtime,5);
	RecalculateJumpTable();
	RefreshWeather();
	RefreshLandTime();
	sld = characterFromId("Archy");	
	sld.Dialog.currentnode = "portroyal";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "PortRoyal_town", "goto", LAi_FindFarFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void GuardOT_WillySquadronGo(string qName)
{
	// эскадру Патерсона - на Антигуа
	Group_SetAddress("Willy_group", "Antigua", "quest_ships", "quest_ship_1");
	pchar.questTemp.Guardoftruth.Archy = "room";
	pchar.quest.GuardOT_waitsquadron.win_condition.l1 = "location";
	pchar.quest.GuardOT_waitsquadron.win_condition.l1.location = "Jamaica";
	pchar.quest.GuardOT_waitsquadron.function = "GuardOT_CheckWillySquadron";
	// время логина торговцу
	sld = characterFromId("PortRoyal_trader");
	LAi_SetLoginTime(sld, 6.0, 21.0);
}

void GuardOT_CheckWillySquadron(string qName)
{
	AddQuestRecord("Guardoftruth", "65");
	pchar.quest.GuardOT_seekenterroom.win_condition.l1 = "location";
	pchar.quest.GuardOT_seekenterroom.win_condition.l1.location = "PortRoyal_houseSp1Room";
	pchar.quest.GuardOT_seekenterroom.function = "GuardOT_SeekEnterToRoom";
	pchar.questTemp.Guardoftruth_room = "true";
}

void GuardOT_SeekEnterToRoom(string qName)
{
	chrDisableReloadToLocation = true;//закрыть локацию
	DoQuestCheckDelay("TalkSelf_Quest", 2.0);
	AddCharacterExpToSkill(pchar, "Fortune", 300);
}

void GuardOT_ReloadToRoof(string qName) // выходим на крышу
{
	// подменяем патч и локаторы
	int n = Findlocation("PortRoyal_town");
	locations[n].models.always.locators = "PortRoyal_Qlocators";
	locations[n].models.day.charactersPatch = "PortRoyal_Qpatch_day"; 
	locations[n].models.night.charactersPatch = "PortRoyal_Qpatch_night";
	Locations[n].models.day.jumpPatch = "PortRoyal_Qjump_patch"; 	
	Locations[n].models.night.jumpPatch = "PortRoyal_Qjump_patch";
	locations[n].locators_radius.reload.reload_quest2 = 0.2;
	DoQuestReloadToLocation("PortRoyal_town", "reload", "reload_quest1", "");
	pchar.GenQuest.CantRun = true;
	CheckAndSetOverloadMode(GetMainCharacter()); // бег запрещаем
	pchar.quest.GuardOT_onroof.win_condition.l1 = "locator";
	pchar.quest.GuardOT_onroof.win_condition.l1.location = "PortRoyal_town";
	pchar.quest.GuardOT_onroof.win_condition.l1.locator_group = "reload";
	pchar.quest.GuardOT_onroof.win_condition.l1.locator = "reload_quest2";
	pchar.quest.GuardOT_onroof.function = "GuardOT_ReloadToArchyRoom";
}

void GuardOT_ReloadToArchyRoom(string qName)
{
	DoQuestReloadToLocation("PortRoyal_storeRoom", "reload", "reload1_quest", "");
	// кладем дневник
	sld = ItemsFromID("ArchyBook");
    sld.shown = true;
	sld.startLocation = "PortRoyal_storeRoom";
	sld.startLocator = "item"+(rand(2)+1); // 3 места
	chrDisableReloadToLocation = true;//закрыть локацию
}

void GuardOT_ReadArchyBook() // прочли дневник
{
	pchar.quest.GuardOT_toroof.over = "yes"; //снять прерывание
	chrDisableReloadToLocation = false;
	// подменяем патч и локаторы
	int n = Findlocation("PortRoyal_town");
	locations[n].models.always.locators = "PortRoyal_locators";
	locations[n].models.day.charactersPatch = "PortRoyal_patch_day"; 
	locations[n].models.night.charactersPatch = "PortRoyal_patch_night";
	AddQuestRecordInfo("ArchyBook", "1");
	AddQuestRecord("Guardoftruth", "66");
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	pchar.quest.GuardOT_exitfromstore.win_condition.l1 = "location";
	pchar.quest.GuardOT_exitfromstore.win_condition.l1.location = "PortRoyal_town";
	pchar.quest.GuardOT_exitfromstore.function = "GuardOT_ExitFromstore";
	// доступ на остров
	int i = FindIsland("IslaDeVieques");
	Islands[i].visible = true;
	Islands[i].reload_enable = true;
	pchar.quest.GuardOT_findisland.win_condition.l1 = "location";
	pchar.quest.GuardOT_findisland.win_condition.l1.location = "IslaDeVieques";
	pchar.quest.GuardOT_findisland.function = "GuardOT_FindIslaDeVieques";
	pchar.questTemp.Guardoftruth.ArchyBoom = "true";
}

void GuardOT_ExitFromstore(string qName) // вышли на улицу
{
	DeleteAttribute(pchar, "GenQuest.CantRun");
	CheckAndSetOverloadMode(GetMainCharacter()); // бег разрешаем
	DeleteAttribute(pchar, "GenQuest.CannotWait");//можно мотать время
}

void GuardOT_FindIslaDeVieques(string qName) // вышли у острова
{
	AddQuestRecord("Guardoftruth", "67");
	// на вход в дом Арчи
	pchar.quest.GuardOT_findisland1.win_condition.l1 = "location";
	pchar.quest.GuardOT_findisland1.win_condition.l1.location = "IslaDeVieques_HouseEntrance";
	pchar.quest.GuardOT_findisland1.function = "GuardOT_NearArchyHouse";
	// прерывание на дом Арчи
	pchar.quest.GuardOT_Onisland.win_condition.l1 = "location";
	pchar.quest.GuardOT_Onisland.win_condition.l1.location = "IslaDeVieques_House";
	pchar.quest.GuardOT_Onisland.function = "GuardOT_InArchyHouse";
}

void GuardOT_NearArchyHouse(string qName) // у дома Арчи
{
	AddQuestRecord("Guardoftruth", "68");
	pchar.GenQuest.CannotWait = true;//запрет ожидания
}

void GuardOT_InArchyHouse(string qName) // в доме Арчи
{
	chrDisableReloadToLocation = true;
	bDisableCharacterMenu = true;//лочим F2
	if(CheckAttribute(pchar, "IsMushketer")) SetMainCharacterToMushketer("", false);
}

void GuardOT_ArchyChestBoom() // ба-бах!!
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	pchar.GenQuest.CantRun = true;
	CheckAndSetOverloadMode(GetMainCharacter()); // бег запрещаем
	CreateLocationParticles("ShipExplode", "box", "box1", 1.0, 0, 0, "boom");
	CreateLocationParticles("ShipExplode", "box", "box1", 1.5, 0, 0, "");
	CreateLocationParticles("blast_inv", "box", "box1", 1.0, 0, 0, "");
	CreateLocationParticles("blast_inv", "box", "box1", 1.5, 0, 0, "");
	CreateLocationParticles("blast_dirt", "box", "box1", 1.0, 0, 0, "");
	CreateLocationParticles("smoke", "box", "box1", 1.0, 0, 0, "");
	CreateLocationParticles("blood_big", "box", "box1", 1.3, 0, 0, "");
	LAi_SetActorType(Pchar);
	LAi_ActorAnimation(Pchar, "jump", "GuardOT_SitInHouse", 0.5);
	ChangeCharacterAddressGroup(Pchar, "IslaDeVieques_House", "goto", "goto5");
	Pchar.chr_ai.hp = stf(Pchar.chr_ai.hp)/4;
	PlaySound("People fight\Death_NPC_08.wav");
	DeleteAttribute(pchar, "questTemp.Guardoftruth.ArchyBoom");
	AddCharacterExpToSkill(pchar, "Defence", 100);
}

void GuardOT_StandUpInHouse(string qName)//поднимаемся на ноги
{
	LAi_SetActorType(Pchar);
	LAi_ActorAnimation(Pchar, "Ground_StandUp", "", 3.5);
	DoQuestFunctionDelay("GuardOT_CreateMercenInHouse", 3.5);
}

void GuardOT_CreateMercenInHouse(string qName)// вошел бандос
{
	PlaySound("Ambient\LAND\door_001.wav");
	LAi_SetPlayerType(Pchar);
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 70;
	string sGun = "pistol6";
	if (MOD_SKILL_ENEMY_RATE < 4) sGun = "pistol1";
	if (MOD_SKILL_ENEMY_RATE > 6) sGun = "pistol4";
	sld = GetCharacter(NPC_GenerateCharacter("GOT_housemercen_1", "mercen_30", "man", "man", iRank, ENGLAND, -1, true, "quest"));
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "topor_04", sGun, "bullet", iScl*2);
	sld.dialog.FileName = "Quest\Sharlie\Guardoftruth.c";
	sld.dialog.currentnode = "housemercen";
	sld.greeting = "hunter";
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	GiveItem2Character(sld, "mushket2");
	TakeNItems(sld, "cartridge", 20);
	TakeNItems(sld, "bullet", 30);
	TakeNItems(sld, "gunpowder", 30);
	if (MOD_SKILL_ENEMY_RATE > 4) LAi_SetCheckMinHP(sld, sti((LAi_GetCharacterHP(sld))/2), false, "GuardOT_CreateAddMercenInHouse");
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "IslaDeVieques_House", "reload", "reload1");
	LAi_ActorDialogDelay(sld, pchar, "", 1.0);
}

void GuardOT_KillMCOfficerInJungle() // убиваем офицеров ГГ
{
	int n = 0;
	for(int i=1; i<=3; i++)
	{
		int idx = GetOfficersIndex(pchar, i);
		if(idx < 0) continue;
		sld = &Characters[idx];
		ChangeCharacterAddressGroup(sld, "IslaDeVieques_HouseEntrance", "quest", "officers"+i);
		LAi_KillCharacter(sld);
		n++;
		if (sld.id == "mary" || sld.id == "helena") pchar.questTemp.Guardoftruth.GirlKill = "true";
	}
	if (n > 0) pchar.questTemp.Guardoftruth.OfficerKill = "true";
	// запрещаем генерацию офицеров по всему острову
	for (i=0; i<MAX_LOCATIONS; i++)
	{	
		if (findsubstr(locations[i].id, "IslaDeVieques" , 0) != -1)
		{
			LAi_LocationDisableOfficersGen(locations[i].id, true);//офицеров не пускать
		}
	}
	LAi_LocationDisableOfficersGen("Shore74", true);//офицеров не пускать
}

void GuardOT_SetWillyOutHouse(string qName) //ставим Патерсона и его отряд
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться patch-8
	GuardOT_KillMCOfficerInJungle(); // убиваем офицеров ГГ
	chrDisableReloadToLocation = true;
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 65;
	// англичане
	for (i=1; i<=5; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("GuardOT_willymushketer_"+i, "mush_ctz_"+(rand(3)+9), "man", "mushketer", iRank, ENGLAND, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket2", "cartridge", iScl*2);
		LAi_CharacterDisableDialog(sld);
		LAi_SetWarriorType(sld);
		LAi_warrior_SetStay(sld, true);
		sld.MusketerDistance = 0;
		ChangeCharacterAddressGroup(sld, "IslaDeVieques_HouseEntrance", "rld", "loc"+i);
	}
	// Патерсон
	sld = characterFromId("Willy");
	sld.model = "Willy_6_mush";
	sld.model.animation = "mushketer";
	sld.dialog.currentnode = "isladevieques";
	GiveItem2Character(sld, "mushket2x2");
	EquipCharacterbyItem(sld, "mushket2x2");
	sld.MushketType = "mushket2x2";
	sld.MushketBulletType = "cartridge";
	if (MOD_SKILL_ENEMY_RATE > 6) TakeNItems(sld, "potion2", 3);
	ChangeCharacterAddressGroup(sld, "IslaDeVieques_HouseEntrance", "rld", "loc0");
	LAi_SetActorType(sld);
	LAi_ActorDialogDelay(sld, pchar, "", 1.3);
	DoQuestFunctionDelay("Terrapin_SetMusic", 1.2);
}

void GuardOT_WillyMushketerFree(string qName) // меняем поведение мушкетеров
{
	for(int i=1; i<=5; i++)
	{
		sld = CharacterFromID("GuardOT_willymushketer_"+i);
		if(i == 1 || i == 4) continue;
		DeleteAttribute(sld, "MusketerDistance");
		sld.MusketerDistance = 10;
	}
}

void GuardOT_WillyShootInJungle(string qName) // Патерсон отстреливается
{
	chrDisableReloadToLocation = true;
	sld = characterFromId("Willy");
	LAi_SetWarriorType(sld);
	LAi_SetCurHPMax(sld);
	TakeNItems(sld, "potion2", MOD_SKILL_ENEMY_RATE/2);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	DoQuestFunctionDelay("GuardOT_WillyRunInJungle", 2.5);
}

void GuardOT_WillyRunInJungle(string qName) // Патерсон убегает
{
	sld = characterFromId("Willy");
	LAi_SetActorType(sld);
	LAi_LockFightMode(sld, true);
	LAi_ActorRunToLocation(sld, "quest", "teleport", "IslaDeVieques_Jungle_01", "quest", "mushketer", "GuardOT_WillyReadyInJungle", -1);
}

void GuardOT_ArchyInCrabShore(string qName) // в бухте
{
	// Патерсон - на корабль
	sld = characterFromId("Willy");
	sld.model = "Willy_6";
	sld.model.animation = "man";
	RemoveItems(sld, "mushket2x2", 1);
	TakeNItems(sld, "potion2", MOD_SKILL_ENEMY_RATE/2);
	DeleteAttribute(sld, "Abordage.Enable");
	DeleteAttribute(sld, "AlwaysFriend");
	DeleteAttribute(sld, "ShipEnemyDisable");
	LAi_SetImmortal(sld, false);
	sld.AlwaysEnemy = true;
	sld.Coastal_Captain = true;
	DeleteAttribute(sld, "ship.sails");
    DeleteAttribute(sld, "ship.blots");
    DeleteAttribute(sld, "ship.masts");
	DeleteAttribute(sld, "ship.hulls");
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	TargetAdmiralMapToCharacter(sld, "A_map_jam"); // 260912
	string sBlade = GetBestGeneratedItem("blade_21");
	GiveItem2Character(sld, sBlade);
	sld.equip.blade = sBlade; // 260912
	GiveItem2Character(sld, "pistol5");
	EquipCharacterbyItem(sld, "pistol5");
	TakeNItems(sld,"potion2", 5);
	chrDisableReloadToLocation = true;
	InterfaceStates.Buttons.Save.enable = false;//запретить сохраняться
	pchar.GenQuest.NoDelBody = true;
	pchar.GenQuest.Notsearchbody = true;
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 60;
	int n = 4+MOD_SKILL_ENEMY_RATE;
	for (i=1; i<=n; i++)
	{
		if (i < 3)
		{
			sld = GetCharacter(NPC_GenerateCharacter("GuardOT_archysoldier_"+i, "mush_ctz_"+(rand(3)+9), "man", "mushketer", iRank, ENGLAND, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket2", "cartridge", iScl*2);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("GuardOT_archysoldier_"+i, "mercen_"+(rand(7)+23), "man", "man", iRank, ENGLAND, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_19","blade_21"), "pistol5", "bullet", iScl*2);
		}
		LAi_CharacterDisableDialog(sld);
		LAi_SetWarriorType(sld);
		if (i < 7) ChangeCharacterAddressGroup(sld, "Shore74", "rld", "loc1");
		else ChangeCharacterAddressGroup(sld, "Shore74", "rld", "loc2");
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	// Арчи Колхаун
	sld = characterFromId("Archy");
	sld.model = "Archy_mush";
	sld.model.animation = "mushketer";
	GiveItem2Character(sld, "mushket2x2");
	EquipCharacterbyItem(sld, "mushket2x2");
	sld.MushketType = "mushket2x2";
	sld.MushketBulletType = "cartridge";
	GiveItem2Character(sld, "key_archy"); // ключ Арчи
	GiveAdmiralMapToCharacter(sld, 5);
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	LAi_CharacterDisableDialog(sld);
	LAi_SetWarriorType(sld);
	ChangeCharacterAddressGroup(sld, "Shore74", "rld", "loc0");
	LAi_group_MoveCharacter(sld, "EnemyFight");
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "GuardOT_CrabShoreGuardDie");
	LAi_SetFightMode(pchar, true);
	// нужно продержаться 1.5 минут
	DoQuestFunctionDelay("GuardOT_OurSailorInCrabShore", 90.0);
}

void GuardOT_OurSailorInCrabShore(string qName) // подмога - наши пришли!
{
	if (LAi_grp_playeralarm <= 0)
	{
		log_testinfo("Подмога не понадобилась - сами крутые!");
		return;
	}
	PlaySound("interface\abordage_wining.wav");
	PlaySound("interface\abordage_wining.wav");
	int iRank = 20+MOD_SKILL_ENEMY_RATE+5;
	int iScl = 60;
	int n = 4+MOD_SKILL_ENEMY_RATE;
	// наши
	for (int i=1; i<=n; i++)
	{
		if (i < 3)
		{
			sld = GetCharacter(NPC_GenerateCharacter("GuardOT_soldier_"+i, "mush_ctz_"+(4+rand(2)), "man", "mushketer", iRank, FRANCE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("GuardOT_soldier_"+i, "citiz_"+(31+rand(9)), "man", "man", iRank, FRANCE, 1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_10","blade_11"), "pistol1", "bullet", iScl*2);
		}
		LAi_CharacterDisableDialog(sld);
		LAi_SetWarriorType(sld);
		if (i < 6) ChangeCharacterAddressGroup(sld, "Shore74", "rld", "loc1");
		else ChangeCharacterAddressGroup(sld, "Shore74", "rld", "loc2");
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
}

void GuardOT_FindArchyKey(string qName) // нашли ключ Арчи
{
	chrDisableReloadToLocation = false; //открыть локацию
	InterfaceStates.Buttons.Save.enable = true; //разрешить сохраняться
	AddQuestRecord("Guardoftruth", "72");
	DeleteAttribute(pchar, "GenQuest.NoDelBody");
	pchar.quest.GuardOT_crabseabattle.win_condition.l1 = "location";
	pchar.quest.GuardOT_crabseabattle.win_condition.l1.location = "IslaDeVieques";
	pchar.quest.GuardOT_crabseabattle.function = "GuardOT_WillySquadronSeaBattle";
	AddCharacterExpToSkill(pchar, "Fortune", 100);
	for (i=1; i<=4+MOD_SKILL_ENEMY_RATE; i++) // Captain Beltrop, 21.01.2021, убираем выживших матросов
	{
			sld = characterFromID("GuardOT_soldier_"+i);
			if (!LAi_IsDead(sld))
			{
			    sld.lifeday = 0; 
			}
	}
}

void GuardOT_WillySquadronSeaBattle(string qName) // эскадра Патерсона
{ 
	bQuestDisableMapEnter = true;//закрыть карту
	for (int i=1; i<=4; i++)
	{
		sld = characterFromId("Willy_cap_"+i);
		DeleteAttribute(sld, "Abordage.Enable");
		DeleteAttribute(sld, "AlwaysFriend");
		DeleteAttribute(sld, "ShipEnemyDisable");
		LAi_SetImmortal(sld, false);
		sld.AlwaysEnemy = true;
		sld.Coastal_Captain = true;
		DeleteAttribute(sld, "ship.sails");
		DeleteAttribute(sld, "ship.blots");
		DeleteAttribute(sld, "ship.masts");
		DeleteAttribute(sld, "ship.hulls");
	}
	Group_SetTaskAttack("Willy_group", PLAYER_GROUP);
	Group_SetPursuitGroup("Willy_group", PLAYER_GROUP);
	Group_LockTask("Willy_group");
	
	pchar.quest.GuardOT_crabseabattle_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.GuardOT_crabseabattle_AfterBattle.win_condition.l1.group = "Willy_group";
	pchar.quest.GuardOT_crabseabattle_AfterBattle.function = "GuardOT_WillySquadronAfterBattle";
}

void GuardOT_WillySquadronAfterBattle(string qName) // победа!
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Group_DeleteGroup("Willy_group");
	bQuestDisableMapEnter = false;
	DeleteAttribute(pchar, "GenQuest.CannotWait");//можно мотать время
	// разрешаем генерацию офицеров по всему острову
	for (i=0; i<MAX_LOCATIONS; i++)
	{	
		if (findsubstr(locations[i].id, "IslaDeVieques" , 0) != -1)
		{
			LAi_LocationDisableOfficersGen(locations[i].id, false);//офицеров пускать
		}
	}
	LAi_LocationDisableOfficersGen("Shore74", false);//офицеров пускать
	AddQuestRecord("Guardoftruth", "73");
	// на компас Стрела пути
	pchar.quest.GuardOT_findarrowway.win_condition.l1 = "item";
	pchar.quest.GuardOT_findarrowway.win_condition.l1.item = "arrowway";
	pchar.quest.GuardOT_findarrowway.function = "GuardOT_FindArrowWayCompas";
	AddComplexSeaExpToScill(250, 250, 250, 250, 250, 250, 0);
}

void GuardOT_FindArrowWayCompas(string qName) // нашли компас
{
	AddQuestRecord("Guardoftruth", "74");
	pchar.questTemp.Guardoftruth = "threeitems"; // флаг для Джино
	AddCharacterExpToSkill(pchar, "Fortune", 500);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////	
//Jason----------------------------------- Коварный остров Ксочитэм ---------------------------------------
////////////////////////////////////////////////////////////////////////////////////////////////////////////
void Ksochitam_StartSearchIsland(string qName) // активация
{
	pchar.questTemp.Ksochitam = "begin";
}

void Ksochitam_LookSkinmapFirstTime() // просмотрели карту первый раз
{
	sld = characterFromId("Jino");
	sld.dialog.currentnode = "ksochitam_5";
	pchar.questTemp.Ksochitam = "talk";
}

void Ksochitam_LookSkinmapSecondTime() // просмотрели карту второй раз
{
	sld = characterFromId("Jino");
	sld.dialog.currentnode = "ksochitam_8";
	pchar.questTemp.Ksochitam = "talk";
}

void Ksochitam_JinoPassenger(string qName) // Джино в пассажиры
{
	sld = characterFromId("Jino");
	AddPassenger(pchar, sld, false);
	SetCharacterRemovable(sld, false);
	ChangeCharacterAddressGroup(sld, "none", "", "");
	// устанавливаем прерывания на локаторы со статуями:
	// у деревни мискито
	pchar.quest.Ksochitam_dolly1.win_condition.l1 = "locator";
	pchar.quest.Ksochitam_dolly1.win_condition.l1.location = "Pearl_Jungle_03";
	pchar.quest.Ksochitam_dolly1.win_condition.l1.locator_group = "item";
	pchar.quest.Ksochitam_dolly1.win_condition.l1.locator = "dolly1";
	pchar.quest.Ksochitam_dolly1.function = "Ksochitam_FindPearlShow";
	// на Доминике
	pchar.quest.Ksochitam_dolly3.win_condition.l1 = "locator";
	pchar.quest.Ksochitam_dolly3.win_condition.l1.location = "Dominica_Jungle_02";
	pchar.quest.Ksochitam_dolly3.win_condition.l1.locator_group = "item";
	pchar.quest.Ksochitam_dolly3.win_condition.l1.locator = "dolly3";
	pchar.quest.Ksochitam_dolly3.function = "Ksochitam_FindDominicaShow";
}

void Ksochitam_FindPearlShow(string qName) // нашли статую у мискито
{
	pchar.questTemp.Ksochitam.PearlShow = "true"; // атрибут статуи №1
	DoQuestFunctionDelay("Ksochitam_FindShowScene", 0.5);
}

void Ksochitam_FindDominicaShow(string qName) // нашли статую на Доминике
{
	pchar.questTemp.Ksochitam.DominicaShow = "true"; // атрибут статуи №3
	DoQuestFunctionDelay("Ksochitam_FindShowScene", 0.5);
}

void Ksochitam_FindShowScene(string qName) // сценка
{
	LAi_SetBarmanType(pchar);
	InterfaceStates.Buttons.Save.enable = false;
	bDisableCharacterMenu = true;//лоченые интерфейсы
	StartQuestMovie(true, true, true);
	locCameraLockNearHero(-5.0, 2.0, -5.0, 600, true);
	DoQuestFunctionDelay("Ksochitam_FindShowSceneEnd", 7.0);
	AddCharacterExpToSkill(pchar, "Fortune", 200);
}

void Ksochitam_FindShowSceneEnd(string qName) // 
{
	locCameraResetState();
	EndQuestMovie();
	InterfaceStates.Buttons.Save.enable = true;
	bDisableCharacterMenu = false;
	DeleteAttribute(pchar, "questTemp.Ksochitam_Dolly");
	if (CheckAttribute(pchar, "questTemp.Ksochitam.PearlShow"))
	{
		if (CheckAttribute(pchar, "questTemp.Ksochitam.DominicaShow")) pchar.questTemp.Ksochitam_Dolly = "full";
		else pchar.questTemp.Ksochitam_Dolly = "half_pearl";
	}
	else pchar.questTemp.Ksochitam_Dolly = "half_dominica";
	DoQuestCheckDelay("TalkSelf_Quest", 0.1);
}

void Ksochitam_JinoDollyTalk(string qName) // говорилка Джино
{
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Jino");
	GetCharacterPos(sld, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Ksochitam_ArriveIsland(string qName) // вошли в локацию Ксочитэма
{
	AddQuestRecord("Ksochitam", "17");
}

void Ksochitam_ArriveRockshore(string qName) // 
{
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	sld = characterFromId("Jino");
	sld.dialog.currentnode = "ksochitam_35";
	DoQuestFunctionDelay("Ksochitam_JinoDollyTalk", 0.5);
	pchar.questTemp.Ksochitam = "onisland";
	pchar.GenQuest.CannotWait = true;//запрет ожидания
	AddCharacterExpToSkill(pchar, "Sailing", 500);
	LAi_group_SetCheck("KSOCHITAM_MONSTERS", "OpenTheDoors");
}

void Ksochitam_Shoreship(string qName) // 
{
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 80;
	float fMft = MOD_SKILL_ENEMY_RATE/10;
	sld = GetCharacter(NPC_GenerateCharacter("ShoreShip4_skeletcap", "skeletcap", "man", "skeleton", iRank, PIRATE, -1, false, "soldier"));
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_21", "pistol4", "bullet", iScl*2+50);
	sld.MultiFighter = 0.8+fMft; // мультифайтер
	ChangeCharacterAddressGroup(sld, "Shore_ship4", "monsters", "monster0");
	LAi_SetWarriorType(sld);
	LAi_warrior_SetStay(sld, true);
	LAi_group_MoveCharacter(sld, "KSOCHITAM_MONSTERS");
	pchar.questTemp.Ksochitam.ShoreShip = "true";
}

void Ksochitam_ShoreshipOpenBox() // открыли сундуки в локации с кораблем
{
	AddQuestRecord("Ksochitam", "7");
	DeleteAttribute(pchar, "questTemp.Ksochitam.ShoreShip");
	AddCharacterExpToSkill(pchar, "Fortune", 400);
}

void Ksochitam_SQOutside(string qName) // вошли в локацию с Санта-Квитерией
{
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_group_SetCheck("KSOCHITAM_MONSTERS", "Ksochitam_SQMonstersDie");
	DeleteAttribute(pchar, "questTemp.Ksochitam.Adversary.L2");
	DeleteAttribute(pchar, "questTemp.Ksochitam.Adversary.L3");
}

void Ksochitam_SQInside(string qName) // внутри Санта-Квитерии
{
	chrDisableReloadToLocation = true;//закрыть локацию
	int iRank = 28+MOD_SKILL_ENEMY_RATE;
	int iScl = 80;
	float fMft = MOD_SKILL_ENEMY_RATE/10;
	for(int i=2; i<=3; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("SQI_skelet_"+i, "skel"+i, "man", "skeleton", iRank, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_07", "pistol5", "bullet", iScl*2+50);
		sld.MultiFighter = 0.8+fMft; // мультифайтер
		sld.monster = true;
		ChangeCharacterAddressGroup(sld, "SantaQuiteriaInside", "goto", "goto"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "KSOCHITAM_MONSTERS");
	}
	sld = GetCharacter(NPC_GenerateCharacter("SQC_skeletcap", "skeletcap", "man", "skeleton", iRank+5, PIRATE, -1, false, "soldier"));
	FantomMakeCoolFighter(sld, iRank+5, iScl+10, iScl+10, "blade_21", "pistol4", "bullet", iScl*2+100);
	sld.dialog.FileName = "Quest\Sharlie\Ksochitam.c";
	sld.dialog.currentnode = "SQC_skeletcap";
	sld.name = "captain";
	sld.lastname = "of 'Santa Quiteria'";
	sld.MultiFighter = 1.0+fMft; // мультифайтер
	GiveItem2Character(sld, "key_archy");
	sld.SaveItemsForDead = true; // сохранять на трупе вещи
	sld.DontClearDead = true; 
	sld.cirassId = Items_FindItemIdx("cirass1");
	sld.monster = true;
	ChangeCharacterAddressGroup(sld, "SantaQuiteriaInside", "goto", "goto1");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "KSOCHITAM_MONSTERS");
	LAi_SetCheckMinHP(sld, 10, true, "Ksochitam_SQCskeletcaptalk");
}

void Ksochitam_CreateDeMaldonado(string qName) // в скалистой бухте
{
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	int iRank = 27+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 75;
	// Алонсо де Мальдонадо
	sld = characterFromId("Maldonado");
	sld.SaveItemsForDead = true; // сохранять на трупе вещи
	sld.DontClearDead = true; // не убирать труп через 200с
	LAi_SetGuardianType(sld);
	sld.protector = true;
	sld.dialog.currentnode = "ksochitam";
	sld.cirassId = Items_FindItemIdx("cirass1");
	ChangeCharacterAddressGroup(sld, "shore65", "quest", "maldonado");
	// солдаты
	for (int i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Maldonado_soldier_"+i, "sold_spa_"+i, "man", "man", iRank, SPAIN, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_13","blade_10"), "pistol5", "bullet", iScl*2+50);
		LAi_CharacterDisableDialog(sld);
		LAi_SetStayType(sld);
		ChangeCharacterAddressGroup(sld, "shore65", "quest", "soldier"+i);
	}
	// мушкетеры
	for (i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Maldonado_mushketer_"+i, "mush_spa_"+i, "man", "mushketer", 35, SPAIN, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, 35, 105, 105, "", "mushket2", "cartridge", iScl*2+50);
		sld.MusketerDistance = 0;
		LAi_SetStayType(sld);
		LAi_CharacterDisableDialog(sld);
		ChangeCharacterAddressGroup(sld, "shore65", "quest", "mushketer"+i);
	}
}

void Ksochitam_CreateMaldonadoHelpers()
{
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 70;
	int n = MOD_SKILL_ENEMY_RATE/2;
	// солдаты
	for (int i=3; i<=n; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Maldonado_soldier_"+i, "sold_spa_"+i, "man", "man", iRank, SPAIN, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_13","blade_10"), "pistol5", "bullet", iScl*2+50);
		LAi_CharacterDisableDialog(sld);
		LAi_SetStayType(sld);
		ChangeCharacterAddressGroup(sld, "shore65", "quest", "add");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	// мушкетеры
	for (i=3; i<=n; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Maldonado_mushketer_"+i, "mush_spa_"+i, "man", "mushketer", 35, SPAIN, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, 35, 105, 105, "", "mushket2", "cartridge", iScl*2+50);
		sld.MusketerDistance = 0;
		LAi_SetStayType(sld);
		LAi_CharacterDisableDialog(sld);
		ChangeCharacterAddressGroup(sld, "shore65", "quest", "mushketer"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
}

void Ksochitam_CreateMaldonadoSquadron(string qName)
{
	Island_SetReloadEnableGlobal("Ksochitam", false);
	// ставим эскадру Мальдонадо
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 90;
	int iShip, iCannon;
	Group_FindOrCreateGroup("Maldonado_group");
	Group_SetType("Maldonado_group", "war");//тип группы
	for (int i=1; i<=4; i++)
	{
		switch (i)
		{
			case 1:
				iShip = SHIP_LINESHIP;
				iCannon = CANNON_TYPE_CANNON_LBS32;
			break;
			
			case 2:
				if (MOD_SKILL_ENEMY_RATE > 4) iShip = SHIP_LINESHIP;
				else iShip = SHIP_GALEON_H;
				iCannon = CANNON_TYPE_CANNON_LBS32;
			break;
			
			case 3:
				iShip = SHIP_GALEON_H;
				iCannon = CANNON_TYPE_CANNON_LBS24;
			break;
			
			case 4:
				iShip = SHIP_XebekVML;
				iCannon = CANNON_TYPE_CULVERINE_LBS18;
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("Maldonadocap_"+i, "off_spa_"+i, "man", "man", iRank, SPAIN, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, iScl, iScl, iScl);
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_13", "pistol5", "bullet", iScl*2+100);
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.watchfort = true;
		sld.Ship.Mode = "war";
		sld.alwaysEnemy = true;
		sld.Coastal_Captain = true;
		sld.ship.Crew.Morale = MOD_SKILL_ENEMY_RATE*5+50;
		sld.Ship.Crew.Exp.Sailors = MOD_SKILL_ENEMY_RATE*5+50;
		sld.Ship.Crew.Exp.Cannoners = MOD_SKILL_ENEMY_RATE*5+50;
		sld.Ship.Crew.Exp.Soldiers = MOD_SKILL_ENEMY_RATE*5+50;
		if (MOD_SKILL_ENEMY_RATE > 4 && i < 3) SetCharacterPerk(sld, "MusketsShoot");
		Group_AddCharacter("Maldonado_group", "Maldonadocap_"+i);
	}
	Group_SetGroupCommander("Maldonado_group", "Maldonadocap_1");
	Group_SetTaskAttack("Maldonado_group", PLAYER_GROUP);
	Group_SetAddress("Maldonado_group", "Ksochitam", "quest_ships", "quest_ship_10");
	Group_LockTask("Maldonado_group");
	
	pchar.quest.Ksochitam_Maldonadoshipsdie.win_condition.l1 = "Group_Death";
	pchar.quest.Ksochitam_Maldonadoshipsdie.win_condition.l1.group = "Maldonado_group";
	pchar.quest.Ksochitam_Maldonadoshipsdie.function = "Ksochitam_MaldonadoSquadronDie";
}

void Ksochitam_MaldonadoSquadronDie(string qName) // победили эскадру Мальдонадо
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Island_SetReloadEnableGlobal("Ksochitam", true);
	LocatorReloadEnterDisable("Shore65", "reload2_back", false);
	Group_DeleteGroup("Maldonado_group");
	sld = characterFromId("Jino");
	sld.dialog.currentnode = "ksochitam_43";
	AddQuestRecord("Ksochitam", "15");
	RemoveItems(pchar, "VerifyPaper", 1);
	sld = characterFromId("Vincento");
	ChangeCharacterAddressGroup(sld, "none", "", ""); // прячем отца Винсенто
	AddComplexSeaExpToScill(300, 300, 300, 300, 300, 300, 0);
}

void Ksochitam_MaskGuard(string qName) // вошли в грот Стража
{
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	pchar.quest.Ksochitam_guard_crypt.win_condition.l1 = "locator";
	pchar.quest.Ksochitam_guard_crypt.win_condition.l1.location = "Shore_mask";
	pchar.quest.Ksochitam_guard_crypt.win_condition.l1.locator_group = "quest";
	pchar.quest.Ksochitam_guard_crypt.win_condition.l1.locator = "detector";
	pchar.quest.Ksochitam_guard_crypt.function = "Ksochitam_EnterGuardCrypt";
}

void Ksochitam_EnterGuardCrypt(string qName)
{
	LAi_SetActorType(pchar);
	StartQuestMovie(true, true, true);
	InterfaceStates.Buttons.Save.enable = false;
	bDisableCharacterMenu = true;//лоченые интерфейсы
	LAi_ActorGoToLocator(pchar, "goto", "rotate", "Ksochitam_GuardCryptRotate", -1);
}

void Ksochitam_GuardMaskFlash(string qName)
{
	if (CheckAttribute(pchar, "questTemp.Ksochitam.GuardMaskBeat")) return; // останавливаем цикл
	int n = rand(18)+1;
	int m = rand(18)+20;
	int k = rand(18)+39;
	int l = rand(18)+58;
	int p = rand(18)+77;
	string locator1 = "fire"+n;
	string locator2 = "fire"+m;
	string locator3 = "fire"+k;
	string locator4 = "fire"+l;
	string locator5 = "fire"+p;
	pchar.questTemp.Ksochitam.GuardMaskFire.l1 = n;
	pchar.questTemp.Ksochitam.GuardMaskFire.l2 = m;
	pchar.questTemp.Ksochitam.GuardMaskFire.l3 = k;
	pchar.questTemp.Ksochitam.GuardMaskFire.l4 = l;
	pchar.questTemp.Ksochitam.GuardMaskFire.l5 = p;
	CreateLocationParticles("fire_incas_Simple", "item", locator1, -0.5, 0, 0, "fortfire");
	CreateLocationParticles("fire_incas_Simple", "item", locator2, -0.5, 0, 0, "fortfire");
	CreateLocationParticles("fire_incas_Simple", "item", locator3, -0.5, 0, 0, "fortfire");
	CreateLocationParticles("fire_incas_Simple", "item", locator4, -0.5, 0, 0, "fortfire");
	CreateLocationParticles("fire_incas_Simple", "item", locator5, -0.5, 0, 0, "fortfire");
	DoQuestFunctionDelay("Ksochitam_GuardMaskFlashPause", 2.5);
}

void Ksochitam_GuardMaskFlashPause(string qName)
{
	DeleteAttribute(pchar, "questTemp.Ksochitam.GuardMaskFire");
	DoQuestFunctionDelay("Ksochitam_GuardMaskFlash", 0.5);
}

void Ksochitam_SetMusic(string qName)
{
	SetMusic("music_teno");
}

void Ksochitam_ArriveHome(string qName)
{
	sld = characterFromId("Jino");
	RemovePassenger(pchar, sld);
	sld.dialog.currentnode = "ksochitam_53";
	DoQuestFunctionDelay("Ksochitam_JinoDollyTalk", 0.5);
}

void Ksochitam_TripComplete(string qName)
{
	CloseQuestHeader("Ksochitam");
	sld = characterFromId("Jino");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "houseF3", "SentJons_HouseF3_Room", "goto", "goto1", "Ksochitam_JinoNormal", 20.0); // patch-7
	// убираем Ксочитэм
	int i = FindIsland("Ksochitam");
	Islands[i].visible = false;
	Islands[i].reload_enable = false;
	DeleteAttribute(&Islands[i], "alwaysStorm");
	DeleteAttribute(&Islands[i], "storm");
	DeleteAttribute(&Islands[i], "tornado");
	DeleteAttribute(&Islands[i], "QuestlockWeather");
	sld = ItemsFromID("arrowway");
	sld.price = 100; // компас можно выкладывать 270912
	sld = ItemsFromID("knife_01");
	sld.price = 1000; // дагу можно выкладывать 270912
	sld = ItemsFromID("mark_map");
	sld.price = 100;
	// создаем монаха
	sld = GetCharacter(NPC_GenerateCharacter("monk_vinsento", "monk_6", "man", "man_B", 5, ENGLAND, 1, false, "soldier"));
	FantomMakeCoolFighter(sld, 5, 10, 10, "", "", "", 20);
	sld.Dialog.Filename = "Quest\Sharlie\OtherNPC.c";
	sld.Dialog.currentnode = "monk_vinsento";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "sentjons_town", "goto", LAi_FindFarFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Ksochitam_VinsentoLastLetterRead() // прочли письмо
{
	chrDisableReloadToLocation = false;//открыть локацию
	pchar.quest.Ksochitam_chapel.win_condition.l1 = "location";
	pchar.quest.Ksochitam_chapel.win_condition.l1.location = "Villemstad_Chapel";
	pchar.quest.Ksochitam_chapel.function = "Tieyasal_VinsentoChapel";
	LocatorReloadEnterDisable("Villemstad_Graveyard", "reload6", false);
	AddQuestRecord("Sharlie", "41");
	SetFunctionTimerCondition("Tieyasal_VinsentoChapelOver", 0, 0, 15, false); // таймер
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////	
//Jason----------------------------------- Древний город майя --------------------------------------------
////////////////////////////////////////////////////////////////////////////////////////////////////////////
void Tieyasal_VinsentoChapelOver(string qName) // отказались проходить квест
{
	AddQuestRecord("Sharlie", "42");
	CloseQuestHeader("Sharlie"); // patch-8
	LocatorReloadEnterDisable("Villemstad_Graveyard", "reload6", true);
	pchar.quest.Ksochitam_chapel.over = "yes"; //снять прерывание
}

// --> провал по времени
void Tieyasal_TotalOver(string qName)
{
	if(IsEntity(&worldMap) || bSeaActive)
	{
		pchar.quest.Tieyasal_TimeOver.win_condition.l1 = "Location_Type";
		pchar.quest.Tieyasal_TimeOver.win_condition.l1.location_type = "town";
		pchar.quest.Tieyasal_TimeOver.function = "Tieyasal_TimeOver";
		pchar.quest.Tieyasal_TimeOver1.win_condition.l1 = "Location_Type";
		pchar.quest.Tieyasal_TimeOver1.win_condition.l1.location_type = "seashore";
		pchar.quest.Tieyasal_TimeOver1.function = "Tieyasal_TimeOver";
	}
	else DoQuestFunctionDelay("Tieyasal_TimeOver", 1.0);
}

void Tieyasal_TimeOver(string qName) // 
{
	GetCharacterPos(pchar, &locx, &locy, &locz);
	sTotalTemp = LAi_FindNearestLocator("reload", locx, locy, locz);
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "reload", sTotalTemp);
	PlaySound("interface\notebook.wav");
	CreateLocationParticles("shadowstar", "reload", sTotalTemp, 1.0, 0, 0, "");
	DoQuestFunctionDelay("Tieyasal_TimeOverContinue_1", 7.0);
	DoQuestFunctionDelay("Tieyasal_TimeOverMusic", 1.5);
}

void Tieyasal_TimeOverMusic(string qName) // 
{
	SetMusic("music_teleport");
}

void Tieyasal_TimeOverContinue_1(string qName) // 
{
	PlaySound("Weather\Thunder_Q.wav");
	CreateLocationParticles("fire_incas", "reload", sTotalTemp, 0.5, 0, 0, "");
	DoQuestFunctionDelay("Tieyasal_TimeOverContinue_2", 7.0);
}

void Tieyasal_TimeOverContinue_2(string qName) // 
{
	PlaySound("Weather\Thunder_Q.wav");
	PlaySound("Ambient\Teno_inside\big_ring.wav");
	PlaySound("Weather\koster_001.wav");
	CreateLocationParticles("shipfire", "reload", sTotalTemp, 0.5, 0, 0, "");
	CreateLocationParticles("shadowstar_Big", "reload", sTotalTemp, 1.5, 0, 0, "");
	DoQuestFunctionDelay("Tieyasal_TimeOverContinue_3", 7.0);
}

void Tieyasal_TimeOverContinue_3(string qName) // 
{
	RemoveAllCharacterItems(pchar, true);
	GiveItem2Character(pchar, "blade_13");
	EquipCharacterbyItem(pchar, "blade_13");
	GiveItem2Character(pchar, "pistol5");
	EquipCharacterbyItem(pchar, "pistol5");
	TakeNItems(pchar, "grapeshot", 50);
	AddItems(pchar, "bullet", 50);
	TakeNItems(pchar, "potion2", 3);
	LAi_SetCharacterUseBullet(pchar, "bullet");
	ChangeCharacterAddressGroup(pchar, "none", "", "");
	DoQuestCheckDelay("Tieyasal_Fail_TeleportContinue_6", 3.0);
}
// <-- провал по времени

void Tieyasal_VinsentoChapel(string qName) // ставим отца Винсенто в часовню
{
	pchar.quest.Tieyasal_VinsentoChapelOver.over = "yes"; //снять прерывание
	chrDisableReloadToLocation = true;
	sld = characterFromId("Vincento");
	sld.dialog.currentnode = "tieyasal";
	ChangeCharacterAddressGroup(sld, "Villemstad_Chapel", "barmen", "stay");
	LAi_SetPriestType(sld);
	for(int i=1; i<=3; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("V_guard_"+i, "sold_spa_"+i, "man", "man", 35, SPAIN, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, 35, 100, 100, "blade_13", "pistol5", "bullet", 200);
		LAi_CharacterDisableDialog(sld);
		LAi_SetActorType(sld);
		ChangeCharacterAddressGroup(sld, "Villemstad_Chapel", "goto", "goto"+i);
		LAi_SetWarriorType(sld);
		LAi_warrior_SetStay(sld, true);
		LAi_warrior_DialogEnable(sld, true);
	}
}

void Tieyasal_SetAdrianInChapel(string qName) // ставим падре Адриана
{
	sld = GetCharacter(NPC_GenerateCharacter("Adrian", "priest_sp1", "man", "man2", 25, SPAIN, -1, true, "quest"));
	SetFantomParamFromRank(sld, 25, true);
	sld.name = "father Adrian";
	sld.lastname = "";
	sld.dialog.FileName = "Quest\Sharlie\OtherNPC.c";
	sld.dialog.currentnode = "adrian";
	sld.greeting = "padre_1";
	RemoveAllCharacterItems(sld, true);
	LAi_SetPriestType(sld);
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "Villemstad_Chapel", "barmen", "stay");
	LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
}

void Tieyasal_CreateITShips(string qName) // ставим корабли у Исла Тесоро
{
	pchar.questTemp.Tieyasal = "islatesoro";
	bQuestDisableMapEnter = true;//закрыть карту
	Island_SetReloadEnableGlobal("Bermudes", false);
	// ставим эскадру
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	int iShip, iCannon;
	Group_FindOrCreateGroup("ITDichoso_group");
	Group_SetType("ITDichoso_group", "war");//тип группы
	for (int i=1; i<=4; i++)
	{
		switch (i)
		{
			case 1:
				iShip = SHIP_LINESHIP;
				iCannon = CANNON_TYPE_CANNON_LBS32;
			break;
			
			case 2:
				iShip = SHIP_FRIGATE;
				iCannon = CANNON_TYPE_CANNON_LBS24;
			break;
			
			case 3:
				iShip = SHIP_XebekVML;
				iCannon = CANNON_TYPE_CULVERINE_LBS18;
			break;
			
			case 4:
				iShip = SHIP_SCHOONER_W;
				iCannon = CANNON_TYPE_CANNON_LBS16;
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("ITDichosocap_"+i, "mercen_1"+i, "man", "man", iRank, PIRATE, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, 100, 100, 100);
		FantomMakeCoolFighter(sld, iRank, 100, 100, "blade_21", "pistol5", "bullet", 200);
		sld.Ship.Mode = "mercenary";
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.alwaysEnemy = true;
		sld.AlwaysSandbankManeuver = true;
		sld.ship.Crew.Morale = MOD_SKILL_ENEMY_RATE*3+70;
		sld.Ship.Crew.Exp.Sailors = MOD_SKILL_ENEMY_RATE*3+70;
		sld.Ship.Crew.Exp.Cannoners = MOD_SKILL_ENEMY_RATE*3+70;
		sld.Ship.Crew.Exp.Soldiers = MOD_SKILL_ENEMY_RATE*3+70;
		SetCharacterPerk(sld, "MusketsShoot");
		SetCharacterPerk(sld, "LongRangeGrappling");
		SetCharacterPerk(sld, "GrapplingProfessional");
		int hcrew = GetMaxCrewQuantity(sld);
		if (i < 3) SetCrewQuantityOverMax(sld, 1.5*hcrew);
		else SetCrewQuantityOverMax(sld, 2*hcrew);
		Group_AddCharacter("ITDichoso_group", "ITDichosocap_"+i);
	}
	Group_SetGroupCommander("ITDichoso_group", "ITDichosocap_1");
	Group_SetTaskAttack("ITDichoso_group", PLAYER_GROUP);
	Group_SetAddress("ITDichoso_group", "Bermudes", "quest_ships", "quest_ship_6");
	Group_LockTask("ITDichoso_group");
	
	pchar.quest.Tieyasal_ITShipsDie.win_condition.l1 = "Group_Death";
	pchar.quest.Tieyasal_ITShipsDie.win_condition.l1.group = "ITDichoso_group";
	pchar.quest.Tieyasal_ITShipsDie.function = "Tieyasal_ITShipsDie";
}

void Tieyasal_ITShipsDie(string qName) // победили эскадру
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Island_SetReloadEnableGlobal("Bermudes", true);
	bQuestDisableMapEnter = false;
	Group_DeleteGroup("ITDichoso_group");
	if (CheckAttribute(pchar, "questTemp.Tieyasal.MigelKnow")) AddQuestRecord("Tieyasal", "6");
	else AddQuestRecord("Tieyasal", "5");
	AddComplexSeaExpToScill(400, 400, 400, 400, 400, 400, 0);
	pchar.quest.Tieyasal_Dichosocall.win_condition.l1 = "location";
	pchar.quest.Tieyasal_Dichosocall.win_condition.l1.location = "Santacatalina_town";
	pchar.quest.Tieyasal_Dichosocall.function = "Tieyasal_CreateDichosoMan";
	pchar.questTemp.Tieyasal = "blueveld";
}

void Tieyasal_CreateDichosoMan(string qName) // посланец Дичозо
{
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = GetCharacter(NPC_GenerateCharacter("Dichoso_agent", "mercen_15", "man", "man", 25, ENGLAND, 0, false, "soldier"));
	FantomMakeCoolFighter(sld, 25, 80, 80, "blade_10", "pistol6", "bullet", 120);
	sld.Dialog.Filename = "Quest\Sharlie\OtherNPC.c";
	sld.Dialog.currentnode = "Dichoso_agent";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "Santacatalina_town", "goto", LAi_FindFarFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Tieyasal_ArriveToNevis(string qName) // прибыли на Сент-Кристофер
{
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.GenQuest.CannotWait = true;//запрет ожидания
	// устанавливаем солдат+офицер
	int iRank = 25+MOD_SKILL_ENEMY_RATE+5;
	int iScl = 70;
	iTotalTemp = 6;
	if (CheckAttribute(pchar, "questTemp.Tieyasal.MigelKnow")) iTotalTemp = 14;
	for (int i=1; i<=iTotalTemp; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("Tieyasal_Oursoldier_"+i, "mercen_24", "man", "man", iRank+5, FRANCE, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_21", "pistol4", "bullet", iScl*2+100);
			sld.dialog.FileName = "Quest\Sharlie\OtherNPC.c";
			sld.dialog.currentnode = "newcastle_officer";
			if (CheckAttribute(pchar, "questTemp.Tieyasal.MigelKnow")) sld.dialog.currentnode = "newcastle_officer_0";
		}
		else
		{
			if (i == 2 || i == 3)
			{
				sld = GetCharacter(NPC_GenerateCharacter("Tieyasal_Oursoldier_"+i, "mush_ctz_"+(4+rand(2)), "man", "mushketer", iRank, FRANCE, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2+50);
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("Tieyasal_Oursoldier_"+i, "citiz_"+(31+rand(9)), "man", "man", iRank, FRANCE, -1, true, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_10","blade_11"), "pistol1", "bullet", iScl*2+50);
			}
			LAi_CharacterDisableDialog(sld);
		}
		ChangeCharacterAddressGroup(sld, "Shore42", "reload", "reload1");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
}

void Tieyasal_NewcastleGoJungle(string qName) // джунгли перед кладбищем
{
	chrDisableReloadToLocation = true;
	for(int i=1; i<=iTotalTemp; i++)
	{
		if (GetCharacterIndex("Tieyasal_Oursoldier_"+i) != -1)
		{
			sld = characterFromID("Tieyasal_Oursoldier_"+i);
			LAi_SetActorType(sld);
			LAi_ActorRunToLocation(sld, "reload", "reload1_back", "none", "", "", "", 7); // 160912
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
	DoQuestCheckDelay("Tieyasal_MCSoldiersReset", 8.0); // 160912
}

void Tieyasal_InGraveyardCrypt(string qName) // внутри крипты
{
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	int iRank = 28+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 90;
	sld = GetCharacter(NPC_GenerateCharacter("Dichoso_crypt_agent", "mercen_22", "man", "man", iRank, SPAIN, -1, false, "soldier"));
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_20", "pistol4", "bullet", iScl*2);
	sld.name = "Stranger";
	sld.lastname = "";
	sld.Dialog.Filename = "Quest\Sharlie\OtherNPC.c";
	sld.Dialog.currentnode = "Dichoso_crypt_agent";
	sld.MultiFighter = 1.0+MOD_SKILL_ENEMY_RATE/20; // мультифайтер
	ChangeCharacterAddressGroup(sld, "Charles_CryptBig2", "quest", "quest1");
	LAi_SetStayType(sld);
	sld.SaveItemsForDead = true; // сохранять на трупе вещи
	sld.DontClearDead = true;
	GiveItem2Character(sld, "specialletter");
	ChangeItemDescribe("specialletter", "itmdescr_specialletter_dichoso");
	sld = ItemsFromID("specialletter");
	sld.text = "Letter_Dichoso";
}

void Tieyasal_StartCryptBattle() // драка в крипте
{
	pchar.GenQuest.Notsearchbody = true;
	for(int i=1; i<=4; i++)
	{
		PlaySound("Ambient\LAND\door_00"+i+".wav");
	}
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], false);
	// ранг и скиллы нападающих будут зависеть от степени осведомленности героя
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	if (CheckAttribute(pchar, "questTemp.Ksochitam.SQCapBookRead")) iRank = iRank-15;
	if (CheckAttribute(pchar, "questTemp.Tieyasal.MigelKnow")) iRank = iRank-15;
	if (iRank < 20) iRank = 20;
	int iScl = 90;
	if (CheckAttribute(pchar, "questTemp.Ksochitam.SQCapBookRead")) iScl = iScl-20;
	if (CheckAttribute(pchar, "questTemp.Tieyasal.MigelKnow")) iScl = iScl-20;
	if (iScl < 20) iScl = 20;
	int n = 2;
	if (MOD_SKILL_ENEMY_RATE > 5) n++;
	if (MOD_SKILL_ENEMY_RATE > 7) n++;
	if (MOD_SKILL_ENEMY_RATE > 9) n++;
	//log_info("Врагов в засаде - "+n+" штук"); 040214
	for(i=1; i<=n; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Dichoso_crypt_soldier_"+i, "citiz_58", "man", "man", iRank, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_19","blade_21"), RandPhraseSimple("pistol4","pistol6"), "bullet", iScl*2);
		ChangeCharacterAddressGroup(sld, "Charles_CryptBig2", "monsters", "monster"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	for(i=1; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Dichoso_crypt_mushketer_"+i, "mush_ctz_"+(rand(2)+10), "man", "mushketer", iRank, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2+100);
		ChangeCharacterAddressGroup(sld, "Charles_CryptBig2", "quest", "mushketer"+i);
		sld.MusketerDistance = 0;
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	sld = characterFromId("Dichoso_crypt_agent");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Tieyasal_CryptBattleComplete");
	LAi_SetFightMode(pchar, true);
	//запускаем офицеров
	for(i=1; i<=3; i++)
	{
		int idx = GetOfficersIndex(pchar, i);
		if(idx < 0) continue;
		sld = &Characters[idx];
		ChangeCharacterAddressGroup(sld, "Charles_CryptBig2", "reload", "reload1");
	}
}

void Tieyasal_DichosoLetterRead() // прочли письмо
{
	chrDisableReloadToLocation = false;//открыть локацию
	DeleteAttribute(pchar, "GenQuest.NoDelBody");
	if (CheckAttribute(pchar, "questTemp.Tieyasal.MigelKnow")) AddQuestRecord("Tieyasal", "13");
	else AddQuestRecord("Tieyasal", "12");
	pchar.quest.Tieyasal_GraveyardBattle.win_condition.l1 = "location";
	pchar.quest.Tieyasal_GraveyardBattle.win_condition.l1.location = "Charles_Graveyard";
	pchar.quest.Tieyasal_GraveyardBattle.function = "Tieyasal_GraveyardBattle";
}

void Tieyasal_GraveyardBattle(string qName) // бой на кладбище
{
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	chrDisableReloadToLocation = true;//закрыть локацию
	// устанавливаем врагов
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	if (CheckAttribute(pchar, "questTemp.Ksochitam.SQCapBookRead")) iRank = iRank-5;
	if (CheckAttribute(pchar, "questTemp.Tieyasal.MigelKnow")) iRank = iRank-5;
	int iScl = 70;
	if (CheckAttribute(pchar, "questTemp.Ksochitam.SQCapBookRead")) iScl = iScl-5;
	if (CheckAttribute(pchar, "questTemp.Tieyasal.MigelKnow")) iScl = iScl-5;
	for (int i=1; i<=18; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("Graveyardsoldier_"+i, "citiz_"+(rand(9)+51), "man", "man", iRank+5, PIRATE, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_21", "pistol4", "bullet", iScl*2+100);
		}
		else
		{
			if (i > 1 && i < 7)
			{
				sld = GetCharacter(NPC_GenerateCharacter("Graveyardsoldier_"+i, "mush_ctz_"+(rand(2)+10), "man", "mushketer", iRank, PIRATE, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2+50);
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("Graveyardsoldier_"+i, "citiz_"+(rand(9)+51), "man", "man", iRank, PIRATE, -1, true, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_10","blade_11"), "pistol1", "bullet", iScl*2+50);
			}
		}
		ChangeCharacterAddressGroup(sld, "Charles_Graveyard", "rld", "loc"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	// наши из засады
	for(i=1; i<=iTotalTemp; i++)
	{
		if (GetCharacterIndex("Tieyasal_Oursoldier_"+i) != -1)
		{
			sld = characterFromID("Tieyasal_Oursoldier_"+i);
			if (CheckAttribute(pchar, "questTemp.Tieyasal.MigelKnow"))
			{
				if (i < 8) ChangeCharacterAddressGroup(sld, "Charles_Graveyard", "reload", "reload1");
				else ChangeCharacterAddressGroup(sld, "Charles_Graveyard", "reload", "reload2");
			}
			else ChangeCharacterAddressGroup(sld, "Charles_Graveyard", "reload", "reload1");
			LAi_SetWarriorType(sld);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Tieyasal_GraveyardBattleComplete");
	LAi_SetFightMode(pchar, true);
}

void Tieyasal_TalkSelfInCabin(string qName) // идем в каюту
{
	log_info("I should get in my cabin");
	PlaySound("interface\notebook.wav");
	Island_SetReloadEnableGlobal("Nevis", false);
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	bDisableCharacterMenu = true;//лочим F2
	int iShipType = GetCharacterShipType(pchar);
	ref rShip = GetRealShip(iShipType);
	string sTemp = "My_" + rShip.CabinType;
	pchar.quest.Tieyasal_Cabintalk.win_condition.l1 = "location";
	pchar.quest.Tieyasal_Cabintalk.win_condition.l1.location = sTemp;
	pchar.quest.Tieyasal_Cabintalk.win_condition = "Tieyasal_PrepareCabinTalk";
	if (CheckCharacterItem(pchar, "splinter_js")) pchar.questTemp.Tieyasal_CabinTalk = "calendar";
	else pchar.questTemp.Tieyasal_CabinTalk = "trip";
}

void Tieyasal_CalendarThink(string qName) // Чапай думает
{
	sld = characterFromId("SnakeEye");
	sld.dialog.currentnode = "calendar_12";
}

void Tieyasal_CalendarDone(string qName) // календарь готов
{
	sld = characterFromId("SnakeEye");
	sld.dialog.currentnode = "calendar_28";
}

void Tieyasal_SetUrakanItzaWarrior(string qName) 
{
	LAi_group_Delete("TMP_FRIEND");
	pchar.GenQuest.CannotWait = true;//запрет ожидания
	LocatorReloadEnterDisable("Tenochtitlan", "reload1_back", true); // закрыть выход
	pchar.GenQuest.Notsearchbody = true;
	pchar.quest.Tieyasal_TripStart.over = "yes"; //снять прерывание
	pchar.quest.Tieyasal_TotalOver.over = "yes"; //снять общий таймер
	// ставим Уракана и мушкетеров ица
	sld = GetCharacter(NPC_GenerateCharacter("Urakan", "itza_Urakan", "man", "man", 40, PIRATE, -1, false, "quest"));
	FantomMakeCoolFighter(sld, 40, 110, 110, "topor_01", "", "", 250);
	sld.name = "Urakan";
	sld.lastname = "";
	sld.dialog.FileName = "Quest\Sharlie\Itza.c";
	sld.dialog.currentnode = "urakan";
	sld.greeting = "urakan";
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "Tenochtitlan", "quest", "urakanstay");
	LAi_SetWarriorType(sld);
	LAi_warrior_SetStay(sld, true);
	LAi_group_MoveCharacter(sld, "TMP_FRIEND");
	for(int i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Bridge_itza_"+i, "mush_itza_"+i, "man", "mushketer", 35, PIRATE, -1, false, "quest"));
		FantomMakeCoolFighter(sld, 35, 110, 110, "", "mushket1", "bullet", 200);
		ChangeCharacterAddressGroup(sld, "Tenochtitlan", "quest", "mushketer"+i);
		LAi_SetImmortal(sld, true);
		LAi_SetWarriorType(sld);
		LAi_warrior_SetStay(sld, true);
		LAi_warrior_DialogEnable(sld, false);
		LAi_group_MoveCharacter(sld, "TMP_FRIEND");
	}
	// прерывание на вход в локатор fire
	pchar.quest.Tieyasal_mushketfire.win_condition.l1 = "locator";
	pchar.quest.Tieyasal_mushketfire.win_condition.l1.location = "Tenochtitlan";
	pchar.quest.Tieyasal_mushketfire.win_condition.l1.locator_group = "teleport";
	pchar.quest.Tieyasal_mushketfire.win_condition.l1.locator = "fire1";
	pchar.quest.Tieyasal_mushketfire.function = "Tieyasal_MushketShoot";
	// ставим воинов ица через 7 сек
	DoQuestFunctionDelay("Tieyasal_CreateItzaWarriorFirstGroup", 7.0);
	pchar.questTemp.Tieyasal.ItzaWarrior = "1";
	// грузить квестовых офицеров
	i = Findlocation("Tenochtitlan");
	locations[i].setquestofficers = true;
	// деактивируем маску Кукулькана, если она у нас есть
	sld = ItemsFromID("mask_true");
	sld.shown = true;
}

void Tieyasal_MushketShoot(string qName) // ГГ сунулся на мост
{
	for(int i=1; i<=2; i++)
	{
		sld = characterFromId("Bridge_itza_"+i);
		LAi_SetActorType(sld);
		LAi_ActorAnimation(sld, "shot", "Saga_MineBanditsxFire_1", 1.0);
	}
}

void Tieyasal_CreateItzaWarriorFirstGroup(string qName) // первая группа вояк ица
{
	LAi_group_Delete("ITZA");
	PlaySound("interface\abordage_wining.wav");
	PlaySound("interface\abordage_wining.wav");
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	iTotalTemp = 5+makeint(MOD_SKILL_ENEMY_RATE/5);
	for(int i=1; i<=iTotalTemp; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Itza_1Group_"+i, "itza_"+(rand(7)+1), "man", "man", iRank, PIRATE, -1, false, "native"));
		FantomMakeCoolFighter(sld, iRank, 100, 100, RandPhraseSimple("blade_01","blade_02"), "", "", 100);
		ChangeCharacterAddressGroup(sld, "Tenochtitlan", "quest", "itza");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "ITZA");
	}
	LAi_group_SetRelation("ITZA", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("ITZA", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("ITZA", "Tieyasal_ItzaWarriorPause");
}

void Tieyasal_InGreatTemple(string qName) // внутри большого храма
{
	LAi_group_Delete("ITZA");
	// ставим Мишеля. Он же Кукулькан
	int iTemp = MOD_SKILL_ENEMY_RATE;
	sld = characterFromId("Mishelle");
	sld.model = "migel_2":
	sld.dialog.currentnode = "kukulkan";
	LAi_SetHP(sld, 1000+MOD_SKILL_ENEMY_RATE*200, 1000+MOD_SKILL_ENEMY_RATE*200);
	LAi_SetImmortal(sld, true);
	sld.LSC_clan = true;
	RemoveAllCharacterItems(sld, true);
	sld.cirassId = Items_FindItemIdx("cirass1");
	sld.MultiFighter = 1.2+MOD_SKILL_ENEMY_RATE/10; // мультифайтер
	GiveItem2Character(sld, "blade_26");
	sld.equip.blade = "blade_26";
	GiveItem2Character(sld, "pistol8");
	EquipCharacterbyItem(sld, "pistol8");
	TakeNItems(sld, "harpoon", 20);
	AddItems(sld, "gunpowder", 20);
	TakeNItems(sld, "potion2", iTemp);
	TakeNItems(sld, "potion3", 5);
	LAi_SetCharacterUseBullet(sld, "harpoon");
	ChangeCharacterAddressGroup(sld, "Temple_great", "quest", "kukulkan");
	LAi_SetActorType(sld);
	// ставим Канека
	sld = GetCharacter(NPC_GenerateCharacter("Kanek", "itza_Kanek", "man", "man", 40, PIRATE, -1, false, "quest"));
	FantomMakeCoolFighter(sld, 40, 90, 90, "topor_01", "", "", 200);
	sld.name = "Kanek";
	sld.lastname = "";
	sld.dialog.FileName = "Quest\Sharlie\Itza.c";
	sld.dialog.currentnode = "kanek";
	sld.greeting = "kanek";
	sld.LSC_clan = true;
	LAi_SetImmortal(sld, true);
	GiveItem2Character(sld, "stonekey");
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	ChangeCharacterAddressGroup(sld, "Temple_great", "quest", "kanek");
	LAi_SetWarriorType(sld);
	LAi_warrior_SetStay(sld, true);
	// ставим охрану ица
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	for(int i=1; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Guard_itza_mush_"+i, "mush_itza_"+(rand(2)+1), "man", "mushketer", iRank, PIRATE, -1, false, "quest"));
		FantomMakeCoolFighter(sld, iRank, 90, 90, "", "mushket1", "cartridge", 100);
		ChangeCharacterAddressGroup(sld, "Temple_great", "monsters", "mushketer"+i);
		sld.MusketerDistance = 0;
		sld.LSC_clan = true;
		if (i == 2)
		{
			sld.SaveItemsForDead = true;
			sld.DontClearDead = true;
		}
		LAi_SetWarriorType(sld);
		LAi_warrior_SetStay(sld, true);
		LAi_warrior_DialogEnable(sld, false);
		LAi_group_MoveCharacter(sld, "ITZA");
	}
	for(i=1; i<=7; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Guard_itza_"+i, "itza_"+i, "man", "man", iRank, PIRATE, -1, false, "native"));
		FantomMakeCoolFighter(sld, iRank, 90, 90, "topor_01", "", "", 100);
		ChangeCharacterAddressGroup(sld, "Temple_great", "monsters", "guard"+i);
		sld.LSC_clan = true;
		LAi_SetWarriorType(sld);
		LAi_warrior_SetStay(sld, true);
		LAi_warrior_DialogEnable(sld, false);
		LAi_group_MoveCharacter(sld, "ITZA");
	}
	// идем к Мишелю принудительно
	LAi_SetActorType(pchar);
	LAi_ActorGoToLocator(pchar, "goto", "goto1", "Tieyasal_MishelleTalkActivation", -1);
	// прерывания на ключ и скрижали
	if (CheckCharacterItem(pchar, "mask_true"))
	{
		pchar.quest.Tieyasal_stonekey.win_condition.l1 = "item";
		pchar.quest.Tieyasal_stonekey.win_condition.l1.item = "stonekey";
		pchar.quest.Tieyasal_stonekey.function = "Tieyasal_FindStoneKey";
		pchar.quest.Tieyasal_tablet1.win_condition.l1 = "item";
		pchar.quest.Tieyasal_tablet1.win_condition.l1.item = "Tablet_1";
		pchar.quest.Tieyasal_tablet1.function = "Tieyasal_FindTabletItzamna";
		pchar.quest.Tieyasal_tablet2.win_condition.l1 = "item";
		pchar.quest.Tieyasal_tablet2.win_condition.l1.item = "Tablet_3";
		pchar.quest.Tieyasal_tablet2.function = "Tieyasal_FindTabletChak";
	}
}

void Tieyasal_TempleFightGuard(string qName) // драка с гардами ица
{
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_SetPlayerType(pchar);
	sld = characterFromId("Mishelle");
	LAi_group_MoveCharacter(sld, "TMP_FRIEND");
	sld = characterFromId("Kanek");
	LAi_group_MoveCharacter(sld, "TMP_FRIEND");
	for(int i=1; i<=4; i++)
	{
		sld = characterFromId("Guard_itza_mush_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "ITZA");
	}
	for(i=1; i<=7; i++)
	{
		sld = characterFromId("Guard_itza_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "ITZA");
	}
	LAi_group_SetRelation("ITZA", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("ITZA", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("ITZA", "Tieyasal_TempleGuardDie");
	LAi_SetFightMode(pchar, true);
	pchar.questTemp.Tieyasal.Defend = "true"; // устанавливаем защиту Мишелю и Канеку
	pchar.questTemp.Tieyasal.LockLadder = "true"; // закрываем лестницу
}

void Tieyasal_TempleDefendActivation() // защита
{
	LAi_ApplyCharacterDamage(pchar, 100, "other");
	LAi_CheckKillCharacter(pchar);			
	GetCharacterPos(pchar, &locx, &locy, &locz);
	string locator = LAi_FindNearestLocator("rld", locx, locy, locz);
	ChangeCharacterAddressGroup(pchar, "Temple_great", "rld", locator);
	PlaySound("PEOPLE\jump.wav");
	CreateLocationParticles("fire_incas_Simple", "rld", locator, 0.5, 0, 0, "");
}

void Tieyasal_SecondFloorActivate(string qName) // активация боя на 2 этаже
{
	PlaySound("Ambient\Teno_inside\big_ring.wav");
	pchar.questTemp.Tieyasal.LockLadder = "true"; // закрываем лестницу
	pchar.questTemp.Tieyasal.LockGate = "true"; // закрываем проход на 3 этаж
	sld = characterFromId("Mishelle_mushketer");
	LAi_group_MoveCharacter(sld, "ITZA");
	for(int i=5; i<=6; i++)
	{
		sld = characterFromId("Warrior_itza_mush_"+i);
		LAi_group_MoveCharacter(sld, "ITZA");
	}
	for(i=1; i<=iTotalTemp; i++)
	{
		sld = characterFromId("Warrior_itza_"+i);
		LAi_group_MoveCharacter(sld, "ITZA");
	}
	LAi_group_SetRelation("ITZA", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("ITZA", LAI_GROUP_PLAYER, true);
	// прерывание на локатор
	pchar.quest.Tieyasal_2floor_add.win_condition.l1 = "locator";
	pchar.quest.Tieyasal_2floor_add.win_condition.l1.location = "Temple_great";
	pchar.quest.Tieyasal_2floor_add.win_condition.l1.locator_group = "quest";
	pchar.quest.Tieyasal_2floor_add.win_condition.l1.locator = "detector2";
	pchar.quest.Tieyasal_2floor_add.function = "Tieyasal_AddingGroupActivate";
}

void Tieyasal_AddingGroupActivate(string qName) // активация добавочной группы
{
	for(int i=11; i<=14; i++)
	{
		sld = characterFromId("Warrior_itza_"+i);
		LAi_RemoveCheckMinHP(sld);
		LAi_group_MoveCharacter(sld, "ITZA");
	}
	LAi_group_SetRelation("ITZA", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("ITZA", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("ITZA", "Tieyasal_FloorWarriorDie");
}

void Tieyasal_ThirdFloorActivate(string qName) // активация боя на 3 этаже
{
	PlaySound("Ambient\Teno_inside\big_ring.wav");
	pchar.questTemp.Tieyasal.LockGate = "true"; // закрываем проход на 3 этаж
	sld = characterFromId("Mishelle");
	LAi_group_MoveCharacter(sld, "ITZA");
	for(int i=1; i<=5; i++)
	{
		sld = characterFromId("Top_itza_"+i);
		LAi_group_MoveCharacter(sld, "ITZA");
	}
	LAi_group_SetRelation("ITZA", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("ITZA", LAI_GROUP_PLAYER, true);	
	//LAi_group_SetCheck("EnemyFight", "Tieyasal_FloorWarriorDie");
}

void Tieyasal_StandUpInTemple(string qName)//поднимаемся на ноги
{
	// ставим воинов ица - антураж
	for(int i=1; i<=3; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Gate_itza_"+i, "itza_"+i, "man", "man", 30, PIRATE, -1, false, "native"));
		FantomMakeCoolFighter(sld, 30, 100, 100, "topor_01", "", "", 200);
		ChangeCharacterAddressGroup(sld, "Temple_great", "reload", "reload"+i);
		LAi_SetActorType(sld);
		sld.LSC_clan = true;
		LAi_group_MoveCharacter(sld, "TMP_FRIEND");
	}
	LAi_SetActorType(pchar);
	LAi_ActorAnimation(pchar, "Ground_StandUp", "", 3.5);
	DoQuestFunctionDelay("Tieyasal_FinalfailTalkContinue", 3.5);
}

void Tieyasal_FinalfailTalkContinue(string qName)
{
	LAi_SetPlayerType(pchar);
	sld = characterFromId("Mishelle");
	sld.dialog.currentnode = "kukulkan_fail_1";
	LAi_SetActorType(sld);
	LAi_ActorDialogDelay(sld, pchar, "", 1.0);
}

void Tieyasal_PrepareToWinBattle()
{
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "reload", "reload1");
	int iRank = 30+MOD_SKILL_ENEMY_RATE*2;
	// входит Уракан и 4 воина
	sld = characterFromId("Urakan");
	LAi_SetActorType(sld);
	sld.LSC_clan = true;
	ChangeCharacterAddressGroup(sld, "Temple_great", "reload", "reload1");
	LAi_ActorGoToLocator(sld, "goto", "stay2", "", -1);
	for(int i=1; i<=8; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Itza_actorwarrior_"+i, "itza_"+(rand(7)+1), "man", "man", iRank, PIRATE, 0, false, "native"));
		FantomMakeCoolFighter(sld, iRank, 100, 100, RandPhraseSimple("topor_01","blade_02"), "", "", 100);
		ChangeCharacterAddressGroup(sld, "Temple_great", "reload", "reload"+(rand(1)+2));
		sld.LSC_clan = true;
		LAi_SetActorType(sld);
		LAi_ActorGoToLocator(sld, "goto", "warrior"+i, "", -1);
		LAi_SetImmortal(sld, true);
		LAi_group_MoveCharacter(sld, "TMP_FRIEND");
	}
	
	// входит Канек
	sld = characterFromId("Kanek");
	ChangeCharacterAddressGroup(sld, "Temple_great", "quest", "detector3");
	LAi_ActorRunToLocator(sld, "goto", "stay3", "", -1);
	DoQuestFunctionDelay("Tieyasal_WinBattleTalk", 10.0);
}

void Tieyasal_WinBattleTalk(string qName) //
{
	if (CheckAttribute(pchar, "questTemp.Tieyasal.Wintalk")) return; // fix
	// запрещаем сохранение и интерфейсы
	bDisableCharacterMenu = true;
	InterfaceStates.Buttons.Save.enable = false;
	ChangeShowIntarface();
	// поворачиваем вояк ица
	for(int i=1; i<=8; i++)
	{
		sld = characterFromId("Itza_actorwarrior_"+i);
		LAi_SetActorType(sld);
		LAi_ActorTurnToCharacter(sld, characterFromID("Blaze"));
	}
	SetMainCharacterIndex(GetCharacterIndex("Urakan"));
	PChar = GetMainCharacter();
	LAi_SetPlayerType(PChar);
	sld = characterFromId("Mishelle");
	sld.dialog.currentnode = "kukulkan_win_1";
	LAi_SetActorType(sld);
	LAi_ActorDialogDelay(sld, pchar, "", 2.0);
}

void Tieyasal_WinBattleStart()
{
	pchar.questTemp.Tieyasal.Wintalk = "true"; // fix
	bDisableCharacterMenu = false;
	ChangeShowIntarface();
	pchar.GenQuest.Notsearchbody = true;
	pchar.GenQuest.NoDelBody = true;
	sld = characterFromId("Urakan");
	LAi_SetActorType(sld);
	LAi_group_MoveCharacter(sld, "TMP_FRIEND");
	sld = characterFromId("Kanek");
	LAi_SetImmortal(sld, false);
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "ITZA"); // patch-7
	sld = characterFromId("Mishelle");
	LAi_SetImmortal(sld, false);
	LAi_SetCurHPMax(sld);
	LAi_GetCharacterMaxEnergy(sld);
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "ITZA"); // patch-7
	LAi_group_SetRelation("ITZA", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY); // patch-7
	LAi_group_FightGroups("ITZA", LAI_GROUP_PLAYER, true); // patch-7
	LAi_SetFightMode(pchar, true);
	LAi_SetCheckMinHP(sld, 1, true, "Tieyasal_MishelleDie");
}

void Tieyasal_MishelleDie(string qName) //
{
	LAi_SetActorType(pchar);
	LAi_ActorTurnToCharacter(pchar, characterFromID("Mishelle"));
	PlaySound("Weather\Thunder_Q.wav");
	DoQuestFunctionDelay("Tieyasal_MishelleDie1", 6.0);
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);
}

void Tieyasal_MishelleDie1(string qName) //
{
	PlaySound("Weather\Thunder_Q.wav");
	for (i=1; i<=5; i++)
	{
		CreateLocationParticles("fire_incas_Simple", "monsters", "top"+i, 0.5, 0, 0, "");
		CreateLocationParticles("fire_incas_Simple", "monsters", "top"+i, 1.0, 0, 0, "");
		CreateLocationParticles("fire_incas_Simple", "monsters", "top"+i, 1.5, 0, 0, "");
	}
	for (i=1; i<=3; i++)
	{
		CreateLocationParticles("fire_incas_Simple", "sit", "sit"+i, 0.5, 0, 0, "");
		CreateLocationParticles("fire_incas_Simple", "sit", "sit"+i, 1.0, 0, 0, "");
		CreateLocationParticles("fire_incas_Simple", "sit", "sit"+i, 1.5, 0, 0, "");
	}
	for (i=1; i<=3; i++)
	{
		CreateLocationParticles("fire_incas_Simple", "reload", "reload"+i, 0.5, 0, 0, "");
		CreateLocationParticles("fire_incas_Simple", "reload", "reload"+i, 1.0, 0, 0, "");
		CreateLocationParticles("fire_incas_Simple", "reload", "reload"+i, 1.5, 0, 0, "");
	}
	CreateLocationParticles("fire_incas_Simple", "quest", "top", 0.5, 0, 0, "");
	CreateLocationParticles("fire_incas_Simple", "quest", "top", 1.0, 0, 0, "");
	CreateLocationParticles("fire_incas_Simple", "quest", "top", 1.5, 0, 0, "");
	DoQuestFunctionDelay("Tieyasal_MishelleDie2", 6.0);
}

void Tieyasal_MishelleDie2(string qName) //
{
	PlaySound("VOICE\Russian\DeadmansGod.wav");
	for (i=1; i<=5; i++)
	{
		CreateLocationParticles("fire_incas_Simple", "monsters", "top"+i, 0.5, 0, 0, "");
		CreateLocationParticles("fire_incas_Simple", "monsters", "top"+i, 1.0, 0, 0, "");
		CreateLocationParticles("fire_incas_Simple", "monsters", "top"+i, 1.5, 0, 0, "");
	}
	for (i=1; i<=3; i++)
	{
		CreateLocationParticles("fire_incas_Simple", "sit", "sit"+i, 0.5, 0, 0, "");
		CreateLocationParticles("fire_incas_Simple", "sit", "sit"+i, 1.0, 0, 0, "");
		CreateLocationParticles("fire_incas_Simple", "sit", "sit"+i, 1.5, 0, 0, "");
	}
	for (i=1; i<=3; i++)
	{
		CreateLocationParticles("fire_incas_Simple", "reload", "reload"+i, 0.5, 0, 0, "");
		CreateLocationParticles("fire_incas_Simple", "reload", "reload"+i, 1.0, 0, 0, "");
		CreateLocationParticles("fire_incas_Simple", "reload", "reload"+i, 1.5, 0, 0, "");
	}
	CreateLocationParticles("fire_incas_Simple", "quest", "top", 0.5, 0, 0, "");
	CreateLocationParticles("fire_incas_Simple", "quest", "top", 1.0, 0, 0, "");
	CreateLocationParticles("fire_incas_Simple", "quest", "top", 1.5, 0, 0, "");
	DoQuestFunctionDelay("Tieyasal_MishelleDie3", 6.0);
}

void Tieyasal_MishelleDie3(string qName) //
{
	for (i=1; i<=5; i++)
	{
		CreateLocationParticles("blast_inv", "monsters", "top"+i, 1.0, 0, 0, "");
	}
	for (i=1; i<=3; i++)
	{
		CreateLocationParticles("blast_inv", "sit", "sit"+i, 1.0, 0, 0, "");
	}
	for (i=1; i<=3; i++)
	{
		CreateLocationParticles("blast_inv", "reload", "reload"+i, 1.0, 0, 0, "");
	}
	CreateLocationParticles("blast_inv", "quest", "top", 1.0, 0, 0, "");
	sld = characterFromId("Mishelle");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	PlaySound("Ambient\Teno_inside\teleporter.wav");
	DoQuestFunctionDelay("Tieyasal_MishelleDisappear", 6.0);
}

void Tieyasal_MishelleDisappear(string qName) //
{
	SetMusic("music_teno");
	LAi_SetPlayerType(pchar);
	InterfaceStates.Buttons.Save.enable = true;
	// снимаем все защиты
	DeleteAttribute(pchar, "questTemp.Tieyasal.Defend");
	DeleteAttribute(pchar, "questTemp.Tieyasal.LockLadder");
	DeleteAttribute(pchar, "questTemp.Tieyasal.LockGate");
	// открываем все храмовые локаторы, кроме сокровищницы и храма Кукулькана
	for(int i=1; i<=34; i++)
	{
		if (i == 31) continue;
		LocatorReloadEnterDisable("Tenochtitlan", "reloadTemple"+i, false);
	}
	LocatorReloadEnterDisable("Tenochtitlan", "reloadU1_back", false);
	LocatorReloadEnterDisable("Tenochtitlan", "reloadU2_back", false);
	sld = characterFromId("Urakan");
	sld.greeting = "";
	sld.dialog.currentnode = "urakan_10";
	LAi_CharacterEnableDialog(sld);
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Tieyasal_FindStoneKey(string qName) // нашли каменный ключ
{
	chrDisableReloadToLocation = false;//открыть локацию
	DeleteAttribute(pchar, "GenQuest.NoDelBody");
	AddQuestRecord("Tieyasal", "27");
}

void Tieyasal_FindTabletItzamna(string qName) // нашли скрижаль Ицамны
{
	sld = ItemsFromID("Tablet_1");
	sld.shown = "0";
}

void Tieyasal_FindTabletChak(string qName) // нашли скрижаль Чака
{
	sld = ItemsFromID("Tablet_3");
	sld.shown = "0";
}

void Tieyasal_UrakanInTemple(string qName) // 
{
	for(int i=1; i<=12; i++)
	{
		sld = characterFromId("Itza_ctz_"+i);
		sld.dialog.currentnode = "itza_ctz_1";
	}
	for(i=2; i<=4; i++)
	{
		LocatorReloadEnterDisable("Tenochtitlan", "reloadTemple3"+i, false);
	}
	pchar.quest.Tieyasal_Treasurereload.win_condition.l1 = "locator";
	pchar.quest.Tieyasal_Treasurereload.win_condition.l1.location = "Tenochtitlan";
	pchar.quest.Tieyasal_Treasurereload.win_condition.l1.locator_group = "reload";
	pchar.quest.Tieyasal_Treasurereload.win_condition.l1.locator = "reloadTemple36";
	pchar.quest.Tieyasal_Treasurereload.function = "Tieyasal_FindTreasureEntrance";
	sld = characterFromId("Urakan");
	sld.greeting = "Urakan";
	LAi_SetWarriorType(sld);
	LAi_warrior_SetStay(sld, true);
	ChangeCharacterAddressGroup(sld, "Temple_great", "quest", "urakan");
}

void Tieyasal_FindTreasureEntrance(string qName) // 
{
	sld = characterFromId("Urakan");
	sld.quest.treasureentrance = "true";
}

void Tieyasal_CheckThreeTablets() // проверяем установку 3 скрижалей в большом храме
{
	ref location = &Locations[FindLocation("Temple_great")];
	if (CheckAttribute(location, "sun") && CheckAttribute(location, "rain") && CheckAttribute(location, "fire"))
	{
		ref sld = ItemsFromID("mask_true");
		sld.shown = "0";
		AddQuestRecord("Tieyasal", "28");
	}
}

void Tieyasal_CheckTwoTablets() // проверяем установку 2 скрижалей для сокровищницы
{
	if (CheckAttribute(pchar, "questTemp.Tieyasal.wartotem") && CheckAttribute(pchar, "questTemp.Tieyasal.tradetotem"))
	{
		DeleteAttribute(pchar, "questTemp.Tieyasal.wartotem");
		DeleteAttribute(pchar, "questTemp.Tieyasal.tradetotem");
		for(int i=5; i<=7; i++)
		{
			LocatorReloadEnterDisable("Tenochtitlan", "reloadTemple3"+i, false);
		}
		PlaySound("Ambient\Teno_inside\big_ring.wav");
		Log_Info("Itzha's treasury has been opened");
	}
}

void Tieyasal_MaskTerminationStart() // уничтожение маски
{
	InterfaceStates.Buttons.Save.enable = false;
	bDisableCharacterMenu = true;
	LAi_SetActorType(pchar);
	LAi_ActorGoToLocator(pchar, "goto", "goto1", "Tieyasal_MaskTerminationTurn", -1);
}

void Tieyasal_MaskTerminationGo(string qName)
{
	SetMusic("music_teleport");
	PlaySound("interface\notebook.wav");
	CreateLocationParticles("item", "item", "button04", 0.2, 0, 0, "");
	DoQuestFunctionDelay("Tieyasal_MaskTerminationContinue_1", 7.0);
}

void Tieyasal_MaskTerminationContinue_1(string qName)
{
	PlaySound("Weather\Thunder_Q.wav");
	CreateLocationParticles("fire_incas", "item", "button04", 0.5, 0, 0, "");
	DoQuestFunctionDelay("Tieyasal_MaskTerminationContinue_2", 7.0);
}

void Tieyasal_MaskTerminationContinue_2(string qName)
{
	PlaySound("Weather\koster_001.wav");
	CreateLocationParticles("fire_incas", "item", "button04", 0.4, 0, 0, "");
	CreateLocationParticles("fire", "item", "button04", 0.1, 0, 0, "");
	DoQuestFunctionDelay("Tieyasal_MaskTerminationContinue_3", 7.0);
}

void Tieyasal_MaskTerminationContinue_3(string qName)
{
	PlaySound("Ambient\Teno_inside\big_ring.wav");
	CreateLocationParticles("fire_incas", "item", "button04", 0.3, 0, 0, "");
	CreateLocationParticles("smoke", "item", "button04", 0.1, 0, 0, "");
	DoQuestFunctionDelay("Tieyasal_MaskTerminationContinue_4", 7.0);
}

void Tieyasal_MaskTerminationContinue_4(string qName)
{
	PlaySound("Ambient\Teno_inside\big_ring.wav");
	CreateLocationParticles("blast_inv", "item", "button04", 0.2, 0, 0, "Boom");
	CreateLocationParticles("blast_inv", "item", "button04", 0.2, 0, 0, "Boom");
	CreateLocationParticles("large_smoke", "item", "button04", 0.1, 0, 0, "Boom");
	DoQuestFunctionDelay("Tieyasal_MaskTerminationEnd", 3.5);
}

void Tieyasal_MaskTerminationEnd(string qName)
{
	SetLaunchFrameFormParam("The Mask of Kukulcan is destroyed"+ NewStr() +"Portals are eliminated!", "", 0, 4);
	LaunchFrameForm();
	DoQuestFunctionDelay("Tieyasal_MaskTerminationReload", 4);
	// убираем партиклы
	int n = Findlocation("Temple_great");
	DeleteAttribute(&locations[n], "sun");
	DeleteAttribute(&locations[n], "rain");
	DeleteAttribute(&locations[n], "fire");
	// разрушаем порталы
	ref rItm = ItemsFromID("dolly0");
	rItm.shown = false;
	ref rItem = ItemsFromID("dolly5");
	rItem.shown = false;
	// Круглый храм
	n = Findlocation("Temple_round");
	locations[n].models.always.dolly = "dolly_F";
	locations[n].models.always.locators = "TempleRoundInside_F_locators";
	// Мэйн
	n = Findlocation("Pearl_Jungle_03");
	DeleteAttribute(&locations[n], "dolly");
	DeleteAttribute(&locations[n], "canteleport");
	DeleteAttribute(&locations[n], "models.always.bracing");
	locations[n].models.always.dolly = "dolly_F";
	locations[n].models.always.dolly.locator.group = "item";
	locations[n].models.always.dolly.locator.name = "dolly1";
	// LSC
	n = Findlocation("UnderWater");
	DeleteAttribute(&locations[n], "dolly");
	DeleteAttribute(&locations[n], "canteleport");
	locations[n].models.always.dolly = "dolly_F";
	locations[n].models.always.dolly.locator.group = "item";
	locations[n].models.always.dolly.locator.name = "dolly2";
	// Доминика
	n = Findlocation("Dominica_Jungle_02");
	DeleteAttribute(&locations[n], "dolly");
	DeleteAttribute(&locations[n], "canteleport");
	locations[n].models.always.dolly = "dolly_F";
	locations[n].models.always.dolly.locator.group = "item";
	locations[n].models.always.dolly.locator.name = "dolly3";
	sld = ItemsFromID("mask_false");
	sld.price = 10000;
}

void Tieyasal_MaskTerminationReload(string qName)
{
	sld = characterFromId("Urakan");
	sld.greeting = "";
	for(int i=1; i<=8; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Itza_actor_"+i, "itza_"+(rand(7)+1), "man", "man", 30, PIRATE, -1, false, "native"));
		FantomMakeCoolFighter(sld, 30, 100, 100, RandPhraseSimple("topor_01","blade_02"), "", "", 100);
		ChangeCharacterAddressGroup(sld, "Temple_great", "monsters", "guard"+i);
		LAi_CharacterDisableDialog(sld);
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
		LAi_SetImmortal(sld, true);
		LAi_group_MoveCharacter(sld, "TMP_FRIEND");
	}
	InterfaceStates.Buttons.Save.enable = true;
	bDisableCharacterMenu = false;
	DoQuestReloadToLocation("Temple_great", "goto", "goto1", "Tieyasal_UrakanLastTalk");
}

void Tieyasal_Win_IndianBead()
{
	LAi_SetActorType(pchar);
	sld = characterFromId("Urakan");
	LAi_CharacterDisableDialog(sld);
	LAi_SetActorType(sld);
	LAi_ActorAnimation(sld, "Bead", "", 5.0);
	for(int i=1; i<=8; i++)
	{
		sld = characterFromId("Itza_actor_"+i);
		LAi_SetActorType(sld);
		LAi_ActorAnimation(sld, "Bead", "", 5.0);
	}
	PlaySound("interface\abordage_wining.wav");
	PlaySound("interface\abordage_wining.wav");
	DoQuestFunctionDelay("Tieyasal_Win_TempleFinal", 5.0);
}

void Tieyasal_Win_TempleFinal(string qName)
{
	LAi_SetPlayerType(pchar);
	sld = characterFromId("Urakan");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "TMP_FRIEND");
	for(int i=1; i<=8; i++)
	{
		sld = characterFromId("Itza_actor_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "TMP_FRIEND");
	}
	AddQuestRecord("Tieyasal", "29");
	// очищаем джунгли от засад ица
	for (i=0; i<MAX_LOCATIONS; i++)
	{				
		if (CheckAttribute(&locations[i], "ItzaLand"))
		{
			DeleteAttribute(&locations[i], "ItzaLand");
		}
	}
	LocatorReloadEnterDisable("Tenochtitlan", "reload1_back", false); // открываем выход
	LocatorReloadEnterDisable("Tayasal_jungle_11", "reload3_back", false); // закрываем Тайясаль со стороны джунглей
	DeleteAttribute(pchar, "GenQuest.CannotWait");//можно мотать время
	setCharacterShipLocation(pchar, "Shore_ship2"));
	setWDMPointXZ("Shore_ship2"); // ставим корабль
	pchar.quest.Tieyasal_Returnshore.win_condition.l1 = "location";
	pchar.quest.Tieyasal_Returnshore.win_condition.l1.location = "Shore_ship2";
	pchar.quest.Tieyasal_Returnshore.function = "Tieyasal_InSeaShore";
	pchar.questTemp.Tieyasal = "home";
}

void Tieyasal_InSeaShore(string qName) // победный финал
{
	LocatorReloadEnterDisable("Tayasal_jungle_09", "reload3_back", true); // закрываем джунгли у Тайясаля
	LocatorReloadEnterDisable("Tayasal_jungle_07", "reload2_back", true); // patch-5
	RemoveItems(pchar, "stonekey", 1);
	pchar.questTemp.Tieyasal_final = "true";
	if (CheckAttribute(pchar, "questTemp.Tieyasal.Teleport")) DoQuestFunctionDelay("Tieyasal_InSeaShoreTime", 1.2);
	else DoQuestFunctionDelay("Tieyasal_InSeaShore_Continue", 0.5);
}

void Tieyasal_InSeaShoreTime(string qName)
{
	SetLaunchFrameFormParam("Several days passed..."+ NewStr() +"The ship has arrived to the bay", "", 0, 5);
	WaitDate("", 0, 0, 7, 3, 10); 
	LaunchFrameForm();
	RefreshLandTime();
	RecalculateJumpTable();
	Whr_UpdateWeather();
	DoQuestFunctionDelay("Tieyasal_InSeaShore_Continue", 5.5);
}

void Tieyasal_InSeaShore_Continue(string qName) // победный финал 
{
	StartQuestMovie(true, true, true);
	InterfaceStates.Buttons.Save.enable = false;
	bDisableCharacterMenu = true;
	LAi_SetActorType(pchar);
	LAi_ActorGoToLocator(pchar, "quest", "hero", "Tieyasal_FinalChoise", -1);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////
////   Миниквесты        начало
/////////////////////////////////////////////////////////////////////////////////////////////////////////
// ----------------- Переспать с официанткой ---------------------
void WaitressFack_null(string qName) //нулим квест официантки
{
	LocatorReloadEnterDisable(pchar.questTemp.different.FackWaitress.City + "_tavern", "reload2_back", true);
	pchar.questTemp.different = "free";
	pchar.quest.WaitressFack_inRoom.over = "yes"; 
	DeleteAttribute(pchar, "questTemp.different.FackWaitress");
}

void WaitressFack_inRoom(string qName)
{
	chrDisableReloadToLocation = true;
	LocatorReloadEnterDisable(locations[reload_location_index].fastreload + "_tavern", "reload2_back", true);
	DoQuestFunctionDelay("WaitressFack_Enter", 10.0 + frand(10.0));
}

void WaitressFack_Enter(string qName)
{	
	LAi_group_Delete("EnemyFight"); 
	LAi_SetFightMode(pchar, false);
	LAi_LockFightMode(pchar, true);
	if (pchar.questTemp.different.FackWaitress.Kick == "0")
	{	//подстава
		iTemp = sti(pchar.rank) + rand(MOD_SKILL_ENEMY_RATE);
		sld = GetCharacter(NPC_GenerateCharacter("BerglarWairessQuest", "mercen_"+(rand(14)+14), "man", "man", iTemp, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, iTemp, 80, 80, "blade_06", "pistol6", "bullet", 50);
		sld.dialog.Filename = "Quest\ForAll_dialog.c";
		sld.dialog.currentnode = "WaitressBerglar";	
		sld.greeting = "banditos"; 
 		//меняем обличие официантки
		rCharacter = characterFromId(locations[reload_location_index].fastreload + "_waitress");
		rCharacter.model = "women_" + (rand(5)+11);
		SetRandomNameToCharacter(rCharacter);
		FaceMaker(rCharacter);  
		CirassMaker(rCharacter);
	}
	else
	{
        sld = characterFromId("WairessQuest");
	}
	ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
	LAi_SetActorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	LAi_ActorDialog(sld, pchar, "", 2.0, 0);
}

void WaitressFack_outRoom()
{
	// ==> Забираем клинки, пистоли и деньги.
	RemoveCharacterEquip(pchar, BLADE_ITEM_TYPE);
	RemoveCharacterEquip(pchar, GUN_ITEM_TYPE);
    while (FindCharacterItemByGroup(pchar, BLADE_ITEM_TYPE) != "")
    {
        TakeItemFromCharacter(pchar, FindCharacterItemByGroup(pchar, BLADE_ITEM_TYPE));
    }
    while (FindCharacterItemByGroup(pchar, GUN_ITEM_TYPE) != "")
    {             
        TakeItemFromCharacter(pchar, FindCharacterItemByGroup(pchar, GUN_ITEM_TYPE));
    }
    pchar.money = 0;
    // <== Забираем клинки, пистоли и деньги.
	AddCharacterExpToSkill(pchar, "Pistol", 100);
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload1_back", "none", "", "", "OpenTheDoors", -1.0);
	pchar.questTemp.different = "FackWaitress_noMoney"; //флаг ограбили
}

void WaitressFack_fight()
{
	AddCharacterExpToSkill(pchar, "FencingL", 30);
	AddCharacterExpToSkill(pchar, "FencingS", 30);
	AddCharacterExpToSkill(pchar, "FencingH", 30);
	LAi_SetFightMode(pchar, true);
	pchar.questTemp.different = "FackWaitress_fighted"; //флаг пришлось подраться
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
    LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	pchar.quest.WaitressFack_afterFight.win_condition.l1 = "NPC_Death";
	pchar.quest.WaitressFack_afterFight.win_condition.l1.character = "BerglarWairessQuest";
	pchar.quest.WaitressFack_afterFight.win_condition = "OpenTheDoors";
}

void WaitressFack_fack()
{
	pchar.questTemp.HorseQty = sti(pchar.questTemp.HorseQty) + 1;
	DoQuestCheckDelay("PlaySex_1", 1.0);
	pchar.questTemp.different = "FackWaitress_facking"; 
}

// ----------------- Пожертвование хозяйки борделя ---------------------
void HostessChurch_null(string qName) //нулим квест 
{
	//если квест еще взят, то деньги считай прикарманены
	if (characters[GetCharacterIndex(pchar.questTemp.different.HostessChurch.city + "_Hostess")].questChurch == "taken") 
	{
		characters[GetCharacterIndex(pchar.questTemp.different.HostessChurch.city + "_Hostess")].questChurch = "baster";
	}
	pchar.questTemp.different = "free";
	DeleteAttribute(pchar, "questTemp.different.HostessChurch");
}

// ----------------- Найти кольцо мэра в борделе ---------------------
void TakeMayorsRing_null(string qName) //нулим квест 
{
	pchar.questTemp.different = "free";
	if (CheckCharacterItem(pchar, "MayorsRing"))
    {
		TakeItemFromCharacter(pchar, "MayorsRing");
		AddQuestRecord("SeekMayorsRing", "4");
		AddQuestUserData("SeekMayorsRing", "sSex", GetSexPhrase("","а"));
		AddQuestUserData("SeekMayorsRing", "sCity", XI_ConvertString("Colony" + pchar.questTemp.different.TakeMayorsRing.city + "Gen"));
		CloseQuestHeader("SeekMayorsRing");
		ChangeCharacterComplexReputation(pchar,"nobility", -3);
	}
	else
	{
		if (pchar.questTemp.different.TakeMayorsRing == "toBrothel")
		{
			AddQuestRecord("SeekMayorsRing", "5");
			AddQuestUserData("SeekMayorsRing", "sSex", GetSexPhrase("ел","ла"));
			AddQuestUserData("SeekMayorsRing", "sCity", XI_ConvertString("Colony" + pchar.questTemp.different.TakeMayorsRing.city + "Gen"));
			CloseQuestHeader("SeekMayorsRing");
			ChangeCharacterComplexReputation(pchar,"nobility", -5);
		}
	}
	DeleteAttribute(pchar, "questTemp.different.TakeMayorsRing");
}

// ----------------- Спихнуть судовые бумаги ---------------------
void GiveShipLetters_null(string qName) //нулим квест 
{
	pchar.questTemp.different = "free";
	DeleteAttribute(pchar, "questTemp.different.GiveShipLetters");
}

void CheckShipLetters(string qName)
{	
	if (!CheckCharacterItem(pchar, "CaptainBook"))
	{
		Log_QuestInfo("Бумаги не взяты!!");
		sld = ItemsFromID("CaptainBook");
		sld.shown = false;
		pchar.questTemp.different = "free";
		pchar.questTemp.different.GiveShipLetters.over = "yes"; //снимаем таймер 
		DeleteAttribute(pchar, "questTemp.different.GiveShipLetters");
	}
}
// ----------------- Спихнуть судовые бумаги ---------------------

// ----------------- Развод на секс хозяйки борделя ---------------------
void SexWithHostess_null(string qName) //нулим квест 
{
	if (pchar.questTemp.different.HostessSex == "toRoom")
	{
		sld = characterFromId(pchar.questTemp.different.HostessSex.city + "_Hostess");
		ChangeCharacterAddressGroup(sld, pchar.questTemp.different.HostessSex.city + "_SecBrRoom", "goto", "goto8");
		LocatorReloadEnterDisable(pchar.questTemp.different.HostessSex.city + "_Brothel", "reload2_back", true);
	}
	LAi_SetOwnerTypeNoGroup(sld);
	sld.dialog.currentnode = "First time";
	sld.quest.NotGoneToSex = true; //не пришел. Секса больше не будет
	DeleteAttribute(pchar, "questTemp.different.HostessSex");
	pchar.questTemp.different = "free";
}

void SexWithHostess_goToRoom()  
{
	chrDisableReloadToLocation = true;
	sld = characterFromId(pchar.questTemp.different.HostessSex.city + "_Hostess");
	LAi_SetActorTypeNoGroup(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload1", pchar.questTemp.different.HostessSex.city + "_Brothel_room", "goto", "goto3", "OpenTheDoors", -1);
	pchar.quest.SexWithHostess_inRoom.win_condition.l1 = "location";
	pchar.quest.SexWithHostess_inRoom.win_condition.l1.location = pchar.questTemp.different.HostessSex.city + "_Brothel_room";
	pchar.quest.SexWithHostess_inRoom.function = "SexWithHostess_inRoom";
	LocatorReloadEnterDisable(pchar.questTemp.different.HostessSex.city + "_Brothel", "reload2_back", false);
}

void SexWithHostess_inRoom(string qName)
{
	DoQuestFunctionDelay("SexWithHostess_inRoom_2", 1.5);
	LocatorReloadEnterDisable(pchar.questTemp.different.HostessSex.city + "_Brothel", "reload2_back", true);
}

void SexWithHostess_inRoom_2(string qName)
{
	sld = characterFromId(pchar.questTemp.different.HostessSex.city + "_Hostess");
	sld.dialog.currentnode = "Hostess_inSexRoom";
	LAi_SetActorTypeNoGroup(sld);
	LAi_ActorDialog(sld, pchar, "", 0, 0);
}

void SexWithHostess_fack()
{
	pchar.questTemp.HorseQty = sti(pchar.questTemp.HorseQty) + 1;
	DoQuestCheckDelay("PlaySex_1", 1.0);
	pchar.questTemp.different = "HostessSex";
}

// ----------------- Миниквесты портмана  ---------------------
void SetCapitainFromCityToSea(string qName) //помещаем в море кэпа, который сейчас ошивается в городе
{
	if (!CheckAttribute(pchar, "quest." + qName + ".CapId")) return;
	int capIndex = GetCharacterIndex(pchar.quest.(qName).CapId)
	if (capIndex != -1)
	{		
		sld = &characters[capIndex];
		if (LAi_IsDead(sld)) return;
		sld.location	= "none";
		sld.location.group = "";
		sld.location.locator = "";
		//в морскую группу кэпа
		string sGroup = "PorpmansShip_" + sld.index;
		group_DeleteGroup(sGroup);
		Group_FindOrCreateGroup(sGroup);
		Group_SetType(sGroup,"trade");
		Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
		Group_LockTask(sGroup);
		Group_AddCharacter(sGroup, sld.id);
		Group_SetGroupCommander(sGroup, sld.id);
		SetRandGeraldSail(sld, sti(sld.Nation)); 
		//записываем данные в структуру кэпа
		sld.quest = "InMap"; //личный флаг рассеянного кэпа
		sld.quest.targetCity = SelectNotEnemyColony(sld); //определим колонию, куда отправится кэп
		sld.quest.stepsQty = sti(sld.quest.stepsQty) + 1; //количество выходов в море
		Log_TestInfo("Рассеянный кэп " + sld.id + " вышел из " + sld.city + " и направился в: " + sld.quest.targetCity);
		//определим бухту, куда ставить энкаунтер. чтобы сразу не генерился перед ГГ у города
		sTemp = GetArealByCityName(sld.city);
		sld.quest.baseShore = GetIslandRandomShoreId(sTemp);
		//на карту
		iTemp = GetMaxDaysFromIsland2Island(sTemp, GetArealByCityName(sld.quest.targetCity))+5; //дней доехать даем с запасом
		Map_CreateTrader(sld.quest.baseShore, sld.quest.targetCity, sld.id, iTemp);
		//даем общий слух, что кэп ушел в другой город
		// -- > belamour gen
		AddSimpleRumourEx(LinkRandPhrase("Капитан " + GetStrSmallRegister(XI_ConvertString(RealShips[sti(sld.Ship.Type)].BaseName + "Gen")) + " '" + sld.Ship.name + "', которого зовут " + GetFullName(sld) + ", опять ушел в море. По слухам, он двинулся в " + XI_ConvertString("Colony"+sld.quest.targetCity+"Acc") + ".", 
			"Вы знаете, капитана " + GetStrSmallRegister(XI_ConvertString(RealShips[sti(sld.Ship.Type)].BaseName + "Gen")) + " '" + sld.Ship.name + "'? Так вот, он направился в " + XI_ConvertString("Colony"+sld.quest.targetCity+"Acc") + ".", 
			"Если вам нужен капитан " + GetStrSmallRegister(XI_ConvertString(RealShips[sti(sld.Ship.Type)].BaseName + "Gen")) + " '" + sld.Ship.name + "', то вам придется отправится в " + XI_ConvertString("Colony"+sld.quest.targetCity+"Acc") + ". " + GetFullName(sld) + " ушел именно туда."), 
			sld.city, iTemp, 1, "PortmansBook_DeliveryToCap", sld.id);
		// <-- gen
		//--> запись инфы по кэпу в базу местного портмана
		sTemp = sld.id; //Id кэпа, который оставил отметку
		rCharacter = &characters[GetCharacterIndex(sld.City + "_PortMan")];
		rCharacter.quest.capitainsList.(sTemp) = sld.quest.targetCity; //куда отправился
		rCharacter.quest.capitainsList.(sTemp).date = GetDateString(); //запишем дату, когда отправился
		//ВНИМАНИЕ. в квестбук должна заносится типовая строка по примеру   PortmansBook_Delivery    #TEXT   5
		//в список портмана заносим тайтл, заголовок и номер строки из quest_text.txt
		rCharacter.quest.capitainsList.(sTemp).QBString1 = characters[GetCharacterIndex(sld.quest.firstCity + "_PortMan")].id + "PortmansBook_Delivery";
		rCharacter.quest.capitainsList.(sTemp).QBString2 = "PortmansBook_Delivery";
		rCharacter.quest.capitainsList.(sTemp).QBQty = 5;
		//перезаносим время в базу кэпов
		sTemp = sld.id;
		NullCharacter.capitainBase.(sTemp).checkTime = iTemp + 5;
		NullCharacter.capitainBase.(sTemp).checkTime.control_day = GetDataDay();
		NullCharacter.capitainBase.(sTemp).checkTime.control_month = GetDataMonth();
		NullCharacter.capitainBase.(sTemp).checkTime.control_year = GetDataYear();
	}
}

void SetRobberFromSeaToMap(string qName) //помещаем в море кэпа-вора, который счас стоит на рейде в порту
{
	if (!CheckAttribute(pchar, "quest." + qName + ".CapId")) return;
	int capIndex = GetCharacterIndex(pchar.quest.(qName).CapId)
	if (capIndex != -1)
	{		
		sld = &characters[capIndex];
		if (LAi_IsDead(sld)) return;
		//в морскую группу кэпа
		string sGroup = "SeekCapShip_" + sld.index;
		group_DeleteGroup(sGroup);
		Group_FindOrCreateGroup(sGroup);
		Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
		Group_LockTask(sGroup);
		Group_AddCharacter(sGroup, sld.id);
		Group_SetGroupCommander(sGroup, sld.id);
		SetRandGeraldSail(sld, sti(sld.Nation)); 
		//записываем данные в структуру кэпа
		sld.quest = "InMap"; //личный флаг рассеянного кэпа
		sld.quest.targetCity = SelectAnyColony2(sld.city, sld.quest.cribCity); //определим колонию, куда отправится кэп
		//Log_TestInfo("Кэп-вор " + sld.id + " вышел из: " + sld.city + " и направился в: " + sld.quest.targetCity);
		//на карту
		iTemp = GetMaxDaysFromIsland2Island(GetArealByCityName(sld.quest.targetCity), GetArealByCityName(sld.city))+5; //дней доехать даем с запасом
		Map_CreateTrader(sld.city, sld.quest.targetCity, sld.id, iTemp);
		//даем общий слух, что кэп ушел в другой город
		// -- > belamour gen
		AddSimpleRumourEx(LinkRandPhrase("Капитан " + GetStrSmallRegister(XI_ConvertString(RealShips[sti(sld.Ship.Type)].BaseName + "Gen")) + " '" + sld.Ship.name + "', которого зовут " + GetFullName(sld) + ", опять ушел в море. По слухам, он двинулся в " + XI_ConvertString("Colony"+sld.quest.targetCity+"Acc") + ".", 
			"Вы знаете, капитана " + GetStrSmallRegister(XI_ConvertString(RealShips[sti(sld.Ship.Type)].BaseName + "Gen")) + " '" + sld.Ship.name + "'? Так вот, он направился в " + XI_ConvertString("Colony"+sld.quest.targetCity+"Acc") + ".", 
			"Если вам нужен капитан " + GetStrSmallRegister(XI_ConvertString(RealShips[sti(sld.Ship.Type)].BaseName + "Gen")) + " '" + sld.Ship.name + "', то вам придется отправится в " + XI_ConvertString("Colony"+sld.quest.targetCity+"Acc") + ". " + GetFullName(sld) + " ушел именно туда."), 
			sld.city, iTemp, 1, "Portmans_SeekShip_rum", sld.id);
		// <-- gen
		//--> запись инфы по кэпу в базу местного портмана
		sTemp = sld.id; //Id кэпа, который оставил отметку
		rCharacter = &characters[GetCharacterIndex(sld.City + "_PortMan")];
		rCharacter.quest.capitainsList.(sTemp) = sld.quest.targetCity; //куда отправился
		rCharacter.quest.capitainsList.(sTemp).date = GetDateString(); //запишем дату, когда отправился
		//ВНИМАНИЕ. в квестбук должна заносится типовая строка по примеру   PortmansBook_Delivery    #TEXT   5
		//в список портмана заносим тайтл, заголовок и номер строки из quest_text.txt
		rCharacter.quest.capitainsList.(sTemp).QBString1 = characters[GetCharacterIndex(sld.quest.cribCity + "_PortMan")].id + "Portmans_SeekShip";
		rCharacter.quest.capitainsList.(sTemp).QBString2 = "Portmans_SeekShip";
		rCharacter.quest.capitainsList.(sTemp).QBQty = 2;
		//перезаносим время в базу кэпов
		sTemp = sld.id;
		NullCharacter.capitainBase.(sTemp).checkTime = iTemp + 5;
		NullCharacter.capitainBase.(sTemp).checkTime.control_day = GetDataDay();
		NullCharacter.capitainBase.(sTemp).checkTime.control_month = GetDataMonth();
		NullCharacter.capitainBase.(sTemp).checkTime.control_year = GetDataYear();
	}
}

void SeekShip_checkAbordage(string qName) //кэп-вор успешно абордирован
{	
	//смотрим, взят корабль себе или потоплен
	sld = characterFromId(pchar.quest.(qName).CapId);
	rCharacter = &characters[GetCharacterIndex(sld.quest.cribCity + "_PortMan")];
	bOk = false;
	for (i=0; i<=COMPANION_MAX; i++)
	{
		iTemp = GetCompanionIndex(pchar, i);
		if(iTemp != -1)
		{
			sld = &characters[iTemp];
			if (sld.ship.name == rCharacter.quest.PortmansSeekShip.shipName && 
				RealShips[sti(sld.ship.type)].BaseName == rCharacter.quest.PortmansSeekShip.shipTapeName &&
				RealShips[sti(sld.Ship.Type)].basetype == rCharacter.quest.PortmansSeekShip.shipTape)
			{
				bOk = true;
			}
		}
	}	
	//решение по результатам проверки
	sld = characterFromId(pchar.quest.(qName).CapId);
	sTemp = "SeekShip_checkSink" + rCharacter.index;
	pchar.quest.(sTemp).over = "yes"; //снимаем прерывание на утонул
	if (bOk)
	{		
		rCharacter.quest = "SeekShip_success"; //флаг успешного взятия на абордаж
		sTemp = rCharacter.id + "Portmans_SeekShip";
		AddQuestRecordEx(sTemp, "Portmans_SeekShip", "5");
	}
	else
	{
		rCharacter.quest = "SeekShip_sink"; //флаг утопления судна, провал квеста
		sTemp = rCharacter.id + "Portmans_SeekShip";
		AddQuestRecordEx(sTemp, "Portmans_SeekShip", "9");
	}
}

void SeekShip_checkSink(string qName)
{
	sld = characterFromId(pchar.quest.(qName).CapId);
	rCharacter = &characters[GetCharacterIndex(sld.quest.cribCity + "_PortMan")];
	rCharacter.quest = "SeekShip_sink"; //флаг утопления судна, провал квеста
	sTemp = rCharacter.id + "Portmans_SeekShip";
	AddQuestRecordEx(sTemp, "Portmans_SeekShip", "8");
	sTemp = "SeekShip_checkAbordage" + rCharacter.index;
	pchar.quest.(sTemp).over = "yes"; //снимаем прерывание на абордаж
}
// ----------------- поиск кэпов, дача квеста горожанином ---------------------
void SCQ_seekCapIsDeath(string qName)
{	
	string sTitle;
	sld = characterFromId(pchar.quest.(qName).CapId); //капитан
	rCharacter = &characters[GetCharacterIndex("QuestCitiz_" + sld.quest.cribCity)]; //горожанин-квестодатель
	//чистим базу нпс-кэпов  -->
	aref forName;
	makearef(forName, NullCharacter.capitainBase);
	DeleteAttribute(forName, sld.id);
	//<-- чистим базу нпс-кэпов
	if (rCharacter.quest.SeekCap == "NM_battle")
	{
		sTitle = sld.quest.cribCity + "SCQ_" + rCharacter.quest.SeekCap;
		AddQuestRecordEx(sTitle, "SCQ_" + rCharacter.quest.SeekCap, "4");
		AddQuestUserData(sTitle, "sCapName", GetFullName(sld));
		AddQuestUserData(sTitle, "sCity", XI_ConvertString("Colony" + rCharacter.city + "Acc"));
		rCharacter.quest.SeekCap = rCharacter.quest.SeekCap + "over"; //дополняем флаг квест до 'выполнен'
	}
	if (rCharacter.quest.SeekCap == "NM_prisoner")
	{
		if (CheckAttribute(pchar, "GenQuest.mustboarding"))//в каюте при абордаже
	{
		sTitle = sld.quest.cribCity + "SCQ_" + rCharacter.quest.SeekCap;
		AddQuestRecordEx(sTitle, "SCQ_" + rCharacter.quest.SeekCap, "5");
			AddQuestUserData(sTitle, "sName", rCharacter.quest.SeekCap.name);
		AddQuestUserData(sTitle, "sCity", XI_ConvertString("Colony" + rCharacter.city + "Acc"));
		rCharacter.quest.SeekCap = rCharacter.quest.SeekCap + "over"; //дополняем флаг квест до 'выполнен'
			DeleteAttribute(pchar, "GenQuest.mustboarding");
		}
		else
		{
			sTitle = sld.quest.cribCity + "SCQ_" + rCharacter.quest.SeekCap;
			sld.lifeDay = 0;
			Map_ReleaseQuestEncounter(sld.id);
			string sGroup = "SeekCapShip_" + sld.index;
			group_DeleteGroup(sGroup);
			sTemp = "SecondTimer_" + sld.id;
			pchar.quest.(sTemp).over = "yes"; //снимаем возможно установленный таймер
			sTemp = "SCQ_" + rCharacter.index;
			pchar.quest.(sTemp).over = "yes"; //снимаем прерывание смерть квестодателя
			if (CheckAttribute(sld, "quest.release")) //если кэп сам отдал пассажира
			{
				AddQuestRecordEx(sTitle, "SCQ_" + rCharacter.quest.SeekCap, "5");
				AddQuestUserData(sTitle, "sName", rCharacter.quest.SeekCap.name);
				AddQuestUserData(sTitle, "sCity", XI_ConvertString("Colony" + rCharacter.city + "Acc"));
				rCharacter.quest.SeekCap = rCharacter.quest.SeekCap + "over"; //дополняем флаг квест до 'выполнен'
			}
			else
		{
			rCharacter.lifeDay = 0;
				AddQuestRecordEx(sTitle, "SCQ_" + rCharacter.quest.SeekCap, "4");
				CloseQuestHeader(sTitle);
			}
		}
	}
	if (rCharacter.quest.SeekCap == "NM_peace")
	{
		sTitle = sld.quest.cribCity + "SCQ_" + rCharacter.quest.SeekCap;
		sld.lifeDay = 0;
		Map_ReleaseQuestEncounter(sld.id);
		sGroup = "SeekCapShip_" + sld.index;
		group_DeleteGroup(sGroup);
		sTemp = "SecondTimer_" + sld.id;
		pchar.quest.(sTemp).over = "yes"; //снимаем возможно установленный таймер
		sTemp = "SCQ_" + rCharacter.index;
		pchar.quest.(sTemp).over = "yes"; //снимаем прерывание смерть квестодателя
		AddQuestRecordEx(sTitle, "SCQ_" + rCharacter.quest.SeekCap, "4");
		CloseQuestHeader(sTitle);
	}
	if (rCharacter.quest.SeekCap == "manSlave")
	{
		sTitle = sld.quest.cribCity + "SCQ_" + rCharacter.quest.SeekCap;
		AddQuestRecordEx(sTitle, "SCQ_" + rCharacter.quest.SeekCap, "4");
		AddQuestUserData(sTitle, "sCapName", GetFullName(sld));
		AddQuestUserData(sTitle, "sCity", XI_ConvertString("Colony" + rCharacter.city + "Acc"));
		rCharacter.quest.SeekCap = rCharacter.quest.SeekCap + "over"; //дополняем флаг квест до 'выполнен'
	}
	if (sld.quest.SeekCap == "womanRevengeFight") //проверим флаг боя на улице, уже можно валить
	{
		sTitle = sld.quest.cribCity + "SCQ_" + rCharacter.quest.SeekCap;
		AddQuestRecordEx(sTitle, "SCQ_" + rCharacter.quest.SeekCap, "5");
		AddQuestUserData(sTitle, "sCapName", GetFullName(sld));
		AddQuestUserData(sTitle, "sCity", XI_ConvertString("Colony" + rCharacter.city + "Acc"));
		rCharacter.quest.SeekCap = rCharacter.quest.SeekCap + "over"; //дополняем флаг квест до 'выполнен'
		sTemp = "SecondTimer_" + sld.id;
		pchar.quest.(sTemp).over = "yes"; //снимаем возможно установленный таймер
		sTemp = "SCQ_" + rCharacter.index;
		pchar.quest.(sTemp).over = "yes"; //снимаем прерывание смерть квестодателя
	}
	if (sld.quest.SeekCap == "womanHasband" || rCharacter.quest.SeekCap == "manRapeWife" || sld.quest.SeekCap == "manFriend" || sld.quest.SeekCap == "womanRevenge" || rCharacter.quest.SeekCap == "womanPirates")
	{
		sTitle = sld.quest.cribCity + "SCQ_" + sld.quest.SeekCap;
		AddQuestRecordEx(sTitle, "SCQ_" + sld.quest.SeekCap, "4");
		sld.lifeDay = 0;
		Map_ReleaseQuestEncounter(sld.id);
		sGroup = "SeekCapShip_" + sld.index;
		group_DeleteGroup(sGroup);
		sTemp = "SecondTimer_" + sld.id;
		pchar.quest.(sTemp).over = "yes"; //снимаем возможно установленный таймер
		sTemp = "SCQ_" + rCharacter.index;
		pchar.quest.(sTemp).over = "yes"; //снимаем прерывание смерть квестодателя
		sTitle = sld.quest.cribCity + "SCQ_" + sld.quest.SeekCap;
		CloseQuestHeader(sTitle);
		//снимаем горожанку-маньячку
		if (sld.quest.SeekCap == "womanRevenge")
		{
			rCharacter.lifeDay = 0;
		}
	}
}
//смерть квестодателя закрывает и чистит квест
void SCQ_CitizenIsDeath(string qName)
{
	sld = characterFromId(pchar.quest.(qName).CapId); //капитан	
	sld.lifeDay = 0;
	rCharacter = characterFromId(pchar.quest.(qName).CitizenId); //горожанин-квестодатель
	//чистим базу нпс-кэпов  -->
	aref forName;
	makearef(forName, NullCharacter.capitainBase);
	DeleteAttribute(forName, sld.id);
	//<-- чистим базу нпс-кэпов
	Map_ReleaseQuestEncounter(sld.id);
	string sGroup = "SeekCapShip_" + sld.index;
	group_DeleteGroup(sGroup);
	sTemp = "SecondTimer_" + sld.id;
	pchar.quest.(sTemp).over = "yes"; //снимаем возможно установленный таймер
	sTemp = "SCQ_" + sld.index;
	pchar.quest.(sTemp).over = "yes"; //снимаем прерывание смерть кэпа
	string sTitle = sld.quest.cribCity + "SCQ_" + rCharacter.quest.SeekCap;
	CloseQuestHeader(sTitle);
}

void CitizCapFromSeaToMap(string qName) //помещаем на карту кэпа, разыскиваемого горожанами
{
	if (!CheckAttribute(pchar, "quest." + qName + ".CapId")) return;
	int capIndex = GetCharacterIndex(pchar.quest.(qName).CapId)
	if (capIndex != -1)
	{		
		sld = &characters[capIndex];
		if (LAi_IsDead(sld)) return;
		sld.nation = sld.quest.nation;
		//в морскую группу кэпа
		string sGroup = "SeekCapShip_" + sld.index;
		group_DeleteGroup(sGroup);
		Group_FindOrCreateGroup(sGroup);
		Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
		Group_LockTask(sGroup);
		Group_AddCharacter(sGroup, sld.id);
		Group_SetGroupCommander(sGroup, sld.id);
		SetRandGeraldSail(sld, sti(sld.Nation)); 
		//записываем данные в структуру кэпа
		sld.quest = "InMap"; //личный флаг искомого кэпа
		sld.quest.targetCity = SelectAnyColony2(sld.city, sld.quest.cribCity); //определим колонию, куда отправится кэп
		//Log_TestInfo("Искомый кэп " + sld.id + " вышел из: " + sld.city + " и направился в: " + sld.quest.targetCity);
		//на карту
		iTemp = GetMaxDaysFromIsland2Island(GetArealByCityName(sld.quest.targetCity), GetArealByCityName(sld.city))+5; //дней доехать даем с запасом
		Map_CreateTrader(sld.city, sld.quest.targetCity, sld.id, iTemp);
		//даем общий слух, что кэп ушел в другой город
		// --> belamour gen
		AddSimpleRumourEx(LinkRandPhrase("Капитан " + GetStrSmallRegister(XI_ConvertString(RealShips[sti(sld.Ship.Type)].BaseName + "Gen")) + " '" + sld.Ship.name + "', которого зовут " + GetFullName(sld) + ", опять ушел в море. По слухам, он двинулся в " + XI_ConvertString("Colony"+sld.quest.targetCity+"Acc") + ".", 
			"Вы знаете, капитана " + GetStrSmallRegister(XI_ConvertString(RealShips[sti(sld.Ship.Type)].BaseName + "Gen")) + " '" + sld.Ship.name + "'? Так вот, он направился в " + XI_ConvertString("Colony"+sld.quest.targetCity+"Acc") + ".", 
			"Если вам нужен капитан " + GetStrSmallRegister(XI_ConvertString(RealShips[sti(sld.Ship.Type)].BaseName + "Gen")) + " '" + sld.Ship.name + "', то вам придется отправится в " + XI_ConvertString("Colony"+sld.quest.targetCity+"Acc") + ". " + GetFullName(sld) + " ушел именно туда."), 
			sld.city, iTemp, 1, "Citiz_SeekCap_rum", sld.id);
		// <-- gen
		//--> запись инфы по кэпу в базу местного портмана
		sTemp = sld.id; //Id кэпа, который оставил отметку
		rCharacter = &characters[GetCharacterIndex(sld.City + "_PortMan")];
		rCharacter.quest.capitainsList.(sTemp) = sld.quest.targetCity; //куда отправился
		rCharacter.quest.capitainsList.(sTemp).date = GetDateString(); //запишем дату, когда отправился
		//ВНИМАНИЕ. в квестбук должна заносится типовая строка по примеру   PortmansBook_Delivery    #TEXT   5
		//в список портмана заносим тайтл, заголовок и номер строки из quest_text.txt
		rCharacter.quest.capitainsList.(sTemp).QBString1 = sld.quest.cribCity + "SCQ_" + characters[GetCharacterIndex("QuestCitiz_"+sld.quest.cribCity)].quest.SeekCap;
		rCharacter.quest.capitainsList.(sTemp).QBString2 = "SCQ_" + characters[GetCharacterIndex("QuestCitiz_"+sld.quest.cribCity)].quest.SeekCap;
		rCharacter.quest.capitainsList.(sTemp).QBQty = 2;
		//меняем сроки проверки по Id кэпа в базе нпс-кэпов
		sTemp = sld.id;
		NullCharacter.capitainBase.(sTemp).checkTime = iTemp + 5;
		NullCharacter.capitainBase.(sTemp).checkTime.control_day = GetDataDay();
		NullCharacter.capitainBase.(sTemp).checkTime.control_month = GetDataMonth();
		NullCharacter.capitainBase.(sTemp).checkTime.control_year = GetDataYear();
	}
}

//после боевки в каюте. для всех квестов по поисков кэпов ситезанами
void CitizSeekCap_afterCabinFight(string qName)
{	
	sld = GetCharacter(NPC_GenerateCharacter(pchar.quest.(qName).label + "_" + pchar.quest.(qName).WifeCity, pchar.quest.(qName).model, "woman", "towngirl", 5, pchar.quest.(qName).nation, -1, false, "citizen"));
	sld.name = pchar.quest.(qName).WifeName;
	sld.lastname = pchar.quest.(qName).WifeLastname;
	sld.dialog.filename   = "Quest\ForAll_dialog.c";
	sld.dialog.currentnode = pchar.quest.(qName).label + "_Board";
	sld.quest.SeekCap = pchar.quest.(qName).label;
	sld.quest.cribCity = pchar.quest.(qName).WifeCity;
	LAi_SetStayType(sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "rld", LAi_FindFarLocator("rld", locx, locy, locz));
	LAi_SetActorType(pchar);
    LAi_SetActorType(sld);
    SetActorDialogAny2Pchar(sld.id, "", 0.0, 0.0);
	LAi_ActorFollow(pchar, sld, "ActorDialog_Any2Pchar", -1);
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////
////   Миниквесты        конец
/////////////////////////////////////////////////////////////////////////////////////////////////////////

void ChangePIRATES()
{
	pchar.SystemInfo.ChangePIRATES = true;
	LaunchCharacter(pchar);
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////
//Jason----------------------------------------Работорговец------------------------------------------
///////////////////////////////////////////////////////////////////////////////////////////////////////////
void Slavetrader_GetRandomShore()//выбор бухты
{	
	switch (rand(3))
	{
		case 0:
			pchar.questTemp.Slavetrader.Island = "Terks";
			break;
		case 1:
			pchar.questTemp.Slavetrader.Island = "Caiman";
			break;
		case 2:
			pchar.questTemp.Slavetrader.Island = "Dominica";
			break;
		case 3:
			pchar.questTemp.Slavetrader.Island = "Bermudes";
			break;
	}
	pchar.questTemp.Slavetrader.Island.Shore = GetIslandRandomShoreId(pchar.questTemp.Slavetrader.Island);
	while(pchar.questTemp.Slavetrader.Island.Shore == "")
	{
		pchar.questTemp.Slavetrader.Island = GetRandomIslandId();
		pchar.questTemp.Slavetrader.Island.Shore = GetIslandRandomShoreId(pchar.questTemp.Slavetrader.Island);
		if (!isLocationFreeForQuests(pchar.questTemp.Slavetrader.Island)) pchar.questTemp.Slavetrader.Island.Shore = "";
	} 
}

void Slavetrader_SlaveShipsOver(string qName)//просроченный таймер
{
	pchar.quest.Slavetrader_ShipsAttack.over = "yes";
	AddQuestRecord("Slavetrader", "7");
	AddQuestUserData("Slavetrader", "sSex", GetSexPhrase("","а"));
	AddQuestUserData("Slavetrader", "sShipName", pchar.questTemp.Slavetrader.ShipName);
	pchar.questTemp.Slavetrader = "goaway";
	ChangeOfficersLoyality("bad_all", 1);
}

void Slavetrader_ShoreShipsOver(string qName)//просроченный таймер пинаса
{
	pchar.quest.Slavetrader_ShoreAttack.over = "yes";
	AddQuestRecord("Slavetrader", "7_1");
	AddQuestUserData("Slavetrader", "sSex", GetSexPhrase("","а"));
	AddQuestUserData("Slavetrader", "sShipName", pchar.questTemp.Slavetrader.ShipName);
	pchar.questTemp.Slavetrader = "goaway_pinas";
	ChangeOfficersLoyality("bad_all", 1);
}

void Slavetrader_CreateSlaveShips(string qName)//создание кораблей в бухте
{
	int i, ShipType, Rank, iShipRank, iCannonType;
	ref sld;
	string Blade, sTemp;
			
	sTemp = pchar.questTemp.Slavetrader.ShipName;
    Island_SetReloadEnableGlobal(pchar.questTemp.Slavetrader.Island, false);
    Group_FindOrCreateGroup("Slave_Attack");
	Group_SetType("Slave_Attack", "war");
	for (i=1; i<=2; i++)
	{
		Rank = sti(pchar.rank) + 5 + rand(MOD_SKILL_ENEMY_RATE);
		if(makeint(pchar.rank) >= 20) { iShipRank = 4; }
		if(makeint(pchar.rank) >= 13 && makeint(pchar.rank) < 20) { iShipRank = rand(1)+2; }	
		if(makeint(pchar.rank) >= 7 && makeint(pchar.rank) < 13) { iShipRank = rand(1); }	
		if(makeint(pchar.rank) < 7) { iShipRank = 0; }
		switch (iShipRank)
		{
			case 0:  
				ShipType = SHIP_BRIG;     					
				Rank = 12 + rand(5);
                Blade = "blade_11";
				iCannonType = CANNON_TYPE_CANNON_LBS16;
			break; 		
			case 1:  
				ShipType = SHIP_BRIGANTINE;			
				Rank = 15 + rand(5);
                Blade = "blade_12";
				iCannonType = CANNON_TYPE_CANNON_LBS16;
			break; 
			case 2: 
				ShipType = SHIP_CORVETTE; 				
				Rank = 20 + rand(5);
                Blade = "blade_13";
				iCannonType = CANNON_TYPE_CANNON_LBS20;
			break; 
			case 3: 
				ShipType = SHIP_FRIGATE;         			
				Rank = 25 + rand(5);
                Blade = "blade_15";
				iCannonType = CANNON_TYPE_CANNON_LBS24;
			break; 
			case 4: 
				ShipType = SHIP_LINESHIP; 						
				Rank = 30 + rand(5);
                Blade = "blade_20";
				iCannonType = CANNON_TYPE_CANNON_LBS32;
			break;  				
		}
		sld = GetCharacter(NPC_GenerateCharacter("CaptainSlaveAttack_"+i, "mercen_"+(rand(14)+14), "man", "man", Rank, PIRATE, 3, true, "quest"));//создание кэпа
		if (i == 1)
		{
			FantomMakeCoolSailor(sld, ShipType, "", iCannonType, 70, 50, 50);
			FantomMakeCoolFighter(sld, Rank, 40, 40, Blade, "pistol1", "bullet", 30);
		}
		if (i == 2)
		{
			FantomMakeCoolSailor(sld, SHIP_GALEON_L, sTemp, CANNON_TYPE_CANNON_LBS16, 70, 50, 50);
			FantomMakeCoolFighter(sld, Rank, 40, 40, "blade_13", "pistol1", "bullet", 30);
		}
		
		Group_AddCharacter("Slave_Attack", "CaptainSlaveAttack_"+i);
		sld.SuperShooter  = true;
		SetCharacterPerk(sld, "Tireless");
		SetCharacterPerk(sld, "HardHitter");
		SetCharacterPerk(sld, "GunProfessional");
		SetCharacterGoods(sld, GOOD_SLAVES, 700 + rand(100));//положить в трюм рабов
		
		sld.ship.Crew.Morale = 50;
		ChangeCrewExp(sld, "Sailors", 40);
		ChangeCrewExp(sld, "Cannoners", 40);
		ChangeCrewExp(sld, "Soldiers", 30);
    }
	Group_SetGroupCommander("Slave_Attack", "CaptainSlaveAttack_1");
	Group_SetTaskAttack("Slave_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("Slave_Attack", PLAYER_GROUP);
	Group_SetAddress("Slave_Attack", pchar.questTemp.Slavetrader.Island, "", "");
	Group_LockTask("Slave_Attack");
			
    pchar.quest.Slavetrader_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Slavetrader_AfterBattle.win_condition.l1.group = "Slave_Attack";
	pchar.quest.Slavetrader_AfterBattle.function = "Slavetrader_SlaveAttack_AfterBattle";//это победа
	pchar.quest.Slavetrader_DieHard.win_condition.l1 = "MapEnter";
    pchar.quest.Slavetrader_DieHard.function = "Slavetrader_SlaveAttack_DieHard";//это слинял
	
	AddQuestRecord("Slavetrader", "3_1");
	AddQuestUserData("Slavetrader", "sSex", GetSexPhrase("","а"));
	AddQuestUserData("Slavetrader", "sShipName", pchar.questTemp.Slavetrader.ShipName);
}

void Slavetrader_SlaveAttack_AfterBattle(string qName)//реакция на победу
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Group_DeleteGroup("Slave_Attack");
	Island_SetReloadEnableGlobal(pchar.questTemp.Slavetrader.Island, true);
    pchar.quest.Slavetrader_DieHard.over = "yes";
	pchar.quest.Slavetrader_SlaveShipsOver.over = "yes";
	AddQuestRecord("Slavetrader", "4");
	AddQuestUserData("Slavetrader", "sShipName", pchar.questTemp.Slavetrader.ShipName);
	pchar.questTemp.Slavetrader = "died";
	AddComplexSeaExpToScill(100, 100, 100, 100, 100, 100, 0);
}

void Slavetrader_SlaveAttack_DieHard(string qName)//реакция на поражение
{
	Group_DeleteGroup("Slave_Attack");
    Island_SetReloadEnableGlobal(pchar.questTemp.Slavetrader.Island, true);
    pchar.quest.Slavetrader_AfterBattle.over = "yes";
	pchar.quest.Slavetrader_SlaveShipsOver.over = "yes";
	AddQuestRecord("Slavetrader", "5");
	AddQuestUserData("Slavetrader", "sShipName", pchar.questTemp.Slavetrader.ShipName);
	pchar.questTemp.Slavetrader = "goaway";
	ChangeOfficersLoyality("bad_all",1);
}

void Slavetrader_CreateShoreShips(string qName)//создание пинаса в бухте
{
	int hcrew, iNation;
	ref sld;
	string sTemp;
	
	iNation = sti(pchar.questTemp.Slavetrader.Nation);
	sTemp = pchar.questTemp.Slavetrader.ShipName;
	pchar.questTemp.Slavetrader = "TakeShoreCap";
    Island_SetReloadEnableGlobal(pchar.questTemp.Slavetrader.Island, false);
    Group_FindOrCreateGroup("Shore_Attack");
	Group_SetType("Shore_Attack", "war");
	sld = GetCharacter(NPC_GenerateCharacter("Slaveshorecap", "trader_"+(rand(13)+1), "man", "man", 25, iNation, 3, true, "quest"));
	sld.DontRansackCaptain = true; 
	FantomMakeCoolSailor(sld, SHIP_PINNACE, sTemp, CANNON_TYPE_CANNON_LBS20, 100, 70, 70);
	sld.Ship.Mode = "trade";
	FantomMakeCoolFighter(sld, 30, 70, 70, "blade_21", "pistol5", "bullet", 250);
	Group_AddCharacter("Shore_Attack", "Slaveshorecap");
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "HardHitter");
	SetCharacterPerk(sld, "MusketsShoot");
	hcrew = GetMaxCrewQuantity(sld);
	SetCrewQuantityOverMax(sld, 1.5*hcrew);
	sld.ship.Crew.Morale = 100;
	ChangeCrewExp(sld, "Sailors", 70);
	ChangeCrewExp(sld, "Cannoners", 70);
	ChangeCrewExp(sld, "Soldiers", 100);
    
	Group_SetGroupCommander("Shore_Attack", "Slaveshorecap");
	Group_SetTaskAttack("Shore_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("Shore_Attack", PLAYER_GROUP);
	Group_SetAddress("Shore_Attack", pchar.questTemp.Slavetrader.Island, "", "");
	Group_LockTask("Shore_Attack");
			
    pchar.quest.Slavetrader_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Slavetrader_AfterBattle.win_condition.l1.group = "Shore_Attack";
	pchar.quest.Slavetrader_AfterBattle.function = "Slavetrader_ShoreAttack_AfterBattle";//это победа
	pchar.quest.Slavetrader_DieHard.win_condition.l1 = "MapEnter";
    pchar.quest.Slavetrader_DieHard.function = "Slavetrader_ShoreAttack_DieHard";//это слинял
	pchar.quest.Slavetrader_ShoreShipsOver.over = "yes";
}

void Slavetrader_ShoreAttack_DieHard(string qName)//реакция на поражение
{
	Group_DeleteGroup("Shore_Attack");
    Island_SetReloadEnableGlobal(pchar.questTemp.Slavetrader.Island, true);
    pchar.quest.Slavetrader_AfterBattle.over = "yes";
	AddQuestRecord("Slavetrader", "11");
	AddQuestUserData("Slavetrader", "sSex", GetSexPhrase("","ла"));
	AddQuestUserData("Slavetrader", "sShipName", pchar.questTemp.Slavetrader.ShipName);
	pchar.questTemp.Slavetrader = "End_quest";
	CloseQuestHeader("Slavetrader");
	ChangeOfficersLoyality("bad_all",1);
}

void Slavetrader_ShoreAttack_AfterBattle(string qName)//реакция на победу
{
	DoQuestCheckDelay("sea_victory", 1.5);
	if (!CheckAttribute(pchar, "GenQuest.LastQuestPrisonerIdx"))
	{
		Group_DeleteGroup("Shore_Attack");
		Island_SetReloadEnableGlobal(pchar.questTemp.Slavetrader.Island, true);
	    pchar.quest.Slavetrader_DieHard.over = "yes";
		AddQuestRecord("Slavetrader", "12");
		AddQuestUserData("Slavetrader", "sShipName", pchar.questTemp.Slavetrader.ShipName);
		CloseQuestHeader("Slavetrader");
		pchar.questTemp.Slavetrader = "End_quest";
	}
	else
	{
		characters[sti(pchar.GenQuest.LastQuestPrisonerIdx)].id = "Slaveshorecap"; //полная победа, если захватил
		AddComplexSeaExpToScill(100, 100, 100, 200, 100, 100, 0);
	}
}

void Slavetrader_BrigOver(string qName)//реакция на просроченный таймер
{
	pchar.questTemp.Slavetrader_BrigAttack.over = "yes";//ликвидация бригантины
	AddQuestRecord("Slavetrader", "15");
	AddQuestUserData("Slavetrader", "sSex", GetSexPhrase("","ла"));
	AddQuestUserData("Slavetrader", "sShipName", pchar.questTemp.Slavetraderbrig.ShipName);
	CloseQuestHeader("Slavetrader");
	ChangeCharacterHunterScore(pchar, NationShortName(sti(pchar.questTemp.Slavetrader.Nation)) + "hunter", 50);
	pchar.questTemp.Slavetrader = "goodbye";
	ChangeOfficersLoyality("bad_all", 1);
}

void Slavetrader_CreateBrig(string qName)//создание бригантины
{
	int iNation = sti(pchar.questTemp.Slavetrader.Nation);
	ref sld;
	string sTemp;
			
    Island_SetReloadEnableGlobal(pchar.questTemp.Slavetraderbrig.Island, false);
    Group_FindOrCreateGroup("Brig_Attack");
	Group_SetType("Brig_Attack", "war");
	sTemp = pchar.questTemp.Slavetraderbrig.ShipName;
	sld = GetCharacter(NPC_GenerateCharacter("CapBrigAttack", "off_" + NationShortName(iNation) + "_" + (rand(1) + 1), "man", "man", 35, iNation, 3, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_BRIGANTINE, sTemp, CANNON_TYPE_CANNON_LBS16, 100, 70, 70);
	FantomMakeCoolFighter(sld, 35, 90, 90, "blade_16", "pistol3", "grapeshot", 100);
	Group_AddCharacter("Brig_Attack", "CapBrigAttack");
	sld.AlwaysEnemy = true;
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "HardHitter");
	SetCharacterPerk(sld, "GunProfessional");
	SetCharacterPerk(sld, "MusketsShoot");
	sld.ship.Crew.Morale = 80;
	ChangeCrewExp(sld, "Sailors", 80);
	ChangeCrewExp(sld, "Cannoners", 100);
	ChangeCrewExp(sld, "Soldiers", 100);
 
	Group_SetGroupCommander("Brig_Attack", "CapBrigAttack");
	Group_SetTaskAttack("Brig_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("Brig_Attack", PLAYER_GROUP);
	Group_SetAddress("Brig_Attack", pchar.questTemp.Slavetraderbrig.Island, "", "");
	Group_LockTask("Brig_Attack");
			
    pchar.quest.Slavetrader_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Slavetrader_AfterBattle.win_condition.l1.group = "Brig_Attack";
	pchar.quest.Slavetrader_AfterBattle.function = "Slavetrader_BrigAttack_AfterBattle";//это победа
	pchar.quest.Slavetrader_DieHard.win_condition.l1 = "MapEnter";
    pchar.quest.Slavetrader_DieHard.function = "Slavetrader_BrigAttack_DieHard";//это слинял
}

void Slavetrader_BrigAttack_AfterBattle(string qName)//реакция на победу
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Group_DeleteGroup("Brig_Attack");
	Island_SetReloadEnableGlobal(pchar.questTemp.Slavetraderbrig.Island, true);
    pchar.quest.Slavetrader_DieHard.over = "yes";
	pchar.quest.Slavetrader_BrigOver.over = "yes";
	if (CheckCharacterItem(pchar, "letter_1"))
	{
		AddQuestRecord("Slavetrader", "16");
		AddQuestUserData("Slavetrader", "sShipName", pchar.questTemp.Slavetraderbrig.ShipName);
		pchar.questTemp.Slavetrader = "winbrig";
		AddComplexSeaExpToScill(100, 100, 100, 150, 100, 100, 0);
	}
	else
	{
		AddQuestRecord("Slavetrader", "17");
		AddQuestUserData("Slavetrader", "sSex", GetSexPhrase("ёл","ла"));
		AddQuestUserData("Slavetrader", "sShipName", pchar.questTemp.Slavetraderbrig.ShipName);
		pchar.questTemp.Slavetrader = "goodbye_1";
	}
}

void Slavetrader_BrigAttack_DieHard(string qName)//реакция на поражение
{
	Group_DeleteGroup("Brig_Attack");
    Island_SetReloadEnableGlobal(pchar.questTemp.Slavetraderbrig.Island, true);
    pchar.quest.Slavetrader_AfterBattle.over = "yes";
	pchar.quest.Slavetrader_BrigShipsOver.over = "yes";
	AddQuestRecord("Slavetrader", "15");
	AddQuestUserData("Slavetrader", "sSex", GetSexPhrase("","ла"));
	AddQuestUserData("Slavetrader", "sShipName", pchar.questTemp.Slavetraderbrig.ShipName);
	CloseQuestHeader("Slavetrader");
	ChangeCharacterHunterScore(pchar, NationShortName(sti(pchar.questTemp.Slavetrader.Nation)) + "hunter", 50);
	pchar.questTemp.Slavetrader = "goodbye";
	ChangeOfficersLoyality("bad_all",1);
}

void Slavetrader_enterSoldiers() //арестовывающие солдеры
{	
	LAi_SetPlayerType(pchar);
	LAi_group_Delete("EnemyFight"); 
	pchar.questTemp.Slavetrader = "After_enterSoldiers";
	iTemp = sti(pchar.rank) + MOD_SKILL_ENEMY_RATE - 2;
	int iNation = sti(pchar.questTemp.Slavetrader.Nation);
	for (i=1; i<=3; i++)
    {
        sld = GetCharacter(NPC_GenerateCharacter("SLSold"+i, "sold_" + NationShortName(iNation) + "_" + (rand(1) + 1), "man", "man", iTemp, iNation, 0, true, "soldier"));
		SetFantomParamFromRank(sld, iTemp, true);         
		LAi_SetWarriorType(sld); 
		LAi_warrior_DialogEnable(sld, false);
        LAi_group_MoveCharacter(sld, "EnemyFight");
        ChangeCharacterAddressGroup(sld, pchar.location, "goto",  "goto3");
    }
    sld = GetCharacter(NPC_GenerateCharacter("SLOfficer", "off_" + NationShortName(iNation) + "_" + (rand(1) + 1), "man", "man", iTemp, iNation, 0, true, "quest"));
	FantomMakeCoolFighter(sld, 25, 100, 100, "blade_13", "pistol6", "bullet", 150);
	sld.Dialog.Filename = "Quest\Other_Quests_NPC.c";
	sld.dialog.currentnode = "Slave_arest";
	sld.greeting = "soldier_arest";
    LAi_SetActorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	ChangeCharacterAddressGroup(sld, pchar.location, "reload",  "reload1");
	LAi_ActorDialog(sld, pchar, "", 1.0, 0);
}

void Slavetrader_Bonanza(string qName)//cоздание индейцев 
{
	chrDisableReloadToLocation = true;
    for (i=1; i<=8; i++)
    {
		sld = GetCharacter(NPC_GenerateCharacter("STIndian"+i, "canib_"+(rand(5)+1), "man", "man", 25, PIRATE, 0, true, "quest"));                    
        FantomMakeCoolFighter(sld, 25, 65, 65, "blade_02", "", "", 150);
        LAi_SetWarriorType(sld);
        LAi_group_MoveCharacter(sld, "EnemyFight");
        GetCharacterPos(pchar, &locx, &locy, &locz);
		sTemp = LAi_FindNearestFreeLocator("goto", locx, locy, locz);
		if (sTemp == "") sTemp = LAi_FindNearestLocator("goto", locx, locy, locz);
        ChangeCharacterAddressGroup(sld, "Shore18", "goto", sTemp);
    }
	sld = GetCharacter(NPC_GenerateCharacter("Nabuki", "Canib_Boss", "man", "man", 35, PIRATE, 0, true, "quest"));
    sld.name 	= "Nabukee";
    sld.lastname = "Anaconda";
	FantomMakeCoolFighter(sld, 35, 80, 80, "topor_01", "pistol4", "bullet", 150);
	TakeNItems(sld, "jewelry2", 120+rand(80));
	TakeNItems(sld, "jewelry3", 120+rand(60));
	TakeNItems(sld, "jewelry4", 140+rand(50));
	TakeNItems(sld, "jewelry6", rand(50));
	sld.SaveItemsForDead = true; // сохранять на трупе вещи
	sld.DontClearDead = true;
	sld.cirassId = Items_FindItemIdx("cirass1"); 
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	GetCharacterPos(pchar, &locx, &locy, &locz);
	sTemp = LAi_FindNearestFreeLocator("goto", locx, locy, locz);
	if (sTemp == "") sTemp = LAi_FindNearestLocator("goto", locx, locy, locz);
	ChangeCharacterAddressGroup(sld, "Shore18", "goto", sTemp);
    LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
    LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "OpenTheDoors");
}

void Slavetrader_GetHispanShore()//определение бухты, из которой галеон выйдет
{
	pchar.questTemp.Slavetrader.Island = "Caracas";
	pchar.questTemp.Slavetrader.Island.Shore = "Shore21";
	pchar.questTemp.SlavetraderAreal.add = "из Каракаса";
	while(pchar.questTemp.Slavetrader.Island == Islands[GetCharacterCurrentIsland(pchar)].id)
	{
		pchar.questTemp.Slavetrader.Island = "Cumana";
		pchar.questTemp.Slavetrader.Island.Shore = "Shore19";
		pchar.questTemp.SlavetraderAreal.add = "из Куманы";
	}
}

void Slavetrader_SlaveHalleon_AfterBattle(string qName)//реакция на победу
{
	Group_DeleteGroup("SlaveGalleon");
	pchar.quest.Slavetrader_SlaveGalleonOver.over = "yes";
	AddQuestRecord("Slavetrader", "19");
	AddQuestUserData("Slavetrader", "sShipName", pchar.questTemp.Slavetrader.ShipName);
	ChangeCharacterComplexReputation(pchar,"nobility", -5);
	pchar.questTemp.Slavetrader = "wingalleon";
}

void Slavetrader_SlaveGalleonOver(string qName)//просроченный таймер
{
	Group_DeleteGroup("SlaveGalleon");
	pchar.quest.Slavetrader_SlaveGalleon.over = "yes";
	pchar.quest.SlaveHalleon_AfterBattle.over = "yes";
	AddQuestRecord("Slavetrader", "7_2");
	AddQuestUserData("Slavetrader", "sShipName", pchar.questTemp.Slavetrader.ShipName);
	pchar.questTemp.Slavetrader = "lostgalleon";
	ChangeOfficersLoyality("bad_all", 1);
}

void Slavetrader_RatCorvette(string qName)//создание корвета крысы
{
	ref sld;
	string sTemp;
    Island_SetReloadEnableGlobal("Tortuga", false);
    Group_FindOrCreateGroup("Rat_Attack");
	Group_SetType("Rat_Attack", "war");
	sTemp = pchar.questTemp.Slavetrader.ShipName;
	sld = GetCharacter(NPC_GenerateCharacter("RatCap", "Gontier", "man", "man", 35, FRANCE, 3, true, "quest"));
	sld.name = "Fransua";
	sld.lastname = "Gontier";
	FantomMakeCoolSailor(sld, SHIP_CORVETTE, sTemp, CANNON_TYPE_CANNON_LBS20, 100, 70, 70);
	FantomMakeCoolFighter(sld, 35, 80, 80, "blade_18", "pistol5", "bullet", 200);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.Ship.Mode = "pirate";
	Group_AddCharacter("Rat_Attack", "RatCap");
	sld.AlwaysEnemy = true;
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "HardHitter");
	SetCharacterPerk(sld, "GunProfessional");
	SetCharacterPerk(sld, "MusketsShoot");
	sld.ship.Crew.Morale = 100;
	ChangeCrewExp(sld, "Sailors", 100);
	ChangeCrewExp(sld, "Cannoners", 100);
	ChangeCrewExp(sld, "Soldiers", 100);
	Group_SetGroupCommander("Rat_Attack", "RatCap");
	Group_SetTaskAttack("Rat_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("Rat_Attack", PLAYER_GROUP);
	Group_SetAddress("Rat_Attack", "Tortuga", "", "");
	Group_LockTask("Rat_Attack");
    pchar.quest.Slavetrader_AfterBattle.win_condition.l1 = "Group_Death";//условие победы
	pchar.quest.Slavetrader_AfterBattle.win_condition.l1.group = "Rat_Attack";
	pchar.quest.Slavetrader_AfterBattle.function = "Slavetrader_RatAttack_AfterBattle";//это победа
	pchar.quest.Slavetrader_DieHard.win_condition.l1 = "MapEnter";
    pchar.quest.Slavetrader_DieHard.function = "Slavetrader_RatAttack_DieHard";//это слинял
	pchar.quest.Slavetrader_RatCorvetteOver.over = "yes";
}

void Slavetrader_RatAttack_AfterBattle(string qName)//реакция на победу
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Group_DeleteGroup("Rat_Attack");
	Island_SetReloadEnableGlobal("Tortuga", true);
    pchar.quest.Slavetrader_DieHard.over = "yes";
	AddQuestRecord("Slavetrader", "21_12");
	pchar.questTemp.Slavetrader = "wincorvette";
	AddComplexSeaExpToScill(100, 100, 100, 100, 100, 100, 0);
}

void Slavetrader_RatAttack_DieHard(string qName)//реакция на поражение
{
	Group_DeleteGroup("Rat_Attack");
    Island_SetReloadEnableGlobal("Tortuga", true);
    pchar.quest.Slavetrader_AfterBattle.over = "yes";
	AddQuestRecord("Slavetrader", "21_11");
	AddQuestUserData("Slavetrader", "sSex", GetSexPhrase("счел","сочла"));
	pchar.questTemp.Slavetrader = "lostcorvette";
	ChangeOfficersLoyality("bad_all", 1);
}

void Slavetrader_RatCorvetteOver(string qName)//просроченный таймер корвета
{
	pchar.quest.Slavetrader_RatAttack.over = "yes";
	AddQuestRecord("Slavetrader", "21_10");
	AddQuestUserData("Slavetrader", "sSex", GetSexPhrase("","а"));
	pchar.questTemp.Slavetrader = "lostcorvette";
	ChangeOfficersLoyality("bad_all", 1);
}

void Slavetrader_GetEscapeShore()//выбираем маяк, куда беглых рабов запхнем
{
	switch (rand(9))
	{
		case 0:
			pchar.questTemp.Slavetrader.EsIsland = "Barbados";
			pchar.questTemp.Slavetrader.Island.Shore = "Mayak2";
			pchar.questTemp.SlavetraderAreal.add = "at the shores of Barbados";
			break;
		case 1:
			pchar.questTemp.Slavetrader.EsIsland = "Guadeloupe";
			pchar.questTemp.Slavetrader.Island.Shore = "Mayak4";
			pchar.questTemp.SlavetraderAreal.add = "at the shores of Guadeloupe";
			break;
		case 2:
			pchar.questTemp.Slavetrader.EsIsland = "Cuba1";
			pchar.questTemp.Slavetrader.Island.Shore = "Mayak9";
			pchar.questTemp.SlavetraderAreal.add = "not far from Santiago";
			break;
		case 3:
			pchar.questTemp.Slavetrader.EsIsland = "Cuba2";
			pchar.questTemp.Slavetrader.Island.Shore = "Mayak10";
			pchar.questTemp.SlavetraderAreal.add = "not far from Havana";
			break;
		case 4:
			pchar.questTemp.Slavetrader.EsIsland = "Tortuga";
			pchar.questTemp.Slavetrader.Island.Shore = "Mayak6";
			pchar.questTemp.SlavetraderAreal.add = "at the shores of Tortuga";
			break;
		case 5:
			pchar.questTemp.Slavetrader.EsIsland = "Trinidad";
			pchar.questTemp.Slavetrader.Island.Shore = "Mayak1";
			pchar.questTemp.SlavetraderAreal.add = "at the shores of Trinidad";
			break;
		case 6:
			pchar.questTemp.Slavetrader.EsIsland = "Nevis";
			pchar.questTemp.Slavetrader.Island.Shore = "Mayak5";
			pchar.questTemp.SlavetraderAreal.add = "at the shores of St. Christopher";
			break;
		case 7:
			pchar.questTemp.Slavetrader.EsIsland = "Hispaniola1";
			pchar.questTemp.Slavetrader.Island.Shore = "Mayak8";
			pchar.questTemp.SlavetraderAreal.add = "not far from Santo Domingo";
			break;
		case 8:
			pchar.questTemp.Slavetrader.EsIsland = "Hispaniola2";
			pchar.questTemp.Slavetrader.Island.Shore = "Mayak7";
			pchar.questTemp.SlavetraderAreal.add = "not far from Port-au-Prince";
			break;
		case 9:
			pchar.questTemp.Slavetrader.EsIsland = "Cartahena";
			pchar.questTemp.Slavetrader.Island.Shore = "Mayak11";
			pchar.questTemp.SlavetraderAreal.add = "not far from Cartagena";
			break;
	}
}

void Slavetrader_EscapeSlaveInShore(string qName)
{
	string sShore = pchar.questTemp.Slavetrader.Island.Shore;
    LAi_group_Delete("EnemyFight"); 
	chrDisableReloadToLocation = true; //закроем локацию
	GetCharacterPos(pchar, &locx, &locy, &locz);
	//наши
    for (i=1; i<=3; i++)
    {
        iTemp = 10+rand(10);
		sld = GetCharacter(NPC_GenerateCharacter("OwnCrew_"+i, "citiz_"+(rand(8)+42), "man", "man", iTemp, sti(pchar.nation), 0, true, "soldier"));
		SetFantomParamFromRank(sld, iTemp, true);
        LAi_SetWarriorType(sld);
		LAi_warrior_DialogEnable(sld, false);
        LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		sTemp = LAi_FindNearestFreeLocator("goto", locx, locy, locz);
		if (sTemp == "") sTemp = LAi_FindNearestLocator("goto", locx, locy, locz);
        ChangeCharacterAddressGroup(sld, sShore, "goto", sTemp);
    }
	//враги
	for (i=21; i<=27; i++)
    {
		iTemp = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
		sld = GetCharacter(NPC_GenerateCharacter("EscapeSlave_"+i, "prizon_"+(rand(3)+1), "man", "man_B", iTemp, PIRATE, -1, true, "marginal"));
		SetFantomParamFromRank(sld, iTemp, true);
		LAi_SetWarriorType(sld);
        LAi_group_MoveCharacter(sld, "EnemyFight");
        GetCharacterPos(pchar, &locx, &locy, &locz);
        ChangeCharacterAddressGroup(sld, sShore, "goto", "goto"+i);
    }
	sld = GetCharacter(NPC_GenerateCharacter("Jimmy", "Tamango", "man", "man", 30, PIRATE, 0, true, "quest"));
	sld.name 	= "Tamango";
	sld.lastname = "";
	FantomMakeCoolFighter(sld, 30, 80, 80, "blade_06", "pistol1", "bullet", 100);
	sld.SaveItemsForDead = true; // сохранять на трупе вещи
	sld.cirassId = Items_FindItemIdx("cirass1");
	sld.DontClearDead = true;
	LAi_SetWarriorType(sld);
    LAi_group_MoveCharacter(sld, "EnemyFight");
    GetCharacterPos(pchar, &locx, &locy, &locz);
    ChangeCharacterAddressGroup(sld, sShore, "goto", "goto30");
    LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
    LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Slavetrader_EscapeSlaves_Win");
}

void Slavetrader_Slavewoman()
{
	sld = characterFromId("Slavewoman");	
	LAi_SetPlayerType(pchar);
	SetCharacterRemovable(sld, false);
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "goto", "goto2", "none", "", "", "", 15.0);
	sld.lifeday = 0;
	for (i=10; i<=25; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("SlaveShor_"+i, "prizon_"+(rand(3)+1), "man", "man_B", 10, PIRATE, 0, true, "quest"));
		FantomMakeCoolFighter(sld, 25, 100, 100, "", "","", 80);
		ChangeCharacterAddressGroup(sld, pchar.questTemp.Slavetrader.Island.Shore, "goto",  "goto"+i);
		sld = characterFromID("SlaveShor_"+i);
		LAi_SetImmortal(sld, true);
		LAi_SetActorType(sld);
		LAi_SetCitizenTypeNoGroup(sld);
		LAi_CharacterDisableDialog(sld);
	}
	SetCharacterGoods(pchar, GOOD_SLAVES, GetCargoGoods(pchar, GOOD_SLAVES) + 1000 + rand(100));
	sTemp = GetSquadronGoods(Pchar, GOOD_SLAVES);
	AddQuestRecord("Slavetrader", "22");
	AddQuestUserData("Slavetrader", "sQty", sTemp);
	pchar.questTemp.Slavetrader = "escapeslave_win";
	ChangeCharacterComplexReputation(pchar, "nobility", -1);
	OfficersReaction("bad");
}

void Slavetrader_CreateLineShips(string qName)//создание линейных кораблей
{
	int i;
	ref sld;
	string sTemp;

	Island_SetReloadEnableGlobal("Cuba2", false);
    Group_FindOrCreateGroup("Havana_Attack");
	Group_SetType("Havana_Attack", "war");
	SetNationRelation2MainCharacter(SPAIN, RELATION_ENEMY);//ссорим ГГ и испанцев
	for (i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("HavanaAttack_"+i, "off_spa_"+i, "man", "man", 35, SPAIN, -1, true, "quest"));
		FantomMakeCoolSailor(sld, SHIP_LINESHIP, "", CANNON_TYPE_CANNON_LBS32, 100, 100, 100);
		FantomMakeCoolFighter(sld, 45, 100, 100, "blade_21", "pistol5", "bullet", 100);
		Group_AddCharacter("Havana_Attack", "HavanaAttack_"+i);
		sld.AlwaysEnemy = true;
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		SetCharacterPerk(sld, "MusketsShoot");
		SetCharacterPerk(sld, "Tireless");
		SetCharacterPerk(sld, "HardHitter");
		SetCharacterPerk(sld, "GunProfessional");
		sld.ship.Crew.Morale = 100;
		ChangeCrewExp(sld, "Sailors", 100);
		ChangeCrewExp(sld, "Cannoners", 100);
		ChangeCrewExp(sld, "Soldiers", 100);
    }
	Group_SetGroupCommander("Havana_Attack", "HavanaAttack_1");
	Group_SetTaskAttack("Havana_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("Havana_Attack", PLAYER_GROUP);
	Group_SetAddress("Havana_Attack", "Cuba2", "", "");
	Group_LockTask("Havana_Attack");
	bQuestDisableMapEnter = true; //запрещаем выход на глобу, чтоб не взяли форт до потопления	
   
    pchar.quest.Slavetrader_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Slavetrader_AfterBattle.win_condition.l1.group = "Havana_Attack";
	pchar.quest.Slavetrader_AfterBattle.function = "Slavetrader_HavanaAttack_AfterBattle";//это победа
	pchar.quest.Slavetrader_DieHardHavana.win_condition.l1 = "MapEnter";//не лезь на карту
    pchar.quest.Slavetrader_DieHardHavana.function = "Slavetrader_HavanaAttack_DieHard";//теперь пеняй на себя
	AddQuestRecord("Slavetrader", "25");
}

void Slavetrader_HavanaAttack_AfterBattle(string qName)//реакция на победу
{
	bQuestDisableMapEnter = false;
	Group_DeleteGroup("Havana_Attack");
	Island_SetReloadEnableGlobal("Cuba2", true);
	AddQuestRecord("Slavetrader", "26");
}

void Slavetrader_HavanaAttack_DieHard(string qName)//если надумал починиться
{
	pchar.quest.Slavetrader_HavanaOver.over = "yes";//снимем таймер
	characters[GetCharacterIndex("Havana_Mayor")].dialog.captureNode = "CAPTURE_Main";//снимем ноду губеру
	AddQuestRecord("Slavetrader", "26_1");
	AddQuestUserData("Slavetrader", "sSex", GetSexPhrase("","а"));
	CloseQuestHeader("Slavetrader");
	pchar.questTemp.Slavetrader = "End_quest";
}

void Slavetrader_HavanaOver(string qName)//просроченный таймер
{
	pchar.quest.Slavetrader_HavanaAttack.over = "yes";
	AddQuestRecord("Slavetrader", "28");
	AddQuestUserData("Slavetrader", "sSex", GetSexPhrase("","ла"));
	ChangeOfficersLoyality("bad_all", 1);
	CloseQuestHeader("Slavetrader");
	characters[GetCharacterIndex("Havana_Mayor")].dialog.captureNode = "CAPTURE_Main";
	pchar.questTemp.Slavetrader = "End_quest";
}

void Slavetrader_FiveTSlavesOver(string qName)//просроченный таймер
{
	ChangeCharacterHunterScore(pchar, NationShortName(sti(pchar.questTemp.Slavetrader.Nation)) + "hunter", 90);
	AddQuestRecord("Slavetrader", "30");
	AddQuestUserData("Slavetrader", "sSex", GetSexPhrase("","а"));
	CloseQuestHeader("Slavetrader");
	pchar.questTemp.Slavetrader = "End_quest";
}

void Slavetrader_HavanaSeekOver(string qName)//просроченный таймер
{
	ChangeCharacterHunterScore(pchar, NationShortName(sti(pchar.questTemp.Slavetrader.Nation)) + "hunter", 90);
	AddQuestRecord("Slavetrader", "31");
	AddQuestUserData("Slavetrader", "sSex", GetSexPhrase("","а"));
	CloseQuestHeader("Slavetrader");
	pchar.questTemp.Slavetrader = "End_quest";
}

void Slavetrader_UsurerEscape(string qName)//меняем модель ростовщика
{
	sld = characterFromId(pchar.questTemp.Slavetrader.UsurerId);
	sld.name = "Sven";
	sld.lastname = "Carlson";
	sld.model = "trader_8";
	LocatorReloadEnterDisable(pchar.questTemp.Slavetrader.Cityname, "reload8_back", false);
}
//<-- Работорговец конец

//-->------------------------------------малява, грабеж торгашей------------------------------------------------
void Deliver_CreateTraderShips(string qName)//создание торговых кораблей
{
	int i, ShipType, Rank, iShipRank, iCannonType;
	int iGoods, iSpace;
	ref sld;
	string sTemp1, sTemp2, sNation;
			
	sTemp1 = pchar.questTemp.jailCanMove.Deliver.ShipName1;//имя корабля
	sTemp2 = pchar.questTemp.jailCanMove.Deliver.ShipName2;//имя корабля
	sNation = pchar.questTemp.jailCanMove.Deliver.Nation;
    Island_SetReloadEnableGlobal(pchar.questTemp.jailCanMove.Deliver.Island, false);
    Group_FindOrCreateGroup("Trade_Attack");//создать группу
	Group_SetType("Trade_Attack", "trade");//тип группы
	for (i=1; i<=2; i++)
	{
		if(makeint(pchar.rank) >= 20) { iShipRank = 3; }
		if(makeint(pchar.rank) >= 15 && makeint(pchar.rank) < 20) { iShipRank = rand(1)+2; }	
		if(makeint(pchar.rank) >= 10 && makeint(pchar.rank) < 15) { iShipRank = rand(1)+1; }	
		if(makeint(pchar.rank) >= 5 && makeint(pchar.rank) < 10) { iShipRank = rand(1); }	
		if(makeint(pchar.rank) < 5) { iShipRank = 0; }
		switch (iShipRank)
		{
			case 0:  
				ShipType = SHIP_BARQUE;     					
				Rank = 12 + rand(5);
				iCannonType = CANNON_TYPE_CANNON_LBS6;
			break; 		
			case 1:  
				ShipType = SHIP_FLEUT;			
				Rank = 18 + rand(5);
				iCannonType = CANNON_TYPE_CANNON_LBS12;
			break; 
			case 2: 
				ShipType = SHIP_PINNACE; 				
				Rank = 25 + rand(5);
				iCannonType = CANNON_TYPE_CANNON_LBS16;
			break; 
			case 3: 
				ShipType = SHIP_EASTINDIAMAN;         			
				Rank = 30 + rand(5);
				iCannonType = CANNON_TYPE_CANNON_LBS24;
			break; 			
		}
		sld = GetCharacter(NPC_GenerateCharacter("CaptainAttack_"+i, "trader_"+(rand(15)+1), "man", "man", Rank, sNation, 3, true, "hunter"));//создание кэпа
		if (i == 1)
		{
			FantomMakeCoolSailor(sld, ShipType, sTemp1, iCannonType, 48, 35, 35);//создание кораблей
		}
		if (i == 2)
		{
			FantomMakeCoolSailor(sld, ShipType, sTemp2, iCannonType, 44, 30, 30);//создание кораблей
		}
		sld.Ship.Mode = "trade";
		iGoods = sti(pchar.questTemp.jailCanMove.Deliver.Goods);
		iSpace = GetCharacterFreeSpace(sld, iGoods);
		iSpace = makeint(iSpace/2 + rand(iSpace/2));
		SetCharacterGoods(sld, iGoods, iSpace);
		Group_AddCharacter("Trade_Attack", "CaptainAttack_"+i);//добавление в группу
		sld.AlwaysEnemy = true;
		sld.ship.Crew.Morale = 30+MOD_SKILL_ENEMY_RATE*5;
		ChangeCrewExp(sld, "Sailors", 30+MOD_SKILL_ENEMY_RATE*5);
		ChangeCrewExp(sld, "Cannoners", 10+MOD_SKILL_ENEMY_RATE*5);
		ChangeCrewExp(sld, "Soldiers", 20+MOD_SKILL_ENEMY_RATE*5);
    }
	Group_SetGroupCommander("Trade_Attack", "CaptainAttack_1");
	Group_SetTaskAttack("Trade_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("Trade_Attack", PLAYER_GROUP);
	Group_SetAddress("Trade_Attack", pchar.questTemp.jailCanMove.Deliver.Island, "Quest_Ships", "Quest_Ship_" + (3+ rand(4)));
	Group_LockTask("Trade_Attack");
			
    pchar.quest.jailCanMoveDeliver_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.jailCanMoveDeliver_AfterBattle.win_condition.l1.group = "Trade_Attack";
	pchar.quest.jailCanMoveDeliver_AfterBattle.function = "Deliver_AfterBattle";//это победа
	pchar.quest.jailCanMoveDeliver_DieHard.win_condition.l1 = "MapEnter";
    pchar.quest.jailCanMoveDeliver_DieHard.function = "Deliver_DieHard";//это слинял
	pchar.quest.Deliver_TraderShipsOver.over = "yes";
	AddQuestRecord("GivePrisonFree", "13_1");
	AddQuestUserData("GivePrisonFree", "sSex", GetSexPhrase("ёл","ла"));
	AddQuestUserData("GivePrisonFree", "sShipName1", pchar.questTemp.jailCanMove.Deliver.ShipName1);
	AddQuestUserData("GivePrisonFree", "sShipName2", pchar.questTemp.jailCanMove.Deliver.ShipName2);
}

void Deliver_AfterBattle(string qName)//реакция на победу
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Group_DeleteGroup("Trade_Attack");
	Island_SetReloadEnableGlobal(pchar.questTemp.jailCanMove.Deliver.Island, true);
    pchar.quest.jailCanMoveDeliver_DieHard.over = "yes";
	DeleteAttribute(pchar, "questTemp.jailCanMove.Deliver");
	CloseQuestHeader("GivePrisonFree");
	AddComplexSeaExpToScill(100, 100, 100, 100, 100, 100, 0);
}

void Deliver_DieHard(string qName)//реакция на поражение
{
	Group_DeleteGroup("Trade_Attack");
    Island_SetReloadEnableGlobal(pchar.questTemp.jailCanMove.Deliver.Island, true);
    pchar.quest.jailCanMoveDeliver_AfterBattle.over = "yes";
	DeleteAttribute(pchar, "questTemp.jailCanMove.Deliver");
	CloseQuestHeader("GivePrisonFree");
}

void Deliver_TraderShipsOver(string qName)//просроченный таймер торговых кораблей и кидалова - 2 в 1
{
	pchar.quest.jailCanMoveDeliver_ShipsAttack.over = "yes";
	AddQuestRecord("GivePrisonFree", "13_2");
	AddQuestUserData("GivePrisonFree", "sSex", GetSexPhrase("","а"));
	AddQuestUserData("GivePrisonFree", "sShipName1", pchar.questTemp.jailCanMove.Deliver.ShipName1);
	AddQuestUserData("GivePrisonFree", "sShipName2", pchar.questTemp.jailCanMove.Deliver.ShipName2);
	DeleteAttribute(pchar, "questTemp.jailCanMove.Deliver");
	CloseQuestHeader("GivePrisonFree");
}
//<--малява, грабеж торгашей

//------------------------------------малява, перехват курьера-------------------------------------------------
void Deliver_CreateCureerShips(string qName)//создание курьерского корабля
{
	int i, ShipType, Rank, iShipRank, iCannonType;
	int iNation = sti(pchar.questTemp.jailCanMove.Deliver.Nation);
	ref sld;
	string Blade, sTemp, sNation;
	
	sTemp = pchar.questTemp.jailCanMove.Deliver.ShipName;//имя корабля
	sNation = pchar.questTemp.jailCanMove.Deliver.Nation;
    Island_SetReloadEnableGlobal(pchar.questTemp.jailCanMove.Deliver.Island, false);
    Group_FindOrCreateGroup("Cureer_Attack");
	Group_SetType("Cureer_Attack", "war");
		if(makeint(pchar.rank) >= 24) { iShipRank = 3; }
		if(makeint(pchar.rank) >= 14 && makeint(pchar.rank) < 24) { iShipRank = 2; }	
		if(makeint(pchar.rank) >= 6 && makeint(pchar.rank) < 14) { iShipRank = 1; }	
		if(makeint(pchar.rank) < 6) { iShipRank = 0; }
		switch (iShipRank)
		{
			case 0:  
				ShipType = SHIP_CAREERLUGGER;     					
				Rank = 12 + rand(5);
                Blade = "blade_08";
				iCannonType = CANNON_TYPE_CANNON_LBS6;
			break; 		
			case 1:  
				ShipType = SHIP_BRIGANTINE;			
				Rank = 17 + rand(5);
                Blade = "blade_09";
				iCannonType = CANNON_TYPE_CANNON_LBS16;
			break; 
			case 2: 
				ShipType = SHIP_POLACRE; 				
				Rank = 22 + rand(5);
                Blade = "blade_10";
				iCannonType = CANNON_TYPE_CANNON_LBS20;
			break; 
			case 3: 
				ShipType = SHIP_FRIGATE;         			
				Rank = 30 + rand(5);
                Blade = "blade_13";
				iCannonType = CANNON_TYPE_CANNON_LBS24;
			break; 			
		}
	sld = GetCharacter(NPC_GenerateCharacter("CureerAttack", "off_" + NationShortName(iNation) + "_" + (rand(1) + 1), "man", "man", Rank, sNation, 3, true, "quest"));
	FantomMakeCoolSailor(sld, ShipType, sTemp, iCannonType, 75, 50, 50);
	FantomMakeCoolFighter(sld, Rank, 40, 40, Blade, "pistol3", "grapeshot", 40);
	Group_AddCharacter("Cureer_Attack", "CureerAttack");
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	SetCharacterPerk(sld, "MusketsShoot");
	sld.AlwaysEnemy = true;
	Group_SetGroupCommander("Cureer_Attack", "CureerAttack");
	Group_SetTaskAttack("Cureer_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("Cureer_Attack", PLAYER_GROUP);
	Group_SetAddress("Cureer_Attack", pchar.questTemp.jailCanMove.Deliver.Island, "Quest_Ships", "Quest_Ship_" + (3+ rand(4)));
	Group_LockTask("Cureer_Attack");
			
    pchar.quest.jailCanMoveDeliver_AfterBattleC.win_condition.l1 = "Group_Death";
	pchar.quest.jailCanMoveDeliver_AfterBattleC.win_condition.l1.group = "Cureer_Attack";
	pchar.quest.jailCanMoveDeliver_AfterBattleC.function = "DeliverC_AfterBattle";//это победа
	pchar.quest.jailCanMoveDeliver_DieHardC.win_condition.l1 = "MapEnter";
    pchar.quest.jailCanMoveDeliver_DieHardC.function = "DeliverC_DieHard";//это слинял
	pchar.quest.Deliver_CureerShipsOver.over = "yes";
	AddQuestRecord("GivePrisonFree", "14_1");
	AddQuestUserData("GivePrisonFree", "sSex", GetSexPhrase("ёл","ла"));
	AddQuestUserData("GivePrisonFree", "sShipName", pchar.questTemp.jailCanMove.Deliver.ShipName);
}

void DeliverC_AfterBattle(string qName)//реакция на победу
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Group_DeleteGroup("Cureer_Attack");
	Island_SetReloadEnableGlobal(pchar.questTemp.jailCanMove.Deliver.Island, true);
    pchar.quest.jailCanMoveDeliver_DieHardC.over = "yes";
	DeleteAttribute(pchar, "questTemp.jailCanMove.Deliver");
	CloseQuestHeader("GivePrisonFree");
	AddComplexSeaExpToScill(100, 100, 100, 100, 100, 100, 0);
}

void DeliverC_DieHard(string qName)//реакция на поражение
{
	Group_DeleteGroup("Cureer_Attack");
    Island_SetReloadEnableGlobal(pchar.questTemp.jailCanMove.Deliver.Island, true);
    pchar.quest.jailCanMoveDeliver_AfterBattleC.over = "yes";
	DeleteAttribute(pchar, "questTemp.jailCanMove.Deliver");
	CloseQuestHeader("GivePrisonFree");
}

void Deliver_CureerShipsOver(string qName)//просроченный таймер курьерского корабля
{
	pchar.quest.jailCanMoveDeliver_ShipsCAttack.over = "yes";
	AddQuestRecord("GivePrisonFree", "14_2");
	AddQuestUserData("GivePrisonFree", "sSex", GetSexPhrase("","а"));
	AddQuestUserData("GivePrisonFree", "sShipName", pchar.questTemp.jailCanMove.Deliver.ShipName);
	DeleteAttribute(pchar, "questTemp.jailCanMove.Deliver");
	CloseQuestHeader("GivePrisonFree");
}
//<--малява, перехват курьера

//------------------------------------------малява, кидалово-----------------------------------------
void Deliver_lay(string qName)//пришли - а нету никого
{
	pchar.quest.Deliver_TraderShipsOver.over = "yes";
	AddQuestRecord("GivePrisonFree", "15");
	AddQuestUserData("GivePrisonFree", "sSex", GetSexPhrase("ёл","ла"));
	AddQuestUserData("GivePrisonFree", "sSex1", GetSexPhrase("","а"));
	AddQuestUserData("GivePrisonFree", "sShipName1", pchar.questTemp.jailCanMove.Deliver.ShipName1);
	AddQuestUserData("GivePrisonFree", "sShipName2", pchar.questTemp.jailCanMove.Deliver.ShipName2);
	DeleteAttribute(pchar, "questTemp.jailCanMove.Deliver");
	CloseQuestHeader("GivePrisonFree");
}
//<--малява, кидалово

//zagolski - побег офицера
void mOfficer_fc(string qName)
{
	ref sld;
	if (!CheckAttribute(pchar, "questTemp.MutinyOfficerIDX")) {
		return;
	}
	sld = &Characters[sti(Pchar.questTemp.MutinyOfficerIDX)];
	if (!CheckAttribute(sld, "quest.Mutiny")) { // mitrokosta если офф мертв или уволен
		DeleteAttribute(pchar, "questTemp.MutinyOfficerIDX");
		return;
	}
	if (CheckAttribute(sld, "ShipInStockMan")) { // mitrokosta сюрприз для хитрецов поставивших в ПУ
		DeleteAttribute(pchar, "questTemp.MutinyOfficerIDX");
		sld.quest.Mutiny.date = GetDateString();
		return;
	}

	if (IsEntity(&worldMap))
    {
		sld = &Characters[sti(Pchar.questTemp.MunityOfficerIDX)];
		if(sti(sld.Payment) == true)
		{
			if (sti(sld.ship.type) != SHIP_NOTUSED)
			{
				Log_SetStringToLog("Officer " + GetFullName(sld) + " has run away with " + sld.ship.name + "");
				DeleteAttribute(pchar, "questTemp.MutinyOfficerIDX");
			}
			else
			{
				Log_SetStringToLog("Officer " + GetFullName(sld) + " has run away from " + pchar.ship.name + "");

				if (GetCrewQuantity(pchar) > 0 && !IsEquipCharacterByArtefact(pchar, "totem_02"))
				{
					AddCharacterExpToSkill(PChar, "Leadership", 200);
					MunityOnShip("ShipMunity");
				}
				else DeleteAttribute(pchar, "questTemp.MutinyOfficerIDX");
			}
			sld.LifeDay = 0;
			RemovePassenger(Pchar, sld);
		}
		else DeleteAttribute(pchar, "questTemp.MutinyOfficerIDX");
		
    }
	else
    {
        pchar.quest.mOfficer_fc2.win_condition.l1 = "MapEnter";
		pchar.quest.mOfficer_fc2.function    = "mOfficer_fc2";
    }
}

void mOfficer_fc2(string qName)
{
	if (!CheckAttribute(pchar, "questTemp.MutinyOfficerIDX")) {
		return;
	}
	ref sld = &Characters[sti(Pchar.questTemp.MutinyOfficerIDX)];
	if (!CheckAttribute(sld, "quest.Mutiny")) { // mitrokosta если офф мертв или уволен
		DeleteAttribute(pchar, "questTemp.MutinyOfficerIDX");
		return;
	}
	if (CheckAttribute(sld, "ShipInStockMan")) { // mitrokosta сюрприз для хитрецов поставивших в ПУ
		DeleteAttribute(pchar, "questTemp.MutinyOfficerIDX");
		sld.quest.Mutiny.date = GetDateString();
		return;
	}

	if(sti(sld.Payment) == true)
	{
		if (sti(sld.ship.type) != SHIP_NOTUSED)
		{
			Log_SetStringToLog("Офицер " + GetFullName(sld) + " сбежал с кораблем " + sld.ship.name + "");
			DeleteAttribute(pchar, "questTemp.MutinyOfficerIDX");
		}
		else
		{
			Log_SetStringToLog("Офицер " + GetFullName(sld) + " сбежал с корабля " + pchar.ship.name + "");

			if (GetCrewQuantity(pchar) > 0 && !IsEquipCharacterByArtefact(pchar, "totem_02"))
			{
				AddCharacterExpToSkill(PChar, "Leadership", 200);
				MunityOnShip("ShipMunity");
			}
			else DeleteAttribute(pchar, "questTemp.MutinyOfficerIDX");
		}
		sld.LifeDay = 0;
		RemovePassenger(Pchar, sld);
	}
	else DeleteAttribute(pchar, "questTemp.MutinyOfficerIDX");
}

// zagolski - опасный груз
void zpq_sld1_fc(string qName)
{
	int iRank = sti(pchar.rank)+5;
	int iScl = 20+sti(pchar.rank)*2;
	LAi_group_Delete("EnemyFight");
	LAi_LocationFightDisable(loadedLocation, true);

    	for (i=1; i<=3; i++)
    	{
		sld = GetCharacter(NPC_GenerateCharacter("qp2_"+i, "citiz_"+(i+40), "man", "man", iRank, PIRATE, 0, true, "quest"));
		sld.Dialog.Filename = "Quest\zpq_dialog.c";
		sld.dialog.currentnode = "zpq_sld2";
		sld.greeting = "Enc_Waiker";
		LAi_SetActorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
		ChangeCharacterAddressGroup(sld, "Cumana_ExitTown", "goto", "goto5");
		if (i == 1)
		{
			FantomMakeCoolFighter(sld, iRank, iScl+5, iScl+5, "blade_10", "pistol1","bullet", iScl*2);
			LAi_ActorDialog(sld, pchar, "", 3, 0);
			GiveItem2Character(sld, "jewelry4");
			AddMoneyToCharacter(sld, 1000+rand(1000));
			sld.SaveItemsForDead  = true;
			sld.DontClearDead = true;
			if (GetCharacterItem(pchar, "map_full") == 0)
			{
				if (GetCharacterItem(pchar, "map_part1") == 0) GiveItem2Character(sld, "map_part1");
				else
				{
					if (GetCharacterItem(pchar, "map_part2") == 0) GiveItem2Character(sld, "map_part2");
				}
			}
			else GiveItem2Character(sld, "map_normal");
		}
		else
		{
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_04", "pistol1","bullet", iScl);
			LAi_ActorFollow(sld, characterFromId("qp2_1"), "", -1);
		}
	}		
}

void zpq_seaBattle(string qName)
{
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 20+sti(pchar.rank)*2;
	LAi_group_Delete("EnemyFight");
	sld = GetCharacter(NPC_GenerateCharacter("zpqCaptain", "citiz_45", "man", "man", iRank, PIRATE, 1, true, "quest"));
	FantomMakeSmallSailor(sld, SHIP_CAREERLUGGER, "Normandy", CANNON_TYPE_CANNON_LBS6, iScl, iScl, iScl, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_10", "pistol3", "grapeshot", iScl*2);
    sld.name 	= "Small";
    sld.lastname = "Jimmy";
	sld.AlwaysSandbankManeuver = true;
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	SetCharacterPerk(sld, "MusketsShoot");
	LAi_group_MoveCharacter(sld, "EnemyFight");
	Group_AddCharacter("zpq_Group", "zpqCaptain");			
	Group_SetType("zpq_Group", "Pirate");
	Group_SetGroupCommander("zpq_Group", "zpqCaptain");
	Group_SetAddress("zpq_Group", "Cumana", "quest_ships", "quest_ship_4");
	Group_SetTaskAttack("zpq_Group", PLAYER_GROUP);
	Group_LockTask("zpq_Group");
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////
// --> Jason ---------------------------Товарно-транспортный генератор-----------------------------------------
///////////////////////////////////////////////////////////////////////////////////////////////////////////////
void FrahtHunterOnSea()//охотники в акватории порта прибытия, одна функция на троих
{
	ref sld;
	int i, iShipType, iRank, iShipRank, iCannonType, iNation;
	string sBlade, sTemp;
    Group_FindOrCreateGroup("Fraht_Attack");
	Group_SetType("Fraht_Attack", "war");
	iNation = PIRATE;
	if (pchar.questTemp.WPU.Postcureer == "begin") iNation = pchar.questTemp.WPU.Postcureer.EnemyNation;
	if (pchar.questTemp.WPU.Escort == "begin") iNation = pchar.questTemp.WPU.Escort.EnemyNation;
	for (i=1; i<=2; i++)
	{
		iRank = sti(pchar.rank) + rand(5);
		if(makeint(pchar.rank) >= 25) { iShipRank = 5; }
		if(makeint(pchar.rank) >= 19 && makeint(pchar.rank) < 25) { iShipRank = 4; }	
		if(makeint(pchar.rank) >= 13 && makeint(pchar.rank) < 18) { iShipRank = 3; }	
		if(makeint(pchar.rank) >= 8 && makeint(pchar.rank) < 12) { iShipRank = 2; }	
		if(makeint(pchar.rank) >= 5 && makeint(pchar.rank) < 8) { iShipRank = 1; }	
		if(makeint(pchar.rank) < 5) { iShipRank = 0; }
		switch (iShipRank)
		{
			case 0:  
				iShipType = SHIP_LUGGER + rand(makeint(SHIP_SLOOP - SHIP_LUGGER));     					
				iCannonType = CANNON_TYPE_CANNON_LBS6;
				sBlade = "blade_03";
			break; 	
			case 1:  
				iShipType = SHIP_SLOOP + rand(makeint(SHIP_BRIG - SHIP_SLOOP));					
				iCannonType = CANNON_TYPE_CANNON_LBS12;
				sBlade = "blade_05";
			break; 		
			case 2:  
				iShipType = SHIP_BRIG + rand(makeint(SHIP_GALEON_L - SHIP_BRIG));			
				iCannonType = CANNON_TYPE_CANNON_LBS16;
				sBlade = "blade_06";
			break; 		
			case 3: 
				iShipType = SHIP_GALEON_L + rand(makeint(SHIP_XebekVML - SHIP_GALEON_L));				
				iCannonType = CANNON_TYPE_CULVERINE_LBS18;
				sBlade = "blade_10";
			break; 
			case 4: 
				iShipType = SHIP_CORVETTE + rand(makeint(SHIP_POLACRE - SHIP_CORVETTE));         			
				iCannonType = CANNON_TYPE_CANNON_LBS20;
				sBlade = "blade_13";
			break; 
			case 5: 
				iShipType = SHIP_GALEON_H + rand(makeint(SHIP_FRIGATE_H - SHIP_GALEON_H));  						
				iCannonType = CANNON_TYPE_CANNON_LBS24;
				sBlade = "blade_19";
			break;  				
		}
		sld = GetCharacter(NPC_GenerateCharacter("FrahtAttack_"+i, "citiz_"+(rand(9)+41), "man", "man", iRank, iNation, 30, true, "quest"));//создание кэпа
		FantomMakeSmallSailor(sld, iShipType, "", iCannonType, 30+rand(15), 20+rand(10), 20+rand(15), 20+rand(15), 20+rand(15));
		FantomMakeCoolFighter(sld, iRank, 30, 30, sBlade, "pistol1", "bullet", 30);
		SetCaptanModelByEncType(sld, "war");
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.AlwaysEnemy = true;
		sld.AnalizeShips = true; 
		Group_AddCharacter("Fraht_Attack", "FrahtAttack_"+i);//добавление в группу
    }
	Group_SetGroupCommander("Fraht_Attack", "FrahtAttack_1");
	Group_SetTaskAttack("Fraht_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("Fraht_Attack", PLAYER_GROUP);
	Group_SetAddress("Fraht_Attack", pchar.questTemp.WPU.Current.TargetIslandID, "", "");
	Group_LockTask("Fraht_Attack");
}

void EnemyNationHunterOnMap(bool _fast)//охотники вражеской нации
{
    ref  sld;
    int  i, iNation;
    string sCapId = "FollowerNation0"; // patch
    string sGroup = "Sea_" + sCapId + "1";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	iNation = GetEnemyNationToMainCharacter();//вражеская нация
	while ((iNation) == PIRATE)
	{
			iNation = GetEnemyNationToMainCharacter();
	}
    for (i = 1; i <= GetCompanionQuantity(pchar); i++)
    {
        sld = GetCharacter(NPC_GenerateCharacter(sCapId + i, "off_" + NationShortName(iNation) + "_" + (rand(1) + 1), "man", "man", sti(PChar.rank) + 5, iNation, 6, true, "hunter"));
        SetShipHunter(sld);
        SetFantomParamHunter(sld);
        SetCaptanModelByEncType(sld, "war");
        sld.AlwaysEnemy = true;
        sld.DontRansackCaptain = true;
        sld.mapEnc.type = "war";
        sld.mapEnc.Name = "interceptors";
		sld.hunter = ""+iNation+"";
        Group_AddCharacter(sGroup, sCapId + i);
    }
    Group_SetGroupCommander(sGroup, sCapId+ "1");
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
	if (_fast) Map_CreateCoolWarrior("", sCapId + "1", 6);
	else Map_CreateWarrior("", sCapId + "1", 6);
}

//--> ------------------------------------------фрахт------------------------------------------------------
void FrahtTime_Over(string qName)//опоздали доставить товар по фрахту
{
	pchar.questTemp.WPU.Fraht = "late";
	SaveCurrentQuestDateParam("questTemp.Fraht.Late");//запомнить дату
	AddQuestRecord("Fraht", "3");
	AddQuestUserData("Fraht", "sTargetColony" ,XI_ConvertString("Colony"+pchar.questTemp.WPU.Fraht.TargetCity+"Gen"));
	SetFunctionTimerCondition("FrahtTime_FullOver", 0, 0, 19, false);
}

void FrahtTime_FullOver(string qName)//прошли все разумные сроки
{
	pchar.questTemp.WPU.Fraht = "lost";
	AddQuestRecord("Fraht", "5");
	ChangeCharacterComplexReputation(pchar,"nobility", -10);
	ChangeCharacterHunterScore(pchar, NationShortName(sti(pchar.questTemp.WPU.Fraht.Nation)) + "hunter", 30);
	pchar.questTemp.WPU.Fraht.count = 0;//счетчик фрахтов в ноль
	Group_DeleteGroup("Fraht_Attack");
}

void FrahtTimeLevelUp_Over(string qName)//опоздали доставить товар по фрахту 2 уровня
{
	pchar.questTemp.WPU.Fraht.count = sti(pchar.questTemp.WPU.Fraht.count)-3;//скрутим счетчик
	DeleteAttribute(pchar, "questTemp.WPU.Fraht.LevelUp");
	DeleteAttribute(pchar, "questTemp.WPU.Fraht.TargetPortmanID");
	pchar.questTemp.WPU.Fraht = "complete";
	AddQuestRecord("Fraht", "3_1");
	CloseQuestHeader("Fraht");
}
// <-- фрахт конец

//--> ------------------------------------------------почта----------------------------------------------------
void PostcureerTime_Over(string qName)//опоздали доставить почту
{
	pchar.questTemp.WPU.Postcureer = "late";
	SaveCurrentQuestDateParam("questTemp.Postcureer.Late");//запомнить дату
	if (CheckAttribute(pchar, "questTemp.WPU.Postcureer.LevelUp")) SetFunctionTimerCondition("PostcureerTime_FullOver", 0, 0, 4, false);
	else SetFunctionTimerCondition("PostcureerTime_FullOver", 0, 0, 9, false);
	AddQuestRecord("Postcureer", "3");
}

void PostcureerTime_FullOver(string qName)//прошли все сроки на доставку почты
{
	pchar.questTemp.WPU.Postcureer = "lost";
	pchar.questTemp.WPU.Postcureer.count = 0;//счетчик почты в ноль
	Group_DeleteGroup("Fraht_Attack");
	if (CheckAttribute(pchar, "questTemp.WPU.Postcureer.LevelUp"))
	{
		AddQuestRecord("Postcureer", "7");
		ChangeCharacterComplexReputation(pchar,"nobility", -12);
		ChangeCharacterHunterScore(pchar, NationShortName(sti(pchar.questTemp.WPU.Postcureer.Nation)) + "hunter", 35);
	}
	else
	{
		AddQuestRecord("Postcureer", "5");
	}
}
//<--почта конец

//--> ----------------------------------------------эскорт-----------------------------------------------
void EscortTime_Over(string qName)//опоздали сопроводить корабли
{
	pchar.questTemp.WPU.Escort = "late";
	SaveCurrentQuestDateParam("questTemp.Escort.Late");//запомнить дату
	AddQuestRecord("Escort", "3");
	SetFunctionTimerCondition("EscortTime_FullOver", 0, 0, 9, false);
}

void EscortTime_FullOver(string qName)//прошли все сроки на сопровождение
{
	if (pchar.questTemp.WPU.Escort.Bonus != "fail")
	{
		pchar.quest.Escort_fail.over = "yes";//снять прерывание
		pchar.questTemp.WPU.Escort.count = 0;//счетчик эскортов в ноль
		Group_DeleteGroup("Fraht_Attack");
		if (GetCharacterIndex("EscortCaptain_1") != -1 && GetCharacterIndex("EscortCaptain_2") != -1)//оба живы
		{
			RemoveCharacterCompanion(Pchar, characterFromID("EscortCaptain_1"));//удалим компаньонов
			RemoveCharacterCompanion(Pchar, characterFromID("EscortCaptain_2"));
		}
		else
		{
			if (GetCharacterIndex("EscortCaptain_1") == -1) RemoveCharacterCompanion(pchar, characterFromID("EscortCaptain_2"));
			else RemoveCharacterCompanion(pchar, characterFromID("EscortCaptain_1"));
			ChangeCharacterNationReputation(pchar, sti(pchar.questTemp.WPU.Escort.Nation), -5);
		}//если делать через цикл - определяет несуществующего НПС, вот и приходится такой огород городить
	}
	if (CheckAttribute(pchar, "questTemp.WPU.Escort.Bonus"))
	{
		pchar.questTemp.WPU.Escort = "complete";
		pchar.questTemp.WPU.Fraht = "lost";
		
		if (pchar.questTemp.WPU.Escort.Bonus != "fail") AddQuestRecord("Escort", "7");
		else AddQuestRecord("Escort", "16");
		
		pchar.questTemp.WPU.Fraht.count = 0;//счетчик фрахтов в ноль
		ChangeCharacterComplexReputation(pchar,"nobility", -15);
		ChangeCharacterHunterScore(pchar, NationShortName(sti(pchar.questTemp.WPU.Escort.Nation)) + "hunter", 35);
		pchar.questTemp.WPU.Fraht.Nation = pchar.questTemp.WPU.Escort.Nation;
		pchar.questTemp.WPU.Fraht.TargetPortmanID = pchar.questTemp.WPU.Escort.TargetPortmanID;
		DeleteAttribute(pchar, "questTemp.WPU.Escort.TargetPortmanID");
	}
	else
	{
		pchar.questTemp.WPU.Escort = "complete";
		AddQuestRecord("Escort", "5");
		CloseQuestHeader("Escort");
		ChangeCharacterComplexReputation(pchar,"nobility", -10);
		ChangeCharacterNationReputation(pchar, sti(pchar.questTemp.WPU.Escort.Nation), -5);
		DeleteAttribute(pchar, "questTemp.WPU.Escort.TargetPortmanID");
		DeleteAttribute(pchar, "questTemp.WPU.Current.TargetIslandID");
	}
}

void Escort_failed(string qName)//два корабля потоплены - провал
{
	if (CheckAttribute(pchar, "questTemp.WPU.Escort.Bonus"))
	{
		pchar.questTemp.WPU.Escort.Bonus = "fail";
		AddQuestRecord("Escort", "15");
	}
	else
	{
		if (pchar.questTemp.WPU.Escort == "begin") pchar.quest.EscortTime_Over.over = "yes";//снять таймер
		if (pchar.questTemp.WPU.Escort == "late") pchar.quest.EscortTime_FullOver.over = "yes";//снять таймер
		pchar.questTemp.WPU.Escort = "complete";
		AddQuestRecord("Escort", "10");
		CloseQuestHeader("Escort");
		DeleteAttribute(pchar, "questTemp.WPU.Escort.TargetPortmanID");
		DeleteAttribute(pchar, "questTemp.WPU.Current.TargetIslandID");
	}
	pchar.questTemp.WPU.Escort.count = 0;//счетчик эскортов в ноль
	Group_DeleteGroup("Fraht_Attack");
	ChangeCharacterComplexReputation(pchar,"nobility", -10);
	ChangeCharacterNationReputation(pchar, sti(pchar.questTemp.WPU.Escort.Nation), -9);
}
//<--эскорт конец

//--> -------------------------------------задания курьера 2 уровня---------------------------------------------
void PostcureerGopHuntersOnLand(string qName)//охотники в порту прибытия
{
	LAi_group_Delete("EnemyFight");
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);
	for (i=1; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("PostHunters"+i, "citiz_58", "man", "man", sti(PChar.rank) + 10, PIRATE, 1, true, "hunter"));
		SetFantomParamHunter(sld);
		SetModelPirate(sld);
		LAi_SetActorType(sld);
		if (i == 1)
		{
			sld.dialog.Filename = "Quest\Other_quests_NPC.c";
			sld.dialog.currentnode = "PostGopHunters";	
			sld.greeting = "hunter"; 
			ChangeCharacterAddressGroup(sld, pchar.questTemp.WPU.Postcureer.City+"_town", "goto", "goto1");
		}
		else
		{
			LAi_CharacterDisableDialog(sld);
			ChangeCharacterAddressGroup(sld, pchar.questTemp.WPU.Postcureer.City+"_town", "goto", "goto1");
		}
		LAi_ActorDialog(sld, pchar, "", 10, 0); 
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
}

void PostcureerProfHuntersOnLand(string qName)//наемники в порту убытия
{
	LAi_group_Delete("EnemyFight");
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);
	int iRank = sti(PChar.rank) + 10;
	for (i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("PostHunters"+i, "citiz_58", "man", "man", iRank, PIRATE, 1, true, "hunter"));
		FantomMakeCoolFighter(sld, iRank, 50, 50, "blade_06", "pistol6", "bullet", 100);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_SetActorType(sld);
		if (i == 1)
		{
			sld.dialog.Filename = "Quest\Other_quests_NPC.c";
			sld.dialog.currentnode = "PostProfHunters";	
			sld.greeting = "hunter"; 
			ChangeCharacterAddressGroup(sld, pchar.questTemp.WPU.Postcureer.StartCity +"_town", "goto", "goto1");
		}
		else
		{
			LAi_CharacterDisableDialog(sld);
			ChangeCharacterAddressGroup(sld, pchar.questTemp.WPU.Postcureer.StartCity +"_town", "goto", "goto1");
		}
		LAi_ActorDialog(sld, pchar, "", 20, 0); 
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
}

void PostcureerAgent(string qName)//агент
{
	LAi_group_Delete("EnemyFight");
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);
	int iRank = sti(PChar.rank) + 10;
	int iNation = pchar.questTemp.WPU.Postcureer.EnemyNation;
	sld = GetCharacter(NPC_GenerateCharacter("PostAgent", "shipowner_"+(rand(6)+4), "man", "man", iRank, iNation, 2, true, "quest"));
	FantomMakeCoolFighter(sld, iRank, 50, 50, "blade_16", "pistol5", "bullet", 50);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	LAi_SetActorType(sld);
	sld.dialog.Filename = "Quest\Other_quests_NPC.c";
	sld.dialog.currentnode = "PostAgent";	
	sld.greeting = "captain_trader"; 
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.questTemp.WPU.Postcureer.StartCity +"_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_ActorDialog(sld, pchar, "", -1, 0); 
	LAi_group_MoveCharacter(sld, "EnemyFight");
}

void PostcureerAgent_ShipAttack(string qName)//агентский фрегат
{
	int iNation = pchar.questTemp.WPU.Postcureer.EnemyNation;
	Group_FindOrCreateGroup("AgentFrigate");//создать группу
	Group_SetType("AgentFrigate", "war");//тип группы
	sld = GetCharacter(NPC_GenerateCharacter("PostAgentCaptain", "citiz_41", "man", "man", 25, iNation, 1, true, "quest"));//создание кэпа
	FantomMakeCoolSailor(sld, SHIP_FRIGATE, "", CANNON_TYPE_CANNON_LBS24, 50, 50, 50);//создание кораблей
	FantomMakeCoolFighter(sld, 25, 50, 50, "blade_13", "pistol6", "bullet", 50);//создание фантома кэпа
	SetCaptanModelByEncType(sld, "war");
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.DontRansackCaptain = true; 
	sld.AlwaysEnemy = true;
	sld.AnalizeShips = true;
	Group_AddCharacter("AgentFrigate", "PostAgentCaptain");//добавление в группу
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "HardHitter");
	SetCharacterPerk(sld, "GunProfessional");
	// ==> стравливание
	Group_SetGroupCommander("AgentFrigate", "PostAgentCaptain");
	Group_SetTaskAttack("AgentFrigate", PLAYER_GROUP);
	Group_SetPursuitGroup("AgentFrigate", PLAYER_GROUP);
	Group_SetAddress("AgentFrigate", pchar.questTemp.WPU.Postcureer.AgentIslandID, "", "");
	Group_LockTask("AgentFrigate");
	AddQuestRecord("Postcureer", "14");
}
//<-- задания курьера 2 уровня конец

//--> --------------------------------------задания 2 уровня эскорт--------------------------------------------
void EscortArsenalShip_Over(string qName)//не пришли в срок
{
	pchar.questTemp.WPU.Escort.count = sti(pchar.questTemp.WPU.Escort.count)-2;//скрутим счетчик за то, что не пришел
	AddQuestRecord("Escort", "21");
	AddQuestUserData("Escort", "sTargetColony", XI_ConvertString("Colony"+pchar.questTemp.WPU.Escort.City));
	CloseQuestHeader("Escort");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp_0");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.TargetPortmanID");
	pchar.questTemp.WPU.Escort = "complete";
}

void EscortArsenalShipGo_Over(string qName)//не сопровождали, а маялись дурью
{
	pchar.quest.Escort_fail.over = "yes";
	RemoveCharacterCompanion(Pchar, characterFromID("ArsenalShipCaptain"));
	sld = characterFromId("ArsenalShipCaptain");
	sld.lifeday = 0;//на всякий случай
	pchar.questTemp.WPU.Escort.count = sti(pchar.questTemp.WPU.Escort.count)-4;//скрутим счетчик за провал
	AddQuestRecord("Escort", "22");
	AddQuestUserData("Escort", "sSName", pchar.questTemp.WPU.Escort.ShipName);
	CloseQuestHeader("Escort");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUpGo_0");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.TargetPortmanID");
	pchar.questTemp.WPU.Escort = "complete";
}

void EscortArsenalShip_failed(string qName)//потеряли корабль
{
	pchar.quest.EscortArsenalShipGo_Over.over = "yes";
	AddQuestRecord("Escort", "23");
	CloseQuestHeader("Escort");
	pchar.questTemp.WPU.Escort.count = 1;//сильно скрутим счетчик за провал
	ChangeCharacterComplexReputation(pchar,"nobility", -2);
	ChangeCharacterNationReputation(pchar, sti(pchar.questTemp.WPU.Escort.Nation), -3);
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUpGo_0");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.TargetPortmanID");
	pchar.questTemp.WPU.Escort = "complete";
}

void DesIsland_Over(string qName)//общее опоздание по всем приключениям у необитаек
{
	pchar.questTemp.WPU.Escort.count = sti(pchar.questTemp.WPU.Escort.count)-3;//скрутим счетчик за опоздание
	AddQuestRecord("Escort", "26");
	AddQuestUserData("Escort", "sIsland", XI_ConvertString("Colony"+pchar.questTemp.WPU.Current.TargetIslandID));
	CloseQuestHeader("Escort");
	if (CheckAttribute(PChar, "questTemp.WPU.Escort.LevelUp_1WM"))
	{
		pchar.quest.DisasterShip_WM.over = "yes";//снять прерывание
		DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp_1WM");
	}
	if (CheckAttribute(PChar, "questTemp.WPU.Escort.LevelUp_1VSP"))
	{
		pchar.quest.DisasterShip_VSP.over = "yes";//снять прерывание
		Delete_EscortStorm();//уберем шторм
		DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp_1VSP");
	}
	if (CheckAttribute(PChar, "questTemp.WPU.Escort.LevelUp_1S"))
	{
		pchar.quest.DisasterShip_S.over = "yes";//снять прерывание
		DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp_1S");
	}
	pchar.questTemp.WPU.Escort = "complete";
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.TargetPortmanID");
}

void Delete_EscortStorm()//убираем шторм
{
	reload_cur_island_index = FindIsland(pchar.questTemp.WPU.Current.TargetIslandID);
	DeleteAttribute(&Islands[reload_cur_island_index], "alwaysStorm");
	DeleteAttribute(&Islands[reload_cur_island_index], "storm");
	DeleteAttribute(&Islands[reload_cur_island_index], "tornado");
	DeleteAttribute(&Islands[reload_cur_island_index], "QuestlockWeather");
	DeleteAttribute(&Islands[reload_cur_island_index], "MaxSeaHeight");//уберем шторм
}

void CreateDisasterShip_WithoutMasts(string qName)//создаем покоцаный корабль
{
    Group_FindOrCreateGroup("WMShip");
	Group_SetType("WMShip", "trade");
	int iShipType = sti(pchar.questTemp.WPU.Escort.ShipType);
	sTemp = pchar.questTemp.WPU.Escort.ShipName;
	sld = GetCharacter(NPC_GenerateCharacter("WMCaptain", "citiz_41", "man", "man", 10, sti(pchar.nation), -1, true, "quest"));
	FantomMakeSmallSailor(sld, iShipType, sTemp, CANNON_TYPE_CANNON_LBS12, 40, 20, 25, 30, 20);
	SetFantomParamFromRank(sld, 10, true); 
	SetCaptanModelByEncType(sld, "trade");
	sld.Ship.Mode = "trade";
	sld.ship.HP = makeint(sti(sld.ship.HP)/5);
	sld.ship.masts.mast3 = 1;
	SetCrewQuantityOverMax(sld, 50+rand(10));
	Group_AddCharacter("WMShip", "WMCaptain");//добавление в группу
	Group_SetGroupCommander("WMShip", "WMCaptain");
	Group_SetAddress("WMShip", pchar.questTemp.WPU.Current.TargetIslandID, "quest_ships", "quest_ship_1");
	pchar.quest.Escort_Shootfail.win_condition.l1 = "Group_Death";
	pchar.quest.Escort_Shootfail.win_condition.l1.group = "WMShip";
	pchar.quest.Escort_Shootfail.function = "Escort_Shootfail";//для особо упоротых
}

void Escort_Shootfail(string qName)//утопили судно сами
{
	Group_DeleteGroup("WMShip");
	pchar.questTemp.WPU.Escort.count = 0;
	CloseQuestHeader("Escort");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp_1WM");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.TargetPortmanID");
	pchar.questTemp.WPU.Escort = "complete";
	ChangeCharacterComplexReputation(pchar,"nobility", -5);
	ChangeCharacterNationReputation(pchar, sti(pchar.questTemp.WPU.Escort.Nation), -50);
}

void WM_Captain_Over(string qName)//опоздали доставить бревна и тряпки
{
	pchar.quest.Escort_Shootfail.over = "yes"; //снять прерывание
	pchar.questTemp.WPU.Escort.count = sti(pchar.questTemp.WPU.Escort.count)-4;//скрутим счетчик за провал
	AddQuestRecord("Escort", "28");
	AddQuestUserData("Escort", "sSName", pchar.questTemp.WPU.Escort.ShipName);
	CloseQuestHeader("Escort");
	Group_DeleteGroup("WMShip");
	sld = characterFromId("WMCaptain");
	sld.lifiday = 0;
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp_1WM");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.TargetPortmanID");
	pchar.questTemp.WPU.Escort = "complete";
}

void RepairShip_Prepare(string qName)//подготовка к ремонту в бухте
{
	chrDisableReloadToLocation = true;//закрыть локацию
	for (i=1; i<=6; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("WMSailor"+i, "shipowner_"+i, "man", "man", 10, PIRATE, 0, true, "citizen"));
		LAi_SetCitizenType(sld);
		LAi_CharacterDisableDialog(sld);
		ChangeCharacterAddressGroup(sld, pchar.questTemp.WPU.Current.TargetIslandID.Shore, "goto", "goto"+i);
	}
	sld = characterFromId("WMCaptain");
	LAi_SetImmortal(sld, true);//защита от дурака
	ChangeCharacterAddressGroup(sld, pchar.questTemp.WPU.Current.TargetIslandID.Shore, "goto", "goto5");
	LAi_SetActorType(sld);
	sld.dialog.Filename = "Capitans_dialog.c";
	sld.dialog.currentnode = "Repair_start";
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void RepairShip_WithoutMasts(string qName)//крутим время
{
	SetLaunchFrameFormParam("Five hours passed...", "", 0, 6);
    LaunchFrameForm();
    WaitDate("", 0, 0, 5, 0, 10); 
    RecalculateJumpTable();
	DoQuestFunctionDelay("RepairShip_Finished", 6.0);
}

void RepairShip_Finished(string qName)//чинимся и добавляемся в компаньоны
{
	pchar.quest.Escort_Shootfail.over = "yes"; //снять прерывание
	sld = characterFromId("WMCaptain");
	DeleteAttribute(sld, "ship.sails");
    DeleteAttribute(sld, "ship.blots");
    DeleteAttribute(sld, "ship.masts");
	DeleteAttribute(sld, "ship.hulls");
	SetBaseShipData(sld);
	Group_DelCharacter("WMShip", "WMCaptain");//иначе будет клон
	SetCharacterRemovable(sld, false);
	sld.CompanionEnemyEnable = false; //всегда друзья
	SetCompanionIndex(pchar, -1, sti(sld.index));
	sld.loyality = MAX_LOYALITY;
	pchar.quest.Escort_fail.win_condition.l1 = "NPC_Death";//прерывание на потопление сопровождаемого
	pchar.quest.Escort_fail.win_condition.l1.character = "WMCaptain";
	pchar.quest.Escort_fail.function = "DisasterShipWM_failed";
	pchar.questTemp.WPU.Escort = "current";
	ChangeCharacterAddressGroup(sld, pchar.questTemp.WPU.Current.TargetIslandID.Shore, "goto", "goto3");
	LAi_SetActorType(sld);
	sld.dialog.Filename = "Capitans_dialog.c";
	sld.dialog.currentnode = "Repair_end";
	LAi_ActorDialog(sld, pchar, "", -1, 0); 
}

void DisasterShipWM_failed(string qName)//потеряли корабль по пути домой
{
	pchar.quest.DisasterShipWM_Over.over = "yes";
	pchar.quest.DisasterShip_final.over = "yes";
	AddQuestRecord("Escort", "23");
	CloseQuestHeader("Escort");
	pchar.questTemp.WPU.Escort.count = 1;//сильно скрутим счетчик за провал
	ChangeCharacterComplexReputation(pchar,"nobility", -1);
	ChangeCharacterNationReputation(pchar, sti(pchar.questTemp.WPU.Escort.Nation), -2);
	if (CheckAttribute(PChar, "questTemp.WPU.Escort.LevelUp_1WM")) DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp_1WM");
	if (CheckAttribute(PChar, "questTemp.WPU.Escort.LevelUp_1VSP")) DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp_1VSP");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.TargetPortmanID");
	pchar.questTemp.WPU.Escort = "complete";
}

void DisasterShipWM_Over(string qName)//не шли домой, а маялись дурью
{
	pchar.quest.Escort_fail.over = "yes";
	pchar.quest.DisasterShip_final.over = "yes";
	RemoveCharacterCompanion(Pchar, characterFromID("WMCaptain"));
	sld = characterFromId("WMCaptain");
	sld.lifeday = 0;//на всякий случай
	pchar.questTemp.WPU.Escort.count = sti(pchar.questTemp.WPU.Escort.count)-4;//скрутим счетчик за провал
	AddQuestRecord("Escort", "22");
	AddQuestUserData("Escort", "sSName", pchar.questTemp.WPU.Escort.ShipName);
	CloseQuestHeader("Escort");
	if (CheckAttribute(PChar, "questTemp.WPU.Escort.LevelUp_1WM")) DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp_1WM");
	if (CheckAttribute(PChar, "questTemp.WPU.Escort.LevelUp_1VSP")) DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp_1VSP");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.TargetPortmanID");
	pchar.questTemp.WPU.Escort = "complete";
}

void WMShip_final(string qName)//финальный диалог с кэпом по прибытии в порт
{
	chrDisableReloadToLocation = true;
	bDisableFastReload = true;
	GetCharacterPos(pchar, &locx, &locy, &locz);
	sld = characterFromId("WMCaptain");
	LAi_SetImmortal(sld, true);//защита от дурака
	ChangeCharacterAddressGroup(sld, pchar.questTemp.WPU.Escort.StartCity +"_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	sld.dialog.Filename = "Capitans_dialog.c";
	if (CheckAttribute(PChar, "questTemp.WPU.Escort.LevelUp_1WM")) sld.dialog.currentnode = "WMShip_final";
	if (CheckAttribute(PChar, "questTemp.WPU.Escort.LevelUp_1VSP")) sld.dialog.currentnode = "VSPShip_final";
	if (CheckAttribute(PChar, "questTemp.WPU.Escort.LevelUp_1S")) sld.dialog.currentnode = "SShip_final";
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void CreateDisasterShip_VSPirate(string qName)//создаем потерявшийся корабль в бою с пиратами
{
	pchar.quest.DesIsland_Over.over = "yes";//снять таймер
	Island_SetReloadEnableGlobal(pchar.questTemp.WPU.Current.TargetIslandID, false);
	//потерянный корабль
    Group_FindOrCreateGroup("WMShip");
	Group_SetType("WMShip", "trade");
    int iShipType, hcrew;
	iShipType = sti(pchar.questTemp.WPU.Escort.ShipType);
	sTemp = pchar.questTemp.WPU.Escort.ShipName;
	sld = GetCharacter(NPC_GenerateCharacter("WMCaptain", "citiz_41", "man", "man", sti(pchar.rank), sti(pchar.nation), -1, true, "quest"));
	FantomMakeSmallSailor(sld, iShipType, sTemp, CANNON_TYPE_CANNON_LBS12, 40, 20, 25, 30, 20);
	SetFantomParamFromRank(sld, sti(pchar.rank), true); 
	SetCaptanModelByEncType(sld, "trade");
	sld.ship.HP = makeint(sti(sld.ship.HP)/1.3);
	hcrew = GetMaxCrewQuantity(sld);
	SetCrewQuantityOverMax(sld, makeint(hcrew/1.5));
	sld.ShipEnemyDisable = true; //при попадании не враждебен
	sld.Ship.Mode = "trade";
    Group_AddCharacter("WMShip", "WMCaptain");
    Group_SetGroupCommander("WMShip", "WMCaptain");
	Group_SetAddress("WMShip", pchar.questTemp.WPU.Current.TargetIslandID, "quest_ships", "quest_ship_1");
	//пиратусы
    Group_FindOrCreateGroup("Pir_Attack");
	Group_SetType("Pir_Attack", "war");
    for (int i=1; i<=3; i++)
    {
        switch (i)
        {
			case 1:
				iShipType = SHIP_BRIG+rand(1);
				iTemp = CANNON_TYPE_CANNON_LBS16;
            break;
            case 2:
				iShipType = SHIP_BRIGANTINE+rand(1);
				iTemp = CANNON_TYPE_CANNON_LBS16;
            break;
            case 3:
				iShipType = SHIP_SLOOP+rand(1);
				iTemp = CANNON_TYPE_CANNON_LBS12;
            break;
		}
	    sld = GetCharacter(NPC_GenerateCharacter("PirateAttack_"+i, "citiz_"+(i + 40), "man", "man", sti(pchar.rank)+5, PIRATE, 1, true, "quest"));
	    FantomMakeSmallSailor(sld, iShipType, "", iTemp, 50+rand(10), 25+rand(10), 30+rand(10), 35+rand(10), 40+rand(10));
	    SetFantomParamFromRank(sld, sti(pchar.rank)+5, true); 
		sld.ship.HP = makeint(sti(sld.ship.HP)/(1.0+frand(0.5)));//этих тоже покоцаем немного
		hcrew = GetMaxCrewQuantity(sld);
		SetCrewQuantityOverMax(sld, makeint(hcrew/(1.0+frand(0.5))));
	    Group_AddCharacter("Pir_Attack", "PirateAttack_"+i);
    }       
	Group_SetGroupCommander("Pir_Attack", "PirateAttack_1");
	Group_SetAddress("Pir_Attack", pchar.questTemp.WPU.Current.TargetIslandID, "quest_ships", "quest_ship_1");
	Group_SetTaskAttack("Pir_Attack", "WMShip");
	Group_SetTaskAttack("WMShip", "Pir_Attack");//натравим друг на друга
	Group_LockTask("WMShip");
	
	pchar.quest.DisasterShip_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.DisasterShip_AfterBattle.win_condition.l1.group = "Pir_Attack";
	pchar.quest.DisasterShip_AfterBattle.function = "DisasterShip_Win";//победа
	pchar.quest.DisasterShip_Sink.win_condition.l1 = "NPC_Death";
	pchar.quest.DisasterShip_Sink.win_condition.l1.character = "WMCaptain";
	pchar.quest.DisasterShip_Sink.function = "DisasterShip_Sink";//не спасли - утонул
	pchar.quest.DisasterShip_DieHard.win_condition.l1 = "MapEnter";
	pchar.quest.DisasterShip_DieHard.function = "DisasterShip_DieHard";//сбежали
}

void DisasterShip_Win(string qName)//победа
{
    Island_SetReloadEnableGlobal(pchar.questTemp.WPU.Current.TargetIslandID, true);
	pchar.quest.DisasterShip_Sink.over = "yes";
	pchar.quest.DisasterShip_DieHard.over = "yes";
	Group_DeleteGroup("Pir_Attack");
	AddQuestRecord("Escort", "33");
	AddQuestUserData("Escort", "sIsland", XI_ConvertString(pchar.questTemp.WPU.Current.TargetIslandID));
	AddQuestUserData("Escort", "sSName", pchar.questTemp.WPU.Escort.ShipName);
	pchar.questTemp.WPU.Escort = "toCap";
	sld = characterFromId("WMCaptain");
	LAi_SetImmortal(sld, true);
	pchar.quest.DisasterShip_GetOut.win_condition.l1 = "MapEnter";
	pchar.quest.DisasterShip_GetOut.function = "DisasterShip_GetOut";//ушли
}

void DisasterShip_GetOut(string qName)//ушли не поговорив
{
	Delete_EscortStorm();//уберем шторм
	Group_DeleteGroup("WMShip");
	AddQuestRecord("Escort", "33_1");
	CloseQuestHeader("Escort");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.TargetPortmanID");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp_1VSP");
	pchar.questTemp.WPU.Escort = "complete";
}

void DisasterShip_Sink(string qName)//утонул
{
	Delete_EscortStorm();//уберем шторм
    Island_SetReloadEnableGlobal(pchar.questTemp.WPU.Current.TargetIslandID, true);
	pchar.quest.DisasterShip_AfterBattle.over = "yes";
	pchar.quest.DisasterShip_DieHard.over = "yes";
	Group_DeleteGroup("WMShip");
	AddQuestRecord("Escort", "34");
	AddQuestUserData("Escort", "sSName", pchar.questTemp.WPU.Escort.ShipName);
	AddQuestUserData("Escort", "sIsland", XI_ConvertString(pchar.questTemp.WPU.Current.TargetIslandID));
	AddQuestUserData("Escort", "sStartCity", XI_ConvertString("Colony"+pchar.questTemp.WPU.Escort.StartCity));
	pchar.questTemp.WPU.Escort = "sink";
	pchar.questTemp.WPU.Escort.count = sti(pchar.questTemp.WPU.Escort.count)-1;//скрутим счетчик
}

void DisasterShip_DieHard(string qName)//сбежали
{
	Delete_EscortStorm();//уберем шторм
    Island_SetReloadEnableGlobal(pchar.questTemp.WPU.Current.TargetIslandID, true);
	pchar.quest.DisasterShip_AfterBattle.over = "yes";
	pchar.quest.DisasterShip_Sink.over = "yes";
	Group_DeleteGroup("WMShip");
	Group_DeleteGroup("Pir_Attack");
	AddQuestRecord("Escort", "35");
	AddQuestUserData("Escort", "sIsland", XI_ConvertString(pchar.questTemp.WPU.Current.TargetIslandID));
	AddQuestUserData("Escort", "sSName", pchar.questTemp.WPU.Escort.ShipName);
	AddQuestUserData("Escort", "sStartCity", XI_ConvertString("Colony"+pchar.questTemp.WPU.Escort.StartCity+"Gen"));
	CloseQuestHeader("Escort");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.TargetPortmanID");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp_1VSP");
	pchar.questTemp.WPU.Escort = "complete";
	pchar.questTemp.WPU.Escort.count = sti(pchar.questTemp.WPU.Escort.count)-4;//скрутим счетчик за провал
}

void CreateDisasterShip_Crew(string qName)//создаем потерпевших крушение
{
	pchar.quest.DesIsland_Over.over = "yes";//снять таймер
	for (i=1; i<=7; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("WMSailor"+i, "shipowner_"+i, "man", "man", sti(pchar.rank), sti(pchar.nation), -1, true, "citizen"));
		LAi_SetCitizenType(sld);
		LAi_CharacterDisableDialog(sld);
		ChangeCharacterAddressGroup(sld, pchar.questTemp.WPU.Current.TargetIslandID.Shore, "goto", "goto"+i);
	}
	sld = GetCharacter(NPC_GenerateCharacter("WMCaptain", "trader_"+(rand(9)+1), "man", "man", sti(pchar.rank), sti(pchar.nation), -1, true, "quest")); 
	FantomMakeCoolFighter(sld, sti(pchar.rank), 20, 20, "blade_04", "pistol6", "bullet", 30);
	LAi_SetCitizenType(sld);
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, pchar.questTemp.WPU.Current.TargetIslandID.Shore, "goto", "goto1");
	LAi_SetActorType(sld);
	sld.dialog.Filename = "Quest\Other_quests_NPC.c";
	sld.dialog.currentnode = "DisasterCap";
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void DisasterShipCrew_onBoard()//добавим моряков в нашу команду
{
	for (i=1; i<=7; i++)
	{
		sld = characterFromId("WMSailor"+i);	
		sld.lifeday = 0;
		LAi_SetActorType(sld);
		LAi_ActorRunToLocation(sld, "reload", "reload1_boat", "none", "", "", "", 10.0);
	}
	sld = characterFromId("WMCaptain");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "reload1_boat", "none", "", "", "", 10.0);
	AddPassenger(pchar, sld, false);
	SetCharacterRemovable(sld, false);
	SetCrewQuantityOverMax(pchar, sti(PChar.Ship.Crew.Quantity)+55); 
	log_info("55 people has joined your crew");
	if (sti(pchar.ship.Crew.Morale) < 90) pchar.ship.Crew.Morale = sti(pchar.ship.Crew.Morale)+10;//поднимем мораль
	ChangeCrewExp(pchar, "Sailors", 10);
	ChangeCrewExp(pchar, "Cannoners", 10);
	ChangeCrewExp(pchar, "Soldiers", 10);//увеличим умения команде
	pchar.quest.DisasterShip_ShoreAttack.win_condition.l1 = "location";
	pchar.quest.DisasterShip_ShoreAttack.win_condition.l1.location = pchar.questTemp.WPU.Current.TargetIslandID;
	pchar.quest.DisasterShip_ShoreAttack.function = "DisasterShip_AttackInShore";
}

void DisasterShipCrew_IndianAttack(string qName)//атака индеев
{
	chrDisableReloadToLocation = true; //закроем локацию
	//наши
    for (i=1; i<=7; i++)
    {
        sld = characterFromId("WMSailor"+i);
        LAi_SetWarriorType(sld);
		LAi_warrior_DialogEnable(sld, false);
        LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
    }
	sld = characterFromId("WMCaptain");
	LAi_SetWarriorType(sld);
	LAi_warrior_DialogEnable(sld, false);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	//индеи
	for (i=1; i<=7; i++)
    {
		iTemp = sti(pchar.rank) + 10;
		sld = GetCharacter(NPC_GenerateCharacter("DisasterShipIndian_"+i, "Canib_"+(rand(5)+1), "man", "man", iTemp, PIRATE, -1, true, "marginal"));
		LAi_SetWarriorType(sld);
        LAi_group_MoveCharacter(sld, "EnemyFight");
        ChangeCharacterAddressGroup(sld, pchar.questTemp.WPU.Current.TargetIslandID.Shore, "reload", "reload1_back");
    }
		
    LAi_group_SetLookRadius("EnemyFight", 100);
    LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
    LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "DisasterShipIndian_Win");
}

void DisasterShip_AttackInShore(string qName)//атака пиратского корвета
{
	bQuestDisableMapEnter = true;//иначе нет мотивации драться в этой ситуации
	Group_FindOrCreateGroup("AttackInShore");
	Group_SetType("AttackInShore", "pirate");
	iTemp = sti(pchar.rank)+10;
	if (iTemp > 40) iTemp = 40;
	sld = GetCharacter(NPC_GenerateCharacter("AttackInShoreCaptain", "citiz_"+(rand(9)+41), "man", "man", iTemp, PIRATE, -1, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_CORVETTE, "", CANNON_TYPE_CULVERINE_LBS18, 50, 50, 50);
	FantomMakeCoolFighter(sld, iTemp, 50, 50, "blade_10", "pistol6", "bullet", 50);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.DontRansackCaptain = true; 
	sld.AlwaysEnemy = true;
	sld.AnalizeShips = true;
	Group_AddCharacter("AttackInShore", "AttackInShoreCaptain");
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "HardHitter");
	SetCharacterPerk(sld, "GunProfessional");
	
	Group_SetGroupCommander("AttackInShore", "AttackInShoreCaptain");
	Group_SetTaskAttack("AttackInShore", PLAYER_GROUP);
	Group_SetPursuitGroup("AttackInShore", PLAYER_GROUP);
	Group_SetAddress("AttackInShore", pchar.questTemp.WPU.Current.TargetIslandID, "", "");
	Group_LockTask("AttackInShore");
	
	pchar.quest.DisasterShipAttack_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.DisasterShipAttack_AfterBattle.win_condition.l1.group = "AttackInShore";
	pchar.quest.DisasterShipAttack_AfterBattle.function = "AttackInShore_Win";//победа
}

void AttackInShore_Win(string qName)//потопили пирата
{
	bQuestDisableMapEnter = false;
	Group_DeleteGroup("AttackInShore");
	AddQuestRecord("Escort", "39");
	AddQuestUserData("Escort", "sIsland", XI_ConvertString(pchar.questTemp.WPU.Current.TargetIslandID));
	AddQuestUserData("Escort", "sSName", pchar.questTemp.WPU.Escort.ShipName);
	pchar.questTemp.WPU.Escort = "win";
	pchar.quest.DisasterShip_final.win_condition.l1 = "location";
	pchar.quest.DisasterShip_final.win_condition.l1.location = pchar.questTemp.WPU.Escort.StartCity +"_town";
	pchar.quest.DisasterShip_final.function = "WMShip_final";
}

void CreateCaravanNearIsland(string qName)//защита торговцев от пиратов
{
	Island_SetReloadEnableGlobal(pchar.questTemp.WPU.Current.TargetIslandID, false);
	pchar.quest.CaravanNearIsland_Over.over = "yes";//снять таймер
	//караван торговцев
    Group_FindOrCreateGroup("CaravanShip");
	Group_SetType("CaravanShip", "trade");
    int iShipType, hcrew;
	for (int i=1; i<=3; i++)
    {
        switch (i)
        {
			case 1:
				iShipType = SHIP_PINNACE;
				iTemp = CANNON_TYPE_CANNON_LBS16;
            break;
            case 2:
				iShipType = SHIP_FLEUT + drand(2);
				iTemp = CANNON_TYPE_CANNON_LBS12;
            break;
            case 3:
				iShipType = SHIP_SCHOONER + drand(3);
				iTemp = CANNON_TYPE_CULVERINE_LBS8;
            break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("CaravanCaptain_"+i, "trader_"+(rand(9)+1), "man", "man", sti(pchar.rank), sti(pchar.nation), 3, true, "quest"));
		FantomMakeSmallSailor(sld, iShipType, "", iTemp, 50, 25, 25, 30, 25);
		SetFantomParamFromRank(sld, sti(pchar.rank), true); 
		sld.ship.HP = makeint(sti(sld.ship.HP)/(1.0+frand(0.5)));
		hcrew = GetMaxCrewQuantity(sld);
		SetCrewQuantityOverMax(sld, makeint(hcrew/(1.0+frand(0.5))));//попортим немного
		sld.ShipEnemyDisable = true; //при попадании не враждебен
		sld.AlwaysFriend = true; // mitrokosta fix aggro
		sld.Ship.Mode = "trade";
	    Group_AddCharacter("CaravanShip", "CaravanCaptain_"+i);
	}
    Group_SetGroupCommander("CaravanShip", "CaravanCaptain_1");
	Group_SetAddress("CaravanShip", pchar.questTemp.WPU.Current.TargetIslandID, "quest_ships", "quest_ship_6");
	//пиратусы
    Group_FindOrCreateGroup("Pir_Attack");
	Group_SetType("Pir_Attack", "war");
    for (i=1; i<=4; i++)
    {
        switch (i)
        {
			case 1:
				iShipType = SHIP_CORVETTE + drand(1);
				iTemp = CANNON_TYPE_CULVERINE_LBS18;
            break;
			case 2:
				iShipType = SHIP_BRIG + crand(1);
				iTemp = CANNON_TYPE_CANNON_LBS16;
            break;
            case 3:
				iShipType = SHIP_BRIGANTINE + drand(1);
				iTemp = CANNON_TYPE_CANNON_LBS16;
            break;
            case 4:
				iShipType = SHIP_SLOOP + crand(1);
				iTemp = CANNON_TYPE_CULVERINE_LBS8;
            break;
		}
	    sld = GetCharacter(NPC_GenerateCharacter("PirateAttack_"+i, "citiz_"+(i+40), "man", "man", sti(pchar.rank)+10, PIRATE, 3, true, "quest"));
	    FantomMakeSmallSailor(sld, iShipType, "", iTemp, 50+rand(10), 25+rand(10), 30+rand(10), 35+rand(10), 40+rand(10));
	    SetFantomParamFromRank(sld, sti(pchar.rank)+10, true); 
		sld.ship.HP = makeint(sti(sld.ship.HP)/(1.0+frand(0.5)));//этих тоже попортим
		hcrew = GetMaxCrewQuantity(sld);
		SetCrewQuantityOverMax(sld, makeint(hcrew/(1.0+frand(0.5))));
	    Group_AddCharacter("Pir_Attack", "PirateAttack_"+i);
    }       
	Group_SetGroupCommander("Pir_Attack", "PirateAttack_1");
	Group_SetAddress("Pir_Attack", pchar.questTemp.WPU.Current.TargetIslandID, "quest_ships", "quest_ship_6");
	Group_SetTaskAttack("Pir_Attack", "CaravanShip");
	Group_SetTaskAttack("CaravanShip", "Pir_Attack");//натравим друг на друга
	Group_LockTask("CaravanShip");
	
	pchar.quest.CaravanShip_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.CaravanShip_AfterBattle.win_condition.l1.group = "Pir_Attack";
	pchar.quest.CaravanShip_AfterBattle.function = "CaravanShip_Win";//победа
	pchar.quest.CaravanShip_Sink.win_condition.l1 = "Group_Death";
	pchar.quest.CaravanShip_Sink.win_condition.l1.group = "CaravanShip";
	pchar.quest.CaravanShip_Sink.function = "CaravanShip_Sink";//поражение
	pchar.quest.CaravanShip_DieHard.win_condition.l1 = "MapEnter";
	pchar.quest.CaravanShip_DieHard.function = "CaravanShip_Fail";//сбежали
}

void CaravanShip_Win(string qName)//пиратские корабли потоплены
{
    Island_SetReloadEnableGlobal(pchar.questTemp.WPU.Current.TargetIslandID, true);
	Group_DeleteGroup("Pir_Attack");
	pchar.quest.CaravanShip_DieHard.over = "yes";
	pchar.quest.CaravanShip_Sink.over = "yes";
	pchar.questTemp.WPU.Escort = "win";
	//считаем не потопленных торговцев
	iTemp = 0;
    for (i=1; i<=3; i++)
    {
		sld = characterFromId("CaravanCaptain_"+i);
		if (LAi_GetCharacterHP(sld) > 0)
		{
			iTemp++;
			LAi_SetImmortal(sld, true);//для особо хитрых
		}
    }
	if (iTemp == 3) AddQuestRecord("Escort", "43");
	if (iTemp == 2) AddQuestRecord("Escort", "44");
	if (iTemp == 1) AddQuestRecord("Escort", "45");
	pchar.questTemp.WPU.Escort.LevelUp_2.Qty = iTemp;
}

void CaravanShip_Sink(string qName)//поражение
{
    Island_SetReloadEnableGlobal(pchar.questTemp.WPU.Current.TargetIslandID, true);
	Group_DeleteGroup("CaravanShip");
	pchar.quest.CaravanShip_AfterBattle.over = "yes";
	pchar.quest.CaravanShip_DieHard.over = "yes";
	AddQuestRecord("Escort", "46");
	CloseQuestHeader("Escort");
	pchar.questTemp.WPU.Escort = "complete";
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.TargetPortmanID");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp_2");
	pchar.questTemp.WPU.Escort.count = sti(pchar.questTemp.WPU.Escort.count)-2;//скрутим счетчик
}

void CaravanShip_Fail(string qName)//сбежали
{
    Island_SetReloadEnableGlobal(pchar.questTemp.WPU.Current.TargetIslandID, true);
	Group_DeleteGroup("Pir_Attack");
	Group_DeleteGroup("CaravanShip");
	pchar.quest.CaravanShip_AfterBattle.over = "yes";
	pchar.quest.CaravanShip_Sink.over = "yes";
	AddQuestRecord("Escort", "47");
	CloseQuestHeader("Escort");
	pchar.questTemp.WPU.Escort = "complete";
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.TargetPortmanID");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp_2");
	ChangeCharacterComplexReputation(pchar,"nobility", -3);
	ChangeCharacterNationReputation(pchar, sti(pchar.questTemp.WPU.Escort.Nation), -1);
	ChangeOfficersLoyality("bad_all", 3);
	pchar.questTemp.WPU.Escort.count = sti(pchar.questTemp.WPU.Escort.count)-4;//скрутим счетчик за провал
}

void CaravanNearIsland_Over(string qName)//засиделись на берегу
{
	pchar.questTemp.WPU.Escort.count = sti(pchar.questTemp.WPU.Escort.count)-4;//скрутим счетчик за провал
	AddQuestRecord("Escort", "42");
	CloseQuestHeader("Escort");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.TargetPortmanID");
	DeleteAttribute(pchar, "questTemp.WPU.Escort.LevelUp_2");
	pchar.questTemp.WPU.Escort = "complete";
}
//<-- ТТГ конец

// --> Jason---------------------------------Бесчестный конкурент------------------------------------------
void ShadowtraderTimeFort_Over(string qName)//просрочили отдать письмо коменданту
{
	DeleteAttribute(pchar, "questTemp.Shadowtrader.Fort");
	RemoveItems(PChar, "letter_1", 1);
	pchar.questTemp.Shadowtrader = "true";
	AddQuestRecord("Shadowtrader", "4");
	CloseQuestHeader("Shadowtrader");
	ChangeCharacterComplexReputation(pchar,"nobility", -1);
}

void ShadowtraderTimeSmugglers_Over(string qName)//просрочили прийти на стрелку
{
	pchar.quest.Shadowtrader_SMG.over = "yes"; //снять прерывание
	DeleteAttribute(pchar, "questTemp.Shadowtrader.SeekTrader");
	pchar.questTemp.Shadowtrader = "true";
	AddQuestRecord("Shadowtrader", "6");
	CloseQuestHeader("Shadowtrader");
	ChangeCharacterComplexReputation(pchar,"nobility", -1);
}

void ShadowAgent(string qName)//активация агента Паскаля
{
	pchar.quest.ShadowtraderTimeSmugglers_Over.over = "yes";//снять таймер
	sld = characterFromID("ShadowAgent_1");   
	LAi_SetActorType(sld);
	sld.dialog.Filename = "Quest\LineMiniQuests\ShadowTrader.c";
	sld.dialog.currentnode = "ShadowAgent";	
	sld.greeting = "marginal"; 
	LAi_ActorDialog(sld, pchar, "", -1, 0); 
	pchar.questTemp.Shadowtrader.ClearHouse = "true"; // 240912
}

void ShadowTrader_final(string qName)//выход из коммона на улицу
{
	chrDisableReloadToLocation = false;//открыть локацию
	DoQuestReloadToLocation(pchar.questTemp.Shadowtrader.City + "_town", "quest", "quest2", "");
	DeleteAttribute(pchar, "questTemp.Shadowtrader.ClearHouse"); // 240912
}
// <-- Бесчестный конкурент конец

// --> Jason---------------------------------Дефицитный товар---------------------------------------------
void Wine_Exchange(string qName)
{
	sld = characterFromId(pchar.questTemp.Wine.id);
	sld.lifeday = 4;//на всякий случай
	LAi_SetStayType(sld);
	ChangeCharacterAddressGroup(sld, pchar.questTemp.Wine.City +"_fort", "goto", "goto53");
	sld.dialog.FileName = "Quest\LineMiniQuests\Wine.c";
	sld.dialog.currentnode = "Wine_fort";
	sld.greeting = "soldier";
}

void Soldier_wait(string qName)
{
	pchar.questTemp.Wine.fail = "true";
	AddQuestRecord("Wine", "2");
	CloseQuestHeader("Wine");
}

void Wine_wait(string qName)
{
	DeleteAttribute(pchar, "questTemp.Wine.wait");
}
// <--Дефицитный товар конец

// --> Jason -----------------------------Сомнительное предложение------------------------------------------------
void Contraoffer_Over(string qName)//просрочили доставить контрабанду
{
	AddQuestRecord("Contraoffer", "2");
	CloseQuestHeader("Contraoffer");
	DeleteAttribute(pchar, "GenQuest.Contraoffer");
}

void Contraoffer_Patrol() //нагрянул патруль
{	
	chrDisableReloadToLocation = true;
	LAi_group_Delete("EnemyFight"); 
	iTemp = sti(pchar.rank) + rand(MOD_SKILL_ENEMY_RATE); //это ранг от сложности
	int iNation = sti(pchar.GenQuest.Contraoffer.Trader.Nation);
	for (i=1; i<=3; i++)
    {
        sld = GetCharacter(NPC_GenerateCharacter("Contraoffer_patrol"+i, "sold_" + NationShortName(iNation) + "_" + (rand(1) + 1), "man", "man", iTemp, iNation, 0, true, "soldier"));
		SetFantomParamFromRank(sld, iTemp, true);         
		LAi_SetWarriorType(sld); 
		LAi_warrior_DialogEnable(sld, false);
        LAi_group_MoveCharacter(sld, "EnemyFight");
        ChangeCharacterAddressGroup(sld, pchar.location, "reload",  "reload1");
    }
    sld = GetCharacter(NPC_GenerateCharacter("Contraoffer_Officer", "off_" + NationShortName(iNation) + "_" + (rand(1) + 1), "man", "man", iTemp, iNation, 0, true, "soldier"));
	SetFantomParamFromRank(sld, iTemp, true); 
	sld.Dialog.Filename = "Quest\Other_Quests_NPC.c"; 
	sld.dialog.currentnode = "Contraoffer_patrol"; 
	sld.greeting = "soldier_arest";
    LAi_SetActorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	ChangeCharacterAddressGroup(sld, pchar.location, "reload",  "reload1");
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Trader_free(string qName)//освобождаем диалог торговцу и затираем атрибуты
{
	DeleteAttribute(pchar, "GenQuest.Contraoffer.Trader");
}
// <-- Сомнительное предложение конец

// --> Jason -----------------------------------Охотник на корабли-----------------------------------------
void Findship_Over(string qName)//просрочили найти корабль на верфь
{
	AddQuestRecord("Findship", "2");
	CloseQuestHeader("Findship");
	DeleteAttribute(pchar, "GenQuest.Findship.Shipyarder");
}
// <-- Охотник на корабли конец

// --> Jason-------------------------------------Неудачливый вор-------------------------------------------
void Device_Over(string qName)//просрочили отыскать вора
{
	AddQuestRecord("Device", "2");
	CloseQuestHeader("Device");
	DeleteAttribute(pchar, "GenQuest.Device.Shipyarder");
}
// <-- Неудачливый вор конец

/////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Jason --> -------------------------------Заносчивый аристократ---------------------------------------------
/////////////////////////////////////////////////////////////////////////////////////////////////////////////
void Badboy_duelstart(string qName)
{
	pchar.quest.BadboyPlace.win_condition.l1 = "Location";
	pchar.quest.BadboyPlace.win_condition.l1.location = pchar.GenQuest.Badboy.Brothel.City + "_ExitTown";
	pchar.quest.BadboyPlace.function = "BadboyPlace";
}

void Badboy_duelOver(string qName)//не пришли на стрелку
{
	pchar.quest.BadboyPlace.over = "yes";
	LAi_LocationDisableOfficersGen(pchar.GenQuest.Badboy.Brothel.City + "_ExitTown", false);//офицеров пускать
	locations[FindLocation(pchar.GenQuest.Badboy.Brothel.City + "_ExitTown")].DisableEncounters = false; //энкаутеры откроем
	sld = characterFromId("Badboy");
	sld.lifeDay = 0;
}

void BadboyPlace(string qName)
{
	pchar.quest.Badboy_duelOver.over = "yes";
	LAi_group_Delete("EnemyFight"); 
    sld = characterFromID("Badboy");
	if (CheckAttribute(sld, "CityType"))
	{
		DeleteAttribute(sld, "City"); 
		DeleteAttribute(sld, "CityType");
	}
	ChangeCharacterAddressGroup(sld, pchar.GenQuest.Badboy.Brothel.City + "_ExitTown", "goto", "goto1");
	LAi_SetActorType(pchar);
    LAi_SetActorType(sld);
    LAi_ActorTurnToCharacter(sld, pchar);
    SetActorDialogAny2Pchar(sld.id, "", 0.0, 0.0);
	LAi_ActorFollow(pchar, sld, "ActorDialog_Any2Pchar", -1);
}

void Badboy_friends(string qName)
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);
	chrDisableReloadToLocation = true;
	LAi_group_Delete("EnemyFight"); 
	iTemp = sti(pchar.rank) + MOD_SKILL_ENEMY_RATE;
	for (i=1; i<=4; i++)
    {
		if (i == 1)
		{
			sld = characterFromID("Badboy");
			if (CheckAttribute(sld, "CityType"))
			{
				DeleteAttribute(sld, "City");
				DeleteAttribute(sld, "CityType");
			}
			TakeNItems(sld, "jewelry5", rand(10)); 
			TakeNItems(sld, "jewelry3", rand(10)); 
			TakeNItems(sld, "jewelry1", rand(10)); 
			sld.money = 24560;
			sld.SaveItemsForDead = true; // сохранять на трупе вещи
			sld.DontClearDead = true; // не убирать труп через 200с
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("BadboyFriends_"+i, "citiz_"+(i + 40), "man", "man", iTemp, PIRATE, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iTemp, 40, 40, "blade_10", "pistol2", "bullet", 50);
			LAi_CharacterDisableDialog(sld);
		}
		LAi_SetActorType(sld);
		GetCharacterPos(pchar, &locx, &locy, &locz);
		ChangeCharacterAddressGroup(sld, pchar.GenQuest.Badboy.Brothel.City + "_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
		LAi_group_MoveCharacter(sld, "EnemyFight");
		LAi_ActorDialog(sld, pchar, "", -1, 0); 
    }
}
// <-- Заносчивый аристократ конец

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
// --> Jason -----------------------------------Место под солнцем---------------------------------------------
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
void GetSunplaceShore()//выбор бухты
{
	pchar.GenQuest.Sunplace.Trader.Island = GetRandomIslandId();
	while(pchar.GenQuest.Sunplace.Trader.Island == Islands[GetCharacterCurrentIsland(pchar)].id)
	{
		pchar.GenQuest.Sunplace.Trader.Island = GetRandomIslandId();
	}
	pchar.GenQuest.Sunplace.Trader.Shore = GetIslandRandomShoreId(pchar.GenQuest.Sunplace.Trader.Island);
	while(pchar.GenQuest.Sunplace.Trader.Shore == "")
	{
		pchar.GenQuest.Sunplace.Trader.Island = GetRandomIslandId();
		pchar.GenQuest.Sunplace.Trader.Shore = GetIslandRandomShoreId(pchar.GenQuest.Sunplace.Trader.Island);
		if (!isLocationFreeForQuests(pchar.GenQuest.Sunplace.Trader.Island)) pchar.GenQuest.Sunplace.Trader.Shore = "";
	}
}

void Sunplace_Over(string qName)//опоздали до места встречи
{
	pchar.quest.Sunplace_Trader.over = "yes";
	AddQuestRecord("Sunplace", "2");
	AddQuestUserData("Sunplace", "sType", GetStrSmallRegister(XI_ConvertString(GetBaseShipParamFromType(sti(pchar.GenQuest.Sunplace.Trader.ShipType), "Name"))));
	AddQuestUserData("Sunplace", "sSName", pchar.GenQuest.Sunplace.Trader.ShipName);
	AddQuestUserData("Sunplace", "sCity", XI_ConvertString("Colony"+pchar.GenQuest.Sunplace.Trader.CityT+"Voc")); // belamour gen
	pchar.GenQuest.Sunplace.Trader = "continue";
	SetFunctionTimerCondition("SunplaceContinue_Over", 0, 0, 10, false);
}

void Sunplace_CreateTraderShip(string qName)//создание торгового корабля(-ей)
{
	pchar.quest.Sunplace_Over.over = "yes";
	int i, iNation, iShipType, iCannonType, iGoods, iSpace;
	iNation = sti(pchar.GenQuest.Sunplace.Trader.Nation);
	iShipType = sti(pchar.GenQuest.Sunplace.Trader.Shiptype);
	if (sti(pchar.rank) < 5) iCannonType = CANNON_TYPE_CULVERINE_LBS8;
	else iCannonType = CANNON_TYPE_CANNON_LBS16;
	iTemp = sti(pchar.rank)+2+rand(MOD_SKILL_ENEMY_RATE);
	sTemp = pchar.GenQuest.Sunplace.Trader.ShipName;
	Group_FindOrCreateGroup("SunplaceTrader");//создать группу
	Group_SetType("SunplaceTrader", "trade");//тип группы
	if (CheckAttribute(pchar, "GenQuest.Sunplace.Bonus"))
	{
		for (i=1; i<=4; i++)
		{
			if (i == 3) sTemp = pchar.GenQuest.Sunplace.Trader.ShipName;
			else sTemp = "";
			switch (i)
			{
				case 1: 
					iGoods = GOOD_MAHOGANY;
					iSpace = 500+rand(200);
					iShipType = SHIP_GALEON_H;
				break;
				case 2: 
					iGoods = GOOD_CHOCOLATE;
					iSpace = 1000+rand(200);
					iShipType = SHIP_GALEON_L;
				break;
				case 3: 
					iGoods = GOOD_EBONY;
					iSpace = 400+rand(100);
					iShipType = SHIP_PINNACE;
				break;
				case 4:
					iGoods = GOOD_COFFEE;
					iSpace = 500+rand(100);
					iShipType = SHIP_CORVETTE;
				break;
			}
			sld = GetCharacter(NPC_GenerateCharacter("SunplaceCaptain_"+i, "citiz_41", "man", "man", iTemp, iNation, 1, true, "quest"));
			FantomMakeSmallSailor(sld, iShipType, sTemp, CANNON_TYPE_CANNON_LBS20, 50+rand(10), 25+rand(10), 25+rand(10), 30+rand(10), 30+rand(10));
			SetFantomParamFromRank(sld, iTemp, true);
			SetCaptanModelByEncType(sld, "trade");
			Fantom_SetCharacterGoods(sld, iGoods, iSpace, 1);
			Group_AddCharacter("SunplaceTrader", "SunplaceCaptain_"+i);
			DeleteAttribute(sld, "SaveItemsForDead");
			DeleteAttribute(sld, "DontClearDead");
			sld.DontRansackCaptain = true; 
			sld.AlwaysEnemy = true;
			sld.AnalizeShips = true;
			sld.Ship.Mode = "trade";
			SetCharacterPerk(sld, "Tireless");
			SetCharacterPerk(sld, "HardHitter");
		}
		AddQuestRecord("Sunplace", "14");
		AddQuestUserData("Sunplace", "sType", GetStrSmallRegister(XI_ConvertString(GetBaseShipParamFromType(sti(pchar.GenQuest.Sunplace.Trader.ShipType), "Name"))));
		AddQuestUserData("Sunplace", "sGoods", GetGoodsNameAlt(sti(pchar.GenQuest.Sunplace.Trader.Goods)));
		AddQuestUserData("Sunplace", "sSName", pchar.GenQuest.Sunplace.Trader.ShipName);
	}
	else
	{
		sld = GetCharacter(NPC_GenerateCharacter("SunplaceCaptain_1", "citiz_41", "man", "man", iTemp, iNation, 1, true, "quest"));
		FantomMakeSmallSailor(sld, iShipType, sTemp, iCannonType, 30+rand(10), 15+rand(10), 15+rand(10), 20+rand(10), 20+rand(10));
		SetFantomParamFromRank(sld, iTemp, true); 
		SetCaptanModelByEncType(sld, "trade");
		iGoods = sti(pchar.GenQuest.Sunplace.Trader.Goods);
		iSpace = GetCharacterFreeSpace(sld, iGoods);
		iSpace = makeint(iSpace/2 + rand(iSpace/2));
		Fantom_SetCharacterGoods(sld, iGoods, iSpace, 1);
		Group_AddCharacter("SunplaceTrader", "SunplaceCaptain_1");
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.DontRansackCaptain = true; 
		sld.AlwaysEnemy = true;
		sld.AnalizeShips = true;
		SetCharacterPerk(sld, "Tireless");
		SetCharacterPerk(sld, "HardHitter");
		AddQuestRecord("Sunplace", "3");
		AddQuestUserData("Sunplace", "sType", GetStrSmallRegister(XI_ConvertString(GetBaseShipParamFromType(sti(pchar.GenQuest.Sunplace.Trader.ShipType), "Name"))));
		AddQuestUserData("Sunplace", "sSName", pchar.GenQuest.Sunplace.Trader.ShipName);
	}

	Group_SetGroupCommander("SunplaceTrader", "SunplaceCaptain_1");
	Group_SetTaskAttack("SunplaceTrader", PLAYER_GROUP);
	Group_SetAddress("SunplaceTrader", pchar.GenQuest.Sunplace.Trader.Island, "quest_ships", "Quest_ship_6");
	Group_LockTask("SunplaceTrader");
	
    pchar.quest.Sunplace_AfterBattle.win_condition.l1 = "Character_Capture";
	pchar.quest.Sunplace_AfterBattle.win_condition.l1.character = "SunplaceCaptain_1";
	pchar.quest.Sunplace_AfterBattle.function = "Sunplace_AfterBattle";
	pchar.quest.Sunplace_AfterBattle_1.win_condition.l1 = "Character_sink";
	pchar.quest.Sunplace_AfterBattle_1.win_condition.l1.character = "SunplaceCaptain_1";
	pchar.quest.Sunplace_AfterBattle_1.function = "Sunplace_AfterBattle";
	pchar.quest.Sunplace_DieHard.win_condition.l1 = "MapEnter";
    pchar.quest.Sunplace_DieHard.function = "Sunplace_DieHard";
}

void Sunplace_AfterBattle(string qName)//реакция на победу
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.Sunplace_AfterBattle.over = "yes";
	pchar.quest.Sunplace_AfterBattle_1.over = "yes";
    pchar.quest.Sunplace_DieHard.over = "yes";
	Group_DeleteGroup("SunplaceTrader");
    pchar.quest.Sunplace_DieHard.over = "yes";
	AddQuestRecord("Sunplace", "4");
	pchar.GenQuest.Sunplace.Trader = "complete";
	AddComplexSeaExpToScill(50, 50, 50, 50, 50, 50, 0);
}

void Sunplace_DieHard(string qName)//реакция на поражение
{
    pchar.quest.Sunplace_AfterBattle.over = "yes";
	pchar.quest.Sunplace_AfterBattle_1.over = "yes";
	if (CheckAttribute(pchar, "GenQuest.Sunplace.Bonus") && GetCharacterIndex("SunplaceCaptain_3") == -1)
	{
		AddQuestRecord("Sunplace", "4");
		AddQuestUserData("Sunplace", "sType", GetStrSmallRegister(XI_ConvertString(GetBaseShipParamFromType(sti(pchar.GenQuest.Sunplace.Trader.ShipType), "Name"))));
		pchar.GenQuest.Sunplace.Trader = "complete";
	}
	else
	{
		AddQuestRecord("Sunplace", "5");
		AddQuestUserData("Sunplace", "sType", GetStrSmallRegister(XI_ConvertString(GetBaseShipParamFromType(sti(pchar.GenQuest.Sunplace.Trader.ShipType), "Name"))));
		AddQuestUserData("Sunplace", "sSName", pchar.GenQuest.Sunplace.Trader.ShipName);
		AddQuestUserData("Sunplace", "sCity", XI_ConvertString("Colony"+pchar.GenQuest.Sunplace.Trader.CityT+"Voc")); // belamour gen
		pchar.GenQuest.Sunplace.Trader = "continue";
		SetFunctionTimerCondition("SunplaceContinue_Over", 0, 0, 10, false);
	}
	Group_DeleteGroup("SunplaceTrader");
}

void SunplaceContinue_Over(string qName)//провалили все и окончательно по срокам
{
	pchar.quest.Sunplace_Store.over = "yes";
	AddQuestRecord("Sunplace", "11");
	CloseQuestHeader("Sunplace");
	DeleteAttribute(pchar, "GenQuest.Sunplace.Trader");
}

void Sunplace_CreateTrader(string qName)//создание конкурента в магазине
{
	ref chr = characterFromId(pchar.GenQuest.Sunplace.Trader.CityT + "_trader");
	sld = GetCharacter(NPC_GenerateCharacter("SunplaceTrader", "trader_7", "man", "man", 10, sti(chr.nation), -1, true, "quest"));
	FantomMakeCoolFighter(sld, 10, 10, 10, "", "", "bullet", 10);
	sld.name = pchar.GenQuest.Sunplace.Trader.Enemyname;
	sld.lastname = "";
	sld.dialog.FileName = "Quest\Other_quests_NPC.c";
	sld.dialog.currentnode = "Sunplace_Store";
	sld.money = 25650;
	sld.SaveItemsForDead = true; // сохранять на трупе вещи
	sld.DontClearDead = true; // не убирать труп через 200с
	LAi_SetCitizenType(sld);
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, pchar.GenQuest.Sunplace.Trader.CityT + "_store", "goto", "goto1");
}
	
void Kill_SunplaceTrader(string qName)//проверка убийства конкурента
{
	if (GetCharacterIndex("SunplaceTrader") == -1)
	{
		AddQuestRecord("Sunplace", "8");
		AddQuestUserData("Sunplace", "sName", pchar.GenQuest.Sunplace.Trader.Enemyname);
		pchar.GenQuest.Sunplace.Trader = "complete_murder";
	}
	else
	{
		sld = CharacterFromID("SunplaceTrader");
		sld.lifeday = 0;
		AddQuestRecord("Sunplace", "9");
		CloseQuestHeader("Sunplace");
		DeleteAttribute(pchar, "GenQuest.Sunplace.Trader");
	}
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.GenQuest.Sunplace.Trader.CityT + "_store")], true);
}

void Sunplace_CreateTraderLugger(string qName)//создание люггера конкурента
{
	pchar.quest.SunplaceContinue_Over.over = "yes";
	int iNation;
	iNation = sti(pchar.GenQuest.Sunplace.Trader.EnemyNation);
	iTemp = sti(pchar.rank)+2+rand(MOD_SKILL_ENEMY_RATE);
	Group_FindOrCreateGroup("SunplaceLugger");//создать группу
	Group_SetType("SunplaceLugger", "trade");//тип группы
	sld = GetCharacter(NPC_GenerateCharacter("Sunplace_Trader", "trader_7", "man", "man", iTemp, iNation, -1, true, "quest"));
	FantomMakeSmallSailor(sld, SHIP_LUGGER, "", CANNON_TYPE_CANNON_LBS6, 30+rand(10), 15+rand(10), 15+rand(10), 20+rand(10), 20+rand(10));
	SetFantomParamFromRank(sld, iTemp, true); 
	sld.name = pchar.GenQuest.Sunplace.Trader.Enemyname;
	sld.lastname = "";
	sld.SaveItemsForDead = true; // сохранять на трупе вещи
	sld.DontClearDead = true; // не убирать труп через 200с
	sld.DontRansackCaptain = true; 
	sld.AnalizeShips = true;
	sld.Ship.Mode = "trade";
	sld.money = 25650;
	Group_AddCharacter("SunplaceLugger", "Sunplace_Trader");
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "HardHitter");

	Group_SetGroupCommander("SunplaceLugger", "Sunplace_Trader");
	Group_SetTaskRunaway("SunplaceLugger", PLAYER_GROUP);
	Group_SetAddress("SunplaceLugger", pchar.GenQuest.Sunplace.Trader.IslandID, "quest_ships", "Quest_ship_6");
	Group_LockTask("SunplaceLugger");
	
    pchar.quest.SunplaceLugger_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.SunplaceLugger_AfterBattle.win_condition.l1.group = "SunplaceLugger";
	pchar.quest.SunplaceLugger_AfterBattle.function = "SunplaceLugger_AfterBattle";
	pchar.quest.SunplaceLugger_DieHard.win_condition.l1 = "MapEnter";
    pchar.quest.SunplaceLugger_DieHard.function = "SunplaceLugger_DieHard";
}

void SunplaceLugger_AfterBattle(string qName)//реакция на победу
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Group_DeleteGroup("SunplaceLugger");
    pchar.quest.SunplaceLugger_DieHard.over = "yes";
	AddQuestRecord("Sunplace", "8");
	AddQuestUserData("Sunplace", "sName", pchar.GenQuest.Sunplace.Trader.Enemyname);
	pchar.GenQuest.Sunplace.Trader = "complete_murder";
	AddComplexSeaExpToScill(50, 50, 50, 50, 50, 50, 0);
}

void SunplaceLugger_DieHard(string qName)//реакция на поражение
{
	Group_DeleteGroup("SunplaceLugger");
    pchar.quest.SunplaceLugger_AfterBattle.over = "yes";
	AddQuestRecord("Sunplace", "10");
	CloseQuestHeader("Sunplace");
	DeleteAttribute(pchar, "GenQuest.Sunplace.Trader");
}
// <-- Место под солнцем

///////////////////////////////////////////////////////////////////////////////////////////////////////////////
// --> Jason --------------------------------Вождь краснокожих------------------------------------------------
///////////////////////////////////////////////////////////////////////////////////////////////////////////////
void RedChieftain_Prepare(string qName)//подготовка инициализации квестодателя
{
	pchar.questTemp.RedChieftain.StartCity = FindFriendCityToMC(true);//город, в котором квестодатель подойдет
	while (pchar.questTemp.RedChieftain.StartCity == "") pchar.questTemp.RedChieftain.StartCity = FindFriendCityToMC(true); // patch-9
	pchar.quest.Red_Chieftain_1.win_condition.l1 = "location";
	pchar.quest.Red_Chieftain_1.win_condition.l1.location = pchar.questTemp.RedChieftain.StartCity+"_town";
	pchar.quest.Red_Chieftain_1.function = "RedChieftain_Begin";
	log_testinfo(pchar.questTemp.RedChieftain.StartCity);
}

void RedChieftain_Begin(string qName)//инициализация квестодателя
{
	chrDisableReloadToLocation = true;
	sld = GetCharacter(NPC_GenerateCharacter("RedChieftain", "Canib", "man", "man", 20, sti(pchar.nation), -1, false, "native"));
	sld.name = "chieftain";
	sld.lastname = "Kanauri";
    sld.Dialog.Filename = "Quest\LineMiniQuests\RedChieftain.c";
	sld.dialog.currentnode = "RedChieftain";
    FantomMakeCoolFighter(sld, 20, 50, 50, "blade_01", "", "", 50);
	LAi_SetImmortal(sld, true);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, pchar.questTemp.RedChieftain.StartCity+"_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void RedChieftainDelete(string qName)//не пришли за 30 дней
{
	sld = CharacterFromID("RedChieftain");
	sld.lifeday = 0;
	DeleteAttribute(pchar, "questTemp.RedChieftain");
	ChangeIndianRelation(-1.0);
}

void RedChieftain_CreateShooner(string qName)//создание кораблей и лодок
{
	pchar.quest.RedChieftainOver.over = "yes";//снять таймер
	Group_FindOrCreateGroup("RedChieftain_Shooner");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 5 + 2*sti(pchar.rank);
	int iNation = sti(pchar.questTemp.RedChieftain.AttackNation);
	int iType = SHIP_SCHOONER_W;
	if (MOD_SKILL_ENEMY_RATE < 6) iType = SHIP_SCHOONER;
	for (int i=1; i<=2; i++)
	{
		if (i == 2 && MOD_SKILL_ENEMY_RATE < 10) iType = SHIP_SCHOONER;
		sld = GetCharacter(NPC_GenerateCharacter("ShoonerRC_Cap_"+i, "off_"+NationShortName(iNation)+"_"+(rand(1)+1), "man", "man", iRank, iNation, 0, true, "quest"));
		FantomMakeSmallSailor(sld, iType, "", CANNON_TYPE_CANNON_LBS12, 50, iScl, iScl, iScl, iScl);
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_10", "pistol1", "bullet", 50);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		Group_AddCharacter("RedChieftain_Shooner", "ShoonerRC_Cap_"+i);
		sld.AlwaysEnemy = true;
		sld.Coastal_Captain = true;
		sld.AnalizeShips = true;
		sld.DontRansackCaptain = true;
    }
	Group_SetGroupCommander("RedChieftain_Shooner", "ShoonerRC_Cap_1");
	if (pchar.questTemp.RedChieftain.Island == "Cumana") Group_SetAddress("RedChieftain_Shooner", pchar.questTemp.RedChieftain.Island, "ships", "l1");
	else Group_SetAddress("RedChieftain_Shooner", pchar.questTemp.RedChieftain.Island, "quest_ships", "quest_ship_7");
	bool bOk = (sti(RealShips[sti(pchar.ship.type)].basetype) == SHIP_TARTANE) || (sti(RealShips[sti(pchar.ship.type)].basetype) == SHIP_WAR_TARTANE) || (sti(RealShips[sti(pchar.ship.type)].basetype) == SHIP_CAREERLUGGER) || (sti(RealShips[sti(pchar.ship.type)].basetype) == SHIP_LUGGER) || (sti(RealShips[sti(pchar.ship.type)].basetype) == SHIP_SLOOP);
	if(bOk && GetCompanionQuantity(pchar) < 2)
	{//все гуд - ставим тартаны
		AddQuestRecord("RedChieftain", "3");
		Island_SetReloadEnableGlobal(pchar.questTemp.RedChieftain.Island, false);
		Group_FindOrCreateGroup("RedChieftain_Tartane");
		for (i=1; i<=6; i++)
		{
			sld = GetCharacter(NPC_GenerateCharacter("TartaneRC_Cap_"+i, "mercen_25", "man", "man", 5, PIRATE, 0, true, "native"));
			sld.name = "indians";
			sld.lastname = "of Caiman tribe";
			FantomMakeSmallSailor(sld, SHIP_TARTANE, "", CANNON_TYPE_NONECANNON, 30, 10, 10, 10, 10);
			SetCrewQuantityOverMax(sld, 12);
			Group_AddCharacter("RedChieftain_Tartane", "TartaneRC_Cap_"+i);
			sld.AlwaysFriend = true;
			sld.ShipEnemyDisable = true;
			sld.AnalizeShips = true;
		}
		Group_SetGroupCommander("RedChieftain_Tartane", "TartaneRC_Cap_1");
		Group_SetTaskAttack("RedChieftain_Shooner", "RedChieftain_Tartane");
		Group_SetTaskRunaway("RedChieftain_Tartane", "RedChieftain_Shooner");
		if (pchar.questTemp.RedChieftain.Island == "Cumana") Group_SetAddress("RedChieftain_Tartane", pchar.questTemp.RedChieftain.Island, "ships", "l1");
		else Group_SetAddress("RedChieftain_Tartane", pchar.questTemp.RedChieftain.Island, "quest_ships", "quest_ship_7");
		Group_LockTask("RedChieftain_Tartane");
		Group_LockTask("RedChieftain_Shooner");
		pchar.quest.Red_Chieftain_AfterBattle.win_condition.l1 = "Group_Death";
		pchar.quest.Red_Chieftain_AfterBattle.win_condition.l1.group = "RedChieftain_Shooner";
		pchar.quest.Red_Chieftain_AfterBattle.function = "RedChieftain_AfterBattle";
		pchar.quest.Red_Chieftain_DieHard.win_condition.l1 = "MapEnter";
		pchar.quest.Red_Chieftain_DieHard.function = "RedChieftain_DieHard";
		pchar.quest.Red_Chieftain_Fail.win_condition.l1 = "Group_Death";
		pchar.quest.Red_Chieftain_Fail.win_condition.l1.group = "RedChieftain_Tartane";
		pchar.quest.Red_Chieftain_Fail.function = "RedChieftain_Fail";
	}
	else
	{
		AddQuestRecord("RedChieftain", "4");
		CloseQuestHeader("RedChieftain");
		Group_SetTaskAttack("RedChieftain_Shooner", PLAYER_GROUP);
		Group_LockTask("RedChieftain_Shooner");
		pchar.quest.Red_Chieftain_end.win_condition.l1 = "Location_Type";
		pchar.quest.Red_Chieftain_end.win_condition.l1.location_type = "town";
		pchar.quest.Red_Chieftain_end.function = "RemoveRedChieftain";
		DeleteAttribute(pchar, "questTemp.RedChieftain");
	}
}

void RedChieftain_AfterBattle(string qName)//победили
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Island_SetReloadEnableGlobal(pchar.questTemp.RedChieftain.Island, true);
	locations[FindLocation(pchar.questTemp.RedChieftain.Shore)].DisableEncounters = true; //энкаутеры закрыть
	bQuestDisableMapEnter = true;//на карту нельзя
	pchar.quest.Red_Chieftain_Fail.over = "yes";
	pchar.quest.Red_Chieftain_DieHard.over = "yes";
	AddQuestRecord("RedChieftain", "5");
	pchar.quest.Red_Chieftain_3.win_condition.l1 = "location";
	pchar.quest.Red_Chieftain_3.win_condition.l1.location = pchar.questTemp.RedChieftain.Shore;
	pchar.quest.Red_Chieftain_3.function = "RedChieftain_Shore";
	AddComplexSeaExpToScill(100, 100, 100, 100, 100, 100, 0);
	AddCharacterExpToSkill(pchar, "Sneak", 300);//скрытность
	AddCharacterExpToSkill(pchar, "Fortune", 200);//везение
	ChangeOfficersLoyality("good_all", 1);
	ChangeCharacterComplexReputation(pchar, "authority", 3);
	//считаем не потопленные тартаны
	iTemp = 0;
    for (i=1; i<=6; i++)
    {
		sld = characterFromId("TartaneRC_Cap_"+i);
		if (LAi_GetCharacterHP(sld) > 0)
		{
			LAi_SetImmortal(sld, true);//защита от дурака
			iTemp++;
		}
    }
	pchar.questTemp.RedChieftain.Tartane = iTemp;
}

void RedChieftain_DieHard(string qName)//сбежали
{
	Island_SetReloadEnableGlobal(pchar.questTemp.RedChieftain.Island, true);
	pchar.quest.Red_Chieftain_AfterBattle.over = "yes";
	pchar.quest.Red_Chieftain_Fail.over = "yes";
	Group_DeleteGroup("RedChieftain_Shooner");
	Group_DeleteGroup("RedChieftain_Tartane");
	pchar.quest.Red_Chieftain_end.win_condition.l1 = "Location_Type";
	pchar.quest.Red_Chieftain_end.win_condition.l1.location_type = "town";
	pchar.quest.Red_Chieftain_end.function = "RemoveRedChieftain";
	AddQuestRecord("RedChieftain", "6");
	CloseQuestHeader("RedChieftain");
	DeleteAttribute(pchar, "questTemp.RedChieftain");
	ChangeOfficersLoyality("bad_all", 1);
	ChangeIndianRelation(-3.0);
}

void RedChieftain_Fail(string qName)//потеряли все тартаны
{	
	Island_SetReloadEnableGlobal(pchar.questTemp.RedChieftain.Island, true);
	pchar.quest.Red_Chieftain_AfterBattle.over = "yes";
	pchar.quest.Red_Chieftain_DieHard.over = "yes";
	pchar.quest.Red_Chieftain_end.win_condition.l1 = "Location_Type";
	pchar.quest.Red_Chieftain_end.win_condition.l1.location_type = "town";
	pchar.quest.Red_Chieftain_end.function = "RemoveRedChieftain";
	AddQuestRecord("RedChieftain", "7");
	CloseQuestHeader("RedChieftain");
	DeleteAttribute(pchar, "questTemp.RedChieftain");
	ChangeOfficersLoyality("bad_all", 1);
	ChangeIndianRelation(-5.0);
}

void RedChieftainOver(string qName)//просрочили
{
	pchar.quest.Red_Chieftain_2.over = "yes"; //снять прерывание
	if (IsEntity(&worldMap) || bSeaActive) 
	{
		pchar.quest.Red_Chieftain_end.win_condition.l1 = "Location_Type";
		pchar.quest.Red_Chieftain_end.win_condition.l1.location_type = "town";
		pchar.quest.Red_Chieftain_end.function = "RemoveRedChieftain";
	}
	else
	{
		sld = CharacterFromID("RedChieftain");
		RemovePassenger(Pchar, sld);
		sld.lifeday = 0;
		log_info("The chieftain has left your vessel!");
		PlaySound("interface\notebook.wav");
	}
	AddQuestRecord("RedChieftain", "2");
	CloseQuestHeader("RedChieftain");
	DeleteAttribute(pchar, "questTemp.RedChieftain");
	ChangeOfficersLoyality("bad_all", 1);
	ChangeIndianRelation(-2.0);
}

void RemoveRedChieftain(string qName)//удалить вождя
{
	sld = CharacterFromID("RedChieftain");
	RemovePassenger(Pchar, sld);
	sld.lifeday = 0;
	log_info("The chieftain has left your vessel!");
	PlaySound("interface\notebook.wav");
}

void RedChieftain_Shore(string qName)//высадка на сушу и бой
{
	bQuestDisableMapEnter = false;//на карту можно
	chrDisableReloadToLocation = true;//закрыть локацию
	int iCrew = GetCrewQuantity(pchar);//получим число команды
	int n = makeint(iCrew/10);
	if (n < 1) n = 1;
	pchar.questTemp.RedChieftain.OurCrew = n;//запомним
	int iRank = sti(pchar.rank)+makeint(MOD_SKILL_ENEMY_RATE/2);
	int iScl = 5 + 2*sti(pchar.rank);
	int iNation = sti(pchar.questTemp.RedChieftain.AttackNation);
	//ставим наших бойцов согласно числу команды
	for (i=1; i<=n; i++)
	{
		if (i == 3)
		{
			sld = GetCharacter(NPC_GenerateCharacter("RSOur_crew_"+i, "mush_ctz_5", "man", "mushketer", iRank, sti(pchar.nation), 0, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("RSOur_crew_"+i, "citiz_"+(rand(9)+31), "man", "man", iRank, sti(pchar.nation), 0, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_10", "pistol1", "bullet", iScl*2);
		}
		ChangeCharacterAddressGroup(sld, pchar.questTemp.RedChieftain.Shore, "goto", "goto1");
		LAi_SetWarriorType(sld);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	//ставим вражеских солдат
	for (i=1; i<=6; i++)
	{
		if (i == 1 || i == 2)
		{
			sld = GetCharacter(NPC_GenerateCharacter("RSEnemy_crew_"+i, "mush_"+NationShortName(iNation)+"_" + i, "man", "mushketer", iRank+2, iNation, 0, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank+2, iScl+5, iScl+5, "", "mushket1", "cartridge", iScl*2);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("RSEnemy_crew_"+i, "sold_"+NationShortName(iNation)+"_"+(rand(1)+7), "man", "man", iRank, iNation, 0, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_10", "pistol1", "bullet", iScl*2);
		}
		ChangeCharacterAddressGroup(sld, pchar.questTemp.RedChieftain.Shore, "reload", "reload1_back");
		LAi_SetWarriorType(sld);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	//ставим офицера
	sld = GetCharacter(NPC_GenerateCharacter("RSEnemy_off", "off_"+NationShortName(iNation)+"_"+(rand(1)+1), "man", "man", iRank+5, iNation, 0, false, "soldier"));
	FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_10", "pistol3", "grapeshot", iScl*2);
	ChangeCharacterAddressGroup(sld, pchar.questTemp.RedChieftain.Shore, "reload", "reload1_back");
	LAi_SetWarriorType(sld);
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	LAi_group_MoveCharacter(sld, "EnemyFight");
	TakeNItems(sld, "jewelry52", rand(150)+50);
	TakeNItems(sld, "jewelry53", rand(175)+175);
	//стравливаем группы
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "RedChieftain_AfterFight");
	LAi_SetFightMode(pchar, true);
}
// <-- Вождь краснокожих

////////////////////////////////////////////////////////////////////////////////////////////////////////////
//--> Jason ----------------------------------Ложный след---------------------------------------------------
////////////////////////////////////////////////////////////////////////////////////////////////////////////
void FalseTrace_Prepare(string qName)//подготовка инициализации квестодателя
{
	pchar.questTemp.FalseTrace.StartCity = FindFriendCityToMC(true);//город, в котором квестодатель подойдет
	while (pchar.questTemp.FalseTrace.StartCity == "") pchar.questTemp.FalseTrace.StartCity = FindFriendCityToMC(true); // patch-9
	pchar.quest.False_Trace_1.win_condition.l1 = "location";
	pchar.quest.False_Trace_1.win_condition.l1.location = pchar.questTemp.FalseTrace.StartCity+"_town";
	pchar.quest.False_Trace_1.function = "FalseTrace_Begin";
	log_testinfo(pchar.questTemp.FalseTrace.StartCity);
}

void FalseTrace_Begin(string qName)//инициализация квестодателя
{
	if (sti(pchar.rank) < 15)
	{
		DoQuestFunctionDelay("FalseTrace_Prepare", 2.0);
		return; // may-16
	}
	chrDisableReloadToLocation = true;
	bDisableFastReload = true;
	sld = GetCharacter(NPC_GenerateCharacter("Mugger", "AdamRainer", "man", "man", 20, sti(pchar.nation), -1, false, "quest"));
	sld.name = "Adam";
	sld.lastname = "Rayner";
    sld.Dialog.Filename = "Quest\LineMiniQuests\FalseTrace.c";
	sld.dialog.currentnode = "FalseTrace";
	sld.greeting = "town_pirate";
    sld.loyality = 25;
	sld.rank 	= 20;
    sld.reputation = 10;
	sld.alignment = "bad";
	LAi_SetHP(sld, 100+MOD_SKILL_ENEMY_RATE*35, 100+MOD_SKILL_ENEMY_RATE*35);
	GiveItem2Character(sld, "blade_04");
	TakeNItems(sld, "potion2", MOD_SKILL_ENEMY_RATE/2);
	sld.equip.blade = "blade_04";
	GiveItem2Character(sld, "pistol5");
	EquipCharacterbyItem(sld, "pistol5");
    TakeNItems(sld, "bullet", 50);
	AddItems(sld, "gunpowder", 50);
	LAi_SetCharacterUseBullet(sld, "bullet");
	sld.cirassId = Items_FindItemIdx("cirass1"); // 280313
    sld.HoldEquip = true; // не отдавать саблю и пистоль
	SetSPECIAL(sld, 7, 4, 8, 4, 3, 10, 8);
	SetSelfSkill(sld, 75, 95, 75, 80, 75);
	SetShipSkill(sld, 50, 10, 8, 9, 12, 11, 15, 12, 90);
	SetCharacterPerk(sld, "BasicDefense");
	SetCharacterPerk(sld, "AdvancedDefense");
	SetCharacterPerk(sld, "CriticalHit");
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "HardHitter");
	SetCharacterPerk(sld, "Sliding");
	SetCharacterPerk(sld, "BladeDancer");
	SetCharacterPerk(sld, "SwordplayProfessional");
	SetCharacterPerk(sld, "Gunman");
	SetCharacterPerk(sld, "GunProfessional");
	sld.HalfImmortal = true;//полубессмертен
	sld.CompanionDisable = true;//не может быть компаньоном
	GetCharacterPos(pchar, &locx, &locy, &locz);
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, pchar.questTemp.FalseTrace.StartCity+"_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void FalseTraceGaleonOver(string qName)//просрочили или не нашли
{
	pchar.quest.False_Trace_AfterBattle.over = "yes";
	Group_DeleteGroup("Sea_FalseTrace1");
	if (IsEntity(&worldMap) || bSeaActive) 
	{
		pchar.quest.False_Trace_end.win_condition.l1 = "Location_Type";
		pchar.quest.False_Trace_end.win_condition.l1.location_type = "town";
		pchar.quest.False_Trace_end.function = "RemoveFalseTrace";
		sld = characterFromId("Mugger");
		DeleteAttribute(sld, "HalfImmortal");
		RemovePassenger(Pchar, sld);
		AddPassenger(pchar, sld, false);
		SetCharacterRemovable(sld, false);
	}
	else
	{
		sld = CharacterFromID("Mugger");
		sld.lifeday = 0;
		sld.dialog.currentnode = "FalseTrace_Remove1";
		RemovePassenger(Pchar, sld);
		GetCharacterPos(pchar, &locx, &locy, &locz);
		LAi_SetActorType(sld);
		ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
	AddQuestRecord("FalseTrace", "2");
	CloseQuestHeader("FalseTrace");
	DeleteAttribute(pchar, "questTemp.FalseTrace");
	ChangeOfficersLoyality("bad_all", 1);
}

void RemoveFalseTrace(string qName)//удалить Адама
{
	sld = CharacterFromID("Mugger");
	sld.lifeday = 0;
	sld.dialog.currentnode = "FalseTrace_Remove1";
	RemovePassenger(Pchar, sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void CreateFalseTraceGaleonOnMap(string qName)//энкаунтер галеона на карте
{
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 10 + 2*sti(pchar.rank);
    string sGroup = "Sea_FalseTrace1";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	// Captain Beltrop, 14.02.2021, правка нации капитана галеона - несовпадение атрибутов
	sld = GetCharacter(NPC_GenerateCharacter("FalseTraceCap", "q_eng_Cap_1", "man", "man", iRank, sti(pchar.questTemp.FalseTrace.Mation), sti(pchar.questTemp.FalseTrace.DayQty), true, "quest"));
	FantomMakeSmallSailor(sld, SHIP_GALEON_L, pchar.questTemp.FalseTrace.ShipName, CANNON_TYPE_CANNON_LBS16, 70, iScl, iScl, iScl, iScl);
	SetCaptanModelByEncType(sld, "war");
	SetRandomNameToCharacter(sld);
	LAi_SetHP(sld, 50+MOD_SKILL_ENEMY_RATE*30, 50+MOD_SKILL_ENEMY_RATE*30);
	sld.AlwaysEnemy = true;
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Coastal_Captain = true; //не ссорить нации
	sld.Ship.Crew.Morale = MOD_SKILL_ENEMY_RATE*10-10;
	sld.Ship.Crew.Exp.Sailors = MOD_SKILL_ENEMY_RATE*10-10;
	sld.Ship.Crew.Exp.Cannoners = MOD_SKILL_ENEMY_RATE*10-10;
	sld.Ship.Crew.Exp.Soldiers = MOD_SKILL_ENEMY_RATE*10-10;
	if (MOD_SKILL_ENEMY_RATE > 4) TakeNItems(sld, "potion2", 2);
	SetCharacterPerk(sld, "HullDamageUp");
	SetCharacterPerk(sld, "SailsDamageUp");
	SetCharacterPerk(sld, "CrewDamageUp");
	SetCharacterPerk(sld, "CriticalShoot");
	SetCharacterPerk(sld, "MusketsShoot");
	SetCharacterPerk(sld, "AdvancedBattleState");
	SetCharacterPerk(sld, "ShipDefenseProfessional");
	SetCharacterPerk(sld, "LongRangeShoot");
	SetCharacterPerk(sld, "ShipTurnRateUp");
	SetCharacterPerk(sld, "ShipSpeedUp");
	DeleteAttribute(sld, "SinkTenPercent");
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.mapEnc.type = "war";
	sld.mapEnc.worldMapShip = "quest_ship";
    sld.mapEnc.Name = "galleon '"+pchar.questTemp.FalseTrace.ShipName+"'";
    Group_AddCharacter(sGroup, "FalseTraceCap");
	Group_SetGroupCommander(sGroup, "FalseTraceCap");
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
	Map_CreateTrader("Cartahena", pchar.questTemp.FalseTrace.TargetShore, "FalseTraceCap", sti(pchar.questTemp.FalseTrace.DayQty));//запуск энкаунтера
	
	pchar.quest.False_Trace_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.False_Trace_AfterBattle.win_condition.l1.group = sGroup;
	pchar.quest.False_Trace_AfterBattle.function = "FalseTrace_AfterBattle";
}

void FalseTrace_AfterBattle(string qName)//утопили галеон
{
	pchar.quest.FalseTraceGaleonOver.over = "yes";
	Group_DeleteGroup("Sea_FalseTrace1");
	Log_testInfo("ГАЛЕОН УТОНУЛ!");
	pchar.quest.False_Trace_end.win_condition.l1 = "Location_Type";
	pchar.quest.False_Trace_end.win_condition.l1.location_type = "town";
	pchar.quest.False_Trace_end.function = "RemoveFalseTrace";
	AddQuestRecord("FalseTrace", "3");
	CloseQuestHeader("FalseTrace");
	DeleteAttribute(pchar, "questTemp.FalseTrace");
	ChangeOfficersLoyality("bad_all", 1);
}

void SetCheckForSolly()//на золото Солли
{
	pchar.quest.False_Trace_3.win_condition.l1 = "location";
	pchar.quest.False_Trace_3.win_condition.l1.location = pchar.questTemp.FalseTrace.QuestCity+"_town";
	pchar.quest.False_Trace_3.function = "RemoveFalseTraceBoth";
	pchar.questTemp.FalseTrace.SollyBonanza = "true";
}

void SetCheckForKillAdam()//на тайник Адама
{
	pchar.quest.False_Trace_3.win_condition.l1 = "location";
	pchar.quest.False_Trace_3.win_condition.l1.location = pchar.questTemp.FalseTrace.QuestShore;
	pchar.quest.False_Trace_3.function = "RemoveFalseTraceBoth";
	pchar.questTemp.FalseTrace.KillAdam = "true";
	LAi_LocationDisableOfficersGen(pchar.questTemp.FalseTrace.QuestShore, true);//офицеров не пускать
	locations[FindLocation(pchar.questTemp.FalseTrace.QuestShore)].DisableEncounters = true; //энкаутеры закрыть
}

void SetCheckForGoldShip()//на корабль с золотом
{
	pchar.quest.False_Trace_3.win_condition.l1 = "location";
	pchar.quest.False_Trace_3.win_condition.l1.location = pchar.questTemp.FalseTrace.TargetShore;
	pchar.quest.False_Trace_3.function = "FalseTrace_GoldShip";
	pchar.questTemp.FalseTrace = "CatchAdam";
	locations[FindLocation(pchar.questTemp.FalseTrace.TargetShore)].DisableEncounters = true; //энкаутеры закрыть
}

void FalseTraceSollyOver(string qName)//просрочили за наводкой на Солли
{
	pchar.quest.False_Trace_3.over = "yes"; //снять прерывание
	if (IsEntity(&worldMap) || bSeaActive) 
	{
		if (CheckAttribute(pchar, "questTemp.FalseTrace.KillAdam")) 
		{
			AddQuestRecord("FalseTrace", "12");
			AddQuestUserData("FalseTrace", "sCity", XI_ConvertString("Colony"+pchar.questTemp.FalseTrace.QuestCity));
			sld = CharacterFromID("Mugger");
			RemovePassenger(Pchar, sld);
			sld.lifeday = 0;
			sld = CharacterFromID("FalseTraceWife");
			RemovePassenger(Pchar, sld);
			sld.lifeday = 0;
			log_info("Adam Rayner has stolen a rowboat and escaped with his wife!");
			PlaySound("interface\notebook.wav");
		}
		else
		{
			pchar.quest.False_Trace_end.win_condition.l1 = "Location_Type";
			pchar.quest.False_Trace_end.win_condition.l1.location_type = "town";
			pchar.quest.False_Trace_end.function = "RemoveFalseTraceBoth";
			AddQuestRecord("FalseTrace", "13");
			AddQuestUserData("FalseTrace", "sCity", XI_ConvertString("Colony"+pchar.questTemp.FalseTrace.QuestCity));
		}
	}
	else
	{
		AddQuestRecord("FalseTrace", "13");
		AddQuestUserData("FalseTrace", "sCity", XI_ConvertString("Colony"+pchar.questTemp.FalseTrace.QuestCity));
		sld = CharacterFromID("Mugger");
		sld.lifeday = 0;
		sld.dialog.currentnode = "FalseTrace_Remove2";
		RemovePassenger(Pchar, sld);
		GetCharacterPos(pchar, &locx, &locy, &locz);
		LAi_SetActorType(sld);
		ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
		LAi_ActorDialog(sld, pchar, "", -1, 0);
		ref chr = CharacterFromID("FalseTraceWife");
		chr.lifeday = 0;
		RemovePassenger(Pchar, chr);
		LAi_SetActorType(chr);
		ChangeCharacterAddressGroup(chr, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
		LAi_ActorFollow(chr, sld, "", -1);
	}
	CloseQuestHeader("FalseTrace");
	DeleteAttribute(pchar, "questTemp.FalseTrace");
}

void RemoveFalseTraceBoth(string qName)//удалить Адама и Катерину+наводка на сокровища Солли+убить Адама
{
	chrDisableReloadToLocation = true;
	bDisableFastReload = true;
	sld = CharacterFromID("Mugger");
	LAi_SetImmortal(sld, true);
	sld.lifeday = 0;
	if (CheckAttribute(pchar, "questTemp.FalseTrace.SollyBonanza")) sld.dialog.currentnode = "FalseTrace_23";
	else 
	{
		if (CheckAttribute(pchar, "questTemp.FalseTrace.KillAdam")) sld.dialog.currentnode = "FalseTrace_24";
		else sld.dialog.currentnode = "FalseTrace_Remove2";
	}
	RemovePassenger(Pchar, sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	ref chr = CharacterFromID("FalseTraceWife");
	LAi_SetImmortal(chr, true);
	RemovePassenger(Pchar, chr);
	LAi_SetActorType(chr);
	ChangeCharacterAddressGroup(chr, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_ActorFollow(chr, sld, "", -1);
}

void FalseTraceBonanzaOver(string qName)//опоздали
{
	pchar.quest.False_Trace_4.over = "yes"; //снять прерывание
	AddQuestRecord("FalseTrace", "15");
	CloseQuestHeader("FalseTrace");
	DeleteAttribute(pchar, "questTemp.FalseTrace");
	ChangeOfficersLoyality("bad_all", 1);
}

void FalseTrace_SollyBonanza(string qName)//высадка на берег за сокровищами
{
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретим драться
	pchar.quest.FalseTraceBonanzaOver.over = "yes"; //снять прерывание
	//заполним сундук
	pchar.GenQuestBox.Shore55 = true;
	pchar.GenQuestBox.Shore55.box2.items.jewelry5 = 2061;//золото
	pchar.GenQuestBox.Shore55.box2.items.jewelry6 = 889;//серебро
	pchar.GenQuestBox.Shore55.box2.items.jewelry10 = 25;//платина
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE/2;
	int iScl = 10 + 2*sti(pchar.rank);
	//ставим наших бойцов
	for (i=1; i<=10; i++)
	{
		if (i == 3)
		{
		sld = GetCharacter(NPC_GenerateCharacter("FTOur_crew_"+i, "mush_ctz_5", "man", "mushketer", iRank, sti(pchar.nation), 0, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
		}
		else
		{
		sld = GetCharacter(NPC_GenerateCharacter("FTOur_crew_"+i, "citiz_"+(i+30), "man", "man", iRank, sti(pchar.nation), 0, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_10", "pistol1", "bullet", iScl*2);
		}
		ChangeCharacterAddressGroup(sld, "Shore55", "goto", "goto1");
		LAi_SetActorType(sld);
		LAi_ActorFollow(sld, pchar, "", -1);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	//ставим бандитов Солли
	for (i=1; i<=6; i++)
	{
		if (i == 1)
		{
		sld = GetCharacter(NPC_GenerateCharacter("FTEnemy_crew_"+i, "mush_ctz_"+(rand(2)+7), "man", "mushketer", iRank, PIRATE, 0, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
		}
		else
		{
		sld = GetCharacter(NPC_GenerateCharacter("FTEnemy_crew_"+i, "citiz_"+(i+40), "man", "man", iRank, PIRATE, 0, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_04", "pistol1", "bullet", iScl*2);
		}
		ChangeCharacterAddressGroup(sld, "Shore55", "goto", "goto4");
		LAi_SetActorType(sld);
		sld.Dialog.Filename = "Quest\LineMiniQuests\FalseTrace.c";
		if (i == 2) sld.dialog.currentnode = "FalseTrace_Solly";
		else LAi_CharacterDisableDialog(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
	}
}

void FalseTrace_SollyBonanzaAdd()//еще выскочили из засады
{
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE/2;
	int iScl = 10 + 2*sti(pchar.rank);
	for (i=1; i<=8; i++)
	{
		if (i == 2)
		{
		sld = GetCharacter(NPC_GenerateCharacter("FTAEnemy_crew_"+i, "mush_ctz_"+(rand(2)+7), "man", "mushketer", iRank, PIRATE, 0, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl+5, "", "mushket1", "cartridge", iScl*2);
		}
		else
		{
		sld = GetCharacter(NPC_GenerateCharacter("FTAEnemy_crew_"+i, "citiz_"+(i+40), "man", "man", iRank, PIRATE, 0, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_04", "pistol1", "bullet", iScl*2);
		}
		ChangeCharacterAddressGroup(sld, "Shore55", "goto", "goto2");
		LAi_SetWarriorType(sld);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
}

void FalseTrace_SollyShip(string qName)//появился Солли
{
	Island_SetReloadEnableGlobal("SantaCatalina", false);//на остров нельзя
	Group_FindOrCreateGroup("Solly_brig");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 20 + 2*sti(pchar.rank);
	if (sti(pchar.rank < 15)) iTemp = SHIP_BRIG;
	else iTemp = SHIP_CORVETTE;
	sld = GetCharacter(NPC_GenerateCharacter("Solly", "mercen_20", "man", "man", iRank, PIRATE, 0, true, "quest"));
	sld.name = "Cockeyed";
	sld.lastname = "Solly";
	FantomMakeSmallSailor(sld, iTemp, "", CANNON_TYPE_CULVERINE_LBS18, 100, iScl, iScl, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, 40, 40, "blade_04", "pistol1", "bullet", 100);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	Group_AddCharacter("Solly_brig", "Solly");
	sld.AlwaysEnemy = true;
	sld.AnalizeShips = true;
	Group_SetGroupCommander("Solly_brig", "Solly");
	Group_SetAddress("Solly_brig", "SantaCatalina", "quest_ships", "quest_ship_9");
	Group_SetTaskAttack("Solly_brig", PLAYER_GROUP);
	Group_LockTask("Solly_brig");
	pchar.quest.FalseTrace_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.FalseTrace_AfterBattle.win_condition.l1.group = "Solly_brig";
	pchar.quest.FalseTrace_AfterBattle.function = "SollyShip_AfterBattle";
	pchar.quest.FalseTrace_DieHard.win_condition.l1 = "MapEnter";
	pchar.quest.FalseTrace_DieHard.function = "SollyShip_DieHard";
}

void SollyShip_AfterBattle(string qName)//победили
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.FalseTrace_DieHard.over = "yes";
	Group_DeleteGroup("Solly_brig");
	Island_SetReloadEnableGlobal("SantaCatalina", true);
	AddQuestRecord("FalseTrace", "17");
	CloseQuestHeader("FalseTrace");
	DeleteAttribute(pchar, "questTemp.FalseTrace");
	SetFunctionTimerCondition("FalseTrace_DeleteBox", 0, 0, 1, false);
	AddComplexSeaExpToScill(200, 150, 150, 150, 200, 200, 0);
	ChangeOfficersLoyality("good_all", 1);
}

void SollyShip_DieHard(string qName)//сбежали
{
	pchar.GenQuestBox.Shore55 = true;
	pchar.GenQuestBox.Shore55.box1.items.mineral18 = 10;
	pchar.GenQuestBox.Shore55.box2.items.mineral14 = 25;
	pchar.quest.FalseTrace_AfterBattle.over = "yes";
	Group_DeleteGroup("Solly_brig");
	Island_SetReloadEnableGlobal("SantaCatalina", true);
	AddQuestRecord("FalseTrace", "18");
	CloseQuestHeader("FalseTrace");
	DeleteAttribute(pchar, "questTemp.FalseTrace");
	ChangeOfficersLoyality("bad_all", 1);
	SetFunctionTimerCondition("FalseTrace_DeleteBox", 0, 0, 1, false); // belamour gen через день удалить хлам из сундуков
}

void FalseTrace_DeleteBox(string qName)//в сундуки - хлам
{
	DeleteAttribute(pchar, "GenQuestBox.Shore55"); // belamour gen этот хлам остается навечно
}

void FalseTrace_GoldShip(string qName)//высадили в бухте Катерину, ее кэпа и пленного Адама
{
	chrDisableReloadToLocation = true;
	sld = &Characters[sti(Pchar.questTemp.FalseTrace.PrisonerIDX)];
	sld.lifeday = 0;
	LAi_CharacterEnableDialog(sld);//разрешение диалога
	sld.Dialog.Filename = "Quest\LineMiniQuests\FalseTrace.c";
	sld.dialog.currentnode = "FalseTrace_GoldShip";
	sld.greeting = "town_pirate";
	RemovePassenger(Pchar, sld);
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto2");
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	ref chr = CharacterFromID("FalseTraceWife");
	chr.lifeday = 0;
	RemovePassenger(Pchar, chr);
	LAi_SetActorType(chr);
	ChangeCharacterAddressGroup(chr, pchar.location, "goto", "goto2");
	LAi_ActorFollow(chr, sld, "", -1);
	ref ch = &Characters[sti(Pchar.questTemp.FalseTrace.PrisonerAdamIDX)];
	ReleasePrisoner(ch); //освободили пленника
	ch.lifeday = 0;
	ChangeCharacterAddressGroup(ch, pchar.location, "goto", "goto2");
	LAi_SetActorType(ch);
	LAi_ActorFollow(ch, sld, "", -1);
}

void CreateFalseTraceGoldShipOnMap(string qName)//создаем корабль с золотом
{
	string sCapId = "FalseTraceGoldCap";
    string sGroup = "Sea_" + sCapId + "1";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	int iNation = sti(pchar.questTemp.FalseTrace.ShipNation);
	int iScl = 20 + 2*sti(pchar.rank);
	if (iScl > 90) iScl = 90;
	for (int i = 1; i <= 2; i++)
    {
		sld = GetCharacter(NPC_GenerateCharacter(sCapId + i, "citiz_41", "man", "man", 20, iNation, 20, true, "quest"));
		SetRandomNameToCharacter(sld);
		SetRandomNameToShip(sld);
		switch (i)
		{
			case 1: iTemp = SHIP_GALEON_H break;
			case 2: 
				if (sti(pchar.rank < 16)) iTemp = SHIP_CORVETTE;
				else iTemp = SHIP_FRIGATE;
			break;
		}
		sld.Ship.Type = GenerateShipExt(iTemp, 1, sld);
		SetBaseShipData(sld);
		SetCaptanModelByEncType(sld, "war");
		int hcrew = GetMaxCrewQuantity(sld);
		SetCrewQuantity(sld, hcrew);
		SetCrewQuantityFull(sld);
		sld.AlwaysEnemy = true;
		sld.DontRansackCaptain = true;
		sld.Coastal_Captain = true; //не ссорить нации
		sld.lifeDay = 15;
		sld.AnalizeShips = true;
		sld.skill.Sailing = iScl+10;
		sld.skill.Defence = iScl;
		sld.skill.Accuracy = iScl;
		sld.skill.Cannons = iScl+rand(10);
		sld.Ship.Crew.Morale = iScl;
		sld.Ship.Crew.Exp.Sailors = iScl;
		sld.Ship.Crew.Exp.Cannoners = iScl;
		sld.Ship.Crew.Exp.Soldiers = iScl;
		SetCharacterPerk(sld, "HullDamageUp");
		SetCharacterPerk(sld, "SailsDamageUp");
		SetCharacterPerk(sld, "CrewDamageUp");
		SetCharacterPerk(sld, "CriticalShoot");
		SetCharacterPerk(sld, "MusketsShoot");
		SetCharacterPerk(sld, "AdvancedBattleState");
		SetCharacterPerk(sld, "ShipDefenseProfessional");
		SetCharacterPerk(sld, "LongRangeShoot");
		SetCharacterPerk(sld, "ShipTurnRateUp");
		SetCharacterPerk(sld, "ShipSpeedUp");
		DeleteAttribute(sld, "SinkTenPercent");
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		SetCharacterGoods(sld, GOOD_GRAPES, 700);
		SetCharacterGoods(sld, GOOD_KNIPPELS, 500);
		SetCharacterGoods(sld, GOOD_BOMBS, 1000);
		SetCharacterGoods(sld, GOOD_POWDER, 2500);
		if (i == 1)
		{
			SetCharacterGoods(sld, GOOD_GOLD, 800);//положить в трюм золото
			SetCharacterGoods(sld, drand(3)+28, 200+drand(100));//положить в трюм апгрейд-товар
		}
		sld.mapEnc.type = "war";
		sld.mapEnc.worldMapShip = "quest_ship";
        sld.mapEnc.Name = "galleon with gold ore";
        Group_AddCharacter(sGroup, sCapId + i);
	}
	Group_SetGroupCommander(sGroup, sCapId+ "1");
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
	Map_CreateTrader(pchar.questTemp.FalseTrace.ShipCity, "Shore3", sCapId + "1", 19);//запуск энкаунтера
	SetFunctionTimerCondition("FalseTraceGoldShipOver", 0, 0, 19, false); 
	//на абордаж
	pchar.quest.FalseTrace_Abordage.win_condition.l1 = "Character_Capture";
	pchar.quest.FalseTrace_Abordage.win_condition.l1.character = "FalseTraceGoldCap1";
	pchar.quest.FalseTrace_Abordage.function = "FalseTraceGoldCap_Abordage";//взяли на абордаж
	//на потопление орудиями
	pchar.quest.FalseTrace_Sink.win_condition.l1 = "Character_sink";
	pchar.quest.FalseTrace_Sink.win_condition.l1.character = "FalseTraceGoldCap1";
	pchar.quest.FalseTrace_Sink.function = "FalseTraceGoldCap_Sink";//потопили
}

void FalseTraceGoldCap_Abordage(string qName)//после абордажа
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.FalseTraceGoldShipOver.over = "yes"; //снять таймер
	pchar.quest.FalseTrace_Sink.over = "yes";
	AddQuestRecord("FalseTrace", "22");
	CloseQuestHeader("FalseTrace");
	DeleteAttribute(pchar, "questTemp.FalseTrace");
	AddComplexSeaExpToScill(150, 150, 150, 200, 150, 150, 0);
	ChangeOfficersLoyality("good_all", 1);
}

void FalseTraceGoldCap_Sink(string qName)//потопили
{
	pchar.quest.FalseTraceGoldShipOver.over = "yes"; //снять таймер
	pchar.quest.FalseTrace_Abordage.over = "yes";
	AddQuestRecord("FalseTrace", "21");
	CloseQuestHeader("FalseTrace");
	DeleteAttribute(pchar, "questTemp.FalseTrace");
	AddComplexSeaExpToScill(20, 20, 20, 0, 20, 20, 0);
	ChangeOfficersLoyality("bad_all", 1);
}

void FalseTraceGoldShipOver(string qName)//опоздали или не нашли галеон
{
	pchar.quest.FalseTrace_Abordage.over = "yes";
	pchar.quest.FalseTrace_Sink.over = "yes";
	AddQuestRecord("FalseTrace", "20");
	CloseQuestHeader("FalseTrace");
	DeleteAttribute(pchar, "questTemp.FalseTrace");
	ChangeOfficersLoyality("bad_all", 1);
}

void FalseTrace_AdamTreasure(string qName)//на маяке у нычки Адама
{
	//заполним сундук
	pchar.GenQuestBox.Mayak7 = true;
	pchar.GenQuestBox.Mayak7.box1.items.gold_dublon = 1109;//дублоны
	pchar.GenQuestBox.Mayak7.box1.items.icollection = 4;//коллекции
	pchar.GenQuestBox.Mayak7.box1.items.jewelry2 = 55;
	pchar.GenQuestBox.Mayak7.box1.items.jewelry3 = 28;
	pchar.GenQuestBox.Mayak7.box1.items.jewelry4 = 11;
	pchar.GenQuestBox.Mayak7.box1.items.jewelry40 = 20;
	pchar.GenQuestBox.Mayak7.box1.items.jewelry41 = 15;
	pchar.GenQuestBox.Mayak7.box1.items.jewelry42 = 21;
	pchar.GenQuestBox.Mayak7.box1.items.jewelry44 = 26;
	pchar.GenQuestBox.Mayak7.box1.items.jewelry47 = 19;
	pchar.GenQuestBox.Mayak7.box1.items.jewelry49 = 24;
	pchar.GenQuestBox.Mayak7.box1.items.jewelry51 = 13;
	//поставим прерывание на вход в локатор
	pchar.quest.False_Trace_8.win_condition.l1 = "locator";
	pchar.quest.False_Trace_8.win_condition.l1.location = "Mayak7";
	pchar.quest.False_Trace_8.win_condition.l1.locator_group = "box";
	pchar.quest.False_Trace_8.win_condition.l1.locator = "box1";
	pchar.quest.False_Trace_8.function = "FalseTrace_PrepereCreateBandits";
}

void FalseTrace_PrepereCreateBandits(string qName)//установим прерывание на выход
{
	chrDisableReloadToLocation = true;
	pchar.quest.False_Trace_9.win_condition.l1 = "locator";
	pchar.quest.False_Trace_9.win_condition.l1.location = "Mayak7";
	pchar.quest.False_Trace_9.win_condition.l1.locator_group = "reload";
	pchar.quest.False_Trace_9.win_condition.l1.locator = "boat";
	pchar.quest.False_Trace_9.function = "FalseTrace_CreateBandits";
}

void FalseTrace_CreateBandits(string qName)//установим бандитов
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретим драться
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE/2;
	int iScl = 10 + 2*sti(pchar.rank);
	if (sti(pchar.rank) < 16) sTemp = "pistol1";
	else sTemp = "pistol6";
	for (i=1; i<=4; i++)
	{
		if (i == 1)
		{
		sld = GetCharacter(NPC_GenerateCharacter("Adam_bandit_"+i, "mercen_24", "man", "man", iRank+3, PIRATE, 0, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank+3, iScl+5, iScl+5, "blade_04", "pistol4", "bullet", iScl*2);
		}
		else
		{
		sld = GetCharacter(NPC_GenerateCharacter("Adam_bandit_"+i, "citiz_"+(i+40), "man", "man", iRank, PIRATE, 0, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_04", sTemp, "bullet", iScl*2);
		}
		ChangeCharacterAddressGroup(sld, "Mayak7", "goto", "goto1");
		LAi_SetActorType(sld);
		sld.Dialog.Filename = "Quest\LineMiniQuests\FalseTrace.c";
		if (i == 1) sld.dialog.currentnode = "FalseTrace_Bandits";
		else LAi_CharacterDisableDialog(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
	}
	//установим Катерину
	sld = characterFromId("FalseTraceWife");
	ChangeCharacterAddressGroup(sld, "Mayak7", "goto", "goto3");
	LAi_SetCitizenType(sld);
	LAi_CharacterDisableDialog(sld);
}

void FalseTrace_BanditsShip(string qName)//бандитский корабль
{
	Island_SetReloadEnableGlobal("Hispaniola2", false);//на остров нельзя
	Group_FindOrCreateGroup("Band_brig");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 10 + 2*sti(pchar.rank);
	if (sti(pchar.rank < 15)) iTemp = SHIP_BRIG;
	else iTemp = SHIP_CORVETTE;
	sld = GetCharacter(NPC_GenerateCharacter("BandCap", "mercen_2", "man", "man", iRank, FRANCE, 0, true, "quest"));
	FantomMakeSmallSailor(sld,iTemp, "", CANNON_TYPE_CANNON_LBS16, 70, iScl, iScl, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, 40, 40, "blade_04", "pistol1", "bullet", 100);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	Group_AddCharacter("Band_brig", "BandCap");
	sld.AlwaysEnemy = true;
	sld.AnalizeShips = true;
	sld.Coastal_Captain = true;
	sld.Ship.Mode = "pirate";
	Group_SetGroupCommander("Band_brig", "BandCap");
	Group_SetAddress("Band_brig", "Hispaniola2", "ships", "l2");
	Group_SetTaskAttack("Band_brig", PLAYER_GROUP);
	Group_LockTask("Band_brig");
	pchar.quest.FalseTrace_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.FalseTrace_AfterBattle.win_condition.l1.group = "Band_brig";
	pchar.quest.FalseTrace_AfterBattle.function = "BandShip_AfterBattle";
	pchar.quest.FalseTrace_DieHard.win_condition.l1 = "MapEnter";
	pchar.quest.FalseTrace_DieHard.function = "BandShip_DieHard";
}

void BandShip_AfterBattle(string qName)//победили
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.FalseTrace_DieHard.over = "yes";
	Group_DeleteGroup("Band_brig");
	Island_SetReloadEnableGlobal("Hispaniola2", true);
	AddQuestRecord("FalseTrace", "26");
	CloseQuestHeader("FalseTrace");
	DeleteAttribute(pchar, "questTemp.FalseTrace");
	AddComplexSeaExpToScill(50, 50, 50, 50, 50, 50, 0);
	ChangeOfficersLoyality("good_all", 1);
}

void BandShip_DieHard(string qName)//сбежали
{
	pchar.GenQuestBox.Mayak7 = true;
	pchar.GenQuestBox.Mayak7.box1.items.mineral18 = 25;
	pchar.quest.FalseTrace_AfterBattle.over = "yes";
	Group_DeleteGroup("Band_brig");
	Island_SetReloadEnableGlobal("Hispaniola2", true);
	AddQuestRecord("FalseTrace", "27");
	CloseQuestHeader("FalseTrace");
	DeleteAttribute(pchar, "questTemp.FalseTrace");
	ChangeOfficersLoyality("bad_all", 1);
}
//<-- Ложный след

///////////////////////////////////////////////////////////////////////////////////////////////////////////////
// --> Jason -----------------------------Сопровождение торговца из таверны----------------------------------
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
void GetEscortTraderShore()//выбор бухты для эскорта торговца из таверны
{
	pchar.GenQuest.Escort.Trader.Island = GetRandomIslandId();
	while(pchar.GenQuest.Escort.Trader.Island == Islands[GetCharacterCurrentIsland(pchar)].id)
	{
		pchar.GenQuest.Escort.Trader.Island = GetRandomIslandId();
	} // patch-6
	pchar.GenQuest.Escort.Trader.Shore = GetIslandRandomShoreId(pchar.GenQuest.Escort.Trader.Island);
	while(pchar.GenQuest.Escort.Trader.Shore == "")
	{
		pchar.GenQuest.Escort.Trader.Island = GetRandomIslandId();
		pchar.GenQuest.Escort.Trader.Shore = GetIslandRandomShoreId(pchar.GenQuest.Escort.Trader.Island);
		if (!isLocationFreeForQuests(pchar.GenQuest.Escort.Trader.Island)) pchar.GenQuest.Escort.Trader.Shore = "";
	}
	pchar.GenQuest.Escort.Trader.City = FindTownOnIsland(pchar.GenQuest.Escort.Trader.Island);
}

void CreateTraderShipAndAdd(ref sld)//создаем корабль сопровождаемого торговца 
{
	int iGoods, iSpace;
	int iShipType = sti(pchar.GenQuest.Escort.Trader.ShipType);
	// --> mitrokosta fix lifeday & name change
	int iRank = sti(pchar.rank) + 10;
	DeleteAttribute(sld, "CityType");
	DeleteAttribute(sld, "City");
	sld.rank = iRank;
	sld.lifeday = sti(pchar.GenQuest.Escort.Trader.DaysQty) + 1;
	sld.PhantomType = "citizen";
	SetFantomParamFromRank(sld, iRank, true);
	// <--
	FantomMakeSmallSailor(sld, iShipType, "", CANNON_TYPE_CANNON_LBS12, 40+rand(10), 30+rand(10), 30+rand(10), 30+rand(10), 30+rand(10));
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	SetCharacterGoods(sld, GOOD_FOOD, 300+rand(100));
	SetCharacterGoods(sld, GOOD_MEDICAMENT, 60+rand(30));
	iGoods = GOOD_COFFEE + drand(sti(GOOD_PAPRIKA - GOOD_COFFEE));
	iSpace = GetCharacterFreeSpace(sld, iGoods);
	iSpace = makeint(iSpace/2 + rand(iSpace/2));
	SetCharacterGoods(sld, iGoods, iSpace);
	SetCharacterRemovable(sld, false);
	SetCompanionIndex(pchar, -1, sti(sld.index));
	sld.loyality = MAX_LOYALITY;
	sld.Abordage.Enable = false;
	sld.AlwaysFriend = true;
	//sld.CompanionEnemyEnable = true;
}

void EscortTrader_Over(string qName)//опоздали сопроводить 170712
{
	pchar.quest.EscortTrader_fail.over = "yes";
	pchar.quest.EscortTrader_Complete.over = "yes";
	pchar.quest.EscortTrader_Attack.over = "yes";
	//RemoveCharacterCompanion(Pchar, characterFromID(pchar.GenQuest.Escort.Trader.id));
	sld = characterFromId(pchar.GenQuest.Escort.Trader.id);
	RemoveCharacterCompanion(Pchar, sld);//лесник удаление из эскадры ,так надежнее. если что - верну обратно .
	sld.lifeday = 0;//лесник . разлокировал 
	AddQuestRecord("TraderEscort", "2");
	CloseQuestHeader("TraderEscort");
	DeleteAttribute(pchar, "GenQuest.Escort.Trader");
	ChangeOfficersLoyality("bad_all", 1);
}

void EscortTrader_failed(string qName)//потеряли сопровождаемого 170712
{
	pchar.quest.EscortTrader_Complete.over = "yes";
	pchar.quest.EscortTrader_Over.over = "yes";
	pchar.quest.EscortTrader_Attack.over = "yes";
	ChangeCharacterComplexReputation(pchar,"nobility", -5);
	ChangeCharacterNationReputation(pchar, sti(pchar.GenQuest.Escort.Trader.Nation), -5);
	AddQuestRecord("TraderEscort", "3");
	CloseQuestHeader("TraderEscort");
	DeleteAttribute(pchar, "GenQuest.Escort.Trader");
	ChangeOfficersLoyality("bad_all", 1);
}

void EscortTraderAttackInShore(string qName)//в бухте напали пираты
{
	Island_SetReloadEnableGlobal(pchar.GenQuest.Escort.Trader.Island, false);//на остров нельзя
	Group_DeleteGroup("Pirate_Attack");
	Group_FindOrCreateGroup("Pirate_Attack");
	SelectLevelWarShipParameter();//автолевеллинг
    for (int i = 1; i <= 2; i++)
    {
        sld = GetCharacter(NPC_GenerateCharacter("TPirate_"+i, "mercen_"+(rand(27)+1), "man", "man", sti(PChar.rank) + 8, PIRATE, 10, true, "hunter"));
		FantomMakeSmallSailor(sld, iGlobalTemp, "", iTotalTemp, 30+rand(5), 30+rand(5), 30+rand(5), 30+rand(5), 35+rand(5));
		FantomMakeCoolFighter(sld, sti(PChar.rank)+5, 30, 30, sTotalTemp, "pistol2", "grapeshot", 30);
        Group_AddCharacter("Pirate_Attack", "TPirate_"+i);
    }
    Group_SetGroupCommander("Pirate_Attack", "TPirate_1");
	Group_SetTaskAttack("Pirate_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("Pirate_Attack", PLAYER_GROUP);
	Group_SetAddress("Pirate_Attack", pchar.GenQuest.Escort.Trader.Island, "", "");
	Group_LockTask("Pirate_Attack");
    
    pchar.quest.EscortTraderInShore_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.EscortTraderInShore_AfterBattle.win_condition.l1.group = "Pirate_Attack";
	pchar.quest.EscortTraderInShore_AfterBattle.function = "EscortTraderInShore_AfterBattle";
	pchar.quest.EscortTraderInShore_DieHard.win_condition.l1 = "MapEnter";
    pchar.quest.EscortTraderInShore_DieHard.function = "EscortTraderInShore_DieHard";
}

void EscortTraderInShore_AfterBattle(string qName)//победили
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.EscortTraderInShore_DieHard.over = "yes";
	Group_DeleteGroup("Pirate_Attack");
	Island_SetReloadEnableGlobal(pchar.GenQuest.Escort.Trader.Island, true);
	AddQuestRecord("TraderEscort", "12");
	ChangeOfficersLoyality("good_all", 1);
	ChangeCharacterComplexReputation(pchar, "authority", 1);
	AddComplexSeaExpToScill(50, 50, 50, 100, 50, 50, 0);
}

void EscortTraderInShore_DieHard(string qName)//сбежали
{
	pchar.quest.EscortTraderInShore_AfterBattle.over = "yes";
	Group_DeleteGroup("Pirate_Attack");
	Island_SetReloadEnableGlobal(pchar.GenQuest.Escort.Trader.Island, true);
	pchar.quest.EscortTrader_fail.over = "yes";
	pchar.quest.EscortTrader_Complete.over = "yes";
	pchar.quest.EscortTrader_Over.over = "yes";//снять три прерывания
	sld = characterFromId(pchar.GenQuest.Escort.Trader.id);
	sld.lifeday = 0;
	RemoveCharacterCompanion(Pchar, sld);
	DeleteAttribute(pchar, "GenQuest.Escort.Trader");
	AddQuestRecord("TraderEscort", "13");
	CloseQuestHeader("TraderEscort");
	ChangeOfficersLoyality("bad_all", 1);
}

void EscortTraderEnemy_Over(string qName)//опоздали по наводке
{
	pchar.quest.EscortTrader_EnTrader.over = "yes";
	DeleteAttribute(pchar, "GenQuest.Escort.Trader");
	AddQuestRecord("TraderEscort", "8");
	CloseQuestHeader("TraderEscort");
	ChangeOfficersLoyality("bad_all", 1);
}

void Create_EnemyTraderFleut(string qName)//флейт торговца
{
	pchar.quest.EscortTraderEnemy_Over.over = "yes";
	Island_SetReloadEnableGlobal(pchar.GenQuest.Escort.Trader.EnIsland, false);//на остров нельзя
	Group_DeleteGroup("Trade_Attack");
	Group_FindOrCreateGroup("Trade_Attack");
    sld = GetCharacter(NPC_GenerateCharacter("EnTrader", "trader_"+(rand(15)+1), "man", "man", sti(PChar.rank)+3, sti(pchar.GenQuest.Escort.Trader.Nation), 5, true, "quest"));
	sld.name = pchar.GenQuest.Escort.Trader.Enemyname;
	sld.lastname = "";
	FantomMakeSmallSailor(sld, SHIP_FLEUT, "", CANNON_TYPE_CANNON_LBS12, 20+rand(5), 15+rand(5), 20+rand(5), 15+rand(5), 15+rand(5));
	SetFantomParamFromRank(sld, sti(PChar.rank)+3, true); 
	sld.AlwaysEnemy = true;
	sld.Ship.Mode = "trade";
	int iGoods = sti(pchar.GenQuest.Escort.Trader.Goods);
	int iSpace = GetCharacterFreeSpace(sld, iGoods);
	iSpace = makeint(iSpace - iSpace/10);
	SetCharacterGoods(sld, iGoods, iSpace);
    Group_AddCharacter("Trade_Attack", "EnTrader");
		
    Group_SetGroupCommander("Trade_Attack", "EnTrader");
	Group_SetTaskRunaway("Trade_Attack", PLAYER_GROUP);
	Group_SetAddress("Trade_Attack", pchar.GenQuest.Escort.Trader.EnIsland, "quest_ships", "quest_ship_6");
	Group_LockTask("Trade_Attack");
    
	//на захват абордажем
	pchar.quest.EnemyTrader_Abordage.win_condition.l1 = "Character_Capture";
	pchar.quest.EnemyTrader_Abordage.win_condition.l1.character = "EnTrader";
	pchar.quest.EnemyTrader_Abordage.function = "EnemyTrader_Win";//взяли на абордаж
	//на потопление орудиями
	pchar.quest.EnemyTrader_Sink.win_condition.l1 = "Character_sink";
	pchar.quest.EnemyTrader_Sink.win_condition.l1.character = "EnTrader";
	pchar.quest.EnemyTrader_Sink.function = "EnemyTrader_Fail";//потопили
	//на карту
	pchar.quest.EnemyTrader_DieHard.win_condition.l1 = "MapEnter";
    pchar.quest.EnemyTrader_DieHard.function = "EnemyTrader_DieHard";
}

void EnemyTrader_Win(string qName)//победили
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.EnemyTrader_DieHard.over = "yes";
	pchar.quest.EnemyTrader_Sink.over = "yes";
	Group_DeleteGroup("Trade_Attack");
	Island_SetReloadEnableGlobal(pchar.GenQuest.Escort.Trader.EnIsland, true);
	AddQuestRecord("TraderEscort", "9");
	AddQuestUserData("TraderEscort", "sAdd", pchar.GenQuest.Escort.Trader.add);
	CloseQuestHeader("TraderEscort");
	DeleteAttribute(pchar, "GenQuest.Escort.Trader");
	AddComplexSeaExpToScill(50, 50, 50, 100, 50, 50, 0);
	AddComplexSelfExpToScill(30, 30, 30, 30);
	AddCharacterExpToSkill(pchar, "Fortune", 100);//везение
	AddCharacterExpToSkill(pchar, "Sneak", 100);//скрытность
	ChangeOfficersLoyality("good_all", 1);
}

void EnemyTrader_Fail(string qName)//утонул флейт
{
	pchar.quest.EnemyTrader_DieHard.over = "yes";
	pchar.quest.EnemyTrader_Abordage.over = "yes";
	Group_DeleteGroup("Trade_Attack");
	Island_SetReloadEnableGlobal(pchar.GenQuest.Escort.Trader.EnIsland, true);
	AddQuestRecord("TraderEscort", "15");
	CloseQuestHeader("TraderEscort");
	DeleteAttribute(pchar, "GenQuest.Escort.Trader");
	AddCharacterExpToSkill(pchar, "Sailing", 10);//навигация
	AddCharacterExpToSkill(pchar, "Accuracy", 20);//меткость
	AddCharacterExpToSkill(pchar, "Cannons", 20);//орудия
	AddCharacterExpToSkill(pchar, "Defence", 10);//защита
	ChangeOfficersLoyality("bad_all", 1);
}

void EnemyTrader_DieHard(string qName)//сбежали
{
	pchar.quest.EnemyTrader_Abordage.over = "yes";
	pchar.quest.EnemyTrader_DieHard.over = "yes";
	Group_DeleteGroup("Trade_Attack");
	Island_SetReloadEnableGlobal(pchar.GenQuest.Escort.Trader.EnIsland, true);
	AddQuestRecord("TraderEscort", "10");
	CloseQuestHeader("TraderEscort");
	DeleteAttribute(pchar, "GenQuest.Escort.Trader");
	ChangeOfficersLoyality("bad_all", 1);
}

void DesIslandAttack(string qName)//нападение торговца-пирата
{
	Log_Info("The trader has raised the black flag and attacking us!");
	Island_SetReloadEnableGlobal(pchar.GenQuest.Escort.Trader.Island, false);//на остров нельзя
	pchar.quest.EscortTrader_fail.over = "yes";
	pchar.quest.EscortTrader_Complete.over = "yes";
	pchar.quest.EscortTrader_Over.over = "yes";//снять три прерывания
	Group_FindOrCreateGroup("ETAttack"); 
	Group_SetType("ETAttack", "pirate");
	sld = characterFromId(pchar.GenQuest.Escort.Trader.id); 
	RemoveCharacterCompanion(Pchar, sld);
	Group_AddCharacter("ETAttack", pchar.GenQuest.Escort.Trader.id);
	sld.lifeday = 0;
	DeleteAttribute(sld, "AlwaysFriend");
	sld.Coastal_Captain = true;//не ругать нации
	sld.alwaysenemy = true;
	sld.nation = PIRATE;
	sld.Ship.Mode = "pirate";
	Ship_FlagRefresh(sld);
	Ship_NationAgressivePatent(sld);
	Ship_SetTaskAttack(SECONDARY_TASK, sti(sld.index), sti(pchar.index));
	SetCharacterRelationBoth(sti(sld.index), GetMainCharacterIndex(), RELATION_ENEMY);
	RefreshBattleInterface();
	UpdateRelations();
	if (sti(pchar.GenQuest.Escort.Trader.Chance) == 2)
	{
		SelectLevelWarShipParameter();//автолевеллинг
		for (int i = 1; i <= 2; i++)
		{
        sld = GetCharacter(NPC_GenerateCharacter("TPirate_"+i, "mercen_"+(rand(27)+1), "man", "man", sti(PChar.rank) + 5, PIRATE, 1, true, "hunter"));
		FantomMakeSmallSailor(sld, iGlobalTemp, "", iTotalTemp, 30+rand(5), 30+rand(5), 30+rand(5), 30+rand(5), 35+rand(5));
		FantomMakeCoolFighter(sld, sti(PChar.rank), 30, 30, sTotalTemp, "pistol2", "grapeshot", 30);
        Group_AddCharacter("ETAttack", "TPirate_"+i);
		}
	}
	Group_SetGroupCommander("ETAttack", pchar.GenQuest.Escort.Trader.id);
	Group_SetAddress("ETAttack", pchar.GenQuest.Escort.Trader.Island, "", "");
	Group_SetPursuitGroup("ETAttack", PLAYER_GROUP);
	Group_LockTask("ETAttack");
	pchar.quest.EscortTradeAttack_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.EscortTradeAttack_AfterBattle.win_condition.l1.group = "ETAttack";
	pchar.quest.EscortTradeAttack_AfterBattle.function = "EscortTraderAttack_AfterBattle";
	pchar.quest.EscortTradeAttack_DieHard.win_condition.l1 = "MapEnter";
    pchar.quest.EscortTradeAttack_DieHard.function = "EscortTraderAttack_DieHard";
}

void EscortTraderAttack_AfterBattle(string qName)//уничтожили врага
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.EscortTradeAttack_DieHard.over = "yes";
	Group_DeleteGroup("Trade_Attack");
	Island_SetReloadEnableGlobal(pchar.GenQuest.Escort.Trader.Island, true); // patch-8
	DeleteAttribute(pchar, "GenQuest.Escort.Trader");
	if (sti(pchar.GenQuest.Escort.Trader.Chance) == 2) AddQuestRecord("TraderEscort", "11");
	else AddQuestRecord("TraderEscort", "14");
	CloseQuestHeader("TraderEscort");
	AddComplexSeaExpToScill(100, 100, 100, 100, 100, 100, 0);
	AddCharacterExpToSkill(pchar, "Leadership", 100);//харизма
	AddCharacterExpToSkill(pchar, "Fortune", 50);//везение
	ChangeOfficersLoyality("good_all", 1);
}

void EscortTraderAttack_DieHard(string qName)//ушли на карту
{
	pchar.quest.EscortTradeAttack_AfterBattle.over = "yes";
	Group_DeleteGroup("Trade_Attack");
	Island_SetReloadEnableGlobal(pchar.GenQuest.Escort.Trader.Island, true); // patch-8
	DeleteAttribute(pchar, "GenQuest.Escort.Trader");
	if (sti(pchar.GenQuest.Escort.Trader.Chance) == 2) AddQuestRecord("TraderEscort", "11");
	else AddQuestRecord("TraderEscort", "14");
	CloseQuestHeader("TraderEscort");
	AddCharacterExpToSkill(pchar, "Sailing", 20);//навигация
	AddCharacterExpToSkill(pchar, "Defence", 20);//защита
	AddCharacterExpToSkill(pchar, "Repair", 20);//починка
	AddCharacterExpToSkill(pchar, "Sneak", 20);//скрытность
	ChangeOfficersLoyality("bad_all", 1);
}

void EscortTraderComplete(string qName)//сдача квеста по прибытию на место
{
	chrDisableReloadToLocation = true;
	bDisableFastReload = true;
	GetCharacterPos(pchar, &locx, &locy, &locz);
	sld = characterFromId(pchar.GenQuest.Escort.Trader.id);
	sld.lifeday = 0;
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, pchar.GenQuest.Escort.Trader.Location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	sld.dialog.Filename = "Quest\QuestTrader_dialog.c";
	sld.dialog.currentnode = "EscortTrader_complete";
	sld.greeting = "captain_complete_1";
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}
// <-- Сопровождение торговца из таверны

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//--> Jason ------------------------------------гонки на гидропланах-----------------------------------------
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
void MCRaceInTargetCity(string qName)//прибыл ГГ
{
	pchar.quest.RacingTimeOver.over = "yes";
	if (!CheckAttribute(pchar, "GenQuest.Racing.Go.TraderWin"))
	{
	pchar.GenQuest.Racing.Go.MCWin = "true";
	AddQuestRecord("Racing", "2");
	AddQuestUserData("Racing", "sCity", XI_ConvertString("Colony"+pchar.GenQuest.Racing.Go.City+"Gen"));
	}
	else AddQuestRecord("Racing", "3");
}

void TraderRaceInTargetCity(string qName)//прибыл торговец
{
	int iNation = sti(pchar.GenQuest.Racing.Go.Nation);
	if (!CheckAttribute(pchar, "GenQuest.Racing.Go.MCWin")) pchar.GenQuest.Racing.Go.TraderWin = "true";
	sld = characterFromId("RaceTrader");
	ref chr = GetCharacter(NPC_GenerateCharacter("RaceTraderSkiper", "mercen_"+(rand(29)+1), "man", "man", sti(PChar.rank) + 20, iNation, -1, true, "quest"));
	FantomMakeSmallSailor(chr, SHIP_FLEUT, pchar.GenQuest.Racing.Go.ShipName, CANNON_TYPE_CANNON_LBS12, 100, 50, 50, 50, 50);
	chr.name = "Боцман";
	chr.lastname = GenerateRandomName_Generator(iNation, "man");
	Group_FindOrCreateGroup("RacingTrader"); 
	Group_SetType("RacingTrader", "Trade");//тип группы
	Group_AddCharacter("RacingTrader", "RaceTraderSkiper");
	Group_SetGroupCommander("RacingTrader", "RaceTraderSkiper");
	Group_SetAddress("RacingTrader", pchar.GenQuest.Racing.Go.Island, "quest_ships", "quest_ship_1");
	//для особо упоротых
	pchar.quest.Racing_fail.win_condition.l1 = "NPC_Death";
	pchar.quest.Racing_fail.win_condition.l1.character = "RaceTraderSkiper";
	pchar.quest.Racing_fail.function = "Racing_failed";
	//торговца усадим в таверну
	LAi_SetSitType(sld);
	FreeSitLocator(pchar.GenQuest.Racing.Go.City + "_tavern", "sit_front1");
	ChangeCharacterAddressGroup(sld, pchar.GenQuest.Racing.Go.City + "_tavern", "sit", "sit_front1");
	sld.dialog.currentnode = "Racing_Finished";
	sld.greeting = "captain_complete_2";
}

void Racing_failed(string qName)//если у кого-то хватит тупости
{
	pchar.quest.RacingTimeOver.over = "yes";
	Group_DeleteGroup("RacingTrader");
	sld = characterFromId("RaceTrader");
	sld.lifeday = 0;
	sld = characterFromId("RaceTraderSkiper");
	sld.lifeday = 0;
	ChangeCharacterHunterScore(PChar, NationShortName(sti(pchar.GenQuest.Racing.Go.Nation)) + "hunter", 90); //начислить НЗГ
	ChangeCharacterComplexReputation(pchar,"authority", -5);
	ChangeOfficersLoyality("bad_all", 5);
	DeleteAttribute(pchar, "GenQuest.Racing.Go");
	AddQuestRecord("Racing", "7");
	CloseQuestHeader("Racing");
}

void RacingTimeOver(string qName)//не пришли совсем
{
	pchar.quest.Racing_Finish.over = "yes";
	pchar.quest.Racing_fail.over = "yes";
	Group_DeleteGroup("RacingTrader");
	sld = characterFromId("RaceTrader");
	sld.lifeday = 0;
	sld = characterFromId("RaceTraderSkiper");
	sld.lifeday = 0;
	DeleteAttribute(pchar, "GenQuest.Racing.Go");
	ChangeCharacterComplexReputation(pchar,"authority", -2);
	ChangeOfficersLoyality("bad_all", 1);
	AddQuestRecord("Racing", "6");
	CloseQuestHeader("Racing");
}
//<-- гонки на гидропланах

///////////////////////////////////////////////////////////////////////////////////////////////////////////////
// --> Jason -----------------------------------мини-квесты монахов-------------------------------------------
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
void Monkletter_Over(string qName)//опоздали с депешей
{
	pchar.GenQuest.Monkletter.Late = "true";
	AddQuestRecord("Monkletter", "4");
}

void Churchbooks_Over(string qName)//опоздали с доставкой молитвенников
{
	pchar.GenQuest.Churchbooks.Late = "true";
	AddQuestRecord("Churchbooks", "5");
}

void Monkpassenger_Over(string qName)//опоздали с пассажиром
{
	pchar.quest.Monkpassenger.over = "yes";
	sld = characterFromId(pchar.GenQuest.Monkpassenger.id);
	sTemp = sld.index+"Citizpassenger";
	if (IsEntity(&worldMap) || bSeaActive) 
	{
		pchar.quest.Monkpassenger_remove.win_condition.l1 = "Location_Type";
		pchar.quest.Monkpassenger_remove.win_condition.l1.location_type = "town";
		pchar.quest.Monkpassenger_remove.function = "Monkpassenger_remove";
	}
	else
	{
		RemovePassenger(Pchar, sld);
		log_info("Passenger "+GetFullName(sld)+" has left your ship!");
		AddQuestRecordEx(sTemp, "Citizpassenger", "2");
		CloseQuestHeader(sTemp);
		sld.lifeday = 0;
		DeleteAttribute(Pchar, "GenQuest.Monkpassenger");
	}
}

void Monkpassenger_remove(string qName)//удаление пассажира
{
	sld = characterFromId(pchar.GenQuest.Monkpassenger.id);
	sTemp = sld.index+"Citizpassenger";
	RemovePassenger(Pchar, sld);
	log_info("Passenger "+GetFullName(sld)+" has left your ship!");
	AddQuestRecordEx(sTemp, "Citizpassenger", "2");
	CloseQuestHeader(sTemp);
	sld.lifeday = 0;
	DeleteAttribute(Pchar, "GenQuest.Monkpassenger");
}

void Monkpassenger_complete(string qName)//доставили пассажира
{
	sld = characterFromId(pchar.GenQuest.Monkpassenger.id);
	sld.Dialog.currentnode = "passenger_3";
	GetCharacterPos(pchar, &locx, &locy, &locz);
    ChangeCharacterAddressGroup(sld, pchar.GenQuest.Monkpassenger.City+"_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Monkshipshine_Over(string qName)//действие освящения окончено
{
	DeleteAttribute(Pchar, "GenQuest.Shipshine");
	log_testinfo("Действие освящения истекло!");
}

void ShipCapellan_Remove()//удаление капеллана
{
	sld = characterFromId(pchar.questTemp.ShipCapellan.id);
	sld.dialog.currentnode = "capellan_7";
	DeleteAttribute(Pchar, "questTemp.ShipCapellan.Yes");
	if (IsEntity(&worldMap) || bSeaActive) 
	{
		pchar.quest.ShipCapellan_remove.win_condition.l1 = "Location_Type";
		pchar.quest.ShipCapellan_remove.win_condition.l1.location_type = "town";
		pchar.quest.ShipCapellan_remove.function = "ShipCapellan_remove_1";
	}
	else
	{
		RemovePassenger(Pchar, sld);
		log_info("Chaplain "+GetFullName(sld)+" has left your ship!");
		PlaySound("interface\notebook.wav");
		sld.lifeday = 0;
		DeleteAttribute(Pchar, "questTemp.ShipCapellan.id");
	}
}

void ShipCapellan_remove_1(string qName)//удаление капеллана
{
	sld = characterFromId(pchar.questTemp.ShipCapellan.id);
	RemovePassenger(Pchar, sld);
	log_info("Chaplain "+GetFullName(sld)+" has left your ship!");
	PlaySound("interface\notebook.wav");
	sld.lifeday = 0;
	DeleteAttribute(Pchar, "questTemp.ShipCapellan.id");
}
//<-- мини-квесты монахов

///////////////////////////////////////////////////////////////////////////////////////////////////////////////
// --> Jason -----------------------------------мини-квесты горожан-------------------------------------------
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
void Townpassenger_Over(string qName)//опоздали с пассажиром
{
	pchar.quest.Townpassenger.over = "yes";
	sld = characterFromId(pchar.GenQuest.Townpassenger.id);
	sTemp = sld.index+"Citizpassenger";
	if (IsEntity(&worldMap) || bSeaActive) 
	{
		pchar.quest.Townpassenger_remove.win_condition.l1 = "Location_Type";
		pchar.quest.Townpassenger_remove.win_condition.l1.location_type = "town";
		pchar.quest.Townpassenger_remove.function = "Townpassenger_remove";
	}
	else
	{
		RemovePassenger(Pchar, sld);
		log_info("Passenger "+GetFullName(sld)+" has left your ship!");
		AddQuestRecordEx(sTemp, "Citizpassenger", "2");
		CloseQuestHeader(sTemp);
		sld.lifeday = 0;
		DeleteAttribute(Pchar, "GenQuest.Townpassenger");
	}
}

void Townpassenger_remove(string qName)//удаление пассажира
{
	sld = characterFromId(pchar.GenQuest.Townpassenger.id);
	sTemp = sld.index+"Citizpassenger";
	RemovePassenger(Pchar, sld);
	log_info("Passenger "+GetFullName(sld)+" has left your ship!");
	AddQuestRecordEx(sTemp, "Citizpassenger", "2");
	CloseQuestHeader(sTemp);
	sld.lifeday = 0;
	DeleteAttribute(Pchar, "GenQuest.Townpassenger");
}

void Townpassenger_complete(string qName)//доставили пассажира
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId(pchar.GenQuest.Townpassenger.id);
	sld.Dialog.currentnode = "passenger_3";
	GetCharacterPos(pchar, &locx, &locy, &locz);
    ChangeCharacterAddressGroup(sld, pchar.GenQuest.Townpassenger.City+"_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}
//<-- мини-кветсы горожан

///////////////////////////////////////////////////////////////////////////////////////////////////////////////
// --> Jason -----------------------------------мини-квесты дворян-------------------------------------------
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
void Noblepassenger_Over(string qName)//опоздали с пассажиром
{
	pchar.quest.Noblepassenger.over = "yes";
	sld = characterFromId(pchar.GenQuest.Noblepassenger.id);
	sTemp = sld.index+"Citizpassenger";
	if (IsEntity(&worldMap) || bSeaActive) 
	{
		pchar.quest.Noblepassenger_remove.win_condition.l1 = "Location_Type";
		pchar.quest.Noblepassenger_remove.win_condition.l1.location_type = "town";
		pchar.quest.Noblepassenger_remove.function = "Noblepassenger_remove";
	}
	else
	{
		RemovePassenger(Pchar, sld);
		log_info("Passenger "+GetFullName(sld)+" has left your ship!");
		AddQuestRecordEx(sTemp, "Citizpassenger", "2");
		CloseQuestHeader(sTemp);
		sld.lifeday = 0;
		DeleteAttribute(Pchar, "GenQuest.Noblepassenger");
	}
}

void Noblepassenger_remove(string qName)//удаление пассажира
{
	sld = characterFromId(pchar.GenQuest.Noblepassenger.id);
	sTemp = sld.index+"Citizpassenger";
	RemovePassenger(Pchar, sld);
	log_info("Passenger "+GetFullName(sld)+" has left your ship!");
	AddQuestRecordEx(sTemp, "Citizpassenger", "2");
	CloseQuestHeader(sTemp);
	sld.lifeday = 0;
	DeleteAttribute(Pchar, "GenQuest.Noblepassenger");
}

void Noblepassenger_complete(string qName)//доставили пассажира
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId(pchar.GenQuest.Noblepassenger.id);
	sld.Dialog.currentnode = "passenger_3";
	GetCharacterPos(pchar, &locx, &locy, &locz);
    ChangeCharacterAddressGroup(sld, pchar.GenQuest.Noblepassenger.City+"_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Noblelombard_Over(string qName)//время вышло
{
	sld = characterFromId(pchar.GenQuest.Noblelombard.id);
	sld.lifeday = 0;
	if (CheckAttribute(pchar, "GenQuest.Noblelombard.Regard")) AddQuestRecord("Noblelombard", "3");
	else AddQuestRecord("Noblelombard", "2");
	CloseQuestHeader("Noblelombard");
	//sld = characterFromId(pchar.GenQuest.Noblelombard.City+"_usurer");// лесник . из за этого вылет .
	DeleteAttribute(pchar, "quest.noblelombard");// лесник . с нпчара на пчара. теперь ок
	DeleteAttribute(Pchar, "GenQuest.Noblelombard");
}

void Noblelombard_Regard(string qName)//можно идти за наградой
{
	pchar.GenQuest.Noblelombard.Giveregard = "true";
}
//<-- мини-квесты дворян

///////////////////////////////////////////////////////////////////////////////////////////////////////////////
// --> Jason -----------------------------мини-квесты темных личностей----------------------------------------
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
void Marginpassenger_Over(string qName)
{
	DeleteAttribute(Pchar, "GenQuest.Marginpassenger");
}

void Marginpassenger_InWorld(string qName)//запускаем кораблик с пассажиром на карте
{
    string sGroup = "Sea_MarginCap1";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 3*sti(pchar.rank)+10;
	int iDays = GetMaxDaysFromIsland2Island(GetArealByCityName(pchar.GenQuest.Marginpassenger.Targetcity), GetArealByCityName(pchar.GenQuest.Marginpassenger.City))+5;
	int iShipType = pchar.GenQuest.Marginpassenger.ShipType;
	sTemp = pchar.GenQuest.Marginpassenger.ShipName;
	if (sti(pchar.rank) < 5) iTemp = CANNON_TYPE_CANNON_LBS3;
	if (sti(pchar.rank) >= 5 && sti(pchar.rank) < 8) iTemp = CANNON_TYPE_CANNON_LBS6;
	if (sti(pchar.rank) >= 8 && sti(pchar.rank) < 12) iTemp = CANNON_TYPE_CANNON_LBS12;
	if (sti(pchar.rank) >= 12 && sti(pchar.rank) < 15) iTemp = CANNON_TYPE_CANNON_LBS16;
	if (sti(pchar.rank) >= 15) iTemp = CANNON_TYPE_CANNON_LBS20;
	sld = GetCharacter(NPC_GenerateCharacter("MarginCap", "citiz_41", "man", "man", iRank, sti(pchar.GenQuest.Marginpassenger.Nation), iDays, true, "quest"));
	FantomMakeSmallSailor(sld, iShipType, sTemp, iTemp, iScl+10, iScl, iScl, iScl, iScl);
	SetFantomParamFromRank(sld, iRank, true); 
	SetCaptanModelByEncType(sld, "trade");
	sld.Ship.Mode = "trade";
	SetRandomNameToCharacter(sld);
	sld.Dialog.Filename = "Quest\Marginpassenger.c";
	sld.DeckDialogNode = "MarginCap";
	LAi_SetHP(sld, 170+iScl, 170+iScl);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	TakeNItems(sld, "potion2", 3);
	SetCharacterPerk(sld, "HullDamageUp");
	SetCharacterPerk(sld, "SailsDamageUp");
	SetCharacterPerk(sld, "CrewDamageUp");
	SetCharacterPerk(sld, "CriticalShoot");
	SetCharacterPerk(sld, "AdvancedBattleState");
	SetCharacterPerk(sld, "ShipTurnRateUp");
	SetCharacterPerk(sld, "ShipSpeedUp");
	DeleteAttribute(sld, "SinkTenPercent");
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.mapEnc.type = "trade";
	sld.mapEnc.worldMapShip = "ranger";
	sld.mapEnc.Name = GetStrSmallRegister(XI_ConvertString(GetBaseShipParamFromType(sti(pchar.GenQuest.Marginpassenger.ShipType), "Name")))+" '"+pchar.GenQuest.Marginpassenger.ShipName + "'";
	Group_AddCharacter(sGroup, "MarginCap");
	Group_SetGroupCommander(sGroup, "MarginCap");
	Map_CreateTrader(pchar.GenQuest.Marginpassenger.City, pchar.GenQuest.Marginpassenger.Targetcity, "MarginCap", iDays);

	SetFunctionTimerCondition("Marginpassenger_InWorldOver", 0, 0, iDays, false);
	pchar.quest.Marginpassenger_Sink.win_condition.l1 = "Character_sink";
	pchar.quest.Marginpassenger_Sink.win_condition.l1.character = "MarginCap";
	pchar.quest.Marginpassenger_Sink.function = "Marginpassenger_InWorldFail";//потопили
}

void Marginpassenger_InWorldOver(string qName)//упустили кораблик
{
	pchar.quest.Marginpassenger_Sink.over = "yes"; //снять прерывание
	AddQuestRecord("Marginpassenger", "2");
	AddQuestUserData("Marginpassenger", "sShipName", pchar.GenQuest.Marginpassenger.ShipName);
	CloseQuestHeader("Marginpassenger");
	Group_DeleteGroup("Sea_MarginCap1");
	DeleteAttribute(Pchar, "GenQuest.Marginpassenger");
	ChangeCharacterComplexReputation(pchar, "authority", -1);
	ChangeOfficersLoyality("bad_all", 1);
}

void Marginpassenger_InWorldFail(string qName)//потопили в бою
{
	pchar.quest.Marginpassenger_InWorldOver.over = "yes"; //снять прерывание
	Group_DeleteGroup("Sea_MarginCap1");
	AddQuestRecord("Marginpassenger", "3");
	AddQuestUserData("Marginpassenger", "sShipName", pchar.GenQuest.Marginpassenger.ShipName);
	CloseQuestHeader("Marginpassenger");
	DeleteAttribute(Pchar, "GenQuest.Marginpassenger");
	ChangeCharacterComplexReputation(pchar, "authority", -1);
	ChangeOfficersLoyality("bad_all", 1);
}

void Marginpassenger_CreateNeedman()//создаем выкупателя
{
	sld = GetCharacter(NPC_GenerateCharacter("MarginNeed", "citiz_"+(rand(9)+11), "man", "man", 10, sti(pchar.GenQuest.Marginpassenger.Nation), -1, true, "quest"));
	sld.Dialog.Filename = "Quest\Marginpassenger.c";
	sld.Dialog.currentnode = "MarginNeed";
	sld.name = pchar.GenQuest.Marginpassenger.q2Name;
	sld.lastname = "";
	LAi_SetImmortal(sld, true);
	RemoveCharacterEquip(sld, BLADE_ITEM_TYPE);
	RemoveCharacterEquip(sld, GUN_ITEM_TYPE);
	LAi_SetCitizenType(sld);
	ChangeCharacterAddressGroup(sld, pchar.GenQuest.Marginpassenger.Targetcity+"_town", "quest", "quest2");
	LAi_SetLoginTime(sld, 12.0, 21.0);
}

void Marginpassenger_SouthshoreOver(string qName)//опоздали в бухту
{
	AddQuestRecord("Marginpassenger", "14");
	AddQuestUserData("Marginpassenger", "sShore", XI_ConvertString(pchar.GenQuest.Marginpassenger.Shore+"Dat"));
	CloseQuestHeader("Marginpassenger");
	DeleteAttribute(Pchar, "GenQuest.Marginpassenger");
	ChangeCharacterComplexReputation(pchar, "authority", -1);
	ChangeOfficersLoyality("bad_all", 1);
}

void Marginpassenger_Southshore(string qName)//бой в бухте
{
	pchar.quest.Marginpassenger_SouthshoreOver.over = "yes"; //снять таймер
	chrDisableReloadToLocation = true;
	GetCharacterPos(pchar, &locx, &locy, &locz);
	int iRank = sti(pchar.rank)+2;
	int iScl = 15 + 2*sti(pchar.rank);
	int n = 5+makeint(MOD_SKILL_ENEMY_RATE/2);
	//наши
    for (i=1; i<=9; i++)
    {
		sld = GetCharacter(NPC_GenerateCharacter("MPCrew_"+i, "citiz_"+(rand(9)+31), "man", "man", iRank, sti(pchar.nation), 0, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_10", "pistol1", "bullet", iScl*2);
        LAi_SetWarriorType(sld);
        LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		sTemp = LAi_FindNearestFreeLocator("goto", locx, locy, locz);
		if (sTemp == "") sTemp = LAi_FindNearestLocator("goto", locx, locy, locz);
        ChangeCharacterAddressGroup(sld, pchar.GenQuest.Marginpassenger.Shore, "goto", sTemp);
    }
	//враги
	for (int i=1; i <=n; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("MPEnemy_"+i, "mush_spa_1", "man", "mushketer", iRank+3, SPAIN, 0, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank+3, iScl+2, iScl+2, "", "mushket1", "cartridge", iScl*2);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("MPEnemy_"+i, "sold_spa_"+(rand(7)+1), "man", "man", iRank+3, SPAIN, 0, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank+3, iScl+2, iScl+2, "blade_10", "pistol1", "bullet", iScl*2);
		}
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		ChangeCharacterAddressGroup(sld, pchar.GenQuest.Marginpassenger.Shore, "reload", "reload1");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	sld = GetCharacter(NPC_GenerateCharacter("Spa_shore_off", "off_spa_"+(rand(1)+1), "man", "man", iRank+5, SPAIN, -1, true, "soldier"));
	FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_10", "pistol5", "bullet", iScl*3);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	ChangeCharacterAddressGroup(sld, pchar.GenQuest.Marginpassenger.Shore, "reload", "reload1");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Marginpassenger_Afterbattle");
}

void Marginpassenger_SouthshipInWorld(string qName)//запускаем кораблик с деревом на карте
{
    string sGroup = "Sea_SouthshipCap1";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 3*sti(pchar.rank)+10;
	int iDays = GetMaxDaysFromIsland2Island(GetArealByCityName(pchar.GenQuest.Marginpassenger.Southcity1), GetArealByCityName(pchar.GenQuest.Marginpassenger.Southcity))+5;
	sTemp = pchar.GenQuest.Marginpassenger.ShipName1;
	sld = GetCharacter(NPC_GenerateCharacter("SouthshipCap", "citiz_41"+(rand(9)), "man", "man", iRank, SPAIN, iDays, true, "quest"));
	FantomMakeSmallSailor(sld, SHIP_BARKENTINE, sTemp, CANNON_TYPE_CANNON_LBS12, iScl+10, iScl, iScl, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_13", "pistol1", "bullet", 100);
	SetCaptanModelByEncType(sld, "trade");
	sld.Ship.Mode = "trade";
	SetRandomNameToCharacter(sld);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.AlwaysEnemy = true;
	SetCharacterPerk(sld, "HullDamageUp");
	SetCharacterPerk(sld, "SailsDamageUp");
	SetCharacterPerk(sld, "CrewDamageUp");
	SetCharacterPerk(sld, "CriticalShoot");
	SetCharacterPerk(sld, "AdvancedBattleState");
	SetCharacterPerk(sld, "ShipTurnRateUp");
	SetCharacterPerk(sld, "ShipSpeedUp");
	AddCharacterGoods(sld, sti(pchar.GenQuest.Marginpassenger.Goods), sti(pchar.GenQuest.Marginpassenger.GoodsQty));//положить в трюм древесину
	sld.mapEnc.type = "trade";
	sld.mapEnc.worldMapShip = "ranger";
	sld.mapEnc.Name = "barquentine '"+pchar.GenQuest.Marginpassenger.ShipName1 + "'";
	Group_AddCharacter(sGroup, "SouthshipCap");
	Group_SetGroupCommander(sGroup, "SouthshipCap");
	Map_CreateTrader(pchar.GenQuest.Marginpassenger.Southcity, pchar.GenQuest.Marginpassenger.Southcity1, "SouthshipCap", iDays);
	SetFunctionTimerCondition("Marginpassenger_SouthshipInWorldOver", 0, 0, iDays, false);
	pchar.quest.Marginpassenger_Sink1.win_condition.l1 = "Character_sink";
	pchar.quest.Marginpassenger_Sink1.win_condition.l1.character = "SouthshipCap";
	pchar.quest.Marginpassenger_Sink1.function = "Marginpassenger_SouthshipFail";//потопили
	pchar.quest.Marginpassenger_Abordage1.win_condition.l1 = "Character_Capture";
	pchar.quest.Marginpassenger_Abordage1.win_condition.l1.character = "SouthshipCap";
	pchar.quest.Marginpassenger_Abordage1.function = "Marginpassenger_SouthshipWin";//взяли на абордаж
}

void Marginpassenger_SouthshipInWorldOver(string qName)//упустили кораблик
{
	pchar.quest.Marginpassenger_Sink1.over = "yes"; //снять прерывание
	pchar.quest.Marginpassenger_Abordage1.over = "yes"; //снять прерывание
	AddQuestRecord("Marginpassenger", "17");
	AddQuestUserData("Marginpassenger", "sShipName", pchar.GenQuest.Marginpassenger.ShipName1);
	CloseQuestHeader("Marginpassenger");
	Group_DeleteGroup("Sea_SouthshipCap1");
	DeleteAttribute(Pchar, "GenQuest.Marginpassenger");
	ChangeCharacterComplexReputation(pchar, "authority", -1);
	ChangeOfficersLoyality("bad_all", 1);
}

void Marginpassenger_SouthshipFail(string qName)//потопили в бою
{
	pchar.quest.Marginpassenger_SouthshipInWorldOver.over = "yes"; //снять прерывание
	pchar.quest.Marginpassenger_Abordage1.over = "yes"; //снять прерывание
	Group_DeleteGroup("Sea_SouthshipCap1");
	AddQuestRecord("Marginpassenger", "18");
	AddQuestUserData("Marginpassenger", "sShipName", pchar.GenQuest.Marginpassenger.ShipName1);
	CloseQuestHeader("Marginpassenger");
	DeleteAttribute(Pchar, "GenQuest.Marginpassenger");
	AddComplexSeaExpToScill(50, 50, 50, 0, 50, 50, 0);
}

void Marginpassenger_SouthshipWin(string qName)//абордировали
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.Marginpassenger_SouthshipInWorldOver.over = "yes"; //снять прерывание
	pchar.quest.Marginpassenger_Sink1.over = "yes"; //снять прерывание
	Group_DeleteGroup("Sea_SouthshipCap1");
	AddQuestRecord("Marginpassenger", "19");
	AddQuestUserData("Marginpassenger", "sShipName", pchar.GenQuest.Marginpassenger.ShipName1);
	CloseQuestHeader("Marginpassenger");
	DeleteAttribute(Pchar, "GenQuest.Marginpassenger");
	AddComplexSeaExpToScill(100, 100, 100, 150, 100, 100, 0);
	AddComplexSelfExpToScill(50, 50, 50, 50);
	ChangeCharacterComplexReputation(pchar, "authority", 1);
	ChangeOfficersLoyality("good_all", 1);
	ChangeCharacterNationReputation(pchar, SPAIN, -1);
}
//<-- мини-квесты темных личностей

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Jason -------------------------------------мини-квесты бродячих капитанов----------------------------------
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
void MarchCap_Create(string qName)//ставим кораблик
{
	log_Testinfo("Прерывание отработало");
	int iRank = sti(pchar.GenQuest.MarchCap.rank);
	int iNation = sti(pchar.GenQuest.MarchCap.basenation);
	int iShip = sti(pchar.GenQuest.MarchCap.shiptype);
	sTemp = pchar.GenQuest.MarchCap.model;
	pchar.GenQuest.MarchCap.begin = "true";
	Group_FindOrCreateGroup("MarchGroup");
	sld = GetCharacter(NPC_GenerateCharacter("MarchCap", sTemp, "man", "man", iRank, iNation, -1, false, "quest"));
	sld.Dialog.Filename = "Quest\MarchCap_dialog.c";
	sld.DeckDialogNode = "MarchCap";
	sld.name = pchar.GenQuest.MarchCap.name;
	sld.lastname = pchar.GenQuest.MarchCap.lastname;
	SetFantomParamFromRank(sld, iRank, true);
	sld.Ship.Type = GenerateShipExt(iShip, true, sld);
	sld.ship.name = pchar.GenQuest.MarchCap.shipname;
	sld.ship.mode = "trade";
	SetBaseShipData(sld);
	SetCrewQuantityFull(sld);
	Fantom_SetCannons(sld, "war");
	Fantom_SetBalls(sld, "pirate");
	Fantom_SetGoods(sld, "war");
	SetFantomParamHunter(sld); //крутые парни
	sld.AlwaysFriend = true;
	sld.DontRansackCaptain = true; //Desperado фикс спасения на шлюпке
	Character_SetAbordageEnable(sld, false);
	Group_AddCharacter("MarchGroup", "MarchCap");
	Group_SetGroupCommander("MarchGroup", "MarchCap");
	Group_SetAddress("MarchGroup", pchar.GenQuest.MarchCap.Startisland, "quest_ships", "quest_ship_1");
}

void MarchCap_Over(string qName)//снимаем кораблик 
{
	if (CheckAttribute(pchar, "GenQuest.MarchCap.begin"))
	{
		sld = characterFromId("MarchCap");
		sld.lifeday = 0;
		LAi_CharacterDisableDialog(sld);
		sld.DontDeskTalk = true;
	}
	else pchar.quest.MarchCap_Create.over = "yes"; //снять прерывание
	DeleteAttribute(pchar, "GenQuest.MarchCap"); // diffix
}

void MarchCap1_CreateConvoy(string qName)//конвой на боевой карте
{
	log_Testinfo("Прерывание отработало");
	pchar.quest.MarchCap_Attack_Over.over = "yes"; //снять прерывание
	pchar.quest.MarchCap1_fail.over = "yes"; //снять прерывание
	Island_SetReloadEnableGlobal(pchar.GenQuest.MarchCap.Island, false);//на остров нельзя
	pchar.GenQuest.MarchCap.StartGoodsQty = GetSquadronGoods(pchar, sti(pchar.GenQuest.MarchCap.Goods));//это столько целевого товара было в трюмах до боя, если было
	Group_DeleteGroup("MarchCap_Attack");
	Group_FindOrCreateGroup("MarchCap_Attack");
	int iNation = sti(pchar.GenQuest.MarchCap.Nation);
	int iRank = sti(PChar.rank)+5;
	int iGoods = sti(pchar.GenQuest.MarchCap.Goods);
	int iSpace;
	//сопровождение
	SelectLevelWarShipParameter();
	sld = GetCharacter(NPC_GenerateCharacter("MrCGuard", "off_"+NationShortName(iNation)+"_"+(rand(5)+1), "man", "man", iRank+3, iNation, 2, true, "quest"));
	SetFantomParamFromRank(sld, iRank+3, true);
	sld.Ship.Type = GenerateShipExt(iGlobalTemp, 1, sld);
	SetRandomNameToShip(sld);
	SetBaseShipData(sld);
	SetCrewQuantityFull(sld);
	Fantom_SetCannons(sld, "war");
	Fantom_SetBalls(sld, "pirate");
	Fantom_SetGoods(sld, "war");
	SetFantomParamHunter(sld); //крутые парни
	sld.AlwaysEnemy = true;
	sld.ship.mode = "war";
	Group_AddCharacter("MarchCap_Attack", "MrCGuard");
    for (int i = 1; i <= 2; i++)//торговцы
    {
		SelectLevelTradeShipParameter();
        sld = GetCharacter(NPC_GenerateCharacter("MrCTrade_"+i, "trader_"+(rand(15)+1), "man", "man", iRank, iNation, 2, true, "quest"));
		sld.Ship.Type = GenerateShipExt(iGlobalTemp, 1, sld);
		SetFantomParamFromRank(sld, iRank, true);
		SetRandomNameToShip(sld);
		SetBaseShipData(sld);
		SetCrewQuantityFull(sld);
		Fantom_SetCannons(sld, "war");
		SetCaptanModelByEncType(sld, "trade");
		sld.AlwaysEnemy = true;
		sld.ship.mode = "trade";
		iSpace = GetCharacterFreeSpace(sld, iGoods);
		iSpace = makeint(iSpace/2 + (iSpace/2.5));
		Fantom_SetCharacterGoods(sld, iGoods, iSpace, 1);
        Group_AddCharacter("MarchCap_Attack", "MrCTrade_"+i);
    }
    Group_SetGroupCommander("MarchCap_Attack", "MrCGuard");
	Group_SetTaskRunAway("MarchCap_Attack", PLAYER_GROUP);
	Group_SetAddress("MarchCap_Attack", pchar.GenQuest.MarchCap.Island, "Quest_Ships", "Quest_Ship_" + (3+rand(4)));
	Group_LockTask("MarchCap_Attack");
	
	pchar.quest.MarchCap1_fail1.win_condition.l1 = "NPC_Death";
	pchar.quest.MarchCap1_fail1.win_condition.l1.character = "MarchCap";
	pchar.quest.MarchCap1_fail1.function = "MarchCap1_fail";
    pchar.quest.MarchCap1_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.MarchCap1_AfterBattle.win_condition.l1.group = "MarchCap_Attack";
	pchar.quest.MarchCap1_AfterBattle.function = "MarchCap1_AfterBattle";
}

void MarchCap_Attack_Over(string qName)//время вышло
{
	pchar.quest.MarchCap1_1.over = "yes"; //снять прерывание
	pchar.quest.MarchCap1_2.win_condition.l1 = "MapEnter";
	pchar.quest.MarchCap1_2.function = "MarchCap_DeckTalk";
	pchar.GenQuest.MarchCap.late = "true";
}

void MarchCap_fail(string qName)//компаньон погиб по пути
{
	if (!CheckAttribute(pchar, "GenQuest.MarchCap.WdmEnc")) pchar.quest.MarchCap_Attack_Over.over = "yes"; //снять прерывание
	pchar.quest.MarchCap1_1.over = "yes"; //снять прерывание
	sld = characterFromId("MarchCap");	
	AddQuestRecord("MarchCap", "3");
	AddQuestUserData("MarchCap", "sName", GetFullName(sld));
	CloseQuestHeader("MarchCap");
	DeleteAttribute(pchar, "GenQuest.MarchCap");
}

void MarchCap1_fail(string qName)//компаньон погиб в бою
{
	if (CheckAttribute(pchar, "GenQuest.MarchCap.Pirate")) pchar.quest.MarchCap1_DieHard.over = "yes"; //снять прерывание
	Island_SetReloadEnableGlobal(pchar.GenQuest.MarchCap.Island, true);//на остров можно
	pchar.quest.MarchCap1_AfterBattle.over = "yes"; //снять прерывание
	sld = characterFromId("MarchCap");	
	AddQuestRecord("MarchCap", "4");
	AddQuestUserData("MarchCap", "sName", GetFullName(sld));
	CloseQuestHeader("MarchCap");
	DeleteAttribute(pchar, "GenQuest.MarchCap");
}

void MarchCap_DeckTalk(string qName)//разговор на палубе
{
	if (CheckAttribute(pchar, "GenQuest.MarchCap.DieHard"))
	{
		pchar.quest.MarchCap1_AfterBattle.over = "yes"; //снять прерывание
		Island_SetReloadEnableGlobal(pchar.GenQuest.MarchCap.Island, true);//на остров можно
		Group_DeleteGroup("MarchCap_Attack");
	}
	pchar.quest.MarchCap1_3.over = "yes"; //снять прерывание
	pchar.quest.MarchCap1_4.over = "yes"; //снять прерывание
	aref arOldMapPos;
	makearef(arOldMapPos, worldMap.old);
	WdmPrepareMapForAbordage(arOldMapPos);
	MakeCloneShipDeck(pchar, true);//клон палубы
	LAi_LocationFightDisable(&Locations[FindLocation("Ship_deck")], true);
	DoReloadFromWorldMapToLocation("Ship_deck", "goto", "goto1");
	LAi_LockFightMode(pchar, true);
	sld = characterFromId("MarchCap");
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "Ship_deck", "goto", "goto2");
	if (CheckAttribute(pchar, "GenQuest.MarchCap.late")) sld.dialog.currentnode = "MarchCap_TimeOver";
	else
	{
		if (CheckAttribute(pchar, "GenQuest.MarchCap.DieHard")) sld.dialog.currentnode = "MarchCap_DieHard";
		else
		{
			if (CheckAttribute(pchar, "GenQuest.MarchCap.Pirate")) sld.dialog.currentnode = "MarchCap_AfterBattleGold";
	else sld.dialog.currentnode = "MarchCap_AfterBattle";
		}
	}
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	pchar.quest.Munity = "";//чтобы не выскочил без разговора
	pchar.GenQuest.MarchCap.Deck = "true";
}

void MarchCap_LandTalk(string qName)//разговор на суше
{
	pchar.quest.MarchCap1_2.over = "yes"; //снять прерывание
	pchar.quest.MarchCap1_3.over = "yes"; //снять прерывание
	pchar.quest.MarchCap1_4.over = "yes"; //снять прерывание
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("MarchCap");
	LAi_SetActorType(sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	if (CheckAttribute(pchar, "GenQuest.MarchCap.Pirate")) sld.dialog.currentnode = "MarchCap_AfterBattleGold";
	else sld.dialog.currentnode = "MarchCap_AfterBattle";
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void MarchCap1_AfterBattle(string qName)//после боя или истечения времени существования конвоя
{
	pchar.quest.MarchCap1_fail1.over = "yes"; //снять прерывание
	if (CheckAttribute(pchar, "GenQuest.MarchCap.WdmEnc")) Group_DeleteGroup("Sea_WorldMarchCap1");
	else
	{
		if (CheckAttribute(pchar, "GenQuest.MarchCap.Pirate"))
		{
			DeleteAttribute(pchar, "GenQuest.MarchCap.DieHard");
			pchar.quest.MarchCap1_DieHard.over = "yes"; //снять прерывание
		}
		Island_SetReloadEnableGlobal(pchar.GenQuest.MarchCap.Island, true);//на остров можно
		Group_DeleteGroup("MarchCap_Attack");
	}
	pchar.quest.MarchCap1_2.win_condition.l1 = "MapEnter";
	pchar.quest.MarchCap1_2.function = "MarchCap_DeckTalk";//раздел добычи в море
	pchar.quest.MarchCap1_3.win_condition.l1 = "Location_Type";
	pchar.quest.MarchCap1_3.win_condition.l1.location_type = "seashore";
	pchar.quest.MarchCap1_3.function = "MarchCap_LandTalk";//раздел добычи на суше
	pchar.quest.MarchCap1_4.win_condition.l1 = "Location_Type";
	pchar.quest.MarchCap1_4.win_condition.l1.location_type = "town";
	pchar.quest.MarchCap1_4.function = "MarchCap_LandTalk";//раздел добычи на суше
	pchar.quest.MarchCap1_fail2.win_condition.l1 = "NPC_Death";
	pchar.quest.MarchCap1_fail2.win_condition.l1.character = "MarchCap";
	pchar.quest.MarchCap1_fail2.function = "MarchCap1_killed";
}

void MarchCap1_killed(string qName)//сам потопил компаньона
{
	pchar.quest.MarchCap1_2.over = "yes"; //снять прерывание
	pchar.quest.MarchCap1_3.over = "yes"; //снять прерывание
	pchar.quest.MarchCap1_4.over = "yes"; //снять прерывание
	AddQuestRecord("MarchCap", "9");
	CloseQuestHeader("MarchCap");
	DeleteAttribute(pchar, "GenQuest.MarchCap");//почистим кучу лишних атрибутов
	pchar.GenQuest.MarchCap = "true"; //больше квеста не будет
}

void MarchCap2_CreateConvoy(string qName)//конвой на карте
{
	string sCapId = "WorldMarchCap";
    string sGroup = "Sea_" + sCapId + "1";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	int iNation = sti(pchar.GenQuest.MarchCap.Nation);
	int iRank = sti(PChar.rank)+5;
	int iGoods = sti(pchar.GenQuest.MarchCap.Goods);
	int iDays = GetMaxDaysFromIsland2Island(GetArealByCityName(pchar.GenQuest.MarchCap.Finishcity), GetArealByCityName(pchar.GenQuest.MarchCap.Startcity))+5;
	int iSpace;
	for (int i = 1; i <= 3; i++)
    {
		sld = GetCharacter(NPC_GenerateCharacter(sCapId + i, "citiz_41", "man", "man", iRank, iNation, iDays, true, "quest"));
		SetRandomNameToCharacter(sld);
		SetRandomNameToShip(sld);
		SetFantomParamFromRank(sld, iRank, true);
		if (i == 1)
		{
			SelectLevelWarShipParameter();
			sld.Ship.Type = GenerateShipExt(iGlobalTemp, 1, sld);
			SetCaptanModelByEncType(sld, "war");
			sld.ship.mode = "war";
			SetFantomParamHunter(sld); //крутые парни
		}
		else
		{
			SelectLevelTradeShipParameter();
			sld.Ship.Type = GenerateShipExt(iGlobalTemp, 1, sld);
			SetCaptanModelByEncType(sld, "trade");
			sld.ship.mode = "trade";
		}
		SetBaseShipData(sld);
		SetCrewQuantityFull(sld);
		Fantom_SetCannons(sld, "war");
		sld.AlwaysEnemy = true;
		sld.AnalizeShips = true;
		if (i == 2 || i == 3)
		{
			iSpace = GetCharacterFreeSpace(sld, iGoods);
			iSpace = makeint(iSpace/2 + (iSpace/2.5));
			Fantom_SetCharacterGoods(sld, iGoods, iSpace, 1);
		}
		sld.mapEnc.type = "war";
		sld.mapEnc.worldMapShip = "quest_ship";
        sld.mapEnc.Name = "trading convoy";
        Group_AddCharacter(sGroup, sCapId + i);
	}
	Group_SetGroupCommander(sGroup, sCapId+ "1");
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
	Map_CreateTrader(pchar.GenQuest.MarchCap.Startcity, pchar.GenQuest.MarchCap.Finishcity, sCapId + "1", iDays);//запуск энкаунтера
	SetFunctionTimerCondition("MarchCap2_Attack_Over", 0, 0, iDays+1, false); //таймер на нахождение
	pchar.quest.MarchCap1_fail.over = "yes"; //снять прерывание
	pchar.quest.MarchCap2_fail.win_condition.l1 = "NPC_Death";
	pchar.quest.MarchCap2_fail.win_condition.l1.character = "MarchCap";
	pchar.quest.MarchCap2_fail.function = "MarchCap2_fail";
}

void MarchCap2_fail(string qName)//компаньон погиб по пути при движении энкаунтера
{
	sld = characterFromId("MarchCap");	
	AddQuestRecord("MarchCap", "3-1");
	AddQuestUserData("MarchCap", "sName", GetFullName(sld));
	CloseQuestHeader("MarchCap");
	DeleteAttribute(pchar, "GenQuest.MarchCap");
}

void MarchCap2_Attack_Over(string qName)//истекло время на нахождение
{
	pchar.quest.MarchCap2_fail.over = "yes"; //снять прерывание
	pchar.quest.MarchCap1_2.win_condition.l1 = "MapEnter";
	pchar.quest.MarchCap1_2.function = "MarchCap_DeckTalk";
	pchar.GenQuest.MarchCap.late = "true";
}

void MarchCap2_CheckBattle(string qName)//признак вступления в бой
{
	pchar.GenQuest.MarchCap.Battlestart = "true";//атрибут начатого боя
	pchar.GenQuest.MarchCap.StartGoodsQty = GetSquadronGoods(pchar, sti(pchar.GenQuest.MarchCap.Goods));//это столько целевого товара было в трюмах до боя, если было
	pchar.quest.MarchCap2_fail.over = "yes"; //снять прерывание
	pchar.quest.MarchCap2_Attack_Over.over = "yes"; //снять таймер
	sld = characterFromId("WorldMarchCap1");
	sld.lifeday = 0;
	log_Testinfo("Релиз энкаунтера по выходу на карту!");
	pchar.quest.MarchCap1_fail1.win_condition.l1 = "NPC_Death";
	pchar.quest.MarchCap1_fail1.win_condition.l1.character = "MarchCap";
	pchar.quest.MarchCap1_fail1.function = "MarchCap1_fail";
    pchar.quest.MarchCap1_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.MarchCap1_AfterBattle.win_condition.l1.group = "Sea_WorldMarchCap1";
	pchar.quest.MarchCap1_AfterBattle.function = "MarchCap1_AfterBattle";
}

void MarchCap3_CreatePirate(string qName)//пират с золотишком
{
	pchar.GenQuest.MarchCap.StartGoodsQty = GetSquadronGoods(pchar, sti(pchar.GenQuest.MarchCap.Goods));//это столько целевого товара было в трюмах до боя, если было
	pchar.quest.MarchCap_Attack_Over.over = "yes"; //снять таймер
	pchar.quest.MarchCap1_fail.over = "yes"; //снять прерывание
	Island_SetReloadEnableGlobal(pchar.GenQuest.MarchCap.Island, false);//закрыть остров
	pchar.GenQuest.MarchCap.DieHard = "true"; //атрибут бегства
	Group_DeleteGroup("MarchCap_Attack");
	Group_FindOrCreateGroup("MarchCap_Attack");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 3*sti(pchar.rank)+10;
	int iShipType = sti(pchar.GenQuest.MarchCap.ShipType);
	int iCannon = sti(pchar.GenQuest.MarchCap.Cannon);
	sld = GetCharacter(NPC_GenerateCharacter("MarchPirate", "mercen_"+(rand(27)+1), "man", "man", iRank, PIRATE, 1, true, "quest"));
	FantomMakeCoolSailor(sld, iShipType, "", iCannon, iScl+25, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_10", "pistol1", "bullet", iScl*2);
	sld.name = GetName(NAMETYPE_ORIG, pchar.GenQuest.MarchCap.PirateName, NAME_NOM));
	sld.lastname = "";
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	switch (drand(5))
	{
		case 0: UpgradeShipParameter(sld, "TurnRate"); break;
		case 1: UpgradeShipParameter(sld, "Capacity"); break;
		case 2: UpgradeShipParameter(sld, "MaxCrew"); break;
		case 3: UpgradeShipParameter(sld, "HP"); break;
		case 4: UpgradeShipParameter(sld, "SpeedRate"); break;
		case 5: UpgradeShipParameter(sld, "WindAgainstSpeed"); break;
	}
	Group_AddCharacter("MarchCap_Attack", "MarchPirate");
	sld.AlwaysEnemy = true;
	sld.AnalizeShips = true;
	AddCharacterGoods(sld, sti(pchar.GenQuest.MarchCap.Goods), sti(pchar.GenQuest.MarchCap.GoodsQty));//положить золото-серебро
	Group_SetGroupCommander("MarchCap_Attack", "MarchPirate");
	Group_SetTaskAttack("MarchCap_Attack", PLAYER_GROUP);
	Group_SetAddress("MarchCap_Attack", pchar.GenQuest.MarchCap.Island, "Quest_Ships", "Quest_Ship_"+(3+rand(4)));
	Group_LockTask("MarchCap_Attack");
	
	pchar.quest.MarchCap1_fail1.win_condition.l1 = "NPC_Death";
	pchar.quest.MarchCap1_fail1.win_condition.l1.character = "MarchCap";
	pchar.quest.MarchCap1_fail1.function = "MarchCap1_fail";
	pchar.quest.MarchCap1_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.MarchCap1_AfterBattle.win_condition.l1.group = "MarchCap_Attack";
	pchar.quest.MarchCap1_AfterBattle.function = "MarchCap1_AfterBattle";
	pchar.quest.MarchCap1_DieHard.win_condition.l1 = "MapEnter";
	pchar.quest.MarchCap1_DieHard.function = "MarchCap_DeckTalk";
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Jason ---------------------------------- новые генераторы губернаторов ----------------------------------
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//--> Контркурьер
void TakePostcureer_CreateShip(string qName)
{
	Log_Info("Enemy vessel is on the horizon!");
	DoQuestCheckDelay("see_sails", 1.3);
	pchar.quest.AllMayorsQuests_Late.over = "yes"; //снимаем общий таймер
	Island_SetReloadEnableGlobal(pchar.GenQuest.TakePostcureer.Island, false);//на остров нельзя
	int iNation = sti(pchar.GenQuest.TakePostcureer.Nation);
	int iRank = sti(pchar.rank)+makeint(MOD_SKILL_ENEMY_RATE/2)+2;
	int iScl = 2*sti(pchar.rank)+10;
	int iShipType = sti(pchar.GenQuest.TakePostcureer.ShipType);
	int iCannon = sti(pchar.GenQuest.TakePostcureer.Cannon);
	string sShipName = pchar.GenQuest.TakePostcureer.ShipName;
	Group_FindOrCreateGroup("ContraCureer");
	Group_SetType("ContraCureer", "war");//тип группы
	sld = GetCharacter(NPC_GenerateCharacter("ContraCureerCap", "off_"+NationShortName(iNation)+"_"+(rand(5)+1), "man", "man", iRank, iNation, -1, true, "quest"));
	FantomMakeSmallSailor(sld, iShipType, sShipName, iCannon, iScl, iScl, iScl, iScl, iScl);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.AlwaysEnemy = true;
	sld.Ship.Mode = "war";
	Group_AddCharacter("ContraCureer", "ContraCureerCap");
	Group_SetGroupCommander("ContraCureer", "ContraCureerCap");
	Group_SetTaskAttack("ContraCureer", PLAYER_GROUP);
	Group_SetAddress("ContraCureer", pchar.GenQuest.TakePostcureer.Island, "Quest_Ships", "Quest_Ship_"+(3+rand(4)));
	Group_LockTask("ContraCureer");
	
	pchar.quest.ContraCureer_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.ContraCureer_AfterBattle.win_condition.l1.group = "ContraCureer";
	pchar.quest.ContraCureer_AfterBattle.function = "ContraCureer_AfterBattle";
	pchar.quest.ContraCureer_DieHard.win_condition.l1 = "MapEnter";
	pchar.quest.ContraCureer_DieHard.function = "ContraCureer_DieHard";
}

void ContraCureer_AfterBattle(string qName)//победили
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.ContraCureer_DieHard.over = "yes";
	Group_DeleteGroup("ContraCureer");
	Island_SetReloadEnableGlobal(pchar.GenQuest.TakePostcureer.Island, true);
	if (CheckCharacterItem(pchar, "ContraPostLetters"))
	{
		AddComplexSeaExpToScill(150, 100, 100, 100, 100, 100, 0);
		ChangeOfficersLoyality("good_all", 1);
		AddQuestRecord("MayorsQuestsList", "4");
		pchar.GenQuest.TakePostcureer = "Execute"; //флаг выполнил успешно
	}
	else
	{
		ChangeOfficersLoyality("bad_all", 1);
		AddQuestRecord("MayorsQuestsList", "4-1");
		pchar.GenQuest.TakePostcureer = "Found"; //флаг провалил
	}
}

void ContraCureer_DieHard(string qName)//сбежали
{
	pchar.quest.ContraCureer_AfterBattle.over = "yes";
	Group_DeleteGroup("ContraCureer");
	Island_SetReloadEnableGlobal(pchar.GenQuest.TakePostcureer.Island, true);
	AddQuestRecord("MayorsQuestsList", "5");
	pchar.GenQuest.TakePostcureer = "Found"; //флаг провалил
}
//<-- Контркурьер

//--> Контрфрахт - арсенал
void TakeArsenalship_CreateShip(string qName)
{
	Log_Info("Enemy convoy is on the horizon!");
	DoQuestCheckDelay("see_sails", 1.3);
	pchar.quest.AllMayorsQuests_Late.over = "yes"; //снимаем общий таймер
	Island_SetReloadEnableGlobal(pchar.GenQuest.TakeArsenalship.Island, false);//на остров нельзя
	int iNation = sti(pchar.GenQuest.TakeArsenalship.Nation);
	int iRank = sti(pchar.rank)+makeint(MOD_SKILL_ENEMY_RATE/2)+2;
	int iScl = 2*sti(pchar.rank)+10;
	int iShipType = sti(pchar.GenQuest.TakeArsenalship.ShipType);
	int iShipTypeA = sti(pchar.GenQuest.TakeArsenalship.ShipTypeA);
	int iCannon = sti(pchar.GenQuest.TakeArsenalship.Cannon);
	int iCannonA = sti(pchar.GenQuest.TakeArsenalship.CannonA);
	string sShipName = pchar.GenQuest.TakeArsenalship.ShipName;
	Group_FindOrCreateGroup("ContraCureer");
	Group_SetType("ContraCureer", "war");//тип группы
	sld = GetCharacter(NPC_GenerateCharacter("ContraCureerCap", "off_"+NationShortName(iNation)+"_"+(rand(5)+1), "man", "man", iRank, iNation, -1, true, "quest"));
	FantomMakeSmallSailor(sld, iShipTypeA, "", iCannonA, iScl, iScl, iScl, iScl, iScl); // Addon 2016-1 Jason пиратская линейка
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "war";
	Group_AddCharacter("ContraCureer", "ContraCureerCap");
	sld = GetCharacter(NPC_GenerateCharacter("ContraArsCap", "off_"+NationShortName(iNation)+"_"+(rand(5)+1), "man", "man", iRank, iNation, -1, true, "quest"));
	FantomMakeSmallSailor(sld, iShipType, sShipName, iCannon, iScl, iScl, iScl, iScl, iScl);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.AlwaysEnemy = true;
	sld.Ship.Mode = "war";
	if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
	int iGoods = GOOD_BALLS + drand(makeint(GOOD_BOMBS - GOOD_BALLS));
	int iSpace = GetCharacterFreeSpace(sld, iGoods);
	iSpace = makeint(iSpace/4);
	AddCharacterGoods(sld, iGoods, iSpace);
	AddCharacterGoods(sld, GOOD_POWDER, iSpace);
	AddCharacterGoods(sld, GOOD_WEAPON, 1000+rand(1000));
	AddCharacterGoods(sld, GOOD_BALLS, 500);
	AddCharacterGoods(sld, GOOD_GRAPES, 1000);
	AddCharacterGoods(sld, GOOD_KNIPPELS, 500);
	AddCharacterGoods(sld, GOOD_BOMBS, 500);
	Group_AddCharacter("ContraCureer", "ContraArsCap");
	Group_SetGroupCommander("ContraCureer", "ContraCureerCap");
	Group_SetTaskAttack("ContraCureer", PLAYER_GROUP);
	Group_SetAddress("ContraCureer", pchar.GenQuest.TakeArsenalship.Island, "Quest_Ships", "Quest_Ship_"+(3+rand(4)));
	Group_LockTask("ContraCureer");
	
	pchar.quest.ContraArs_AfterBattle.win_condition.l1 = "NPC_Death";
	pchar.quest.ContraArs_AfterBattle.win_condition.l1.character = "ContraArsCap";
	pchar.quest.ContraArs_AfterBattle.function = "ContraArs_AfterBattle";
	pchar.quest.ContraArs_DieHard.win_condition.l1 = "MapEnter";
	pchar.quest.ContraArs_DieHard.function = "ContraArs_DieHard";
}

void ContraArs_AfterBattle(string qName)//победили
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.ContraArs_DieHard.over = "yes";
	//Group_DeleteGroup("ContraCureer");
	Island_SetReloadEnableGlobal(pchar.GenQuest.TakeArsenalship.Island, true);
	AddComplexSeaExpToScill(150, 100, 100, 100, 100, 100, 0);
	ChangeOfficersLoyality("good_all", 1);
	AddQuestRecord("MayorsQuestsList", "8-1");
	pchar.GenQuest.TakeArsenalship = "Execute"; //флаг выполнил успешно
}

void ContraArs_DieHard(string qName)//сбежали
{
	pchar.quest.ContraArs_AfterBattle.over = "yes";
	Group_DeleteGroup("ContraCureer");
	Island_SetReloadEnableGlobal(pchar.GenQuest.TakeArsenalship.Island, true);
	ChangeOfficersLoyality("bad_all", 1);
	AddQuestRecord("MayorsQuestsList", "5");
	pchar.GenQuest.TakeArsenalship = "Found"; //флаг провалил
}
//<-- Контрфрахт - арсенал

//--> ОЗГ - пират
void TakePirateship_CreateShip(string qName)
{
	Log_Info("Pirate vessel in on the horizon!");
	DoQuestCheckDelay("see_sails", 1.3);
	pchar.quest.AllMayorsQuests_Late.over = "yes"; //снимаем общий таймер
	Island_SetReloadEnableGlobal(pchar.GenQuest.TakePirateship.Island, false);//на остров нельзя
	int iRank = sti(pchar.rank)+makeint(MOD_SKILL_ENEMY_RATE/2)+5;
	int iScl = 2*sti(pchar.rank)+15;
	int iShipType = sti(pchar.GenQuest.TakePirateship.ShipType);
	int iCannon = sti(pchar.GenQuest.TakePirateship.Cannon);
	string sShipName = pchar.GenQuest.TakePirateship.ShipName;
	Group_FindOrCreateGroup("ContraCureer");
	Group_SetType("ContraCureer", "pirate");//тип группы
	sld = GetCharacter(NPC_GenerateCharacter("ContraCureerCap", "citiz_"+(rand(9)+51), "man", "man", iRank, PIRATE, -1, true, "quest"));
	sld.name = pchar.GenQuest.TakePirateship.Name;
	sld.lastname = "";
	FantomMakeSmallSailor(sld, iShipType, sShipName, iCannon, iScl, iScl, iScl, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_05", "pistol1", "bullet", 50);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.WatchFort = true;
	sld.AlwaysEnemy = true;
	sld.Ship.Mode = "pirate";
	SetCharacterPerk(sld, "MusketsShoot");
	int iGoods = GOOD_CHOCOLATE + drand(makeint(GOOD_COTTON - GOOD_CHOCOLATE));
	int iSpace = GetCharacterFreeSpace(sld, iGoods);
	iSpace = makeint(iSpace/2);
	AddCharacterGoods(sld, iGoods, iSpace);
	Group_AddCharacter("ContraCureer", "ContraCureerCap");
	Group_SetGroupCommander("ContraCureer", "ContraCureerCap");
	Group_SetTaskAttack("ContraCureer", PLAYER_GROUP);
	Group_SetAddress("ContraCureer", pchar.GenQuest.TakePirateship.Island, "Quest_Ships", "Quest_Ship_"+(3+rand(4)));
	Group_LockTask("ContraCureer");
	
	pchar.quest.ContraCureer_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.ContraCureer_AfterBattle.win_condition.l1.group = "ContraCureer";
	pchar.quest.ContraCureer_AfterBattle.function = "ContraPirate_AfterBattle";
	pchar.quest.ContraCureer_DieHard.win_condition.l1 = "MapEnter";
	pchar.quest.ContraCureer_DieHard.function = "ContraPirate_DieHard";
}

void ContraPirate_AfterBattle(string qName)//победили
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.ContraCureer_DieHard.over = "yes";
	Group_DeleteGroup("ContraCureer");
	Island_SetReloadEnableGlobal(pchar.GenQuest.TakePirateship.Island, true);
	AddComplexSeaExpToScill(200, 150, 150, 150, 150, 150, 0);
	ChangeOfficersLoyality("good_all", 1);
	AddQuestRecord("MayorsQuestsList", "9-1");
	pchar.GenQuest.TakePirateship = "Execute"; //флаг выполнил успешно
}

void ContraPirate_DieHard(string qName)//сбежали
{
	pchar.quest.ContraCureer_AfterBattle.over = "yes";
	Group_DeleteGroup("ContraCureer");
	Island_SetReloadEnableGlobal(pchar.GenQuest.TakePirateship.Island, true);
	ChangeOfficersLoyality("bad_all", 1);
	AddQuestRecord("MayorsQuestsList", "5");
	pchar.GenQuest.TakePirateship = "Found"; //флаг провалил
}
//<-- ОЗГ - пират

//--> ОЗГ - пассажир
void TakePassenger_CreateShip(string qName)
{
	int iNation = sti(pchar.GenQuest.TakePassenger.Nation);
	int iRank = sti(pchar.rank)+makeint(MOD_SKILL_ENEMY_RATE/2)+4;
	int iScl = 2*sti(pchar.rank)+10;
	int iShipType = sti(pchar.GenQuest.TakePassenger.ShipType);
	int iCannon = sti(pchar.GenQuest.TakePassenger.Cannon);
	int iDays = sti(pchar.GenQuest.TakePassenger.Terms2);
	string sShipName = pchar.GenQuest.TakePassenger.ShipName;
	string sCapId = "ContraPassCap";
    string sGroup = "Sea_" + sCapId + "1";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	sld = GetCharacter(NPC_GenerateCharacter(sCapId, "off_"+NationShortName(iNation)+"_"+(rand(5)+1), "man", "man", iRank, iNation, iDays, true, "quest"));
	FantomMakeSmallSailor(sld, iShipType, sShipName, iCannon, iScl, iScl, iScl, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_06", "pistol1", "bullet", 50);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.Ship.Mode = "war";	
	sld.AlwaysEnemy = true;
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	int iGoods = GOOD_COFFEE + drand(sti(GOOD_PAPRIKA - GOOD_COFFEE));
	int iSpace = GetCharacterFreeSpace(sld, iGoods);
	iSpace = makeint(iSpace/4);
	AddCharacterGoods(sld, iGoods, iSpace);
	sld.mapEnc.type = "trade";
	sld.mapEnc.worldMapShip = "quest_ship";
    sld.mapEnc.Name = "'" + sShipName + " '";
    Group_AddCharacter(sGroup, sld.id);
	Group_SetGroupCommander(sGroup, sld.id);
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
	Map_CreateTrader(pchar.GenQuest.TakePassenger.City, pchar.GenQuest.TakePassenger.CityA, sld.id, iDays);//запуск энкаунтера
	pchar.quest.ContraCureer_Abordage.win_condition.l1 = "Character_Capture";
	pchar.quest.ContraCureer_Abordage.win_condition.l1.character = "ContraPassCap";
	pchar.quest.ContraCureer_Abordage.function = "ContraPass_Abordage";//взяли на абордаж
	pchar.quest.ContraCureer_Sink.win_condition.l1 = "Character_sink";
	pchar.quest.ContraCureer_Sink.win_condition.l1.character = "ContraPassCap";
	pchar.quest.ContraCureer_Sink.function = "ContraPass_Sink";//потопили
}

void ContraPass_Abordage(string qName)//победили
{
	pchar.quest.AllMayorsQuests_Late.over = "yes"; //снимаем общий таймер
	pchar.quest.ContraCureer_Sink.over = "yes";
	Group_DeleteGroup("Sea_ContraPassCap1");
	AddComplexSeaExpToScill(150, 100, 100, 100, 100, 100, 0);
	ChangeOfficersLoyality("good_all", 1);
	AddQuestRecord("MayorsQuestsList", "10-1");
	pchar.GenQuest.TakePassenger = "Execute"; //флаг выполнил успешно
}

void ContraPass_Sink(string qName)//провалили
{
	pchar.quest.AllMayorsQuests_Late.over = "yes"; //снимаем общий таймер
	pchar.quest.ContraCureer_Abordage.over = "yes";
	Group_DeleteGroup("Sea_ContraPassCap1");
	ChangeOfficersLoyality("bad_all", 1);
	AddQuestRecord("MayorsQuestsList", "10-2");
	pchar.GenQuest.TakePassenger = "Found"; //флаг провалил
}
//<-- ОЗГ - пассажир

//--> Таможенный патруль
void CustomPatrol_CreateShip(string qName)
{
	int iNation = sti(pchar.GenQuest.CustomPatrol.Nation);
	int iRank = sti(pchar.rank)+makeint(MOD_SKILL_ENEMY_RATE/2)+2;
	int iScl = 2*sti(pchar.rank)+10;
	int iShipType = sti(pchar.GenQuest.CustomPatrol.ShipType);
	int iShipTypeA = sti(pchar.GenQuest.CustomPatrol.ShipTypeA);
	int iCannon = sti(pchar.GenQuest.CustomPatrol.Cannon);
	int lcr = sti(pchar.GenQuest.CustomPatrol.Loginlocator);
	int iDay = 1;
	if (makeint(environment.time) > 20.0) iDay = 2;
	Group_FindOrCreateGroup("ContraCureer");
	Group_SetType("ContraCureer", "pirate");//тип группы
	sld = GetCharacter(NPC_GenerateCharacter("ContraCureerCap", "citiz_"+(rand(9)+51), "man", "man", iRank, iNation, iDay, true, "quest"));//кэп-сдатчик
	FantomMakeSmallSailor(sld, iShipType, "", iCannon, iScl, iScl, iScl, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_05", "pistol1", "bullet", 50);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "pirate";
	sld.WatchFort = true;
	sld.Coastal_Captain = true;
	if (drand(1) == 0) AddCharacterGoods(sld, GOOD_SLAVES, 250+(drand(100)));
	Group_AddCharacter("ContraCureer", "ContraCureerCap");
	sld = GetCharacter(NPC_GenerateCharacter("ContraContraCap", "citiz_"+(rand(9)+41), "man", "man", iRank, iNation, iDay, true, "quest"));//конрик-приемщик
	FantomMakeSmallSailor(sld, iShipType, "", iCannon, iScl, iScl, iScl, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_06", "pistol1", "bullet", 50);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "pirate";
	sld.WatchFort = true;
	sld.Coastal_Captain = true;
	if (drand(1) == 1) AddCharacterGoods(sld, GOOD_SLAVES, 250+(drand(100)));
	Group_AddCharacter("ContraCureer", "ContraContraCap");
	Group_SetGroupCommander("ContraCureer", "ContraCureerCap");
	Group_SetAddress("ContraCureer", pchar.GenQuest.CustomPatrol.Island, "Quest_Ships", "Quest_Ship_"+lcr);
	
	//взяли на абордаж
	pchar.quest.ContraCureer_Capture.win_condition.l1 = "Character_Capture";
	pchar.quest.ContraCureer_Capture.win_condition.l1.character = "ContraCureerCap";
	pchar.quest.ContraCureer_Capture.function = "CustomPatrol_AfterBattle";
	//потопили
	pchar.quest.ContraCureer_Sink.win_condition.l1 = "Character_sink";
	pchar.quest.ContraCureer_Sink.win_condition.l1.character = "ContraCureerCap";
	pchar.quest.ContraCureer_Sink.function = "CustomPatrol_AfterBattle";
	// сбежали
	pchar.quest.ContraCureer_DieHard.win_condition.l1 = "MapEnter";
	pchar.quest.ContraCureer_DieHard.function = "CustomPatrol_DieHard";
}

void CustomPatrol_AfterBattle(string qName)//победили
{
	pchar.quest.AllMayorsQuests_Late.over = "yes"; //снимаем общий таймер
	pchar.quest.ContraCureer_DieHard.over = "yes";
	pchar.quest.ContraCureer_Capture.over = "yes";
	pchar.quest.ContraCureer_Sink.over = "yes";
	//Group_DeleteGroup("ContraCureer");
	AddComplexSeaExpToScill(150, 100, 100, 100, 100, 100, 0);
	AddCharacterExpToSkill(pchar, "Sneak", 200);//скрытность
	ChangeOfficersLoyality("good_all", 1);
	AddQuestRecord("MayorsQuestsList", "11-1");
	pchar.GenQuest.CustomPatrol = "Execute"; //флаг выполнил успешно
	ChangeContrabandRelation(pchar, -20);
}

void CustomPatrol_DieHard(string qName)//сбежали
{
	pchar.quest.AllMayorsQuests_Late.over = "yes"; //снимаем общий таймер
	pchar.quest.ContraCureer_AfterBattle.over = "yes";
	Group_DeleteGroup("ContraCureer");
	ChangeOfficersLoyality("bad_all", 1);
	AddQuestRecord("MayorsQuestsList", "5");
	pchar.GenQuest.CustomPatrol = "Found"; //флаг провалил
}
//<-- Таможенный патруль

//--> Дезертир
void FindFugitive_Over(string qName)//не пошел сдавать пленника
{
	pchar.quest.FindFugitive1.over = "yes"; //снять прерывание
	sld = &Characters[sti(Pchar.GenQuest.FindFugitive.PrisonerIDX)];
	ReleasePrisoner(sld); //освободили пленника
	sld.lifeday = 0;
	log_info(""+pchar.GenQuest.FindFugitive.Name+" died of calenture!");
	PlaySound("interface\notebook.wav");
	pchar.GenQuest.FindFugitive = "Late"; //флаг опоздал
}

void FindFugitive_inResidence(string qName)//в резиденции
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = &Characters[sti(Pchar.GenQuest.FindFugitive.PrisonerIDX)];
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorFollow(sld, pchar, "", -1);
}
//<-- Дезертир
///////////////////////////////////////////////////////////////////////////////////////////////////////
///Jason--------------------------------------- Регата ----------------------------------------------
///////////////////////////////////////////////////////////////////////////////////////////////////////
void PrepareToRegata(string qName)
{
	chrDisableReloadToLocation = true;
	bDisableFastReload = true;
	sld = GetCharacter(NPC_GenerateCharacter("RegataCureer", "off_eng_2", "man", "man", 20, ENGLAND, 1, false, "quest"));
    sld.Dialog.Filename = "Quest\Regata_dialog.c";
	sld.dialog.currentnode = "Regata_Cureer";
	LAi_SetImmortal(sld, true);
    FantomMakeCoolFighter(sld, 20, 20, 20, "blade_11", "pistol3", "grapeshot", 50);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, pchar.questTemp.Regata.CureerCity+"_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void RegataToPortRoyalTimeOver(string qName)//не активировали регату за 30 дней
{
	if (CheckAttribute(pchar, "questTemp.Regata.nomoney"))
	{
		sld = characterFromId("eng_guber");
		sld.dialog.currentnode = "First time";
	}
	if (CheckAttribute(pchar, "questTemp.Regata.Begin"))
	{
		sld = characterFromId("RegataHead");
		sld.lifeday = 0;
	}
	DeleteAttribute(pchar, "questTemp.Regata");
}

void PrepareToRegataInPortroyal(string qName)//создаем распорядителя регаты
{
	sld = GetCharacter(NPC_GenerateCharacter("RegataHead", "off_eng_5", "man", "man", 20, ENGLAND, -1, false, "quest"));
    sld.Dialog.Filename = "Quest\Regata_dialog.c";
	sld.dialog.currentnode = "Regata_Head";
	sld.name = "Henry";
	sld.lastname = "Stivenson";
	LAi_SetImmortal(sld, true);
	LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
    FantomMakeCoolFighter(sld, 90, 90, 90, "blade_11", "pistol3", "grapeshot", 50);
	LAi_SetHuberType(sld);
	ChangeCharacterAddressGroup(sld, "Portroyal_Roomtownhall", "sit", "sit2");
}

void Regata_SetCitizen()//оптимизация - установка ситизенов и распорядителя
{
	//установим благодарных зрителей
	for (i=1; i <=9; i++)
	{
	sld = GetCharacter(NPC_GenerateCharacter("RegataCitPRMan_"+i, "citiz_"+(rand(9)+11), "man", "man", 10, ENGLAND, 1, false, "quest"));
	sld.Dialog.Filename = "Quest\Regata_dialog.c";
		LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
	ChangeCharacterAddressGroup(sld, "Portroyal_town", "goto", "goto21");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocator(sld, "quest", "quest1", "RegataCitPR_norm", -1);
		if (CheckAttribute(pchar, "questTemp.Regata.Prepare"))
		{
		LAi_SetLoginTime(sld, 9.0, 13.0);
		sld.dialog.currentnode = "Regata_CitMan";
		}
		else sld.dialog.currentnode = "Regata_CitMan_1";
	}
	for (i=1; i <=5; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("RegataCitPRWom_"+i, "women_"+(rand(9)+7), "woman", "towngirl", 5, ENGLAND, 1, false, "quest"));
		sld.Dialog.Filename = "Quest\Regata_dialog.c";
		LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
		ChangeCharacterAddressGroup(sld, "Portroyal_town", "patrol", "patrol1");
		LAi_SetActorType(sld);
		LAi_ActorGoToLocator(sld, "quest", "quest1", "RegataCitPR_norm", -1);
		if (CheckAttribute(pchar, "questTemp.Regata.Prepare"))
		{
			LAi_SetLoginTime(sld, 9.0, 13.0);
			sld.dialog.currentnode = "Regata_CitWom";
		}
		else sld.dialog.currentnode = "Regata_CitWom_1";
	}
	for (i=1; i <=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("RegataCitPRHor_"+i, "horse0"+(2+i), "woman", "towngirl", 5, ENGLAND, 1, false, "quest"));
		sld.Dialog.Filename = "Quest\Regata_dialog.c";
		LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
		ChangeCharacterAddressGroup(sld, "Portroyal_town", "patrol", "patrol13");
		LAi_SetActorType(sld);
		LAi_ActorGoToLocator(sld, "goto", "goto27", "RegataCitPR_norm", -1);
		if (CheckAttribute(pchar, "questTemp.Regata.Prepare"))
		{
			LAi_SetLoginTime(sld, 9.0, 13.0);
			sld.dialog.currentnode = "Regata_CitHorse";
		}
		else sld.dialog.currentnode = "Regata_CitHorse_1";
	}
	//установим распорядителя регаты
	sld = characterFromId("RegataHead");
	LAi_SetStayType(sld);
	if (CheckAttribute(pchar, "questTemp.Regata.Prepare")) sld.dialog.currentnode = "Regata_Prepare_1";
	else sld.dialog.currentnode = "Regata_Finish";
	ChangeCharacterAddressGroup(sld, "Portroyal_town", "goto", "goto29");
}

void Regata_SetTime(string qName)//подготовка к запуску
{
	log_testinfo("ПРИГОТОВЛЕНИЯ К РЕГАТЕ ПОШЛИ!");
	LocatorReloadEnterDisable("Portroyal_town", "reload1_back", true);//закроем выход в море
	Regata_SetCitizen();//горожане и распорядитель
	//установим тела противников, для антуражу и индикации готовности, без возможности общения
	for (i=1; i<=5; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Regata_Cap_F"+i, "mercen_1"+i, "man", "man", 20, ENGLAND, 1, true, "quest"));
		ChangeCharacterAddressGroup(sld, "Portroyal_town", "reload", "reload1_back");
		LAi_SetImmortal(sld, true);
		LAi_SetActorType(sld);
		LAi_ActorGoToLocator(sld, "reload", "reload1_back", "RegataCapTurn", -1);
		LAi_SetLoginTime(sld, 12.0, 13.0);
	}
	//установим кораблики противников
	Group_FindOrCreateGroup("Regata");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	string sName, sShip;
	for (int i=1; i<=5; i++)
	{
		switch(i)
		{
			case 1:
				sName = pchar.questTemp.Regata.AdversaryName.a;
				sShip = pchar.questTemp.Regata.AdversaryShipName.a;
			break;
			case 2:
				sName = pchar.questTemp.Regata.AdversaryName.b;
				sShip = pchar.questTemp.Regata.AdversaryShipName.b;
			break;
			case 3:
				sName = pchar.questTemp.Regata.AdversaryName.c;
				sShip = pchar.questTemp.Regata.AdversaryShipName.c;
			break;
			case 4:
				sName = pchar.questTemp.Regata.AdversaryName.d;
				sShip = pchar.questTemp.Regata.AdversaryShipName.d;
			break;
			case 5:
				sName = pchar.questTemp.Regata.AdversaryName.e;
				sShip = pchar.questTemp.Regata.AdversaryShipName.e;
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("Regata_Cap"+i, "mercen_1"+i, "man", "man", iRank, ENGLAND, 1, true, "quest"));
		sld.name = sName;
		sld.lastname = "";
		FantomMakeCoolSailor(sld, SHIP_LUGGER, sShip, CANNON_TYPE_CANNON_LBS3, 90, 60, 60);
		FantomMakeCoolFighter(sld, iRank, 50, 50, "blade_05", "pistol1", "bullet", 100);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_SetImmortal(sld, true);//иначе несколько точно утонут, теревшись друг о друга
		Group_AddCharacter("Regata", "Regata_Cap"+i);
   }
	Group_SetGroupCommander("Regata", "Regata_Cap1");
	Group_SetTaskRunAway("Regata", PLAYER_GROUP);
	Group_SetPursuitGroup("Regata", PLAYER_GROUP);
	Group_SetAddress("Regata", "Jamaica", "quest_ships", "quest_ship_1");
	Group_LockTask("Regata");
}

void Regata_Lost(string qName)//опоздал к старту
{
	pchar.quest.Regata_Start.over = "yes";//снять прерывание
	DeleteAttribute(pchar, "questTemp.Regata");
	log_info("You are too late for the regatta.");
	Group_DeleteGroup("Regata");
	LocatorReloadEnterDisable("Portroyal_town", "reload1_back", false);//откроем выход в море
	sld = characterFromId("RegataHead");
	LAi_SetHuberType(sld);
	sld.dialog.currentnode = "Regata_Head";
	ChangeCharacterAddressGroup(sld, "Portroyal_Roomtownhall", "sit", "sit2");
}

void Regata_Start(string qName)//старт регаты
{
	log_testinfo("РЕГАТЕ-СТАРТ!!!");
	//стартовая точка отсчета времени
	pchar.quest.Regata_Lost.over = "yes";//снять прерывание
	pchar.questTemp.Regata.StartYear = GetDataYear();
	pchar.questTemp.Regata.StartMonth = GetDataMonth();
	pchar.questTemp.Regata.StartDay = GetDataDay();
	pchar.questTemp.Regata.StartTime = GetTime();
	for (i=1; i <=5; i++)
	{
		if (i==1) sTemp = "a";
		if (i==2) sTemp = "b";
		if (i==3) sTemp = "c";
		if (i==4) sTemp = "d";
		if (i==5) sTemp = "e";
		pchar.questTemp.Regata.AdversaryFirstTransition.Time.(sTemp) = 72*stf(pchar.questTemp.Regata.AdversarySpeed.(sTemp));//время 1 перехода в часах
		pchar.questTemp.Regata.AdversarySecondTransition.Time.(sTemp) = 122*stf(pchar.questTemp.Regata.AdversarySpeed.(sTemp));//время 1+2 переходов в часах
		pchar.questTemp.Regata.AdversaryThirdTransition.Time.(sTemp) = 192*stf(pchar.questTemp.Regata.AdversarySpeed.(sTemp));//время 1+2+3 переходов в часах
		pchar.questTemp.Regata.AdversaryFourthTransition.Time.(sTemp) = 240*stf(pchar.questTemp.Regata.AdversarySpeed.(sTemp));//время 1+2+3+4 переходов в часах
		pchar.questTemp.Regata.AdversaryFifthTransition.Time.(sTemp) = 360*stf(pchar.questTemp.Regata.AdversarySpeed.(sTemp));//время 1+2+3+4+5 переходов в часах
		log_testinfo(FindRussianDaysString(pchar.questTemp.Regata.AdversaryThirdTransition.Time.(sTemp)));
	}
	pchar.quest.Regata_Check.win_condition.l1 = "location";
	pchar.quest.Regata_Check.win_condition.l1.location = "Beliz";
	pchar.quest.Regata_Check.function = "RegataCheck";//проверка
	//распорядитель дает отмашку
	sld = characterFromId("RegataHead");
	LAi_SetActorType(sld);
	sld.dialog.currentnode = "Regata_Start";
	LAi_ActorDialogNow(sld, pchar, "", -1);
}

void ReturnJamaicaNorm(string qName)//вертаем остров в норму
{
	Island_SetReloadEnableGlobal("Jamaica", true);
	sld = characterFromId("RegataHead");
	LAi_SetHuberType(sld);
	sld.dialog.currentnode = "Regata_Head";
	ChangeCharacterAddressGroup(sld, "Portroyal_Roomtownhall", "sit", "sit2");
	DeleteAttribute(pchar, "questTemp.Regata.Prepare");
}

void RegataCheck(string qName)//проверку ставим в локации острова, чтобы не жульничал 
{
	log_testinfo("ПРОВЕРКА ПРАВИЛЬНОСТИ!!!");
	if ((GetCompanionQuantity(pchar) > 1) || sti(RealShips[sti(pchar.ship.type)].basetype) != SHIP_LUGGER || pchar.Ship.Name != "Santa Catherina") pchar.questTemp.Regata.Breach = "true";
}

void RegataPU_Open(string qName)//телепорт в ПУ, если ночь на дворе
{
	PlaySound("Interface\knock.wav");
	DoQuestReloadToLocation(pchar.questTemp.Regata.Town+"_portoffice", "reload", "reload1", "");
}

void RegataTH_Open(string qName) // belamour резиденция ночью
{
	PlaySound("Interface\knock.wav");
	DoQuestReloadToLocation("bridgetown_townhall", "reload", "reload1", "");
}

void RegataShipyarder(string qName)//верфист с парусами в Белизе
{
	bDisableFastReload = true;
	chrDisableReloadToLocation = true;
	sld = characterFromId("Beliz_shipyarder");
	sld.Dialog.Filename = "Quest\Regata_dialog.c";
	sld.dialog.currentnode = "Regata_Shipyarder";
	GetCharacterPos(pchar, &locx, &locy, &locz);
    ChangeCharacterAddressGroup(sld, "Beliz_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Contra_Regata(string qName)//контрики с пушками в Порт Принсе
{
	for (i=1; i<=2; i++)
	{
	sld = GetCharacter(NPC_GenerateCharacter("RegataContra_"+i, "citiz_"+(46+i), "man", "man", 20, FRANCE, 1, false, "quest"));
	sld.Dialog.Filename = "Quest\Regata_dialog.c";
	sld.dialog.currentnode = "Regata_Contra";
		LAi_SetImmortal(sld, true);
		LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	if (i == 2) LAi_CharacterDisableDialog(sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
    ChangeCharacterAddressGroup(sld, "Portpax_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void Padre_Regata(string qName)//падре в Сент-Джонсе
{
	bDisableFastReload = true;
	chrDisableReloadToLocation = true;
	sld = characterFromId("SentJons_Priest");
	sld.Dialog.Filename = "Quest\Regata_dialog.c";
	sld.dialog.currentnode = "Regata_Padre";
	GetCharacterPos(pchar, &locx, &locy, &locz);
    ChangeCharacterAddressGroup(sld, "SentJons_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void RegataSpyglassGirl(string qName)//девушка с подзорной трубой
{
	bDisableFastReload = true;
	chrDisableReloadToLocation = true;
	sld = GetCharacter(NPC_GenerateCharacter("SpyglassGirl", "women_"+(rand(5)+11), "woman", "towngirl", 5, ENGLAND, 1, true, "quest"));
	sld.Dialog.Filename = "Quest\Regata_dialog.c";
	sld.dialog.currentnode = "Regata_Spyglass";
	LAi_SetImmortal(sld, true);
	LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
	GetCharacterPos(pchar, &locx, &locy, &locz);
    ChangeCharacterAddressGroup(sld, "SentJons_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void RegataAttack_Hunter(string qName)//атака ДУ
{
	CoolTraderHunterOnMap();
}

void RegataAttack_Lugger(string qName)//засада из 2 люггеров
{
	Group_DeleteGroup("Lugger_Attack");
	Group_FindOrCreateGroup("Lugger_Attack");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 5*sti(pchar.rank);
	int iNation = sti(pchar.questTemp.Regata.AttackNation);
	for (int i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Lugger_CapAttack_"+i, "mercen_"+(rand(27)+1), "man", "man", iRank, iNation, 5, true, "quest"));
		FantomMakeCoolSailor(sld, SHIP_LUGGER, "", CANNON_TYPE_CANNON_LBS6, 100, iScl, iScl);
		FantomMakeCoolFighter(sld, iRank, 50, 50, "blade_05", "pistol1", "bullet", 100);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		UpgradeShipParameter(sld, "SpeedRate");
		if (drand(3) == i) UpgradeShipParameter(sld, "WindAgainstSpeed");
		Character_SetAbordageEnable(sld, false); //нельзя абордировать
		Group_AddCharacter("Lugger_Attack", "Lugger_CapAttack_"+i);
		sld.AlwaysEnemy = true;
		sld.Coastal_Captain = true;
		sld.AnalizeShips = true;
    }
	Group_SetGroupCommander("Lugger_Attack", "Lugger_CapAttack_1");
	Group_SetTaskAttack("Lugger_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("Lugger_Attack", PLAYER_GROUP);
	Group_SetAddress("Lugger_Attack", pchar.questTemp.Regata.AttackIsland, "", "");
	Group_LockTask("Lugger_Attack");
}

void RegataAttack_Corvette(string qName)//засада - корвет
{
	Group_DeleteGroup("Corvette_Attack");
	Group_FindOrCreateGroup("Corvette_Attack");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 7*sti(pchar.rank);
	int iNation = sti(pchar.questTemp.Regata.AttackNation);
		sld = GetCharacter(NPC_GenerateCharacter("Corvette_CapAttack_1", "mercen_"+(rand(27)+1), "man", "man", iRank, iNation, 5, true, "quest"));
		FantomMakeCoolSailor(sld, SHIP_CORVETTE, "", CANNON_TYPE_CANNON_LBS20, 100, iScl, iScl);
		FantomMakeCoolFighter(sld, iRank, 50, 50, "blade_10", "pistol1", "bullet", 100);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		UpgradeShipParameter(sld, "SpeedRate");
		if (drand(3) == 0) UpgradeShipParameter(sld, "Capacity");
		Character_SetAbordageEnable(sld, false); //нельзя абордировать
		Group_AddCharacter("Corvette_Attack", "Corvette_CapAttack_1");
		sld.AlwaysEnemy = true;
		sld.Coastal_Captain = true;
		sld.AnalizeShips = true;
	Group_SetGroupCommander("Corvette_Attack", "Corvette_CapAttack_1");
	Group_SetTaskAttack("Corvette_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("Corvette_Attack", PLAYER_GROUP);
	Group_SetAddress("Corvette_Attack", pchar.questTemp.Regata.AttackIsland, "", "");
	Group_LockTask("Corvette_Attack");
}

void RegataAttack_Brigantine(string qName)//засада - бригантина
{
	Group_DeleteGroup("Brigantine_Attack");
	Group_FindOrCreateGroup("Brigantine_Attack");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 10*sti(pchar.rank);
	int iNation = sti(pchar.questTemp.Regata.AttackNation);
	sld = GetCharacter(NPC_GenerateCharacter("Brigantine_CapAttack_1", "mercen_"+(rand(27)+1), "man", "man", iRank, iNation, 5, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_BRIGANTINE, "", CANNON_TYPE_CANNON_LBS16, 100, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, 50, 50, "blade_10", "pistol1", "bullet", 100);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	UpgradeShipParameter(sld, "SpeedRate");
	if (drand(1) == 0) UpgradeShipParameter(sld, "Capacity");
	else UpgradeShipParameter(sld, "WindAgainstSpeed");
	Character_SetAbordageEnable(sld, false); //нельзя абордировать
	sld.AlwaysEnemy = true;
	sld.Coastal_Captain = true;
	sld.AnalizeShips = true;
	Group_AddCharacter("Brigantine_Attack", "Brigantine_CapAttack_1");
	Group_SetGroupCommander("Brigantine_Attack", "Brigantine_CapAttack_1");
	Group_SetTaskAttack("Brigantine_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("Brigantine_Attack", PLAYER_GROUP);
	Group_SetAddress("Brigantine_Attack", pchar.questTemp.Regata.AttackIsland, "", "");
	Group_LockTask("Brigantine_Attack");
}

void RegataAttack_Brander(string qName)//люггер-брандер
{
	Island_SetReloadEnableGlobal("Antigua", false);//на остров нельзя			
	bQuestDisableMapEnter = true;//на глобалку тоже
	Group_DeleteGroup("Brander_Attack");
	Group_FindOrCreateGroup("Brander_Attack");
	sTemp = pchar.questTemp.Regata.BranderName;
	sld = GetCharacter(NPC_GenerateCharacter("Brander_CapAttack_1", "mercen_"+(rand(27)+1), "man", "man", 30, ENGLAND, 5, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_LUGGER, sTemp, CANNON_TYPE_CANNON_LBS3, 100, 10, 10);
	SetShipSkill(sld, 30, 10, 10, 10, 100, 10, 10, 10, 10);//дополнительно
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	UpgradeShipParameter(sld, "SpeedRate");
	UpgradeShipParameter(sld, "Capacity");
	UpgradeShipParameter(sld, "WindAgainstSpeed");
	UpgradeShipParameter(sld, "TurnRate");
	Character_SetAbordageEnable(sld, false); //нельзя абордировать
	sld.DontDeskTalk = true; //шлюпку не выслать
	sld.Coastal_Captain = true;
	SetCharacterGoods(sld, GOOD_BALLS, 0);
	SetCharacterGoods(sld, GOOD_BOMBS, 0);
	SetCharacterGoods(sld, GOOD_SAILCLOTH, 0);
	SetCharacterGoods(sld, GOOD_PLANKS, 0);
	SetCharacterGoods(sld, GOOD_RUM, 0);
	SetCharacterGoods(sld, GOOD_POWDER, 250);
	Group_AddCharacter("Brander_Attack", "Brander_CapAttack_1");
	Group_SetGroupCommander("Brander_Attack", "Brander_CapAttack_1");
	Group_SetAddress("Brander_Attack", "Antigua", "IslandShips1", "ship_5");
	Ship_SetTaskMove(SECONDARY_TASK, sti(sld.Index), -1548.87, 559.55);
	DoQuestFunctionDelay("BranderGo", 5.0);
}

void BranderGo(string qName)//относится к функции выше - таск брандера не действует на дрейфующий корабль
{
	sld = characterFromId("Brander_CapAttack_1");
	Ship_SetTaskBrander(SECONDARY_TASK, sti(sld.Index), GetMainCharacterIndex());
	sld.ShipTaskLock = true;
	pchar.quest.Brander_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Brander_AfterBattle.win_condition.l1.group = "Brander_Attack";
	pchar.quest.Brander_AfterBattle.function = "BranderDestroyed";
}

void BranderDestroyed(string qName)//брандер капут
{
	Group_DeleteGroup("Brander_Attack");
	Island_SetReloadEnableGlobal("Antigua", true);		
	bQuestDisableMapEnter = false;
}

void RegataSiege(string qName)//создаем осаду ручками, ибо CreateSiege() тут не совсем годится
{
	Group_DeleteGroup("Siege_Attack");
	Group_FindOrCreateGroup("Siege_Attack");
	for (int i=1; i<=5; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Siege_CapAttack_"+i, "off_spa_"+(rand(1)+1), "man", "man", 40-(i*2), SPAIN, -1, true, "quest"));
		switch (i)
		{
			case 1: FantomMakeCoolSailor(sld, SHIP_LINESHIP, "", CANNON_TYPE_CANNON_LBS32, 100, 100, 100); break;
			case 2:
				FantomMakeCoolSailor(sld, SHIP_LINESHIP, "", CANNON_TYPE_CANNON_LBS32, 100, 100, 100);
				LAi_SetImmortal(sld, true);//защита от дурака
				Character_SetAbordageEnable(sld, false); //нельзя абордировать
			break;
			case 3: FantomMakeCoolSailor(sld, SHIP_GALEON_H, "", CANNON_TYPE_CANNON_LBS32, 100, 100, 100); break;
			case 4: FantomMakeCoolSailor(sld, SHIP_GALEON_H, "", CANNON_TYPE_CANNON_LBS24, 100, 100, 100); break;
			case 5: FantomMakeCoolSailor(sld, SHIP_GALEON_H, "", CANNON_TYPE_CANNON_LBS24, 100, 100, 100); break;
		}
		FantomMakeCoolFighter(sld, 40-(i*2), 100, 100, "blade_13", "pistol5", "bullet", 250);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.AnalizeShips = true;
		sld.AlwaysEnemy = true;
		sld.AlwaysSandbankManeuver = true;
		Group_AddCharacter("Siege_Attack", "Siege_CapAttack_"+i);
    }
	Group_SetGroupCommander("Siege_Attack", "Siege_CapAttack_1");
	Group_SetAddress("Siege_Attack", "Barbados", "quest_ships", "quest_ship_5");
}

void RegataSiegeDelete(string qName)//удалить осаду
{
	Group_DeleteGroup("Siege_Attack");
	for (i=1; i <=5; i++)
	{
		if (GetCharacterIndex("Siege_CapAttack_"+i) != -1)
		{
			sld = characterFromId("Siege_CapAttack_"+i);
			sld.lifeday = 0;
		}
	}
}

void RegataSiegeOfficer(string qName)//офицер-вестовой
{
	bDisableFastReload = true;
	LocatorReloadEnterDisable("Bridgetown_town", "reload1_back", true);
	LocatorReloadEnterDisable("Bridgetown_town", "reload2_back", true);
	LocatorReloadEnterDisable("Bridgetown_town", "reload3_back", true);
	LocatorReloadEnterDisable("Bridgetown_town", "gate1_back", true);
	LocatorReloadEnterDisable("Bridgetown_town", "gate_back", true);//чтобы не сбежал
	LocatorReloadEnterDisable("Bridgetown_Exittown", "reload3", true);//для логики событий
	sld = GetCharacter(NPC_GenerateCharacter("SiegeOfficer", "off_eng_1", "man", "man", 25, ENGLAND, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 25, 60, 60, "blade_10", "pistol5", "bullet", 100);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.name = "lieutenant";
    sld.lastname = "Mahoiny";
	sld.Dialog.Filename = "Quest\Regata_dialog.c";
	sld.dialog.currentnode = "Regata_SiegeOfficer";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "Bridgetown_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz)); 
    ChangeCharacterAddressGroup(sld, "Bridgetown_town", "goto", "goto8"); // belamour фикс махойни
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	//поставим горожанок
	for (i=1; i <=9; i++)
	{
	sld = GetCharacter(NPC_GenerateCharacter("RegataBridgWom_"+i, "women_"+(rand(9)+7), "woman", "towngirl", 5, ENGLAND, -1, false, "quest"));
	sld.Dialog.Filename = "Quest\Regata_dialog.c";
	sld.dialog.currentnode = "Regata_BridgWom";
	LAi_SetImmortal(sld, true);//защита от дурака
	LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
	ChangeCharacterAddressGroup(sld, "Bridgetown_town", "goto", "goto4");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocator(sld, "patrol", "patrol17", "RegataBridgWom_norm", -1);
	}
}

void RegataSiegeEvacuation(string qName)//эвакуация на корабль
{
	sld = characterFromId("SiegeOfficer");
	sld.dialog.currentnode = "Regata_SiegeOfficer_4";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void CreateSiegeSloop(string qName)//шлюп у мыса
{
	Group_DeleteGroup("Sloop_Attack");
	Group_FindOrCreateGroup("Sloop_Attack");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 5*sti(pchar.rank);
	sld = GetCharacter(NPC_GenerateCharacter("Sloop_CapAttack", "off_spa_"+(rand(1)+1), "man", "man", iRank, SPAIN, -1, true, "quest"));
	FantomMakeSmallSailor(sld, SHIP_SLOOP, "", CANNON_TYPE_CANNON_LBS12, 100, iScl, iScl, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, 50, 50, "blade_10", "pistol1", "bullet", 100);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	UpgradeShipParameter(sld, "SpeedRate");
	UpgradeShipParameter(sld, "WindAgainstSpeed");
	Group_AddCharacter("Sloop_Attack", "Sloop_CapAttack");
	sld.AlwaysEnemy = true;
	sld.Coastal_Captain = true;
	sld.AnalizeShips = true;
	Group_SetGroupCommander("Sloop_Attack", "Sloop_CapAttack");
	Group_SetTaskAttack("Sloop_Attack", PLAYER_GROUP);
	Group_SetAddress("Sloop_Attack", "Barbados", "quest_ships", "quest_ship_9");
	Group_LockTask("Sloop_Attack");
}

void RegataSiegeShore(string qName)//бой в бухте
{
	chrDisableReloadToLocation = true;
	for (i=1; i <=9; i++)
	{
		sld = characterFromId("RegataBridgWom_"+i);
		ChangeCharacterAddressGroup(sld, "Shore4", "goto", "goto10");
		LAi_SetActorType(sld);
		LAi_ActorGoToLocator(sld, "goto", "goto4", "RegataBridgWom_norm", -1);
	}
	sld = characterFromId("SiegeOfficer");
	sld.dialog.currentnode = "Regata_SiegeOfficer_6";
	LAi_SetWarriorType(sld);
	LAi_warrior_DialogEnable(sld, true);
	ChangeCharacterAddressGroup(sld, "Shore4", "goto", "goto8");
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	for (int i=1; i <=3; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Spa_shore_sold_"+i, "sold_spa_"+(rand(7)+1), "man", "man", 20, SPAIN, -1, true, "quest"));
		FantomMakeCoolFighter(sld, 20, 60, 60, "blade_10", "pistol1", "bullet", 100);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		ChangeCharacterAddressGroup(sld, "Shore4", "goto", "goto"+(15+i));
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	sld = GetCharacter(NPC_GenerateCharacter("Spa_shore_off", "off_spa_"+(rand(1)+1), "man", "man", 25, SPAIN, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 25, 60, 60, "blade_10", "pistol5", "bullet", 100);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	ChangeCharacterAddressGroup(sld, "Shore4", "goto", "goto19");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "RegataShoreAfterBattle");
}

void RegataBarbadosCave(string qName)//в пещере
{
	LocatorReloadEnterDisable("Barbados_cave", "reload1", true);
	if (GetCharacterIndex("SiegeOfficer") != -1)
	{
		sld = characterFromId("SiegeOfficer");
		sld.dialog.currentnode = "Regata_SiegeOfficer_8";
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
		ChangeCharacterAddressGroup(sld, "Barbados_cave", "monsters", "monster10");
	}
	else
	{
		sld = characterFromId("RegataBridgWom_1");
		sld.dialog.currentnode = "Regata_BridgWom_3";
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
		ChangeCharacterAddressGroup(sld, "Barbados_cave", "monsters", "monster10");
	}
	for (i=2; i <=9; i++)
	{
		sld = characterFromId("RegataBridgWom_"+i);
		LAi_SetActorType(sld);
		ChangeCharacterAddressGroup(sld, "Barbados_cave", "monsters", "monster37");
		LAi_ActorRunToLocator(sld, "reload", "reload1", "", 30);
	}
}

void RegataSiegeSkiper()//Вудро в церкви
{
	sld = GetCharacter(NPC_GenerateCharacter("SiegeSkiper", "Doggerty", "man", "man", 30, ENGLAND, 2, true, "quest"));
	FantomMakeCoolFighter(sld, 25, 10, 10, "blade_10", "pistol5", "bullet", 10);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	SetShipSkill(sld, 35, 15, 24, 30, 100, 35, 20, 60, 40);
	SetCharacterPerk(sld, "ShipSpeedUp");
	SetCharacterPerk(sld, "ShipTurnRateUp");
	SetCharacterPerk(sld, "StormProfessional");
	SetCharacterPerk(sld, "WindCatcher");
	SetCharacterPerk(sld, "SailsMan");
	SetCharacterPerk(sld, "SailingProfessional");
	sld.CompanionDisable = true;
	sld.name = "Vudro";
    sld.lastname = "Doggerty";
	sld.Dialog.Filename = "Quest\Regata_dialog.c";
	sld.dialog.currentnode = "Regata_SiegeSkiper";
	LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "Bridgetown_church", "goto", "goto1");
	LAi_SetStayType(sld);
}

void SiegeSkiperOver(string qName)//время службы Вудро истекло
{
	if (IsEntity(&worldMap) || bSeaActive) 
	{
		pchar.quest.Remove_Vudro.win_condition.l1 = "Location_Type";
		pchar.quest.Remove_Vudro.win_condition.l1.location_type = "town";
		pchar.quest.Remove_Vudro.function = "RemoveSiegeSkiper";
	}
	else
	{
		Pchar.questTemp.FiringOfficerIDX = GetCharacterIndex("SiegeSkiper");
		sld = &Characters[sti(Pchar.questTemp.FiringOfficerIDX)];
		CheckForReleaseOfficer(sti(Pchar.questTemp.FiringOfficerIDX));
		RemovePassenger(Pchar, sld);
		DeleteAttribute(sld, "Payment");
		DeleteAttribute(Pchar, "questTemp.FiringOfficerIDX");//удаляем из офицеров
		log_info("The navigator has left your ship!");
		PlaySound("interface\notebook.wav");
	}
}

void RemoveSiegeSkiper(string qName)//удалить Вудро
{
	Pchar.questTemp.FiringOfficerIDX = GetCharacterIndex("SiegeSkiper");
	sld = &Characters[sti(Pchar.questTemp.FiringOfficerIDX)];
	CheckForReleaseOfficer(sti(Pchar.questTemp.FiringOfficerIDX));
	RemovePassenger(Pchar, sld);
    DeleteAttribute(sld, "Payment");
	DeleteAttribute(Pchar, "questTemp.FiringOfficerIDX");//удаляем из офицеров
	log_info("The navigator has left your ship!");
	PlaySound("interface\notebook.wav");
}

void RegataFinishSea(string qName)//здесь пересчитаем время для установки кораблей соперников
{
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.CannotWait = true;//запрет ожидания
	Group_FindOrCreateGroup("Regata");
	int n=0;
	pchar.questTemp.Regata.FifthTransitionTime = GetPastTime("hour", sti(pchar.questTemp.Regata.StartYear), sti(pchar.questTemp.Regata.StartMonth), sti(pchar.questTemp.Regata.StartDay), stf(pchar.questTemp.Regata.StartTime), GetDataYear(), GetDataMonth(), GetDataDay(), GetTime());//истратил ГГ в часах на всю регату
	for (i=1; i <=5; i++)
	{
		if (i==1) sTemp = "a";
		if (i==2) sTemp = "b";
		if (i==3) sTemp = "c";
		if (i==4) sTemp = "d";
		if (i==5) sTemp = "e";
		if (pchar.questTemp.Regata.AdversaryFifthTransition.Time.(sTemp) < sti(pchar.questTemp.Regata.FifthTransitionTime)) n++;
	}
	if (n != 0)
	{
		for (int i=1; i <=n; i++)
		{
			if (i==1) sTemp = "a";
			if (i==2) sTemp = "b";
			if (i==3) sTemp = "c";
			if (i==4) sTemp = "d";
			if (i==5) sTemp = "e";
			sld = GetCharacter(NPC_GenerateCharacter("Regata_Cap"+i, "mercen_1"+i, "man", "man", 20, ENGLAND, 1, true, "quest"));
			sld.name = pchar.questTemp.Regata.AdversaryName.(sTemp);
			sld.lastname = "";
			FantomMakeCoolSailor(sld, SHIP_LUGGER, pchar.questTemp.Regata.AdversaryShipName.(sTemp), CANNON_TYPE_CANNON_LBS3, 90, 60, 60);
			FantomMakeCoolFighter(sld, 20, 50, 50, "blade_6", "pistol1", "bullet", 100);
			DeleteAttribute(sld, "SaveItemsForDead");
			DeleteAttribute(sld, "DontClearDead");
			LAi_SetImmortal(sld, true);//иначе несколько точно утонут, теревшись друг о друга
			Group_AddCharacter("Regata", "Regata_Cap"+i);
		}
		Group_SetGroupCommander("Regata", "Regata_Cap1");
		Group_SetAddress("Regata", "Jamaica", "quest_ships", "quest_ship_1");
	}
	Log_TestInfo(FindRussianDaysString(n));
	Log_TestInfo(FindRussianDaysString(sti(pchar.questTemp.Regata.FifthTransitionTime)));
}

void RegataFinishTown(string qName)//финиш на суше
{
	Regata_SetCitizen();//горожане и распорядитель
}

void RegataFinal(string qName)//финальная часть регаты при победе
{
	sld = characterFromId("PortRoyal_Mayor");
	sld.dialog.currentnode = "Regata_Final";
	sld = characterFromId("RegataHead");
	LAi_SetHuberType(sld);
	sld.dialog.currentnode = "Give_advantage";
	ChangeCharacterAddressGroup(sld, "Portroyal_Roomtownhall", "sit", "sit2");
}

void RegataFinalOver(string qName)//зачистка всего связанного с регатой
{
	sld = characterFromId("PortRoyal_Mayor");
	sld.dialog.currentnode = "First time";
	sld = characterFromId("RegataHead");
	sld.dialog.currentnode = "Other_result_repeat";//для мотальщиков времени в локации
	sld.lifeday = 0;
	DeleteAttribute(pchar, "questTemp.Regata");
}
////////////////////////////////////////////////////////////////////////////////////////////////////////
///-----------------------------------------регата конец-----------------------------------------------
////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////
///Jason-----------------------------------Португалец начало-----------------------------------------------
///////////////////////////////////////////////////////////////////////////////////////////////////////
void Portugal_BeginOver(string qName)//не пришли
{
	sld = characterFromId("Avendel");
	sld.lifeday = 0;
	pchar.questTemp.Portugal = "end";
}

void Portugal_DoctorOver(string qName)//не нашли дом
{
	sld = characterFromId("Avendel");
	sld.lifeday = 0;
	pchar.quest.Portugal_Guard.over = "yes";
	AddQuestRecord("Portugal", "2");
	CloseQuestHeader("Portugal");
	pchar.questTemp.Portugal = "end";
}

void CreatePortugalGuard(string qName)//охрана Португальца
{
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	LAi_group_Delete("EnemyFight");
	int iRank = sti(pchar.rank)+7;
	for (int i=1; i <=3; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("PortugalGuard_"+i, "citiz_"+(i+42), "man", "man", iRank, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, iRank, 20+iRank, 20+iRank, "blade_10", "pistol1", "bullet", 20+iRank);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.dialog.FileName = "Quest\Portugal_dialog.c";
		sld.dialog.currentnode = "Portugal_guard";
		sld.greeting = "town_pirate";		
		GetCharacterPos(pchar, &locx, &locy, &locz);
        ChangeCharacterAddressGroup(sld, "Marigo_houseF1", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
		LAi_SetWarriorType(sld);
		if (i == 1)
		{
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
		}
	}
}

void CreatePortugalDoctor(string qName)//создаем доктора и Португальца
{
	chrDisableReloadToLocation = true;
	//Барт Португалец
	sld = GetCharacter(NPC_GenerateCharacter("Portugal", "Port_A", "man", "man", 35, PIRATE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 35, 65, 65, "", "", "bullet", 150);
	sld.name = "Bartolomeo";
	sld.lastname = "Portuguese";
	sld.dialog.FileName = "Quest\Portugal_dialog.c";
	sld.dialog.currentnode = "Bart_lay";
	LAi_SetLayType(sld);
	ChangeCharacterAddressGroup(sld, "Marigo_RoomHouseF1", "barmen", "bar1");
	//доктор
	sld = GetCharacter(NPC_GenerateCharacter("PortugalDoctor", "VanShtal", "man", "man", 10, HOLLAND, -1, true, "quest"));
	sld.dialog.FileName = "Quest\Portugal_dialog.c";
	sld.dialog.currentnode = "Portugal_doctor";
	sld.greeting = "shtile";
	sld.name = "Piter";
	sld.lastname = "van Stahl";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "Marigo_RoomHouseF1", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialogDelay(sld, pchar, "", 2.5);
}

void AvendelInHouse(string qName)//Португалец в доме
{
	sld = characterFromId("Avendel");
	sld.dialog.currentnode = "Avendel_house";
	ChangeCharacterAddressGroup(sld, "Marigo_HouseF1", "goto", "goto2");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void PortugalClovesOver(string qName)//просрочили забрать Португальца из дома - зачищаем всех
{
	sld = characterFromId("Avendel");
	sld.lifeday = 0;
	sld = characterFromId("PortugalDoctor");
	sld.lifeday = 0;
	sld = characterFromId("Portugal");
	sld.lifeday = 0;
	AddQuestRecord("Portugal", "4");
	CloseQuestHeader("Portugal");
	pchar.questTemp.Portugal = "end";
}

void Portugal_ToAntiguaOver(string qName)//Португалец помер
{
	DeleteAttribute(pchar, "GenQuest.CannotWait");//можно мотать время
	sld = characterFromId("Portugal");
	LAi_KillCharacter(sld);
	if (pchar.questTemp.Portugal == "TreatmentStart" || pchar.questTemp.Portugal == "TreatmentCurrent" || pchar.questTemp.Portugal == "TreatmentComplete") pchar.questTemp.Portugal.Die = "true";
	else
	{
		pchar.quest.Remove_Avendel.win_condition.l1 = "Location_Type";
		pchar.quest.Remove_Avendel.win_condition.l1.location_type = "town";
		pchar.quest.Remove_Avendel.function = "RemoveAvendelnDoc";
		AddQuestRecord("Portugal", "6");
		CloseQuestHeader("Portugal");
		pchar.questTemp.Portugal = "end";
	}
	sld = characterFromId("Jino");
	ChangeCharacterAddressGroup(sld, "SentJons_HouseF3_Room", "goto", "goto1"); // patch-9
}

void RemoveAvendelnDoc(string qName)//зачищаем Авендела и доктора
{
	chrDisableReloadToLocation = true;
	bDisableFastReload = true;
	sld = characterFromId("PortugalDoctor");
	RemovePassenger(Pchar, sld);
	sld.lifeday = 0;
	sld = characterFromId("Avendel");
	sld.dialog.currentnode = "Avendel_goodbye";
	RemovePassenger(Pchar, sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Portugal_TreatmentOver(string qName)//лечение окончено
{
	pchar.questTemp.Portugal = "TreatmentFinish";
}

void AvendelSpeach(string qName)//подходилка-говорилка Авендела
{
	chrDisableReloadToLocation = true;
	sld = characterFromId("Avendel");
	if (pchar.questTemp.Portugal == "ToMartinique") sld.dialog.currentnode = "Avendel_Room_2";
	else
	{
		if (pchar.questTemp.Portugal == "MartiniqueGovernor") sld.dialog.currentnode = "Avendel_seapatrol";
		else
		{
			if (pchar.questTemp.Portugal == "MartiniqueGovernorEnd") sld.dialog.currentnode = "Avendel_seapatrol_5";
			else
			{
				if (pchar.questTemp.Portugal == "LeFransuaAfterFight") sld.dialog.currentnode = "Avendel_LeFransua";
			else sld.dialog.currentnode = "Avendel_Room";
		}
	}
	}
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void PortugalOnStreet(string qName)//охотники в Сент-Джонсе
{
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретим драться
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	for (int i=1; i <=5; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("PortugalHunter_"+i, "citiz_"+(i+42), "man", "man", iRank, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, iRank, 20+iRank, 20+iRank, "blade_10", "pistol1", "bullet", 20+iRank);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.dialog.FileName = "Quest\Portugal_dialog.c";
		sld.dialog.currentnode = "Portugal_hunter";
		sld.greeting = "town_pirate";		
		GetCharacterPos(pchar, &locx, &locy, &locz);
        ChangeCharacterAddressGroup(sld, "SentJons_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
		LAi_SetWarriorType(sld);
		if (i == 1)
		{
		sld.name = "Leo";
		sld.lastname = "Cord";
		}
		if (i != 1) LAi_CharacterDisableDialog(sld);
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void PortugalSeaHunter(string qName)//атака охотников в порту
{
	sld = characterFromId("Portugal");
	LAi_SetGroundSitType(sld);
	ChangeCharacterAddressGroup(sld, "My_Deck", "goto", "goto6");//Португальца в трюм
	Group_DeleteGroup("Hunter_Attack");
	Group_FindOrCreateGroup("Hunter_Attack");
	SelectLevelWarShipParameter();//автолевеллинг
	sld = GetCharacter(NPC_GenerateCharacter("Porthunter", "mercen_"+(rand(27)+1), "man", "man", sti(PChar.rank)+5, ENGLAND, 5, true, "hunter"));
	FantomMakeSmallSailor(sld, iGlobalTemp, "", iTotalTemp, 70+rand(5), 60+rand(5), 60+rand(5), 50+rand(5), 55+rand(5));
	FantomMakeCoolFighter(sld, sti(PChar.rank)+5, 30, 30, sTotalTemp, "pistol3", "grapeshot", 50);
	sld.AlwaysEnemy = true;
	sld.Coastal_Captain = true;
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "pirate";
	Group_AddCharacter("Hunter_Attack", "Porthunter");
	Group_SetGroupCommander("Hunter_Attack", "Porthunter");
	Group_SetTaskAttack("Hunter_Attack", PLAYER_GROUP);
	Group_SetPursuitGroup("Hunter_Attack", PLAYER_GROUP);
	Group_SetAddress("Hunter_Attack", "Antigua", "", "");
	Group_LockTask("Hunter_Attack");
	int i = FindColony("Fortfrance");
	colonies[i].DontSetShipInPort = true;  //не ставить корабли в порту Мартиники
}

void PortugalOnMartinique(string qName)//прибыли на Мартинику - доктор
{
	sld = characterFromId("PortugalDoctor");
	sld.dialog.currentnode = "Portugal_doctor_12";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void PortugalInTavernRoom(string qName)//доктор и Португалец в комнате таверны
{
	sld = characterFromId("PortugalDoctor");
	sld.dialog.currentnode = "Portugal_doctor_14";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void CreateFrancePatrol(string qName)//посыльный в городе - приглашение к губернатору
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = GetCharacter(NPC_GenerateCharacter("PortugalPatrol_"+i, "off_fra_1", "man", "man", 25, FRANCE, 0, true, "quest"));
	FantomMakeCoolFighter(sld, 25, 70, 70, "blade_15", "pistol6", "bullet", 50);
	sld.dialog.FileName = "Quest\Portugal_dialog.c";
	sld.dialog.currentnode = "Portugal_patrol";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "Fortfrance_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void PortugalSeapatrolGo(string qName)//типо патрулируем Мартинику - просто крутим время
{
	DoQuestFunctionDelay("PortugalSeapatrolEnd", 60.0);//минуту поплаваем
	Island_SetReloadEnableGlobal("Martinique", false);//на остров нельзя			
	bQuestDisableMapEnter = true;//запрет выхода на глобу
}

void PortugalSeapatrolEnd(string qName)//отдежурили
{
	AddQuestRecord("Portugal", "11");
	Island_SetReloadEnableGlobal("Martinique", true); //снять запрет
	LocatorReloadEnterDisable("Fortfrance_town", "reload4_back", false);//открыть таверну
	SetLaunchFrameFormParam("Two days later"+ NewStr() +"Enemy's vessel was not seen", "", 0, 4);
	LaunchFrameForm();
	WaitDate("", 0, 0, 2, 4, 10); //крутим время
	RecalculateJumpTable();
	sld = characterFromId("FortFrance_Mayor");
	sld.dialog.currentnode = "Portugal_9";
	pchar.questTemp.Portugal = "MartiniqueGovernorEnd";//новый флаг
	sld = characterFromId("Avendel");
	sld.greeting = "avendel_2";
	sld = characterFromId("Portugal");
	sld.greeting = "portugal";
	SetFunctionTimerCondition("MartiniqueGovernorOver", 0, 0, 5, false);//5 дней на получение награды
	pchar.quest.Portugal_SeapatrolAvendel1.win_condition.l1 = "location";
	pchar.quest.Portugal_SeapatrolAvendel1.win_condition.l1.location = "Fortfrance_town";
	pchar.quest.Portugal_SeapatrolAvendel1.function = "AvendelSpeach";
	int i = FindColony("Fortfrance");
	colonies[i].DontSetShipInPort = false;//ставить корабли в порту Мартиники
		}

void MartiniqueGovernorOver(string qName)//вертаем обычную ноду губеру Мартиники
{
	sld = characterFromId("FortFrance_Mayor");
	sld.dialog.currentnode = "First time";
}

void MartiniquePortugalOver(string qName)//не нашли Португальца за 2 дня - конец квеста
{
	sld = characterFromId("Avendel");
	sld.lifeday = 0;
	RemovePassenger(Pchar, sld);
	AddQuestRecord("Portugal", "16");
	CloseQuestHeader("Portugal");
	pchar.questTemp.Portugal = "end";
}

void Portugal_enterPirates()//пиратусы в таверне Ле Франсуа
{
	LAi_group_Delete("EnemyFight");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE; // patch-9
	for (int i=1; i<=3; i++)
{
		sld = GetCharacter(NPC_GenerateCharacter("LeFransuaPirate_"+i, "citiz_"+(i+43), "man", "man", iRank, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, iRank, 40+iRank, 40+iRank, "blade_10", "pistol3", "bullet", 100+iRank);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.dialog.FileName = "Quest\Portugal_dialog.c";
		sld.dialog.currentnode = "LeFransua_pirate";
		sld.greeting = "town_pirate";		
		GetCharacterPos(pchar, &locx, &locy, &locz);
        ChangeCharacterAddressGroup(sld, "LeFransua_tavern", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
		LAi_SetWarriorType(sld);
		if (i == 1)
		{
			LAi_SetActorType(sld);
			LAi_ActorDialog(sld, pchar, "", -1, 0);
		}
	}
}

void CreateFranzGarke(string qName)//создаем Франца Гарке в комнате, туда же - Португальца
{
	LAi_group_Delete("EnemyFight");
	chrDisableReloadToLocation = true;
	sld = characterFromId("Portugal");
	ChangeCharacterAddressGroup(sld, "LeFransua_tavern_upstairs", "goto", "goto2");//ставим Португальца
	sld = GetCharacter(NPC_GenerateCharacter("FranzGarke", "Garke", "man", "man", 30, PIRATE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 25+MOD_SKILL_ENEMY_RATE, 90, 90, "blade_17", "pistol6", "bullet", 150);
	SetCharacterPerk(sld, "SwordplayProfessional");
	sld.name = "Frants";
	sld.lastname = "Garke";
	GiveItem2Character(sld, "cirass2");
	EquipCharacterbyItem(sld, "cirass2");
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.dialog.FileName = "Quest\Portugal_dialog.c";
	sld.dialog.currentnode = "FranzGarke";
	sld.greeting = "town_pirate";
	ChangeCharacterAddressGroup(sld, "LeFransua_tavern_upstairs", "goto", "goto1");
	LAi_SetActorType(sld);
	LAi_ActorDialogNow(sld, pchar, "", -1);
}

void CreateVaskezsPirates(string qName)//драка на улицах Ле Франсуа
{
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретим драться
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	for (int i=1; i <=9; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("VaskezsPirate_"+i, "citiz_"+(i+40), "man", "man", iRank, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, iRank, 30+iRank, 30+iRank, "blade_10", "pistol1", "bullet", 70+iRank);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.dialog.FileName = "Quest\Portugal_dialog.c";
		sld.dialog.currentnode = "Vaskezs_pirate";
		sld.greeting = "town_pirate";		
		GetCharacterPos(pchar, &locx, &locy, &locz);
        
		LAi_SetWarriorType(sld);
		if (i == 1)
		{
			ChangeCharacterAddressGroup(sld, "LeFransua_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
		}
		else
		{
			LAi_CharacterDisableDialog(sld);
			ChangeCharacterAddressGroup(sld, "LeFransua_town", "goto", "goto"+i);
		}
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void CreateVaskezsFrigate(string qName)//атака фрегата Васкеза // patch-9
{
	Island_SetReloadEnableGlobal("Martinique", false);
	sld = characterFromId("Portugal");
	LAi_SetStayType(sld);
	LAi_CharacterDisableDialog(sld);//запрет диалога
	RemoveCharacterEquip(sld, BLADE_ITEM_TYPE);
	RemoveCharacterEquip(sld, GUN_ITEM_TYPE);
	ChangeCharacterAddressGroup(sld, "My_Deck", "goto", "goto6");//Португальца в трюм
	Group_FindOrCreateGroup("VaskezFrigate");
	sld = GetCharacter(NPC_GenerateCharacter("Vaskezs_helper", "mercen_"+(rand(27)+1), "man", "man", 25+MOD_SKILL_ENEMY_RATE, PIRATE, -1, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_FRIGATE, "Albatross", CANNON_TYPE_CANNON_LBS24, 90, 90, 90);
	FantomMakeCoolFighter(sld, 25+MOD_SKILL_ENEMY_RATE, 70, 70, "blade_10", "pistol3", "grapeshot", 100);
	sld.AlwaysEnemy = true;
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.WatchFort = true;//видеть форты
	Group_AddCharacter("VaskezFrigate", "Vaskezs_helper");
	Group_SetGroupCommander("VaskezFrigate", "Vaskezs_helper");
	Group_SetTaskAttack("VaskezFrigate", PLAYER_GROUP);
	Group_SetAddress("VaskezFrigate", "Martinique", "quest_ships", "quest_ship_6");
	Group_LockTask("VaskezFrigate");
	pchar.quest.VaskezFrigate_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.VaskezFrigate_AfterBattle.win_condition.l1.group = "VaskezFrigate";
	pchar.quest.VaskezFrigate_AfterBattle.function = "VaskezFrigate_AfterBattle";
	pchar.quest.VaskezFrigate_DieHard.win_condition.l1 = "MapEnter";
	pchar.quest.VaskezFrigate_DieHard.function = "VaskezFrigate_DieHard";
}

void VaskezFrigate_AfterBattle(string qName)//победили
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.VaskezFrigate_DieHard.over = "yes";
	Group_DeleteGroup("VaskezFrigate");
	Island_SetReloadEnableGlobal("Martinique", true);
	AddComplexSeaExpToScill(250, 150, 150, 150, 150, 150, 0);
	ChangeOfficersLoyality("good_all", 1);
	pchar.questTemp.Portugal.Condition2 = "true";
	bQuestDisableMapEnter = true;
	AddQuestRecord("Portugal", "18");
	sld = characterFromId("Portugal");
	sld.dialog.currentnode = "Portugal_treasure";
	LAi_CharacterEnableDialog(sld);//разрешение диалога
}

void VaskezFrigate_DieHard(string qName)//сбежали
{
	pchar.quest.VaskezFrigate_AfterBattle.over = "yes";
	Group_DeleteGroup("VaskezFrigate");
	Island_SetReloadEnableGlobal("Martinique", true);
	ChangeOfficersLoyality("bad_all", 1);
	AddQuestRecord("Portugal", "19");
	sld = characterFromId("Portugal");
	sld.dialog.currentnode = "Portugal_treasure";
	LAi_CharacterEnableDialog(sld);//разрешение диалога
}

void RemovePortugal(string qName)//Португальца - вон
{
	sld = characterFromId("Portugal");
	sld.lifeday = 0;
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "", "", "none", "", "", "", 1.0);
	CloseQuestHeader("Portugal");
	pchar.questTemp.Portugal = "end";
	log_info("Bart the Portuguese has left your ship!");
}

void CreateHollIndBattle(string qName)//массовая драка в джунглях с индейцами и голландцами
{
	chrDisableReloadToLocation = true;
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 10 + 2*sti(pchar.rank);
	//ставим голландцев
	for (i=1; i<=10; i++)
	{
		if (i >= 1 && i <= 3)
		{
			sld = GetCharacter(NPC_GenerateCharacter("PortHol_"+i, "mush_hol_"+i, "man", "mushketer", iRank, HOLLAND, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
			sld.MusketerDistance = 0;
			ChangeCharacterAddressGroup(sld, "Terks_Jungle_01", "rld", "aloc"+(4+i));
		}
		else
		{
			if (i == 4)
			{
				sld = GetCharacter(NPC_GenerateCharacter("PortHol_"+i, "off_hol_"+i, "man", "man", iRank, HOLLAND, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank+7, iScl+5, iScl+5, "blade_20", "pistol1", "bullet", iScl*2);
				ChangeCharacterAddressGroup(sld, "Terks_Jungle_01", "rld", "aloc8");
				LAi_SetImmortal(sld, true);
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("PortHol_"+i, "sold_hol_"+(5+i), "man", "man", iRank, HOLLAND, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_19", "pistol1", "bullet", iScl*2);
				ChangeCharacterAddressGroup(sld, "Terks_Jungle_01", "rld", "aloc9");
			}
		}
		LAi_SetWarriorType(sld);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_group_Register("PortHoll");
		LAi_group_MoveCharacter(sld, "PortHoll");
	}
	//ставим индеев
	for (i=1; i<=12; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("PortInd_"+i, "canib_"+(rand(5)+1), "man", "man", iRank, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_02", "", "", iScl*2);
		ChangeCharacterAddressGroup(sld, "Terks_Jungle_01", "goto", "goto4");
		LAi_SetWarriorType(sld);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_group_Register("PortInd");
		LAi_group_MoveCharacter(sld, "PortInd");
	}
	//стравим все группы
	LAi_group_SetRelation("PortInd", "PortHoll", LAI_GROUP_ENEMY);
	LAi_group_FightGroups("PortInd", "PortHoll", true);
	LAi_group_SetRelation("PortHoll", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("PortHoll", LAI_GROUP_PLAYER, true);
	LAi_group_SetRelation("PortInd", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("PortInd", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("PortInd", "CheckPortHoll");
}

void DigPortugalGems(string qName)//могу копать, могу не копать :)
{
	DoQuestCheckDelay("TalkSelf_Quest", 0.1);
}

void CreatePortugalHollShip(string qName)//голландский фрегат // patch-9
{
	Island_SetReloadEnableGlobal("Terks", false);
	Group_FindOrCreateGroup("PortHolFrigate");
	sld = GetCharacter(NPC_GenerateCharacter("PortHolCap", "off_hol_5", "man", "man", sti(PChar.rank)+MOD_SKILL_ENEMY_RATE, HOLLAND, -1, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_FRIGATE, "", CANNON_TYPE_CANNON_LBS24, 90, 90, 90);
	FantomMakeCoolFighter(sld, sti(PChar.rank)+MOD_SKILL_ENEMY_RATE, 70, 70, "blade_21", "pistol3", "grapeshot", 100);
	sld.AlwaysEnemy = true;
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	Group_AddCharacter("PortHolFrigate", "PortHolCap");
	Group_SetGroupCommander("PortHolFrigate", "PortHolCap");
	Group_SetTaskAttack("PortHolFrigate", PLAYER_GROUP);
	Group_SetPursuitGroup("PortHolFrigate", PLAYER_GROUP);
	Group_SetAddress("PortHolFrigate", "Terks", "", "");
	Group_LockTask("PortHolFrigate");
	pchar.quest.PortHolFrigate_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.PortHolFrigate_AfterBattle.win_condition.l1.group = "PortHolFrigate";
	pchar.quest.PortHolFrigate_AfterBattle.function = "PortHolFrigate_AfterBattle";
	pchar.quest.PortHolFrigate_DieHard.win_condition.l1 = "MapEnter";
	pchar.quest.PortHolFrigate_DieHard.function = "PortHolFrigate_DieHard";
	pchar.quest.Portugal_Terks2.win_condition.l1 = "location";
	pchar.quest.Portugal_Terks2.win_condition.l1.location = "Marigo_tavern";
	pchar.quest.Portugal_Terks2.function = "SetAvendelMarigo";
	SetFunctionTimerCondition("SetAvendelMarigoOver", 0, 0, 30, false);
}

void PortHolFrigate_AfterBattle(string qName)//победили
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.PortHolFrigate_DieHard.over = "yes";
	Group_DeleteGroup("PortHolFrigate");
	Island_SetReloadEnableGlobal("Terks", true);
	AddComplexSeaExpToScill(150, 100, 100, 100, 100, 100, 0);
	ChangeOfficersLoyality("good_all", 1);
	AddQuestRecord("Portugal", "26");
}

void PortHolFrigate_DieHard(string qName)//сбежали
{
	pchar.quest.PortHolFrigate_AfterBattle.over = "yes";
	Group_DeleteGroup("PortHolFrigate");
	Island_SetReloadEnableGlobal("Terks", true);
	ChangeOfficersLoyality("bad_all", 1);
	AddQuestRecord("Portugal", "27");
}

void SetAvendelMarigoOver(string qName)//счищаем Авендела и Португальца
{
	sld = characterFromId("Avendel");
	sld.lifeday = 0;
	sld = characterFromId("Portugal");
	sld.lifeday = 0;
	AddQuestRecord("Portugal", "28");
	CloseQuestHeader("Portugal");
	pchar.questTemp.Portugal = "end";
}

void SetAvendelMarigo(string qName)//Авендел в таверне Мариго
{
	sld = characterFromId("Avendel");
	sld.dialog.currentnode = "Avendel_Marigo";
	LAi_SetSitType(sld);
	FreeSitLocator("Marigo_tavern", "sit_front1");
	ChangeCharacterAddressGroup(sld, "Marigo_tavern", "sit", "sit_front1");
}

void InMarigoResidence()//в резиденции Мариго
{
	AddQuestRecord("Portugal", "29");
	SetFunctionTimerCondition("InMarigoResidenceOver", 0, 0, 5, false);
	sld = GetCharacter(NPC_GenerateCharacter("PortServant" , "shipowner_10", "man", "man", 10, HOLLAND, 5, true, "quest"));
	FantomMakeCoolFighter(sld, 10, 10, 10, "", "", "", 10);
	sld.dialog.FileName = "Quest\Portugal_dialog.c";
	sld.dialog.currentnode = "Servant";
	sld.greeting = "worker";
	LAi_SetOwnerType(sld);
	ChangeCharacterAddressGroup(sld, "Marigo_TownhallRoom", "goto", "goto1");
}

void InMarigoResidenceOver(string qName)//счищаем Португальца
{
	sld = characterFromId("Portugal");
	sld.lifeday = 0;
	if (pchar.questTemp.Portugal == "SeekPortVillemstad" || pchar.questTemp.Portugal == "PortugalInPrison") AddQuestRecord("Portugal", "33");
	else AddQuestRecord("Portugal", "30");
	CloseQuestHeader("Portugal");
	pchar.questTemp.Portugal = "end";
}

void CreateErnandoVaskez()//появился Васкез
{
	sld = GetCharacter(NPC_GenerateCharacter("Vaskez", "Vasces", "man", "man", 35, PIRATE, -1, true, "soldier"));
	FantomMakeCoolFighter(sld, sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+15, 100, 100, "blade_10", "pistol6", "bullet", 200);
	sld.name = "Ernando";
	sld.lastname = "Vaskez";
	sld.dialog.FileName = "Quest\Portugal_dialog.c";
	sld.dialog.currentnode = "Vaskez";
	sld.greeting = "vaskez";
	SetCharacterPerk(sld, "SwordplayProfessional");
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_prison", "reload", "reload9");
	LAi_ActorDialogNow(sld, pchar, "", -1);
}
//<-- Португалец конец

//////////////////////////////////////////////////////////////////////////////////////////////////////////
// Jason ----------------------------------------Цена чахотки--------------------------------------------
//////////////////////////////////////////////////////////////////////////////////////////////////////////
void Consumption_CommandantHouse(string qName)//создаем слугу и заполняем сундуки
{
	pchar.questTemp.Consumption.House = "true";//атрибут, что пришел
	chrDisableReloadToLocation = true;
	int iRank = sti(pchar.rank)+10;
	int iScl = 20 + 2*sti(pchar.rank);
	sld = GetCharacter(NPC_GenerateCharacter("Conservant_1", "citiz_5", "man", "man", iRank, SPAIN, -1, true, "quest"));
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_10", "pistol1", "bullet", iScl*2);
	sld.dialog.FileName = "Quest\LineMiniQuests\Consumption.c";
	sld.dialog.currentnode = "Servant";
	sld.greeting = "citizen_male";
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "PortSpein_houseF2", "goto", "goto4");
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	//заполним сундуки
	pchar.GenQuestBox.PortSpein_houseF2 = true;
	pchar.GenQuestBox.PortSpein_houseF2.box1.items.cannabis6 = 1;
	pchar.GenQuestBox.PortSpein_houseF2.box1.items.jewelry42 = 1;
	pchar.GenQuestBox.PortSpein_houseF2.box1.items.astrolab = 1;
	pchar.GenQuestBox.PortSpein_houseF2.box1.items.cirass2 = 1;
	pchar.GenQuestBox.PortSpein_houseF2.box1.items.gold_dublon = 44;
	pchar.GenQuestBox.PortSpein_houseF2.box2.items.potion2 = 15;
	pchar.GenQuestBox.PortSpein_houseF2.box2.items.jewelry6 = 72;
	pchar.GenQuestBox.PortSpein_houseF2.box2.items.jewelry3 = 12;
	pchar.GenQuestBox.PortSpein_houseF2.box2.items.indian_4 = 1;
	pchar.GenQuestBox.PortSpein_houseF2.box2.items.pistol6 = 1;
	pchar.GenQuestBox.PortSpein_houseF2.box3.items.letter_consumption = 1;
	pchar.GenQuestBox.PortSpein_houseF2.box3.items.map_trinidad = 1;
	pchar.GenQuestBox.PortSpein_houseF2.box3.items.recipe_berserker_potion = 1; // patch-9
	pchar.GenQuestBox.PortSpein_houseF2.box3.items.berserker_potion = 1; // patch-9
	pchar.GenQuestBox.PortSpein_houseF2.box3.items.jewelry15 = 1;
	pchar.GenQuestBox.PortSpein_houseF2.box3.items.gold_dublon = 500;
	//прерывание на письмо
	pchar.quest.Consumption1.win_condition.l1 = "item";
	pchar.quest.Consumption1.win_condition.l1.item = "letter_consumption";
	pchar.quest.Consumption1.function = "ConsumptionFindLetter";
}

void ConsumptionFindLetter(string qName)//нашли письмо
{
	AddQuestRecord("Consumption", "7");
}

void Consumption_CreateSergio(string qName)//создаем Сержио
{
	chrDisableReloadToLocation = true;
	int iRank = sti(pchar.rank)+8;
	int iScl = 15 + 2*sti(pchar.rank); // patch-9
	sld = GetCharacter(NPC_GenerateCharacter("Sergio", "SerhioSaldo", "man", "man", iRank, SPAIN, -1, true, "quest"));
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_13", "pistol1", "bullet", iScl*2);
	sld.name = "Sergio";
    sld.lastname = "Saldo";
	sld.dialog.FileName = "Quest\LineMiniQuests\Consumption.c";
	sld.dialog.currentnode = "Sergio";
	sld.greeting = "soldier";
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	LAi_SetActorType(sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "PortSpein_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Consumption_MeetSergio(string qName)//пришли на встречу
{
	chrDisableReloadToLocation = true;
	pchar.quest.Consumption4.over = "yes"; //снять прерывание
	if (CheckAttribute(pchar, "questTemp.Consumption.House"))
	{//подчистим дом коменданта
		pchar.GenQuestBox.PortSpein_houseF2 = true;
		pchar.GenQuestBox.PortSpein_houseF2.box1.items.mineral1 = 1;
		pchar.GenQuestBox.PortSpein_houseF2.box2.items.mineral5 = 1;
		pchar.GenQuestBox.PortSpein_houseF2.box3.items.mineral6 = 1;
		if (!CheckAttribute(pchar, "questTemp.Consumption.Fight")) 
		{
			sld = characterFromId("Conservant_1");
			sld.lifeday = 0;
		}
	}
	else pchar.quest.Consumption.over = "yes"; //снять прерывание
	sld = characterFromId("Sergio");
	sld.dialog.currentnode = "Sergio_5";
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "PortSpein_Exittown", "rld", "aloc9");
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Consumption_FailSergio(string qName)//опоздали
{
	locations[FindLocation("PortSpein_Exittown")].DisableEncounters = false; //энкаутеры открыть
	LAi_LocationDisableOfficersGen("PortSpein_Exittown", false);//офицеров пускать
	pchar.quest.Consumption3.over = "yes"; //снять прерывание
	if (CheckAttribute(pchar, "questTemp.Consumption.House"))
	{//подчистим дом коменданта
		pchar.GenQuestBox.PortSpein_houseF2 = true;
		pchar.GenQuestBox.PortSpein_houseF2.box1.items.mineral1 = 1;
		pchar.GenQuestBox.PortSpein_houseF2.box2.items.mineral5 = 1;
		pchar.GenQuestBox.PortSpein_houseF2.box3.items.mineral6 = 1;
		if (!CheckAttribute(pchar, "questTemp.Consumption.Fight")) 
		{
			sld = characterFromId("Conservant_1");
			sld.lifeday = 0;
		}
	}
	else pchar.quest.Consumption.over = "yes"; //снять прерывание
	AddQuestRecord("Consumption", "9");
	Consumption_Close();
}

void Consumption_CreateBandits()//бандиты Хуана
{
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 10 + 2*sti(pchar.rank); // patch-9
	for (i=1; i<=3; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("Conbandit_"+i, "mush_ctz_2", "man", "mushketer", iRank, PIRATE, 0, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2); // patch-9
			sld.MusketerDistance = 0;
			ChangeCharacterAddressGroup(sld, "PortSpein_Exittown", "goto", "goto2");
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Conbandit_"+i, "citiz_"+(i+47), "man", "man", iRank, PIRATE, 0, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_17", "pistol3", "bullet", iScl*2); // patch-9
			DeleteAttribute(sld, "SaveItemsForDead");
			DeleteAttribute(sld, "DontClearDead");
			ChangeCharacterAddressGroup(sld, "PortSpein_Exittown", "rld", "aloc"+(i+4));
			if (sti(pchar.rank) > 7) SetCharacterPerk(sld, "SwordplayProfessional");
			if (i == 2)
			{
				sld.dialog.filename = "Quest\LineMiniQuests\Consumption.c";
				sld.dialog.currentnode = "Bandit";
				LAi_SetActorType(sld);
				LAi_ActorDialogNow(sld, pchar, "", -1);
			}
		}
	}
}

void Consumption_CreateJuan(string qName)//галеон Хуана
{
	pchar.quest.Consumption6.over = "yes"; //снять прерывание
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE; // patch-9
	int iScl = 15 + 2*sti(pchar.rank);
	int iCannon, iShip;
	if (sti(pchar.rank) < 11)
	{
		iShip = SHIP_GALEON_L;
		iCannon = CANNON_TYPE_CANNON_LBS20;
	}
	else
	{
		iShip = SHIP_GALEON_H;
		if (sti(pchar.rank) < 18) iCannon = CANNON_TYPE_CANNON_LBS24;
		else iCannon = CANNON_TYPE_CANNON_LBS32;
	}
	Island_SetReloadEnableGlobal("Trinidad", false);
	Group_FindOrCreateGroup("ConJuanShip");
	sld = GetCharacter(NPC_GenerateCharacter("ConJuan", "HuanTubercul", "man", "man", iRank, PIRATE, -1, true, "quest"));
	sld.name = "Juan";
    sld.lastname = "Consumption";
	FantomMakeSmallSailor(sld, iShip, "", iCannon, iScl, iScl, iScl, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_19", "pistol5", "bullet", iScl*3); // 280313
	sld.AlwaysEnemy = true;
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Coastal_Captain = true;
	sld.WatchFort = true;
	sld.Ship.Mode = "pirate";
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	if (sti(pchar.rank) > 7) SetCharacterPerk(sld, "SwordplayProfessional");
	if (sti(pchar.rank) > 14) SetCharacterPerk(sld, "CannonProfessional");
	if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("ConJuanShip", "ConJuan");
	Group_SetGroupCommander("ConJuanShip", "ConJuan");
	Group_SetTaskAttack("ConJuanShip", PLAYER_GROUP);
	Group_SetAddress("ConJuanShip", "Trinidad", "quest_ships", "quest_ship_8");
	Group_LockTask("ConJuanShip");
	pchar.quest.Consumption_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Consumption_AfterBattle.win_condition.l1.group = "ConJuanShip";
	pchar.quest.Consumption_AfterBattle.function = "Consumption_AfterBattle";
	pchar.quest.Consumption_DieHard.win_condition.l1 = "MapEnter";
	pchar.quest.Consumption_DieHard.function = "Consumption_DieHard";
}

void Consumption_AfterBattle(string qName)//победили
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.quest.Consumption_DieHard.over = "yes";
	Group_DeleteGroup("ConJuanShip");
	pchar.questTemp.Consumption = "final";
	if (CheckAttribute(pchar, "questTemp.Consumption.Abordage"))
	{
		AddComplexSeaExpToScill(250, 200, 200, 200, 200, 200, 0);
		ChangeOfficersLoyality("good_all", 1);
		AddQuestRecord("Consumption", "12");
		pchar.quest.Consumption_boom.win_condition.l1 = "NPC_Death";
		pchar.quest.Consumption_boom.win_condition.l1.character = "ConJuan_free";
		pchar.quest.Consumption_boom.function = "Consumption_OpenLocation";//для извращенцев
		bDisableSailTo = true;
	}
	else
	{
		Island_SetReloadEnableGlobal("Trinidad", true);
		ChangeOfficersLoyality("bad_all", 1);
		AddQuestRecord("Consumption", "13");
		Consumption_Close();
	}
}

void Consumption_OpenLocation(string qName)//открыть локацию
{
	log_Testinfo("ОСТРОВ ОТКРЫТ!!!");
	bDisableSailTo = false;
	Island_SetReloadEnableGlobal("Trinidad", true);
}

void Consumption_DieHard(string qName)//сбежали
{
	pchar.quest.Consumption_AfterBattle.over = "yes";
	Group_DeleteGroup("ConJuanShip");
	Island_SetReloadEnableGlobal("Trinidad", true);
	ChangeOfficersLoyality("bad_all", 1);
	AddQuestRecord("Consumption", "14");
	Consumption_Close();
}

void Consumption_FailJuan(string qName)//опоздали
{
	pchar.quest.Consumption5.over = "yes";
	AddQuestRecord("Consumption", "15");
	Consumption_Close();
}

void Consumption_Close()//подчистка квеста и возврат официантки в норму
{
	sld = characterFromId("PortSpein_waitress");
	sld.dialog.filename = "Waitress_dialog.c";
	sld.dialog.currentnode = "First time";//вертаем ноду официантке
	CloseQuestHeader("Consumption");
	DeleteAttribute(pchar, "questTemp.Consumption");
}
//<-- Цена чахотки конец

// ---------------------------- генератор торговли смолами через Сержио Сальдо -------------------------------
void Oil_PrepareSergio(string qName) // прерывание на Сержио
{
	pchar.quest.Oil_Trinidad.win_condition.l1 = "location";
	pchar.quest.Oil_Trinidad.win_condition.l1.location = "Portspein_town";
	pchar.quest.Oil_Trinidad.function = "Oil_SetSergioTrinidad";
}

void Oil_SetSergioTrinidad(string qName) // Сержио активирует начало
{
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.GenQuest.Hunter2Pause = true; 
	sld = characterFromId("Sergio");	
	sld.Dialog.currentnode = "Sergio_20";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "Portspein_town", "goto", LAi_FindNearestLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Oil_SergioRuntoMayak(string qName) // 
{
	chrDisableReloadToLocation = false;
	sld = characterFromId("Sergio");	
	sld.Dialog.currentnode = "Sergio_26";
	LAi_SetActorType(sld);
	LAi_ActorRunToLocator(sld, "quest", "quest2", "", 10);
	DoQuestFunctionDelay("Oil_SetSergioToMayak", 10.0);
}

void Oil_SetSergioToMayak(string qName) // Сержио на маяке
{
	sld = characterFromId("Sergio");	
	if (CheckAttribute(pchar, "questTemp.OilTrade")) sld.Dialog.currentnode = "oil_trade";
	ChangeCharacterAddressGroup(sld, "Mayak1_Lighthouseroom", "goto", "goto2");
	LAi_SetGuardianType(sld);
	sld.protector = true;
	LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
	SetFunctionTimerCondition("Oil_SetSergioToMayakOver", 0, 0, 1, false); // таймер
}

void Oil_SetSergioToMayakOver(string qName) // не пришли - убираем Сержио
{
	if (GetCharacterIndex("Sergio") != -1)
	{
		sld = characterFromId("Sergio");	
		ChangeCharacterAddressGroup(sld, "none", "", "");
	}
}

void Oil_TradeFail(string qName) // прибили квестодателя - конец генератора
{
	DeleteAttribute(pchar, "questTemp.OilTrade");
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////
// Jason ---------------------------------------- Мангароса --------------------------------------------
//////////////////////////////////////////////////////////////////////////////////////////////////////////
void Mangarosa_Start(string qName) //нашли первую травку
{
	AddQuestRecord("Mangarosa", "1");
	pchar.questTemp.Mangarosa = "find";
	pchar.questTemp.Mangarosa.m_count = 0;
	pchar.questTemp.Mangarosa.g_count = 0;
}

void MangarosaEffect(string sEff)
{
	if (CheckAttribute(pchar, "questTemp.Mangarosa.Potion"))
	{
		DeleteAttribute(pchar, "questTemp.Mangarosa.Potion");
		Log_Info("An overdose of Mangarosa!");
		Log_Info("You are poisoned");
		Pchar.chr_ai.hp = stf(Pchar.chr_ai.hp)-50;
		LAi_CheckKillCharacter(pchar);
		AddCharacterHealth(pchar, -10); //сносим здоровье
		pchar.chr_ai.poison = 500; // травим
		if (stf(pchar.Health.HP) <= 1) LAi_KillCharacter(pchar);
	}
	else
	{
		Log_Info("A special potion of Mangarosa was used!");
		pchar.questTemp.Mangarosa.Potion.(sEff) = true;
		AddCharacterHealth(pchar, 4);
		pchar.quest.Mangarosa_del.win_condition.l1 = "Timer";
		pchar.quest.Mangarosa_del.win_condition.l1.date.hour  = rand(24); // 021012
		pchar.quest.Mangarosa_del.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 1);
		pchar.quest.Mangarosa_del.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 1);
		pchar.quest.Mangarosa_del.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 1);
		pchar.quest.Mangarosa_del.function = "Mangarosa_DeleteEffect";
	}
	RemoveItems(pchar, "mangarosa"+sEff, 1);
	PlaySound("Ambient\Tavern\glotok_001.wav");
}

void Mangarosa_DeleteEffect(string qName) //
{
	PlaySound("interface\notebook.wav");
	Log_Info("A potion of Mangarosa is not affecting you anymore");
	DeleteAttribute(pchar, "questTemp.Mangarosa.Potion");
}

void Colt_Timer(string qName) //
{
	sld = characterFromId("Jino");	
	sld.quest.cartridge = true;
}

//------------------------------------------------ клады ---------------------------------------------------
void Treasure_SetCaribWarrior()
{
	chrDisableReloadToLocation = true;//закрыть локацию
	int iRank = 10+sti(pchar.rank)+makeint(MOD_SKILL_ENEMY_RATE)/2;
	for(int i=1; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Treasure_carib_"+i, "canib_"+(rand(5)+1), "man", "man", iRank, PIRATE, 1, true, "native"));
		SetFantomParamFromRank(sld, iRank, true);
		sld.name = GetIndianName(MAN);
		sld.lastname = "";
		LAi_CharacterDisableDialog(sld);
		GetCharacterPos(pchar, &locx, &locy, &locz);
		ChangeCharacterAddressGroup(sld, pchar.location, "monsters", LAi_FindFarFreeLocator("monsters", locx, locy, locz));
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
		LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
		LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
		LAi_group_SetCheck("EnemyFight", "OpenTheDoors");
	}
}

void Treasure_SetBandosWarrior()
{
	chrDisableReloadToLocation = true;//закрыть локацию
	int iRank = 8+sti(pchar.rank)+makeint(MOD_SKILL_ENEMY_RATE)/2;
	for(int i=1; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Treasure_bandos_"+i, "citiz_"+(rand(9)+41), "man", "man", iRank, PIRATE, 1, true, "marginal"));
		SetFantomParamFromRank(sld, iRank, true);
		LAi_CharacterDisableDialog(sld);
		GetCharacterPos(pchar, &locx, &locy, &locz);
		ChangeCharacterAddressGroup(sld, pchar.location, "monsters", LAi_FindFarFreeLocator("monsters", locx, locy, locz));
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
		LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
		LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
		LAi_group_SetCheck("EnemyFight", "OpenTheDoors");
	}
}

void Treasure_SetCaptainWarrior(string qName) //
{
	string model;
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться // patch-6
	for(int i=1; i<=4; i++)
	{
		model = "citiz_"+(rand(9)+51);
		if (i > 1) model = "mercen_"+(rand(29)+1);
		sld = GetCharacter(NPC_GenerateCharacter("Treasure_sailor_"+i, model, "man", "man", iRank, PIRATE, 1, true, "soldier"));
		SetFantomParamFromRank(sld, iRank, true);
		sld.Dialog.Filename = "Hunter_dialog.c";
		sld.Dialog.currentnode = "TreasureCaptain";
		sld.greeting = "hunter";
		if (i > 1) LAi_CharacterDisableDialog(sld);
		GetCharacterPos(pchar, &locx, &locy, &locz);
		ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindFarLocator("goto", locx, locy, locz));
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void Treasure_SetOfficerWarrior(string qName) //
{
	string model;
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iNation = sti(colonies[FindColony(GetCityNameByIsland(Pchar.curIslandId))].nation);
	if (iNation == "") iNation = drand(3);
	if (iNation > 3) iNation = drand(3); // patch-6
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться // patch-6
	for(int i=1; i<=4; i++)
	{
		model = "off_"+NationShortName(iNation)+"_"+(rand(4)+1);
		if (i > 1) model = "sold_"+NationShortName(iNation)+"_"+(rand(7)+1);
		sld = GetCharacter(NPC_GenerateCharacter("Treasure_soldier_"+i, model, "man", "man", iRank, PIRATE, 1, true, "soldier"));
		SetFantomParamFromRank(sld, iRank, true);
		sld.Dialog.Filename = "Hunter_dialog.c";
		sld.Dialog.currentnode = "TreasureOfficer";
		sld.greeting = "patrol";
		if (i > 1) LAi_CharacterDisableDialog(sld);
		GetCharacterPos(pchar, &locx, &locy, &locz);
		ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindFarLocator("goto", locx, locy, locz));
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void TownPirate_battle(string qName) //
{
	bDisableFastReload = false;//открыть переход
	chrDisableReloadToLocation = true;
	for(int i=1; i<=12; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("PirateTownAttack_"+i, "citiz_"+(rand(9)+41), "man", "man", 35, PIRATE, 0, true, "soldier"));
		sld.City = "Pirates";
		sld.CityType = "citizen";
		FantomMakeCoolFighter(sld, 35, 100, 100, "blade_10", "pistol1", "bullet", 250);
		LAi_SetWarriorType(sld);
		GetCharacterPos(pchar, &locx, &locy, &locz);
		ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestLocator("goto", locx, locy, locz));
		LAi_group_MoveCharacter(sld, "PIRATE_CITIZENS");
	}
	SetNationRelation2MainCharacter(PIRATE, RELATION_ENEMY);
	LAi_group_Attack(sld, Pchar);
	DoQuestCheckDelay("OpenTheDoors", 120.0);
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//------------------------------------------------ Калеуче ---------------------------------------------------
//////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Caleuche_StartTotal(string qName) // квест Калеуче
{
	pchar.questTemp.Caleuche = "Start"; 
}

void Caleuche_StartGo(string qName) // этот долбоебизм вызван необходимостью типа не начинать новую игру... 
{
	if (!GetDLCenabled(DLC_APPID_1)) return;
	log_testinfo("Квест Калеуче стартовал!!!");
	pchar.questTemp.Caleuche = "Go";
	pchar.questTemp.Caleuche.SeekAmulet = "true"; 
	if (pchar.questTemp.HWIC.Detector == "self_win" || pchar.questTemp.HWIC.Detector == "holl_win") pchar.questTemp.Caleuche.Skul = "true";
	if (GetCharacterIndex("Landlady") != -1)
	{
		sld = characterFromId("Landlady");
		sld.lifeday = 0;
	}
	// находим
	pchar.quest.Caleuche_find_amulet.win_condition.l1 = "item";
	pchar.quest.Caleuche_find_amulet.win_condition.l1.item = "kaleuche_amulet1";
	pchar.quest.Caleuche_find_amulet.function = "Caleuche_FindFirstAmulet";
	// бухта Хаэль Роа
	int n = Findlocation("KhaelRoa_port");
	locations[n].image = "loading\haelroa.tga";
	locations[n].type = "questisland";
	locations[n].locators_radius.reload.reload2 = 2;
	locations[n].questflower = 1;
	// сюда ставим переменные для храма чавинцев
	// механизм 9 каменных плиток - определим маршрут
	pchar.questTemp.Caleuche.Tile = rand(4);
	switch (sti(pchar.questTemp.Caleuche.Tile))
	{
		case 0: pchar.questTemp.Caleuche.NextTile = "step1"; break;
		case 1: pchar.questTemp.Caleuche.NextTile = "step4"; break;
		case 2: pchar.questTemp.Caleuche.NextTile = "step7"; break;
		case 3: pchar.questTemp.Caleuche.NextTile = "step7"; break;
		case 4: pchar.questTemp.Caleuche.NextTile = "step1"; break;
	}
	// механизм 6 рычагов - определим последовательность
	pchar.questTemp.Caleuche.LeftLevers = rand(4);
	pchar.questTemp.Caleuche.RightLevers = rand(4);
	// ящик Мерримана
	sld = ItemsFromID("MerrimanBook");
	sld.picTexture = "ITEMS_18";
	sld.picIndex = 14;
	sld.model = "BrassBox";
	sld.shown = true; 
	sld.Weight = 8.0;
	sld.startLocation = "Havana_CryptDungeon";
	sld.startLocator = "item"+(rand(4)+1);
	// костюм Лампорта
	sld = ItemsFromID("suit4");
	sld.B_CirassLevel = 0.15;
	sld.G_CirassLevel = 0.10;
	DeleteAttribute(sld, "critical");
	// харки калеуче 'без новой игры' - в принципе все равно до конца не работает, но пусть будет
	ref refShip;
	makeref(refShip,ShipsTypes[SHIP_CURSED_FDM]);
	refShip.MaxCaliber      			= 36;
	refShip.Capacity        			= 6000;
	refShip.CannonsQuantity				= 56;
	refShip.CannonsQuantityMin			= 56;
	refShip.rcannon 					= 23;
	refShip.lcannon 					= 23;
	refShip.fcannon 					= 6;
	refShip.bcannon 					= 4;
	refShip.MaxCrew         			= 777;
	refShip.OptCrew         			= 622;
	refShip.MinCrew         			= 94;	
	refShip.SpeedRate					= 15.2;
	refShip.TurnRate        			= 32.0;
	refShip.Price           			= 100000;
	refShip.HP              			= 6666;
}

void Caleuche_FindFirstAmulet(string qName) // нашли первый амулет
{
	DeleteAttribute(pchar, "questTemp.Caleuche.SeekAmulet");
	AddQuestRecord("Caleuche", "1");
	pchar.questTemp.Caleuche = "amulet"; 
	// определяем знатока амулетов из двух смотрителей
	if (rand(1) == 0) pchar.questTemp.Caleuche.Amuletmaster = "BasTer_Lightman";
	else pchar.questTemp.Caleuche.Amuletmaster = "Santiago_Lightman";
}

void Caleuche_CreateShamane()// создаем Туттуатхапака - шамана
{
	if (!GetDLCenabled(DLC_APPID_1)) return;
	sld = GetCharacter(NPC_GenerateCharacter("Tuttuat", "Tuttuathapack", "man", "man_A1", 30, PIRATE, -1, true, "native"));
	SetFantomParamFromRank(sld, 30, true);
	RemoveAllCharacterItems(sld, true);
	sld.name = "Tuttuathapak";
	sld.lastname = "";
	sld.dialog.FileName = "Quest\Caleuche_dialog.c";
	sld.dialog.currentnode = "Tuttuat";
	sld.greeting = "urakan";
	LAi_SetStayTypeNoGroup(sld);
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "IndianlTown_shack2", "quest", "quest1");
}

void Caleuche_PrepareGhostship(string qName) // готовим первую атаку Калеуче
{
	for (int i=0;i<MAX_ISLANDS;i++)
	{				
		if (Islands[i].id == "Dominica")
		{
			Islands[i].alwaysStorm = true; 
			Islands[i].storm = true;
		}
	}
	Island_SetReloadEnableGlobal("Dominica", false);//на остров нельзя			
	bQuestDisableMapEnter = true;
	DoQuestFunctionDelay("Caleuche_CreateGhostship", 25.0);
}

void Caleuche_CreateGhostship(string qName)//подгружаем в море Калеуче
{
	if (!GetDLCenabled(DLC_APPID_1)) return;
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	Group_FindOrCreateGroup("Caleuche_Attack");
	sld = GetCharacter(NPC_GenerateCharacter("Caleuche_seacap", "skeletcap", "man", "man", iRank, PIRATE, -1, true, "quest"));
	sld.name = "captain-undead";
	sld.lastname = "";
	sld.dialog.FileName = "Quest\Caleuche_dialog.c";
	sld.dialog.currentnode = "CaleucheCap";
	FantomMakeCoolSailor(sld, SHIP_CURSED_FDM, "Ghost ship", CANNON_TYPE_CANNON_LBS32, 90, 90, 90);
	FantomMakeCoolFighter(sld, iRank, 90, 90, "blade_21", "pistol5", "bullet", 200);
	NullCharacterGoods(sld); // удаляем все товары, чтобы не стрелял
	LAi_SetImmortal(sld, true);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.PoisonResistent = true; // Captain Beltrop, 06.10.2020, нет отравлению ядом Таино
	sld.DontHitInStorm = true; // не ломается в шторм
	sld.Abordage.Enable = false; // запрет абордажа
	SetShipSailsFromFile(sld, "ships/parus_common.tga");
	SetSailsColor(sld, 8);//черный рваный парус
	ref shTo = &RealShips[sti(sld.Ship.Type)];
	shTo.SpeedRate = 30.0;
	shTo.TurnRate = 70.0;
	SetCrewQuantityOverMax(sld, 666);
	Group_AddCharacter("Caleuche_Attack", "Caleuche_seacap");
    Group_SetGroupCommander("Caleuche_Attack", "Caleuche_seacap");
	Group_SetTaskAttack("Caleuche_Attack", PLAYER_GROUP);
    Group_LockTask("Caleuche_Attack");
	SetCharacterRelationBoth(sti(sld.index), GetMainCharacterIndex(), RELATION_ENEMY);
	Sea_LoginGroupCurrentSea("Caleuche_Attack");
	Group_SetTaskAttack("Caleuche_Attack", PLAYER_GROUP);
	Ship_SetTaskAttack(SECONDARY_TASK, sti(sld.index), GetMainCharacterIndex());
	DoQuestCheckDelay("Caleuche_Video", 1.5);
}

void Caleuche_GhostshipBoarding() // калеуче готовит абордаж
{
	PlaySound("interface\_GTBoard0.wav");
	SetLaunchFrameFormParam("", "", 0, 4);
	SetLaunchFrameFormPic("loading\boarding_b3.tga");
	LaunchFrameForm();
	DoQuestFunctionDelay("Caleuche_GhostshipBoardingGo", 4.0);
}

void Caleuche_GhostshipBoardingGo(string qName) // калеуче идет на абордаж
{
	for (int i=0;i<MAX_LOCATIONS;i++)
	{				
		if (Locations[i].id == "Deck_Galeon_Ship")
		{
			Locations[i].alwaysStorm = true; 
			Locations[i].storm = true;
		}
	}
	LAi_LocationFightDisable(&Locations[FindLocation("Deck_Galeon_Ship")], false);//разрешить драться
	DoQuestReloadToLocation("Deck_Galeon_Ship", "reload", "reload2", "Caleuche_GhostshipBoardingDeck");
}

void Caleuche_PrepareBeliz(string qName) // готовим локации Белиза
{
	locations[FindLocation("Beliz_ExitTown")].DisableEncounters = true; 
	locations[FindLocation("Beliz_Jungle_01")].DisableEncounters = true; 
	locations[FindLocation("Beliz_CaveEntrance_1")].DisableEncounters = true; 
	locations[FindLocation("Beliz_Cave")].DisableEncounters = true; 
	locations[FindLocation("Beliz_CaveEntrance_2")].DisableEncounters = true; 
	locations[FindLocation("Beliz_Cave_2")].DisableEncounters = true; 
	locations[FindLocation("Beliz_CaveEntrance_3")].DisableEncounters = true; 
	locations[FindLocation("Beliz_jungle_03")].DisableEncounters = true; 
}

void Caleuche_FergusCome(string qName) // Фергус в таверне Белиза
{
	if (!GetDLCenabled(DLC_APPID_1)) return;
	sld = GetCharacter(NPC_GenerateCharacter("Fergus", "mercen_16", "man", "man", 20, ENGLAND, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 20, 50, 50, "blade_12", "pistol1", "bullet", 50);
	sld.name = "Fergus";
	sld.lastname = "Hooper";
	sld.dialog.FileName = "Quest\Caleuche_dialog.c";
	sld.dialog.currentnode = "fergus";
	sld.greeting = "marginal";
	LAi_SetSitType(sld);
	LAi_SetImmortal(sld, true);
	FreeSitLocator("Beliz_tavern", "sit_front1");
	ChangeCharacterAddressGroup(sld, "Beliz_tavern", "sit", "sit3");
	LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
	LAi_SetLoginTime(sld, 18.0, 22.0);
}

void Caleuche_FindLetter(string qName) // 
{
	chrDisableReloadToLocation = false;//открыть локацию
	AddQuestRecord("Caleuche", "12");
	pchar.quest.Caleuche_junglebandos.win_condition.l1 = "location";
	pchar.quest.Caleuche_junglebandos.win_condition.l1.location = "Beliz_Jungle_01";
	pchar.quest.Caleuche_junglebandos.win_condition.l2 = "Hour";
	pchar.quest.Caleuche_junglebandos.win_condition.l2.start.hour = 0.00;
	pchar.quest.Caleuche_junglebandos.win_condition.l2.finish.hour = 3.00;
	pchar.quest.Caleuche_junglebandos.function = "Caleuche_LoginJungleBandos";
}

void Caleuche_LoginJungleBandos(string qName) // бандосы в лесу
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	chrDisableReloadToLocation = true;//закрыть локацию
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 60;
	for (int i=1; i<=6; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("Beliz_forestbandos_"+i, "mercen_20", "man", "man", iRank+5, PIRATE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank+5, iScl, iScl, "blade_13", "pistol4", "bullet", iScl*2+100);
			sld.dialog.FileName = "Quest\Caleuche_dialog.c";
			sld.dialog.currentnode = "Beliz_forestbandos";	
			sld.greeting = "banditos"; 
			LAi_SetCheckMinHP(sld, 10, true, "Caleuche_HeadBandosEscape");
			ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto3");
			LAi_SetActorType(sld);
			LAi_ActorDialog(sld, pchar, "", -1, 0);
		}
		else
		{
			if (i == 2)
			{
				sld = GetCharacter(NPC_GenerateCharacter("Beliz_forestbandos_"+i, "mush_ctz_9", "man", "mushketer", iRank, PIRATE, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "bullet", iScl*2);
				LAi_CharacterDisableDialog(sld);
				ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto3");
				LAi_SetActorType(sld);
				LAi_ActorDialog(sld, pchar, "", -1, 0);
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("Beliz_forestbandos_"+i, "citiz_4"+i, "man", "man", iRank, PIRATE, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_10", "pistol1", "bullet", iScl*2);
				LAi_CharacterDisableDialog(sld);
				ChangeCharacterAddressGroup(sld, pchar.location, "goto", "ass"+(i+2));
				LAi_SetSitType(sld);
			}
		}
		LAi_group_MoveCharacter(sld, "TMP_FRIEND");
	}
	// костер
	ref location = &Locations[FindLocation(pchar.location)];
	ref rItm = ItemsFromID("fire");
	rItm.shown = true;
	rItm.startLocation = location.id;
	rItm.startLocator = "fire";
	location.fire = true;
}

void Caleuche_JungleBandosRobbery(string qName) // 
{
	// купец с конвоем
	LAi_group_Delete("EnemyFight");
	chrDisableReloadToLocation = true;//закрыть локацию
	int iRank = 22+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 65;
	for (int i=1; i<=7; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("Beliz_forestmerchant_"+i, "trader_1", "man", "man", iRank, PIRATE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_13", "pistol6", "bullet", iScl*2);
			ChangeCharacterAddressGroup(sld, pchar.location, "rld", "loc1");
			LAi_SetWarriorType(sld);
		}
		else
		{
			if (i > 1 && i < 4)
			{
				sld = GetCharacter(NPC_GenerateCharacter("Beliz_forestmerchant_"+i, "mush_ctz_"+i, "man", "mushketer", iRank, PIRATE, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "", "mushket2", "cartridge", iScl*2+70);
				ChangeCharacterAddressGroup(sld, pchar.location, "rld", "loc1");
				LAi_SetWarriorType(sld);
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("Beliz_forestmerchant_"+i, "citiz_2"+i, "man", "man", iRank, PIRATE, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_11", "pistol5", "bullet", iScl*2+70);
				ChangeCharacterAddressGroup(sld, pchar.location, "rld", "loc1");
				LAi_SetWarriorType(sld);
			}
		}
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	for (i=1; i<=6; i++)
	{
		sld = characterFromId("Beliz_forestbandos_"+i);	
		sld.LSC_clan = true;
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Caleuche_ForestMerchantDie");
	LAi_SetFightMode(pchar, true);
}

void Caleuche_CaveOpen(string qName) // 
{
	LocatorReloadEnterDisable("Beliz_CaveEntrance_2", "reload1_back", false); // открываем пещеру
	pchar.quest.Caleuche_amulet2.win_condition.l1 = "item";
	pchar.quest.Caleuche_amulet2.win_condition.l1.item = "kaleuche_amulet2";
	pchar.quest.Caleuche_amulet2.function = "Caleuche_SecondAmuletFind";
}

void Caleuche_SecondAmuletFind(string qName) // 
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	chrDisableReloadToLocation = true;//закрыть локацию
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 70;
	for (int i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Beliz_cavebandos_"+i, "citiz_2"+i, "man", "man", iRank, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_06", "pistol6", "bullet", 250);
		sld.dialog.FileName = "Quest\Caleuche_dialog.c";
		sld.dialog.currentnode = "Beliz_cavebandos";	
		sld.greeting = "banditos"; 
		if (i == 2) LAi_CharacterDisableDialog(sld);
		ChangeCharacterAddressGroup(sld, pchar.location, "monsters", "monster"+(33+i));
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
	// Калеуче почуял амулет
	pchar.quest.Caleuche_Prepare_MapAttack.win_condition.l1 = "MapEnter";
	pchar.quest.Caleuche_Prepare_MapAttack.function = "Caleuche_PrepareMapAttack";
}

void Caleuche_BelizbandosClear(string qName) // чистим всё по квесту
{
	locations[FindLocation("Beliz_ExitTown")].DisableEncounters = false; 
	locations[FindLocation("Beliz_Jungle_01")].DisableEncounters = false; 
	locations[FindLocation("Beliz_CaveEntrance_1")].DisableEncounters = false; 
	locations[FindLocation("Beliz_Cave")].DisableEncounters = false; 
	locations[FindLocation("Beliz_CaveEntrance_2")].DisableEncounters = false; 
	locations[FindLocation("Beliz_Cave_2")].DisableEncounters = false; 
	locations[FindLocation("Beliz_CaveEntrance_3")].DisableEncounters = false; 
	locations[FindLocation("Beliz_jungle_03")].DisableEncounters = false;
	LAi_LocationDisableOfficersGen("Beliz_ExitTown", false);
	LAi_LocationDisableOfficersGen("Beliz_Jungle_01", false);
	LAi_LocationDisableOfficersGen("Beliz_CaveEntrance_1", false);
	LAi_LocationDisableOfficersGen("Beliz_Cave", false);
	LAi_LocationDisableOfficersGen("Beliz_CaveEntrance_2", false);
	LAi_LocationDisableOfficersGen("Beliz_Cave_2", false);
	LAi_LocationDisableOfficersGen("Beliz_CaveEntrance_3", false);
	LAi_LocationDisableOfficersGen("Beliz_jungle_03", false);
	DeleteAttribute(pchar, "questTemp.Caleuche.Bandos");
	DeleteAttribute(pchar, "questTemp.Caleuche.belizbandos");
}

void Caleuche_BelizRegard(string qName) // 
{
	pchar.questTemp.Caleuche.BelizRegard = "true";
}

void Caleuche_PrepareMapAttack(string qName) // 
{
	SetFunctionTimerCondition("Caleuche_MapAttack", 0, 0, 3, false); // таймер
}

void Caleuche_MapAttack(string qName) // корабль-призрак ищет ГГ
{
	if (!GetDLCenabled(DLC_APPID_1)) return;
	if (!Caleuche_CheckAmulet()) return;
	string sCapId = "Map_Caleuche";
    string sGroup = "Sea_" + sCapId + "1";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	
	sld = GetCharacter(NPC_GenerateCharacter(sCapId, "skeletcap", "man", "man", 45, PIRATE, -1, true, "quest"));
	sld.name = "captain-undead";
	sld.lastname = "";
	FantomMakeCoolSailor(sld, SHIP_CURSED_FDM, "Ghost ship", CANNON_TYPE_CANNON_LBS32, 105, 105, 105);
	FantomMakeCoolFighter(sld, 45, 100, 100, "blade_21", "pistol5", "bullet", 300);
	LAi_SetImmortal(sld, true);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.DontHitInStorm = true; // не ломается в шторм
	sld.Abordage.Enable = false; // запрет абордажа
	SetShipSailsFromFile(sld, "ships/parus_common.tga");
	SetSailsColor(sld, 8);//черный рваный парус
	ref shTo = &RealShips[sti(sld.Ship.Type)];
	shTo.SpeedRate = 30.0;
	shTo.TurnRate = 70.0;
	SetCrewQuantityOverMax(sld, 666);
	sld.mapEnc.type = "war";
    sld.mapEnc.Name = "ghost ship";
	sld.mapEnc.worldMapShip = "pirates_manowar";
	
	Group_AddCharacter(sGroup, sCapId);
	Group_SetGroupCommander(sGroup, sCapId);
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
    Map_CreateCoolWarrior("", sCapId, 5);
}

void Caleuche_ClearFromMap(string qName) // стираем энкаунтер Калеуче и ставим новый таймер
{
	log_info("You have escaped from the ghost ship!");
	PlaySound("MUSIC\Victory.mp3");
	Group_DeleteGroup("Sea_Map_Caleuche1");
	SetFunctionTimerCondition("Caleuche_MapAttack", 0, 0, 4, false); // таймер
	AddCharacterExpToSkill(pchar, "Sailing", 50);
}

void Caleuche_MapGhostshipBoarding() // подпустили слишком близко - пипец котенку
{
	pchar.GenQuest.FrameLockEsc = true;
	SetMusicAlarm("");
	PlaySound("interface\_GTBoard2.wav");
	PlaySound("interface\abordage2.wav");
	SetLaunchFrameFormParam("", "", 0, 15);
	SetLaunchFrameFormPic("loading\boarding_b3.tga");
	LaunchFrameForm();
	DoQuestCheckDelay("Caleuche_GhostshipGameOver", 15.0);
}

void Caleuche_CreateGarpiyaInWorld(string qName) // щебека Гарпия на карте
{
	if (!CheckAttribute(pchar, "questTemp.Caleuche.Garpiya")) return;
	
	string sStartCity, sTargetCity;
	if (pchar.questTemp.Garpiya == "to_portroyal")
	{
		sStartCity = "Marigo";
		sTargetCity = "PortRoyal";
	}
	else
	{
		sStartCity = "PortRoyal";
		sTargetCity = "Marigo";
	}
	
	string sCapId = "Map_Garpiya";
    string sGroup = "Sea_" + sCapId + "1";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	
	sld = GetCharacter(NPC_GenerateCharacter(sCapId, "mercen_20", "man", "man", 30, FRANCE, 13, true, "quest"));
	sld.name = "Reginald";
	sld.lastname = "Jackson";
	sld.greeting = "captain";
	sld.Dialog.Filename = "Quest\Caleuche_dialog.c";
	sld.DeckDialogNode = "reginald";
	FantomMakeCoolSailor(sld, SHIP_XebekVML, "Harpy", CANNON_TYPE_CULVERINE_LBS18, 70, 70, 70);
	FantomMakeCoolFighter(sld, 30, 70, 70, "blade_20", "pistol4", "bullet", 200);
	LAi_SetImmortal(sld, true);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.DontHitInStorm = true; // не ломается в шторм
	sld.Abordage.Enable = false; // запрет абордажа
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable  = true;
	sld.Ship.Mode = "trade";
	RealShips[sti(sld.Ship.Type)].ship.upgrades.hull = 1;
	SetCharacterPerk(sld, "MusketsShoot");
	
	sld.mapEnc.type = "trade";
    sld.mapEnc.Name = "xebec 'Harpy'";
	sld.mapEnc.worldMapShip = "ranger";
	
	Group_AddCharacter(sGroup, sCapId);
	Group_SetGroupCommander(sGroup, sCapId);
    //Group_LockTask(sGroup);
    Map_CreateTrader(sStartCity, sTargetCity, sCapId, 12);
	
	pchar.quest.Caleuche_garpiya_sea.win_condition.l1 = "Group_Death";
	pchar.quest.Caleuche_garpiya_sea.win_condition.l1.group = sGroup;
	pchar.quest.Caleuche_garpiya_sea.function = "Caleuche_CreateGarpiyaInSea";
}

void Caleuche_CreateGarpiyaInSea(string qName) // щебека Гарпия в порту
{
	if (!GetDLCenabled(DLC_APPID_1)) return;
	log_testinfo("Гарпия в порту");
	if (!CheckAttribute(pchar, "questTemp.Caleuche.Garpiya")) return;
	
	int iNation;
	string sTargetIsland;
	if (pchar.questTemp.Garpiya == "to_portroyal")
	{
		sTargetIsland = "Jamaica";
		iNation = ENGLAND;
	}
	else 
	{
		sTargetIsland = "SentMartin";
		iNation = HOLLAND;
	}
	
	string sCapId = "Sea_Garpiya";
    string sGroup = "XebecGarpiya";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	
	sld = GetCharacter(NPC_GenerateCharacter(sCapId, "mercen_20", "man", "man", 30, iNation, 2, true, "quest"));
	sld.name = "Reginald";
	sld.lastname = "Jackson";
	sld.Dialog.Filename = "Quest\Caleuche_dialog.c";
	sld.DeckDialogNode = "reginald";
	sld.greeting = "captain";
	FantomMakeCoolSailor(sld, SHIP_XebekVML, "Harpy", CANNON_TYPE_CULVERINE_LBS18, 70, 70, 70);
	FantomMakeCoolFighter(sld, 30, 70, 70, "blade_20", "pistol4", "bullet", 200);
	LAi_SetImmortal(sld, true);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.DontHitInStorm = true; // не ломается в шторм
	sld.Abordage.Enable = false; // запрет абордажа
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable  = true;
	sld.Ship.Mode = "trade";
	RealShips[sti(sld.Ship.Type)].ship.upgrades.hull = 1;
	SetCharacterPerk(sld, "MusketsShoot");
	
	Group_AddCharacter(sGroup, sCapId);
	Group_SetGroupCommander(sGroup, sCapId);
	Group_SetTaskNone(sGroup);//нет задачи
	Group_SetAddress(sGroup, sTargetIsland, "quest_ships", "Quest_ship_1");
	
	pchar.quest.Caleuche_garpiya_map.win_condition.l1 = "Group_Death";
	pchar.quest.Caleuche_garpiya_map.win_condition.l1.group = sGroup;
	pchar.quest.Caleuche_garpiya_map.function = "Caleuche_PrepareGarpiyaInWorld";
}

void Caleuche_PrepareGarpiyaInWorld(string qName) // подготовка к выходу на карту
{
	if (!CheckAttribute(pchar, "questTemp.Caleuche.Garpiya")) return;

	if (pchar.questTemp.Garpiya == "to_portroyal") pchar.questTemp.Garpiya = "to_marigo";
	else pchar.questTemp.Garpiya = "to_portroyal";
	DoQuestFunctionDelay("Caleuche_CreateGarpiyaInWorld", 1.0);
}

void Caleuche_ThirdAmuletFind(string qName) // нашли третий амулет
{
	AddQuestRecord("Caleuche", "21");
	SetFunctionTimerCondition("Caleuche_MapAttack", 0, 0, 1, false); // таймер
}

void Caleuche_CreateMonk(string qName) // ставим монаха в Виллемстад
{
	if (!GetDLCenabled(DLC_APPID_1)) return;
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = GetCharacter(NPC_GenerateCharacter("monk_caleuche", "monk_5", "man", "man_B", 5, HOLLAND, 1, false, "soldier"));
	FantomMakeCoolFighter(sld, 5, 10, 10, "", "", "", 20);
	sld.Dialog.Filename = "Quest\Caleuche_dialog.c";
	sld.Dialog.currentnode = "monk_caleuche";
	sld.greeting = "monk";
	LAi_SetImmortal(sld, true);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "villemstad_town", "goto", LAi_FindFarFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Caleuche_CreateJoakimSkel(string qName) // в комнате ночью
{
	LAi_group_Delete("EnemyFight");
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "goto", "goto2");
	CreateLocationParticles("large_smoke", "goto", "goto2", 0.5, 0, 0, "");
	DoQuestFunctionDelay("Caleuche_SetLandLedySkel", 5.0);
	DoQuestFunctionDelay("Terrapin_SetMusic", 1.2);
}

void Caleuche_SetLandLedySkel(string qName) // скелет хозяйки дома
{
	PlaySound("Types\skel.wav");
	int iRank = 20+MOD_SKILL_ENEMY_RATE*3;
	int iHp = 200+MOD_SKILL_ENEMY_RATE*80;
	sld = GetCharacter(NPC_GenerateCharacter("skel_landlady", "skelt", "skeleton", "skeleton_b", iRank, PIRATE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, iRank, 90, 90, "topor_02", "", "", 50);
	SetSPECIAL(sld, 10, 10, 10, 3, 3, 10, 10);
	LAi_SetHP(sld, iHp, iHp);
	if (MOD_SKILL_ENEMY_RATE > 4)
	{
		sld.cirassId = Items_FindItemIdx("cirass1");
		SetCharacterPerk(sld, "Energaiser");
		SetCharacterPerk(sld, "SwordplayProfessional");
		SetCharacterPerk(sld, "HardHitter");
	}
	float fMft = MOD_SKILL_ENEMY_RATE/10;
	sld.MultiFighter = 1.0+fMft; // мультифайтер
	sld.name = "dead hostess";
	sld.lastname = "";
	sld.monster = true;
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	GiveItem2Character(sld, "jewelry42");
	GiveItem2Character(sld, "jewelry45");
	GiveItem2Character(sld, "jewelry46");
	GiveItem2Character(sld, "jewelry43");
	GiveItem2Character(sld, "Mineral6");
	GiveItem2Character(sld, "purse1"); // Addon-2016
	LAi_SetActorType(sld);
	LAi_ActorTurnToCharacter(sld, pchar);
	ChangeCharacterAddressGroup(sld, "Villemstad_houseSp1_room", "goto", "goto2");
	CreateLocationParticles("fire_incas_Simple", "goto", "goto2", 0.5, 0, 0, "");
	DoQuestFunctionDelay("Caleuche_LandLedySkelAttack", 5.0);
}

void Caleuche_LandLedySkelAttack(string qName) // скелет хозяйки дома атакует
{
	PlaySound("Reef\reef_01.wav");
	LAi_SetPlayerType(pchar);
	sld = characterFromId("skel_landlady");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Caleuche_LandLedySkelDie");
	LAi_SetFightMode(pchar, true);
	DoQuestFunctionDelay("Terrapin_SetMusic", 0.5);
}

void Caleuche_PrepareCubaGrot() // готовим пещеру Кубы
{
	locations[FindLocation("Cuba_Jungle_07")].DisableEncounters = true; 
	locations[FindLocation("Cuba_CaveEntrance")].DisableEncounters = true; 
	locations[FindLocation("Cuba_Grot")].DisableEncounters = true;
	LocatorReloadEnterDisable("Cuba_Jungle_07", "reload2_back", true);
	// ставим охотника
	sld = GetCharacter(NPC_GenerateCharacter("cavehunter", "mush_ctz_2", "man", "mushketer", 25, SPAIN, -1, true, "soldier"));
	FantomMakeCoolFighter(sld, 25, 70, 100, "", "mushket1", "cartridge", 150);
	sld.Dialog.Filename = "Quest\Caleuche_dialog.c";
	sld.dialog.currentnode = "cavehunter";
	sld.greeting = "town_pirate";
	sld.MusketerDistance = 5;
	LAi_SetGuardianType(sld);
	sld.protector = true;
	ChangeCharacterAddressGroup(sld, "Cuba_Jungle_07", "officers", "reload2_2");
	LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
}

void Caleuche_CubaCaveEntrance(string qName) // бой перед пещерой
{
	LAi_group_Delete("EnemyFight");
	chrDisableReloadToLocation = true;//закрыть локацию
	// нечисть
	int iRank = 16+MOD_SKILL_ENEMY_RATE*2;
	for (int i=1; i<=6; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("cubacaveent_skel_"+i, "skel"+(rand(3)+1), "skeleton", "skeleton", iRank, PIRATE, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank, 50, 50, LinkRandPhrase("blade_03","blade_05","blade_07"), "pistol1", "bullet", 120);
		sld.monster = true; 
		LAi_SetWarriorType(sld);
		if (i < 4) ChangeCharacterAddressGroup(sld, "Cuba_CaveEntrance", "officers", "reload1_"+i);
		else ChangeCharacterAddressGroup(sld, "Cuba_CaveEntrance", "monsters", "monster"+(i-3));
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	// помощник, если есть
	if (GetCharacterIndex("cavehunter") != -1)
	{
		sld = characterFromId("cavehunter");
		if (CheckAttribute(sld, "quest.caleuche"))
		{
			sld.MusketerDistance = 0;
			sld.MushketBulletType = "cartridge";
			ChangeCharacterAddressGroup(sld, "Cuba_CaveEntrance", "officers", "reload2_1");
			LAi_SetWarriorType(sld);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
		else sld.lifeday = 0;
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Caleuche_CubaCaveEntSkelDie");
	LAi_SetFightMode(pchar, true);
}

void Caleuche_CubaGrot(string qName) // нечисть в гроте
{
	chrDisableReloadToLocation = true;//закрыть локацию
	// нечисть
	int iRank = 18+MOD_SKILL_ENEMY_RATE*2;
	for (int i=1; i<=6; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("cubagrot_skel1_"+i, "skel"+(rand(3)+1), "skeleton", "skeleton", iRank, PIRATE, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank, 60, 60, LinkRandPhrase("blade_15","blade_04","blade_06"), "pistol1", "bullet", 150);
		sld.monster = true; 
		LAi_SetWarriorType(sld);
		if (i < 4) ChangeCharacterAddressGroup(sld, "Cuba_Grot", "monsters", "monster3");
		else ChangeCharacterAddressGroup(sld, "Cuba_Grot", "monsters", "monster4");
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	// помощник, если есть
	if (GetCharacterIndex("cavehunter") != -1)
	{
		sld = characterFromId("cavehunter");
		if (CheckAttribute(sld, "quest.caleuche"))
		{
			sld.MusketerDistance = 5;
			sld.MushketBulletType = "cartridge";
			ChangeCharacterAddressGroup(sld, "Cuba_Grot", "officers", "reload1_2");
			LAi_SetWarriorType(sld);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_SetCheck("EnemyFight", "Caleuche_CubaGrotSkel1Die");
	LAi_SetFightMode(pchar, true);
}

void Caleuche_CubaGrotChavinavy(string qName)//драка с монстром
{
	if (!GetDLCenabled(DLC_APPID_1)) return;
	LAi_group_Delete("EnemyFight");
	PlaySound("ambient\horror\horror2.wav");
	sld = GetCharacter(NPC_GenerateCharacter("CubaChavinavi", "Chavinavi_1", "skeleton", "skeleton", 20+MOD_SKILL_ENEMY_RATE*3, PIRATE, -1, false, "quest"));
	FantomMakeCoolFighter(sld, 20+MOD_SKILL_ENEMY_RATE*3, 80, 80, "topor_01", "pistol6", "bullet", MOD_SKILL_ENEMY_RATE*80);
	sld.name = "Chavinavy";
	sld.lastname = "";
	sld.monster = true; // признак нежити
	sld.MultiFighter = 1.0+MOD_SKILL_ENEMY_RATE/10; // мультифайтер
	ChangeCharacterAddressGroup(sld, "Cuba_Grot", "item", "item2");
	LAi_SetActorType(sld);
	LAi_ActorAnimation(sld, "Ground_sitting", "Caleuche_MonsterStandUp", 1.0);
}

void Caleuche_MerrimanCaveOver(string qName) // провалили по времени
{
	pchar.quest.caleuche_merriman_cave.over = "yes"; //снять прерывание
	pchar.quest.caleuche_merriman_cave1.over = "yes"; //снять прерывание
	LocatorReloadEnterDisable("Havana_CryptBig2", "reload2", true);
	RemoveItems(pchar, "kaleuche_key", 1);
	sld = characterFromId("Havana_Cemeteryman");
	sld.model = "keeper_5";
	Characters_RefreshModel(sld);
	sld.name = "Esberto";
	sld.lastname = "Salinas";
	sld = characterFromId("Tuttuat");
	sld.dialog.currentnode = "Tuttuat_41";
	sld = GetCharacter(NPC_GenerateCharacter("cryptguard", "off_spa_2", "man", "man", 40, SPAIN, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 40, 100, 100, "blade_19", "pistol4", "bullet", 100);
	sld.dialog.FileName = "Quest\Caleuche_dialog.c";
	sld.dialog.currentnode = "cryptguard";
	sld.greeting = "";
	LAi_SetImmortal(sld, true);
	LAi_SetGuardianType(sld);
	sld.protector = true;
	ChangeCharacterAddressGroup(sld, "Havana_CryptBig2", "reload", "reload2");
	LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
}

void Caleuche_OpenMerrimanCave(string qName) // открываем логово Мерримана
{
	PlaySound("interface\key.wav");
	LocatorReloadEnterDisable("Havana_CryptBig2", "reload2", false);
}

void Caleuche_InMerrimanCave(string qName) // заполняем логово Мерримана
{
	pchar.quest.Caleuche_MerrimanCaveOver.over = "yes"; //снять прерывание
	RemoveItems(pchar, "kaleuche_key", 1);
	chrDisableReloadToLocation = true;//закрыть локацию
	int iRank = 16+MOD_SKILL_ENEMY_RATE*2;
	int iHp = 200+MOD_SKILL_ENEMY_RATE*80;
	string sTemp = "pistol1";
	if (MOD_SKILL_ENEMY_RATE > 4) sTemp = "pistol5";
	if (MOD_SKILL_ENEMY_RATE > 6) sTemp = "pistol6";
	if (MOD_SKILL_ENEMY_RATE > 8) sTemp = "pistol4";
	// скелеты - черные стражи
	for (int i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("merriman_skel_"+i, "skelt", "skeleton", "skeleton_B", iRank+2, PIRATE, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank+2, 60, 60, LinkRandPhrase("blade_15","blade_04","blade_06"), "pistol3", "grapeshot", 150);
		sld.monster = true;
		sld.LSC_clan = true;
		LAi_CharacterDisableDialog(sld);
		LAi_SetGuardianType(sld);
		ChangeCharacterAddressGroup(sld, "Havana_CryptDungeon", "goto", "goto"+(15+i));
		LAi_group_MoveCharacter(sld, LAI_GROUP_MONSTERS);
	}
	// скелеты - простые
	for (i=3; i<=8; i++)
	{
		if (i > 6) sld = GetCharacter(NPC_GenerateCharacter("merriman_skel_"+i, "skelt", "skeleton", "skeleton_B", iRank+2, PIRATE, -1, true, "soldier"));
		else sld = GetCharacter(NPC_GenerateCharacter("merriman_skel_"+i, "skel"+(rand(3)+1), "skeleton", "skeleton", iRank, PIRATE, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank, 50, 50, LinkRandPhrase("blade_03","blade_05","blade_07"), "pistol1", "bullet", 120);
		sld.monster = true; 
		sld.LSC_clan = true;
		LAi_CharacterDisableDialog(sld);
		LAi_SetGuardianType(sld);
		if (i < 7) ChangeCharacterAddressGroup(sld, "Havana_CryptDungeon", "goto", "goto"+(3+i));
		else ChangeCharacterAddressGroup(sld, "Havana_CryptDungeon", "goto", "goto"+(11+i));
		LAi_group_MoveCharacter(sld, LAI_GROUP_MONSTERS);
	}
	// скелеты - крутые
	for (i=9; i<=11; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("merriman_skel_"+i, "skel"+(rand(3)+1), "skeleton", "skeleton", iRank+4, PIRATE, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank+4, 70, 70, LinkRandPhrase("blade_18","blade_19","blade_21"), sTemp, "bullet", 170);
		sld.monster = true; 
		sld.LSC_clan = true;
		LAi_CharacterDisableDialog(sld);
		LAi_SetGuardianType(sld);
		ChangeCharacterAddressGroup(sld, "Havana_CryptDungeon", "goto", "goto"+(2+i));
		LAi_group_MoveCharacter(sld, LAI_GROUP_MONSTERS);
	}
	// скелеты - за решеткой, антураж
	for (i=12; i<=15; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("merriman_skel_"+i, "skel"+(rand(3)+1), "skeleton", "skeleton", 10, PIRATE, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, 10, 20, 20, "", "", "", 30);
		sld.monster = true; 
		sld.LSC_clan = true;
		LAi_CharacterDisableDialog(sld);
		LAi_SetActorType(sld);
		ChangeCharacterAddressGroup(sld, "Havana_CryptDungeon", "goto", "goto"+(8+i));
	}
	// скелеты - за столом, антураж
	for (i=16; i<=21; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("merriman_skel_"+i, "skel"+(rand(3)+1), "skeleton", "skeleton", 10, PIRATE, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, 10, 10, 10, "", "", "", 20);
		sld.monster = true; 
		sld.LSC_clan = true;
		LAi_CharacterDisableDialog(sld);
		LAi_SetSitType(sld);
		ChangeCharacterAddressGroup(sld, "Havana_CryptDungeon", "goto", "goto"+(13+i));
	}
	// Жоаким Мерриман, с обычной бошкой
	sld = characterFromId("Joakim");
	sld.dialog.currentnode = "caleuche";
	FantomMakeCoolFighter(sld, iRank+4, 80, 80, "topor_04", "pistol4", "bullet", 20);
	SetSPECIAL(sld, 8, 6, 8, 5, 5, 10, 6);
	LAi_SetHP(sld, iHp, iHp);
	if (MOD_SKILL_ENEMY_RATE > 4)
	{
		sld.cirassId = Items_FindItemIdx("cirass1");
		SetCharacterPerk(sld, "Energaiser");
		SetCharacterPerk(sld, "SwordplayProfessional");
		SetCharacterPerk(sld, "HardHitter");
		TakeNItems(pchar, "potion2", MOD_SKILL_ENEMY_RATE-5);
	}
	float fMft = MOD_SKILL_ENEMY_RATE/10;
	sld.MultiFighter = 1.0+fMft; // мультифайтер
	sld.LSC_clan = true;
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	GiveItem2Character(sld, "SkullAztec");
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "Havana_CryptDungeon", "quest", "quest1");
	// прерывание на локатор-детектор
	pchar.quest.caleuche_mdetector.win_condition.l1 = "locator";
	pchar.quest.caleuche_mdetector.win_condition.l1.location = "Havana_CryptDungeon";
	pchar.quest.caleuche_mdetector.win_condition.l1.locator_group = "quest";
	pchar.quest.caleuche_mdetector.win_condition.l1.locator = "detector";
	pchar.quest.caleuche_mdetector.function = "Caleuche_MerrimanTalk";
}

void Caleuche_MerrimanTalk(string qName) // активируем разговор с Мерриманом
{
	if (!GetDLCenabled(DLC_APPID_1)) return;
	DoQuestFunctionDelay("Terrapin_SetMusic", 0.5);
	// останавливаем скелетов и офицеров
	for (i=1; i<=11; i++)
	{
		if (GetCharacterIndex("merriman_skel_"+i) != -1)
		{
			sld = characterFromId("merriman_skel_"+i);
			if (LAi_GetCharacterHP(sld) > 0) LAi_SetActorType(sld);
		}
	}
	if(GetOfficersQuantity(pchar) > 0)
	{
		pchar.OfficerAttRange = 7.0;
		OfficersHold();
	}
	sld = characterFromId("Joakim");
	LAi_SetActorType(sld);
	LAi_SetActorType(pchar);
	LAi_ActorFollow(pchar, sld, "ActorDialog_Any2Pchar", -1);
	LAi_ActorTurnToCharacter(sld, pchar);
	SetActorDialogAny2Pchar(sld.id, "", 0.0, 0.0);
	iGlobalTemp = 0;
}

void Caleuche_MerrimanCallMonster(string qName) // вызов Мерриманом Чавинави
{
	sld = characterFromId("Joakim");
	if (LAi_GetCharacterHP(sld) < 1) return;
	PlaySound("VOICE\Russian\hambit\Joakim Merriman-03.wav");
	sld = GetCharacter(NPC_GenerateCharacter("MerrimanChavinavi"+iGlobalTemp, "Chavinavi_1", "man", "skeleton", 20+MOD_SKILL_ENEMY_RATE*3, PIRATE, -1, false, "quest"));
	FantomMakeCoolFighter(sld, 20+MOD_SKILL_ENEMY_RATE*3, 70, 70, "topor_01", "pistol6", "bullet", MOD_SKILL_ENEMY_RATE*60);
	sld.name = "Chavinavy";
	sld.lastname = "";
	sld.monster = true; // признак нежити
	sld.LSC_clan = true;
	sld.MultiFighter = 1.0+MOD_SKILL_ENEMY_RATE/20; // мультифайтер
	GetCharacterPos(pchar, &locx, &locy, &locz);
	string sTemp = LAi_FindNearestLocator("goto", locx, locy, locz);
	ChangeCharacterAddressGroup(sld, "Havana_CryptDungeon", "goto", sTemp);
	CreateLocationParticles("fire_incas_Simple", "goto", sTemp, 0.5, 0, 0, "");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "TmpEnemy");
	LAi_group_SetRelation("TmpEnemy", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("TmpEnemy", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("TmpEnemy", "Caleuche_MerrimanRecallMonster");
}

void Caleuche_FindSkull(string qName) // нашли нефритовый череп
{
	chrDisableReloadToLocation = false;//открыть локацию
	InterfaceStates.Buttons.Save.enable = true;
	DeleteAttribute(pchar, "GenQuest.CannotWait");
	DeleteAttribute(pchar, "GenQuest.NoDelBody");
	AddQuestRecord("Caleuche", "33");
	sld = characterFromId("Joakim");
	sld.model = "Meriman_1";
	Characters_RefreshModel(sld);
	pchar.questTemp.Caleuche = "island";
	sld = ItemsFromID("SkullAztec");
	sld.shown = true; // деактивация для локатора итем
	sld.price = 0;
	sld.ItemType = "QUESTITEMS";
}

void Caleuche_MerrimanBoxOpen() // открыли ящик Мерримана
{
	RemoveItems(pchar, "MerrimanBook", 1);
	PlaySound("interface\important_item.wav");
	Log_Info("You have received a vial of ethyl alcohol");
	Log_Info("You have received a vial of nitric acid");
	Log_Info("You have received a crucible");
	Log_Info("You have received pestle and mortar");
	Log_Info("You have received glass vials");
	Log_Info("You have received a plant of Mangarosa");
	Log_Info("You have received a recipe of elixir");
	TakeNItems(pchar, "mineral28", 1);
	TakeNItems(pchar, "mineral29", 1);
	TakeNItems(pchar, "tigel", 1);
	TakeNItems(pchar, "mineral27", 1);
	TakeNItems(pchar, "mineral17", 10);
	TakeNItems(pchar, "cannabis7", 1);
	TakeNItems(pchar, "recipe_potion2", 1);
}

void Caleuche_TuttuatAmuletOver(string qName) // действие амулетов истекло
{
	Log_Info("Amulets of Tuttuathapak have lost their power!");
	PlaySound("interface\notebook.wav");
	if(IsEquipCharacterByArtefact(pchar, "kaleuche_amulet2")) RemoveCharacterEquip(pchar, TALISMAN_ITEM_TYPE);
	if(IsEquipCharacterByArtefact(pchar, "kaleuche_amulet3")) RemoveCharacterEquip(pchar, TALISMAN_ITEM_TYPE);
	// преобразуем амулеты
	ChangeItemDescribe("kaleuche_amulet2", "itmdescr_kaleuche_amulet2");
	ChangeItemDescribe("kaleuche_amulet3", "itmdescr_kaleuche_amulet3");
	sld = ItemsFromID("kaleuche_amulet2");
	sld.picIndex = 10;
	sld.picTexture = "ITEMS_36";
	DeleteAttribute(sld, "groupID");
	DeleteAttribute(sld, "unique");
	DeleteAttribute(sld, "kind");
	sld.ItemType = "QUESTITEMS";
	sld = ItemsFromID("kaleuche_amulet3");
	sld.picIndex = 11;
	sld.picTexture = "ITEMS_36";
	DeleteAttribute(sld, "groupID");
	DeleteAttribute(sld, "unique");
	DeleteAttribute(sld, "kind");
	sld.ItemType = "QUESTITEMS";
	pchar.questTemp.Caleuche.AmuletOver = "true";
}

void Caleuche_KhaelRoaArrive(string qName) // прибыли на Хаэль Роа
{
	if (!GetDLCenabled(DLC_APPID_1)) return;
	AddQuestRecord("Caleuche", "36");
	int i, n;
	string sTemp;
	// сюда ставим все изменения в локациях храма, лабиринтов и алькова - без НИ
	// джунгли вход в храм
	n = Findlocation("Temple_h");
	locations[n].type = "questisland";
	locations[n].DisableEncounters = true;
	locations[n].islandId = "KhaelRoa";
	locations[n].questflower = 1;
	// лабиринт-1
	n = Findlocation("Labirint_1");
	locations[n].type = "teno_inside";
	Locations[n].environment.weather = "true";
	Locations[n].environment.sea = "false";
	Locations[n].lockWeather = "Inside";
	locations[n].environment.weather.rain = false;
	locations[n].islandId = "KhaelRoa";
	Locations[n].reload.l1.name = "reload27";
	Locations[n].reload.l1.go = "Temple_h";
	Locations[n].reload.l1.emerge = "reload2";
	Locations[n].reload.l1.autoreload = "1";
	locations[n].DisableOfficers = "1";
	// лабиринт-2
	n = Findlocation("Labirint_2");
	locations[n].type = "teno_inside";
	Locations[n].environment.weather = "true";
	Locations[n].environment.sea = "false";
	Locations[n].lockWeather = "Inside";
	locations[n].environment.weather.rain = false;
	locations[n].islandId = "KhaelRoa";
	locations[n].DisableOfficers = "1";
	// лабиринт-3
	n = Findlocation("Labirint_3");
	locations[n].type = "teno_inside";
	Locations[n].environment.weather = "true";
	Locations[n].environment.sea = "false";
	Locations[n].lockWeather = "Inside";
	locations[n].environment.weather.rain = false;
	locations[n].islandId = "KhaelRoa";
	DeleteAttribute(&locations[n], "reload.l28");
	Locations[n].models.always.l2 = "lab3_blocks";
	locations[n].models.always.door = "door";
	locations[n].models.always.door.locator.group = "door";
	locations[n].models.always.door.locator.name = "door1";
	locations[n].DisableOfficers = "1";
	// альков
	n = Findlocation("treasure_alcove");
	locations[n].type = "Alcove";
	Locations[n].environment.weather = "true";
	Locations[n].environment.sea = "false";
	Locations[n].lockWeather = "Inside";
	locations[n].environment.weather.rain = false;
	locations[n].islandId = "KhaelRoa";
	locations[n].locators_radius.item.button01 = 1.2;
	DeleteAttribute(&locations[n], "models.always.l3"); // артефакт
	locations[n].DisableOfficers = "1";
	// прерывание
	pchar.quest.Caleuche_alcove.win_condition.l1 = "locator";
	pchar.quest.Caleuche_alcove.win_condition.l1.location = "treasure_alcove";
	pchar.quest.Caleuche_alcove.win_condition.l1.locator_group = "teleport";
	pchar.quest.Caleuche_alcove.win_condition.l1.locator = "teleport6";
	pchar.quest.Caleuche_alcove.function = "Caleuche_InAlcoveTop";
	// подсказки
	pchar.quest.Caleuche_support1.win_condition.l1 = "locator";
	pchar.quest.Caleuche_support1.win_condition.l1.location = "treasure_alcove";
	pchar.quest.Caleuche_support1.win_condition.l1.locator_group = "teleport";
	pchar.quest.Caleuche_support1.win_condition.l1.locator = "teleport0";
	pchar.quest.Caleuche_support1.function = "Caleuche_TeleportSupport";
	pchar.quest.Caleuche_support2.win_condition.l1 = "locator";
	pchar.quest.Caleuche_support2.win_condition.l1.location = "treasure_alcove";
	pchar.quest.Caleuche_support2.win_condition.l1.locator_group = "teleport";
	pchar.quest.Caleuche_support2.win_condition.l1.locator = "teleport1";
	pchar.quest.Caleuche_support2.function = "Caleuche_TeleportSupport";
	pchar.quest.Caleuche_support3.win_condition.l1 = "locator";
	pchar.quest.Caleuche_support3.win_condition.l1.location = "Labirint_3";
	pchar.quest.Caleuche_support3.win_condition.l1.locator_group = "quest";
	pchar.quest.Caleuche_support3.win_condition.l1.locator = "detector";
	pchar.quest.Caleuche_support3.function = "Caleuche_TileSupport";
}

void Caleuche_TileSupport(string qName) // 
{
	AddQuestRecord("Caleuche", "44");
}

void Caleuche_NineStoneTiles() // ступили на правильную плитку
{
	PlaySound("interface\key.wav");
	switch (sti(pchar.questTemp.Caleuche.Tile))
	{
		case 0:
			switch (pchar.questTemp.Caleuche.NextTile)
			{
				case "step1": pchar.questTemp.Caleuche.NextTile = "step4"; break;
				case "step4": pchar.questTemp.Caleuche.NextTile = "step5"; break;
				case "step5": pchar.questTemp.Caleuche.NextTile = "step2"; break;
				case "step2": pchar.questTemp.Caleuche.NextTile = "step3"; break;
				case "step3": pchar.questTemp.Caleuche.NextTile = "step6"; break;
				case "step6": pchar.questTemp.Caleuche.NextTile = "step9"; break;
				case "step9": Caleuche_NineStoneTilesOpen(); break;
				break;
			}
		break;
		case 1:
			switch (pchar.questTemp.Caleuche.NextTile)
			{
				case "step4": pchar.questTemp.Caleuche.NextTile = "step1"; break;
				case "step1": pchar.questTemp.Caleuche.NextTile = "step2"; break;
				case "step2": pchar.questTemp.Caleuche.NextTile = "step5"; break;
				case "step5": pchar.questTemp.Caleuche.NextTile = "step8"; break;
				case "step8": pchar.questTemp.Caleuche.NextTile = "step9"; break;
				case "step9": pchar.questTemp.Caleuche.NextTile = "step6"; break;
				case "step6": Caleuche_NineStoneTilesOpen(); break;
				break;
			}
		break;
		case 2:
			switch (pchar.questTemp.Caleuche.NextTile)
			{
				case "step7": pchar.questTemp.Caleuche.NextTile = "step4"; break;
				case "step4": pchar.questTemp.Caleuche.NextTile = "step5"; break;
				case "step5": pchar.questTemp.Caleuche.NextTile = "step8"; break;
				case "step8": pchar.questTemp.Caleuche.NextTile = "step9"; break;
				case "step9": pchar.questTemp.Caleuche.NextTile = "step6"; break;
				case "step6": pchar.questTemp.Caleuche.NextTile = "step3"; break;
				case "step3": Caleuche_NineStoneTilesOpen(); break;
				break;
			}
		break;
		case 3:
			switch (pchar.questTemp.Caleuche.NextTile)
			{
				case "step7": pchar.questTemp.Caleuche.NextTile = "step8"; break;
				case "step8": pchar.questTemp.Caleuche.NextTile = "step5"; break;
				case "step5": pchar.questTemp.Caleuche.NextTile = "step2"; break;
				case "step2": pchar.questTemp.Caleuche.NextTile = "step3"; break;
				case "step3": pchar.questTemp.Caleuche.NextTile = "step6"; break;
				case "step6": pchar.questTemp.Caleuche.NextTile = "step9"; break;
				case "step9": Caleuche_NineStoneTilesOpen(); break;
			}
		break;
		case 4:
			switch (pchar.questTemp.Caleuche.NextTile)
			{
				case "step1": pchar.questTemp.Caleuche.NextTile = "step4"; break;
				case "step4": pchar.questTemp.Caleuche.NextTile = "step7"; break;
				case "step7": pchar.questTemp.Caleuche.NextTile = "step8"; break;
				case "step8": pchar.questTemp.Caleuche.NextTile = "step9"; break;
				case "step9": pchar.questTemp.Caleuche.NextTile = "step6"; break;
				case "step6": pchar.questTemp.Caleuche.NextTile = "step3"; break;
				case "step3": Caleuche_NineStoneTilesOpen(); break;
			}
		break;
	}
}

void Caleuche_NineStoneTilesOpen() // прошли 9 плиток правильно
{
	if (!GetDLCenabled(DLC_APPID_1)) return;
	DeleteAttribute(pchar, "questTemp.Caleuche.NextTile");
	DeleteAttribute(pchar, "questTemp.Caleuche.Tile");
	PlaySound("Ambient\Teno_inside\door_1.wav");
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "reload", "reload30");
	DoQuestFunctionDelay("Caleuche_ShowLeftLevers", 4.5);
	AddCharacterExpToSkill(pchar, "Sneak", 200);
}

void Caleuche_NineStoneDelete() // ступили на ложную плитку - начинай сначала
{
	PlaySound("interface\box_locked.wav");
	switch (sti(pchar.questTemp.Caleuche.Tile))
	{
		case 0: pchar.questTemp.Caleuche.NextTile = "step1"; break;
		case 1: pchar.questTemp.Caleuche.NextTile = "step4"; break;
		case 2: pchar.questTemp.Caleuche.NextTile = "step7"; break;
		case 3: pchar.questTemp.Caleuche.NextTile = "step7"; break;
		case 4: pchar.questTemp.Caleuche.NextTile = "step1"; break;
	}
}

void Caleuche_ShowLeftLevers(string qName) // показываем левые рычаги
{
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "item", "knife1");
	DoQuestFunctionDelay("Caleuche_ShowLeftLeversFire", 2.5);
}

void Caleuche_ShowLeftLeversFire(string qName) // показываем левые рычаги
{
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "item", "knife3");
	pchar.questTemp.Caleuche.Lever.Count = 0;
	pchar.questTemp.Caleuche.LeverL = "true";
	DoQuestCheckDelay("pchar_back_to_player", 2.5);
	iGlobalTemp = 0;
}

void Caleuche_ThreeLeverAim() // наводим ГГ на цель
{
	string sTemp;
	switch (pchar.questTemp.Caleuche.Lever.Locator)
	{
		case "column11": sTemp = "knife1"; break;
		case "column12": sTemp = "knife2"; break;
		case "column13": sTemp = "knife3"; break;
	}
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "item", sTemp);
	DoQuestCheckDelay("Caleuche_ThreeLeverAim", 1.0);
}

void Caleuche_ThreeLeverTurn(string qName) // поворачиваем рычаг
{
	PlaySound("interface\key.wav");
	switch (sti(pchar.questTemp.Caleuche.Lever.Count))
	{
		case 0: return; break;
		case 1: pchar.questTemp.Caleuche.Lever.Locator1 = pchar.questTemp.Caleuche.Lever.Locator; break;
		case 2: pchar.questTemp.Caleuche.Lever.Locator2 = pchar.questTemp.Caleuche.Lever.Locator; break;
		case 3: 
			pchar.questTemp.Caleuche.Lever.Locator3 = pchar.questTemp.Caleuche.Lever.Locator;
			Caleuche_CheckThreeLeverTurn();
		break;
	}
}

void Caleuche_CheckThreeLeverTurn() // проверям правильность поворота левых рычагов
{
	bool bOk = false;
	pchar.questTemp.Caleuche.Lever.Count = 0;
	switch (sti(pchar.questTemp.Caleuche.LeftLevers))
	{
		case 0: 
			if (pchar.questTemp.Caleuche.Lever.Locator1 == "column13" && pchar.questTemp.Caleuche.Lever.Locator2 == "column11" && pchar.questTemp.Caleuche.Lever.Locator3 == "column12") bOk = true;
		break;
		
		case 1: 
			if (pchar.questTemp.Caleuche.Lever.Locator1 == "column11" && pchar.questTemp.Caleuche.Lever.Locator2 == "column13" && pchar.questTemp.Caleuche.Lever.Locator3 == "column12") bOk = true;
		break;
		
		case 2: 
			if (pchar.questTemp.Caleuche.Lever.Locator1 == "column12" && pchar.questTemp.Caleuche.Lever.Locator2 == "column13" && pchar.questTemp.Caleuche.Lever.Locator3 == "column11") bOk = true;
		break;
		
		case 3: 
			if (pchar.questTemp.Caleuche.Lever.Locator1 == "column12" && pchar.questTemp.Caleuche.Lever.Locator2 == "column11" && pchar.questTemp.Caleuche.Lever.Locator3 == "column13") bOk = true;
		break;
		
		case 4: 
			if (pchar.questTemp.Caleuche.Lever.Locator1 == "column11" && pchar.questTemp.Caleuche.Lever.Locator2 == "column12" && pchar.questTemp.Caleuche.Lever.Locator3 == "column13") bOk = true;
		break;
	}
	if (bOk)
	{
		PlaySound("Ambient\Teno_inside\door_2.wav");
		LAi_SetActorType(pchar);
		LAi_ActorTurnToLocator(pchar, "reload", "reload30");
		DeleteAttribute(pchar, "questTemp.Caleuche.LeverL");
		DeleteAttribute(pchar, "questTemp.Caleuche.LeftLevers");
		DoQuestFunctionDelay("Caleuche_ShowRightLevers", 5.5);
		AddCharacterExpToSkill(pchar, "Fortune", 150);
	}
	else
	{
		DeleteAttribute(pchar, "questTemp.Caleuche.LeverL");
		pchar.questTemp.Caleuche.LeverType = 0;
		LAi_SetActorType(pchar);
		LAi_ActorTurnToLocator(pchar, "item", "knife4");
		DoQuestFunctionDelay("Caleuche_LeverAttack", 2.0);
	}
}

void Caleuche_ShowRightLevers(string qName) // показываем правые рычаги
{
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "item", "knife4");
	DoQuestFunctionDelay("Caleuche_ShowRightLeversFire", 2.5);
	
}

void Caleuche_ShowRightLeversFire(string qName) // показываем правые рычаги
{
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "item", "knife6");
	pchar.questTemp.Caleuche.Lever.Count = 0;
	pchar.questTemp.Caleuche.LeverR = "true";
	DoQuestCheckDelay("pchar_back_to_player", 2.5);
}

void Caleuche_SixLeverAim() // наводим ГГ на цель
{
	string sTemp;
	switch (pchar.questTemp.Caleuche.Lever.Locator)
	{
		case "column21": sTemp = "knife4"; break;
		case "column22": sTemp = "knife5"; break;
		case "column23": sTemp = "knife6"; break;
	}
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "item", sTemp);
	DoQuestCheckDelay("Caleuche_SixLeverAim", 1.0);
}

void Caleuche_SixLeverTurn(string qName) // поворачиваем рычаг
{
	PlaySound("interface\key.wav");
	switch (sti(pchar.questTemp.Caleuche.Lever.Count))
	{
		case 0: return; break;
		case 1: pchar.questTemp.Caleuche.Lever.Locator1 = pchar.questTemp.Caleuche.Lever.Locator; break;
		case 2: pchar.questTemp.Caleuche.Lever.Locator2 = pchar.questTemp.Caleuche.Lever.Locator; break;
		case 3: 
			pchar.questTemp.Caleuche.Lever.Locator3 = pchar.questTemp.Caleuche.Lever.Locator;
			Caleuche_CheckSixLeverTurn();
		break;
	}
}

void Caleuche_CheckSixLeverTurn() // проверям правильность поворота правых рычагов
{
	bool bOk = false;
	pchar.questTemp.Caleuche.Lever.Count = 0;
	switch (sti(pchar.questTemp.Caleuche.RightLevers))
	{
		case 0: 
			if (pchar.questTemp.Caleuche.Lever.Locator1 == "column23" && pchar.questTemp.Caleuche.Lever.Locator2 == "column22" && pchar.questTemp.Caleuche.Lever.Locator3 == "column21") bOk = true;
		break;
		
		case 1: 
			if (pchar.questTemp.Caleuche.Lever.Locator1 == "column22" && pchar.questTemp.Caleuche.Lever.Locator2 == "column21" && pchar.questTemp.Caleuche.Lever.Locator3 == "column23") bOk = true;
		break;
		
		case 2: 
			if (pchar.questTemp.Caleuche.Lever.Locator1 == "column21" && pchar.questTemp.Caleuche.Lever.Locator2 == "column23" && pchar.questTemp.Caleuche.Lever.Locator3 == "column22") bOk = true;
		break;
		
		case 3: 
			if (pchar.questTemp.Caleuche.Lever.Locator1 == "column22" && pchar.questTemp.Caleuche.Lever.Locator2 == "column23" && pchar.questTemp.Caleuche.Lever.Locator3 == "column21") bOk = true;
		break;
		
		case 4: 
			if (pchar.questTemp.Caleuche.Lever.Locator1 == "column23" && pchar.questTemp.Caleuche.Lever.Locator2 == "column22" && pchar.questTemp.Caleuche.Lever.Locator3 == "column21") bOk = true;
		break;
	}
	if (bOk)
	{
		PlaySound("Ambient\Teno_inside\door_3.wav");
		LAi_SetActorType(pchar);
		LAi_ActorTurnToLocator(pchar, "reload", "reload30");
		DeleteAttribute(pchar, "questTemp.Caleuche.LeverR");
		DeleteAttribute(pchar, "questTemp.Caleuche.RightLevers");
		DoQuestCheckDelay("pchar_back_to_player", 6.0);
		DoQuestCheckDelay("Video_Door", 6.0);
		AddCharacterExpToSkill(pchar, "Fortune", 150);
	}
	else
	{
		DeleteAttribute(pchar, "questTemp.Caleuche.LeverR");
		pchar.questTemp.Caleuche.LeverType = 1;
		LAi_SetActorType(pchar);
		LAi_ActorTurnToLocator(pchar, "item", "knife2");
		DoQuestFunctionDelay("Caleuche_LeverAttack", 2.0);
	}
}

void Caleuche_LeverAttack(string qName) // ставим чавинави при неправильной последовательности
{
	PlaySound("ambient\horror\horror2.wav");
	for (int i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("LeverChavinavi_"+i+iGlobalTemp, "Chavinavi_1", "man", "skeleton", 20+MOD_SKILL_ENEMY_RATE*2, PIRATE, -1, false, "quest"));
		FantomMakeCoolFighter(sld, 20+MOD_SKILL_ENEMY_RATE*3, 70, 70, "topor_01", "pistol6", "bullet", MOD_SKILL_ENEMY_RATE*60);
		sld.name = "Chavinavy";
		sld.lastname = "";
		sld.monster = true; // признак нежити
		sld.LSC_clan = true;
		sld.KhaelRoaMonster = true;
		sld.MultiFighter = 1.0+MOD_SKILL_ENEMY_RATE/20; // мультифайтер
		LAi_SetActorType(sld);
		if (sti(pchar.questTemp.Caleuche.LeverType) == 0) 
		{
			ChangeCharacterAddressGroup(sld, "labirint_3", "goto", "monster1"+i);
			CreateLocationParticles("fire_incas_Simple", "goto", "monster1"+i, 0.5, 0, 0, "");
		}
		else 
		{
			ChangeCharacterAddressGroup(sld, "labirint_3", "goto", "monster2"+i);
			CreateLocationParticles("fire_incas_Simple", "goto", "monster2"+i, 0.5, 0, 0, "");
		}
	}
	DoQuestFunctionDelay("Caleuche_LeverFight", 2.0);
}

void Caleuche_LeverFight(string qName) // атака чавинави
{
	LAi_SetPlayerType(pchar);
	LAi_group_Delete("EnemyFight");
	chrDisableReloadToLocation = true;//закрыть локацию
	for (int i=1; i<=2; i++)
	{
		sld = characterFromId("LeverChavinavi_"+i+iGlobalTemp);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Caleuche_LeverFightOver");
	LAi_SetFightMode(pchar, true);
}

void Caleuche_TeleportSupport(string qName)
{
	log_info("Press 'T' to use");
}

void Caleuche_TeleportStart() // телепортация по алькову
{
	if (CheckAttribute(pchar, "questTemp.Caleuche.LockTeleport"))
	{
		log_info("The portal is blocked!");
		return;
	}
	PlaySound("Ambient\Teno_inside\teleporter.wav");
	switch (sGlobalTemp)
	{
		case "teleport0": 
			ChangeCharacterAddressGroup(pchar, "Treasure_Alcove", "quest", "teleport");
			Caleuche_TeleportTrap();
		break;
		case "teleport1": ChangeCharacterAddressGroup(pchar, "Treasure_Alcove", "teleport", "teleport2"); break;
		case "teleport2": ChangeCharacterAddressGroup(pchar, "Treasure_Alcove", "teleport", "teleport1"); break;
		case "teleport3": ChangeCharacterAddressGroup(pchar, "Treasure_Alcove", "teleport", "teleport4"); break;
		case "teleport4": ChangeCharacterAddressGroup(pchar, "Treasure_Alcove", "teleport", "teleport3"); break;
		case "teleport5": ChangeCharacterAddressGroup(pchar, "Treasure_Alcove", "teleport", "teleport6"); break;
		case "teleport6": ChangeCharacterAddressGroup(pchar, "Treasure_Alcove", "teleport", "teleport5"); break;
	}
}

void Caleuche_TeleportTrap() // телепорт-ловушка
{
	if (CheckAttribute(pchar, "questTemp.Caleuche.Friend")) return;
	LAi_SetActorType(pchar);
	PlaySound("ambient\horror\horror2.wav");
	for (int i=1; i<=6; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("AlkovChavinavi_"+i+iGlobalTemp, "Chavinavi_1", "skeleton", "skeleton", 20+MOD_SKILL_ENEMY_RATE*2, PIRATE, -1, false, "quest"));
		FantomMakeCoolFighter(sld, 20+MOD_SKILL_ENEMY_RATE*3, 70, 70, "topor_01", "", "", MOD_SKILL_ENEMY_RATE*60);
		sld.name = "Chavinavy";
		sld.lastname = "";
		sld.monster = true; // признак нежити
		sld.LSC_clan = true;
		sld.KhaelRoaMonster = true;
		sld.MultiFighter = 1.0+MOD_SKILL_ENEMY_RATE/20; // мультифайтер
		if (i < 4) ChangeCharacterAddressGroup(sld, "Treasure_Alcove", "quest", "quest1");
		else ChangeCharacterAddressGroup(sld, "Treasure_Alcove", "quest", "quest2");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Caleuche_TeleportTrapOver");
	pchar.questTemp.Caleuche.LockTeleport = "true";
	DoQuestCheckDelay("pchar_back_to_player", 3.0);
}

void Caleuche_InAlcoveTop(string qName) // в святилище
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	pchar.questTemp.Caleuche.LockTeleport = "true";
	int iRank = 20+MOD_SKILL_ENEMY_RATE*3;
	int iHp = 400+MOD_SKILL_ENEMY_RATE*160;
	int iHpt = 200+MOD_SKILL_ENEMY_RATE*100;
	string sPistol = "pistol6";
	if (MOD_SKILL_ENEMY_RATE > 4) sPistol = "pistol4";
	sld = GetCharacter(NPC_GenerateCharacter("TopChavinavi_1", "mictlantecuhtli", "skeleton", "skeleton", iRank+10, PIRATE, -1, false, "quest"));
	FantomMakeCoolFighter(sld, iRank+10, 90, 90, "topor_01", sPistol, "bullet", 50);
	sld.name = "Chieftain Chavinavy";
	sld.lastname = "";
	sld.Dialog.Filename = "Quest\Caleuche_dialog.c";
	sld.dialog.currentnode = "Chavinavi";
	LAi_SetHP(sld, iHp, iHp);
	sld.KhaelRoaMonster = true;
	sld.monster = true; // признак нежити
	sld.MultiFighter = 1.0+MOD_SKILL_ENEMY_RATE/10; // мультифайтер
	ChangeCharacterAddressGroup(sld, "Treasure_Alcove", "goto", "monster1");
	TakeNItems(sld, "potion2", MOD_SKILL_ENEMY_RATE/2+1);
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	if (MOD_SKILL_ENEMY_RATE > 2)
	{
		for (int i=2; i<=3; i++)
		{
			sld = GetCharacter(NPC_GenerateCharacter("TopChavinavi_"+i, "Chavinavi_1", "skeleton", "skeleton", iRank, PIRATE, -1, false, "quest"));
			FantomMakeCoolFighter(sld, iRank, 70, 70, "topor_01", "", "", 50);
			sld.name = "Chavinavy";
			sld.lastname = "";
			LAi_SetHP(sld, iHpt, iHpt);
			sld.KhaelRoaMonster = true;
			sld.monster = true; // признак нежити
			sld.MultiFighter = 1.0+MOD_SKILL_ENEMY_RATE/20; // мультифайтер
			TakeNItems(sld, "potion2", MOD_SKILL_ENEMY_RATE/2);
			ChangeCharacterAddressGroup(sld, "Treasure_Alcove", "goto", "monster"+i);
			LAi_SetActorType(sld);
		}
	}
	if (MOD_SKILL_ENEMY_RATE == 6)
	{
		for (i=4; i<=5; i++)
		{
			sld = GetCharacter(NPC_GenerateCharacter("TopChavinavi_"+i, "skel"+(rand(3)+1), "skeleton", "skeleton", iRank, PIRATE, -1, false, "quest"));
			FantomMakeCoolFighter(sld, iRank-10, 60, 60, LinkRandPhrase("blade_10","blade_06","blade_04"), "pistol5", "bullet", 50);
			sld.name = "temple undead";
			sld.lastname = "";
			LAi_SetHP(sld, iHpt-400, iHpt-400);
			sld.monster = true; // признак нежити
			TakeNItems(sld, "potion2", 2);
			ChangeCharacterAddressGroup(sld, "Treasure_Alcove", "goto", "monster"+i);
			LAi_SetActorType(sld);
		}
	}
	if (MOD_SKILL_ENEMY_RATE > 7)
	{
		for (i=4; i<=5; i++)
		{
			sld = GetCharacter(NPC_GenerateCharacter("TopChavinavi_"+i, "Chavinavi_1", "skeleton", "skeleton", iRank, PIRATE, -1, false, "quest"));
			FantomMakeCoolFighter(sld, iRank, 70, 70, "topor_01", "", "", 50);
			sld.name = "Chavinavy";
			sld.lastname = "";
			LAi_SetHP(sld, iHpt, iHpt);
			sld.KhaelRoaMonster = true;
			sld.monster = true; // признак нежити
			sld.MultiFighter = 1.0+MOD_SKILL_ENEMY_RATE/20; // мультифайтер
			TakeNItems(sld, "potion2", MOD_SKILL_ENEMY_RATE/2);
			ChangeCharacterAddressGroup(sld, "Treasure_Alcove", "goto", "monster"+i);
			LAi_SetActorType(sld);
		}
	}
	LAi_SetActorType(pchar);
	DoQuestCheckDelay("pchar_back_to_player", 2.5);
}

void Caleuche_PutSkull() // положили череп
{
	if (CheckAttribute(pchar, "questTemp.Caleuche.QuestionFail"))
	{
		DeleteAttribute(pchar, "questTemp.Caleuche.QuestionFail");
		AddQuestRecord("Caleuche", "37");
	}
	int n = Findlocation("treasure_alcove");
	locations[n].type = "Alcove_1";
	Locations[n].models.always.totem.rotate.x = 0.0;
	Locations[n].models.always.totem.rotate.y = 0.5;
	Locations[n].models.always.totem.rotate.z = 0.0;
	SetMusic("music_alcove_1");
	DeleteAttribute(pchar, "questTemp.Caleuche.LockTeleport");
	setCharacterShipLocation(pchar, "KhaelRoa_port");
	setWDMPointXZ("KhaelRoa_port");
	// ставим прерывание на выход в локацию острова - бой с Калеуче
	pchar.quest.Caleuche_final_battle.win_condition.l1 = "location";
	pchar.quest.Caleuche_final_battle.win_condition.l1.location = "KhaelRoa";
	pchar.quest.Caleuche_final_battle.function = "Caleuche_FinalBattle";
}

void Caleuche_GiveGrant() // получение шкуры ягуара
{
	pchar.questTemp.Caleuche.Friend = "true";
	SetMusic("music_alcove_1");
	sld = characterFromId("TopChavinavi_1");
	sld.dialog.currentnode = "Chavinavi_5";
	LAi_SetActorType(pchar);
	bDisableCharacterMenu = true;//лоченые интерфейсы
	InterfaceStates.Buttons.Save.enable = false;//запретить сохраняться
	DoQuestCheckDelay("Caleuche_RotatePause", 5.0);
}

void Caleuche_FinalBattle(string qName) // последний бой калеуче
{
	if (GetCharacterIndex("Caleuche_seacap") != -1)
	{
		sld = characterFromId("Caleuche_seacap");
		sld.lifeday = 0; // убираем ненужного НПС
		ChangeCharacterAddressGroup(sld, "none", "", "");
	} // это лучше потом убрать
	bQuestDisableMapEnter = true;
	Island_SetReloadEnableGlobal("KhaelRoa", false);
	DoQuestFunctionDelay("Caleuche_CreateGhostshipKhalRoa", 30.0);
	LAi_group_SetRelation(LAI_GROUP_MONSTERS, LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	DeleteAttribute(pchar, "questTemp.Caleuche.Friend");
	LAi_LocationFightDisable(&Locations[FindLocation("treasure_alcove")], false);
}

void Caleuche_CreateGhostshipKhalRoa(string qName)//подгружаем в море Калеуче
{
	if (!GetDLCenabled(DLC_APPID_1)) return;
	log_info("Корабль-призрак на горизонте!");
	PlaySound("interface\_EvEnemy1.wav");
	SetMusicAlarm("music_storm");
	int iRank = 20+MOD_SKILL_ENEMY_RATE*3;
	Group_FindOrCreateGroup("Caleuche_Attack");
	sld = GetCharacter(NPC_GenerateCharacter("Kaleuche_khaelroacap", "skeletcap", "man", "man", iRank, PIRATE, -1, true, "quest"));
	sld.name = "Baltazar";
	sld.lastname = "de Cordes";
	FantomMakeCoolSailor(sld, SHIP_CURSED_FDM, "Flying Heart", CANNON_TYPE_CANNON_LBS36, 100, 100, 100);
	FantomMakeCoolFighter(sld, iRank, 100, 100, "blade_21", "pistol5", "bullet", 400);
	sld.MultiFighter = 1.0+MOD_SKILL_ENEMY_RATE/10;
	GiveItem2Character(sld, "kaleuche_amulet1");
	GiveItem2Character(sld, "spyglass3");
	sld.cirassId = Items_FindItemIdx("cirass1");
	TakeNItems(sld, "potion2", MOD_SKILL_ENEMY_RATE/2);
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	sld.GenQuest.CrewSkelMode = true;
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.PoisonResistent = true; // Captain Beltrop, 06.10.2020, нет отравлению ядом Таино
	sld.DontHitInStorm = true; // не ломается в шторм
	sld.AlwaysSandbankManeuver = true;
	sld.SinkTenPercent = false;
	SetShipSailsFromFile(sld, "ships/parus_common.tga");
	SetSailsColor(sld, 8);//черный рваный парус
	ref shTo = &RealShips[sti(sld.Ship.Type)];
	shTo.SpeedRate = 30.0;
	shTo.TurnRate = 70.0;
	SetCrewQuantityOverMax(sld, 666);
	sld.ship.Crew.Morale = 60+MOD_SKILL_ENEMY_RATE*4;
	sld.Ship.Crew.Exp.Sailors = 60+MOD_SKILL_ENEMY_RATE*4;
	sld.Ship.Crew.Exp.Cannoners = 60+MOD_SKILL_ENEMY_RATE*4;
	sld.Ship.Crew.Exp.Soldiers = 60+MOD_SKILL_ENEMY_RATE*4;
	AddCharacterGoods(sld, GOOD_BALLS, 3300);
	AddCharacterGoods(sld, GOOD_GRAPES, 500);
	AddCharacterGoods(sld, GOOD_KNIPPELS, 700);
	AddCharacterGoods(sld, GOOD_BOMBS, 1500);
	AddCharacterGoods(sld, GOOD_POWDER, 6000);
	Group_AddCharacter("Caleuche_Attack", "Kaleuche_khaelroacap");
    Group_SetGroupCommander("Caleuche_Attack", "Kaleuche_khaelroacap");
	Group_SetTaskAttack("Caleuche_Attack", PLAYER_GROUP);
    Group_LockTask("Caleuche_Attack");
	SetCharacterRelationBoth(sti(sld.index), GetMainCharacterIndex(), RELATION_ENEMY);
	Sea_LoginGroupCurrentSea("Caleuche_Attack");
	Group_SetTaskAttack("Caleuche_Attack", PLAYER_GROUP);
	Ship_SetTaskAttack(SECONDARY_TASK, sti(sld.index), GetMainCharacterIndex());
	
	pchar.quest.Caleuche_Khaelroa_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Caleuche_Khaelroa_AfterBattle.win_condition.l1.group = "Caleuche_Attack";
	pchar.quest.Caleuche_Khaelroa_AfterBattle.function = "Caleuche_KhaelRoaAfterBattle";
	// для ачивки
	pchar.quest.Caleuche_Khaelroa_Abordage.win_condition.l1 = "Character_Capture";
	pchar.quest.Caleuche_Khaelroa_Abordage.win_condition.l1.character = "Kaleuche_khaelroacap";
	pchar.quest.Caleuche_Khaelroa_Abordage.function = "Caleuche_KhaelroaAbordage";//взяли на абордаж
}

void Caleuche_KhaelRoaAfterBattle(string qName) // победили калеуче
{
	if (!GetDLCenabled(DLC_APPID_1)) return;
	DoQuestCheckDelay("sea_victory", 1.5);
	Group_DeleteGroup("Caleuche_Attack");
	bQuestDisableMapEnter = false;//открыть карту
	Island_SetReloadEnableGlobal("KhaelRoa", true);
	LocatorReloadEnterDisable("Temple_h", "reload2", true); // в храм больше не пускаем
	if (CheckCharacterItem(pchar, "kaleuche_amulet1"))
	{
		AddQuestRecord("Caleuche", "39");
		pchar.questTemp.Caleuche = "regard";
		AddCharacterExpToSkill(pchar, "Grappling", 500);
		AddCharacterExpToSkill(pchar, "Defence", 200);
	}
	else
	{
		AddQuestRecord("Caleuche", "40");
		pchar.questTemp.Caleuche = "end";
		CloseQuestHeader("Caleuche");
		sld = characterFromId("Tuttuat");
		sld.lifeday = 0;
	}
	AddComplexSeaExpToScill(600, 500, 500, 0, 300, 500, 0);
	ChangeCharacterComplexReputation(pchar, "fame", 10);
	ChangeCharacterComplexReputation(pchar, "authority", 20);
	pchar.questTemp.KhaelRoa = "true"; // атрибут для Натаниэля на LSC
}

void Caleuche_KhaelroaAbordage(string qName) // 
{
	pchar.questTemp.Caleuche.Abordage = "true";
}

void Caleuche_MangarosaPotion(string qName) // 
{
	pchar.questTemp.Caleuche.Potion = "true";
}

void Caleuche_MangarosaPotionEffect(string sEff) // 
{
	switch (sEff)
	{
		case "kaleuche_amulet1":
			if (AddSPECIALValue(pchar, SPECIAL_A, 0) != SPECIAL_MAX)
			{
				log_info("You feel more dexterous");
				AddSPECIALValue(pchar, SPECIAL_A, 1);
			}
			AddCharacterSkill(pchar, SKILL_F_LIGHT, 5);
		break;
		
		case "kaleuche_amulet2":
			if (AddSPECIALValue(pchar, SPECIAL_E, 0) != SPECIAL_MAX)
			{
				log_info("You feel more sturdy");
				AddSPECIALValue(pchar, SPECIAL_E, 1);
			}
			AddCharacterSkill(pchar, SKILL_FENCING, 5);
		break;
		
		case "kaleuche_amulet3":
			sld = ItemsFromID("kaleuche_amulet3");
			int i = sti(sld.reaction);
			switch (i)
			{
				case 31:
					if (AddSPECIALValue(pchar, SPECIAL_S, 0) != SPECIAL_MAX)
					{
						log_info("You feel stronger");
						AddSPECIALValue(pchar, SPECIAL_S, 1);
					}
					AddCharacterSkill(pchar, SKILL_F_HEAVY, 5);
				break;
				
				case 32:
					if (AddSPECIALValue(pchar, SPECIAL_P, 0) != SPECIAL_MAX)
					{
						log_info("Your perception intensifies");
						AddSPECIALValue(pchar, SPECIAL_P, 1);
					}
					AddCharacterSkill(pchar, SKILL_PISTOL, 5);
				break;
				
				case 33:
					if (AddSPECIALValue(pchar, SPECIAL_I, 0) != SPECIAL_MAX)
					{
						log_info("You feel more insightful");
						AddSPECIALValue(pchar, SPECIAL_I, 1);
					}
					AddCharacterSkill(pchar, SKILL_SNEAK, 5);
				break;
				
				case 34:
					if (AddSPECIALValue(pchar, SPECIAL_C, 0) != SPECIAL_MAX)
					{
						log_info("You feel more self-assured");
						AddSPECIALValue(pchar, SPECIAL_C, 1);
					}
					AddCharacterSkill(pchar, SKILL_LEADERSHIP, 5);
				break;
				
				case 35:
					if (AddSPECIALValue(pchar, SPECIAL_L, 0) != SPECIAL_MAX)
					{
						log_info("You feel inspired");
						AddSPECIALValue(pchar, SPECIAL_L, 1);
					}
					AddCharacterSkill(pchar, SKILL_FORTUNE, 5);
				break;
			}
		break;
	}
}
// <-- Калеуче

// Addon-2016 Jason, французские миниквесты (ФМК)
void FMQ_SetConditions(string qName) // установка параметров старта
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	if (CheckAttribute(pchar, "questTemp.FMQ.Success")) return;
	// Гваделупа
	pchar.quest.FMQG_start.win_condition.l1 = "location";
	pchar.quest.FMQG_start.win_condition.l1.location = "Baster_town";
	pchar.quest.FMQG_start.win_condition.l2 = "Ship_location";
	pchar.quest.FMQG_start.win_condition.l2.location = "Baster_town";
	pchar.quest.FMQG_start.win_condition.l3 = "Hour";
	pchar.quest.FMQG_start.win_condition.l3.start.hour = 8.00;
	pchar.quest.FMQG_start.win_condition.l3.finish.hour = 15.00;
	pchar.quest.FMQG_start.function = "FMQG_Activation";
	// Мартиника
	pchar.quest.FMQM_start.win_condition.l1 = "location";
	pchar.quest.FMQM_start.win_condition.l1.location = "Fortfrance_town";
	pchar.quest.FMQM_start.win_condition.l2 = "Ship_location";
	pchar.quest.FMQM_start.win_condition.l2.location = "Fortfrance_town";
	pchar.quest.FMQM_start.win_condition.l3 = "Hour";
	pchar.quest.FMQM_start.win_condition.l3.start.hour = 8.00;
	pchar.quest.FMQM_start.win_condition.l3.finish.hour = 20.00;
	pchar.quest.FMQM_start.function = "FMQM_Activation";
	// Сент-Кристофер
	pchar.quest.FMQN_start.win_condition.l1 = "location";
	pchar.quest.FMQN_start.win_condition.l1.location = "Charles_town";
	pchar.quest.FMQN_start.win_condition.l2 = "Ship_location";
	pchar.quest.FMQN_start.win_condition.l2.location = "Charles_town";
	pchar.quest.FMQN_start.win_condition.l3 = "Hour";
	pchar.quest.FMQN_start.win_condition.l3.start.hour = 8.00;
	pchar.quest.FMQN_start.win_condition.l3.finish.hour = 21.00;
	pchar.quest.FMQN_start.function = "FMQN_Activation";
	// Тортуга
	pchar.quest.FMQT_start.win_condition.l1 = "location";
	pchar.quest.FMQT_start.win_condition.l1.location = "Tortuga_town";
	pchar.quest.FMQT_start.win_condition.l2 = "Ship_location";
	pchar.quest.FMQT_start.win_condition.l2.location = "Tortuga_town";
	pchar.quest.FMQT_start.win_condition.l3 = "Hour";
	pchar.quest.FMQT_start.win_condition.l3.start.hour = 10.00;
	pchar.quest.FMQT_start.win_condition.l3.finish.hour = 16.00;
	pchar.quest.FMQT_start.function = "FMQT_Activation";
	// Порт-о-Пренс
	pchar.quest.FMQP_start.win_condition.l1 = "location";
	pchar.quest.FMQP_start.win_condition.l1.location = "Portpax_town";
	pchar.quest.FMQP_start.win_condition.l2 = "Ship_location";
	pchar.quest.FMQP_start.win_condition.l2.location = "Portpax_town";
	pchar.quest.FMQP_start.win_condition.l3 = "Hour";
	pchar.quest.FMQP_start.win_condition.l3.start.hour = 8.00;
	pchar.quest.FMQP_start.win_condition.l3.finish.hour = 22.00;
	pchar.quest.FMQP_start.function = "FMQP_Activation";
	// флаг, он же счетчик
	pchar.questTemp.FMQ.Success = 0;
}

void FMQ_Count() // подсчет успешно выполненных
{
	pchar.questTemp.FMQ.Success = sti(pchar.questTemp.FMQ.Success)+1;
	if (sti(pchar.questTemp.FMQ.Success) == 5) FMQL_Start(); // запуск последнего квеста
}

// --> ФМК-Гваделупа
void FMQG_Activation(string qName) // 
{
	if (CheckAttribute(pchar, "questTemp.HWIC") || sti(pchar.rank) > 12 || pchar.Ship.Type == SHIP_NOTUSED) return;
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	sld = GetCharacter(NPC_GenerateCharacter("FMQG_pass_1", "q_citizen_1", "man", "man", 10, FRANCE, -1, false, "soldier"));
	SetFantomParamFromRank(sld, 10, true);
	sld.Dialog.Filename = "Quest\LineMiniQuests\FMQ_Guadeloupe.c";
	sld.Dialog.currentnode = "citizen";
	sld.name = "Bertrand";
	sld.lastname = "Pinette";
	RemoveAllCharacterItems(sld, true);
	ChangeCharacterAddressGroup(sld, "Baster_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void FMQG_StartLate(string qName) // опоздание
{
	pchar.quest.FMQG_Capster.over = "yes"; //снять прерывание
	pchar.questTemp.FMQG = "fail";
	DeleteAttribute(pchar, "GenQuest.SmugglersBlock");
	AddQuestRecord("FMQ_Guadeloupe", "2");
	CloseQuestHeader("FMQ_Guadeloupe");
}

void FMQG_CapsterBeach(string qName) // на пляже
{
	pchar.quest.FMQG_StartLate.over = "yes"; //снять таймер
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	// горожанин
	sld = characterFromId("FMQG_pass_1");
	sld.Dialog.currentnode = "citizen_9";
	GiveItem2Character(sld, "blade_04");
	GiveItem2Character(sld, "pistol1");
	EquipCharacterbyItem(sld, "blade_04");
	EquipCharacterbyItem(sld, "pistol1");
	TakeNItems(sld, "bullet", 20);
	TakeNItems(sld, "potion1", 5);
	LAi_SetCharacterUseBullet(sld, "bullet");
	ChangeCharacterAddressGroup(sld, "Shore29", "smugglers", "smuggler01");
	LAi_SetStayType(sld);
	// испанец
	sld = GetCharacter(NPC_GenerateCharacter("FMQG_pass_2", "off_spa_6", "man", "man", 30, SPAIN, -1, false, "soldier"));
	SetFantomParamFromRank(sld, 30, true);
	sld.name = "Carlos";
	sld.lastname = "de Milyar";
	ChangeCharacterAddressGroup(sld, "Shore29", "smugglers", "smuggler02");
	LAi_SetActorType(sld);
	TakeNItems(sld, "potion2", 2);
	// француз
	sld = GetCharacter(NPC_GenerateCharacter("FMQG_pass_3", "quest_off_franc", "man", "man", 20, FRANCE, -1, false, "soldier"));
	SetFantomParamFromRank(sld, 20, true);
	sld.name = "Jean";
	sld.lastname = "Deno";
	ChangeCharacterAddressGroup(sld, "Shore29", "smugglers", "smuggler03");
	LAi_SetActorType(sld);
	TakeNItems(sld, "potion2", 2);
}

void FMQG_SailingStart(string qName) // вышли в море
{
	LAi_LocationFightDisable(&Locations[FindLocation("Shore29")], false);
	AddQuestRecord("FMQ_Guadeloupe", "3");
	pchar.quest.FMQG_SailFinish.win_condition.l1 = "location";
	pchar.quest.FMQG_SailFinish.win_condition.l1.location = "Shore47";
	pchar.quest.FMQG_SailFinish.win_condition.l2 = "Ship_location";
	pchar.quest.FMQG_SailFinish.win_condition.l2.location = "Shore47";
	pchar.quest.FMQG_SailFinish.function = "FMQG_SailingFinish";
}

void FMQG_SailingLate(string qName) // опоздали к Москитос
{
	AddQuestRecord("FMQ_Guadeloupe", "4");
	pchar.questTemp.FMQG = "late";
}

void FMQG_MutiniActivate(string qName) // закладка бунта
{
	if (IsEntity(&worldMap)) DoQuestFunctionDelay("FMQG_MutiniOnShip", 0.5);
	else
	{
		pchar.quest.FMQG_Mutiny.win_condition.l1 = "MapEnter";
		pchar.quest.FMQG_Mutiny.function = "FMQG_MutiniOnShip";
	}
}

void FMQG_MutiniOnShip(string qName) // бунт
{
	pchar.quest.FMQG_SailFinish.over = "yes";
	pchar.questTemp.FMQG = "mutiny";
	MunityOnShip("ShipMunity");
}

void FMQG_SailingFinish(string qName) // прибыли в Москитос
{
	float locx, locy, locz;
	pchar.quest.FMQG_SailingLate.over = "yes";
	pchar.quest.FMQG_MutiniActivate.over = "yes";
	pchar.quest.FMQG_Mutiny.over = "yes";
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	for (i=1; i<=3; i++)
	{
		sld = characterFromId("FMQG_pass_"+i);
		RemovePassenger(pchar, sld);
		GetCharacterPos(pchar, &locx, &locy, &locz);
		ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestLocator("goto", locx, locy, locz));
		LAi_SetActorType(sld);
		if (i == 1)
		{
			sld.Dialog.currentnode = "citizen_12";
			if (pchar.questTemp.FMQG == "late") sld.Dialog.currentnode = "citizen_12a";
			LAi_ActorDialog(sld, pchar, "", -1, 0);
		}
	}
}

void FMQG_Block(string qName) // блокировка продолжения, если истекли 3 месяца, или 8 ранг
{
	pchar.questTemp.FMQG = "block";
}

void FMQG_BasterContinue(string qName) // продолжение
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	sld = GetCharacter(NPC_GenerateCharacter("FMQG_cureer", "citiz_12", "man", "man", 10, FRANCE, 0, false, "soldier"));
	SetFantomParamFromRank(sld, 10, true);
	sld.Dialog.Filename = "Quest\LineMiniQuests\FMQ_Guadeloupe.c";
	sld.Dialog.currentnode = "cureer";
	RemoveAllCharacterItems(sld, true);
	ChangeCharacterAddressGroup(sld, "Baster_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void FMQG_CreateJuanship(string qName) // ставим корабль дона Хуана
{
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE-2; // Addon 2016-1 Jason пиратская линейка
	int iScl = 10 + 2*sti(pchar.rank);
	int iCannon = CANNON_TYPE_CANNON_LBS16;
	if (MOD_SKILL_ENEMY_RATE < 4) iCannon = CANNON_TYPE_CANNON_LBS12;
	if (MOD_SKILL_ENEMY_RATE > 6) iCannon = CANNON_TYPE_CULVERINE_LBS18;
	AddQuestRecord("FMQ_Guadeloupe", "11");
	Group_FindOrCreateGroup("FMQG_shipgroup");
	sld = GetCharacter(NPC_GenerateCharacter("FMQG_Juan", "quest_off_spain", "man", "man", iRank, SPAIN, -1, false, "soldier"));
	FantomMakeSmallSailor(sld, SHIP_SCHOONER_W, "Sario", iCannon, iScl, iScl, iScl, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank-5, iScl, iScl, "blade_13", "pistol1", "bullet", iScl*3);
	sld.name = "Juan";
	sld.lastname = "Deno";
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.DontHitInStorm = true; // не ломается в шторм
	sld.Ship.Mode = "war";
	Character_SetAbordageEnable(sld, false);
	sld.DontDeskTalk = true;
	RealShips[sti(sld.Ship.Type)].ship.upgrades.hull = 1;
	SetSailsColor(sld, 3);
	sld.ship.Crew.Morale = MOD_SKILL_ENEMY_RATE*8+20;
	sld.Ship.Crew.Exp.Sailors = MOD_SKILL_ENEMY_RATE*8+20;
	sld.Ship.Crew.Exp.Cannoners = MOD_SKILL_ENEMY_RATE*8+20;
	sld.Ship.Crew.Exp.Soldiers = MOD_SKILL_ENEMY_RATE*8+20;
	if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("FMQG_shipgroup", "FMQG_Juan");
	Group_SetGroupCommander("FMQG_shipgroup", "FMQG_Juan");
	Group_SetTaskNone("FMQG_shipgroup");
	Group_SetAddress("FMQG_shipgroup", "PortoBello", "Islandships1", "ship_2");
	Group_LockTask("FMQG_shipgroup");
	// на атаку в порту
	pchar.quest.FMQG_Juanfail.win_condition.l1 = "NPC_Death";
	pchar.quest.FMQG_Juanfail.win_condition.l1.character = "FMQG_Juan";
	pchar.quest.FMQG_Juanfail.function = "FMQG_ShipJuanFail";
	// на отправление в путь
	int i = rand(1)+1;
	pchar.quest.FMQG_Juansail.win_condition.l1 = "Timer";
	pchar.quest.FMQG_Juansail.win_condition.l1.date.hour  = sti(GetTime() + rand(6));
	pchar.quest.FMQG_Juansail.win_condition.l1.date.day   = GetAddingDataDay(0, 0, i);
	pchar.quest.FMQG_Juansail.win_condition.l1.date.month = GetAddingDataMonth(0, 0, i);
	pchar.quest.FMQG_Juansail.win_condition.l1.date.year  = GetAddingDataYear(0, 0, i);
	pchar.quest.FMQG_Juansail.function = "FMQG_ShipJuanSail";
}

void FMQG_ShipJuanFail(string qName) // напал в порту и прибил
{
	pchar.quest.FMQG_Juansail.over = "yes";
	pchar.questTemp.FMQG = "fail";
	AddQuestRecord("FMQ_Guadeloupe", "13");
	CloseQuestHeader("FMQ_Guadeloupe");
}

void FMQG_ShipJuanSail(string qName) // 
{
	if (bSeaActive)
	{
		pchar.quest.FMQG_Juansail1.win_condition.l1 = "ExitFromSea";
		pchar.quest.FMQG_Juansail1.function = "FMQG_ShipJuanToMap";
	}
	else DoQuestFunctionDelay("FMQG_ShipJuanToMap", 1.5);
}

void FMQG_ShipJuanToMap(string qName) // шхуна на карте
{
	pchar.quest.FMQG_Juanfail.over = "yes";
	Group_DelCharacter("FMQG_shipgroup", "FMQG_Juan");
	Group_DeleteGroup("FMQG_shipgroup");
	AddQuestRecord("FMQ_Guadeloupe", "12");
	string sGroup = "Sea_FMQGgroup1";
	Group_FindOrCreateGroup(sGroup);
	Group_SetType(sGroup, "war");
	sld = characterFromId("FMQG_Juan");
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Alwaysenemy = true;
	sld.Coastal_Captain = true;
	sld.Ship.Mode = "war";
	Character_SetAbordageEnable(sld, true);//можно абордировать
	sld.mapEnc.type = "war";
	sld.mapEnc.worldMapShip = "quest_ship";
	sld.mapEnc.Name = "'Sario'";
	Group_AddCharacter(sGroup, "FMQG_Juan");
	
	Group_SetGroupCommander(sGroup, "FMQG_Juan");
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
	Map_CreateTrader("Portobello", "Cartahena", "FMQG_Juan", 7);
	SetFunctionTimerCondition("FMQG_JuanLost", 0, 0, 8, false);
	pchar.quest.FMQG_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.FMQG_AfterBattle.win_condition.l1.group = sGroup;
	pchar.quest.FMQG_AfterBattle.function = "FMQG_JuanAfterBattle";
}

void FMQG_JuanAfterBattle(string qName) // 
{
	pchar.quest.FMQG_JuanLost.over = "yes";
	Group_DeleteGroup("FMQG_shipgroup");
	if (pchar.questTemp.FMQG == "fail") return;
	if (pchar.questTemp.FMQG == "juan_capture")
	{
		Group_DeleteGroup("Sea_FMQGgroup1");
		PlaySound("MUSIC\Victory.mp3");
		AddComplexSeaExpToScill(50, 50, 50, 50, 50, 50, 0);
	}
	else
	{
		Group_DeleteGroup("Sea_FMQGgroup1");
		pchar.questTemp.FMQG = "fail";
		AddQuestRecord("FMQ_Guadeloupe", "15");
		CloseQuestHeader("FMQ_Guadeloupe");
	}
}

void FMQG_JuanLost(string qName) // 
{
	pchar.quest.FMQG_AfterBattle.over = "yes";
	Group_DeleteGroup("Sea_FMQGgroup1");
	pchar.questTemp.FMQG = "fail";
	AddQuestRecord("FMQ_Guadeloupe", "15");
	CloseQuestHeader("FMQ_Guadeloupe");
}

void FMQG_ArriveMoskitos(string qName) // 
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	if (pchar.questTemp.FMQG == "fail") return;
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	sld = GetCharacter(sti(Pchar.questTemp.FMQG.PrisonerIDX));
	ReleasePrisoner(sld);
	sld.Dialog.Filename = "Quest\LineMiniQuests\FMQ_Guadeloupe.c";
	sld.Dialog.currentnode = "Juan_2";
	LAi_CharacterEnableDialog(sld);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void FMQG_PlantationGuards(string qName) // 
{
	int n = 1;
	if (MOD_SKILL_ENEMY_RATE > 4) n = 2;
	int iRank = MOD_SKILL_ENEMY_RATE+7;
	for (int i=1; i<=n; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("FMQG_plant_guard_"+i, "sold_eng_"+i, "man", "man", iRank, ENGLAND, -1, false, "soldier"));
		SetFantomParamFromRank(sld, iRank, true);
		ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	SetNationRelation2MainCharacter(ENGLAND, RELATION_ENEMY);
	ChangeCharacterNationReputation(pchar, ENGLAND, -3);
}

void FMQG_Lighthouse(string qName) // на маяке
{
	AddQuestRecord("FMQ_Guadeloupe", "20");
	int i = 1+rand(1);
	SetFunctionTimerCondition("FMQG_KidnappingPrepare", 0, 0, i, false);
	int n = FindLocation("Bridgetown_Plantation");
	locations[n].locators_radius.quest.detector2 = 3.5;
	pchar.quest.FMQG_KidnappingInfo.win_condition.l1 = "locator";
	pchar.quest.FMQG_KidnappingInfo.win_condition.l1.location = "Bridgetown_Plantation";
	pchar.quest.FMQG_KidnappingInfo.win_condition.l1.locator_group = "quest";
	pchar.quest.FMQG_KidnappingInfo.win_condition.l1.locator = "detector2";
	pchar.quest.FMQG_KidnappingInfo.function = "FMQG_KidnappingInfo";
	pchar.questTemp.FMQG.Info = "true";
}

void FMQG_KidnappingPrepare(string qName) // на маяке
{
	if (pchar.questTemp.FMQG == "fail") return;
	int iTime = 18+rand(3);
	pchar.quest.FMQG_Kidnapping.win_condition.l1 = "Ship_location";
	pchar.quest.FMQG_Kidnapping.win_condition.l1.location = "Mayak2";
	pchar.quest.FMQG_Kidnapping.win_condition.l2 = "locator";
	pchar.quest.FMQG_Kidnapping.win_condition.l2.location = "Bridgetown_Plantation";
	pchar.quest.FMQG_Kidnapping.win_condition.l2.locator_group = "quest";
	pchar.quest.FMQG_Kidnapping.win_condition.l2.locator = "detector2";
	pchar.quest.FMQG_Kidnapping.win_condition.l3 = "HardHour";
	pchar.quest.FMQG_Kidnapping.win_condition.l3.hour = iTime;
	pchar.quest.FMQG_Kidnapping.function = "FMQG_KidnappingPinett";
}

void FMQG_KidnappingInfo(string qName) // 
{
	DoQuestCheckDelay("TalkSelf_Quest", 0.1);
	PlaySound("interface\notebook.wav");
}

void FMQG_KidnappingPinett(string qName) // Пинетт вышел
{
	log_info("This is it! Bertrand Pinette is heading to the town!");
	PlaySound("interface\notebook.wav");
	iTotalTemp = MOD_SKILL_ENEMY_RATE/2;
	if (iTotalTemp < 2) iTotalTemp = 2;
	int iRank = MOD_SKILL_ENEMY_RATE+3;
	int iScl = 10 + 2*sti(pchar.rank);
	LAi_group_Delete("TmpEnemy");
	LAi_group_Delete("EnemyFight");
	chrDisableReloadToLocation = true;
	sld = characterFromId("FMQG_pass_1");
	sld.LSC_clan = true;
	ChangeCharacterAddressGroup(sld, pchar.location, "quest", "detector3");
	LAi_SetActorType(sld);
	LAi_SetCheckMinHP(sld, LAi_GetCharacterHP(sld)-1, false, "FMQG_KidnappingAttack");
	LAi_ActorGoToLocator(sld, "reload", "reload1_back", "FMQG_KidnappingFail", -1);
	for (int i=1; i<=iTotalTemp; i++)
	{
		ref chr = GetCharacter(NPC_GenerateCharacter("FMQG_pinett_guard_"+i, "citiz_2"+i, "man", "man", iRank, ENGLAND, -1, false, "soldier"));
		FantomMakeCoolFighter(chr, iRank, iScl, iScl, LinkRandPhrase("blade_10","blade_04","blade_06"), "pistol1", "bullet", iScl*3);
		chr.LSC_clan = true;
		ChangeCharacterAddressGroup(chr, pchar.location, "quest", "detector3");
		LAi_SetActorType(chr);
		LAi_SetCheckMinHP(chr, LAi_GetCharacterHP(chr)-1, false, "FMQG_KidnappingAttack");
		LAi_ActorFollow(chr, sld, "", -1);
	}
}

void FMQG_KidnappingSucsess(string qName) // Пинетт на корабле
{
	LocatorReloadEnterDisable("Mayak2", "reload1_back", false);
	AddQuestRecord("FMQ_Guadeloupe", "22");
	sld = characterFromId("FMQG_pass_1");
	LAi_SetActorType(sld);
	sld.location = "none";
	AddPassenger(pchar, sld, false);
	SetCharacterRemovable(sld, false);
	pchar.questTemp.FMQG = "sucsess";
}

void FMQG_InCave(string qName) // в пещере Гваделупы
{
	pchar.quest.FMQG_cave1.win_condition.l1 = "location";
	pchar.quest.FMQG_cave1.win_condition.l1.location = "Guadeloupe_CaveEntrance";
	pchar.quest.FMQG_cave1.function = "FMQG_Killers";
}

void FMQG_Killers(string qName) // привет от ростовщика
{
	int n = 2;// Addon 2016-1 Jason пиратская линейка
	if (MOD_SKILL_ENEMY_RATE > 6) n = 3;
	if (MOD_SKILL_ENEMY_RATE < 4) n = 1;
	int iRank = MOD_SKILL_ENEMY_RATE+5;
	chrDisableReloadToLocation = true;
	for (int i=1; i<=n; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("FMQG_killer_"+i, RandPhraseSimple("Killer_1","Killer_5"), "man", "man", iRank, PIRATE, -1, false, "soldier")); // may-16
		FantomMakeCoolFighter(sld, iRank, 30, 30, RandPhraseSimple("topor_04","blade_06"), "pistol1", "bullet", 120);
		ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload2_back");
		LAi_SetActorType(sld);
		if (i == 1)
		{
			sld.Dialog.Filename = "Quest\LineMiniQuests\FMQ_Guadeloupe.c";
			sld.Dialog.currentnode = "killer";
		}
		else LAi_CharacterDisableDialog(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void FMQG_UsurerTimeOut(string qName) // таймер опоздания 61 день
{
	AddQuestRecord("FMQ_Guadeloupe", "28");
	CloseQuestHeader("FMQ_Guadeloupe");
	ChangeCharacterHunterScore(pchar, "frahunter", 50);
	ChangeCharacterComplexReputation(pchar, "nobility", -10);
	ChangeOfficersLoyality("bad_all", 5);
	AddCrewMorale(pchar, -20);
	pchar.quest.FMQG_Juanship.over = "yes";
	if (GetCharacterIndex("FMQG_Juan") != -1) // стоит в порту
	{
		sld = characterFromId("FMQG_Juan");
		sld.lifeday = 0;
		Group_DeleteGroup("Sea_FMQGgroup1"); // плывет по карте
	}
	pchar.quest.FMQG_Juanfail.over = "yes";
	pchar.quest.FMQG_Juansail.over = "yes";
	pchar.quest.FMQG_Juansail1.over = "yes";
	pchar.quest.FMQG_JuanToMap.over = "yes";
	if (pchar.questTemp.FMQG == "to_moskitos") // пленник в трюме - в обычные пленники
	{
		pchar.quest.FMQG_SailMoskitos.over = "yes";
		sld = characterFromId(pchar.questTemp.FMQG.PrisonerID);
		sld.Dialog.currentnode = "First time";
		LAi_CharacterEnableDialog(sld);
	}
	if (pchar.questTemp.FMQG == "headhunter_pinett") // идет охота на Пинетта
	{
		sld = characterFromId("FMQG_pass_1");
		sld.lifeday = 0;
		pchar.quest.FMQG_Mayak.over = "yes";
		pchar.quest.FMQG_Kidnapping.over = "yes";
	}
	if (pchar.questTemp.FMQG == "sucsess") // Пинетт захвачен
	{
		sld = characterFromId("FMQG_pass_1");
		RemovePassenger(pchar, sld);
		sld.lifeday = 0;
		AddQuestUserData("FMQ_Guadeloupe", "sAdd", " As for Pinette.. Hell with him, the scum banker won't have him.");
	}
	if (pchar.questTemp.FMQG == "letter") // письмо Пинетта
	{
		ReOpenQuestHeader("FMQ_Guadeloupe");
		AddQuestUserData("FMQ_Guadeloupe", "sAdd1", " The scum banker will help me to sort this out under a threat of exposure - Pinette's letter is a very serious argument. I should head to Guadeloupe and enter the town through the city gates at night.");
		pchar.questTemp.FMQG.Letter = "true";
	}
	pchar.questTemp.FMQG = "fail";
}

void FMQG_RemoveHunterScore(string qName) // снятие НЗГ
{
	int n = ChangeCharacterHunterScore(Pchar, "frahunter", 0);
	if (n >= 50) ChangeCharacterNationReputation(pchar, FRANCE, 50);
	else ChangeCharacterNationReputation(pchar, FRANCE, n);
	ChangeCharacterComplexReputation(pchar, "nobility", 10);
	ChangeOfficersLoyality("good_all", 5);
	AddCrewMorale(pchar, 20);
}

void FMQG_ClearBox(string qName) // 
{
	DeleteAttribute(pchar, "GenQuestBox.Guadeloupe_Cave");
}
// <-- ФМК-Гваделупа

// --> ФМК-Мартиника
void FMQM_Activation(string qName) // старт
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	if (CheckAttribute(pchar, "questTemp.HWIC") || sti(pchar.rank) > 12 || pchar.Ship.Type == SHIP_NOTUSED) return;
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	sld = GetCharacter(NPC_GenerateCharacter("FMQM_carpenter", "citiz_25", "man", "man", 10, FRANCE, 0, false, "soldier"));
	SetFantomParamFromRank(sld, 10, true);
	sld.Dialog.Filename = "Quest\LineMiniQuests\FMQ_Martinique.c";
	sld.Dialog.currentnode = "carpenter";
	RemoveAllCharacterItems(sld, true);
	ChangeCharacterAddressGroup(sld, "Fortfrance_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void FMQM_Denial(string qName) // просрочка
{
	pchar.questTemp.FMQM = "fail";
	AddQuestRecord("FMQ_Martinique", "2");
	CloseQuestHeader("FMQ_Martinique");
}

void FMQM_ConvoyStart(string qName) // конвой со смолой
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	string sCapId = "OilCap";// Addon 2016-1 Jason пиратская линейка
    string sGroup = "Sea_" + sCapId + "1";
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE-2;// Addon 2016-1 Jason пиратская линейка
	int iScl = 10 + 2*sti(pchar.rank);
	int iShip, iTemp, iSpace;
	if (sti(pchar.rank) < 8)
	{
		if (MOD_SKILL_ENEMY_RATE < 7) iShip = SHIP_SLOOP;
		else iShip = SHIP_SCHOONER_W;
	}
	else
	{
		if (MOD_SKILL_ENEMY_RATE < 7) iShip = SHIP_BARKENTINE;
		else iShip = SHIP_BRIG;
	}
	for (int i = 1; i <= 3; i++)
    {
		sld = GetCharacter(NPC_GenerateCharacter(sCapId + i, "citiz_41", "man", "man", iRank, SPAIN, 25, true, "soldier"));
		SetRandomNameToCharacter(sld);
		SetRandomNameToShip(sld);
		switch (i)
		{
			case 1: iTemp = iShip; break;
			case 2: 
				if (MOD_SKILL_ENEMY_RATE < 7) iTemp = SHIP_BARQUE;
				else iTemp = SHIP_BARKENTINE; 
			break;
			case 3: 
				if (MOD_SKILL_ENEMY_RATE < 7) iTemp = SHIP_LUGGER;
				else iTemp = SHIP_SCHOONER;
			break;
		}
		sld.Ship.Type = GenerateShipExt(iTemp, 1, sld);
		SetBaseShipData(sld);
		if (i > 1) 
		{
			SetCaptanModelByEncType(sld, "trade");
			sld.Ship.Mode = "trade";
		}
		else 
		{
			SetCaptanModelByEncType(sld, "war");
			sld.Ship.Mode = "war";
		}
		int hcrew = GetMaxCrewQuantity(sld);
		SetCrewQuantity(sld, hcrew);
		SetCrewQuantityFull(sld);
		sld.AlwaysEnemy = true;
		sld.DontRansackCaptain = true;
		sld.lifeDay = 25;
		sld.AnalizeShips = true;
		sld.WatchFort = true; //видеть форты
		sld.skill.Sailing = iScl+rand(5);
		sld.skill.Defence = iScl+rand(5);
		sld.skill.Accuracy = iScl+rand(5);
		sld.skill.Cannons = iScl+rand(5);
		sld.Ship.Crew.Morale = iScl+10;
		sld.Ship.Crew.Exp.Sailors = iScl+10;
		sld.Ship.Crew.Exp.Cannoners = iScl+10;
		sld.Ship.Crew.Exp.Soldiers = iScl+10;
		SetCharacterPerk(sld, "HullDamageUp");
		SetCharacterPerk(sld, "SailsDamageUp");
		SetCharacterPerk(sld, "CrewDamageUp");
		if (MOD_SKILL_ENEMY_RATE > 4 && i == 1) SetCharacterPerk(sld, "CriticalShoot");
		if (MOD_SKILL_ENEMY_RATE > 6) SetCharacterPerk(sld, "MusketsShoot");
		SetCharacterPerk(sld, "AdvancedBattleState");
		SetCharacterPerk(sld, "ShipTurnRateUp");
		SetCharacterPerk(sld, "ShipSpeedUp");
		DeleteAttribute(sld, "SinkTenPercent");
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		AddCharacterGoods(sld, GOOD_BALLS, 300);
		AddCharacterGoods(sld, GOOD_GRAPES, 300);
		AddCharacterGoods(sld, GOOD_KNIPPELS, 200);
		AddCharacterGoods(sld, GOOD_BOMBS, 200);
		AddCharacterGoods(sld, GOOD_POWDER, 800);
		iSpace = GetCharacterFreeSpace(sld, GOOD_SUGAR);
		iSpace = makeint(iSpace/2 + drand(iSpace/2));
		Fantom_SetCharacterGoods(sld, GOOD_SUGAR, iSpace, 1);
		if (i == 2) 
		{
			sld.Ship.Name = "Benseсho";
			SetCharacterGoods(sld, GOOD_OIL, 100+drand(10));//положить в трюм смолу
			if (MOD_SKILL_ENEMY_RATE > 4) SetCrewQuantityOverMax(sld, hcrew+4*MOD_SKILL_ENEMY_RATE); // увеличенная команда // may-16
		}
		sld.mapEnc.type = "trade";
		sld.mapEnc.worldMapShip = "quest_ship";
        sld.mapEnc.Name = "trade convoy from Port-of-Spain";
        Group_AddCharacter(sGroup, sCapId + i);
	}
	Group_SetGroupCommander(sGroup, sCapId+ "1");
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
	Map_CreateTrader("PortSpein", "SanJuan", sCapId + "1", 25);//запуск энкаунтера
	SetFunctionTimerCondition("FMQM_ConvoyDelete", 0, 0, 26, false);
	pchar.quest.FMQM_Convoy_Abordage.win_condition.l1 = "Character_Capture";
	pchar.quest.FMQM_Convoy_Abordage.win_condition.l1.character = "OilCap2";
	pchar.quest.FMQM_Convoy_Abordage.function = "FMQM_ConvoyBoarding";//взяли на абордаж
	pchar.quest.FMQM_Convoy_Sink.win_condition.l1 = "Character_sink";
	pchar.quest.FMQM_Convoy_Sink.win_condition.l1.character = "OilCap2";
	pchar.quest.FMQM_Convoy_Sink.function = "FMQM_ConvoySink";//потопили
}

void FMQM_ConvoyBoarding(string qName) // 
{
	pchar.quest.FMQM_ConvoyDelete.over = "yes";
	pchar.quest.FMQM_Convoy_Sink.over = "yes";
	AddComplexSeaExpToScill(50, 50, 50, 50, 50, 50, 0);
	if (GetSquadronGoods(pchar, GOOD_OIL) >= 50)
	{
		pchar.questTemp.FMQM = "oil";
		AddQuestRecord("FMQ_Martinique", "8");
		SetFunctionTimerCondition("FMQM_Late", 0, 0, 30, false);
	}
	else
	{
		pchar.questTemp.FMQM = "fail";
		AddQuestRecord("FMQ_Martinique", "7");
		CloseQuestHeader("FMQ_Martinique");
	}
}

void FMQM_ConvoySink(string qName) // 
{
	pchar.quest.FMQM_ConvoyDelete.over = "yes";
	pchar.quest.FMQM_Convoy_Abordage.over = "yes";
	pchar.questTemp.FMQM = "fail";
	AddQuestRecord("FMQ_Martinique", "5");
	CloseQuestHeader("FMQ_Martinique");
}

void FMQM_ConvoyDelete(string qName) // 
{
	pchar.quest.FMQM_Convoy_Sink.over = "yes";
	pchar.quest.FMQM_Convoy_Abordage.over = "yes";
	pchar.questTemp.FMQM = "fail";
	AddQuestRecord("FMQ_Martinique", "6");
	CloseQuestHeader("FMQ_Martinique");
}

void FMQM_Late(string qName) // просрочка на месяц
{
	pchar.questTemp.FMQM = "fail";
	AddQuestRecord("FMQ_Martinique", "9");
	CloseQuestHeader("FMQ_Martinique");
}

void FMQM_WaitTime(string qName) // 
{
	// ориентируем на вечер
	int iTime, iAddTime;
	iTime = sti(environment.time);
	if (iTime >= 21) iAddTime = 24 - iTime;
	if (iTime < 7) iAddTime = 21 - iTime;
	if (iTime >= 7 && iTime < 21) iAddTime = 21 - iTime;
	SetLaunchFrameFormParam("Evening has come..."+ NewStr() +"The resin was unloaded at the shipyard...", "", 0, 5);
	LaunchFrameForm();
	StoreDayUpdate();
	WaitDate("",0,0,0,iAddtime,5);
	RecalculateJumpTable();
	RefreshWeather();
	RefreshLandTime();
	DoQuestFunctionDelay("FMQM_OilTalking", 5.0);
}

void FMQM_OilTalking(string qName) // 
{
	sld = characterFromId("FortFrance_shipyarder");
	ChangeCharacterAddressGroup(sld, "FortFrance_Shipyard", "goto", "goto3");
	LAi_SetActorType(sld);
	LAi_ActorDialogNow(sld, pchar, "", -1);
	DeleteAttribute(pchar, "GenQuest.FrameLockEsc");
}

void FMQM_ShipyardOpen(string qName) // 
{
	LocatorReloadEnterDisable("FortFrance_town", "reload5_back", false);
	sld = characterFromId("FortFrance_shipyarder");
	ChangeCharacterAddressGroup(sld, "FortFrance_Shipyard", "sit", "sit1");
	sld.Dialog.Filename = "Common_Shipyard.c";
	sld.Dialog.currentnode = "First time";
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	AddQuestRecord("FMQ_Martinique", "11");
}

void FMQM_GuideAdvice(string qName) // 
{
	chrDisableReloadToLocation = true;
	sld = characterFromId("Guide_x");
	sld.dialog.currentnode = "greguar_18";
	ChangeCharacterAddressGroup(sld, "Fortfrance_town", "goto", "goto13");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void FMQM_HurryLate(string qName) // 
{
	pchar.worldmapencountersoff = "0"; // включить энкаунтеры
	pchar.quest.FMQM_hurry.over = "yes";
	pchar.questTemp.FMQM = "fail";
	AddQuestRecord("FMQ_Martinique", "14");
	CloseQuestHeader("FMQ_Martinique");
}

void FMQM_ArriveGuadeloupe(string qName) // 
{
	pchar.worldmapencountersoff = "0"; // включить энкаунтеры
	pchar.quest.FMQM_HurryLate.over = "yes";
	AddQuestRecord("FMQ_Martinique", "15");
	Island_SetReloadEnableGlobal("Guadeloupe", false);
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	pchar.GenQuest.SmugglersBlock = "baster_tavern";
	Group_SetAddress(PLAYER_GROUP, "Guadeloupe", "quest_ships", "quest_ship_10");
	// ставим тартану
	Group_FindOrCreateGroup("FMQM_Tartane");
	Group_SetType("FMQM_Tartane", "pirate");//тип группы
	sld = GetCharacter(NPC_GenerateCharacter("FMQM_Tartane_Cap", "mercen_7", "man", "man", 15, FRANCE, 5, true, "soldier"));
	FantomMakeCoolSailor(sld, SHIP_WAR_TARTANE, "Topaz", CANNON_TYPE_CANNON_LBS3, 30, 30, 30);
	FantomMakeCoolFighter(sld, 15, 30, 30, "blade_06", "pistol1", "bullet", 50);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "pirate";
	LAi_SetImmortal(sld, true);
	sld.ShipEnemyDisable = true;
	Group_AddCharacter("FMQM_Tartane", "FMQM_Tartane_Cap");
	Group_SetGroupCommander("FMQM_Tartane", "FMQM_Tartane_Cap");
	Group_SetTaskNone("FMQM_Tartane");
	Group_SetAddress("FMQM_Tartane", "Guadeloupe", "ships", "l5");
	Group_LockTask("FMQM_Tartane");
	// таймер
	pchar.quest.FMQM_Tartane.win_condition.l1 = "Timer";
	pchar.quest.FMQM_Tartane.win_condition.l1.date.hour  = 6+(rand(6));
	pchar.quest.FMQM_Tartane.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 1);
	pchar.quest.FMQM_Tartane.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 1);
	pchar.quest.FMQM_Tartane.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 1);
	pchar.quest.FMQM_Tartane.function = "FMQM_TartaneSail";
}

void FMQM_TartanaAlarm() // 
{
	log_info("Sounds of alarm on the Topaz tartane!");
	pchar.quest.FMQM_Tartane.over = "yes";
	Island_SetReloadEnableGlobal("Guadeloupe", true);
	bQuestDisableMapEnter = false;
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	DeleteAttribute(pchar, "GenQuest.SmugglersBlock");
	sld = characterFromId("FMQM_Tartane_Cap");
	sld.quest.seaattack = "true";
	LAi_SetImmortal(sld, false);
	DeleteAttribute(sld, "ShipEnemyDisable");
	Ship_SetTaskRunAway(SECONDARY_TASK, sti(sld.index), sti(pchar.index));
	SetCharacterRelationBoth(sti(sld.index), GetMainCharacterIndex(), RELATION_ENEMY);
	RefreshBattleInterface();
	UpdateRelations();
	pchar.questTemp.FMQM = "fail";
	AddQuestRecord("FMQ_Martinique", "16");
	CloseQuestHeader("FMQ_Martinique");
}

void FMQM_TartaneSail(string qName) // 
{
	sld = characterFromId("FMQM_Tartane_Cap");
	sld.quest.seaattack = "true";
	pchar.GenQuest.CabinLock = true; // закрыть каюту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	Ship_SetTaskRunAway(SECONDARY_TASK, sti(sld.index), sti(pchar.index));
	AddQuestRecord("FMQ_Martinique", "17");
	// таймер
	pchar.quest.FMQM_Tartane1.win_condition.l1 = "Timer";
	pchar.quest.FMQM_Tartane1.win_condition.l1.date.hour  = sti(GetTime() + 2);
	pchar.quest.FMQM_Tartane1.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 0);
	pchar.quest.FMQM_Tartane1.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 0);
	pchar.quest.FMQM_Tartane1.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 0);
	pchar.quest.FMQM_Tartane1.function = "FMQM_AbandonGuadeloupe";
}

void FMQM_AbandonGuadeloupe(string qName) // 
{
	log_info("You are free to land on shore");
	PlaySound("interface\notebook.wav");
	Island_SetReloadEnableGlobal("Guadeloupe", true);
	DeleteAttribute(pchar, "GenQuest.CabinLock");
	pchar.GenQuest.MapClosedNoBattle = true;
	pchar.quest.FMQM_Abandon.win_condition.l1 = "location";
	pchar.quest.FMQM_Abandon.win_condition.l1.location = "Shore28";
	pchar.quest.FMQM_Abandon.win_condition.l2 = "Ship_location";
	pchar.quest.FMQM_Abandon.win_condition.l2.location = "Shore28";
	pchar.quest.FMQM_Abandon.function = "FMQM_AbandonCoast";
	AddGeometryToLocation("Shore28", "smg");
	// таймер
	pchar.quest.FMQM_Tartane2.win_condition.l1 = "Timer";
	pchar.quest.FMQM_Tartane2.win_condition.l1.date.hour  = sti(GetTime() + 2);
	pchar.quest.FMQM_Tartane2.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 0);
	pchar.quest.FMQM_Tartane2.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 0);
	pchar.quest.FMQM_Tartane2.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 0);
	pchar.quest.FMQM_Tartane2.function = "FMQM_AbandonGuadeloupeLate";
}

void FMQM_AbandonGuadeloupeLate(string qName) // 
{
	pchar.quest.FMQM_Abandon.over = "yes";
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	DeleteAttribute(pchar, "GenQuest.SmugglersBlock");
	RemoveGeometryFromLocation("Shore28", "smg");
	pchar.questTemp.FMQM = "fail";
	AddQuestRecord("FMQ_Martinique", "22");
	CloseQuestHeader("FMQ_Martinique");
}

void FMQM_AbandonCoast(string qName) // в бухте Морн л'О
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	pchar.quest.FMQM_Tartane2.over = "yes";
	DeleteAttribute(pchar, "GenQuest.SmugglersBlock");
	int iRank = MOD_SKILL_ENEMY_RATE+5;
	int iScl = 20 + 2*sti(pchar.rank);
	int i, n;
	n = makeint(MOD_SKILL_ENEMY_RATE/3 + 6);
	pchar.GenQuest.Hunter2Pause = true;
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation("Shore28")], true);//запретить драться
	//ставим наших бойцов
	for (i=1; i<=5; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("FMQM_Our_crew_"+i, "citiz_"+(i+30), "man", "man", iRank, sti(pchar.nation), 0, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, LinkRandPhrase("blade_12","blade_09","blade_14"), "pistol1", "bullet", iScl*2);
		ChangeCharacterAddressGroup(sld, "Shore28", "goto", "goto12");
		LAi_SetActorType(sld);
		LAi_ActorFollow(sld, pchar, "", -1);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	// ставим противника
	for (i=1; i<=n; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("FMQM_Enemy_crew_"+i, "mush_ctz_9", "man", "mushketer", iRank, PIRATE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
			LAi_SetCharacterUseBullet(sld, "cartridge");
			sld.MusketerDistance = 0;
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("FMQM_Enemy_crew_"+i, "citiz_"+(40+i), "man", "man", iRank, PIRATE, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, LinkRandPhrase("blade_03","blade_05","blade_07"), "pistol1", "bullet", iScl*2);
		}
		if (i < 4) ChangeCharacterAddressGroup(sld, "Shore28", "smugglers", "smuggler0"+i);
		else 
		{
			ChangeCharacterAddressGroup(sld, "Shore28", "goto", "goto"+i);
			LAi_CharacterDisableDialog(sld);
		}
		if (MOD_SKILL_ENEMY_RATE > 8)
		{
			sld = GetCharacter(NPC_GenerateCharacter("FMQM_Enemy_crew_plus", "mush_ctz_8", "man", "mushketer", iRank+3, PIRATE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank+3, iScl+5, iScl+5, "", "mushket1", "cartridge", iScl*3);
			sld.MusketerDistance = 0;
			ChangeCharacterAddressGroup(sld, "Shore28", "smugglers", "smugglerload");
		}
		LAi_SetStayType(sld);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.dialog.FileName = "Quest\LineMiniQuests\FMQ_Martinique.c";
		sld.dialog.currentnode = "pirate";
		sld.greeting = "marginal";
	}
}

void FMQM_ShoreFight(string qName) // 
{
	LAi_group_Delete("EnemyFight");
	LAi_LocationFightDisable(&Locations[FindLocation("Shore28")], false);
	int i, n;
	n = makeint(MOD_SKILL_ENEMY_RATE/3 + 6);
	for (i=1; i<=5; i++)
	{
		sld = characterFromId("FMQM_Our_crew_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	for (i=1; i<=n; i++)
	{
		sld = characterFromId("FMQM_Enemy_crew_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	if (MOD_SKILL_ENEMY_RATE > 8)
	{
		sld = characterFromId("FMQM_Enemy_crew_plus");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "FMQM_ShoreAfterFight");
	LAi_SetFightMode(pchar, true);
}

void FMQ_CheckEnemyDistance() // расчет дистанции
{
	float fdist;
	if (pchar.location == "Shore28")
	{
		if (GetCharacterDistByLoc(pchar, "reload", "sea", &fdist))
		{
			if (fdist < 5.0) FMQM_OfficerTalkBegin();
		}
	}
}

void FMQM_OfficerTalkBegin()
{
	DeleteAttribute(pchar, "questTemp.FMQ.Attack");
	sld = characterFromId("FMQM_officer");
	LAi_SetActorType(sld);
	LAi_ActorDialogNow(sld, pchar, "", -1);
}

void FMQM_PeaceExit(string qName) // 
{
	Group_DeleteGroup("FMQM_Tartane");
	sld = characterFromId("FMQM_officer");
	LAi_SetWarriorType(sld);
	LAi_CharacterDisableDialog(sld);
	sld.lifeday = 0;
	chrDisableReloadToLocation = false;
	RemoveGeometryFromLocation("Shore28", "smg");
	pchar.quest.FMQM_final.win_condition.l1 = "ExitFromLocation";
	pchar.quest.FMQM_final.win_condition.l1.location = pchar.location;
	pchar.quest.FMQM_final.function = "FMQM_PeaceFinal";
}

void FMQM_PeaceFinal(string qName) // 
{
	LAi_LocationFightDisable(&Locations[FindLocation("Shore28")], false);
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	int i = makeint(sti(pchar.questTemp.FMQM.Qty)/2);
	SetCharacterGoods(pchar, GOOD_OIL, GetCargoGoods(pchar, GOOD_OIL) + i);
	DeleteAttribute(pchar, "questTemp.FMQM.Qty");
	pchar.questTemp.FMQM = "end";
	FMQ_Count();
	AddQuestRecord("FMQ_Martinique", "19");
	CloseQuestHeader("FMQ_Martinique");
	ChangeCharacterComplexReputation(pchar, "authority", 1);
	AddComplexSelfExpToScill(50, 50, 50, 50);
	AddCharacterExpToSkill(pchar, "Leadership", 100);
	AddCharacterExpToSkill(pchar, "Fortune", 100);
	AddCharacterExpToSkill(pchar, "Sneak", 100);
}

void FMQM_BattleExit(string qName) // 
{
	LAi_LocationFightDisable(&Locations[FindLocation("Shore28")], false);
	sld = characterFromId("FMQM_officer");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	for (i=1; i<=5; i++)
	{
		sld = characterFromId("FMQM_mercenary_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "FMQM_AfterBattleExit");
	LAi_SetFightMode(pchar, true);
}

void FMQM_SeaBattleTartane(string qName) // 
{
	RemoveGeometryFromLocation("Shore28", "smg");
	int i = makeint(sti(pchar.questTemp.FMQM.Qty)/2);
	SetCharacterGoods(pchar, GOOD_OIL, GetCargoGoods(pchar, GOOD_OIL) + i);
	SetCharacterGoods(pchar, GOOD_ROPES, GetCargoGoods(pchar, GOOD_ROPES) + 50);
	SetCharacterGoods(pchar, GOOD_SHIPSILK, GetCargoGoods(pchar, GOOD_SHIPSILK) + 30);
	SetCharacterGoods(pchar, GOOD_SANDAL, GetCargoGoods(pchar, GOOD_SANDAL) + 25);
	DeleteAttribute(pchar, "questTemp.FMQM.Qty");
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	Group_SetAddress("FMQM_Tartane", "Guadeloupe", "", "");
	Group_SetPursuitGroup("FMQM_Tartane", PLAYER_GROUP);
	sld = characterFromId("FMQM_Tartane_Cap");
	LAi_SetImmortal(sld, false);
	DeleteAttribute(sld, "ShipEnemyDisable");
	sld.Coastal_Captain = true;
	sld.AlwaysEnemy = true;
	Ship_SetTaskAttack(SECONDARY_TASK, sti(sld.index), sti(pchar.index));
	SetCharacterRelationBoth(sti(sld.index), GetMainCharacterIndex(), RELATION_ENEMY);
	RefreshBattleInterface();
	UpdateRelations();
	Group_LockTask("FMQM_Tartane");
	pchar.quest.Mirage_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Mirage_AfterBattle.win_condition.l1.group = "FMQM_Tartane";
	pchar.quest.Mirage_AfterBattle.function = "FMQM_BattleFinal";
}

void FMQM_BattleFinal(string qName) // 
{
	PlaySound("MUSIC\Victory.mp3");// Addon 2016-1 Jason пиратская линейка
	Group_DeleteGroup("FMQM_Tartane");
	bQuestDisableMapEnter = false;//открыть карту
	pchar.questTemp.FMQM = "end";
	FMQ_Count();
	AddQuestRecord("FMQ_Martinique", "21");
	CloseQuestHeader("FMQ_Martinique");
	ChangeCharacterComplexReputation(pchar, "authority", 3);
	AddCrewMorale(pchar, 5);
	ChangeOfficersLoyality("good_all", 1);
	AddComplexSelfExpToScill(80, 80, 80, 80);
	AddCharacterExpToSkill(pchar, "Leadership", 100);
	AddCharacterExpToSkill(pchar, "Fortune", 100);
	AddCharacterExpToSkill(pchar, "Sneak", 100);
	AddComplexSeaExpToScill(50, 50, 50, 50, 50, 50, 50);
}

// --> ФМК-Сент-Кристофер
void FMQN_Activation(string qName) // 
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	if (CheckAttribute(pchar, "questTemp.HWIC") || sti(pchar.rank) > 12 || pchar.Ship.Type == SHIP_NOTUSED) return;
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+5;
	int iScl = 30 + 3*sti(pchar.rank);
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	sld = GetCharacter(NPC_GenerateCharacter("FMQN_seafox_1", "quest_off_eng", "man", "man", iRank+5, ENGLAND, -1, false, "soldier"));
	FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_15", "pistol5", "bullet", iScl*3);
	sld.Dialog.Filename = "Quest\LineMiniQuests\FMQ_Nevis.c";
	sld.Dialog.currentnode = "seafox";
	sld.name = "Caspar";
	sld.lastname = "Gratton";
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	ChangeCharacterAddressGroup(sld, "Charles_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	for (i=2; i<=5; i++)
	{
		if (i == 5)
		{
			sld = GetCharacter(NPC_GenerateCharacter("FMQN_seafox_"+i, "mush_eng_6", "man", "mushketer", iRank, ENGLAND, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
			LAi_SetCharacterUseBullet(sld, "cartridge");
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("FMQN_seafox_"+i, "sold_eng_1"+i, "man", "man", iRank, ENGLAND, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, LinkRandPhrase("blade_12","blade_09","blade_14"), "pistol1", "bullet", iScl*2);
		}
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
	}
}

void FMQN_SailingLate(string qName) // закладка бунта
{
	if (IsEntity(&worldMap)) DoQuestFunctionDelay("FMQN_MutiniOnShip", 0.5);
	else
	{
		pchar.quest.FMQN_Mutiny.win_condition.l1 = "MapEnter";
		pchar.quest.FMQN_Mutiny.function = "FMQN_MutiniOnShip";
	}
}

void FMQN_MutiniOnShip(string qName) // бунт
{
	if (pchar.questTemp.FMQN != "begin") return;
	pchar.quest.FMQN_sailing.over = "yes";
	pchar.questTemp.FMQN = "mutiny";
	MunityOnShip("ShipMunity");
	for(i = 0; i < MAX_LOCATIONS; i++)
	{	
		sld = &Locations[i];
		if (CheckAttribute(sld, "islandId") && sld.islandId == "SentMartin")
		{
			sld.DisableEncounters = false;	
		}
	}
	sld = &Locations[FindLocation("Shore40")];
	DeleteAttribute(sld, "QuestlockWeather");
}

void FMQN_ArriveMaarten(string qName) // прибыли на Синт-Марртен
{
	// ориентируем на ночь
	int iTime, iAddTime;
	iTime = sti(environment.time);
	if (iTime >= 21) iAddTime = 24 - iTime + 1;
	if (iTime < 7) iAddTime = iTime + 13;
	if (iTime >= 7 && iTime < 21) iAddTime = 24 - iTime + 1;
	StoreDayUpdate();
	WaitDate("",0,0,0,iAddtime,5);
	RecalculateJumpTable();
	RefreshWeather();
	RefreshLandTime();
	pchar.quest.FMQN_SailingLate.over = "yes";
	chrDisableReloadToLocation = true;
	pchar.GenQuest.Hunter2Pause = true;
	for (int i=1; i<=5; i++)
	{
		sld = characterFromId("FMQN_seafox_"+i);
		LAi_SetActorType(sld);
		ChangeCharacterAddressGroup(sld, "Shore40", "goto", "goto"+i);
		if (i == 1)
		{
			sld.Dialog.currentnode = "seafox_6";
			LAi_ActorDialog(sld, pchar, "", -1, 0);
		}
	}
	pchar.questTemp.FMQN = "maarten";
	sld = &Locations[FindLocation("Shore40")];
	DeleteAttribute(sld, "QuestlockWeather");
}

void FMQN_EnglishmanGo() // англичане убегают
{
	for (int i=1; i<=5; i++)
	{
		sld = characterFromId("FMQN_seafox_"+i);
		LAi_SetActorType(sld);
		LAi_ActorRunToLocation(sld, "reload", "reload1_back", "none", "", "", "", 10.0);
		if (i == 1) RemovePassenger(pchar, sld);	
	}
	pchar.questTemp.FMQN.Choose = "true";
	DoQuestCheckDelay("TalkSelf_Quest", 11.0);
	InterfaceStates.Buttons.Save.enable = false;
	bDisableCharacterMenu = true;
}

void FMQN_ChooseExit(string qName) // отказ от продолжения
{
	chrDisableReloadToLocation = false;
	InterfaceStates.Buttons.Save.enable = true;
	bDisableCharacterMenu = false;
	DeleteAttribute(pchar, "questTemp.FMQN.Choose");
	for(i = 0; i < MAX_LOCATIONS; i++)
	{	
		sld = &Locations[i];
		if (CheckAttribute(sld, "islandId") && sld.islandId == "SentMartin")
		{
			sld.DisableEncounters = false;	
		}
	}
	for (int i=1; i<=5; i++)
	{
		sld = characterFromId("FMQN_seafox_"+i);
		sld.lifeday = 0;
	}
	pchar.questTemp.FMQN = "fail";
	AddQuestRecord("FMQ_Nevis", "3");
	CloseQuestHeader("FMQ_Nevis");
}

void FMQN_ChooseContinue() // продолжаем квест 
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	chrDisableReloadToLocation = false;
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	InterfaceStates.Buttons.Save.enable = true;
	bDisableCharacterMenu = false;
	pchar.GenQuest.SmugglersBlock = "marigo_tavern"; 
	DeleteAttribute(pchar, "questTemp.FMQN.Choose");
	AddQuestRecord("FMQ_Nevis", "4");
	pchar.quest.FMQN_to_port.win_condition.l1 = "location";
	pchar.quest.FMQN_to_port.win_condition.l1.location = "Marigo_town";
	pchar.quest.FMQN_to_port.win_condition.l2 = "Ship_location";
	pchar.quest.FMQN_to_port.win_condition.l2.location = "Marigo_town";
	pchar.quest.FMQN_to_port.function = "FMQN_ArriveToPort";
	SetFunctionTimerCondition("FMQN_WaitOver", 0, 0, 3, false);
	// поставим корвет Зеепард
	Group_FindOrCreateGroup("FMQN_shipgroup");
	sld = GetCharacter(NPC_GenerateCharacter("FMQN_Cap_Zeepard", "off_hol_4", "man", "man", 25, HOLLAND, -1, false, "soldier"));
	FantomMakeCoolSailor(sld, SHIP_CORVETTE, "'Zeepard", CANNON_TYPE_CULVERINE_LBS18, 65, 65, 65);
	FantomMakeCoolFighter(sld, 25, 65, 65, "blade_13", "pistol1", "bullet", 150);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.DontHitInStorm = true; // не ломается в шторм
	LAi_SetImmortal(sld, true);
	sld.ShipEnemyDisable  = true;
	sld.Ship.Mode = "war";
	sld.ship.Crew.Morale = 90;
	sld.Ship.Crew.Exp.Sailors = 90;
	sld.Ship.Crew.Exp.Cannoners = 90;
	sld.Ship.Crew.Exp.Soldiers = 90;
	SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("FMQN_shipgroup", "FMQN_Cap_Zeepard");
	Group_SetGroupCommander("FMQN_shipgroup", "FMQN_Cap_Zeepard");
	Group_SetTaskNone("FMQN_shipgroup");
	Group_SetAddress("FMQN_shipgroup", "SentMartin", "quest_ships", "quest_ship_1");
	Group_LockTask("FMQN_shipgroup");
}

void FMQN_ArriveToPort(string qName) // прибыли в Филипсбург 
{
	pchar.questTemp.FMQN = "town";
	bDisableFastReload = true;
}

void FMQN_WaitOver(string qName) // прошли три дня
{
	pchar.quest.FMQN_to_port.over = "yes";
	if (pchar.location == "Shore40") DoQuestFunctionDelay("FMQN_ThreeDaysOver", 1.0);
	else
	{
		pchar.questTemp.FMQN = "late";
		AddQuestRecord("FMQ_Nevis", "5");
		pchar.quest.FMQN_fail_town.win_condition.l1 = "location";
		pchar.quest.FMQN_fail_town.win_condition.l1.location = "Shore40";
		pchar.quest.FMQN_fail_town.function = "FMQN_ThreeDaysOver";
	}
}

void FMQN_ThreeDaysOver(string qName) // прошли три дня
{
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	bDisableFastReload = false;//открыть переход
	DeleteAttribute(pchar, "GenQuest.SmugglersBlock");
	for(i = 0; i < MAX_LOCATIONS; i++)
	{	
		sld = &Locations[i];
		if (CheckAttribute(sld, "islandId") && sld.islandId == "SentMartin")
		{
			sld.DisableEncounters = false;	
		}	
	}
	sld = characterFromId("FMQN_Cap_Zeepard");
	sld.lifeday = 0;
	pchar.questTemp.FMQN = "fail";
	AddQuestRecord("FMQ_Nevis", "6");
	CloseQuestHeader("FMQ_Nevis");
	AddSimpleRumourCity("English raiding party tried to infiltrate our prison but got into a trap arranged by our vigilant commandant. Now every Englishman is locked behind bars, ha ha!", "Marigo", 20, 2, "");
	AddSimpleRumourCity("Hear, hear. They caught British raiding party not long ago. They wanted to free their countrymen from our prison but got locked there as well instead!", "Marigo", 20, 2, "");
}

void FMQN_ToGovernor(string qName) // посланец к губеру
{
	int iTime, iAddTime;
	iTime = sti(environment.time);
	float locx, locy, locz;
	chrDisableReloadToLocation = true;
	pchar.GenQuest.Hunter2Pause = true;
	LAi_LocationFightDisable(&Locations[FindLocation("Marigo_town")], true);
	sld = GetCharacter(NPC_GenerateCharacter("FMQN_hov_sold", "sold_hol_1", "man", "man", 15, HOLLAND, 0, false, "soldier"));
	SetFantomParamFromRank(sld, 15, true);
	sld.Dialog.Filename = "Quest\LineMiniQuests\FMQ_Nevis.c";
	sld.Dialog.currentnode = "soldier";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "Marigo_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void FMQN_ReloadToGovernor() // релоад к губеру
{
	LAi_LocationFightDisable(&Locations[FindLocation("Marigo_town")], false);
	if (stf(environment.time) < 10.0) WaitDate("",0,0,0,4,5);
	DoQuestReloadToLocation("Marigo_townhall", "reload", "reload1", "");
	DoQuestCheckDelay("OpenTheDoors", 10.0); // Addon 2016-1 Jason пиратская линейка
}

void FMQN_SetSoldiersInCave() // англичан в пещеру
{
	pchar.quest.FMQN_WaitOver.over = "yes";
	pchar.GenQuest.CannotWait = true;//запрет ожидания
	LAi_LocationFightDisable(&Locations[FindLocation("Marigo_Cave")], true);
	LAi_LocationDisableOfficersGen("Marigo_Cave", true);
	sld = CharacterFromID("FMQN_seafox_1");
	sld.Dialog.currentnode = "seafox_9";
	sld.model = "quest_off_holl";
	Characters_RefreshModel(sld);
	sld.talker = 9;
	LAi_SetStayType(sld);
	ChangeCharacterAddressGroup(sld, "Marigo_Cave", "goto", "goto3");
	for (int i=2; i<=5; i++)
	{
		sld = CharacterFromID("FMQN_seafox_"+i);
		if (i == 5)
		{
			sld.model = "mush_hol_2";
		}
		else
		{
			sld.model = "sold_hol_"+(i-1);
		}
		ChangeCharacterAddressGroup(sld, "Marigo_Cave", "goto", "ass"+(i-1));
		LAi_SetActorType(sld);
	}
}

void FMQN_ToChurch() // в церковь к Филипу Якобсену
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	sld = CharacterFromID("FMQN_seafox_1");
	LAi_CharacterDisableDialog(sld);
	if (pchar.questTemp.FMQN == "way_div_1")
	{
		AddQuestRecord("FMQ_Nevis", "11");
		pchar.questTemp.FMQN = "way_div_2";
	}
	else 
	{
		AddQuestRecord("FMQ_Nevis", "12");
		pchar.questTemp.FMQN = "way_eng_2";
	}
	// ставим монаха
	sld = GetCharacter(NPC_GenerateCharacter("FMQN_monk", "monk_5", "man", "man_B", 10, HOLLAND, -1, true, "quest"));
	SetFantomParamFromRank(sld, 10, true);
	RemoveAllCharacterItems(sld, true);
	sld.name = "Filippe";
	sld.lastname = "Jaсobsen";
	sld.Dialog.Filename = "Quest\LineMiniQuests\FMQ_Nevis.c";
	sld.dialog.currentnode = "monk";
	sld.greeting = "monk";
	LAi_SetStayType(sld);
	LAi_SetImmortal(sld, true);
	LAi_SetLoginTime(sld, 8.00, 10.00);
	ChangeCharacterAddressGroup(sld, "Marigo_church", "reload", "reload2_back");
	LAi_group_MoveCharacter(sld, "HOLLAND_CITIZENS");
}

void FMQN_HollandPeace() // за голландцев, мир
{
	sld = CharacterFromID("FMQN_monk");
	sld.lifeday = 0;
	for (int i=1; i<=5; i++)
	{
		sld = CharacterFromID("FMQN_seafox_"+i);
		sld.lifeday = 0;
	}
	LocatorReloadEnterDisable("Marigo_town", "reload1_back", true);
	LocatorReloadEnterDisable("Marigo_town", "reload2_back", true);
	LocatorReloadEnterDisable("Marigo_town", "gate_back", true);//закрыть выходы из города
	pchar.questTemp.FMQN = "hol_peace";
	AddQuestRecord("FMQ_Nevis", "13");
	SetFunctionTimerCondition("FMQN_HollandPeaceReward", 0, 0, 1, false);
}

void FMQN_HollandPeaceReward(string qName) // за голландцев, мир, награда
{
	pchar.questTemp.FMQN = "hol_peace_rew";
	AddSimpleRumourCity("British raiding party had come to our island yet our vigilant commandant found and slain them all. This is big!", "Marigo", 20, 2, "");
	AddSimpleRumourCity("Have you heard? There was a skirmish outside the town. They have found English raiding party. Brits refused to surrender and were killed in action. Good job, commandant!", "Marigo", 20, 2, "");
}

void FMQN_HollandPeaceComplete() // за голландцев, мир, завершение
{
	LocatorReloadEnterDisable("Marigo_town", "reload1_back", false);
	LocatorReloadEnterDisable("Marigo_town", "reload2_back", false);
	LocatorReloadEnterDisable("Marigo_town", "gate_back", false);
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	bDisableFastReload = false;//открыть переход
	DeleteAttribute(pchar, "GenQuest.SmugglersBlock");
	LAi_LocationFightDisable(&Locations[FindLocation("Marigo_Cave")], false);
	LAi_LocationDisableOfficersGen("Marigo_Cave", false);
	DeleteAttribute(pchar, "GenQuest.CannotWait");//можно мотать время
	for(i = 0; i < MAX_LOCATIONS; i++)
	{	
		sld = &Locations[i];
		if (CheckAttribute(sld, "islandId") && sld.islandId == "SentMartin")
		{
			sld.DisableEncounters = false;	
		}	
	}
	Group_DeleteGroup("FMQN_shipgroup");
	pchar.questTemp.FMQN = "end";
	FMQ_Count();
	AddQuestRecord("FMQ_Nevis", "14");
	CloseQuestHeader("FMQ_Nevis");
	ChangeCharacterNationReputation(pchar, HOLLAND, 5);
	AddCharacterExpToSkill(pchar, "Sneak", 200);
	AddCharacterExpToSkill(pchar, "Leadership", 100);
}

void FMQN_HollandBattle() // за голландцев, боевой
{
	sld = CharacterFromID("FMQN_monk");
	sld.lifeday = 0;
	pchar.questTemp.FMQN = "hol_battle";
	AddQuestRecord("FMQ_Nevis", "15");
	LocatorReloadEnterDisable("Marigo_ExitTown", "reload3", true);
	LocatorReloadEnterDisable("Marigo_ExitTown", "reload2_back", true);
	LocatorReloadEnterDisable("Marigo_jungle_01", "reload1_back", true);
	LocatorReloadEnterDisable("Marigo_jungle_01", "reload2_back", true);
	LocatorReloadEnterDisable("Marigo_jungle_01", "reload3_back", true);
	DoQuestReloadToLocation("Marigo_ExitTown", "reload", "reload3", "FMQN_HollandBattleRun");
}

void FMQN_HollandBattlePlan(string qName) // за голландцев, военный совет
{
	sld = CharacterFromID("FMQN_holland_0");
	sld.Dialog.currentnode = "hol_officer_2";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void FMQN_HollandBattleGovernor(string qName) // к губернатору
{
	pchar.questTemp.FMQN = "hol_battle_complete";
}

void FMQN_HollandBattleAdding(string qName) // солдаты спускаются по 1 с интервалом 10 сек
{
	sld = CharacterFromID("FMQN_holland_"+iTotalTemp);
	ChangeCharacterAddressGroup(sld, "Marigo_Cave", "reload", "reload2");
	iTotalTemp++;
	FMQN_HollandBattleAdding1();
}

void FMQN_HollandBattleAdding1() // китайская рекурсия
{
	if (iTotalTemp > 5) return;
	DoQuestCheckDelay("FMQN_HollandBattleAdding2", 10.0);
}

void FMQN_HollandBattleComplete() // за голландцев, боевой, завершение
{
	LocatorReloadEnterDisable("Marigo_town", "reload1_back", false);
	LocatorReloadEnterDisable("Marigo_town", "reload2_back", false);
	LocatorReloadEnterDisable("Marigo_town", "gate_back", false);
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	bDisableFastReload = false;//открыть переход
	DeleteAttribute(pchar, "GenQuest.SmugglersBlock");
	LAi_LocationDisableOfficersGen("Marigo_Cave", false);
	DeleteAttribute(pchar, "GenQuest.CannotWait");//можно мотать время
	for(i = 0; i < MAX_LOCATIONS; i++)
	{	
		sld = &Locations[i];
		if (CheckAttribute(sld, "islandId") && sld.islandId == "SentMartin")
		{
			sld.DisableEncounters = false;	
		}	
	}
	Group_DeleteGroup("FMQN_shipgroup");
	pchar.questTemp.FMQN = "end";
	FMQ_Count();
	AddQuestRecord("FMQ_Nevis", "17");
	CloseQuestHeader("FMQ_Nevis");
	AddMoneyToCharacter(pchar, 10000); 
	GiveNationLicence(HOLLAND, 180);
	ChangeCharacterNationReputation(pchar, HOLLAND, 15);
	ChangeCharacterNationReputation(pchar, ENGLAND, -15);
	ChangeCharacterComplexReputation(pchar, "fame", 2);
	AddCharacterExpToSkill(pchar, "Sneak", 200);
	AddCharacterExpToSkill(pchar, "Leadership", 200);
	AddCharacterExpToSkill(pchar, "Fortune", 200);
	AddComplexSelfExpToScill(50, 50, 50, 50);
	AddSimpleRumourCity("Oh, it's you! Bravo, captain! You were brave enough to face English spies armed to the teeth!", "Marigo", 20, 3, "");
	AddSimpleRumourCity("Our powers praise you highly, captain. And for reasons: helping to eliminate English spies is a big deal!", "Marigo", 20, 3, "");
	SetFunctionTimerCondition("FMQN_HollandSetHunters", 0, 0, 5, false);
}

void FMQN_HollandSetHunters(string qName) // перехватчик
{
	Map_NationQuestHunter(ENGLAND);
}

void FMQN_EnglandFail(string qName) // провал английского варианта
{
	for (int i=1; i<=5; i++)
	{
		sld = CharacterFromID("FMQN_seafox_"+i);
		sld.lifeday = 0;
		LAi_CharacterDisableDialog(sld);
	}
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	bDisableFastReload = false;//открыть переход
	DeleteAttribute(pchar, "GenQuest.SmugglersBlock");
	LAi_LocationFightDisable(&Locations[FindLocation("Marigo_Cave")], false);
	LAi_LocationDisableOfficersGen("Marigo_Cave", false);
	DeleteAttribute(pchar, "GenQuest.CannotWait");//можно мотать время
	for(i = 0; i < MAX_LOCATIONS; i++)
	{	
		sld = &Locations[i];
		if (CheckAttribute(sld, "islandId") && sld.islandId == "SentMartin")
		{
			sld.DisableEncounters = false;	
		}
	}
	sld = characterFromId("FMQN_Cap_Zeepard");
	sld.lifeday = 0;
	if (pchar.questTemp.FMQN == "way_eng_3") // провалил у попа
	{
		sld = CharacterFromID("FMQN_monk");
		sld.lifeday = 0;
		AddQuestRecord("FMQ_Nevis", "19");
	}
	if (pchar.questTemp.FMQN == "way_eng_4") // не дошел до пещеры к 20 часам
	{
		AddQuestRecord("FMQ_Nevis", "22");
	}
	if (pchar.questTemp.FMQN == "way_eng_5") // не встретил у ворот в 23 часа
	{
		AddQuestRecord("FMQ_Nevis", "23");
		pchar.quest.FMQN_to_prison.over = "yes";
	}
	CloseQuestHeader("FMQ_Nevis");
	pchar.questTemp.FMQN = "fail";
	AddSimpleRumourCity("Английский десант явился на наш остров, однако наш бдительный комендант не зевал, нашел всех негодяев и перебил. Вот так-то!", "Marigo", 20, 2, "");
	AddSimpleRumourCity("Слыхали? Была схватка за городом. Нашли английских диверсантов. Они отказались сдаться, и были перебиты солдатами. Молодец наш комендант!", "Marigo", 20, 2, "");
}

void FMQN_EnglandBattleFail(string qName) // тревога
{
	Log_Info("Alarm in the town!");
	PlaySound("VOICE\Russian\EvilPirates01.wav");
	LAi_group_SetHearRadius("HOLLAND_CITIZENS", 200);
	for (int i=1; i<=5; i++)
	{
		sld = CharacterFromID("FMQN_seafox_"+i);
		sld.lifeday = 0;
		LAi_CharacterDisableDialog(sld);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		LAi_SetImmortal(sld, false);
	}
	if (pchar.questTemp.FMQN == "way_eng_7") // после захода в тюрьму
	{
		for (i=5; i<=6; i++)
		{
			sld = CharacterFromID("FMQN_prisoner_"+i);
			sld.lifeday = 0;
			LAi_SetImmortal(sld, false);
		}
	}
	pchar.quest.FMQN_jail.over = "yes";
	pchar.quest.FMQN_jail1.over = "yes";
	pchar.quest.FMQN_Alarm.over = "yes";
	pchar.quest.FMQN_fail3.over = "yes";
	chrDisableReloadToLocation = false;
	pchar.quest.FMQN_fail_exit.win_condition.l1 = "ExitFromLocation";
	pchar.quest.FMQN_fail_exit.win_condition.l1.location = pchar.location;
	pchar.quest.FMQN_fail_exit.function = "FMQN_EnglandBattleFailExit";
}

void FMQN_EnglandBattleFailExit(string qName) // провал после тревоги
{
	LAi_group_SetHearRadius("HOLLAND_CITIZENS", LAI_GROUP_GRD_HEAR);
	LAi_LocationDisableOfficersGen("Marigo_Town", false);
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	bDisableFastReload = false;//открыть переход
	DeleteAttribute(pchar, "GenQuest.SmugglersBlock");
	LAi_LocationFightDisable(&Locations[FindLocation("Marigo_Cave")], false);
	LAi_LocationDisableOfficersGen("Marigo_Cave", false);
	DeleteAttribute(pchar, "GenQuest.CannotWait");//можно мотать время
	for(i = 0; i < MAX_LOCATIONS; i++)
	{	
		sld = &Locations[i];
		if (CheckAttribute(sld, "islandId") && sld.islandId == "SentMartin")
		{
			sld.DisableEncounters = false;	
		}
	}
	Group_DeleteGroup("FMQN_shipgroup");
	AddQuestRecord("FMQ_Nevis", "24");
	CloseQuestHeader("FMQ_Nevis");
	pchar.questTemp.FMQN = "fail";
	AddSimpleRumourCity("What insolence! The Brits infiltrated our town at night! And yet our commandant had them found and killed. Big deal!", "Marigo", 20, 2, "");
	AddSimpleRumourCity("Have you heard? There was a skirmish in the town. They have found English raiding party. Brits refused to surrender and were killed in action. Good job, commandant!", "Marigo", 20, 2, "");
}

void FMQN_EnglandMonkPlan(string qName) // монах все сделал
{
	sld = CharacterFromID("FMQN_monk");
	LAi_CharacterEnableDialog(sld);
	sld.dialog.currentnode = "monk_6";
}

void FMQN_EnglandPrepare() // готовимся к операции Ы
{
	AddQuestRecord("FMQ_Nevis", "21");
	DeleteAttribute(pchar, "GenQuest.CannotWait");
	pchar.quest.FMQN_to_prison.win_condition.l1 = "HardHour";
	pchar.quest.FMQN_to_prison.win_condition.l1.hour = 23.00;
	pchar.quest.FMQN_to_prison.win_condition.l2 = "location";
	pchar.quest.FMQN_to_prison.win_condition.l2.location = "Marigo_ExitTown";
	pchar.quest.FMQN_to_prison.function = "FMQN_EnglandGotoPrison";
	pchar.quest.FMQN_fail2.win_condition.l1 = "Timer";
	pchar.quest.FMQN_fail2.win_condition.l1.date.hour  = 0.0;
	pchar.quest.FMQN_fail2.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 1);
	pchar.quest.FMQN_fail2.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 1);
	pchar.quest.FMQN_fail2.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 1);
	pchar.quest.FMQN_fail2.function = "FMQN_EnglandFail";
	pchar.questTemp.FMQN = "way_eng_5";
}

void FMQN_EnglandGotoPrison(string qName) // пришли англичане к воротам
{
	pchar.quest.FMQN_fail2.over = "yes";
	chrDisableReloadToLocation = true;
	for (int i=1; i<=5; i++)
	{
		sld = CharacterFromID("FMQN_seafox_"+i);
		ChangeCharacterAddressGroup(sld, "Marigo_ExitTown", "reload", "reload1_back");
		LAi_CharacterDisableDialog(sld);
		if (i == 1)
		{
			LAi_CharacterEnableDialog(sld);
			sld.dialog.currentnode = "seafox_31";
		}
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void FMQN_EnglandReload(string qName) // релоад в город
{
	LAi_LocationDisableOfficersGen("Marigo_Town", true);
	DoQuestReloadToLocation("Marigo_town", "reload", "gate_back", "FMQN_EnglandSnake");
}

void FMQN_EnglandJail(string qName) // англичане - в тюрьму
{
	PlaySound("interface\notebook.wav");
	for (int i=1; i<=5; i++)
	{
		sld = CharacterFromID("FMQN_seafox_"+i);
		LAi_SetActorType(sld);
		LAi_ActorRunToLocation(sld, "reload", "reload_jail", "none", "", "", "FMQN_EnglandInJail", 7.0);
	}
	LAi_SetActorType(pchar);
	LAi_ActorGoToLocator(pchar, "goto", "goto21", "FMQN_EnglandJailTurn", -1);
}

void FMQN_EnglandReloadJungle(string qName) // релоад в джунгли
{
	DoQuestReloadToLocation("Marigo_exittown", "reload", "reload3", "FMQN_EnglandEscape");
	LAi_LocationDisableOfficersGen("Marigo_Town", false);
}

void FMQN_EnglandInShoreAttack(string qName) // рубилово в бухте
{
	bool bOk;
	if (pchar.location.from_sea == "shore40") bOk;
	else 
	{
		Log_Info("You didn't moor at the bay!");
		PlaySound("interface\notebook.wav");
	}
	PlaySound("interface\abordage_wining.wav");
	chrDisableReloadToLocation = true;
	for (int i=5; i<=6; i++) // пленные бегут
	{
		sld = CharacterFromID("FMQN_prisoner_"+i);
		LAi_SetActorType(sld);
		LAi_ActorRunToLocator(sld, "quest", "quest1", "", 20);
	}
	// активируем наших
	for (i=1; i<=5; i++)
	{
		sld = CharacterFromID("FMQN_seafox_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	// ставим отряд голландцев
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 20 + 2*sti(pchar.rank);
	LAi_group_Delete("EnemyFight");
	sld = GetCharacter(NPC_GenerateCharacter("FMQN_holland_0", "off_hol_5", "man", "man", iRank+5, HOLLAND, -1, false, "soldier"));
	FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_15", "pistol5", "bullet", iScl*4);
	sld.name = "Hans";
	sld.lastname = "Shulte";
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	ChangeCharacterAddressGroup(sld, "shore40", "goto", "goto10");
	for (i=1; i<=9; i++)
	{
		if (i > 7)
		{
			sld = GetCharacter(NPC_GenerateCharacter("FMQN_holland_"+i, "mush_hol_"+(i-4), "man", "mushketer", iRank, HOLLAND, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*3);
			sld.MusketerDistance = 0;
			ChangeCharacterAddressGroup(sld, "shore40", "goto", "goto"+(i+3));
		}
		else
		{
			if (i == 6 || i == 7)
			{
				if (MOD_SKILL_ENEMY_RATE < 6) continue;
			}
			sld = GetCharacter(NPC_GenerateCharacter("FMQN_holland_"+i, "sold_hol_1"+i, "man", "man", iRank, HOLLAND, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, LinkRandPhrase("blade_12","blade_09","blade_14"), "pistol1", "bullet", iScl*2);
			ChangeCharacterAddressGroup(sld, "shore40", "goto", "goto"+i);
		}
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
	}
	for (i=0; i<=9; i++)
	{
		if (i == 6 || i == 7)
		{
			if (MOD_SKILL_ENEMY_RATE < 6) continue;
		}
		sld = CharacterFromID("FMQN_holland_"+i);
		if (!bOk) LAi_SetCheckMinHP(sld, 10, true, "");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "FMQN_AfterShoreAttack");	
	LAi_SetFightMode(pchar, true);
}

void FMQN_EnglandSeaAttack(string qName) // атака в море
{
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");// Addon 2016-1 Jason пиратская линейка
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE-2;
	int iScl = 15 + 2*sti(pchar.rank);
	int iShipType = sti(RealShips[sti(pchar.ship.type)].basetype);
	if (iShipType < SHIP_BARKENTINE) iShipType = SHIP_BRIGANTINE; // для умников
	if (iShipType > SHIP_POLACRE) iShipType = SHIP_CORVETTE; // для особенных
	int iCannon = CANNON_TYPE_CULVERINE_LBS8;
	if (iShipType > SHIP_SLOOP && MOD_SKILL_ENEMY_RATE > 8) iCannon = CANNON_TYPE_CULVERINE_LBS18;
	Island_SetReloadEnableGlobal("SentMartin", false);//на остров нельзя
	Group_FindOrCreateGroup("FMQN_shoregroup");
	sld = GetCharacter(NPC_GenerateCharacter("FMQN_shorecap", "off_hol_4", "man", "man", iRank, HOLLAND, -1, false, "soldier"));
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_14", "pistol1", "bullet", iScl*2);
	FantomMakeSmallSailor(sld, iShipType, "", iCannon, iScl, iScl, iScl, iScl, iScl);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "war";
	sld.AlwaysEnemy = true;
	sld.Coastal_Captain = true;
	sld.ship.Crew.Morale = 30+MOD_SKILL_ENEMY_RATE*6;
	sld.Ship.Crew.Exp.Sailors = 30+MOD_SKILL_ENEMY_RATE*6;
	sld.Ship.Crew.Exp.Cannoners = 30+MOD_SKILL_ENEMY_RATE*6;
	sld.Ship.Crew.Exp.Soldiers = 30+MOD_SKILL_ENEMY_RATE*6;
	if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("FMQN_shoregroup", "FMQN_shorecap");
	Group_SetGroupCommander("FMQN_shoregroup", "FMQN_shorecap");
	Group_SetAddress("FMQN_shoregroup", "SentMartin", "quest_ships", "quest_ship_7");
	Group_SetTaskAttack("FMQN_shoregroup", PLAYER_GROUP);
	Group_LockTask("FMQN_shoregroup");
	pchar.quest.FMQN_AfterSeaBattle.win_condition.l1 = "Group_Death";
	pchar.quest.FMQN_AfterSeaBattle.win_condition.l1.group = "FMQN_shoregroup";
	pchar.quest.FMQN_AfterSeaBattle.function = "FMQN_EnglandAfterSeaBattle";
	for (i=5; i<=6; i++)
	{
		sld = CharacterFromID("FMQN_prisoner_"+i);
		ChangeCharacterAddressGroup(sld, "none", "", "");
	}
}

void FMQN_EnglandAfterSeaBattle(string qName) // после морского боя
{
	Group_DeleteGroup("FMQN_shoregroup");
	bQuestDisableMapEnter = false;//открыть карту
	bDisableFastReload = false;//открыть переход
	DeleteAttribute(pchar, "GenQuest.SmugglersBlock");
	LAi_LocationFightDisable(&Locations[FindLocation("Marigo_Cave")], false);
	LAi_LocationDisableOfficersGen("Marigo_Cave", false);
	DeleteAttribute(pchar, "GenQuest.CannotWait");//можно мотать время
	for(i = 0; i < MAX_LOCATIONS; i++)
	{	
		sld = &Locations[i];
		if (CheckAttribute(sld, "islandId") && sld.islandId == "SentMartin")
		{
			sld.DisableEncounters = false;	
		}	
	}
	LocatorReloadEnterDisable("Marigo_ExitTown", "reload3", false);
	LocatorReloadEnterDisable("Marigo_ExitTown", "reload2_back", false);
	LocatorReloadEnterDisable("Marigo_jungle_01", "reload1_back", false);
	LocatorReloadEnterDisable("Marigo_jungle_01", "reload3_back", false);
	LocatorReloadEnterDisable("Marigo_jungle_02", "reload1_back", false);
	LocatorReloadEnterDisable("Marigo_jungle_02", "reload3_back", false);
	LocatorReloadEnterDisable("Marigo_jungle_02", "reloadW_back", false);
	LocatorReloadEnterDisable("shore40", "reload1_back", false);
	// подгружаем Зеепард
	Group_FindOrCreateGroup("FMQN_shipgroup");
	sld = characterFromId("FMQN_Cap_Zeepard");
	DeleteAttribute(sld, "ShipEnemyDisable");
	LAi_SetImmortal(sld, false);
	sld.AlwaysEnemy = true;
	Group_AddCharacter("FMQN_shipgroup", "FMQN_Cap_Zeepard");
	Group_SetGroupCommander("FMQN_shipgroup", "FMQN_Cap_Zeepard");
	Group_SetAddress("FMQN_shipgroup", "SentMartin", "", "");
	Group_SetTaskAttack("FMQN_shipgroup", PLAYER_GROUP);
	Sea_LoginGroupCurrentSea("FMQN_shipgroup");
	Log_Info("The Zeepard corvette is on us!");
	// через 3 дня откроем остров
	SetFunctionTimerCondition("FMQN_EnglandOpenSintMaarten", 0, 0, 3, false);
	// НЗГ
	ChangeCharacterHunterScore(pchar, "holhunter", 15);
	pchar.quest.FMQN_eng_complete.win_condition.l1 = "location";
	pchar.quest.FMQN_eng_complete.win_condition.l1.location = "SentJons_town";
	pchar.quest.FMQN_eng_complete.function = "FMQN_EnglandOnAntigua";
	AddQuestRecord("FMQ_Nevis", "27");
	SetFunctionTimerCondition("FMQN_EnglandAntiguaLate", 0, 0, 20, false);
	AddSimpleRumourCity("Have you heard about the mess happening here? The governor is outraged. English spies have freed their countrymen from our prison! They say some French had something to do with this.", "Marigo", 20, 2, "");
	AddSimpleRumourCity("Have you heard?? The governor is outraged. English spies have freed their countrymen from our prison! They say some French had something to do with this.", "Marigo", 20, 2, "");
}

void FMQN_EnglandOpenSintMaarten(string qName) // открываем Синт-Маартен
{
	Group_DeleteGroup("FMQN_shipgroup");
	if (GetCharacterIndex("FMQN_Cap_Zeepard") != -1) 
	{
		sld = CharacterFromID("FMQN_Cap_Zeepard");
		sld.lifeday = 0;
	}
	Island_SetReloadEnableGlobal("SentMartin", true);
}

void FMQN_EnglandAntiguaLate(string qName) // вез-вез и не довез
{
	pchar.quest.FMQN_LateFinal.win_condition.l1 = "Location_Type";
	pchar.quest.FMQN_LateFinal.win_condition.l1.location_type = "town";
	pchar.quest.FMQN_LateFinal.function = "FMQN_EnglandAntiguaLateFinal";
}

void FMQN_EnglandAntiguaLateFinal(string qName) // вез-вез и не довез за 20 дней
{
	if (pchar.location == "SentJons_town") return;
	pchar.quest.FMQN_eng_complete.over = "yes";
	for (int i=5; i<=6; i++)
	{
		sld = CharacterFromID("FMQN_prisoner_"+i);
		RemovePassenger(pchar, sld);
		sld.lifeday = 0;
	}
	if (pchar.questTemp.FMQN == "caspar_alive")
	{
		sld = CharacterFromID("FMQN_seafox_1");
		RemovePassenger(pchar, sld);
		sld.lifeday = 0;
	}
	pchar.questTemp.FMQN = "fail";
	AddQuestRecord("FMQ_Nevis", "30");
	CloseQuestHeader("FMQ_Nevis");
}

void FMQN_EnglandOnAntigua(string qName) // на Антигуа
{
	pchar.quest.FMQN_EnglandAntiguaLate.over = "yes";
	pchar.quest.FMQN_LateFinal.over = "yes";
	pchar.GenQuest.Hunter2Pause = true; 
	LocatorReloadEnterDisable("SentJons_town", "reload1_back", true);
	LocatorReloadEnterDisable("SentJons_town", "reload2_back", true);
	LocatorReloadEnterDisable("SentJons_town", "gate_back", true);//закрыть выходы из города
	pchar.GenQuest.CannotWait = true;
	for (int i=5; i<=6; i++)
	{
		sld = CharacterFromID("FMQN_prisoner_"+i);
		RemovePassenger(pchar, sld);
		sld.lifeday = 1;
	}
	if (pchar.questTemp.FMQN == "caspar_alive")
	{
		sld = CharacterFromID("FMQN_seafox_1");
		RemovePassenger(pchar, sld);
		sld.dialog.currentnode = "seafox_35";
		sld.model = "quest_off_eng";
		Characters_RefreshModel(sld);
		LAi_CharacterEnableDialog(sld);
		ChangeCharacterAddressGroup(sld, "SentJons_town", "quest", "quest1");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
	else
	{
		sld = CharacterFromID("FMQN_prisoner_5");
		sld.Dialog.Filename = "Quest\LineMiniQuests\FMQ_Nevis.c";
		sld.dialog.currentnode = "seafox_35x";
		LAi_CharacterEnableDialog(sld);
		ChangeCharacterAddressGroup(sld, "SentJons_town", "quest", "quest1");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void FMQN_EnglandReward(string qName) // Фокс ждет
{
	pchar.questTemp.FMQN = "eng_reward";
}

void FMQN_EnglandComplete() // за Англию завершение
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	// награда оружием
	switch (pchar.HeroParam.HeroType)
	{        
		case "HeroType_1": 
			GiveItem2Character(pchar, "blade_15");
			Log_Info("You have received Marinera");
		break;
		
		case "HeroType_2":
			GiveItem2Character(pchar, "blade_10");
			Log_Info("You have received Cord");
		break;
		
		case "HeroType_3":
			GiveItem2Character(pchar, "blade_13");
			Log_Info("You have received Officer Broadsword");
		break;
		
		case "HeroType_4":
			GiveItem2Character(pchar, "blade_15");
			Log_Info("You have received Marinera");
		break;
	}
	LocatorReloadEnterDisable("SentJons_town", "reload1_back", false);
	LocatorReloadEnterDisable("SentJons_town", "reload2_back", false);
	LocatorReloadEnterDisable("SentJons_town", "gate_back", false);
	DeleteAttribute(pchar, "GenQuest.CannotWait");
	pchar.questTemp.FMQN = "end";
	FMQ_Count();
	AddQuestRecord("FMQ_Nevis", "29");
	CloseQuestHeader("FMQ_Nevis");
	AddMoneyToCharacter(pchar, 30000); 
	GiveItem2Character(pchar, "mushket3");
	Log_Info("You have received an arquebuse");
	PlaySound("interface\important_item.wav");
	ChangeCharacterNationReputation(pchar, ENGLAND, 20);
	ChangeCharacterComplexReputation(pchar, "nobility", 5);
	ChangeCharacterComplexReputation(pchar, "authority", 3);
	ChangeCharacterComplexReputation(pchar, "fame", 3);
	ChangeOfficersLoyality("good_all", 1);
	AddCharacterExpToSkill(pchar, "Sneak", 200);
	AddCharacterExpToSkill(pchar, "Leadership", 200);
	AddCharacterExpToSkill(pchar, "Fortune", 200);
	AddComplexSelfExpToScill(50, 50, 50, 50);
	AddSimpleRumourCity("Oh, it's you! Bravo, captain! You were brave enough to assist our marines right in the Dutch den!", "SentJons", 20, 3, "");
	AddSimpleRumourCity("The governor praise you highly, captain. And for reasons: helping Fox's men to save the imprisoned officers is a big deal!", "SentJons", 20, 3, "");
}

// --> ФМК-Тортуга
void FMQT_Activation(string qName) // 
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	if (CheckAttribute(pchar, "questTemp.HWIC") || sti(pchar.rank) > 12) return;
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	sld = GetCharacter(NPC_GenerateCharacter("FMQT_girl", "women_11", "woman", "towngirl", 5, FRANCE, -1, false, "quest"));
	SetFantomParamFromRank(sld, 5, true);
	sld.Dialog.Filename = "Quest\LineMiniQuests\FMQ_Tortuga.c";
	if (sti(pchar.reputation.nobility) > 41) sld.Dialog.currentnode = "girl";
	else sld.Dialog.currentnode = "girl_5";
	RemoveAllCharacterItems(sld, true);
	ChangeCharacterAddressGroup(sld, "Tortuga_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	// запираем сундук Левассера и заполним его
	ref rLoc = &Locations[FindLocation("Tortuga_townhallRoom")];
	rLoc.private2.key = "crowbar";
	rLoc.private2.key.delItem = true;
	rLoc.private2.money = 10000;
	rLoc.private2.items.jewelry2 = 200;
	rLoc.private2.items.cannabis7 = 1;
	rLoc.private2.items.indian_7 = 1;
	rLoc.private2.items.indian_8 = 1;
	rLoc.private2.items.amulet_6 = 1;
	rLoc.private2.items.amulet_10 = 1;
	rLoc.private2.items.obereg_9 = 1;
}

void FMQT_ClearChest() // 
{
	ref rLoc = &Locations[FindLocation("Tortuga_townhallRoom")];
	DeleteAttribute(rLoc, "private2.key");
	DeleteAttribute(rLoc, "private2.key.delItem");
	DeleteAttribute(rLoc, "private2.money");
	DeleteAttribute(rLoc, "private2.items");
	DeleteAttribute(pchar, "questTemp.FMQT.Open");
	DeleteAttribute(pchar, "questTemp.FMQT.Common");
}

void FMQT_Begin() // 
{
	chrDisableReloadToLocation = false;
	string sLoc = "CommonBedroom";
	if (pchar.questTemp.FMQT == "begin_serveroom") sLoc = "CommonResidence_4";
	pchar.quest.FMQT_start.win_condition.l1 = "location";
	pchar.quest.FMQT_start.win_condition.l1.location = sLoc;
	pchar.quest.FMQT_start.win_condition.l2 = "HardHour";
	pchar.quest.FMQT_start.win_condition.l2.hour = 18.00;
	pchar.quest.FMQT_start.function = "FMQT_WifeMeeting";
	pchar.quest.FMQT_late.win_condition.l1 = "Timer";
	pchar.quest.FMQT_late.win_condition.l1.date.hour  = 20.0;
	pchar.quest.FMQT_late.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 0);
	pchar.quest.FMQT_late.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 0);
	pchar.quest.FMQT_late.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 0);
	pchar.quest.FMQT_late.function = "FMQT_Late";
	pchar.questTemp.FMQT.Common = "true";
}

void FMQT_Late(string qName) // 
{
	pchar.quest.FMQT_start.over = "yes";
	pchar.questTemp.FMQT = "fail";
	AddQuestRecord("FMQ_Tortuga", "3");
	CloseQuestHeader("FMQ_Tortuga");
	FMQT_ClearChest();
}

void FMQT_WifeMeeting(string qName) // 
{
	pchar.quest.FMQT_late.over = "yes";
	chrDisableReloadToLocation = true;
	sld = GetCharacter(NPC_GenerateCharacter("FMQT_wife", "Levaser_Wife", "woman", "towngirl", 5, FRANCE, -1, false, "quest"));
	SetFantomParamFromRank(sld, 5, true);
	sld.name = "Marceline";
	sld.lastname = "Levasseur";
	sld.Dialog.Filename = "Quest\LineMiniQuests\FMQ_Tortuga.c";
	if (pchar.questTemp.FMQT == "begin_serveroom") sld.Dialog.currentnode = "wife";
	else sld.Dialog.currentnode = "wife_8";
	RemoveAllCharacterItems(sld, true);
	LAi_SetImmortal(sld, true);
	LAi_SetLoginTime(sld, 6.0, 20.0);
	ChangeCharacterAddressGroup(sld, pchar.location, "barmen", "stay");
	LAi_SetOwnerType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
}

void FMQT_HuberTime(string qName) // 
{
	pchar.questTemp.FMQT = "fail";
	AddQuestRecord("FMQ_Tortuga", "5");
	CloseQuestHeader("FMQ_Tortuga");
	FMQT_ClearChest();
}

void FMQT_TavernTime(string qName) // 
{
	pchar.questTemp.FMQT = "fail";
	AddQuestRecord("FMQ_Tortuga", "8");
	CloseQuestHeader("FMQ_Tortuga");
	FMQT_ClearChest();
}

void FMQT_KeyTime(string qName) // 
{
	ChangeItemDescribe("kaleuche_key", "itmdescr_kaleuche_key");
	sld = CharacterFromID("FMQT_wife");
	sld.lifeday = 0;
	if (CheckCharacterItem(pchar, "kaleuche_key")) // не вскрывал сундук
	{
		RemoveItems(pchar, "kaleuche_key", 1);
		AddQuestRecord("FMQ_Tortuga", "12");
		pchar.questTemp.FMQT = "fail";
	}
	else 
	{
		AddQuestRecord("FMQ_Tortuga", "13");
		ChangeCharacterHunterScore(PChar, "frahunter", 30);
		pchar.questTemp.FMQT = "end";
		FMQ_Count();
	}
	CloseQuestHeader("FMQ_Tortuga");
	FMQT_ClearChest();
}

void FMQT_KeyNextDay() // 
{
	pchar.quest.FMQT_next_day.win_condition.l1 = "Timer";
	pchar.quest.FMQT_next_day.win_condition.l1.date.hour  = 6.0;
	pchar.quest.FMQT_next_day.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 1);
	pchar.quest.FMQT_next_day.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 1);
	pchar.quest.FMQT_next_day.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 1);
	pchar.quest.FMQT_next_day.function = "FMQT_PlaceWife";
	pchar.quest.FMQT_late3.win_condition.l1 = "Timer";
	pchar.quest.FMQT_late3.win_condition.l1.date.hour  = sti(GetTime());
	pchar.quest.FMQT_late3.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 1);
	pchar.quest.FMQT_late3.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 1);
	pchar.quest.FMQT_late3.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 1);
	pchar.quest.FMQT_late3.function = "FMQT_KeyTime";
}

void FMQT_PlaceWife(string qName) // ставим жену Левассера в будуар 
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	sld = CharacterFromID("FMQT_wife");
	LAi_CharacterEnableDialog(sld);
	sld.Dialog.currentnode = "wife_15";
	LAi_SetStayType(sld);
	ChangeCharacterAddressGroup(sld, "CommonBedroom", "barmen", "stay");
}

void FMQT_Deceive() // 
{
	sld = CharacterFromID("FMQT_wife");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload1", "none", "", "", "", 5.0);
	chrDisableReloadToLocation = false;
	pchar.quest.FMQT_deceive_fin.win_condition.l1 = "Timer";
	pchar.quest.FMQT_deceive_fin.win_condition.l1.date.hour  = 18.0;
	pchar.quest.FMQT_deceive_fin.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 1);
	pchar.quest.FMQT_deceive_fin.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 1);
	pchar.quest.FMQT_deceive_fin.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 1);
	pchar.quest.FMQT_deceive_fin.function = "FMQT_DeceiveFinal";
	AddQuestRecord("FMQ_Tortuga", "16");
	FMQT_ClearChest();
}

void FMQT_DeceiveFinal(string qName) // провальный финал - прогоняют
{
	sld = CharacterFromID("FMQT_wife");
	LAi_CharacterEnableDialog(sld);
	sld.Dialog.currentnode = "wife_27";
	LAi_SetStayType(sld);
	ChangeCharacterAddressGroup(sld, "CommonBedroom", "barmen", "stay");
}

void FMQT_MercenEnter(string qName) // входит наемник 
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	pchar.questTemp.FMQT = "chest_open";
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], false);
	LAi_group_Delete("EnemyFight");
	sld = GetCharacter(NPC_GenerateCharacter("FMQT_mercen", "Claude_Durand", "man", "man", 1, FRANCE, -1, false, "soldier"));
	sld.name = "Clod";
	sld.lastname = "Duran";
	sld.Dialog.Filename = "Quest\LineMiniQuests\FMQ_Tortuga.c";
	sld.Dialog.currentnode = "mercen";
	sld.rank = 15;
	sld.reputation = 25;
	sld.alignment = "bad";
	LAi_SetHP(sld, 180, 180);
	SetSelfSkill(sld, 45, 50, 45, 45, 35);
	SetShipSkill(sld, 25, 10, 20, 20, 20, 20, 20, 20, 30);
	SetSPECIAL(sld, 8, 5, 8, 4, 6, 8, 5);
	SetCharacterPerk(sld, "Energaiser");
	SetCharacterPerk(sld, "BasicDefense");
	SetCharacterPerk(sld, "AdvancedDefense");
	SetCharacterPerk(sld, "CriticalHit");
	if (MOD_SKILL_ENEMY_RATE > 2)
	{
		SetCharacterPerk(sld, "Sliding");
		sld.cirassId = Items_FindItemIdx("cirass1");
		sld.MultiFighter = 1.5;
		sld.MultiShooter = 2.0;
	}
	SetCharacterPerk(sld, "Gunman");
	SetCharacterPerk(sld, "Tireless");
	sld.SuperShooter = true;
	EquipCharacterByArtefact(sld, "indian_1");
	EquipCharacterByArtefact(sld, "indian_7");
	EquipCharacterByArtefact(sld, "indian_4");
	GiveItem2Character(sld, "blade_12");
	sld.equip.blade = "blade_12";
	GiveItem2Character(sld, "pistol1");
	EquipCharacterbyItem(sld, "pistol1");
	LAi_SetCharacterUseBullet(sld, "bullet");
    TakeNItems(sld, "bullet", 20);
	AddItems(sld, "gunpowder", 20);
	int i = makeint(MOD_SKILL_ENEMY_RATE/3);
	int n = 1+i;
	TakeNItems(sld, "potion1", n);
	TakeNItems(sld, "potion2", i);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	ChangeCharacterAddressGroup(sld, "Tortuga_townhallRoom", "reload", "reload1");
	LAi_SetCheckMinHP(sld, 20, true, "FMQT_MercenTalk");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	// таймер сутки на отдачу
	SetFunctionTimerCondition("FMQT_GemsTimeOver", 0, 0, 1, false);
}

void FMQT_GemsTimeOver(string qName) // не отдал камни
{
	sld = CharacterFromID("FMQT_wife");
	sld.lifeday = 0;
	ChangeCharacterAddressGroup(sld, "none", "", "");
	AddQuestRecord("FMQ_Tortuga", "13");
	ChangeCharacterHunterScore(PChar, "frahunter", 30);
	pchar.questTemp.FMQT = "end";
	FMQ_Count();
	CloseQuestHeader("FMQ_Tortuga");
	FMQT_ClearChest();
}

void FMQT_WifeFinalTalk() // 
{
	sld = CharacterFromID("FMQT_wife");
	LAi_CharacterEnableDialog(sld);
	if (CheckAttribute(pchar, "questTemp.FMQT.Roomfight")) sld.Dialog.currentnode = "wife_21";
	else sld.Dialog.currentnode = "wife_21x";
}

void FMQT_MercenAttackRoom(string qName) // 
{
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], false);
	LAi_group_Delete("EnemyFight");
	sld = CharacterFromID("FMQT_mercen");
	LAi_SetImmortal(sld, false);
	ChangeCharacterAddressGroup(sld, "CommonBedroom", "reload", "reload1");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "FMQT_MercenDieInRoom");
	sld = CharacterFromID("FMQT_wife");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "reload1", "none", "", "", "", 5.0);
}

void FMQT_FinalNoJewelry() // 
{
	sld = CharacterFromID("FMQT_wife");
	LAi_CharacterDisableDialog(sld);
	sld.lifeday = 0;
	chrDisableReloadToLocation = false;
	pchar.questTemp.FMQT = "end";
	FMQ_Count();
	AddQuestRecord("FMQ_Tortuga", "20");
	CloseQuestHeader("FMQ_Tortuga");
	FMQT_ClearChest();
	ChangeCharacterHunterScore(PChar, "frahunter", 10);
}

void FMQT_FinalNoSex() // 
{
	sld = CharacterFromID("FMQT_wife");
	LAi_CharacterDisableDialog(sld);
	sld.lifeday = 0;
	chrDisableReloadToLocation = false;
	pchar.questTemp.FMQT = "end";
	FMQ_Count();
	AddQuestRecord("FMQ_Tortuga", "21");
	CloseQuestHeader("FMQ_Tortuga");
	FMQT_ClearChest();
	AddCharacterExpToSkill(pchar, "Leadership", 300);//авторитет
	AddCharacterExpToSkill(pchar, "Fortune", 100);//везение
	AddCharacterExpToSkill(pchar, "Sneak", 100);//скрытность
}

void FMQT_FinalWithSex() // 
{
	WaitDate("", 0, 0, 0, 2, 10); //крутим время
	RecalculateJumpTable();
	sld = CharacterFromID("FMQT_wife");
	sld.lifeday = 0;
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload1", "none", "", "", "", 10.0);
	if (CheckAttribute(pchar, "questTemp.FMQT.Caution")) // заполним сундук бабы
	{
		AddQuestRecord("FMQ_Tortuga", "24");
		DeleteAttribute(pchar, "questTemp.FMQT.Caution");
		pchar.GenQuestBox.CommonBedroom = true;
		pchar.GenQuestBox.CommonBedroom.box1.money = 5000;
		pchar.GenQuestBox.CommonBedroom.box1.items.gold_dublon = 50;
		pchar.GenQuestBox.CommonBedroom.box1.items.totem_03 = 1;
		pchar.GenQuestBox.CommonBedroom.box1.items.potionwine = 3;
		pchar.GenQuestBox.CommonBedroom.box1.items.jewelry42 = 1;
		pchar.GenQuestBox.CommonBedroom.box1.items.jewelry43 = 1;
		pchar.GenQuestBox.CommonBedroom.box1.items.jewelry41 = 2;
		pchar.GenQuestBox.CommonBedroom.box1.items.jewelry40 = 1;
		pchar.GenQuestBox.CommonBedroom.box1.items.jewelry45 = 1;
		pchar.GenQuestBox.CommonBedroom.box1.items.jewelry46 = 2;
		pchar.GenQuestBox.CommonBedroom.box1.items.amulet_7 = 1;
		pchar.GenQuestBox.CommonBedroom.box1.items.amulet_2 = 1;
		pchar.GenQuestBox.CommonBedroom.box1.items.amulet_3 = 1;
		SetFunctionTimerCondition("FMQT_ClearWifeChest", 0, 0, 1, false);
		AddCharacterExpToSkill(pchar, "Fortune", 100);//везение
		AddCharacterExpToSkill(pchar, "Sneak", 100);//скрытность
	}
	else
	{
		// шарим по карманам ГГ
		if (sti(Pchar.money) >= 50000) Pchar.money = sti(Pchar.money)-25000;
		else Pchar.money = sti(Pchar.money)/2;
		AddQuestRecord("FMQ_Tortuga", "22");
	}
	chrDisableReloadToLocation = false;
	pchar.questTemp.FMQT = "end";
	FMQ_Count();
	CloseQuestHeader("FMQ_Tortuga");
	FMQT_ClearChest();
	AddCharacterExpToSkill(pchar, "Leadership", 400);//авторитет
	AddCharacterExpToSkill(pchar, "Fortune", 100);//везение
	AddCharacterExpToSkill(pchar, "Sneak", 100);//скрытность
}

void FMQT_ClearWifeChest(string qName) // 
{
	DeleteAttribute(pchar, "GenQuestBox.CommonBedroom");
}

// --> ФМК-Порт Пренс
void FMQP_Activation(string qName) // 
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	if (CheckAttribute(pchar, "questTemp.HWIC") || sti(pchar.rank) > 12 || pchar.Ship.Type == SHIP_NOTUSED) return;
	pchar.quest.FMQP_begin.win_condition.l1 = "location";
	pchar.quest.FMQP_begin.win_condition.l1.location = "PortPax_tavern";
	pchar.quest.FMQP_begin.win_condition.l2 = "Hour";
	pchar.quest.FMQP_begin.win_condition.l2.start.hour = 8.00;
	pchar.quest.FMQP_begin.win_condition.l2.finish.hour = 20.00;
	pchar.quest.FMQP_begin.function = "FMQP_Begin";
}

void FMQP_Begin(string qName) // 
{
	pchar.questTemp.FMQP = "begin";
	chrDisableReloadToLocation = true;
	sld = CharacterFromID("PortPax_waitress");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	// приведем в порядок плантацию Порто-Белло без НИ
	ref loc = &Locations[FindLocation("PortoBello_Plantation")];
	loc.reload.l1.name = "reload2_back";
	loc.reload.l1.go = "PortoBello_ExitTown";
	loc.reload.l1.emerge = "reload2";
	loc.reload.l1.autoreload = "1";
	loc.reload.l1.label = "ExitTown";
	loc.locators_radius.reload.reload2_back = 2.5;
	loc = &Locations[FindLocation("PortoBello_ExitTown")];
	loc.reload.l2.emerge = "reload2";
	loc.reload.l2.autoreload = "1";
}

void FMQP_Remove(string qName) // 
{
	DeleteAttribute(pchar, "questTemp.FMQP");
	sld = CharacterFromID("PortPax_waitress");
	LAi_SetWaitressType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	LocatorReloadEnterDisable("Portpax_town", "reload4_back", false);
}

void FMQP_InRoom(string qName) // 
{
	DoQuestReloadToLocation("Portpax_tavern_upstairs", "quest", "quest4", "FMQP_InRoom");
}

void FMQP_SantoDomingoOver(string qName) // 
{
	pchar.quest.FMQP_sdm.over = "yes";
	pchar.questTemp.FMQP = "fail";
	AddQuestRecord("FMQ_Portpax", "2");
	CloseQuestHeader("FMQ_Portpax");
	LocatorReloadEnterDisable("Santodomingo_town", "houseSp4", true);
	DeleteAttribute(pchar, "GenQuestRandItem.CommonPirateHouse");
	ChangeItemDescribe("letter_parol", "itmdescr_letter_parol");
}

void FMQP_InSantoDomingo(string qName) // 
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	LocatorReloadEnterDisable("Santodomingo_town", "houseSp4", false);
	pchar.questTemp.FMQP = "sdm";
	// ставим засаду в коммон
	int iRank = MOD_SKILL_ENEMY_RATE+sti(pchar.rank)-2;// Addon 2016-1 Jason пиратская линейка
	int iScl = 15 + 2*sti(pchar.rank);
	sld = GetCharacter(NPC_GenerateCharacter("FMQP_Ugo", "citiz_19", "man", "man", iRank, PIRATE, 2, false, "soldier"));
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_05","blade_07"), "pistol1", "bullet", iScl*2);
	sld.name = "Ugo";
	sld.lastname = "";
	ChangeCharacterAddressGroup(sld, "CommonPirateHouse", "goto", "goto6");
	sld.Dialog.Filename = "Quest\LineMiniQuests\FMQ_PortPax.c";
	sld.Dialog.currentnode = "ugo";
	LAi_SetImmortal(sld, true);
	LAi_SetStayType(sld);
	sld.talker = 9;
	// записку
	sld = ItemsFromID("letter_parol");
	ChangeItemDescribe("letter_parol", "itmdescr_letter_parol_FMQP");
	sld.model = "letter";
	pchar.GenQuestRandItem.CommonPirateHouse = true;
	pchar.GenQuestRandItem.CommonPirateHouse.randitem2 = "letter_parol";
}

void FMQP_SantoDomingoFight(string qName) // 
{
	chrDisableReloadToLocation = true;
	int iRank = MOD_SKILL_ENEMY_RATE+sti(pchar.rank)-2;// Addon 2016-1 Jason пиратская линейка
	int iScl = 10 + 2*sti(pchar.rank);
	LAi_group_Delete("EnemyFight");
	sld = CharacterFromID("FMQP_Ugo");
	LAi_SetImmortal(sld, false);
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	for (int i=3; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("FMQP_bandos_"+i, "citiz_2"+i, "man", "man", iRank, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_05","blade_07"), "pistol1", "bullet", iScl*2);
		ChangeCharacterAddressGroup(sld, "CommonPirateHouse", "goto", "goto"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "FMQP_SantoDomingoAfterFight");
	LAi_SetFightMode(pchar, true);
	// кладем настоящего Уго
	sld = GetCharacter(NPC_GenerateCharacter("FMQP_Ugo_x", "citiz_19", "man", "man", 5, PIRATE, 1, false, "soldier"));
	SetFantomParamFromRank(sld, 5, true);
	RemoveAllCharacterItems(sld, true);
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	ChangeCharacterAddressGroup(sld, "CommonPirateHouse", "sit", "sit1");
	LAi_SetSitType(sld);
	LAi_KillCharacter(sld);
}

void FMQP_FindLetter(string qName) // 
{
	AddQuestRecord("FMQ_Portpax", "4");
	DoQuestFunctionDelay("FMQP_DomingoEnter", 5.0);
}

void FMQP_DomingoEnter(string qName) // 
{
	sld = CharacterFromID("FMQP_noble");
	sld.Dialog.currentnode = "noble_5";
	ChangeCharacterAddressGroup(sld, "CommonPirateHouse", "reload", "reload1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void FMQP_OnBoard(string qName) // 
{
	DoQuestReloadToLocation("Santodomingo_tavern", "tables", "stay1", "FMQP_OnBoard");
}

void FMQP_SetRaiders(string qName) // 
{
	int iRank = MOD_SKILL_ENEMY_RATE+sti(pchar.rank);// Addon 2016-1 Jason пиратская линейка
	int iScl = 10 + 2*sti(pchar.rank);
	int iShipType = sti(RealShips[sti(pchar.ship.type)].basetype);
	if (iShipType < SHIP_BARKENTINE) iShipType = SHIP_BRIGANTINE; // для умников
	if (iShipType > SHIP_POLACRE) iShipType = SHIP_CORVETTE; // для умников
	int iCannon = CANNON_TYPE_CULVERINE_LBS8;
	if (iShipType > SHIP_SLOOP && MOD_SKILL_ENEMY_RATE > 4) iCannon = CANNON_TYPE_CANNON_LBS16;
	string sGroup = "FMQP_SeaGroup";
	Group_FindOrCreateGroup(sGroup);
	sld = GetCharacter(NPC_GenerateCharacter("FMQP_Follower", "mercen_23", "man", "man", iRank, SPAIN, 50, true, "quest"));
	FantomMakeSmallSailor(sld, iShipType, "", iCannon, iScl, iScl, iScl, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_06", "pistol1", "bullet", 150);
	sld.Ship.Mode = "pirate";	
	DeleteAttribute(sld, "SinkTenPercent");
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.AlwaysSandbankManeuver = true;
	sld.AnalizeShips = true;
	sld.DontRansackCaptain = true;
	sld.WatchFort = true;
	sld.AlwaysEnemy = true;
	sld.Coastal_Captain = true;
	SetCharacterPerk(sld, "SwordplayProfessional");
	SetCharacterPerk(sld, "AdvancedDefense");
	SetCharacterPerk(sld, "CriticalHit");
	SetCharacterPerk(sld, "MusketsShoot");
	SetCharacterPerk(sld, "HardHitter");
	sld.ship.Crew.Morale = 40+5*MOD_SKILL_ENEMY_RATE;
	ChangeCrewExp(sld, "Sailors", 40+5*MOD_SKILL_ENEMY_RATE);
	ChangeCrewExp(sld, "Cannoners", 40+5*MOD_SKILL_ENEMY_RATE);
	ChangeCrewExp(sld, "Soldiers", 40+5*MOD_SKILL_ENEMY_RATE);
	Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
	Group_LockTask(sGroup);
	Group_AddCharacter(sGroup, sld.id);
	Group_SetGroupCommander(sGroup, sld.id);
	sld.mapEnc.type = "war";
	sld.mapEnc.worldMapShip = "Galleon_red";
    sld.mapEnc.Name = "interceptor";
	Map_CreateCoolWarrior("", sld.id, 50);
}

void FMQP_PortobelloTimeOver(string qName) // 
{
	pchar.questTemp.FMQP = "time_over";
	SetFunctionTimerCondition("FMQP_PortobelloFail", 0, 0, 10, false);
}

void FMQP_PortobelloFail(string qName) // 
{
	pchar.quest.FMQP_Plantation.over = "yes"; 
	pchar.quest.FMQP_Portobello_Fail.win_condition.l1 = "Location_Type";
	pchar.quest.FMQP_Portobello_Fail.win_condition.l1.location_type = "town";
	pchar.quest.FMQP_Portobello_Fail.function = "FMQP_PortobelloClear";
}

void FMQP_PortobelloClear(string qName) // 
{
	sld = CharacterFromID("FMQP_noble");
	RemovePassenger(pchar, sld);
	pchar.questTemp.FMQP = "fail";
	AddQuestRecord("FMQ_Portpax", "6");
	CloseQuestHeader("FMQ_Portpax");
	Log_Info("Domingo Albalate has left your ship");
}

void FMQP_OnPlantation(string qName) // 
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	chrDisableReloadToLocation = true;
	pchar.quest.FMQP_PortobelloTimeOver.over = "yes"; 
	pchar.quest.FMQP_PortobelloFail.over = "yes"; 
	LocatorReloadEnterDisable("PortoBello_Plantation", "reload2_back", true);
	sld = CharacterFromID("FMQP_noble");
	RemovePassenger(pchar, sld);
	sld.Dialog.currentnode = "noble_23";
	ChangeCharacterAddressGroup(sld, "PortoBello_Plantation", "reload", "reload1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	if (pchar.questTemp.FMQP == "time_over")
	{
		pchar.quest.FMQP_plantation_late.win_condition.l1 = "location";
		pchar.quest.FMQP_plantation_late.win_condition.l1.location = "PortoBello_Plantation_Sp1";
		pchar.quest.FMQP_plantation_late.function = "FMQP_NoBook";
	}
	else
	{
		ChangeItemDescribe("Almanac", "itmdescr_Almanac_FMQP");
		sld = ItemsFromID("Almanac");
		sld.model = "open_book";
		pchar.GenQuestRandItem.PortoBello_Plantation_Sp1 = true;
		pchar.GenQuestRandItem.PortoBello_Plantation_Sp1.randitem1 = "Almanac";
		pchar.quest.FMQP_Book.win_condition.l1 = "item";
		pchar.quest.FMQP_Book.win_condition.l1.item = "Almanac";
		pchar.quest.FMQP_Book.function = "FMQP_FindBook";
	}
}

void FMQP_FindBook(string qName) // 
{
	Log_Info("You have found a heavy accounting book");
	sld = CharacterFromID("FMQP_noble");
	sld.Dialog.currentnode = "noble_27";
	LAi_SetActorType(sld);
	LAi_SetActorType(pchar);
	LAi_ActorFollow(pchar, sld, "ActorDialog_Any2Pchar", -1);
	LAi_ActorTurnToCharacter(sld, pchar);
	SetActorDialogAny2Pchar(sld.id, "", 0.0, 0.0);
	pchar.questTemp.FMQP = "book";
}

void FMQP_PrepareUncle(string qName) // 
{
	LAi_SetPlayerType(pchar);
	sld = CharacterFromID("FMQP_noble");
	LAi_SetActorType(sld);
	LAi_ActorFollowEverywhere(sld, "", -1);
	AddQuestRecord("FMQ_Portpax", "8");
	pchar.quest.FMQP_uncle.win_condition.l1 = "location";
	pchar.quest.FMQP_uncle.win_condition.l1.location = "PortoBello_Plantation";
	pchar.quest.FMQP_uncle.function = "FMQP_CreateUncleLuis";
}

void FMQP_CreateUncleLuis(string qName) // 
{
	LAi_LocationFightDisable(&Locations[FindLocation("PortoBello_Plantation")], true);
	// дядюшка
	int iRank = MOD_SKILL_ENEMY_RATE+sti(pchar.rank)-2;// Addon 2016-1 Jason пиратская линейка
	int iScl = 15 + 2*sti(pchar.rank); // may-16
	string sBlade = "blade_04";
	if (MOD_SKILL_ENEMY_RATE < 6) sBlade = "blade_12";
	if (MOD_SKILL_ENEMY_RATE > 8) sBlade = "topor_04";
	string sPistol = "pistol6";
	if (MOD_SKILL_ENEMY_RATE > 8) sPistol = "pistol4";
	ref chr = GetCharacter(NPC_GenerateCharacter("FMQP_Uncle", "citiz_1", "man", "man", iRank, SPAIN, -1, false, "soldier"));
	FantomMakeCoolFighter(chr, iRank, iScl, iScl, "blade_15", "pistol5", "bullet", iScl*2);
	chr.name = "Luis";
	chr.lastname = "Ortiz";
	chr.Dialog.Filename = "Quest\LineMiniQuests\FMQ_PortPax.c";
	chr.Dialog.currentnode = "uncle";
	DeleteAttribute(chr, "SaveItemsForDead");
	DeleteAttribute(chr, "DontClearDead");
	ChangeCharacterAddressGroup(chr, "PortoBello_Plantation", "goto", "goto21");
	LAi_SetActorType(chr);
	LAi_ActorDialog(chr, pchar, "", -1, 0);
	// гарды
	for (int i=1; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("FMQP_guard_"+i, "citiz_5"+i, "man", "man", iRank, SPAIN, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, sBlade, sPistol, "bullet", iScl*2);
		SetCharacterPerk(sld, "Gunman");
		SetCharacterPerk(sld, "GunProfessional");
		if (MOD_SKILL_ENEMY_RATE > 6)
		{
			SetCharacterPerk(sld, "SwordplayProfessional");
			sld.cirassId = Items_FindItemIdx("cirass2");
		}
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		ChangeCharacterAddressGroup(sld, "PortoBello_Plantation", "goto", "goto22");
		LAi_SetActorType(sld);
		LAi_ActorFollow(sld, chr, "", -1);
	}
}

void FMQP_UncleExit(string qName) // 
{
	DoQuestReloadToLocation("Portobello_exittown", "reload", "reload2", "FMQP_UncleExit");
}

void FMQP_OpenPlantation(string qName) // 
{
	LocatorReloadEnterDisable("Portobello_exittown", "reload2_back", false);
}

void FMQP_PlantatonPause(string qName) // 
{
	LocatorReloadEnterDisable("PortoBello_Plantation", "reload2_back", false);
	chrDisableReloadToLocation = false;
	bQuestDisableMapEnter = true;
	sld = CharacterFromID("FMQP_noble");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "houseSp1", "none", "", "", "", 20.0);
	pchar.questTemp.FMQP = "reward";
	AddQuestRecord("FMQ_Portpax", "11");
	pchar.quest.FMQP_Pause.win_condition.l1 = "Timer";
	pchar.quest.FMQP_Pause.win_condition.l1.date.hour  = 8.0;
	pchar.quest.FMQP_Pause.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 1);
	pchar.quest.FMQP_Pause.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 1);
	pchar.quest.FMQP_Pause.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 1);
	pchar.quest.FMQP_Pause.function = "FMQP_PlantatonReward";
	ref rloc = &Locations[FindLocation("PortoBello_Plantation")];
	rloc.soldiers = true;
}

void FMQP_PlantatonReward(string qName) // 
{
	sld = CharacterFromID("FMQP_noble");
	sld.Dialog.currentnode = "noble_39";
	ChangeCharacterAddressGroup(sld, "PortoBello_Plantation_Sp1", "goto", "goto1");
	LAi_SetStayType(sld);
	sld.talker = 9;
}

void FMQP_ReceiveReward(string qName) // 
{
	bQuestDisableMapEnter = false;// Addon 2016-1 Jason пиратская линейка
	sld = CharacterFromID("FMQP_noble");
	sld.lifeday = 0;
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload1", "none", "", "", "", 4.0);
	pchar.questTemp.FMQP = "end";
	FMQ_Count();
	AddQuestRecord("FMQ_Portpax", "12");
	CloseQuestHeader("FMQ_Portpax");
	GiveItem2Character(pchar, "indian_6"); 
	GiveItem2Character(pchar, "amulet_10"); 
	GiveItem2Character(pchar, "obereg_10"); 
	GiveItem2Character(pchar, "spyglass3"); 
	GiveItem2Character(pchar, "blade_16"); 
	AddCharacterGoods(pchar, GOOD_COFFEE, 200);
	ChangeCharacterComplexReputation(pchar, "authority", 3);
	ChangeCharacterComplexReputation(pchar, "fame", 2);
	AddComplexSelfExpToScill(50, 50, 50, 50);
	AddCharacterExpToSkill(pchar, "Leadership", 200);
	AddCharacterExpToSkill(pchar, "Fortune", 100);
}

void FMQP_NoBook(string qName) // 
{
	pchar.quest.FMQP_no_book.win_condition.l1 = "ExitFromLocation";
	pchar.quest.FMQP_no_book.win_condition.l1.location = pchar.location;
	pchar.quest.FMQP_no_book.function = "FMQP_LateFinal";
}

void FMQP_LateFinal(string qName) // 
{
	sld = CharacterFromID("FMQP_noble");
	sld.Dialog.currentnode = "noble_46";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

// --> ФМК-Последний урок
void FMQL_Start() // накручиваем гида и выдаем ему шняву
{
    if(!GetDLCenabled(DLC_APPID_2)) return;
	if (CheckAttribute(pchar, "questTemp.HWIC") || sti(pchar.rank) > 14) return;
	sld = GetCharacter(NPC_GenerateCharacter("Guide_y", "Guide_1", "man", "man", 10, FRANCE, -1, true, "officer"));
	FantomMakeSmallSailor(sld, SHIP_SHNYAVA, "Fudroyan", CANNON_TYPE_CANNON_LBS16, 45, 45, 45, 45, 45);
	sld.name = "Gregoire";
	sld.lastname = "Valinnie";
	sld.dialog.FileName = "Quest\LineMiniQuests\FMQ_Lesson.c";
	sld.dialog.currentnode = "greguar";
	sld.talker = 9;
	sld.rank = 25;
	int iHp = MOD_SKILL_ENEMY_RATE*10+300;
	LAi_SetHP(sld, iHp, iHp);
	SetSelfSkill(sld, 80, 80, 80, 80, 50);
	SetShipSkill(sld, 50, 80, 35, 30, 50, 20, 30, 20, 80);
	SetSPECIAL(sld, 9, 5, 8, 6, 5, 10, 8);
	SetCharacterPerk(sld, "Energaiser");
	SetCharacterPerk(sld, "BasicDefense");
	SetCharacterPerk(sld, "AdvancedDefense");
	SetCharacterPerk(sld, "CriticalHit");
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "HardHitter");
	SetCharacterPerk(sld, "Sliding");
	SetCharacterPerk(sld, "BladeDancer");
	SetCharacterPerk(sld, "SwordplayProfessional");
	SetCharacterPerk(sld, "Gunman");
	SetCharacterPerk(sld, "GunProfessional");
	SetCharacterPerk(sld, "ShipSpeedUp");
	SetCharacterPerk(sld, "ShipTurnRateUp");
	SetCharacterPerk(sld, "HullDamageUp");
	SetCharacterPerk(sld, "SailsDamageUp");
	SetCharacterPerk(sld, "Doctor1");
	SetCharacterPerk(sld, "BasicBattleState");
	SetCharacterPerk(sld, "BasicCommerce");
	SetCharacterPerk(sld, "AdvancedCommerce");
	GiveItem2Character(sld, "blade_30");
	EquipCharacterbyItem(sld, "blade_30");
	GiveItem2Character(sld, "pistol6");
	EquipCharacterbyItem(sld, "pistol6");
	sld.cirassId = Items_FindItemIdx("cirass4");
	LAi_SetCharacterUseBullet(sld, "bullet");
    TakeNItems(sld, "bullet", 30);
	AddItems(sld, "gunpowder", 30);
	TakeNItems(sld, "potion2", 5);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	SetCrewQuantityOverMax(sld, 100);
	UpgradeShipParameter(sld, "Capacity");
	sld.ship.Crew.Morale = 90;
	sld.Ship.Crew.Exp.Sailors = 90;
	sld.Ship.Crew.Exp.Cannoners = 60;
	sld.Ship.Crew.Exp.Soldiers = 60;
	NullCharacterGoods(sld);
	AddCharacterGoods(sld, GOOD_BALLS, 200);
	AddCharacterGoods(sld, GOOD_GRAPES, 200);
	AddCharacterGoods(sld, GOOD_KNIPPELS, 200);
	AddCharacterGoods(sld, GOOD_BOMBS, 200);
	AddCharacterGoods(sld, GOOD_FOOD, 400);
	AddCharacterGoods(sld, GOOD_POWDER, 500);
	AddCharacterGoods(sld, GOOD_WEAPON, 150);
	AddCharacterGoods(sld, GOOD_MEDICAMENT, 100);
	ChangeCharacterAddressGroup(sld, "Fortfrance_town", "quest", "quest1");
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	// при 13 ранге - трем гида
	pchar.quest.FMQL_delete_guide.win_condition.l1 = "Rank";
	pchar.quest.FMQL_delete_guide.win_condition.l1.value = 15;
	pchar.quest.FMQL_delete_guide.win_condition.l1.operation = ">=";
	pchar.quest.FMQL_delete_guide.function = "FMQL_DeleteGuide";
}

void FMQL_DeleteGuide(string qName) // удаляем гида на 15 ранге
{
	sld = CharacterFromID("Guide_y");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld.lifeday = 0;
}

void FMQL_Begin() // 
{
	chrDisableReloadToLocation = true;
	sld = CharacterFromID("Guide_y");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "reload1", "none", "", "", "OpenTheDoors", 5.0);
	SetCharacterRemovable(sld, false);
	sld.CompanionEnemyEnable = false; //всегда друзья
	SetCompanionIndex(pchar, -1, sti(sld.index));
	sld.loyality = MAX_LOYALITY;
	pchar.quest.FMQL_shipfail.win_condition.l1 = "NPC_Death";//прерывание на потопление 
	pchar.quest.FMQL_shipfail.win_condition.l1.character = "Guide_y";
	pchar.quest.FMQL_shipfail.function = "FMQL_ShipFail";
	SetFunctionTimerCondition("FMQL_TimeOver", 0, 0, 7, false);
	pchar.quest.FMQL_cumana.win_condition.l1 = "location";
	pchar.quest.FMQL_cumana.win_condition.l1.location = "Cumana";
	pchar.quest.FMQL_cumana.function = "FMQL_ArriveCumana";
	AddQuestRecord("FMQ_Lesson", "1");
}

void FMQL_ShipFail(string qName) // 
{
	pchar.quest.FMQL_cumana.over = "yes";
	pchar.quest.FMQL_TimeOver.over = "yes";
	ChangeCharacterHunterScore(PChar, "frahunter", 10);
	ChangeCharacterComplexReputation(pchar, "nobility", -5);
	AddQuestRecord("FMQ_Lesson", "11");
	CloseQuestHeader("FMQ_Lesson");
	pchar.questTemp.FMQL = "fail";
}

void FMQL_TimeOver(string qName) // 
{
	pchar.quest.FMQL_cumana.over = "yes";
	pchar.quest.FMQL_shipfail.over = "yes";
	sld = CharacterFromID("Guide_y");
	sld.lifeday = 0;
	RemoveCharacterCompanion(pchar, sld);
	AddQuestRecord("FMQ_Lesson", "4");
	CloseQuestHeader("FMQ_Lesson");
	pchar.questTemp.FMQL = "fail";
}

void FMQL_ArriveCumana(string qName) // у Куманы - ставим англов и голландцев
{
	pchar.quest.FMQL_TimeOver.over = "yes";
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	pchar.GenQuest.CannotWait = true;
	Group_FindOrCreateGroup("FMQL_Enggroup");
	Group_FindOrCreateGroup("FMQL_Holgroup");
	int iShip;
	for (int i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("FMQL_EngCap_"+i, "off_eng_"+i, "man", "man", 25, ENGLAND, 5, true, "officer"));
		if (i == 1) iShip = SHIP_FRIGATE;
		else iShip = SHIP_CORVETTE;
		FantomMakeCoolSailor(sld, iShip, "", CANNON_TYPE_CULVERINE_LBS18, 60, 60, 60);
		FantomMakeCoolFighter(sld, 25, 100, 100, "blade_13", "pistol1", "bullet", 150);
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		Character_SetAbordageEnable(sld, false);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.Ship.Mode = "war";
		SetCharacterPerk(sld, "MusketsShoot");
		Group_AddCharacter("FMQL_Enggroup", "FMQL_EngCap_"+i);
	}
	Group_SetGroupCommander("FMQL_Enggroup", "FMQL_EngCap_1");
	Group_SetAddress("FMQL_Enggroup", "Cumana", "quest_ships", "quest_ship_8");
	Group_SetTaskAttack("FMQL_Enggroup", "FMQL_Holgroup");
	Group_LockTask("FMQL_Enggroup");
	for (i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("FMQL_HolCap_"+i, "off_hol_"+i, "man", "man", 25, HOLLAND, 5, true, "officer"));
		if (i == 1) iShip = SHIP_GALEON_H;
		else iShip = SHIP_XebekVML;
		FantomMakeCoolSailor(sld, iShip, "", CANNON_TYPE_CULVERINE_LBS18, 60, 60, 60);
		FantomMakeCoolFighter(sld, 25, 100, 100, "blade_13", "pistol1", "bullet", 150);
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		Character_SetAbordageEnable(sld, false);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.Ship.Mode = "war";
		SetCharacterPerk(sld, "MusketsShoot");
		Group_AddCharacter("FMQL_Holgroup", "FMQL_HolCap_"+i);
	}
	Group_SetGroupCommander("FMQL_Holgroup", "FMQL_HolCap_1");
	Group_SetAddress("FMQL_Holgroup", "Cumana", "quest_ships", "quest_ship_7");
	Group_SetTaskAttack("FMQL_Holgroup", "FMQL_Enggroup");
	Group_LockTask("FMQL_Holgroup");
	// прерывание на высадку
	pchar.quest.FMQL_bdls.win_condition.l1 = "location";
	pchar.quest.FMQL_bdls.win_condition.l1.location = "shore18";
	pchar.quest.FMQL_bdls.function = "FMQL_AbandonBdlS";
}

void FMQL_AbandonBdlS(string qName) // 
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	InterfaceStates.Buttons.Save.enable = false;//запретить сохраняться
	pchar.quest.FMQL_shipfail.over = "yes";
	pchar.questTemp.FMQL = "shore";
	chrDisableReloadToLocation = true;
	int oRank = sti(pchar.rank)+5;
	int eRank = sti(pchar.rank);
	int oScl = 20 + 2*sti(pchar.rank);
	int eScl = 10 + 2*sti(pchar.rank);// Addon 2016-1 Jason пиратская линейка
	// ставим наших
	sld = CharacterFromID("Guide_y");
	RemoveCharacterCompanion(pchar, sld);
	ChangeCharacterAddressGroup(sld, "Shore18", "goto", "goto8");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	for (int i=1; i<=5; i++)
	{
		if (i == 5)
		{
			sld = GetCharacter(NPC_GenerateCharacter("FMQL_sailor_"+i, "mush_ctz_5", "man", "mushketer", oRank, FRANCE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, oRank, oScl, oScl, "", "mushket3", "grapeshot", oScl*3);
			TakeNItems(pchar, "grapeshot", 40);
			TakeNItems(pchar, "gunpowder", 40);
			LAi_SetCharacterUseBullet(sld, "grapeshot");
			ChangeCharacterAddressGroup(sld, "shore18", "goto", "goto8");
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("FMQL_sailor_"+i, "citiz_3"+i, "man", "man", oRank, FRANCE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, oRank, oScl, oScl, LinkRandPhrase("blade_08","blade_11","blade_14"), "pistol1", "bullet", oScl*2);
		}
		ChangeCharacterAddressGroup(sld, "shore18", "goto", "goto7");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	// первая группа индеев
	PlaySound("interface\abordage_wining.wav");
	LAi_group_Delete("EnemyFight");
	for (i=1; i<=10; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("FMQL_indian_"+i, "miskito_"+(rand(5)+1), "man", "man", eRank, PIRATE, -1, false, "native"));
		FantomMakeCoolFighter(sld, eRank, eScl, eScl, RandPhraseSimple("topor_05","slave_02"), "", "", eScl*2);
		ChangeCharacterAddressGroup(sld, "shore18", "goto", "goto3");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "FMQL_FirstBattleEnd");
	LAi_SetFightMode(pchar, true);
}

void FMQL_SecondCoastBattle() // 
{
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;// Addon 2016-1 Jason пиратская линейка
	int iScl = 25 + 2*sti(pchar.rank);
	// вторая группа индеев
	PlaySound("interface\abordage_wining.wav");
	for (int i=1; i<=8; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("FMQL_indian_add_"+i, "miskito_"+(rand(5)+1), "man", "man", iRank, PIRATE, -1, false, "native"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_01","blade_02"), "", "", iScl*2);
		ChangeCharacterAddressGroup(sld, "shore18", "goto", "goto3");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	sld = CharacterFromID("Guide_y");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "FMQL_SecondBattleEnd");
	LAi_SetFightMode(pchar, true);
}

void FMQL_GoToJungle() // 
{
	chrDisableReloadToLocation = false;
	LocatorReloadEnterDisable("shore18", "boat", true);
	sld = CharacterFromID("Guide_y");
	LAi_SetActorType(sld);
	LAi_ActorFollowEverywhere(sld, "", -1);
	for (int i=1; i<=5; i++)
	{
		sld = CharacterFromID("FMQL_sailor_"+i);
		if (LAi_GetCharacterHP(sld) > 0)
		{
			LAi_SetActorType(sld);
			LAi_ActorFollowEverywhere(sld, "", -1);
		}
	}
	pchar.quest.FMQL_jungle.win_condition.l1 = "location";
	pchar.quest.FMQL_jungle.win_condition.l1.location = "Common_jungle_01";
	pchar.quest.FMQL_jungle.function = "FMQL_InJungle";
}

void FMQL_InJungle(string qName) // в джунглях
{
	chrDisableReloadToLocation = true;
	int iRank = sti(pchar.rank)+8-makeint(MOD_SKILL_ENEMY_RATE/2);
	int iScl = 25 + 2*sti(pchar.rank);
	if (CheckAttribute(pchar, "questTemp.Prosper_fmql"))
	{
		sld = GetCharacter(NPC_GenerateCharacter("FMQL_Prosper", "Prospero_mush", "man", "mushketer", iRank, FRANCE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, 110, "", "mushket1", "cartridge", iScl*3);
		LAi_SetCharacterUseBullet(sld, "cartridge");
		sld.name = "Prosper";
		sld.lastname = "Trubal";
		sld.dialog.FileName = "Quest\LineMiniQuests\FMQ_Lesson.c";
		sld.dialog.currentnode = "prosper";
		sld.cirassId = Items_FindItemIdx("cirass1");
		SetCharacterPerk(sld, "SwordplayProfessional");
		SetCharacterPerk(sld, "Gunman");
		SetCharacterPerk(sld, "GunProfessional");
	}
	else
	{
		sld = GetCharacter(NPC_GenerateCharacter("FMQL_mercen", "mush_ctz_12", "man", "mushketer", iRank, FRANCE, -1, false, "soldier"));
		sld.dialog.FileName = "Quest\LineMiniQuests\FMQ_Lesson.c";
		sld.dialog.currentnode = "mercen";
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*3);
		LAi_SetCharacterUseBullet(sld, "cartridge");
	}
	ChangeCharacterAddressGroup(sld, "Common_jungle_01", "rld", "aloc0");
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0); 
	for (int i=6; i<=10; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("FMQL_sailor_"+i, "citiz_"+(20+i), "man", "man", iRank, FRANCE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, LinkRandPhrase("blade_03","blade_04","blade_06"), "pistol1", "bullet", iScl*2);
		ChangeCharacterAddressGroup(sld, "Common_jungle_01", "rld", "aloc4");
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_SetActorType(sld);
		LAi_ActorFollow(sld, pchar, "", 5.0);
	}
}

void FMQL_FailInShore() // 
{
	for (int i=1; i<=5; i++)
	{
		sld = CharacterFromID("FMQL_sailor_"+i);
		sld.lifeday = 0;
	}
	chrDisableReloadToLocation = false;
	LocatorReloadEnterDisable("shore18", "boat", false);
	DeleteAttribute(pchar, "GenQuest.CannotWait");
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	AddQuestRecord("FMQ_Lesson", "2");
	CloseQuestHeader("FMQ_Lesson");
	pchar.questTemp.FMQL = "fail";
}

void FMQL_PrepareAttack() // стадо баранов
{
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "quest", "quest1");
	FMQL_OurWarriorsActivate();
	DoQuestFunctionDelay("FMQL_CreateCaribMushketer", 3.0);
}

void FMQL_OurWarriorsActivate() // 
{
	sld = CharacterFromID("Guide_y");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	if (GetCharacterIndex("FMQL_Prosper") != -1)
	{
		sld = CharacterFromID("FMQL_Prosper");
		LAi_SetWarriorType(sld);
		LAi_warrior_DialogEnable(sld, false);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	if (GetCharacterIndex("FMQL_mercen") != -1)
	{
		sld = CharacterFromID("FMQL_mercen");
		LAi_SetWarriorType(sld);
		LAi_warrior_DialogEnable(sld, false);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	for (int i=1; i<=10; i++)
	{
		if (GetCharacterIndex("FMQL_sailor_"+i) != -1)
		{
			sld = CharacterFromID("FMQL_sailor_"+i);
			LAi_SetWarriorType(sld);
			LAi_warrior_DialogEnable(sld, false);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
}

void FMQL_PrepareSneakAttack() // засада
{
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "quest", "quest1");
	sld = CharacterFromID("Guide_y");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocator(sld, "rld", "aloc0", "", 5.0);
	if (GetCharacterIndex("FMQL_Prosper") != -1)
	{
		sld = CharacterFromID("FMQL_Prosper");
		LAi_SetActorType(sld);
		LAi_ActorRunToLocator(sld, "rld", "aloc11", "", 5.0);
	}
	if (GetCharacterIndex("FMQL_mercen") != -1)
	{
		sld = CharacterFromID("FMQL_mercen");
		LAi_SetActorType(sld);
		LAi_ActorRunToLocator(sld, "rld", "aloc11", "", 5.0);
	}
	for (int i=1; i<=10; i++)
	{
		if (GetCharacterIndex("FMQL_sailor_"+i) != -1)
		{
			sld = CharacterFromID("FMQL_sailor_"+i);
			if (i == 5) sld.MusketerDistance = 0;
			LAi_SetActorType(sld);
			LAi_ActorRunToLocator(sld, "rld", "aloc"+i, "", 5.0);
		}
	}
	DoQuestFunctionDelay("FMQL_CreateCaribMushketer", 7.0);
}

void FMQL_CreateCaribMushketer(string qName) // вышли из леса крутые карибы с пушками
{
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+2;// Addon 2016-1 Jason пиратская линейка
	int iScl = 30 + 2*sti(pchar.rank);
	// третья группа индеев - мушкетеры
	for (int i=1; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("FMQL_canib_mush_"+i, "mush_cnb_"+(rand(2)+1), "man", "mushketer", iRank, PIRATE, -1, false, "native"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2);
		LAi_SetCharacterUseBullet(sld, "cartridge");
		sld.name = GetIndianName(MAN);
		sld.lastname = "";
		ChangeCharacterAddressGroup(sld, "Common_jungle_01", "quest", "quest1");
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_SetActorType(sld);
		LAi_ActorRunToLocator(sld, "rld", "loc"+i, "", 5.0);
	}
	DoQuestFunctionDelay("FMQL_CreateCaribWarrior", 3.0);
}

void FMQL_CreateCaribWarrior(string qName) // вождь с командой
{
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+5;
	int iScl = 35 + 3*sti(pchar.rank);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	// вождь
	sld = GetCharacter(NPC_GenerateCharacter("FMQL_canib_chief", "canib_boss", "man", "man", iRank+5, PIRATE, -1, false, "native"));
	FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "topor_01", "pistol5", "bullet", iScl*3+50);
	ChangeCharacterAddressGroup(sld, "Common_jungle_01", "quest", "quest1");
	LAi_SetCheckMinHP(sld, 10, true, "FMQL_CanibBossAmulet");
	LAi_SetWarriorType(sld);
	// третья группа индеев - воины
	for (int i=1; i<=6; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("FMQL_canib_"+i, "canib_"+i, "man", "man", iRank, PIRATE, -1, false, "native"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "topor_04", "pistol1", "bullet", iScl*3);
		ChangeCharacterAddressGroup(sld, "Common_jungle_01", "quest", "quest1");
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_SetWarriorType(sld);
	}
	if (pchar.questTemp.FMQL == "sneak") DoQuestFunctionDelay("FMQL_CreateCaribGo", 0.1);
	else DoQuestFunctionDelay("FMQL_CaribAttack", 0.5);
}

void FMQL_CaribAttack(string qName) // схватились с карибами
{
	LAi_SetPlayerType(pchar);
	sld = CharacterFromID("FMQL_canib_chief");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	for (int i=1; i<=4; i++)
	{
		sld = CharacterFromID("FMQL_canib_mush_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	for (i=1; i<=6; i++)
	{
		sld = CharacterFromID("FMQL_canib_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "FMQL_AfterCaribAttack");
	LAi_SetFightMode(pchar, true);
}

void FMQL_CreateCaribGo(string qName) // идут, пока не подозревают
{
	sld = CharacterFromID("FMQL_canib_chief");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocator(sld, "quest", "quest2", "", 5.0);
	for (int i=1; i<=6; i++)
	{
		sld = CharacterFromID("FMQL_canib_"+i);
		LAi_SetActorType(sld);
		LAi_ActorRunToLocator(sld, "quest", "quest2", "", 5.0);
	}
	DoQuestFunctionDelay("FMQL_CaribShot", 5.0);
}

void FMQL_CaribShot(string qName) // залп из засады
{
	if (GetCharacterIndex("FMQL_Prosper") != -1)
	{
		sld = CharacterFromID("FMQL_Prosper");
		LAi_SetActorType(sld);
		LAi_ActorAnimation(sld, "shot", "", 1.0);
	}
	if (GetCharacterIndex("FMQL_mercen") != -1)
	{
		sld = CharacterFromID("FMQL_mercen");
		LAi_SetActorType(sld);
		LAi_ActorAnimation(sld, "shot", "", 1.0);
	}
	for (int i=5; i<=10; i++)
	{
		if (GetCharacterIndex("FMQL_sailor_"+i) != -1)
		{
			if (i > 5 && i < 9) continue;
			sld = CharacterFromID("FMQL_sailor_"+i);
			LAi_SetActorType(sld);
			LAi_ActorAnimation(sld, "shot", "", 1.0);
		}
	}
	DoQuestFunctionDelay("FMQL_CaribDie", 1.3);
}

void FMQL_CaribDie(string qName) // 
{
	for (int i=3; i<=4; i++)
	{
		sld = CharacterFromID("FMQL_canib_mush_"+i);
		LAi_KillCharacter(sld);
	}
	sld = CharacterFromID("FMQL_canib_6");
	LAi_KillCharacter(sld);
	if (GetCharacterIndex("FMQL_sailor_5") != -1) 
	{
		sld = CharacterFromID("FMQL_canib_5");
		LAi_KillCharacter(sld);
	}
	FMQL_OurWarriorsActivate();
	DoQuestFunctionDelay("FMQL_CaribAttack", 1.0);
}

void FMQL_ClearAllCharacters() // тотальная чистка чаров
{
	if (GetCharacterIndex("Guide_y") != -1)
	{
		sld = CharacterFromID("Guide_y");
		sld.lifeday = 0;
	}
	if (GetCharacterIndex("FMQL_Prosper") != -1)
	{
		sld = CharacterFromID("FMQL_Prosper");
		sld.lifeday = 0;
	}
	if (GetCharacterIndex("FMQL_mercen") != -1)
	{
		sld = CharacterFromID("FMQL_mercen");
		sld.lifeday = 0;
	}
	for (int i=1; i<=10; i++)
	{
		if (GetCharacterIndex("FMQL_sailor_"+i) != -1)
		{
			sld = CharacterFromID("FMQL_sailor_"+i);
			sld.lifeday = 0;
		}
	}
}

void FMQL_ReturnMartinique(string qName) // прибыли домой
{
	if(!GetDLCenabled(DLC_APPID_2)) return;
	pchar.quest.FMQL_ReturnTimeOver.over = "yes";
	pchar.quest.FMQL_shipfail_1.over = "yes";
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	pchar.GenQuest.SmugglersBlock = "fortfrance_tavern";
	chrDisableReloadToLocation = true;
	sld = CharacterFromID("Guide_y");
	sld.Dialog.currentnode = "greguar_15";
	RemoveCharacterCompanion(pchar, sld);
	LAi_SetCurHPMax(sld);
	TakeNItems(sld, "potion2", MOD_SKILL_ENEMY_RATE/2);
	ChangeCharacterAddressGroup(sld, "Fortfrance_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	if (GetCharacterIndex("FMQL_Prosper") != -1)
	{
		sld = CharacterFromID("FMQL_Prosper");
		RemovePassenger(pchar, sld);
		sld.Dialog.currentnode = "prosper_9x";
		LAi_SetCurHPMax(sld);
		TakeNItems(sld, "potion2", 3);
		ChangeCharacterAddressGroup(sld, "Fortfrance_town", "reload", "reload4_back");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void FMQL_MeetingOnLamanten(string qName) // встреча на пляже Ламантен
{
	// ставим шняву
	sld = CharacterFromID("Guide_y");
	DeleteAttribute(sld, "chr_ai.poison"); // патч 17/1
	LAi_SetCurHPMax(sld);
	Group_AddCharacter("FMQL_GuideGroup", "Guide_y");
	Group_SetGroupCommander("FMQL_GuideGroup", "Guide_y");
	Group_SetAddress("FMQL_GuideGroup", "Martinique", "quest_ships", "quest_ship_10");
	Group_SetTaskNone("FMQL_GuideGroup");
	AddGeometryToLocation("Shore38", "smg");
	pchar.quest.FMQL_goods_over.win_condition.l1 			= "Timer";		// ugeen fix, плодил ошибки в compile.log
	pchar.quest.FMQL_goods_over.win_condition.l1.date.hour  = 2.0;
	pchar.quest.FMQL_goods_over.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 0);
	pchar.quest.FMQL_goods_over.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 0);
	pchar.quest.FMQL_goods_over.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 0);
	pchar.quest.FMQL_goods_over.function = "FMQL_GoodsTimeOver";
	pchar.quest.FMQL_beach.win_condition.l1 = "Hour";
	pchar.quest.FMQL_beach.win_condition.l1.start.hour = 0.00;
	pchar.quest.FMQL_beach.win_condition.l1.finish.hour = 2.00;
	pchar.quest.FMQL_beach.win_condition.l2 = "location";
	pchar.quest.FMQL_beach.win_condition.l2.location = "Shore38";
	pchar.quest.FMQL_beach.win_condition.l3 = "Ship_location";
	pchar.quest.FMQL_beach.win_condition.l3.location = "Shore38";
	pchar.quest.FMQL_beach.function = "FMQL_OnLamantenBeach";
}

void FMQL_ShipFailReturn(string qName) // 
{
	pchar.quest.FMQL_return.over = "yes";
	pchar.quest.FMQL_ReturnTimeOver.over = "yes";
	ChangeCharacterHunterScore(PChar, "frahunter", 40);
	ChangeCharacterComplexReputation(pchar, "nobility", -20);
	AddQuestRecord("FMQ_Lesson", "12");
	CloseQuestHeader("FMQ_Lesson");
	pchar.questTemp.FMQL = "fail";
}

void FMQL_ReturnTimeOver(string qName) // 
{
	pchar.quest.FMQL_return.over = "yes";
	pchar.quest.FMQL_shipfail_1.over = "yes";
	sld = CharacterFromID("Guide_y");
	sld.lifeday = 0;
	RemoveCharacterCompanion(pchar, sld);
	AddQuestRecord("FMQ_Lesson", "13");
	CloseQuestHeader("FMQ_Lesson");
	pchar.questTemp.FMQL = "fail";
}

void FMQL_GoodsTimeOver(string qName) // 
{
	pchar.quest.FMQL_beach.over = "yes";
	LAi_LocationDisableOfficersGen("Shore38", false);
	LAi_LocationFightDisable(&Locations[FindLocation("Shore38")], false);
	locations[FindLocation("Shore38")].DisableEncounters = false; // may-16
	DeleteAttribute(pchar, "GenQuest.SmugglersBlock");
	RemoveGeometryFromLocation("Shore38", "smg");
	sld = CharacterFromID("Guide_y");
	sld.lifeday = 0;
	AddQuestRecord("FMQ_Lesson", "14");
	CloseQuestHeader("FMQ_Lesson");
	pchar.questTemp.FMQL = "fail";
}

void FMQL_OnLamantenBeach(string qName) // на самом пляже
{
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	chrDisableReloadToLocation = true;
	pchar.GenQuest.CannotWait = true;
	DeleteAttribute(pchar, "GenQuest.SmugglersBlock");
	LAi_LocationFightDisable(&Locations[FindLocation("Shore38")], true);
	// контра
	for (int i=1; i<=3; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("FMQL_contra_"+i, "citiz_2"+(i+6), "man", "man", 25, PIRATE, -1, false, "marginal"));
		SetFantomParamFromRank(sld, 25, true);
		sld.dialog.FileName = "Quest\LineMiniQuests\FMQ_Lesson.c";
		sld.Dialog.currentnode = "contra";
		sld.greeting = "smuggler";
		ChangeCharacterAddressGroup(sld, "Shore38", "smugglers", "smuggler0"+i);
		LAi_SetStayType(sld);
		sld.talker = 9;
		LAi_CharacterDisableDialog(sld);
	}
	// гид
	sld = CharacterFromID("Guide_y");
	sld.Dialog.currentnode = "greguar_17";
	sld.MultiFighter = 2.0;
	LAi_SetCurHPMax(sld); // патч 17/1
	if (MOD_SKILL_ENEMY_RATE > 4) sld.MultiFighter = 4.0; // мультифайтер may-16
	sld.LSC_clan = true; // may-16
	TakeNItems(sld, "potion2", makeint(MOD_SKILL_ENEMY_RATE/2)); // may-16
	sld.SaveItemsForDead = true; 
	sld.DontClearDead = true;
	ChangeCharacterAddressGroup(sld, "Shore38", "goto", "goto1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void FMQL_CreateGuidesWarriors() // ставим кодлу гида
{
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+10;
	int iScl = 55 + 3*sti(pchar.rank); // may-16
	// индей со склопеттой
	sld = GetCharacter(NPC_GenerateCharacter("FMQL_Johnny", "mush_cnb_1", "man", "mushketer", iRank, PIRATE, -1, false, "native"));
	FantomMakeCoolFighter(sld, iRank, iScl, 110, "", "grape_mushket", "grenade", iScl*3);
	sld.name = "Johnny";
	sld.lastname = "";
	SetSPECIAL(sld, 10, 10, 5, 3, 5, 10, 10);
	TakeNItems(sld, "grenade", 70); // may-16
	LAi_SetCharacterUseBullet(sld, "grenade");
	if (MOD_SKILL_ENEMY_RATE > 2) // may-16
	{
		sld.MultiFighter = 2.0;
		sld.MultiShooter = 4.0;
	}
	TakeNItems(sld, "potion2", makeint(MOD_SKILL_ENEMY_RATE/2)); // may-16
	sld.cirassId = Items_FindItemIdx("cirass1");
	sld.LSC_clan = true; // may-16
	SetCharacterPerk(sld, "SwordplayProfessional");
	SetCharacterPerk(sld, "Gunman");
	SetCharacterPerk(sld, "GunProfessional");
	ChangeCharacterAddressGroup(sld, "Shore38", "box", "box1");
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	LAi_SetActorType(sld);
	LAi_ActorTurnToCharacter(sld, characterFromID("FMQL_contra_2"));
	// гарды
	for (int i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("FMQL_guard_"+i, "killer_"+(rand(4)+1), "man", "man", iRank, PIRATE, -1, false, "soldier")); // may-16
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "topor_04", "", "", iScl*3); // mitrokosta ослабление гардов
		ChangeCharacterAddressGroup(sld, "Shore38", "goto", "goto"+(i+1));
		sld.MultiFighter = 1.4;
		if (MOD_SKILL_ENEMY_RATE > 4) sld.MultiFighter = 2.0; // мультифайтер may-16
		TakeNItems(sld, "potion2", makeint(MOD_SKILL_ENEMY_RATE/3)); // may-16
		sld.cirassId = Items_FindItemIdx("cirass4");
		sld.LSC_clan = true; // may-16
		SetCharacterPerk(sld, "SwordplayProfessional");
		SetCharacterPerk(sld, "Gunman");
		SetCharacterPerk(sld, "GunProfessional");
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_SetActorType(sld);
	}
}
// Addon 2016-1 Jason пиратская линейка - это отключаю
void FMQL_MoneyForSelina(string qName) // 
{
	AddMoneyToCharacter(pchar, -20000);
	PlaySound("interface\notebook.wav");
	Log_Info("You have spared 20 000 pesos for Selina Trubal");
}

void FMQL_ProsperDead(string qName) // 
{
	Log_TestInfo("Проспер убит");
	pchar.questTemp.FMQL.ProsperDead = "true";
}

void FMQL_PirateDead(string qName) // 
{
	Log_TestInfo("Пират убит");
	pchar.questTemp.FMQL.PirateDead = "true";
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///============================================================ Jason Пиратская линейка ================================================================================
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// эпизод 1 - Янтарная лихорадка
void Mtraxx_TerraxReset(int i) // общая функция при провалах
{
	QuestSetCurrentNode("Terrax", "First time");
	CloseQuestHeader("Roger_"+i);
	pchar.questTemp.Mtraxx = "fail";
	if (CheckAttribute(pchar, "GenQuest.HunterLongPause")) DeleteAttribute(pchar, "GenQuest.HunterLongPause");
}

void Mtraxx_JewelryBegin() // старт первого квеста
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	// девка
	pchar.quest.mtr_sdm_brothel.win_condition.l1 = "location";
	pchar.quest.mtr_sdm_brothel.win_condition.l1.location = "santodomingo_brothel";
	pchar.quest.mtr_sdm_brothel.function = "Mtraxx_SetGabriela";
	// таймер
	SetFunctionTimerCondition("Mtraxx_JewelrySDMOver", 0, 0, 3, false);
}

void Mtraxx_SetGabriela(string qName) // 
{
	DoQuestFunctionDelay("Mtraxx_RenameGabriela", 2.0);
}

void Mtraxx_RenameGabriela(string qName) // 
{
	sld = characterFromId("HorseGen_"+reload_location_index+"_2"); // переименуем девку
	sld.name = "Gabriela";
	sld.lastname = "Chapada";
}

void Mtraxx_JewelrySDMOver(string qName) // опоздание по Санто-Доминго
{
	DeleteAttribute(pchar, "questTemp.Mtraxx.AffairOfHonor");
	pchar.quest.mtr_sdm_brothel.over = "yes";
	AddQuestRecord("Roger_1", "2");
	Mtraxx_TerraxReset(1);
}

void Mtraxx_JewelryHavanaOver(string qName) // опоздание по Гаване
{
	DeleteAttribute(pchar, "GenQuest.PrisonQuestLock");
	pchar.quest.mtr_jewelry_havana.over = "yes";
	AddQuestRecord("Roger_1", "4");
	Mtraxx_TerraxReset(1);
}

void Mtraxx_HavanaInfo(string qName) // 
{
	AddQuestRecord("Roger_1", "6");
}

void Mtraxx_CreateOfficer() // ставим Лопе Монторо
{
	sld = GetCharacter(NPC_GenerateCharacter("Lope", "sold_spa_16", "man", "man", 25, SPAIN, 15, true, "quest"));
	SetFantomParamFromRank(sld, 25, true);
	sld.name = " Lope";
	sld.lastname = "Montoro";
	sld.dialog.FileName = "Quest\Roger.c";
	sld.dialog.currentnode = "Mtr_officer";
	sld.greeting = "";
	RemoveAllCharacterItems(sld, true);
	LAi_SetStayType(sld);
	ChangeCharacterAddressGroup(sld, "Havana_prison", "goto", "goto9");
	LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
}

void Mtraxx_TimeclearPrison(string qName) // опоздание по тюрьме
{
	DeleteAttribute(pchar, "GenQuest.PrisonQuestLock");
	AddQuestRecord("Roger_1", "9");
	sld = characterFromId("Lope");
	LAi_CharacterDisableDialog(sld);
	if (GetCharacterIndex("Rosario") != -1)
	{
		sld = characterFromId("Rosario");
		LAi_CharacterDisableDialog(sld);
		sld.lifeday = 0;
	}
	Mtraxx_TerraxReset(1);
}

void Mtraxx_CreateRosario() // ставим Росарио
{
	sld = GetCharacter(NPC_GenerateCharacter("Rosario", "off_spa_3", "man", "man", 25, SPAIN, -1, true, "quest"));
	SetFantomParamFromRank(sld, 25, true);
	sld.name = "Rosario";
	sld.lastname = "Gusman";
	sld.dialog.FileName = "Quest\Roger.c";
	sld.dialog.currentnode = "Mtr_rosario";
	sld.greeting = "";
	LAi_SetImmortal(sld, true);
	LAi_SetLoginTime(sld, 16.0, 20.0);
	LAi_SetWarriorType(sld);
	LAi_warrior_DialogEnable(sld, true);
	ChangeCharacterAddressGroup(sld, "Havana_town", "goto", "goto1");
	LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
}

void Mtraxx_PrisonerFree(string qName) // пленник свободен
{
	pchar.questTemp.Mtraxx = "jewelry_8";
	sld = characterFromId("Lope");
	LAi_CharacterEnableDialog(sld);
	sld.dialog.currentnode = "Mtr_officer_7";
}

void Mtraxx_TimeclearGulf(string qName) // опоздание в залив
{
	pchar.quest.mtr_jewelry_gulf.over = "yes";
	AddQuestRecord("Roger_1", "13");
	Mtraxx_TerraxReset(1);
}

void Mtraxx_JewelryGulf(string qName) // Кабаньяс в заливе
{	
	if(!GetDLCenabled(DLC_APPID_3)) return;
	pchar.quest.Mtraxx_TimeclearGulf.over = "yes";
	Island_SetReloadEnableGlobal("Santacatalina", false);//на остров нельзя
	bQuestDisableMapEnter = true;//на карту тоже
	pchar.questTemp.Mtraxx.JewQty = 0;
	Group_FindOrCreateGroup("Mtr_Jewhead");
	Group_FindOrCreateGroup("Mtr_Jewwork");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+5;
	if (iRank > 50) iRank = 50;
	sld = GetCharacter(NPC_GenerateCharacter("Cabanos", "off_spa_2", "man", "man", iRank, SPAIN, -1, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_SCHOONER_W, "Cantavro", CANNON_TYPE_CULVERINE_LBS18, 50, 50, 50);
	FantomMakeCoolFighter(sld, iRank, 50, 50, "blade_15", "pistol5", "bullet", 150); // патч 17/1
	sld.name = " Esberdo";
	sld.lastname = "Cabanas";
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true; // патч 17/1
	sld.Ship.Mode = "war";
	sld.AlwaysEnemy = true;
	SetSailsColor(sld, 6);
	sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*4;
	sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*4;
	sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*4;
	sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*4;
	SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("Mtr_Jewhead", "Cabanos");
	Group_SetGroupCommander("Mtr_Jewhead", "Cabanos");
	Group_SetAddress("Mtr_Jewhead", "Santacatalina", "quest_ships", "quest_ship_7");
	Group_SetTaskAttack("Mtr_Jewhead", PLAYER_GROUP);
	Group_LockTask("Mtr_Jewhead");
	
	for (int i=1; i<=5; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Catcher_"+i, "citiz_3"+i, "man", "man", 10, SPAIN, -1, true, "quest"));
		FantomMakeCoolSailor(sld, SHIP_TARTANE, "", CANNON_TYPE_NONECANNON, 30, 30, 30);
		SetFantomParamFromRank(sld, 10, true);
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysEnemy = true;
		sld.JewelryGulf = true;
		sld.PearlTartane = true;
		Character_SetAbordageEnable(sld, false);
		Group_AddCharacter("Mtr_Jewwork", "Catcher_"+i);
	}
	Group_SetGroupCommander("Mtr_Jewwork", "Catcher_1");
	Group_SetAddress("Mtr_Jewwork", "Santacatalina", "quest_ships", "quest_ship_5");
	Group_SetTaskRunaway("Mtr_Jewwork", PLAYER_GROUP);
	Group_LockTask("Mtr_Jewwork");
	
	pchar.quest.mtr_jewgulf_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.mtr_jewgulf_AfterBattle.win_condition.l1.group = "Mtr_Jewhead";
	pchar.quest.mtr_jewgulf_AfterBattle.function = "Mtraxx_JewelryAfterBattle";
	
	pchar.quest.mtr_jewgulf_result.win_condition.l1 = "MapEnter";
	pchar.quest.mtr_jewgulf_result.function = "Mtraxx_JewelryResult";
}

void Mtraxx_JewelryAfterBattle(string qName) // уничтожили Кабаньяса
{
	bQuestDisableMapEnter = false;
	Group_DeleteGroup("Mtr_Jewhead");
	DoQuestCheckDelay("sea_victory", 1.5);
	ChangeCharacterNationReputation(pchar, SPAIN, -5);
	ChangeCharacterComplexReputation(pchar, "authority", 3);
	ChangeCharacterComplexReputation(pchar, "nobility", -3);
	ChangeCharacterComplexReputation(pchar, "fame", 3);
	OfficersReaction("bad");
	AddComplexSeaExpToScill(150, 50, 50, 50, 70, 70, 0);
}

void Mtraxx_JewelryResult(string qName) // считаем янтарь
{
	Island_SetReloadEnableGlobal("Santacatalina", true);
	Group_DeleteGroup("Mtr_Jewwork");
	int i = sti(pchar.questTemp.Mtraxx.JewQty);
	if (i < 1)
	{
		AddQuestRecord("Roger_1", "14");
		Mtraxx_TerraxReset(1);
	}
	else
	{
		if (i < 30)
		{
			AddQuestRecord("Roger_1", "15");
			AddQuestUserData("Roger_1", "sQty", FindRussianQtyString(i));
			Mtraxx_TerraxReset(1);
		}
		else
		{
			AddQuestRecord("Roger_1", "16");
			AddQuestUserData("Roger_1", "sQty", FindRussianQtyString(i));
			QuestSetCurrentNode("Terrax", "mtraxx_7");
			pchar.questTemp.Mtraxx = "jewelry_11";
		}
	}
	
}

// Эпизод 2 - Шелковый путь

void Mtraxx_SilkBegin() // 
{
	SetFunctionTimerCondition("Mtraxx_SilkCPVOver", 0, 0, 8, false);
	pchar.quest.mtr_silk_jeffry.win_condition.l1 = "location";
	pchar.quest.mtr_silk_jeffry.win_condition.l1.location = "Nevis";
	pchar.quest.mtr_silk_jeffry.function = "Mtraxx_SilkCreateJeffry";
}

void Mtraxx_SilkCPVOver(string qName) // опоздание к Капстервилю
{
	pchar.quest.mtr_silk_jeffry.over = "yes";
	AddQuestRecord("Roger_2", "2");
	Mtraxx_TerraxReset(2);
}

void Mtraxx_SilkCreateJeffry(string qName) // создаем Джеффри // 3 прогона
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	Group_FindOrCreateGroup("Mtr_Jeffry");
	sld = GetCharacter(NPC_GenerateCharacter("Jeffry", "Jeffry", "man", "man", 25, ENGLAND, -1, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_GALEON_L, "Snake", CANNON_TYPE_CULVERINE_LBS18, 80, 80, 80);
	sld.name = "Geffrey";
	sld.lastname = "Brooke";
	sld.dialog.FileName = "Quest\Roger.c";
	sld.DeckDialogNode = "Jeffry";
	sld.greeting = "captain";
	sld.rank = 28;
	sld.reputation = 15;
	LAi_SetHP(sld, 350, 350);
	SetSelfSkill(sld, 90, 55, 45, 90, 50);
	SetShipSkill(sld, 40, 40, 70, 60, 80, 60, 80, 60, 40);
	SetSPECIAL(sld, 8, 6, 8, 4, 5, 8, 6);
	SetCharacterPerk(sld, "Energaiser");
	SetCharacterPerk(sld, "BasicDefense");
	SetCharacterPerk(sld, "AdvancedDefense");
	SetCharacterPerk(sld, "CriticalHit");
	SetCharacterPerk(sld, "Sliding");
	SetCharacterPerk(sld, "SwordplayProfessional");
	SetCharacterPerk(sld, "Gunman");
	SetCharacterPerk(sld, "GunProfessional");
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "HullDamageUp");
	SetCharacterPerk(sld, "SailsDamageUp");
	SetCharacterPerk(sld, "CrewDamageUp");
	SetCharacterPerk(sld, "CriticalShoot");
	SetCharacterPerk(sld, "CannonProfessional");
	SetCharacterPerk(sld, "BasicBattleState");
	SetCharacterPerk(sld, "AdvancedBattleState");
	SetCharacterPerk(sld, "ShipDefenseProfessional");
	SetCharacterPerk(sld, "Carpenter");
	SetCharacterPerk(sld, "ShipSpeedUp");
	SetCharacterPerk(sld, "ShipTurnRateUp");
	SetCharacterPerk(sld, "StormProfessional");
	SetCharacterPerk(sld, "SailsMan");
	SetCharacterPerk(sld, "LongRangeGrappling");
	SetCharacterPerk(sld, "GrapplingProfessional");
	SetCharacterPerk(sld, "MusketsShoot");
	SetCharacterPerk(sld, "Doctor1");
	SetCharacterPerk(sld, "Doctor2");
	SetCharacterPerk(sld, "BasicCommerce");
	sld.SuperShooter = true;
	RemoveAllCharacterItems(sld, true);
	GiveItem2Character(sld, "blade_15");
	EquipCharacterbyItem(sld, "blade_15");
	GiveItem2Character(sld, "pistol6");
	EquipCharacterbyItem(sld, "pistol6");
	LAi_SetCharacterUseBullet(sld, "cartridge");
    TakeNItems(sld, "cartridge", 50);
	TakeNItems(sld, "potion2", 3);
	sld.cirassId = Items_FindItemIdx("cirass2");
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "pirate";
	LAi_SetImmortal(sld, true);
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable  = true;
	Group_AddCharacter("Mtr_Jeffry", "Jeffry");
	Group_SetGroupCommander("Mtr_Jeffry", "Jeffry");
	Group_SetAddress("Mtr_Jeffry", "Nevis", "quest_ships", "quest_ship_1");
	Group_SetTaskNone("Mtr_Jeffry");
	Group_LockTask("Mtr_Jeffry");
}

void Mtraxx_CreateBilly(string qName) // создаем Билли
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	if (pchar.questTemp.Mtraxx == "fail") return;
	Group_SetAddress("Mtr_Jeffry", "Nevis", "quest_ships", "quest_ship_6"); // переместить судно Джеффри
	Group_FindOrCreateGroup("Mtr_Billi");
	sld = GetCharacter(NPC_GenerateCharacter("Siplyi", "Billy_Pirt", "man", "man", 25, ENGLAND, -1, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_TARTANE, "Fly Fish", CANNON_TYPE_NONECANNON, 70, 70, 70);
	FantomMakeCoolFighter(sld, 25, 70, 70, "blade_06", "pistol1", "bullet", 150);
	sld.name = "Billy";
	sld.lastname = "Pert";
	sld.dialog.FileName = "Quest\Roger.c";
	sld.DeckDialogNode = "Billy";
	sld.greeting = "";
	LAi_SetHP(sld, 250, 250);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "pirate";
	LAi_SetImmortal(sld, true);
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable  = true;
	sld.ship.HP = makeint(sti(sld.ship.HP)/2);
	Group_AddCharacter("Mtr_Billi", "Siplyi");
	Group_SetGroupCommander("Mtr_Billi", "Siplyi");
	Group_SetAddress("Mtr_Billi", "Jamaica", "quest_ships", "quest_ship_7");
	Group_SetTaskNone("Mtr_Billi");
	Group_LockTask("Mtr_Billi");
}

void Mtraxx_BillySeaTimeOver(string qName) // прозевали баркас Билли в море
{
	sld = characterFromId("Siplyi");
	sld.DontDeskTalk = true;
	sld.lifeday = 0;
	sld = characterFromId("Jeffry");
	sld.lifeday = 0;
	AddQuestRecord("Roger_2", "10-1"); // правки прогона 3
	Mtraxx_TerraxReset(2);
}

void Mtraxx_BillyTimeOver(string qName) // опоздание к Билли на суше
{
	sld = characterFromId("Siplyi");
	sld.DontDeskTalk = true;
	sld.lifeday = 0;
	pchar.quest.mtr_billy_coast.over = "yes";
	if (GetCharacterIndex("Siplyi1") != -1)
	{
		sld = characterFromId("Siplyi1");
		sld.lifeday = 0;
		LAi_CharacterDisableDialog(sld);
	}
	sld = characterFromId("Jeffry");
	sld.lifeday = 0;
	AddQuestRecord("Roger_2", "10");
	Mtraxx_TerraxReset(2);
}

void Mtraxx_BillyOnCoast(string qName) // Билли на берегу
{
	if (pchar.questTemp.Mtraxx == "fail") return;
	sld = GetCharacter(NPC_GenerateCharacter("Siplyi1", "Billy_Pirt", "man", "man", 25, ENGLAND, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 25, 70, 70, "blade_06", "pistol1", "bullet", 150);
	sld.name = "Билли";
	sld.lastname = "Пирт";
	sld.dialog.FileName = "Quest\Roger.c";
	sld.dialog.currentnode = "Billy_9";
	sld.greeting = "";
	LAi_SetHP(sld, 250, 250);
	LAi_SetWarriorType(sld);
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "shore35", "goto", "goto1");
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
}

void Mtraxx_BillyTakeShip() // корабельный обмен
{
	ref sld, chr;
	aref arTo, arFrom;
	sld = CharacterFromID("Siplyi");
	chr = CharacterFromID(pchar.GenQuest.CompanionId);			
	DeleteAttribute(sld,"ship");
	sld.ship = "";
	makearef(arTo, sld.ship);
	makearef(arFrom, chr.Ship);
	CopyAttributes(arTo, arFrom);
	SeaAI_SetOfficer2ShipAfterAbordage(sld, chr); 			
	DeleteAttribute(chr,"ship"); // трем корабль
	chr.ship.type = SHIP_NOTUSED;
	RemoveCharacterCompanion(pchar, chr);
	AddPassenger(pchar, chr, false);
	SetCharacterRelationBoth(sti(sld.index), GetMainCharacterIndex(), RELATION_FRIEND);
	SetCrewQuantityFull(sld);
	DeleteAttribute(pchar,"GenQuest.CompanionId");
	RemoveCharacterGoods(pchar, GOOD_SHIPSILK, 1);
	sld.lifeday = 1;
	pchar.quest.mtr_silk_billyremove.win_condition.l1 = "MapEnter";
	pchar.quest.mtr_silk_billyremove.function = "Mtraxx_SilkRemoveBilly";
}

void Mtraxx_SilkRemoveBilly(string qName) // удаляем Билли
{
	sld = CharacterFromID("Siplyi");
	sld.lifeday = 0;
	Group_DeleteGroup("Mtr_Billi");
}

void Mtraxx_SilkCreateSmuggler(string qName) // подгружаем Утрехт, если ГГ в море
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	if (pchar.questTemp.Mtraxx == "fail") return;
	log_info("The Utrecht is on the horizon!");
	PlaySound("interface\notebook.wav");
	PlaySound("interface\_EvEnemy0.wav");
	pchar.quest.mtr_silk_smuggler_over.over = "yes";
	Island_SetReloadEnableGlobal("Jamaica", false);//на остров нельзя
	bQuestDisableMapEnter = true;//на карту тоже
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+2;
	if (iRank > 45) iRank = 45;
	Group_FindOrCreateGroup("Mtr_Utreht");
	sld = GetCharacter(NPC_GenerateCharacter("Cap_Utreht", "mercen_19", "man", "man", iRank, ENGLAND, -1, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_BRIGANTINE, "Utrecht", CANNON_TYPE_CULVERINE_LBS18, 50, 50, 50);
	FantomMakeCoolFighter(sld, iRank, 50, 50, "blade_13", "pistol5", "bullet", 100);
	sld.name = "Joachim";
	sld.lastname = "Gusen";
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Coastal_Captain = true; // правки прогона 3
	DeleteAttribute(sld, "SaveItemsForDead");
	sld.Ship.Mode = "pirate";
	SetSailsColor(sld, 2);
	sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*4;
	sld.Ship.Crew.Exp.Sailors = 60+MOD_SKILL_ENEMY_RATE*4;
	sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*4;
	sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*4;
	if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
	SetCharacterGoods(sld, GOOD_SHIPSILK, 80);
	Group_AddCharacter("Mtr_Utreht", "Cap_Utreht");
	Group_SetGroupCommander("Mtr_Utreht", "Cap_Utreht");
	Group_SetTaskRunaway("Mtr_Utreht", PLAYER_GROUP);
	Group_LockTask("Mtr_Utreht");
	DoQuestFunctionDelay("Mtraxx_SilkSetSmuggler", 3.0);
	
	pchar.quest.mtr_silksmuggler_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.mtr_silksmuggler_AfterBattle.win_condition.l1.group = "Mtr_Utreht";
	pchar.quest.mtr_silksmuggler_AfterBattle.function = "Mtraxx_SilkSmugglerAfterBattle";
}

void Mtraxx_SilkSetSmuggler(string qName) // подгружаем Утрехт
{
	Sea_LoginGroupCurrentSea("Mtr_Utreht");
}

void Mtraxx_SilkSmugglerAfterBattle(string qName) // после боя с Утрехт
{
	Group_DeleteGroup("Mtr_Utreht");
	DeleteAttribute(pchar, "questTemp.Mtraxx.watcher");
	DeleteAttribute(pchar, "questTemp.Mtraxx.check");
	Island_SetReloadEnableGlobal("Jamaica", true);
	pchar.quest.mtr_silk_shore.win_condition.l1 = "location";
	pchar.quest.mtr_silk_shore.win_condition.l1.location = "shore36";
	pchar.quest.mtr_silk_shore.function = "Mtraxx_SilkInShore";
	AddQuestRecord("Roger_2", "11");
	pchar.questTemp.Mtraxx = "silk_9";
	AddComplexSeaExpToScill(100, 100, 100, 100, 100, 100, 0);
	ChangeCharacterComplexReputation(pchar, "nobility", -2);
	ChangeCharacterComplexReputation(pchar, "authority", 3);
}

void Mtraxx_SilkInShore(string qName) // высадились в бухте
{
	if (pchar.questTemp.Mtraxx == "fail") return;
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+10;
	if (iRank > 50) iRank = 50;
	pchar.GenQuest.Hunter2Pause = true;
	bQuestDisableMapEnter = false;
	ref rItm = ItemsFromID("fire");
	rItm.shown = true;
	rItm.startLocation = "shore36";
	rItm.startLocator = "goto7";
	CreateFireParticles("goto", "goto7");
	if (CheckAttribute(pchar, "questTemp.Mtraxx.Silkfail"))
	{
		AddQuestRecord("Roger_2", "12");
		DeleteAttribute(pchar, "questTemp.Mtraxx.Silkfail");
		Mtraxx_TerraxReset(2);
	}
	else
	{
		LAi_LocationFightDisable(&Locations[FindLocation("shore36")], true);//запретить драться
		for (int i=1; i<=4; i++)
		{
			sld = GetCharacter(NPC_GenerateCharacter("Mtr_acceptor_"+i, "citiz_2"+i, "man", "man", 20, ENGLAND, -1, true, "quest"));
			FantomMakeCoolFighter(sld, iRank, 50, 50, "blade_0"+(5+i), "pistol1", "bullet", iRank*5);
			sld.dialog.FileName = "Quest\Roger.c";
			sld.dialog.currentnode = "Mtr_acceptor";
			sld.greeting = "";
			LAi_SetStayType(sld);
			if (i > 1)
			{
				ChangeCharacterAddressGroup(sld, "shore36", "goto", "goto"+(10+i));
				LAi_CharacterDisableDialog(sld);
			}
			else 
			{
				ChangeCharacterAddressGroup(sld, "shore36", "goto", "goto6");
				sld.talker = 9;
			}
		}
	}
}

void Mtraxx_SilkSmugglerOver(string qName) // не нашли Утрехт
{
	if (pchar.questTemp.Mtraxx == "fail") return;
	log_Testinfo("Опоздали!");
	if (sti(pchar.questTemp.Mtraxx.month) < 1)
	{
		log_Testinfo("На второй круг");
		pchar.questTemp.Mtraxx.month = 1;
		int hour = 1+rand(3);
		int day = 13+rand(2);
		pchar.quest.mtr_silk_smuggler.win_condition.l1 = "Timer";
		pchar.quest.mtr_silk_smuggler.win_condition.l1.date.hour  = hour;
		pchar.quest.mtr_silk_smuggler.win_condition.l1.date.day   = day;
		pchar.quest.mtr_silk_smuggler.win_condition.l1.date.month = GetAddingDataMonth(0, 1, 0);
		pchar.quest.mtr_silk_smuggler.win_condition.l1.date.year  = GetAddingDataYear(0, 1, 0);
		pchar.quest.mtr_silk_smuggler.win_condition.l2 = "location";
		pchar.quest.mtr_silk_smuggler.win_condition.l2.location = "Jamaica";
		pchar.quest.mtr_silk_smuggler.function = "Mtraxx_SilkCreateSmuggler";
		// таймер
		pchar.quest.mtr_silk_smuggler_over.win_condition.l1 = "Timer";
		pchar.quest.mtr_silk_smuggler_over.win_condition.l1.date.hour  = hour+2;
		pchar.quest.mtr_silk_smuggler_over.win_condition.l1.date.day   = day;
		pchar.quest.mtr_silk_smuggler_over.win_condition.l1.date.month = GetAddingDataMonth(0, 1, 0);
		pchar.quest.mtr_silk_smuggler_over.win_condition.l1.date.year  = GetAddingDataYear(0, 1, 0);
		pchar.quest.mtr_silk_smuggler_over.function = "Mtraxx_SilkSmugglerOver";
	}
	else
	{
		pchar.quest.mtr_silk_smuggler_over.win_condition.l1 = "Timer";
		pchar.quest.mtr_silk_smuggler_over.win_condition.l1.date.hour  = 6;
		pchar.quest.mtr_silk_smuggler_over.win_condition.l1.date.day   = 15;
		pchar.quest.mtr_silk_smuggler_over.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 0);
		pchar.quest.mtr_silk_smuggler_over.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 0);
		pchar.quest.mtr_silk_smuggler_over.function = "Mtraxx_SilkSmugglerFail";
	}
}

void Mtraxx_SilkSmugglerFail(string qName) // провал по Утрехту
{
	pchar.quest.Mtraxx_BillyTimeOver.over = "yes";
	AddQuestRecord("Roger_2", "13");
	Mtraxx_TerraxReset(2);
}

void Mtraxx_SilkTimeOver(string qName) // вышли 2 месяца
{
	if (pchar.questTemp.Mtraxx == "fail") return;
	if (pchar.questTemp.Mtraxx == "silk_10")
	{
		AddQuestRecord("Roger_2", "16");
		SetFunctionTimerCondition("Mtraxx_SilkTimeLateAll", 0, 0, 10, false);
		pchar.questTemp.Mtraxx.SilkLate = "true";
		pchar.questTemp.Mtraxx = "silk_15"; // к Тираксу
		QuestSetCurrentNode("Terrax", "mtraxx_12");
		// прячем Джеффри
		sld = characterFromId("Jeffry");
		sld.DontDeskTalk = true;
		SetFunctionTimerCondition("Mtraxx_SilkHideJeffry", 0, 0, 1, false);
	}
	else
	{
		sld = characterFromId("Jeffry");
		sld.DontDeskTalk = true;
		sld.lifeday = 0;
		AddQuestRecord("Roger_2", "18");
		Mtraxx_TerraxReset(2);
	}
}

void Mtraxx_SilkTimeLateAll(string qName) // опоздали полностью
{
	DeleteAttribute(pchar, "questTemp.Mtraxx.SilkLate");
	AddQuestRecord("Roger_2", "17");
	Mtraxx_TerraxReset(2);
}

void Mtraxx_CargoSilk() // выгрузка шелка
{
	SetLaunchFrameFormParam("One hour later..."+ NewStr() +"The silk was unloaded to the buyer", "", 0, 5);
	LaunchFrameForm();
	WaitDate("", 0, 0, 0, 1, 10); //крутим время
	RecalculateJumpTable();
	DoQuestFunctionDelay("Mtraxx_CargoSilkExit", 5.5);
}

void Mtraxx_CargoSilkExit(string qName) // расчет
{
	int iQty = GetSquadronGoods(pchar, GOOD_SHIPSILK);
	RemoveCharacterGoods(pchar, GOOD_SHIPSILK, iQty);
	AddMoneyToCharacter(pchar, iQty*2500);
	sld = characterFromId("Mtr_acceptor_1");
	sld.dialog.currentnode = "Mtr_acceptor_5";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", 1.0, -1);
}

void Mtraxx_CargoSilkWin() // чистим покупателей
{
	for (int i=1; i<=4; i++)
	{
		sld = characterFromId("Mtr_acceptor_"+i);
		sld.lifeday = 0;
		LAi_CharacterDisableDialog(sld);
	}
	pchar.quest.mtr_cargosilk_clear.win_condition.l1 = "ExitFromLocation";
	pchar.quest.mtr_cargosilk_clear.win_condition.l1.location = pchar.location;
	pchar.quest.mtr_cargosilk_clear.function = "Mtraxx_CargoSilkClear";
}

void Mtraxx_CargoSilkClear(string qName) // чистим покупателей
{
	LAi_LocationFightDisable(&Locations[FindLocation("shore36")], false);
	ref rItm = ItemsFromID("fire");
	rItm.shown = false;
	AddQuestRecord("Roger_2", "15");
	pchar.questTemp.Mtraxx = "silk_10"; // покупатель найден
	sld = characterFromId("Jeffry");
	sld.DeckDialogNode = "Jeffry_9";
}

void Mtraxx_SilkSmugglerPatrol(string qName) // сдали губеру
{
	pchar.questTemp.Mtraxx = "silk_12";
}

void Mtraxx_SilkPay(string qName) // 
{
	QuestSetCurrentNode("Terrax", "mtraxx_16");
}

void Mtraxx_SilkPayLate(string qName) // 
{
	QuestSetCurrentNode("Terrax", "mtraxx_22");
}

void Mtraxx_SilkHideJeffry(string qName) // прячем Джеффри
{
	Group_SetAddress("Mtr_Jeffry", "Jamaica", "quest_ships", "quest_ship_7");
	Group_DelCharacter("Mtr_Jeffry", "Jeffry");
	Group_DeleteGroup("Mtr_Jeffry");
}

void Mtraxx_SilkTradeOver(string qName) // 
{
	DeleteAttribute(pchar, "questTemp.Mtraxx.SilkTrade");
}

// эпизод 3: Жаркое солнце Маракайбо

void Mtraxx_PlantBegin() // старт плантации
{
	SetFunctionTimerCondition("Mtraxx_PlantLate", 0, 0, 30, false);
	pchar.quest.mtr_plant_pelly.win_condition.l1 = "location";
	pchar.quest.mtr_plant_pelly.win_condition.l1.location = "Barbados";
	pchar.quest.mtr_plant_pelly.function = "Mtraxx_PlantCreatePelly";
	pchar.questTemp.Mtraxx = "plant_1";
}

void Mtraxx_PlantLate(string qName) // опоздали
{
	pchar.quest.mtr_plant_pelly.over = "yes";
	AddQuestRecord("Roger_3", "2");
	Mtraxx_TerraxReset(3);
}

void Mtraxx_PlantCreatePelly(string qName) // ставим Пелли
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	pchar.quest.Mtraxx_PlantLate.over = "yes";
	Island_SetReloadEnableGlobal("Barbados", false);
	bQuestDisableMapEnter = true;
	pchar.GenQuest.MapClosedNoBattle = true;
	Group_FindOrCreateGroup("PellyGroup");
	Group_SetType("PellyGroup", "pirate");//тип группы
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+10;
	if (iRank > 50) iRank = 50;
	sld = GetCharacter(NPC_GenerateCharacter("Pelly_sea", "Tesak", "man", "man", iRank, ENGLAND, -1, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_BARKENTINE, "Moray", CANNON_TYPE_CANNON_LBS16, 65, 65, 65);
	FantomMakeCoolFighter(sld, iRank, 65, 65, "blade_06", "pistol3", "grapeshot", 200);
	sld.name = "Paul";
	sld.lastname = "Chant";
	sld.dialog.FileName = "Quest\Roger.c";
	sld.DeckDialogNode = "Pelly";
	sld.greeting = "town_pirate";
	sld.rank = 25;
	sld.reputation = 10;
	LAi_SetHP(sld, 450, 450);
	SetSelfSkill(sld, 50, 90, 55, 90, 50);
	SetShipSkill(sld, 30, 40, 70, 70, 66, 50, 90, 50, 50);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	LAi_SetImmortal(sld, true);
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true;
	sld.Ship.Mode = "pirate";
	SetSailsColor(sld, 8);
	sld.ship.Crew.Morale = 70;
	sld.Ship.Crew.Exp.Sailors = 70;
	sld.Ship.Crew.Exp.Cannoners = 70;
	sld.Ship.Crew.Exp.Soldiers = 100;
	SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter("PellyGroup", "Pelly_sea");
	Group_SetGroupCommander("PellyGroup", "Pelly_sea");
	Group_SetTaskNone("PellyGroup");
	Group_SetAddress("PellyGroup", "Barbados", "quest_ships", "quest_ship_5");
	Group_LockTask("PellyGroup");
}

void Mtraxx_PlantContinue() // в Маракайбо
{
	SetFunctionTimerCondition("Mtraxx_PlantLate_1", 0, 0, 15, false);
	Island_SetReloadEnableGlobal("Barbados", true);
	bQuestDisableMapEnter = false;
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	Group_SetTaskRunAway("PellyGroup", PLAYER_GROUP);
	Group_LockTask("PellyGroup");
	pchar.quest.mtr_plant_maracaibo.win_condition.l1 = "location";
	pchar.quest.mtr_plant_maracaibo.win_condition.l1.location = "Maracaibo";
	pchar.quest.mtr_plant_maracaibo.function = "Mtraxx_PlantMaracaiboArrive";
	pchar.quest.mtr_plant_pelly1.win_condition.l1 = "ExitFromLocation";
	pchar.quest.mtr_plant_pelly1.win_condition.l1.location = pchar.location;
	pchar.quest.mtr_plant_pelly1.function = "Mtraxx_PlantPellyRun";
	pchar.questTemp.Mtraxx = "plant_2";
}

void Mtraxx_PlantLate_1(string qName) // 
{
	pchar.quest.mtr_plant_pelly1.over = "yes";
	pchar.quest.Mtraxx_PlantPellyArrive.over = "yes";
	AddQuestRecord("Roger_3", "4");
	Mtraxx_TerraxReset(3);
	Mtraxx_PlantPellyClear();
} 

void Mtraxx_PlantPellyRun(string qName) // 
{
	SetFunctionTimerCondition("Mtraxx_PlantPellyArrive", 0, 0, 6+rand(2), false);
	Group_SetAddress("PellyGroup", "Curacao", "quest_ships", "quest_ship_6"); 
} 

void Mtraxx_PlantPellyArrive(string qName) // 3 прогона
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	Group_SetAddress("PellyGroup", "Maracaibo", "quest_ships", "quest_ship_4");
	Group_SetTaskNone("PellyGroup");
	Group_LockTask("PellyGroup");
	ref loc = &Locations[FindLocation("shore37")];
	loc.DisableEncounters = true; //энкаутеры закрыть
	ref rItm = ItemsFromID("fire");
	rItm.shown = true;
	rItm.startLocation = "shore37";
	rItm.startLocator = "fire";
	loc.fire = true;
	LAi_LocationFightDisable(&Locations[FindLocation("shore37")], true);//запретить драться
	for (int i=1; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Pelly_sailor_"+i, "citiz_2"+i, "man", "man", 25, ENGLAND, -1, true, "quest"));
		FantomMakeCoolFighter(sld, 25, 50, 50, "blade_0"+(5+i), "pistol1", "bullet", 100);
		LAi_SetWarriorType(sld);
		LAi_CharacterDisableDialog(sld);
		ChangeCharacterAddressGroup(sld, "shore37", "goto", "goto"+i);
	}
	// клон Пелли - сухопутный
	sld = GetCharacter(NPC_GenerateCharacter("Pelly", "Tesak", "man", "man", 25, PIRATE, -1, false, "quest"));
	sld.name = "Paul";
	sld.lastname = "Chant";
	sld.greeting = "town_pirate";
	sld.Dialog.Filename = "Quest\Roger.c";
	sld.dialog.currentnode = "Pelly_7";
	sld.rank = 25;
	sld.reputation = 10;
	LAi_SetHP(sld, 450, 450);
	SetSelfSkill(sld, 50, 90, 55, 90, 50);
	SetShipSkill(sld, 30, 40, 70, 70, 66, 50, 90, 50, 50);
	SetSPECIAL(sld, 10, 6, 10, 3, 3, 10, 5);
	SetCharacterPerk(sld, "Energaiser");
	SetCharacterPerk(sld, "BasicDefense");
	SetCharacterPerk(sld, "AdvancedDefense");
	SetCharacterPerk(sld, "CriticalHit");
	SetCharacterPerk(sld, "HardHitter");
	SetCharacterPerk(sld, "Sliding");
	SetCharacterPerk(sld, "BladeDancer");
	SetCharacterPerk(sld, "SwordplayProfessional");
	SetCharacterPerk(sld, "Gunman");
	SetCharacterPerk(sld, "GunProfessional");
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "HullDamageUp");
	SetCharacterPerk(sld, "SailsDamageUp");
	SetCharacterPerk(sld, "CrewDamageUp");
	SetCharacterPerk(sld, "CriticalShoot");
	SetCharacterPerk(sld, "CannonProfessional");
	SetCharacterPerk(sld, "BasicBattleState");
	SetCharacterPerk(sld, "AdvancedBattleState");
	SetCharacterPerk(sld, "ShipDefenseProfessional");
	SetCharacterPerk(sld, "Carpenter");
	SetCharacterPerk(sld, "ShipSpeedUp");
	SetCharacterPerk(sld, "ShipTurnRateUp");
	SetCharacterPerk(sld, "StormProfessional");
	SetCharacterPerk(sld, "WindCatcher");
	SetCharacterPerk(sld, "LongRangeGrappling");
	SetCharacterPerk(sld, "GrapplingProfessional");
	SetCharacterPerk(sld, "MusketsShoot");
	SetCharacterPerk(sld, "Doctor1");
	SetCharacterPerk(sld, "Doctor2");
	SetCharacterPerk(sld, "BasicCommerce");
	sld.SuperShooter = true;
	RemoveAllCharacterItems(sld, true);
	GiveItem2Character(sld, "blade_10");
	EquipCharacterbyItem(sld, "blade_10");
	GiveItem2Character(sld, "pistol4");
	EquipCharacterbyItem(sld, "pistol4");
	LAi_SetCharacterUseBullet(sld, "cartridge");
    TakeNItems(sld, "cartridge", 50);
	TakeNItems(sld, "potion2", 10);
	sld.cirassId = Items_FindItemIdx("cirass1");
	LAi_SetStayType(sld);
	LAi_CharacterEnableDialog(sld);
	sld.dialog.currentnode = "Pelly_7";
	ChangeCharacterAddressGroup(sld, "shore37", "goto", "goto6");
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER); // 3 прогона
} 

void Mtraxx_PlantPellyClear() // чистим Пелли
{
	LAi_LocationFightDisable(&Locations[FindLocation("shore37")], false);//разрешить драться
	Group_DeleteGroup("PellyGroup");
	sld = characterFromId("Pelly_sea");
	sld.lifeday = 0;
	if (GetCharacterIndex("Pelly") != -1)
	{
		sld = characterFromId("Pelly");
		sld.lifeday = 0;
	}
	for (int i=1; i<=4; i++)
	{
		if (GetCharacterIndex("Pelly_sailor_"+i) != -1)
		{
			sld = characterFromId("Pelly_sailor_"+i);
			sld.lifeday = 0;
		}
	}
	ref loc = &Locations[FindLocation("shore37")];
	loc.DisableEncounters = false;
	ref rItm = ItemsFromID("fire");
	rItm.shown = false;
	DeleteAttribute(loc, "fire");
} 

void Mtraxx_PlantMaracaiboArrive(string qName) // прибыли к Маракайбо
{
	pchar.GenQuest.HunterLongPause = true;
	pchar.quest.Mtraxx_PlantLate_1.over = "yes";
	pchar.questTemp.Mtraxx = "plant_2";
	SetFunctionTimerCondition("Mtraxx_PlantPrepareTimeOver", 0, 0, 10, false);
	// готовим плантацию Маракайбо. Управляющий
	sld = GetCharacter(NPC_GenerateCharacter("Mtr_plantation_boss", "citiz_20", "man", "man", 15, SPAIN, -1, false, "soldier"));
	SetFantomParamFromRank(sld, 15, true);
	sld.Dialog.Filename = "Plantation_dialog.c";
	sld.Dialog.currentnode = "plantator";
	RemoveAllCharacterItems(sld, true);
	LAi_SetLoginTime(sld, 6.0, 22.99);
	ChangeCharacterAddressGroup(sld, "Maracaibo_Plantation_Sp1", "barmen", "stay");
	LAi_SetOwnerType(sld);
	LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
	// типа пленные пираты, 5 штук
	for (int i=4; i<=8; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Mtr_plantation_prisoner_"+i, "citiz_4"+i, "man", "man", 15, PIRATE, 30, false, "soldier"));
		SetFantomParamFromRank(sld, 15, true);
		sld.Dialog.Filename = "Plantation_dialog.c";
		sld.Dialog.currentnode = "pirate_slave";
		sld.greeting = ""; 
		LAi_SetLoginTime(sld, 6.0, 22.99);
		RemoveAllCharacterItems(sld, true);
		ChangeCharacterAddressGroup(sld, "Maracaibo_Plantation", "goto", "goto"+i);
		LAi_SetCitizenType(sld);
		LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
	}
}

void Mtraxx_PlantPrepareTimeOver(string qName) // стал заниматься фигней вместо дела
{
	sld = characterFromId("Mtr_plantation_boss");
	sld.lifeday = 0;
	if (GetCharacterIndex("Mrt_Rocur") != -1)
	{
		sld = characterFromId("Mrt_Rocur");
		sld.lifeday = 0;
	}
	if (GetCharacterIndex("Mrt_Rocur_clone") != -1)
	{
		sld = characterFromId("Mrt_Rocur_clone");
		sld.lifeday = 0;
	}
	AddQuestRecord("Roger_3", "4-1");
	Mtraxx_PlantPellyClear();
	Mtraxx_TerraxReset(3);
}

void Mtraxx_PlantSetMaxRocur() // ставим Жана Пикара
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	sld = GetCharacter(NPC_GenerateCharacter("Mrt_Rocur", "Jan_Slave", "man", "man", 20, PIRATE, -1, false, "soldier"));
	sld.name = "Jean";
	sld.lastname = "Picard";
	sld.Dialog.Filename = "Quest\Roger.c";
	sld.Dialog.currentnode = "rocur";
	sld.greeting = ""; 
	sld.rank = 20;
	sld.reputation = 30;
	LAi_SetHP(sld, 300.0, 300.0);
	SetSPECIAL(sld, 7, 6, 8, 6, 8, 7, 5);
	SetSelfSkill(sld, 45, 85, 55, 50, 55);
    SetShipSkill(sld, 50, 60, 60, 60, 70, 60, 70, 60, 55);
	SetCharacterPerk(sld, "Energaiser");
	SetCharacterPerk(sld, "BasicDefense");
	SetCharacterPerk(sld, "AdvancedDefense");
	SetCharacterPerk(sld, "CriticalHit");
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "Sliding");
	SetCharacterPerk(sld, "Gunman");
	SetCharacterPerk(sld, "ShipSpeedUp");
	SetCharacterPerk(sld, "ShipTurnRateUp");
	SetCharacterPerk(sld, "StormProfessional");
	SetCharacterPerk(sld, "HullDamageUp");
	SetCharacterPerk(sld, "SailsDamageUp");
	SetCharacterPerk(sld, "CrewDamageUp");
	SetCharacterPerk(sld, "CriticalShoot");
	SetCharacterPerk(sld, "BasicBattleState");
	SetCharacterPerk(sld, "Doctor1");
	SetCharacterPerk(sld, "BasicCommerce");
	SetCharacterPerk(sld, "AdvancedCommerce");
	sld.SuperShooter = true;
	LAi_SetImmortal(sld, true);
	LAi_SetLoginTime(sld, 6.0, 22.99);
	RemoveAllCharacterItems(sld, true);
	ChangeCharacterAddressGroup(sld, "Maracaibo_Plantation", "goto", "goto10");
	LAi_SetCitizenType(sld);
	LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
}

void Mtraxx_PlantMakeMaxRocurClone() // ставим клон Жана Пикара
{
	sld = GetCharacter(NPC_GenerateCharacter("Mrt_Rocur_clone", "Jan_Slave", "man", "man", 20, PIRATE, -1, false, "soldier"));
	SetFantomParamFromRank(sld, 15, true);
	sld.name = "Jean";
	sld.lastname = "Picard";
	sld.Dialog.Filename = "Quest\Roger.c";
	sld.Dialog.currentnode = "rocur_4";
	sld.greeting = "";
	sld.rank = 20;
	LAi_SetHP(sld, 300.0, 300.0);
	LAi_SetImmortal(sld, true);
	LAi_SetLoginTime(sld, 23.0, 5.99);
	RemoveAllCharacterItems(sld, true);
	ChangeCharacterAddressGroup(sld, "Maracaibo_Plantation_S2", "goto", "goto1");
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
}

void Mtraxx_PlantCheckShoreBox() // анализ содержимого сундука
{
	int iBlade, iGun, iMushket, iPotion, iBullet, iGunpowder, iCartridge, iShot;
	iBlade = 0;
	string sBlade;
	if (!CheckAttribute(pchar, "questTemp.Mtraxx.Weapon.Blade") && GetSquadronGoods(pchar, GOOD_WEAPON) >= 30)
	{
		PlaySound("interface\notebook.wav");
		RemoveCharacterGoods(pchar, GOOD_WEAPON, 30);
		pchar.questTemp.Mtraxx.Weapon.Blade = "true";
		int n = Findlocation("Shore37");
		locations[n].private1.items.Bunch = 1;
		log_info("30 pieces of cold arms has been taken from the ship's arsenal");
		log_info("Gathered cold arms - 30 pieces");
	}
	if (CheckAttribute(pchar, "questTemp.Mtraxx.Weapon.Blade"))
	{
		DeleteAttribute(pchar, "questTemp.Mtraxx.Weapon.NoBlade");
		iBlade = CheckItemInBox("Bunch", "Shore37", "private1");
		if (iBlade > 0) log_info("Gathered cold arms - 30 pieces");
		else 
		{
			pchar.questTemp.Mtraxx.Weapon.NoBlade = "true";
			log_info("No cold arms");
		}
	}
	iGun = 0;
	iGun = iGun+CheckItemInBox("pistol1", "Shore37", "private1");
	log_info("Gathered pistols - "+FindRussianQtyString(iGun)+"");
	pchar.questTemp.Mtraxx.Weapon.Gun = iGun;
	iMushket = 0;
	iMushket = iMushket+CheckItemInBox("mushket1", "Shore37", "private1");
	log_info("Gathered muskets - "+FindRussianQtyString(iMushket)+"");
	pchar.questTemp.Mtraxx.Weapon.Mushket = iMushket;
	iPotion = 0;
	iPotion = iPotion+CheckItemInBox("potion1", "Shore37", "private1");
	iPotion = iPotion+CheckItemInBox("potion2", "Shore37", "private1");
	log_info("Gathered healing potions - "+FindRussianQtyString(iPotion)+"");
	pchar.questTemp.Mtraxx.Weapon.Potion = iPotion;
	iBullet = 0;
	iBullet = iBullet+CheckItemInBox("bullet", "Shore37", "private1");
	iGunpowder = 0;
	iGunpowder = iGunpowder+CheckItemInBox("Gunpowder", "Shore37", "private1");
	iCartridge = 0;
	iCartridge = iCartridge+CheckItemInBox("Cartridge", "Shore37", "private1");
	if (iBullet > iGunpowder || iBullet == iGunpowder) iShot = iGunpowder;
	else iShot = iBullet;
	iShot = iShot+iCartridge;
	log_info("Gathered supplies for "+iShot+" shots");
	pchar.questTemp.Mtraxx.Weapon.Shot = iShot;
}

void Mtraxx_PlantShoreBoxComplete() // сбор оружия окончен
{
	DeleteAttribute(pchar, "questTemp.Mtraxx.Ammo");
	pchar.questTemp.Mtraxx = "plant_5";
	AddQuestRecord("Roger_3", "8");
	// закрыть сундук
	ref loc = &Locations[FindLocation("Shore37")];
	DeleteAttribute(loc, "private1.opened");
	loc.private1.closed = true;
}

void Mtraxx_PlantFindRocurDay(string qName) // ищем Жана Пикара днем
{
	chrDisableReloadToLocation = true;
	sld = characterFromId("Mrt_Rocur");
	LAi_CharacterEnableDialog(sld);
	sld.dialog.currentnode = "rocur_25";
}	

void Mtraxx_SeekWeaponOver(string qName) // истек месяц на сбор оружия
{
	DeleteAttribute(pchar, "questTemp.Mtraxx.Weapon");
	pchar.quest.mtraxx_plant_goods.over = "yes";
	DeleteAttribute(pchar, "GenQuest.CannotWait");
	sld = characterFromId("Mtr_plantation_boss");
	sld.lifeday = 0;
	sld = characterFromId("Mrt_Rocur");
	sld.lifeday = 0;
	sld = characterFromId("Mrt_Rocur_clone");
	sld.lifeday = 0;
	AddQuestRecord("Roger_3", "16");
	Mtraxx_PlantPellyClear();
	Mtraxx_TerraxReset(3);
}	
	
void Mtraxx_PlantWaitDay(string qName) // крутим время до 21 ч следующего дня
{
	bDisableCharacterMenu = true;//лочим F2
	pchar.GenQuest.FrameLockEsc = true; // закрыть ESC
	int iTime, iAddTime;
	iTime = sti(environment.time);
	if (iTime >= 21) iAddTime = 24 - iTime;
	if (iTime < 7) iAddTime = 21 - iTime;
	if (iTime >= 7 && iTime < 21) iAddTime = 21 - iTime;
	SetLaunchFrameFormParam("Later, next evening...", "Mtraxx_PlantWaitDay", 0, 5);
	LaunchFrameForm();
	StoreDayUpdate();
	WaitDate("",0,0,1,iAddtime,5);
	RecalculateJumpTable();
	RefreshWeather();
	RefreshLandTime();
}	
	
void Mtraxx_PlantAfterTrading() // поторговали, на выход
{
	bDisableCharacterMenu = false; // разлочим F2
	DeleteAttribute(pchar, "GenQuest.FrameLockEsc");
	chrDisableReloadToLocation = false;
	sld = characterFromId("Mtr_plantation_boss");
	sld.lifeday = 0;
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "houseSp1", "none", "", "", "", 20.0);
	AddQuestRecord("Roger_3", "12");
	pchar.quest.Mtraxx_SeekWeaponOver.over = "yes"; // снимаем таймер на поиск оружия
	pchar.quest.Mtraxx_TimerPlantMutiny.win_condition.l1 = "Timer";
	pchar.quest.Mtraxx_TimerPlantMutiny.win_condition.l1.date.hour  = 0.0;
	pchar.quest.Mtraxx_TimerPlantMutiny.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 1);
	pchar.quest.Mtraxx_TimerPlantMutiny.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 1);
	pchar.quest.Mtraxx_TimerPlantMutiny.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 1);
	pchar.quest.Mtraxx_TimerPlantMutiny.function = "Mtraxx_PlantShoreTimeOver";
	pchar.questTemp.Mtraxx = "plant_8";
}		
	
void Mtraxx_PlantShoreTimeOver(string qName) // не явился в бухту до полуночи либо без корабля
{
	DeleteAttribute(pchar, "questTemp.Mtraxx.Weapon");
	DeleteAttribute(pchar, "GenQuest.CannotWait");
	sld = characterFromId("Mrt_Rocur");
	sld.lifeday = 0;
	sld = characterFromId("Mrt_Rocur_clone");
	sld.lifeday = 0;
	AddQuestRecord("Roger_3", "13");
	Mtraxx_PlantPellyClear();
	Mtraxx_TerraxReset(3);
}	
	
void Mtraxx_PlantPrepareMarch() // к походу
{
	DeleteAttribute(pchar, "GenQuest.CannotWait");//можно мотать время
	pchar.questTemp.Mtraxx = "plant_9";
	LocatorReloadEnterDisable("shore37", "boat", true); // закрыть выход в море
	LocatorReloadEnterDisable("Maracaibo_ExitTown", "reload4", true); // закрыть вход в город
	LocatorReloadEnterDisable("Maracaibo_ExitTown", "reload3_back", true); // закрыть вход в форт
	pchar.quest.Mtraxx_TimerPlantMutiny.over = "yes"; // снимаем таймер на полночь
	int i = 0;
	if (stf(environment.time) < 24.00) i = 1;
	pchar.quest.Mtraxx_enterPlantMutiny.win_condition.l1 = "location";
	pchar.quest.Mtraxx_enterPlantMutiny.win_condition.l1.location = "Maracaibo_Plantation";
	pchar.quest.Mtraxx_enterPlantMutiny.function = "Mtraxx_PlantWaitMutiny";
	
	pchar.quest.Mtraxx_TimerPlantMutiny1.win_condition.l1 = "Timer";
	pchar.quest.Mtraxx_TimerPlantMutiny1.win_condition.l1.date.hour  = 4.0;
	pchar.quest.Mtraxx_TimerPlantMutiny1.win_condition.l1.date.day   = GetAddingDataDay(0, 0, i);
	pchar.quest.Mtraxx_TimerPlantMutiny1.win_condition.l1.date.month = GetAddingDataMonth(0, 0, i);
	pchar.quest.Mtraxx_TimerPlantMutiny1.win_condition.l1.date.year  = GetAddingDataYear(0, 0, i);
	pchar.quest.Mtraxx_TimerPlantMutiny1.function = "Mtraxx_PlantMutinyOver";
	
	pchar.quest.Mtraxx_TimerPlantMutiny2.win_condition.l1 = "locator";
	pchar.quest.Mtraxx_TimerPlantMutiny2.win_condition.l1.location = "Maracaibo_Plantation";
	pchar.quest.Mtraxx_TimerPlantMutiny2.win_condition.l1.locator_group = "quest";
	pchar.quest.Mtraxx_TimerPlantMutiny2.win_condition.l1.locator = "detector3";
	pchar.quest.Mtraxx_TimerPlantMutiny2.function = "Mtraxx_PlantMutinyAlarm";
	
	int n = 26 - sti(environment.time);
	SetLaunchFrameFormParam("Some time later...", "Mtraxx_PlantPrepareMarch", 0, 3);
	LaunchFrameForm();
	StoreDayUpdate();
	WaitDate("",0,0,0,n,5);
	RecalculateJumpTable();
	RefreshWeather();
	RefreshLandTime();
}	

void Mtraxx_PlantWaitMutiny(string qName) // 
{
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.questTemp.Mtraxx.Mutiny = "true";
	sld = characterFromId("Pelly");
	sld.Dialog.currentnode = "Pelly_20";
	ChangeCharacterAddressGroup(sld, "Maracaibo_Plantation", "quest", "detector2");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	for (int i=1; i<=7; i++)
	{
		sld = CharacterFromID("Mtr_PellyPirate_"+i);
		ChangeCharacterAddressGroup(sld, "Maracaibo_Plantation", "reload", "reload2_back");
		LAi_CharacterDisableDialog(sld); // патч 17/1
		LAi_SetActorType(sld);
		LAi_ActorFollowEverywhere(sld, "", -1);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
}	
	
void Mtraxx_PlantMutinyAlarm(string qName) // подошел слишком близко
{
	chrDisableReloadToLocation = false;
	DeleteAttribute(pchar, "questTemp.Mtraxx.Mutiny");
	pchar.quest.Mtraxx_Plant_Mutiny.over = "yes";
	pchar.quest.Mtraxx_TimerPlantMutiny1.over = "yes";
	LocatorReloadEnterDisable("shore37", "boat", false); 
	LocatorReloadEnterDisable("Maracaibo_ExitTown", "reload4", false); 
	LocatorReloadEnterDisable("Maracaibo_ExitTown", "reload3_back", false); 
	LAi_group_AttackGroup("SPAIN_CITIZENS", LAI_GROUP_PLAYER);
	log_info("Plantation is alarmed!");
	SetNationRelation2MainCharacter(SPAIN, RELATION_ENEMY);
	sld = characterFromId("Pelly");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	for (int i=1; i<=7; i++)
	{
		sld = CharacterFromID("Mtr_PellyPirate_"+i);
		sld.lifeday = 0;
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	sld = characterFromId("Mrt_Rocur");
	sld.lifeday = 0;
	sld = characterFromId("Mrt_Rocur_clone");
	sld.lifeday = 0;
	AddQuestRecord("Roger_3", "14");
	Mtraxx_PlantPellyClear();
	Mtraxx_TerraxReset(3);
}		
	
void Mtraxx_PlantMutinyOver(string qName) // не пришел до 4 часов
{
	DeleteAttribute(pchar, "questTemp.Mtraxx.Mutiny");
	pchar.quest.Mtraxx_Plant_Mutiny.over = "yes";
	pchar.quest.Mtraxx_TimerPlantMutiny2.over = "yes";
	pchar.quest.Mtraxx_enterPlantMutiny.over = "yes";
	LocatorReloadEnterDisable("shore37", "boat", false); 
	LocatorReloadEnterDisable("Maracaibo_ExitTown", "reload4", false); 
	LocatorReloadEnterDisable("Maracaibo_ExitTown", "reload3_back", false); 
	Mtraxx_PlantPellyClear();
	for (int i=1; i<=7; i++)
	{
		sld = CharacterFromID("Mtr_PellyPirate_"+i);
		sld.lifeday = 0;
	}
	sld = characterFromId("Mrt_Rocur");
	sld.lifeday = 0;
	sld = characterFromId("Mrt_Rocur_clone");
	sld.lifeday = 0;
	AddQuestRecord("Roger_3", "15");
	Mtraxx_TerraxReset(3);
}		
	
void Mtraxx_PlantMutiny() // восстание на плантации
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	DeleteAttribute(pchar, "questTemp.Mtraxx.Mutiny");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 30 + 2*sti(pchar.rank);
	chrDisableReloadToLocation = true;//закрыть локацию
	pchar.GenQuest.FrameLockEsc = true; // закрыть ESC
	bDisableCharacterMenu = true;//лочим F2
	InterfaceStates.Buttons.Save.enable = false;//запретить сохраняться
	pchar.GenQuest.CannotWait = true;
	SetNationRelation2MainCharacter(SPAIN, RELATION_ENEMY);
	pchar.quest.Mtraxx_TimerPlantMutiny1.over = "yes";
	pchar.quest.Mtraxx_TimerPlantMutiny2.over = "yes";
	PlaySound("VOICE\Russian\EvilPirates01.wav");
	PlaySound("interface\abordage_wining.wav");
	for(int n=0; n<MAX_LOCATIONS; n++)
	{	
		sld = &characters[n];
		if (CheckAttribute(sld, "plantation") && sld.plantation == "patrol" && sld.city == "Maracaibo")
		{
			ChangeCharacterAddressGroup(sld, "none", "", "");
		}
	}
	// Пелли и его бригада
	sld = characterFromId("Pelly");
	LAi_SetCheckMinHP(sld, 10, true, ""); // скрытое бессмертие
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	for (int i=1; i<=7; i++)
	{
		sld = CharacterFromID("Mtr_PellyPirate_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	// Жан Пикар и его команда, все расчеты тут
	int iGun = sti(pchar.questTemp.Mtraxx.Weapon.Gun);
	int iMush = sti(pchar.questTemp.Mtraxx.Weapon.Mushket);
	int iPtn = sti(pchar.questTemp.Mtraxx.Weapon.Potion);
	int iShot = sti(pchar.questTemp.Mtraxx.Weapon.Shot);
	int iMptn = 0;
	// Жан Пикар
	sld = characterFromId("Mrt_Rocur");
	LAi_RemoveLoginTime(sld);
	DoQuestCheckDelay("Mtraxx_PlantJanReady", 15.0);
	GiveItem2Character(sld, "blade_08");
	EquipCharacterbyItem(sld, "blade_08");
	if (iGun > 0 && iShot > 0)
	{
		GiveItem2Character(sld, "pistol1");
		EquipCharacterbyItem(sld, "pistol1");
		TakeNItems(sld, "cartridge", 5);
		LAi_SetCharacterUseBullet(sld, "cartridge");
		iGun--;
	}
	if (iPtn > 0)
	{
		if (iPtn > 90) 
		{
			TakeNItems(sld, "potion2", 3);
			iPtn = iPtn-6;
		}
		else
		{
			if (iPtn > 60) 
			{
				TakeNItems(sld, "potion2", 2);
				iPtn = iPtn-3;
			}
			else
			{
				TakeNItems(sld, "potion2", 1);
				iPtn--;
			}
		}
	}
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	ChangeCharacterAddressGroup(sld, "Maracaibo_Plantation", "goto", "goto14");
	iTotalTemp = 7;
	if (iMush > 0 && iShot >= (iMush*20)) // расчет мушкетов и зарядов к ним
	{
		iTotalTemp = 7 + iMush;
		iShot = iShot - iMush*20;
	}
	if (iGun > 0) // расчет числа пистолей. iGun - то, что в сундуке, Gun - на выдачу, /4
	{
		int Gun = makeint(iGun/4);
		if (Gun < 1) Gun = 1;
		if (Gun > 7) Gun = 7;
	}
	if (iShot > 0) // расчет числа зарядов. Аналогично 
	{
		int Shot = makeint(iShot/4);
		if (Shot < 1) Shot = 1;
	}
	if (iPtn >= 6 && iMush > 0)
	{
		iMptn = 1;
		iPtn = iPtn - 6;
	}
	if (iPtn > 0) // расчет числа зелий. Аналогично 
	{
		int Ptn = makeint(iPtn/4);
		if (Ptn < 1) Ptn = 1;
		if (Ptn > 21) Ptn = 21;
	}
	for (i=1; i<=iTotalTemp; i++)
	{
		if (i > 7) // мушкетеры до 2 шт
		{
			sld = GetCharacter(NPC_GenerateCharacter("Mtr_RocursPirat_"+i, "mush_ctz_"+i, "man", "mushketer", iRank, PIRATE, 0, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl);
			RemoveItems(sld, "cartridge", GetCharacterItem(sld, "cartridge"));
			RemoveItems(sld, "bullet", GetCharacterItem(sld, "bullet"));
			RemoveItems(sld, "gunpowder", GetCharacterItem(sld, "gunpowder"));
			RemoveItems(sld, "potion1", GetCharacterItem(sld, "potion1"));
			RemoveItems(sld, "potion2", GetCharacterItem(sld, "potion2"));
			RemoveItems(sld, "potion3", GetCharacterItem(sld, "potion3"));
			TakeNItems(sld, "cartridge", 20);
			LAi_SetCharacterUseBullet(sld, "cartridge");
			if (iMptn > 0)
			{
				TakeNItems(sld, "potion1", 1);
				TakeNItems(sld, "potion2", 1);
				LAi_SetHP(sld, LAi_GetCharacterHP(sld)+30, LAi_GetCharacterHP(sld)+30);
			}
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Mtr_RocursPirat_"+i, "citiz_4"+(i+2), "man", "man", iRank, PIRATE, 0, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, LinkRandPhrase("blade_03","blade_05","blade_07"), "", "", iScl);
			RemoveItems(sld, "bullet", GetCharacterItem(sld, "bullet"));
			RemoveItems(sld, "gunpowder", GetCharacterItem(sld, "gunpowder"));
			RemoveItems(sld, "potion1", GetCharacterItem(sld, "potion1"));
			RemoveItems(sld, "potion2", GetCharacterItem(sld, "potion2"));
			RemoveItems(sld, "potion3", GetCharacterItem(sld, "potion3"));
			if (Gun > 0)
			{
				GiveItem2Character(sld, "pistol1");
				EquipCharacterbyItem(sld, "pistol1");
				Gun--;
				LAi_SetHP(sld, LAi_GetCharacterHP(sld)+80, LAi_GetCharacterHP(sld)+80);
			}
			if (Shot > 0)
			{
				if (Shot >= 7)
				{
					TakeNItems(sld, "cartridge", makeint(Shot/7));
					LAi_SetCharacterUseBullet(sld, "cartridge");
					Shot = 0;
				}
				else
				{
					TakeNItems(sld, "cartridge", 1);
					LAi_SetCharacterUseBullet(sld, "cartridge");
					Shot--;
				}
			}
			if (Ptn > 0)
			{
				int m = makeint(Ptn/7);
				LAi_SetHP(sld, LAi_GetCharacterHP(sld)+20*m, LAi_GetCharacterHP(sld)+20*m);
				if (Ptn >= 7)
				{
					TakeNItems(sld, "potion2", m);
					Ptn = 0;
				}
				else
				{
					TakeNItems(sld, "potion2", 1);
					Ptn--;
				}
			}
		}
		if (iMush > 0)
		{
			LAi_SetHP(sld, LAi_GetCharacterHP(sld)+20*iMush, LAi_GetCharacterHP(sld)+20*iMush);
		}
		if (i < 4) ChangeCharacterAddressGroup(sld, "Maracaibo_Plantation", "goto", "goto11");
		else
		{
			if (i < 7) ChangeCharacterAddressGroup(sld, "Maracaibo_Plantation", "goto", "goto13");
			else ChangeCharacterAddressGroup(sld, "Maracaibo_Plantation", "goto", "goto12");
		}
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	// ставим испанцев
	LAi_group_Delete("EnemyFight");
	for (i=1; i<=16; i++)
	{
		if (i < 3) // мушкетеры, 2 шт
		{
			sld = GetCharacter(NPC_GenerateCharacter("Mtr_PlantGuard_"+i, "mush_spa_"+i, "man", "mushketer", iRank, SPAIN, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2+30);
			LAi_SetCharacterUseBullet(sld, "cartridge");
			if (MOD_SKILL_ENEMY_RATE > 4) sld.cirassId = Items_FindItemIdx("cirass1");
			ChangeCharacterAddressGroup(sld, "Maracaibo_Plantation", "goto", "goto"+i);
		}
		else
		{
			if (i == 4) // начальник охраны
			{
				sld = GetCharacter(NPC_GenerateCharacter("Mtr_PlantGuard_"+i, "sold_spa_15", "man", "man", iRank+5, SPAIN, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank+5, iScl+10, iScl+10, "topor_04", "pistol4", "bullet", iScl*2+60);
				SetCharacterPerk(sld, "SwordplayProfessional");
				SetCharacterPerk(sld, "Gunman");
				SetCharacterPerk(sld, "GunProfessional");
				sld.cirassId = Items_FindItemIdx("cirass1");
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("Mtr_PlantGuard_"+i, "sold_spa_"+(rand(7)+1), "man", "man", iRank, SPAIN, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", iScl*2);
				if (MOD_SKILL_ENEMY_RATE > 4) sld.cirassId = Items_FindItemIdx("cirass2");
			}
			if (i < 10) ChangeCharacterAddressGroup(sld, "Maracaibo_Plantation", "goto", "goto"+i);
			else ChangeCharacterAddressGroup(sld, "Maracaibo_Plantation", "goto", "goto"+(i-9));
		}
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Mtraxx_PlantMutinyAfterFight");
	LAi_SetFightMode(pchar, true);
	// таймер, для большего эффекта - визуальный
	pchar.questTemp.Mtraxx.PlantMutiny = "true";
	SetShowTimer(300.0);
	log_info("You have 300 seconds before the Spanish will get reinforces from the fort");
	DoQuestFunctionDelay("Terrapin_SetMusic", 0.5);
	pchar.quest.Escort_fail.win_condition.l1 = "NPC_Death";
	pchar.quest.Escort_fail.win_condition.l1.character = "Mrt_Rocur";
	pchar.quest.Escort_fail.function = "Mtraxx_PlantRocurDie";
	
}		

void Mtraxx_PlantRocurDie(string qName) // Пикар дал дуба
{
	pchar.questTemp.Mtraxx.RocurDie = "true";
}

void Mtraxx_PlantExitopen(string qName) // убежали
{
	if (CheckAttribute(pchar, "questTemp.Mtraxx.PlantFort")) return;
	pchar.questTemp.Mtraxx.PlantEscape = "true"; // флаг - убежали
	DeleteAttribute(pchar, "questTemp.Mtraxx.PlantMutiny");
	DoQuestReloadToLocation("Maracaibo_ExitTown", "reload", "reload2", "Mtraxx_PlantEscape");
}

void Mtraxx_PlantMutinyFortAttack() // пришло подкрепление из форта
{
	if (CheckAttribute(pchar, "questTemp.Mtraxx.PlantEscape")) return;
	pchar.questTemp.Mtraxx.PlantFort = "true"; // флаг - пришли из форта
	pchar.quest.mtraxx_plant_exitopen.over = "yes";
	PlaySound("interface\abordage_wining.wav");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+5;
	int iScl = 40 + 2*sti(pchar.rank);
	for (i=1; i<=15; i++)
	{
		if (i < 3) // мушкетеры, 2 шт
		{
			sld = GetCharacter(NPC_GenerateCharacter("Mtr_FortGuard_"+i, "mush_spa_"+i, "man", "mushketer", iRank, SPAIN, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*2+30);
			LAi_SetCharacterUseBullet(sld, "cartridge");
			if (MOD_SKILL_ENEMY_RATE > 4) sld.cirassId = Items_FindItemIdx("cirass1");
			ChangeCharacterAddressGroup(sld, "Maracaibo_Plantation", "reload", "reload1");
		}
		else
		{
			if (i == 3) // офицер
			{
				sld = GetCharacter(NPC_GenerateCharacter("Mtr_FortGuard_"+i, "off_spa_4", "man", "man", iRank+5, SPAIN, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank+5, iScl+10, iScl+10, "topor_04", "pistol4", "bullet", iScl*2+90);
				SetCharacterPerk(sld, "SwordplayProfessional");
				SetCharacterPerk(sld, "Gunman");
				SetCharacterPerk(sld, "GunProfessional");
				sld.cirassId = Items_FindItemIdx("cirass1");
			}
			else
			{
				sld = GetCharacter(NPC_GenerateCharacter("Mtr_FortGuard_"+i, "sold_spa_"+(rand(7)+1), "man", "man", iRank, SPAIN, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, iRank, iScl, iScl, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", iScl*2);
				if (MOD_SKILL_ENEMY_RATE > 4) sld.cirassId = Items_FindItemIdx("cirass2");
			}
			ChangeCharacterAddressGroup(sld, "Maracaibo_Plantation", "reload", "reload1");
		}
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetCheck("EnemyFight", "Mtraxx_PlantMutinyAfterFortFight");
}

void Mtraxx_PlantEscapeInShore(string qName) // в бухте
{
	// нулим бойцов
	for (int i=1; i<=7; i++)
	{
		if (GetCharacterIndex("Mtr_PellyPirate_"+i) != -1)
		{
			sld = CharacterFromID("Mtr_PellyPirate_"+i);
			LAi_SetWarriorType(sld);
			sld.lifeday = 0;
		}
	}
	// нулим пленников на плантации
	for (i=4; i<=8; i++)
	{
		if (GetCharacterIndex("Mtr_plantation_prisoner_"+i) != -1)
		{
			sld = CharacterFromID("Mtr_plantation_prisoner_"+i);
			sld.lifeday = 0;
		}
	}
	// подводим итоги
	if (CheckAttribute(pchar, "questTemp.Mtraxx.RocurDie")) // провалили дело
	{
		sld = characterFromId("Pelly");
		sld.Dialog.currentnode = "Pelly_14";
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
	else
	{
		sld = characterFromId("Mrt_Rocur");
		LAi_CharacterEnableDialog(sld);
		sld.Dialog.currentnode = "rocur_27";
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void Mtraxx_PlantFailFinal() // провалили дело
{
	LAi_LocationFightDisable(&Locations[FindLocation("shore37")], false);
	locations[FindLocation("shore37")].DisableEncounters = false;
	LocatorReloadEnterDisable("Maracaibo_ExitTown", "reload2_back", false);
	LocatorReloadEnterDisable("Maracaibo_ExitTown", "reload3_back", false);
	LocatorReloadEnterDisable("Maracaibo_ExitTown", "reload4", false);
	LocatorReloadEnterDisable("shore37", "boat", false);
	sld = characterFromId("Pelly");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "sea", "none", "", "", "", 10.0);
	Mtraxx_PlantPellyClear();
	AddQuestRecord("Roger_3", "17");
	Mtraxx_TerraxReset(3);
}

void Mtraxx_PlantSeaEscape() // уходим в море
{
	sld = characterFromId("Mrt_Rocur");// лесник . Пикар убегает на корабль Тисака лесник
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "sea", "none", "", "", "", 3.0); // лесник 
	sld = characterFromId("Pelly");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "sea", "none", "", "", "OpenTheDoors", 10.0);
	LocatorReloadEnterDisable("shore37", "boat", false);
	AddQuestRecord("Roger_3", "18");
	LocatorReloadEnterDisable("shore37", "reload1_back", true);
	pchar.quest.mtraxx_plant_seabattle.win_condition.l1 = "location";
	pchar.quest.mtraxx_plant_seabattle.win_condition.l1.location = "Maracaibo";
	pchar.quest.mtraxx_plant_seabattle.function = "Mtraxx_PlantSeaBattle";
}

void Mtraxx_PlantSeaBattle(string qName) // бой с испанской эскадрой
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	DeleteAttribute(pchar, "GenQuest.HunterLongPause");
	AddQuestRecord("Roger_3", "19");
	LAi_LocationFightDisable(&Locations[FindLocation("shore37")], false);
	locations[FindLocation("shore37")].DisableEncounters = false;
	LocatorReloadEnterDisable("shore37", "reload1_back", false);
	LocatorReloadEnterDisable("Maracaibo_ExitTown", "reload2_back", false);
	LocatorReloadEnterDisable("Maracaibo_ExitTown", "reload3_back", false);
	LocatorReloadEnterDisable("Maracaibo_ExitTown", "reload4", false);
	DeleteAttribute(pchar, "GenQuest.CannotWait");
	Island_SetReloadEnableGlobal("Maracaibo", false);
	bQuestDisableMapEnter = true;
	pchar.nation = FRANCE;
	// ставим три испанских корабля
	Group_FindOrCreateGroup("Mtr_PlantSeaGroup");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 20 + 2*sti(pchar.rank);
	int Type, iShip, Ship1, Ship2, Ship3, iCannon, Cannon1, Cannon2;
	int iClass = sti(RealShips[sti(pchar.ship.type)].Class);
	if (MOD_SKILL_ENEMY_RATE < 4) // халява
	{
		Type = 1;
		if (iClass == 3) Type = 2;
		if (iClass < 3) Type = 4;
	}
	if (MOD_SKILL_ENEMY_RATE >= 4 && MOD_SKILL_ENEMY_RATE < 8) // 2-3 уровни
	{
		Type = 4;
		if (iClass == 3) Type = 3;
		if (iClass < 3) Type = 5;
	}
	if (MOD_SKILL_ENEMY_RATE >= 8) // высшие уровни
	{
		Type = 3;
		if (iClass == 3) Type = 5;
		if (iClass < 3) Type = 6;
	}
	switch (Type)
	{
		case 1:
			Ship1 = SHIP_SCHOONER_W;
			Ship2 = SHIP_SLOOP;
			Ship3 = SHIP_CAREERLUGGER;
			Cannon1 = CANNON_TYPE_CANNON_LBS16;
			Cannon2 = CANNON_TYPE_CULVERINE_LBS8;
		break;
		
		case 2:
			Ship1 = SHIP_GALEON_L;
			Ship2 = SHIP_SCHOONER_W;
			Ship3 = SHIP_SLOOP;
			Cannon1 = CANNON_TYPE_CANNON_LBS16;
			Cannon2 = CANNON_TYPE_CULVERINE_LBS8;
		break;
		
		case 3:
			Ship1 = SHIP_CORVETTE;
			Ship2 = SHIP_GALEON_L;
			Ship3 = SHIP_SCHOONER_W;
			Cannon1 = CANNON_TYPE_CULVERINE_LBS18;
			Cannon2 = CANNON_TYPE_CANNON_LBS16;
		break;
		
		case 4:
			Ship1 = SHIP_BRIGANTINE;
			Ship2 = SHIP_SCHOONER_W;
			Ship3 = SHIP_BARKENTINE;
			Cannon1 = CANNON_TYPE_CULVERINE_LBS18;
			Cannon2 = CANNON_TYPE_CANNON_LBS16;
		break;
		
		case 5:
			Ship1 = SHIP_NAVIO;
			Ship2 = SHIP_XebekVML;
			Ship3 = SHIP_BRIG;
			Cannon1 = CANNON_TYPE_CANNON_LBS24;
			Cannon2 = CANNON_TYPE_CULVERINE_LBS18;
		break;
		
		case 6:
			Ship1 = SHIP_GALEON_H;
			Ship2 = SHIP_CORVETTE;
			Ship3 = SHIP_XebekVML;
			Cannon1 = CANNON_TYPE_CANNON_LBS24;
			Cannon2 = CANNON_TYPE_CULVERINE_LBS18;
		break;
	}
	for (int i=1; i<=3; i++)
	{
		switch (i)
		{
			case 1:
				iShip = Ship1;
				iCannon = Cannon1;
			break;
			
			case 2:
				iShip = Ship2;
				iCannon = Cannon2;
				if (Type == 6) iCannon = Cannon1;
			break;
			
			case 3:
				iShip = Ship3;
				iCannon = Cannon2;
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("Mtr_PlantSeaCap_"+i, "off_spa_"+(5-i), "man", "man", iRank, SPAIN, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, iScl, iScl, iScl);
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, LinkRandPhrase("blade_15","blade_16","topor_04"), "pistol1", "bullet", iScl*3);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysEnemy = true;
		sld.Ship.Mode = "war";
		sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*6;
		if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
		if (Type > 1 && i == 1) SetRandGeraldSail(sld, SPAIN);
		Group_AddCharacter("Mtr_PlantSeaGroup", "Mtr_PlantSeaCap_"+i);
	}
	Group_SetGroupCommander("Mtr_PlantSeaGroup", "Mtr_PlantSeaCap_1");
	Group_SetAddress("Mtr_PlantSeaGroup", "Maracaibo", "quest_ships", "quest_ship_7");
	Group_SetTaskAttack("Mtr_PlantSeaGroup", PLAYER_GROUP);
	Group_LockTask("Mtr_PlantSeaGroup");
	// Пелли уплывает
	ref chr = characterFromId("Mtr_PlantSeaCap_1");
	sld = characterFromId("Pelly_sea");
	sld.nation = SPAIN;
	Ship_SetTaskRunAway(SECONDARY_TASK, sti(sld.index), sti(chr.index));
	
	pchar.quest.mtraxx_plant_seabattlewin.win_condition.l1 = "NPC_Death";
	pchar.quest.mtraxx_plant_seabattlewin.win_condition.l1.character = "Mtr_PlantSeaCap_1";
	pchar.quest.mtraxx_plant_seabattlewin.function = "Mtraxx_PlantSeaBattleCanEscape";
}

void Mtraxx_PlantSeaBattleCanEscape(string qName) // уничтожили флагман испанцев
{
	Log_Info("The Spanish has lost their flagship! We can try to flee!");
	PlaySound("interface\notebook.wav");
	bQuestDisableMapEnter = false;//открыть карту
	pchar.quest.mtraxx_plant_seabattlemap.win_condition.l1 = "MapEnter";
	pchar.quest.mtraxx_plant_seabattlemap.function = "Mtraxx_PlantGoHome";
}

void Mtraxx_PlantGoHome(string qName) // пора домой
{
	AddQuestRecord("Roger_3", "20");
	Group_SetAddress("PellyGroup", "Hispaniola1", "quest_ships", "quest_ship_6"); // Пелли в Ла Вегу
	pchar.questTemp.Mtraxx = "plant_success";
	QuestSetCurrentNode("Terrax", "mtraxx_27");
	SetFunctionTimerCondition("Mtraxx_PlantGoHomeOver", 0, 0, 40, false);
	SetFunctionTimerCondition("Mtraxx_PlantOpenMaracaibo", 0, 0, 5, false);
	AddComplexSeaExpToScill(100, 100, 100, 50, 50, 50, 0);
	ChangeCharacterComplexReputation(pchar, "authority", 7);
	ChangeCharacterComplexReputation(pchar, "fame", 5);
	ChangeCharacterHunterScore(PChar, "spahunter", 15); 
}

void Mtraxx_PlantOpenMaracaibo(string qName) // открываем остров
{
	Island_SetReloadEnableGlobal("Maracaibo", true);
}

void Mtraxx_PlantGoHomeOver(string qName) // истекло время на возвращение
{
	QuestSetCurrentNode("Terrax", "mtraxx_31");
	Group_DeleteGroup("PellyGroup");
	CloseQuestHeader("Roger_3");
}

void Mtraxx_PlantFithTaskTimer(string qName) // таймер на опоздание к 5 заданию
{
	pchar.questTemp.Mtraxx.Late = "true";
}

// эпизод 4 - Особенности пиратской торговли
void Mtraxx_PasqualeBegin() // установка параметров
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	Group_DeleteGroup("PellyGroup");
	SetFunctionTimerCondition("Mtraxx_PasqualeLate", 0, 0, 7, false);
	// здесь определим координаты эскадры
	int degN, degW, minN1, minN2, minW1, minW2;
	int i = rand(2); // широта
	int n = rand(4); // долгота // правки прогона 3
	int k = rand(2)+1; // минуты широты
	int m = rand(2)+1; // минуты долготы
	pchar.questTemp.Mtraxx.Crdn.degN = 22 + i; // градус широты
	pchar.questTemp.Mtraxx.Crdn.degW = 62 + n; // градус долготы // правки прогона 3
	pchar.questTemp.Mtraxx.Crdn.minN1 = k * 20 - 19; // нижний предел интервала широты
	pchar.questTemp.Mtraxx.Crdn.minN2 = k * 20; // верхний предел интервала широты
	pchar.questTemp.Mtraxx.Crdn.minW1 = m * 20 - 19; // нижний предел интервала долготы
	pchar.questTemp.Mtraxx.Crdn.minW2 = m * 20; // верхний предел интервала долготы
	// тип целевого корабля тоже определим здесь
	pchar.questTemp.Mtraxx.Crdn.Ship = SHIP_NAVIO;
	if (MOD_SKILL_ENEMY_RATE < 6) pchar.questTemp.Mtraxx.Crdn.Ship = SHIP_PINNACE;
	if (MOD_SKILL_ENEMY_RATE > 8) pchar.questTemp.Mtraxx.Crdn.Ship = SHIP_EASTINDIAMAN;
}

void Mtraxx_PasqualeLate(string qName) // опоздали к Паскалю
{
	DeleteAttribute(pchar, "questTemp.Mtraxx.Crdn");
	pchar.questTemp.Mtraxx = "pasq_late";
	QuestSetCurrentNode("Terrax", "mtraxx_34"); // правки прогона 3
	AddQuestRecord("Roger_4", "2");
	CloseQuestHeader("Roger_4");
}

void Mtraxx_PasqualeTimeConvoy(string qName) // дата прихода конвоя
{
	if (CheckAttribute(pchar, "questTemp.Mtraxx.PasqFail")) return;
	pchar.quest.mtraxx_pasq_convoy.win_condition.l1 = "EnterToSea";
	pchar.quest.mtraxx_pasq_convoy.function = "Mtraxx_PasqualeCheckCoordinates";
}

void Mtraxx_PasqualeCheckCoordinates(string qName) // проверяем координаты
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	if (CheckAttribute(pchar, "questTemp.Mtraxx.PasqFail")) return;
	int degN, degW, minN1, minN2, minW1, minW2;
	degN = sti(pchar.questTemp.Mtraxx.Crdn.degN); // градус широты
	degW = sti(pchar.questTemp.Mtraxx.Crdn.degW); // градус долготы
	minN1 = sti(pchar.questTemp.Mtraxx.Crdn.minN1); // нижний предел интервала широты
	minN2 = sti(pchar.questTemp.Mtraxx.Crdn.minN2); // верхний предел интервала широты
	minW1 = sti(pchar.questTemp.Mtraxx.Crdn.minW1); // нижний предел интервала долготы
	minW2 = sti(pchar.questTemp.Mtraxx.Crdn.minW2); // верхний предел интервала долготы
	if (CheckAttribute(pchar, "Ship.pos.x") && !bDisableMapEnter)
	{
		if(GetSeaCoordDegreeZ(makefloat(pchar.Ship.pos.z)) == degN && GetMapCoordMinutesZ(makefloat(worldMap.playerShipZ)) >= minN1 && GetMapCoordMinutesZ(makefloat(worldMap.playerShipZ)) < minN2 && GetSeaCoordDegreeX(makefloat(pchar.Ship.pos.x)) == degW && GetMapCoordMinutesX(makefloat(worldMap.playerShipX)) >= minW1 && GetMapCoordMinutesX(makefloat(worldMap.playerShipX)) < minW2) 
		{	
			log_Testinfo("Координаты найдены!");
			bQuestDisableMapEnter = true;
			pchar.quest.Mtraxx_PasqualeConvoyOver.over = "yes";
			DoQuestFunctionDelay("Mtraxx_PasqualeCreateConvoy", 3.0);
		}
		else 
		{
			log_Testinfo("Координаты не соответствуют");
			pchar.quest.mtraxx_pasq_convoy1.win_condition.l1 = "MapEnter";
			pchar.quest.mtraxx_pasq_convoy1.function = "Mtraxx_PasqualeTimeConvoy";
		}
	}
	else log_Testinfo("Координаты не проверяются");
}

void Mtraxx_PasqualeConvoyOver(string qName) // не нашли конвой
{
	pchar.questTemp.Mtraxx.PasqFail = "true";
	DeleteAttribute(pchar, "questTemp.Mtraxx.Crdn");
	pchar.questTemp.Mtraxx = "pasq_late";
	AddQuestRecord("Roger_4", "4");
	CloseQuestHeader("Roger_4");
	QuestSetCurrentNode("Terrax", "mtraxx_34");
}

void Mtraxx_PasqualeCreateConvoy(string qName) // создаем конвой
{
	log_info("Dutch convoy is on the horizon!");
	PlaySound("interface\notebook.wav");
	PlaySound("interface\_EvEnemy0.wav");
	Group_FindOrCreateGroup("Mtr_PasqSeaGroup");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iScl = 20 + 2*sti(pchar.rank);
	int Type, iShip, Ship1, Ship2, Ship3, iCannon, Cannon1, Cannon2, iSpace;
	int iClass = sti(RealShips[sti(pchar.ship.type)].Class);
	Type = 2; // 3-4
	if (MOD_SKILL_ENEMY_RATE < 6) Type = 1; // 2-4
	if (MOD_SKILL_ENEMY_RATE > 8) Type = 3; // 5
	switch (Type)
	{
		case 1:
			Ship1 = SHIP_SCHOONER_W;
			Ship3 = SHIP_FLEUT;
			if (MOD_SKILL_ENEMY_RATE < 4)
			{
				Cannon1 = CANNON_TYPE_CANNON_LBS16;
				Cannon2 = CANNON_TYPE_CANNON_LBS12;
			}
			else
			{
				Cannon1 = CANNON_TYPE_CANNON_LBS20;
				Cannon2 = CANNON_TYPE_CANNON_LBS16;
			}
		break;
		
		case 2:
			Ship1 = SHIP_CORVETTE;
			Ship3 = SHIP_FLEUT;
			Cannon1 = CANNON_TYPE_CULVERINE_LBS18;
			Cannon2 = CANNON_TYPE_CANNON_LBS16;
		break;
		
		case 3:
			Ship1 = SHIP_NAVIO;
			Ship3 = SHIP_CORVETTE;
			Cannon1 = CANNON_TYPE_CANNON_LBS24;
			Cannon2 = CANNON_TYPE_CULVERINE_LBS18;
		break;
	}
	Ship2 = sti(pchar.questTemp.Mtraxx.Crdn.Ship);
	for (int i=1; i<=3; i++)
	{
		switch (i)
		{
			case 1:
				iShip = Ship1;
				iCannon = Cannon1;
			break;
			
			case 2:
				iShip = Ship2;
				iCannon = Cannon2;
				if (Type == 2 && MOD_SKILL_ENEMY_RATE > 6) iCannon = Cannon1;
			break;
			
			case 3:
				iShip = Ship3;
				iCannon = Cannon2;
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("Mtr_PasqCap_"+i, "off_hol_"+i, "man", "man", iRank, HOLLAND, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, iScl, iScl, iScl);
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, LinkRandPhrase("blade_15","blade_16","topor_04"), "pistol1", "bullet", iScl*3);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysEnemy = true;
		sld.Ship.Mode = "war";
		sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*6;
		if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
		if (i == 1) 
		{
			SetRandGeraldSail(sld, HOLLAND);
			iSpace = GetCharacterFreeSpace(sld, GOOD_WHEAT);
			iSpace = makeint(iSpace/2 + rand(iSpace/2));
			Fantom_SetCharacterGoods(sld, GOOD_WHEAT, iSpace, 1);
		}
		if (i == 2) 
		{
			sld.ship.name = "Rosbohom";
			NullCharacterGoods(sld);
			AddCharacterGoods(sld, GOOD_BALLS, 500);
			AddCharacterGoods(sld, GOOD_GRAPES, 400);
			AddCharacterGoods(sld, GOOD_KNIPPELS, 300);
			AddCharacterGoods(sld, GOOD_BOMBS, 500);
			AddCharacterGoods(sld, GOOD_POWDER, 1000);
			AddCharacterGoods(sld, GOOD_WEAPON, 450);
			AddCharacterGoods(sld, GOOD_FOOD, 500);
			AddCharacterGoods(sld, GOOD_MEDICAMENT, 150);
			AddCharacterGoods(sld, GOOD_RUM, 50);
			iSpace = GetCharacterFreeSpace(sld, GOOD_EBONY);
			Fantom_SetCharacterGoods(sld, GOOD_EBONY, iSpace, 1);
			pchar.questTemp.Mtraxx.Crdn.Ebony = iSpace;
		}
		if (i == 3) 
		{
			iSpace = GetCharacterFreeSpace(sld, GOOD_FRUITS);
			iSpace = makeint(iSpace/2 + rand(iSpace/2));
			Fantom_SetCharacterGoods(sld, GOOD_FRUITS, iSpace, 1);
		}
		Group_AddCharacter("Mtr_PasqSeaGroup", "Mtr_PasqCap_"+i);
	}
	Group_SetGroupCommander("Mtr_PasqSeaGroup", "Mtr_PasqCap_1");
	Group_SetTaskAttack("Mtr_PasqSeaGroup", PLAYER_GROUP);
	Group_LockTask("Mtr_PasqSeaGroup");
	Sea_LoginGroupCurrentSea("Mtr_PasqSeaGroup");
	pchar.quest.mtr_pasq_seabattleCheck.win_condition.l1 = "MapEnter";
	pchar.quest.mtr_pasq_seabattleCheck.function = "Mtraxx_PasqualeCheck";
	pchar.quest.mtr_pasq_seabattleAbordage.win_condition.l1 = "Character_Capture";
	pchar.quest.mtr_pasq_seabattleAbordage.win_condition.l1.character = "Mtr_PasqCap_2";
	pchar.quest.mtr_pasq_seabattleAbordage.function = "Mtraxx_PasqualeBoarding";
	pchar.quest.mtr_pasq_seabattleSink.win_condition.l1 = "Character_sink";
	pchar.quest.mtr_pasq_seabattleSink.win_condition.l1.character = "Mtr_PasqCap_2";
	pchar.quest.mtr_pasq_seabattleSink.function = "Mtraxx_PasqualeSink";
	bQuestDisableMapEnter = false;
	Island_SetReloadEnableGlobal("Bermudes", false);
}

void Mtraxx_PasqualeSink(string qName) // утопили Розбоом
{
	pchar.quest.mtr_pasq_seabattleAbordage.over = "yes";
	pchar.questTemp.Mtraxx.Crdn.Fail = "true";
}

void Mtraxx_PasqualeBoarding(string qName) // взяли Розбоом
{
	pchar.quest.mtr_pasq_seabattleSink.over = "yes";
	pchar.questTemp.Mtraxx.Crdn.Win = "true";
}

void Mtraxx_PasqualeCheck(string qName) // подводим итоги боя // правки прогона 3
{
	Group_DeleteGroup("Mtr_PasqSeaGroup");
	Island_SetReloadEnableGlobal("Bermudes", true);
	OfficersReaction("bad");
	ChangeCharacterComplexReputation(pchar, "nobility", -2);
	if (CheckAttribute(pchar, "questTemp.Mtraxx.Crdn.Fail"))
	{
		pchar.questTemp.Mtraxx = "pasq_sink";
		AddQuestRecord("Roger_4", "5");
		CloseQuestHeader("Roger_4");
		DeleteAttribute(pchar, "questTemp.Mtraxx.Crdn");
		QuestSetCurrentNode("Terrax", "mtraxx_34");
		ChangeCharacterHunterScore(PChar, "holhunter", 15);
		ChangeCharacterComplexReputation(pchar, "nobility", -3);
		return;
	}
	if (CheckAttribute(pchar, "questTemp.Mtraxx.Crdn.Win"))
	{
		pchar.questTemp.Mtraxx = "pasq_win";
		AddQuestRecord("Roger_4", "7");
		DoQuestCheckDelay("sea_victory", 1.3);
		ChangeCharacterComplexReputation(pchar, "authority", 3);
		ChangeCharacterComplexReputation(pchar, "fame", 3);
		AddComplexSeaExpToScill(100, 50, 50, 100, 100, 100, 0);
		ChangeCharacterHunterScore(PChar, "holhunter", 15); 
		ChangeCharacterComplexReputation(pchar, "nobility", -4);
		return;
	}
	DeleteAttribute(pchar, "questTemp.Mtraxx.Crdn");
	pchar.questTemp.Mtraxx = "pasq_esc";
	AddQuestRecord("Roger_4", "6");
	CloseQuestHeader("Roger_4");
	QuestSetCurrentNode("Terrax", "mtraxx_34");
}

void Mtraxx_PasqualeJeffry(string qName) // подходит Джеффри
{
	chrDisableReloadToLocation = true;
	sld = characterFromId("Jeffry");
	sld.dialog.currentnode = "Jeffry_15";
	sld.greeting = "captain";
	ChangeCharacterAddressGroup(sld, "Pirates_town", "reload", "reload3_back");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Mtraxx_PasqualeJan(string qName) // продолжение квеста
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	if (!CheckAttribute(pchar, "questTemp.Mtraxx.Pasquale.Continue")) return; // правки прогона 3
	chrDisableReloadToLocation = true;
	sld = characterFromId("Mrt_Rocur");
	LAi_CharacterEnableDialog(sld); // релиз-правка
	sld.dialog.currentnode = "rocur_48";
	ChangeCharacterAddressGroup(sld, "LaVega_exittown", "reload", "reload2_back");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	// корвет Пикара в бухту для антуража
	Group_FindOrCreateGroup("RocurSeaGroup");
	FantomMakeCoolSailor(sld, SHIP_CORVETTE, "Грифон", CANNON_TYPE_CULVERINE_LBS18, 90, 90, 90);
	sld.nation = PIRATE;
	sld.Abordage.Enable = false;
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true; 
	LAi_SetImmortal(sld, true); // сплошная защита от дурака
	sld.DontDeskTalk = true;
	Group_AddCharacter("RocurSeaGroup", "Mrt_Rocur");
	Group_SetGroupCommander("RocurSeaGroup", "Mrt_Rocur");
	Group_SetTaskNone("RocurSeaGroup");
	Group_SetAddress("RocurSeaGroup", "Hispaniola1", "quest_ships", "quest_ship_4");
	Group_LockTask("RocurSeaGroup");
}

void Mtraxx_PasqualeJanTimer(string qName) // корвет Жана к бухте Гонаив
{
	Group_SetAddress("RocurSeaGroup", "Hispaniola2", "quest_ships", "quest_ship_4");
}

void Mtraxx_PasqualeJanTimeOver(string qName) // не явился на стрелку
{
	AddQuestRecord("Roger_4", "13");
	CloseQuestHeader("Roger_4");
	pchar.quest.mtraxx_pasq_gonaiv.over = "yes";
	if (pchar.location == "Hispaniola2" && bSeaActive)
	{
		pchar.quest.mtraxx_pasq_janover.win_condition.l1 = "ExitFromLocation";
		pchar.quest.mtraxx_pasq_janover.win_condition.l1.location = pchar.location;
		pchar.quest.mtraxx_pasq_janover.function = "Mtraxx_PasqualeJanTimeOver1";
	}
	else 
	{
		Group_DelCharacter("RocurSeaGroup", "Mrt_Rocur");
		Group_DeleteGroup("RocurSeaGroup");
	}
	DeleteAttribute(pchar, "questTemp.Mtraxx.Pasquale.Grabbing");
}

void Mtraxx_PasqualeJanTimeOver1(string qName) // 
{
	Group_DelCharacter("RocurSeaGroup", "Mrt_Rocur");
	Group_DeleteGroup("RocurSeaGroup");
}

void Mtraxx_PasqualeJanGonaiv(string qName) // встретились в бухте
{
	pchar.GenQuest.HunterLongPause = true;
	pchar.quest.mtraxx_pasq_check.over = "yes";
	pchar.quest.Mtraxx_PasqualeJanTimeOver.over = "yes";
	chrDisableReloadToLocation = true;
	sld = characterFromId("Mrt_Rocur");
	sld.dialog.currentnode = "rocur_57";
	ChangeCharacterAddressGroup(sld, "Shore34", "goto", "goto1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Mtraxx_PasqualeNight() // ночной порой два жулика...
{
	int iTime, iAddTime;
	iTime = sti(environment.time);
	iAddTime = 24 - iTime;
	if (iAddTime < 1) iAddTime = 24;
	SetLaunchFrameFormParam("Night has come...", "", 0, 3);
	LaunchFrameForm();
	StoreDayUpdate();
	WaitDate("",0,0,0,iAddtime,5);
	RecalculateJumpTable();
	RefreshWeather();
	RefreshLandTime();
	DoQuestFunctionDelay("Mtraxx_PasqualeNightTalk", 3.0);
}

void Mtraxx_PasqualeNightTalk(string qName) // ... сговорились пойти на дело
{
	pchar.GenQuest.Hunter2Pause = true; // 3 прогона
	DoQuestReloadToLocation("Shore34", "reload", "reload1", "Mtraxx_PasqualeNightTalk");
}

void Mtraxx_PasqualeNightMarch() // параметры локаций для похода
{
	AddQuestRecord("Roger_4", "12");
	sld = characterFromId("Mrt_Rocur");
	LAi_SetActorType(sld);
	LAi_ActorFollowEverywhere(sld, "", -1);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	chrDisableReloadToLocation = false;
	LocatorReloadEnterDisable("Shore34", "boat", true);
	pchar.quest.mtraxx_pasq_night.win_condition.l1 = "Timer";
	pchar.quest.mtraxx_pasq_night.win_condition.l1.date.hour  = 4.0;
	pchar.quest.mtraxx_pasq_night.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 0);
	pchar.quest.mtraxx_pasq_night.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 0);
	pchar.quest.mtraxx_pasq_night.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 0);
	pchar.quest.mtraxx_pasq_night.function = "Mtraxx_PasqualeNightTimeover";
	pchar.quest.mtraxx_pasq_lavega.win_condition.l1 = "location";
	pchar.quest.mtraxx_pasq_lavega.win_condition.l1.location = "Lavega_town";
	pchar.quest.mtraxx_pasq_lavega.function = "Mtraxx_PasqualeNightLavega";
	pchar.GenQuest.CannotWait = true;
	for (int i=0; i<MAX_LOCATIONS; i++)
	{				
		if (CheckAttribute(locations[i], "islandId") && locations[i].islandId == "Hispaniola")
		{
			LAi_LocationDisableOfficersGen(locations[i].id, true);
		}
	}
}

void Mtraxx_PasqualeNightClear() // чистка запретов
{
	for (int i=0; i<MAX_LOCATIONS; i++)
	{				
		if (CheckAttribute(locations[i], "islandId") && locations[i].islandId == "Hispaniola")
		{
			LAi_LocationDisableOfficersGen(locations[i].id, false);
		}
	}
	LocatorReloadEnterDisable("shore34", "boat", false);
	DeleteAttribute(pchar, "GenQuest.CannotWait");
	DeleteAttribute(pchar, "questTemp.Mtraxx.Pasquale.Grabbing");
	DeleteAttribute(pchar, "GenQuest.HunterLongPause");
}

void Mtraxx_PasqualeNightTimeover(string qName) // замешкались
{
	pchar.questTemp.Mtraxx.Pasquale.Timeover = "true";
	DeleteAttribute(pchar, "GenQuest.HunterLongPause");
}

void Mtraxx_PasqualeNightLavega(string qName) // вошли в Ла Вегу
{
	if (CheckAttribute(pchar, "questTemp.Mtraxx.Pasquale.Timeover"))
	{
		DeleteAttribute(pchar, "questTemp.Mtraxx.Pasquale.Timeover");
		Mtraxx_PasqualeNightClear();
		sld = characterFromId("Mrt_Rocur");
		sld.dialog.currentnode = "rocur_98";
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
		return;
	}
	pchar.quest.mtraxx_pasq_night.over = "yes";
	chrDisableReloadToLocation = true;
	sld = characterFromId("Mrt_Rocur");
	sld.dialog.currentnode = "rocur_72";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	// заполняем сундуки
	int n = Findlocation("LaVega_TwoFloorHouse");
	locations[n].private1.items.chest = 1;
	locations[n].private1.items.jewelry3 = 50;
	locations[n].private1.items.map_hisp = 1;
	locations[n].private1.items.potionrum = 10;
	locations[n].private2.items.totem_03 = 1;
	locations[n].private2.items.Mineral13 = 1;
	locations[n].private2.items.Mineral30 = 1;
	locations[n].private2.items.Mineral6 = 1;
	locations[n].private2.items.Mineral2 = 1;
	locations[n].private2.items.Mineral3 = 1;
	locations[n].private2.items.potionwine = 5;
	// ставим деваху
	sld = GetCharacter(NPC_GenerateCharacter("Mirabella", "Mirabelle", "woman", "towngirl", 1, PIRATE, -1, false, "quest"));
	SetFantomParamFromRank(sld, 1, true);
	sld.name = "Mirabelle";
	sld.lastname = "";
	sld.Dialog.Filename = "Quest\Roger.c";
	sld.dialog.currentnode = "mirabelle";
	RemoveAllCharacterItems(sld, true);
	sld.DontClearDead = true;
	ChangeCharacterAddressGroup(sld, "LaVega_TwoFloorHouse", "goto", "goto7");
	LAi_SetActorType(sld);
}

void Mtraxx_PasqualeNightToHouse() // бежим в дом
{
	sld = characterFromId("Mrt_Rocur");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "reload10", "LaVega_TwoFloorHouse", "goto", "goto1", "Mtraxx_PasqualeNightToHouse", -1);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
}

void Mtraxx_PasqualeNightInHouse() // в доме
{
	sld = characterFromId("Mrt_Rocur");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocator(sld, "goto", "goto3", "Mtraxx_PasqualeJanAni", -1);
	pchar.quest.mtraxx_pasq_girl.win_condition.l1 = "locator";
	pchar.quest.mtraxx_pasq_girl.win_condition.l1.location = "LaVega_TwoFloorHouse";
	pchar.quest.mtraxx_pasq_girl.win_condition.l1.locator_group = "quest";
	pchar.quest.mtraxx_pasq_girl.win_condition.l1.locator = "quest1";
	pchar.quest.mtraxx_pasq_girl.function = "Mtraxx_PasqualeFindGirl";
}

void Mtraxx_PasqualeCheckChest() // проверяем залез ли в сундук
{
	pchar.questTemp.Mtraxx.Pasquale.Grabbing.Chest = "true";
}

void Mtraxx_PasqualeFindGirl(string qName) // нашел Мирабель
{
	pchar.questTemp.Mtraxx.Pasquale.Girl = "true";
	sld = characterFromId("Mirabella");
	LAi_SetActorType(sld);
	LAi_ActorDialogDelay(sld, pchar, "", 1.5);
}

void Mtraxx_PasqualeJanSeeGirl() // Жан видит Мирабель
{
	sld = characterFromId("Mrt_Rocur");
	sld.dialog.currentnode = "rocur_75";
	LAi_SetActorType(sld);
	LAi_ActorGoToLocator(sld, "goto", "goto6", "Mtraxx_PasqualeJanSeeGirl", 5);
}

void Mtraxx_PasqualeJanTreasure(string qName) // делим добычу
{
	if (CheckAttribute(pchar, "questTemp.Mtraxx.Pasquale.Girl")) return;
	pchar.quest.mtraxx_pasq_girl.over = "yes"; 
	sld = characterFromId("Mirabella");
	sld.lifeday = 0;
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld = characterFromId("Mrt_Rocur");
	sld.dialog.currentnode = "rocur_86";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Mtraxx_PasqualeNightOutHouse() // вышли из дома
{
	sld = characterFromId("Mrt_Rocur");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "reload1", "LaVega_town", "reload", "reload10", "Mtraxx_PasqualeNightOutHouse", -1);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
}

void Mtraxx_PasqualeNightGulf() // за воротами
{
	chrDisableReloadToLocation = false;
	sld = characterFromId("Mrt_Rocur");
	LAi_SetActorType(sld);
	LAi_ActorFollowEverywhere(sld, "", -1);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	pchar.quest.mtraxx_pasq_final.win_condition.l1 = "location";
	pchar.quest.mtraxx_pasq_final.win_condition.l1.location = "shore34";
	pchar.quest.mtraxx_pasq_final.function = "Mtraxx_PasqualeFinal";
	if (CheckAttribute(pchar, "questTemp.Mtraxx.Mirabella")) AddQuestRecord("Roger_4", "16");
	else AddQuestRecord("Roger_4", "15");
	AddCharacterExpToSkill(pchar, "Sneak", 400);
	AddCharacterExpToSkill(pchar, "Fortune", 300);
}

void Mtraxx_PasqualeFinal(string qName) // завершающий разговор в заливе
{
	chrDisableReloadToLocation = true;
	sld = characterFromId("Mrt_Rocur");
	sld.dialog.currentnode = "rocur_90";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Mtraxx_PasqualeAddComplete() // итоги
{
	chrDisableReloadToLocation = false;
	sld = characterFromId("Mrt_Rocur");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "sea", "none", "", "", "", 10.0);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	sld.lifeday = 0;
	Group_DeleteGroup("RocurSeaGroup");
	AddQuestRecord("Roger_4", "17");
	CloseQuestHeader("Roger_4");
	LocatorReloadEnterDisable("LaVega_Exittown", "reload3", false);
	Mtraxx_PasqualeNightClear();
	if (CheckAttribute(pchar, "questTemp.Mtraxx.Mirabella"))
	{
		chrDisableReloadToLocation = true;
		sld = characterFromId("Mirabella");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void Mtraxx_PasqualeGrabbingCheck(string qName) // проверка на заход к Тираксу до ограбления Паскуале
{
	if (CheckAttribute(pchar, "questTemp.Mtraxx.Pasquale.Grabbing"))
	{
		DeleteAttribute(pchar, "questTemp.Mtraxx.Pasquale.Grabbing");
		pchar.quest.mtraxx_pasq_gonaiv.over = "yes";
		pchar.quest.Mtraxx_PasqualeJanTimer.over = "yes";
		pchar.quest.Mtraxx_PasqualeJanTimeOver.over = "yes";
		AddQuestRecord("Roger_4", "19");
		CloseQuestHeader("Roger_4");
	}
	else return;
}

void Mtraxx_PasqualeMirabella(string qName) // Мирабель вышла на Исла Моне
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	float locx, locy, locz;
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	pchar.quest.Mtraxx_MirabellaSailOver.over = "yes";
	pchar.quest.mtraxx_pasq_mirabella.over = "yes";
	pchar.quest.mtraxx_pasq_mirabella1.over = "yes";
	sld = characterFromId("Mirabella");
	sld.dialog.currentnode = "mirabelle_14";
	RemovePassenger(pchar, sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorFollowEverywhere(sld, "", -1);
	pchar.quest.mtraxx_islamona_mirabella.win_condition.l1 = "location";
	pchar.quest.mtraxx_islamona_mirabella.win_condition.l1.location = "IslaMona_TwoFloorHouse";
	pchar.quest.mtraxx_islamona_mirabella.function = "Mtraxx_PasqualeMirabellaHouse";
}

void Mtraxx_PasqualeMirabellaHouse(string qName) // привели Мирабель в дом
{
	LocatorReloadEnterDisable("IslaMona_TwoFloorHouse", "reload1", true);
	LocatorReloadEnterDisable("IslaMona_TwoFloorHouse", "reload3", true);
	sld = characterFromId("Mirabella");
	LAi_SetActorType(sld);
	LAi_ActorDialogDelay(sld, pchar, "", 2.0);
}

void Mtraxx_PasqualeMirabellaRoom(string qName) // привели Мирабель в комнату
{
	chrDisableReloadToLocation = true;
	LocatorReloadEnterDisable("IslaMona_TwoFloorHouse", "reload1", false);
	LocatorReloadEnterDisable("IslaMona_TwoFloorHouse", "reload3", false);
	sld = characterFromId("Mirabella");
	sld.dialog.currentnode = "mirabelle_18";
	LAi_SetActorType(sld);
	LAi_ActorDialogDelay(sld, pchar, "", 2.0);
}

void Mtraxx_PasqualeMirabellaSex(string qName) // занялись любовью с ней
{
	bDisableCharacterMenu = false;
	DeleteAttribute(pchar, "GenQuest.FrameLockEsc");
	sld = characterFromId("Mirabella");
	sld.dialog.currentnode = "mirabelle_22";
	LAi_SetActorType(sld);
	LAi_ActorDialogDelay(sld, pchar, "", 1.0);
	AddCharacterExpToSkill(pchar, "Leadership", 400);
}

void Mtraxx_MirabellaSetLife(string qName) // устанавливаем поведение Мирабель в доме // прогона 3
{
	pchar.quest.mtraxx_mirabella_life.win_condition.l1 = "locator";
	pchar.quest.mtraxx_mirabella_life.win_condition.l1.location = "IslaMona_TwoFloorHouse";
	pchar.quest.mtraxx_mirabella_life.win_condition.l1.locator_group = "reload";
	pchar.quest.mtraxx_mirabella_life.win_condition.l1.locator = "reload1";
	pchar.quest.mtraxx_mirabella_life.again = true;
	pchar.quest.mtraxx_mirabella_life.function = "Mtraxx_MirabellaLife";
}

void Mtraxx_MirabellaLife(string qName) // поведение Мирабель в доме
{
	sld = characterFromId("Mirabella");
	sld.greeting = "mirabella";
	LAi_SetStayType(sld);
	if (stf(environment.time) > 7.99 && stf(environment.time) < 21.0) // днем внизу
	{
		ChangeCharacterAddressGroup(sld, "IslaMona_TwoFloorHouse", "goto", "goto"+(rand(2)+1));
	}
	else
	{
		ChangeCharacterAddressGroup(sld, "IslaMona_TwoFloorRoom", "goto", "goto"+(rand(4)+1));
	}
}

void Mtraxx_MirabellaSex(string qName) // секс с Мирабель
{
	string sTemp;
	float fTime;
	ResetSound();
	pchar.GenQuest.FrameLockEsc = true;
	bDisableCharacterMenu = true;
	switch (rand(5))
	{
		case 0: 
			sTemp = "8";
			fTime = 9.3;
		break;
		
		case 1: 
			sTemp = "10";
			fTime = 12.2;
		break;
		
		case 2: 
			sTemp = "12";
			fTime = 12.3;
		break;
		
		case 3: 
			sTemp = "13";
			fTime = 10.2;
		break;
		
		case 4: 
			sTemp = "14";
			fTime = 11.2;
		break;
	}
	PlayStereoSound("sex\sex" + sTemp + ".wav");
	WaitDate("", 0, 0, 0, 2, 30);
	SetLaunchFrameFormParam("", "", 0, fTime);
	SetLaunchFrameFormPic("loading\inside\censored1.tga");
	LaunchFrameForm();
	AddCharacterHealth(pchar, 5);
	LAi_SetCurHPMax(pchar);
	DoQuestFunctionDelay("Mtraxx_MirabellaAfterSex", fTime);
}

void Mtraxx_MirabellaAfterSex(string qName) // после секса с Мирабель
{
	bDisableCharacterMenu = false;
	DeleteAttribute(pchar, "GenQuest.FrameLockEsc");
	sld = characterFromId("Mirabella");
	LAi_SetActorType(sld);
	LAi_ActorDialogDelay(sld, pchar, "", 1.0);
}

void Mtraxx_MirabellaSailOver(string qName) // не довез Мирабель
{
	pchar.quest.mtraxx_pasq_mirabella.over = "yes";
	pchar.quest.mtraxx_pasq_mirabella1.over = "yes";
	sld = characterFromId("Mirabella");
	sld.lifeday = 0;
	RemovePassenger(pchar, sld);
	Log_Info("Mirabelle died of fever!");
	PlaySound("interface\notebook.wav");
}

// эпизод 5 - Камни цвета леса и крови
void Mtraxx_MeridaBegin() // к Леприкону
{
	pchar.quest.mtraxx_merida_begin.win_condition.l1 = "location";
	pchar.quest.mtraxx_merida_begin.win_condition.l1.location = "LaVega_port";
	pchar.quest.mtraxx_merida_begin.win_condition.l2 = "Ship_location";
	pchar.quest.mtraxx_merida_begin.win_condition.l2.location = "LaVega_port";
	pchar.quest.mtraxx_merida_begin.function = "Mtraxx_MeridaCreateLepricon";
	SetFunctionTimerCondition("Mtraxx_MeridaSailTimer", 0, 0, 30, false);
}

void Mtraxx_MeridaSailTimer(string qName) // не доплыли до Маракайбо
{
	pchar.quest.mtraxx_merida_begin.over = "yes";
	pchar.quest.mtraxx_merida_sailover.win_condition.l1 = "Location_Type";
	pchar.quest.mtraxx_merida_sailover.win_condition.l1.location_type = "town";
	pchar.quest.mtraxx_merida_sailover.function = "Mtraxx_MeridaTimeOver";
	pchar.questTemp.Mtraxx = "merida_timeover";
}

void Mtraxx_MeridaTimeOver(string qName) // не доплыли до Маракайбо
{
	chrDisableReloadToLocation = true;
	float locx, locy, locz;
	sld = characterFromId("Mrt_Rocur");
	LAi_SetActorType(sld);
	sld.dialog.currentnode = "rocur_35";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Mtraxx_MeridaTimeOverFail() // не доплыли до Маракайбо
{
	chrDisableReloadToLocation = false;
	AddMoneyToCharacter(pchar, 50000);
	sld = characterFromId("Mrt_Rocur");
	RemovePassenger(pchar, sld);
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "reload4", "none", "", "", "", 10.0);
	sld.lifeday = 0;
	if (GetCharacterIndex("Lepricon") != -1)
	{
		sld = characterFromId("Lepricon");
		RemovePassenger(pchar, sld);
		sld.lifeday = 0;
	}
	AddQuestRecord("Roger_5", "2");
	Mtraxx_TerraxReset(5);
}

void Mtraxx_MeridaCreateLepricon(string qName) // ставим Леприкона с бригадой
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	chrDisableReloadToLocation = true;
	sld = GetCharacter(NPC_GenerateCharacter("Lepricon", "Leprechaun", "man", "man", 25, PIRATE, -1, true, "quest"));
	sld.name = "Luka";
	sld.lastname = "Bayard";
	sld.dialog.FileName = "Quest\Roger.c";
	sld.dialog.currentnode = "lepricon";
	sld.greeting = "";
	sld.rank = 30;
	sld.reputation = 20;
	LAi_SetHP(sld, 420, 420);
	SetSPECIAL(sld, 7, 10, 8, 3, 5, 9, 5);
	SetSelfSkill(sld, 30, 40, 90, 75, 65);
	SetShipSkill(sld, 45, 50, 5, 5, 5, 5, 5, 5, 90);
	SetCharacterPerk(sld, "Energaiser");
	SetCharacterPerk(sld, "BasicDefense");
	SetCharacterPerk(sld, "AdvancedDefense");
	SetCharacterPerk(sld, "CriticalHit");
	SetCharacterPerk(sld, "HardHitter");
	SetCharacterPerk(sld, "Sliding");
	SetCharacterPerk(sld, "BladeDancer");
	SetCharacterPerk(sld, "SwordplayProfessional");
	SetCharacterPerk(sld, "Gunman");
	SetCharacterPerk(sld, "GunProfessional");
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "BasicCommerce");
	sld.SuperShooter = true;
	RemoveAllCharacterItems(sld, true);
	GiveItem2Character(sld, "topor_01");
	EquipCharacterbyItem(sld, "topor_01");
	GiveItem2Character(sld, "pistol2");
	EquipCharacterbyItem(sld, "pistol2");
	LAi_SetCharacterUseBullet(sld, "grapeshot");
    TakeNItems(sld, "grapeshot", 50);
	TakeNItems(sld, "gunpowder", 50);
	sld.cirassId = Items_FindItemIdx("cirass4");
	LAi_SetCheckMinHP(sld, 10, true, "");
	TakeNItems(sld, "potion2", 7);
	TakeNItems(sld, "potion3", 7);
	TakeNItems(sld, "potion4", 7);
	ChangeCharacterAddressGroup(sld, "Lavega_port", "goto", "goto1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	for (int i=5; i<=9; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Lepricons_pirate_"+i, "mercen_"+i, "man", "man", 20, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, 20, 55, 55, LinkRandPhrase("blade_04","blade_06","topor_02"), "pistol3", "grapeshot", 150);
		LAi_CharacterDisableDialog(sld);
		TakeNItems(sld, "potion2", 5);
		TakeNItems(sld, "potion3", 6);
		TakeNItems(sld, "potion4", 6);
		ChangeCharacterAddressGroup(sld, "Lavega_port", "goto", "goto2");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void Mtraxx_MeridaSail() // отправляемся к Маракайбо
{
	sld = characterFromId("Lepricon");
	AddPassenger(pchar, sld, false);//добавить пассажира
	SetCharacterRemovable(sld, false);
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "sea", "none", "", "", "OpenTheDoors", -1);
	for (int i=5; i<=9; i++)
	{
		sld = characterFromId("Lepricons_pirate_"+i);
		LAi_SetActorType(sld);
		LAi_ActorRunToLocation(sld, "reload", "sea", "none", "", "", "", 10.0);
	}
	AddQuestRecord("Roger_5", "3");
	pchar.quest.mtraxx_merida_shore.win_condition.l1 = "location";
	pchar.quest.mtraxx_merida_shore.win_condition.l1.location = "Shore_ship3";
	pchar.quest.mtraxx_merida_shore.function = "Mtraxx_MeridaArriveShore";
}

void Mtraxx_MeridaArriveShore(string qName) // прибыли на мыс НН
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	if (pchar.questTemp.Mtraxx == "merida_timeover") // опоздал
	{
		DoQuestFunctionDelay("Mtraxx_MeridaTimeOver", 2.0);
		pchar.quest.mtraxx_merida_sailover.over = "yes";
		return;
	}
	pchar.quest.Mtraxx_MeridaSailTimer.over = "yes";
	chrDisableReloadToLocation = true;
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	sld = characterFromId("Mrt_Rocur");
	sld.dialog.currentnode = "rocur_36";
	ChangeCharacterAddressGroup(sld, "Shore_ship3", "goto", "goto2");
	LAi_SetActorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	sld = characterFromId("Lepricon");
	LAi_SetActorType(sld);
	sld.dialog.currentnode = "lepricon_2";
	ChangeCharacterAddressGroup(sld, "Shore_ship3", "goto", "goto1");
	LAi_SetActorType(sld);
	LAi_ActorFollow(sld, pchar, "", -1);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
}

void Mtraxx_MeridaSeekVillage() // ищем араваков
{
	chrDisableReloadToLocation = false;
	sld = characterFromId("Mrt_Rocur");
	LAi_SetActorType(sld);
	LAi_ActorFollowEverywhere(sld, "", -1);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	sld = characterFromId("Lepricon");
	LAi_SetActorType(sld);
	LAi_ActorFollowEverywhere(sld, "", -1);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	AddQuestRecord("Roger_5", "4");
	pchar.quest.mtraxx_merida_village.win_condition.l1 = "location";
	pchar.quest.mtraxx_merida_village.win_condition.l1.location = "Locono_village";
	pchar.quest.mtraxx_merida_village.function = "Mtraxx_MeridaFindVillage";
}

void Mtraxx_MeridaFindVillage(string qName) // нашли деревню
{
	pchar.questTemp.Mtraxx = "merida_village";
	// вождь Кумвана
	sld = GetCharacter(NPC_GenerateCharacter("Cumvana", "Kumvana", "man", "man", 25, SPAIN, -1, true, "native"));
	SetFantomParamFromRank(sld, 25, true);
	sld.name = "Kumwana";
	sld.lastname = "";
	LAi_SetLoginTime(sld, 6.0, 21.99);
	sld.dialog.Filename = "indian_dialog.c";
	sld.dialog.currentnode = "cumvana";
	sld.greeting = "indian_male";
	GiveItem2Character(sld, "blade_02");
	EquipCharacterbyItem(sld, "blade_02");
	ChangeCharacterAddressGroup(sld, "Locono_shack1", "sit", "sit1");
	LAi_SetHuberType(sld);
	// Хайами
	sld = GetCharacter(NPC_GenerateCharacter("Hayamee", "squaw_3", "woman", "woman_B", 10, SPAIN, -1, true, "native"));
	SetFantomParamFromRank(sld, 10, true);
	sld.name = "Hayami";
	sld.lastname = "";
	LAi_SetLoginTime(sld, 6.0, 21.99);
	LAi_SetImmortal(sld, true);
	sld.dialog.Filename = "indian_dialog.c";
	sld.dialog.currentnode = "IndianWoman";
	LAi_CharacterDisableDialog(sld);
	ChangeCharacterAddressGroup(sld, "Locono_village", "quest", "teleport1");
	LAi_SetCitizenType(sld);
	LAi_group_MoveCharacter(sld, "MiskitoGroup3");
	// Леприкона - гулять
	sld = characterFromId("Lepricon");
	sld.dialog.currentnode = "lepricon_3";
	LAi_SetWarriorType(sld);
	LAi_warrior_DialogEnable(sld, true);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
}

void Mtraxx_MeridaCumvanaTimer(string qName) // Кумвана снова готов говорить
{
	sld = characterFromId("Cumvana");
	sld.dialog.currentnode = "cumvana_8";
}

void Mtraxx_MeridaHayameeTimer(string qName) // ставим Тагофу
{
	sld = characterFromId("Hayamee");
	sld.dialog.currentnode = "hayamee_4";
	LAi_CharacterEnableDialog(sld);
	LAi_RemoveLoginTime(sld);
	ChangeCharacterAddressGroup(sld, "Locono_shack3", "quest", "quest1");
	// Тагофа - проводник
	sld = GetCharacter(NPC_GenerateCharacter("Tagofa", "miskito_6", "man", "man", 25, SPAIN, -1, true, "native"));
	SetFantomParamFromRank(sld, 25, true);
	sld.name = "Tagofa";
	sld.lastname = "";
	sld.dialog.Filename = "Quest\Roger.c";
	sld.dialog.currentnode = "tagofa";
	sld.greeting = "indian_male";
	LAi_SetCheckMinHP(sld, 20, true, ""); // скрытое бессмертие
	GiveItem2Character(sld, "topor_05");
	EquipCharacterbyItem(sld, "topor_05");
	ChangeCharacterAddressGroup(sld, "Locono_shack3", "sit", "sit1");
	LAi_SetLayType(sld);
	LAi_CharacterDisableDialog(sld);
	LAi_group_MoveCharacter(sld, "MiskitoGroup3");
}

void Mtraxx_MeridaTagofaHide(string qName) // 
{
	sld = characterFromId("Hayamee");
	sld.dialog.currentnode = "hayamee_14";
	LAi_CharacterEnableDialog(sld);
	sld = characterFromId("Tagofa");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, "MiskitoGroup3");
}

void Mtraxx_MeridaPotionLate(string qName) // тянет время до разговора с Хайами
{
	sld = characterFromId("Hayamee");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld.lifeday = 0;
	if (pchar.location == "Locono_village") DoQuestFunctionDelay("Mtraxx_MeridaPotionOver", 1.0);
	else
	{
		pchar.quest.mtraxx_merida_hayameelate.win_condition.l1 = "location";
		pchar.quest.mtraxx_merida_hayameelate.win_condition.l1.location = "Locono_village";
		pchar.quest.mtraxx_merida_hayameelate.function = "Mtraxx_MeridaPotionOver";
	}
}

void Mtraxx_MeridaPotionOver(string qName) // затянул время
{
	chrDisableReloadToLocation = true;
	sld = characterFromId("Lepricon");
	LAi_SetActorType(sld);
	sld.dialog.currentnode = "lepricon_10";
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Mtraxx_MeridaHayameeLate(string qName) // опоздание принести вещи Хайами
{
	sld = characterFromId("Hayamee");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld.lifeday = 0;
	sld = characterFromId("Tagofa");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld.lifeday = 0;
	if (pchar.location == "Locono_village") DoQuestFunctionDelay("Mtraxx_MeridaHayameeOver", 1.0);
	else
	{
		pchar.quest.mtraxx_merida_hayameelate.win_condition.l1 = "location";
		pchar.quest.mtraxx_merida_hayameelate.win_condition.l1.location = "Locono_village";
		pchar.quest.mtraxx_merida_hayameelate.function = "Mtraxx_MeridaHayameeOver";
	}
}

void Mtraxx_MeridaHayameeOver(string qName) // Хайами и Тагофа ушли
{
	chrDisableReloadToLocation = true;
	sld = characterFromId("Lepricon");
	LAi_SetActorType(sld);
	sld.dialog.currentnode = "lepricon_9";
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Mtraxx_MeridaHayameeFail() // Хайами и Тагофа ушли
{
	chrDisableReloadToLocation = false;
	sld = characterFromId("Lepricon");
	RemovePassenger(pchar, sld);
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "reload1", "none", "", "", "", 20.0);
	sld.lifeday = 0;
	sld = characterFromId("Mrt_Rocur");
	RemovePassenger(pchar, sld);
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "reload1", "none", "", "", "", 20.0);
	sld.lifeday = 0;
	Mtraxx_TerraxReset(5);
}

void Mtraxx_MeridaRemoveGifts() // удалить подарки Хайами
{
	PlaySound("interface\important_item.wav");
	for (int i=1; i<=3; i++)
	{
		if (GetCharacterFreeItem(pchar, "spyglass"+i) > 0)
		{	
			RemoveItems(pchar, "spyglass"+i, 1);
			i = 3;
		}
	}
	RemoveItems(pchar, "pistol3", 1);
	RemoveItems(pchar, "pistol5", 1);
	RemoveItems(pchar, "bullet", 30);
	RemoveItems(pchar, "grapeshot", 30);
	RemoveItems(pchar, "gunpowder", 60);
	RemoveItems(pchar, "jewelry41", 1);
	RemoveItems(pchar, "jewelry42", 1);
	ChangeIndianRelation(3.0);
	AddCharacterExpToSkill(pchar, "Leadership", 100);
}

void Mtraxx_MeridaTagofaEnter(string qName) // пришел Тагофа
{
	sld = characterFromId("Tagofa");
	ChangeCharacterAddressGroup(sld, "Locono_shack3", "reload", "reload1");
	LAi_CharacterEnableDialog(sld);
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Mtraxx_MeridaBoatLate(string qName) // опоздание построить лодки
{
	sld = characterFromId("Hayamee");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld.lifeday = 0;
	sld = characterFromId("Tagofa");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld.lifeday = 0;
	if (pchar.location == "Maracaibo_river") DoQuestFunctionDelay("Mtraxx_MeridaBoatOver", 1.0);
	else
	{
		pchar.quest.mtraxx_merida_hayameelate.win_condition.l1 = "location";
		pchar.quest.mtraxx_merida_hayameelate.win_condition.l1.location = "Maracaibo_river";
		pchar.quest.mtraxx_merida_hayameelate.function = "Mtraxx_MeridaBoatOver";
	}
}

void Mtraxx_MeridaBoatOver(string qName) // опоздание построить лодки
{
	chrDisableReloadToLocation = true;
	sld = characterFromId("Lepricon");
	LAi_SetActorType(sld);
	sld.dialog.currentnode = "lepricon_11";
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Mtraxx_MeridaBuildBoats() // строим лодки
{
	pchar.quest.Mtraxx_MeridaBoatLate.over = "yes";
	LocatorReloadEnterDisable("Shore_ship3", "boat", true); // закроем море
	RemoveCharacterGoods(pchar, GOOD_PLANKS, 20);
	RemoveCharacterGoods(pchar, GOOD_LEATHER, 10);
	bDisableCharacterMenu = true;
	pchar.GenQuest.FrameLockEsc = true;
	PlaySound("ambient\ShipYard\Fon_Out_01.wav");
	PlaySound("ambient\ShipYard\pila_001.wav");
	PlaySound("ambient\ShipYard\topor_001.wav");
	pchar.questTemp.Mtraxx = "merida_trip";
	SetLaunchFrameFormParam("Two days later..."+ NewStr() +"Six longboats has been built...", "Mtraxx_MeridaBuildBoats", 0, 5);
	LaunchFrameForm();
	StoreDayUpdate();
	WaitDate("",0,0,2,3,5);
	RecalculateJumpTable();
	RefreshWeather();
	RefreshLandTime();
	int n = Findlocation("Maracaibo_river");
	string sTemp;
	for (int i=1; i<=6; i++)
	{
		sTemp = "Boat"+i;
		locations[n].models.always.(sTemp) = "Boat";
		Locations[n].models.always.(sTemp).locator.group = "quest";
		Locations[n].models.always.(sTemp).locator.name = "boat"+i;
		Locations[n].models.always.(sTemp).tech = "DLightModel";
	}
	sld = characterFromId("Tagofa");
	LAi_CharacterEnableDialog(sld);
	AddCharacterExpToSkill(pchar, "Repair", 200);
}

void Mtraxx_MeridaWarning(string qName) // знак капонгов на тропе
{
	sld = characterFromId("Tagofa");
	sld.dialog.currentnode = "tagofa_13";
	LAi_SetActorType(sld);
	LAi_ActorDialogNow(sld, pchar, "", -1);
}

void Mtraxx_MeridaPrepareCapongAttack(string qName) // готовим атаку капонгов
{
	int i = rand(7)+3;
	DoQuestFunctionDelay("Mtraxx_MeridaCapongAttack", i);
	chrDisableReloadToLocation = true;
}

void Mtraxx_MeridaOurWarriorsAttack() // наши - к бою готовы!
{
	sld = characterFromId("Mrt_Rocur");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	sld = characterFromId("Lepricon");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	for (int i=5; i<=9; i++) // ребята Леприкона
	{
		if (GetCharacterIndex("Lepricons_pirate_"+i) != -1) 
		{
			sld = characterFromId("Lepricons_pirate_"+i);
			LAi_SetWarriorType(sld);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
	for (i=1; i<=8; i++) // наши красавцы
	{
		if (GetCharacterIndex("Merida_pirate_"+i) != -1) 
		{
			sld = characterFromId("Merida_pirate_"+i);
			LAi_SetWarriorType(sld);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
}

void Mtraxx_MeridaCheckOurWarriors() // проверка наших после боев // правки прогона 3
{
	sld = characterFromId("Mrt_Rocur");
	LAi_SetActorType(sld);
	LAi_ActorFollowEverywhere(sld, "", -1);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	sld = characterFromId("Lepricon");
	LAi_SetActorType(sld);
	LAi_ActorFollowEverywhere(sld, "", -1);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	for (int i=5; i<=9; i++) // ребята Леприкона
	{
		if (GetCharacterIndex("Lepricons_pirate_"+i) != -1) 
		{
			sld = characterFromId("Lepricons_pirate_"+i);
			if (LAi_GetCharacterHP(sld) > 0)
			{
				LAi_SetActorType(sld);
				LAi_ActorFollowEverywhere(sld, "", -1);
				LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
	}
	for (i=1; i<=8; i++) // наши красавцы
	{
		if (GetCharacterIndex("Merida_pirate_"+i) != -1) 
		{
			sld = characterFromId("Merida_pirate_"+i);
			if (LAi_GetCharacterHP(sld) > 0)
			{
				LAi_SetActorType(sld);
				LAi_ActorFollowEverywhere(sld, "", -1);
				LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
			}
		}
	}
}

void Mtraxx_MeridaCapongAttack(string qName) // атака капонгов
{
	PlaySound("interface\abordage_wining.wav");
	// активируем наших
	sld = characterFromId("Tagofa");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "reload1_back", "none", "", "", "", 10.0);
	Mtraxx_MeridaOurWarriorsAttack();
	// ставим капонгов
	LAi_group_Delete("EnemyFight");
	for (i=1; i<=12; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Capong_land_"+i, "canib_"+(rand(5)+1), "man", "man", 18, PIRATE, -1, false, "native"));
		FantomMakeCoolFighter(sld, 18, 55, 55, RandPhraseSimple("blade_01","blade_02"), "", "", 140);
		sld.name = GetIndianName(MAN);
		sld.lastname = "";
		sld.viper = true;
		if (i < 7) ChangeCharacterAddressGroup(sld, "Merida_jungle_01", "goto", "goto10");
		else ChangeCharacterAddressGroup(sld, "Merida_jungle_01", "monsters", "monster10");
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Mtraxx_MeridaCapongAfterFight");
	LAi_SetFightMode(pchar, true);
}

void Mtraxx_MeridaExitTown(string qName) // у ворот Мериды
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	chrDisableReloadToLocation = true;
	sld = characterFromId("Tagofa");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocator(sld, "quest", "waterfall", "", -1);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER); // правки прогона 3
	// ставим дозорного
	sld = GetCharacter(NPC_GenerateCharacter("Merida_guard", "mercen_23", "man", "man", 25, SPAIN, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 25, 70, 70, "blade_13", "pistol3", "grapeshot", 150);
	sld.dialog.Filename = "Quest\Roger.c";
	sld.dialog.currentnode = "merida_guard";
	sld.greeting = "";
	LAi_SetImmortal(sld, true);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	ChangeCharacterAddressGroup(sld, "Merida_ExitTown", "quest", "protector");
	LAi_SetGuardianType(sld);
	sld.protector = true;
	LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
}

void Mtraxx_MeridaHouseGuards(string qName) // выскочили мушкетеры
{
	LAi_group_Delete("EnemyFight");
	Mtraxx_MeridaOurWarriorsAttack();
	// ставим трех поселенцев-мушкетеров
	for (int i=1; i<=3; i++) 
	{
		sld = GetCharacter(NPC_GenerateCharacter("Merida_mushketer_"+i, "mush_ctz_"+i, "man", "mushketer", 25, SPAIN, -1, true, "quest"));
		if (i == 1) 
		{
			FantomMakeCoolFighter(sld, 25, 100, 100, "", "grape_mushket", "grenade", 180);
			LAi_SetCharacterUseBullet(sld, "grenade");
			if (MOD_SKILL_ENEMY_RATE > 2)
			{
				sld.cirassId = Items_FindItemIdx("cirass1");
				sld.MultiShooter = 1.0 + stf(MOD_SKILL_ENEMY_RATE/10);
				sld.MusketerDistance = 5;
			}
		}
		else 
		{
			FantomMakeCoolFighter(sld, 25, 60, 60, "", "mushket1", "cartridge", 150);
			LAi_SetCharacterUseBullet(sld, "cartridge");
			sld.MusketerDistance = 0;
		}
		SetCharacterPerk(sld, "Gunman");
		SetCharacterPerk(sld, "GunProfessional");
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		ChangeCharacterAddressGroup(sld, "Merida_ExitTown", "quest", "mushketer"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_SetFightMode(pchar, true);
	DoQuestFunctionDelay("Mtraxx_MeridaGateAttack", 10.0);
}

void Mtraxx_MeridaGateAttack(string qName) // драка у ворот
{
	PlaySound("interface\abordage_wining.wav");
	sld = characterFromId("Merida_guard");
	LAi_SetImmortal(sld, false);
	ChangeCharacterAddressGroup(sld, "Merida_ExitTown", "reload", "reload2");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	for (int i=1; i<=12; i++) 
	{
		if (i < 3)
		{
			sld = GetCharacter(NPC_GenerateCharacter("Merida_defender_"+i, "mush_spa_"+i, "man", "mushketer", 25, SPAIN, -1, true, "quest"));
			FantomMakeCoolFighter(sld, 25, 70, 70, "", "mushket1", "cartridge", 170);
			LAi_SetCharacterUseBullet(sld, "cartridge");
			if (MOD_SKILL_ENEMY_RATE > 2) sld.cirassId = Items_FindItemIdx("cirass1");
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Merida_defender_"+i, "sold_spa_"+(rand(7)+1), "man", "man", 25, SPAIN, -1, true, "quest"));
			FantomMakeCoolFighter(sld, 25, 70, 70, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol3", "grapeshot", 150);
			if (MOD_SKILL_ENEMY_RATE > 2) sld.cirassId = Items_FindItemIdx("cirass2");
		}
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		ChangeCharacterAddressGroup(sld, "Merida_ExitTown", "reload", "reload2");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetCheck("EnemyFight", "Mtraxx_MeridaGateAfterBattle");
}

void Mtraxx_MeridaTown(string qName) // бой в Мериде
{
	PlaySound("interface\abordage_wining.wav");
	LAi_group_Delete("EnemyFight");
	chrDisableReloadToLocation = true;
	Mtraxx_MeridaOurWarriorsAttack();
	for (i=1; i<=3; i++)
	{
		int idx = GetOfficersIndex(pchar, i);
		if (idx < 1) continue;
		sld = &Characters[idx];
		ChangeCharacterAddressGroup(sld, "Merida_Town", "officers", "reload19_"+i);
	}
	// защитники
	for (int i=1; i<=12; i++) 
	{
		if (i > 9)
		{
			sld = GetCharacter(NPC_GenerateCharacter("Merida_citizen_"+i, "mush_spa_"+(i-9), "man", "mushketer", 25, SPAIN, -1, true, "quest"));
			FantomMakeCoolFighter(sld, 25, 70, 70, "", "mushket1", "cartridge", 170);
			LAi_SetCharacterUseBullet(sld, "cartridge");
			if (MOD_SKILL_ENEMY_RATE > 2) sld.cirassId = Items_FindItemIdx("cirass1");
			sld.MusketerDistance = 0;
			ChangeCharacterAddressGroup(sld, "Merida_Town", "rld", "loc"+(i-10));
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Merida_citizen_"+i, "citiz_1"+i, "man", "man", 15, SPAIN, -1, true, "quest"));
			FantomMakeCoolFighter(sld, 15, 40, 40, LinkRandPhrase("blade_09","blade_11","blade_14"), "pistol1", "bullet", 100);
			ChangeCharacterAddressGroup(sld, "Merida_Town", "goto", "goto"+i);
		}
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Mtraxx_MeridaAfterBattle");
	LAi_SetFightMode(pchar, true);
}

void Mtraxx_MeridaTownhall(string qName) // в резиденции Мериды
{
	chrDisableReloadToLocation = true;
	// ставим мэра
	sld = GetCharacter(NPC_GenerateCharacter("Merida_head", "huber_spa", "man", "man", 20, SPAIN, 1, true, "quest"));
	FantomMakeCoolFighter(sld, 20, 50, 50, "blade_15", "", "", 100);
	sld.dialog.Filename = "Quest\Roger.c";
	sld.dialog.currentnode = "merida_head";
	sld.name = "Demetrio";
	sld.lastname = "Rojas";
	sld.greeting = "";
	LAi_SetImmortal(sld, true);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	ChangeCharacterAddressGroup(sld, "Merida_townhall", "goto", "goto1");
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, "SPAIN_CITIZENS");
}

void Mtraxx_MeridaExit(string qName) // покидаем город
{
	DoQuestCheckDelay("Saga_MineSetMusic", 1.5);
	Mtraxx_MeridaCheckOurWarriors();
	// антураж захваченного города
	for (int i=1; i<=18; i++) // дым
	{
		if (i == 3) continue;
		CreateLocationParticles("Bomb_Smoke", "reload", "reload"+i, 0, 0, 0, "torch_deck");
	}
	for (i=1; i<=18; i++) // огонь
	{
		if (i == 3) continue;
		CreateLocationParticles("shipfire", "reload", "reload"+i, 0, 0, 0, "fortfire");
	}
	for (i=1; i<=15; i++) // дым
	{
		CreateLocationParticles("smoke", "goto", "goto"+i, 0, 0, 0, "");
	}
	for (i=1; i<=10; i++) // жертвы нападения
	{
		if (i < 6)
		{
			sld = GetCharacter(NPC_GenerateCharacter("Merida_victim_"+i, "citiz_1"+i, "man", "man", 5, SPAIN, 1, true, "quest"));
			SetFantomParamFromRank(sld, 5, true);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Merida_victim_"+i, "women_"+(4+i), "woman", "towngirl", 5, SPAIN, 1, true, "quest"));
			SetFantomParamFromRank(sld, 5, true);
		}
		RemoveAllCharacterItems(sld, true);
		sld.DontClearDead = true;
		LAi_SetStayType(sld);
		ChangeCharacterAddressGroup(sld, "Merida_town", "goto", "goto"+(15+i));
		LAi_KillCharacter(sld);
	}
	// открываем локаторы
	LocatorReloadEnterDisable("Merida_ExitTown", "reload1_back", false);
	LocatorReloadEnterDisable("Merida_Town", "gate_back", false);
	pchar.quest.mtraxx_merida_back.win_condition.l1 = "location";
	pchar.quest.mtraxx_merida_back.win_condition.l1.location = "Merida_ExitTown";
	pchar.quest.mtraxx_merida_back.function = "Mtraxx_MeridaBack";
	// НЗГ
	pchar.quest.mtraxx_merida_headhunt.win_condition.l1 = "MapEnter";
	pchar.quest.mtraxx_merida_headhunt.function = "Mtraxx_MeridaHeadHunter";
}

void Mtraxx_MeridaHeadHunter(string qName) // НЗГ и прочее
{
	ChangeCharacterComplexReputation(pchar, "fame", 10);
	ChangeCharacterComplexReputation(pchar, "authority", 5);
	ChangeCharacterComplexReputation(pchar, "nobility", -20);
	OfficersReaction("bad");
	OfficersReaction("bad");
	ChangeCharacterHunterScore(PChar, "spahunter", 30);
}

void Mtraxx_MeridaBack(string qName) // вышли из Мериды
{
	LocatorReloadEnterDisable("Merida_ExitTown", "reload2", true);
	sld = characterFromId("Tagofa");
	LAi_SetActorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	LAi_ActorFollowEverywhere(sld, "", -1);
	pchar.quest.mtraxx_merida_cave.win_condition.l1 = "location";
	pchar.quest.mtraxx_merida_cave.win_condition.l1.location = "Serpentine_cave";
	pchar.quest.mtraxx_merida_cave.function = "Mtraxx_MeridaCave";
}

void Mtraxx_MeridaCave(string qName) // в пещере
{
	int i = 3 + rand(3);
	chrDisableReloadToLocation = true;
	DoQuestFunctionDelay("Mtraxx_MeridaCaveAttack", i);
}

void Mtraxx_MeridaCaveAttack(string qName) // атака капонгов в пещере
{
	PlaySound("interface\abordage_wining.wav");
	// активируем наших
	sld = characterFromId("Tagofa");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "reload1_back", "none", "", "", "", 10.0);
	Mtraxx_MeridaOurWarriorsAttack();
	// ставим капонгов
	LAi_group_Delete("EnemyFight");
	for (i=1; i<=8; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Capong_cave_"+i, "canib_"+(rand(5)+1), "man", "man", 25, PIRATE, -1, false, "native"));
		FantomMakeCoolFighter(sld, 25, 80, 80, RandPhraseSimple("blade_01","blade_02"), "", "", 150);
		sld.name = GetIndianName(MAN);
		sld.lastname = "";
		sld.viper = true;
		ChangeCharacterAddressGroup(sld, "Serpentine_cave", "monsters", "monster"+i);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Mtraxx_MeridaCaveAfterFight");
	LAi_SetFightMode(pchar, true);
}

void Mtraxx_MeridaReturn(string qName) // уплываем назад по реке
{
	bDisableCharacterMenu = true;
	pchar.GenQuest.FrameLockEsc = true;
	SetMusic("music_map");
	SetLaunchFrameFormParam("", "", 0, 15);
	SetLaunchFrameFormPic("loading\River_1.tga");
	LaunchFrameForm();
	WaitDate("", 0, 0, 2, 2, 20); //крутим время
	RecalculateJumpTable();
	StoreDayUpdate();
	RefreshWeather();
	RefreshLandTime();
	DoQuestFunctionDelay("Mtraxx_MeridaReturnEnd", 15.0);
}

void Mtraxx_MeridaReturnEnd(string qName) // уплываем назад по реке
{
	DoQuestReloadToLocation("Maracaibo_river", "reload", "reload2", "Mtraxx_MeridaReturnEnd");
}

void Mtraxx_MeridaFinal(string qName) // на берегу, дележ добычи
{
	chrDisableReloadToLocation = true;
	pchar.GenQuest.Hunter2Pause = true;
	// чистим нпс
	for (int i=5; i<=9; i++) // ребята Леприкона
	{
		if (GetCharacterIndex("Lepricons_pirate_"+i) != -1) 
		{
			sld = characterFromId("Lepricons_pirate_"+i);
			sld.lifeday = 0;
			LAi_SetWarriorType(sld);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
	for (i=1; i<=8; i++) // наши красавцы
	{
		if (GetCharacterIndex("Merida_pirate_"+i) != -1) 
		{
			sld = characterFromId("Merida_pirate_"+i);
			sld.lifeday = 0;
			LAi_SetWarriorType(sld);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
	sld = characterFromId("Mrt_Rocur");
	sld.dialog.currentnode = "rocur_44";
	LAi_SetActorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Mtraxx_MeridaReturnLate(string qName) // затянул с возвращением
{
	pchar.quest.mtraxx_merida_returnover.win_condition.l1 = "Location_Type";
	pchar.quest.mtraxx_merida_returnover.win_condition.l1.location_type = "town";
	pchar.quest.mtraxx_merida_returnover.function = "Mtraxx_MeridaReturnOver";
	pchar.quest.mtraxx_merida_returnover1.win_condition.l1 = "Location_Type";
	pchar.quest.mtraxx_merida_returnover1.win_condition.l1.location_type = "seashore";
	pchar.quest.mtraxx_merida_returnover1.function = "Mtraxx_MeridaReturnOver";
	pchar.questTemp.Mtraxx = "merida_returnover";
}

void Mtraxx_MeridaReturnOver(string qName) // затянул с возвращением
{
	if (pchar.questTemp.Mtraxx != "merida_returnover") return;
	chrDisableReloadToLocation = true;
	float locx, locy, locz;
	sld = characterFromId("Lepricon");
	LAi_SetActorType(sld);
	sld.dialog.currentnode = "lepricon_12";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Mtraxx_MeridaReturnFail() // затянул с возвращением
{
	pchar.quest.mtraxx_merida_lavega.over = "yes";
	chrDisableReloadToLocation = false;
	sld = characterFromId("Lepricon");
	RemovePassenger(pchar, sld);
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "reload4", "none", "", "", "", 10.0);
	sld.lifeday = 0;
	sld = characterFromId("Mrt_Rocur");
	RemovePassenger(pchar, sld);
	sld.lifeday = 0;
	AddQuestRecord("Roger_5", "21");
	Mtraxx_TerraxReset(5);
}

// Эпизод 6. Двуликий Янус.
void Mtraxx_IgnasioKitty(string qName) // ставим пинас Китти
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	pchar.quest.mtraxx_merida_returnover.over = "yes";
	pchar.quest.mtraxx_merida_returnover1.over = "yes";
	pchar.quest.Mtraxx_MeridaReturnLate.over = "yes";
	LocatorReloadEnterDisable("LaVega_port", "boat", true);
	Group_FindOrCreateGroup("Mtr_Kitty");
	sld = GetCharacter(NPC_GenerateCharacter("Mtr_KittyCap", "mercen_10", "man", "man", 20, ENGLAND, -1, false, "soldier"));
	FantomMakeCoolSailor(sld, SHIP_PINNACE, "Kitty", CANNON_TYPE_CANNON_LBS16, 50, 50, 50);
	FantomMakeCoolFighter(sld, 20, 40, 40, "blade_11", "pistol1", "bullet", 50);
	SetShipSkill(sld, 30, 90, 40, 45, 65, 55, 20, 50, 45);
	sld.Dialog.Filename = "Quest\Roger.c";
	sld.DeckDialogNode = "kittycap";
	sld.greeting = "captain";
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "pirate";
	SetCharacterPerk(sld, "MusketsShoot");
	UpgradeShipParameter(sld, "Capacity");
	int iSpace = GetCharacterFreeSpace(sld, GOOD_EBONY);
	Fantom_SetCharacterGoods(sld, GOOD_EBONY, iSpace, 1);
	sld.Abordage.Enable = false;
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true; 
	LAi_SetImmortal(sld, true); // сплошная защита от дурака
	sld.DontDeskTalk = true;
	Group_AddCharacter("Mtr_Kitty", "Mtr_KittyCap");
	Group_SetGroupCommander("Mtr_Kitty", "Mtr_KittyCap");
	Group_SetTaskNone("Mtr_Kitty");
	Group_SetAddress("Mtr_Kitty", "Hispaniola1", "quest_ships", "quest_ship_3");
	Group_LockTask("Mtr_Kitty");
}

void Mtraxx_IgnasioTimeOver(string qName) // опоздали
{
	pchar.quest.mtraxx_ignasio_sail.over = "yes";
	pchar.quest.mtraxx_ignasio_sinkkitty.over = "yes";
	sld = characterFromId("Mtr_KittyCap");
	RemoveCharacterCompanion(pchar, sld);
	AddQuestRecord("Roger_6", "2");
	Mtraxx_TerraxReset(6);
}

void Mtraxx_IgnasioKittySink(string qName) // потеряли пинас
{
	pchar.quest.mtraxx_ignasio_sail.over = "yes";
	pchar.quest.Mtraxx_IgnasioTimeOver.over = "yes";
	AddQuestRecord("Roger_6", "3");
	Mtraxx_TerraxReset(6);
}

void Mtraxx_IgnasioArrive(string qName) // прибыли на Барбадос
{
	pchar.GenQuest.Hunter2Pause = true;
	pchar.quest.mtraxx_ignasio_sinkkitty.over = "yes";
	pchar.quest.Mtraxx_IgnasioTimeOver.over = "yes";
	chrDisableReloadToLocation = true;
	sld = characterFromId("Mtr_KittyCap");
	sld.dialog.currentnode = "kittycap_3";
	LAi_CharacterEnableDialog(sld);
	ChangeCharacterAddressGroup(sld, "Bridgetown_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Mtraxx_IgnasioCreateMarko() // ставим Игнасио Марко
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	float locx, locy, locz;
	sld = GetCharacter(NPC_GenerateCharacter("Ignasio", "Marco", "man", "man", 30, ENGLAND, -1, false, "soldier"));
	FantomMakeCoolSailor(sld, SHIP_POLACRE_QUEST, "Torero", CANNON_TYPE_CANNON_LBS24, 60, 60, 60);
	FantomMakeCoolFighter(sld, 30, 80, 80, "blade_10", "pistol6", "bullet", 150);
	sld.Dialog.Filename = "Quest\Roger.c";
	sld.dialog.currentnode = "ignasio";
	sld.greeting = "captain";
	sld.name = "Ignacio";
	sld.lastname = "Marco";
	SetCharacterPerk(sld, "BasicDefense");
	SetCharacterPerk(sld, "Gunman");
	SetCharacterPerk(sld, "GunProfessional");
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "HardHitter");
	SetCharacterPerk(sld, "SwordplayProfessional");
	SetCharacterPerk(sld, "Doctor1");
	SetCharacterPerk(sld, "Doctor2");
	SetCharacterPerk(sld, "WindCatcher");
	SetCharacterPerk(sld, "SailsMan");
	SetCharacterPerk(sld, "LongRangeShoot");
	SetCharacterPerk(sld, "CannonProfessional");
	SetCharacterPerk(sld, "BasicBattleState");
	SetCharacterPerk(sld, "AdvancedBattleState");
	SetCharacterPerk(sld, "ShipDefenseProfessional");
	SetCharacterPerk(sld, "LongRangeGrappling");
	SetCharacterPerk(sld, "GrapplingProfessional");
	int n = 60 + MOD_SKILL_ENEMY_RATE*4;
	SetSPECIAL(sld, 7, 5, 6, 6, 5, 10, 6);
	SetSelfSkill(sld, 65, n, 60, 90, 55);
	SetShipSkill(sld, 45, 50, n, n, 90, 70, 90, n, 70);
	sld.Ship.Crew.Morale = n;
	sld.Ship.Crew.Exp.Sailors = n;
	sld.Ship.Crew.Exp.Cannoners = n;
	sld.Ship.Crew.Exp.Soldiers = n;
	UpgradeShipParameter(sld, "MaxCrew");
	int hcrew = GetMaxCrewQuantity(sld);
	SetCrewQuantity(sld, hcrew);
	if (MOD_SKILL_ENEMY_RATE > 2)
	{
		SetCharacterPerk(sld, "MusketsShoot");
		sld.cirassId = Items_FindItemIdx("cirass1");
		sld.multifighter = 1.2 + stf(MOD_SKILL_ENEMY_RATE/10);
		sld.MultiShooter = 1.0 + stf(MOD_SKILL_ENEMY_RATE/10);
	}
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.AlwaysSandbankManeuver = true;
	sld.ShipHideImmortal = 500; // непотопляемый корабль
	Character_SetAbordageEnable(sld, false); // нельзя абордировать
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, "Bridgetown_town", "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz)); // прогона 3
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	// Исла де Коче
	int i = FindIsland("IslaDeCoche");
	Islands[i].visible = true;
	Islands[i].reload_enable = true;
}

void Mtraxx_IgnasioAddMarko() // Игнасио - в эскадру
{
	chrDisableReloadToLocation = false;
	LAI_SetPlayerType(pchar);           
	DoQuestReloadToLocation("Bridgetown_tavern", "tables", "stay2", "");
	sld = CharacterFromID("Ignasio");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	SetCharacterRemovable(sld, false);
	sld.CompanionEnemyEnable = false; //всегда друзья
	SetCompanionIndex(pchar, -1, sti(sld.index));
	sld.loyality = MAX_LOYALITY;
	sld.Tasks.CanBoarding = false; // запрет идти на абордаж - дубль
	sld.Tasks.CanChangeShipAfterBoarding = false; // запрет меняться кораблями - дубль
	if (CheckAttribute(pchar, "questTemp.HWIC.Isladecoche"))
	{
		AddQuestRecord("Roger_6", "4");
		DeleteAttribute(pchar, "questTemp.HWIC.Isladecoche");
	}
	else 
	{
		AddQuestRecord("Roger_6", "5");
	}
	pchar.questTemp.Mtraxx = "ignasio_toisland";
	pchar.quest.mtraxx_ignasio_island.win_condition.l1 = "location";
	pchar.quest.mtraxx_ignasio_island.win_condition.l1.location = "IslaDeCoche";
	pchar.quest.mtraxx_ignasio_island.function = "Mtraxx_IgnasioCreateCaravane";
	SetFunctionTimerCondition("Mtraxx_IgnasioCaravaneTimeOver", 0, 0, 15, false); // таймер для шибко грамотных
}

void Mtraxx_IgnasioCaravaneTimeOver(string qName) // время вышло - взрываем корабль ГГ
{
	pchar.quest.mtraxx_ignasio_island.over = "yes";
	if (bSeaActive) DoQuestFunctionDelay("Mtraxx_MarkusGameOver", 2.0);
	else 
	{
		pchar.quest.mtraxx_ignasio_boom.win_condition.l1 = "EnterToSea";
		pchar.quest.mtraxx_ignasio_boom.function = "Mtraxx_IgnasioTimeOverBoom";
	}
}

void Mtraxx_IgnasioTimeOverBoom(string qName) // время вышло - взрываем корабль ГГ
{
	bQuestDisableMapEnter = true;
	DoQuestFunctionDelay("Mtraxx_MarkusGameOver", 3.0);
}

void Mtraxx_IgnasioCreateCaravane(string qName) // ставим голландцев
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	pchar.quest.Mtraxx_IgnasioCaravaneTimeOver.over = "yes";
	AddQuestRecord("Roger_6", "6");
	Island_SetReloadEnableGlobal("IslaDeCoche", false);
	bQuestDisableMapEnter = true;//закрыть карту
	Group_FindOrCreateGroup("Mtr_IgnasioSeaGroup");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+5;
	int iScl = 30 + 3*sti(pchar.rank);
	int Type, iShip, iCannon, iSpace, iCrew, hcrew;
	int n = 3;
	if (MOD_SKILL_ENEMY_RATE > 6) n = 4;
	for (int i=1; i<=n; i++)
	{
		switch (i)
		{
			case 1:
				iShip = SHIP_NAVIO;
				iCannon = CANNON_TYPE_CANNON_LBS24;
				if (MOD_SKILL_ENEMY_RATE < 6) iCannon = CANNON_TYPE_CANNON_LBS20;
			break;
			
			case 2:
				iShip = SHIP_PINNACE;
				iCannon = CANNON_TYPE_CULVERINE_LBS18;
				if (MOD_SKILL_ENEMY_RATE < 6) iCannon = CANNON_TYPE_CANNON_LBS20;
			break;
			
			case 3:
				iShip = SHIP_FLEUT;
				iCannon = CANNON_TYPE_CANNON_LBS16;
			break;
			
			case 4:
				iShip = SHIP_XebekVML;
				iCannon = CANNON_TYPE_CULVERINE_LBS18;
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("Mtr_IgnasioSeaCap_"+i, "off_hol_"+(5-i), "man", "man", iRank, HOLLAND, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, iScl+(25-i*5), iScl+(25-i*5), iScl+(25-i*5));
		FantomMakeCoolFighter(sld, iRank, iScl+(25-i*5), iScl+(25-i*5), LinkRandPhrase("blade_15","blade_16","topor_04"), "pistol1", "bullet", iScl*2);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysEnemy = true;
		sld.AlwaysSandbankManeuver = true;
		sld.Ship.Mode = "war";
		sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*6;
		if (MOD_SKILL_ENEMY_RATE > 2) SetCharacterPerk(sld, "MusketsShoot");
		if (i == 1) 
		{
			hcrew = GetMaxCrewQuantity(sld);
			iCrew = sti(0.8*hcrew);
			SetCrewQuantityOverMax(sld, iCrew);
			SetRandGeraldSail(sld, HOLLAND);
			sld.ship.HP = sti(sld.ship.HP)-makeint(sti(sld.ship.HP)/6);
			AddCharacterGoods(sld, GOOD_SILVER, 350);
			iSpace = GetCharacterFreeSpace(sld, GOOD_MAHOGANY);
			Fantom_SetCharacterGoods(sld, GOOD_MAHOGANY, iSpace, 1);
		}
		if (i == 2) 
		{
			hcrew = GetMaxCrewQuantity(sld);
			iCrew = sti(0.7*hcrew);
			SetCrewQuantityOverMax(sld, iCrew);
			sld.ship.HP = sti(sld.ship.HP)-makeint(sti(sld.ship.HP)/5);
			AddCharacterGoods(sld, GOOD_SILVER, 275);
			iSpace = GetCharacterFreeSpace(sld, GOOD_MAHOGANY);
			Fantom_SetCharacterGoods(sld, GOOD_MAHOGANY, iSpace, 1);
		}
		if (i == 3) 
		{
			hcrew = GetMaxCrewQuantity(sld);
			iCrew = sti(0.6*hcrew);
			SetCrewQuantityOverMax(sld, iCrew);
			sld.ship.HP = sti(sld.ship.HP)-makeint(sti(sld.ship.HP)/4);
			AddCharacterGoods(sld, GOOD_SILVER, 175);
			iSpace = GetCharacterFreeSpace(sld, GOOD_MAHOGANY);
			Fantom_SetCharacterGoods(sld, GOOD_MAHOGANY, iSpace, 1);
		}
		Group_AddCharacter("Mtr_IgnasioSeaGroup", "Mtr_IgnasioSeaCap_"+i);
	}
	Group_SetGroupCommander("Mtr_IgnasioSeaGroup", "Mtr_IgnasioSeaCap_1");
	Group_SetAddress("Mtr_IgnasioSeaGroup", "IslaDeCoche", "quest_ships", "quest_ship_5");
	Group_SetTaskAttack("Mtr_IgnasioSeaGroup", PLAYER_GROUP);
	Group_LockTask("Mtr_IgnasioSeaGroup");
	pchar.questTemp.Mtraxx.Mahogany = GetSquadronGoods(pchar, GOOD_MAHOGANY);
	pchar.questTemp.Mtraxx.Silver = GetSquadronGoods(pchar, GOOD_SILVER);
	pchar.quest.mtraxx_ignasio_afterbattle.win_condition.l1 = "Group_Death";
	pchar.quest.mtraxx_ignasio_afterbattle.win_condition.l1.group = "Mtr_IgnasioSeaGroup";
	pchar.quest.mtraxx_ignasio_afterbattle.function = "Mtraxx_IgnasioAfterBattle";
}

void Mtraxx_IgnasioAfterBattle(string qName) // победили голландцев
{
	DoQuestCheckDelay("sea_victory", 1.5);
	pchar.GenQuest.MapClosedNoBattle = true;
	AddQuestRecord("Roger_6", "7");
	Island_SetReloadEnableGlobal("IslaDeCoche", true);
	pchar.quest.mtraxx_ignasio_land.win_condition.l1 = "location";
	pchar.quest.mtraxx_ignasio_land.win_condition.l1.location = "shore78";
	pchar.quest.mtraxx_ignasio_land.function = "Mtraxx_IgnasioOnLand";
	pchar.quest.mtraxx_ignasio_land1.win_condition.l1 = "location";
	pchar.quest.mtraxx_ignasio_land1.win_condition.l1.location = "shore79";
	pchar.quest.mtraxx_ignasio_land1.function = "Mtraxx_IgnasioOnLand";
	AddComplexSeaExpToScill(100, 100, 100, 100, 100, 100, 0);
}

void Mtraxx_IgnasioOnLand(string qName) // высадились на берег для дележа
{
	pchar.GenQuest.Hunter2Pause = true;
	pchar.quest.mtraxx_ignasio_land.over = "yes";
	pchar.quest.mtraxx_ignasio_land1.over = "yes";
	chrDisableReloadToLocation = true;
	sld = CharacterFromID("Ignasio");
	sld.dialog.currentnode = "ignasio_13";
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	for (int i=1; i<=9; i++) // 
	{
		sld = GetCharacter(NPC_GenerateCharacter("Ignasio_pirate_"+i, "citiz_4"+i, "man", "man", 18, PIRATE, 0, true, "soldier"));
		FantomMakeCoolFighter(sld, 25, 50, 50, LinkRandPhrase("blade_07","blade_08","blade_11"), "pistol1", "bullet", 120);
		LAi_CharacterDisableDialog(sld);
		if (i < 5) ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto"+i);
		else ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
}

void Mtraxx_IgnasioEscape() // Игнасио уходит
{
	sld = CharacterFromID("Ignasio");
	RemoveCharacterCompanion(pchar, sld);
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "sea", "none", "", "", "Mtraxx_IgnasioEscape", -1);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	for (int i=1; i<=5; i++) // 
	{
		sld = CharacterFromID("Ignasio_pirate_"+i);
		LAi_SetActorType(sld);
		LAi_ActorRunToLocation(sld, "reload", "sea", "none", "", "", "", 10);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	DeleteAttribute(pchar, "questTemp.Mtraxx.Silver");
	DeleteAttribute(pchar, "questTemp.Mtraxx.Mahogany");
}

void Mtraxx_IgnasioOurEscape() // убираем наших антуражников
{
	sld = CharacterFromID("Ignasio_spy");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "sea", "none", "", "", "", -1);
	for (int i=6; i<=9; i++) // 
	{
		sld = CharacterFromID("Ignasio_pirate_"+i);
		LAi_SetActorType(sld);
		LAi_ActorRunToLocation(sld, "reload", "sea", "none", "", "", "", 10);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	chrDisableReloadToLocation = false;
	pchar.quest.mtraxx_ignasio_spanish.win_condition.l1 = "location";
	pchar.quest.mtraxx_ignasio_spanish.win_condition.l1.location = "IslaDeCoche";
	pchar.quest.mtraxx_ignasio_spanish.function = "Mtraxx_IgnasioPrepareSpanish";
	AddQuestRecord("Roger_6", "8");
}

void Mtraxx_IgnasioPrepareSpanish(string qName) // ставим убегающего Игнасио Марко
{
	Island_SetReloadEnableGlobal("IslaDeCoche", false); // правки релиза
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	Group_FindOrCreateGroup("IgnasioSeaGroup");
	sld = CharacterFromID("Ignasio");
	DeleteAttribute(sld, "ship.sails");
    DeleteAttribute(sld, "ship.blots");
    DeleteAttribute(sld, "ship.masts");
	sld.Abordage.Enable = false;
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true; 
	LAi_SetImmortal(sld, true); // сплошная защита от дурака
	sld.DontDeskTalk = true;
	sld.nation = SPAIN;
	Group_AddCharacter("IgnasioSeaGroup", "Ignasio");
	Group_SetGroupCommander("IgnasioSeaGroup", "Ignasio");
	Group_SetAddress("IgnasioSeaGroup", "IslaDeCoche", "quest_ships", "quest_ship_5");
	Group_SetTaskRunAway("IgnasioSeaGroup", PLAYER_GROUP);
	Group_LockTask("IgnasioSeaGroup");
	DoQuestFunctionDelay("Mtraxx_IgnasioCreateSpanish", 2.0);
}

void Mtraxx_IgnasioCreateSpanish(string qName) // 
{
	int iShip, iCannon, iRank, iScl;
	Group_FindOrCreateGroup("LosadaSeaGroup");
	for (int i=1; i<=3; i++)
	{
		switch (i)
		{
			case 1:
				iRank = 45;
				iScl = 110;
				iShip = SHIP_GALEON_H;
				iCannon = CANNON_TYPE_CANNON_LBS24;
			break;
			
			case 2:
				iRank = 35;
				iScl = 100;
				iShip = SHIP_CORVETTE;
				iCannon = CANNON_TYPE_CULVERINE_LBS18;
			break;
			
			case 3:
				iRank = 35;
				iScl = 100;
				iShip = SHIP_XebekVML;
				iCannon = CANNON_TYPE_CULVERINE_LBS18;
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("Losada_Seacap_"+i, "off_spa_"+(7-i), "man", "man", iRank, SPAIN, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, iScl, iScl, iScl);
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, LinkRandPhrase("blade_18","blade_19","blade_20"), "pistol5", "bullet", 250);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.cirassId = Items_FindItemIdx("cirass4");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysEnemy = true;
		sld.AlwaysSandbankManeuver = true;
		sld.Ship.Mode = "war";
		sld.ship.Crew.Morale = 100;
		sld.Ship.Crew.Exp.Sailors = 100;
		sld.Ship.Crew.Exp.Cannoners = 100;
		sld.Ship.Crew.Exp.Soldiers = 100;
		SetCharacterPerk(sld, "MusketsShoot");
		if (i == 1) 
		{
			SetShipSkill(sld, 60, 50, 100, 100, 100, 100, 100, 100, 70);
			SetCharacterPerk(sld, "LongRangeShoot");
			SetCharacterPerk(sld, "FastReload");
			SetCharacterPerk(sld, "CannonProfessional");
			SetCharacterPerk(sld, "ShipDefenseProfessional");
			SetCharacterPerk(sld, "WindCatcher");
			SetCharacterPerk(sld, "SailsMan");
			SetCharacterPerk(sld, "SailingProfessional");
			Character_SetAbordageEnable(sld, false);
			SetRandGeraldSail(sld, SPAIN);
			int hcrew = GetMaxCrewQuantity(sld);
			SetCrewQuantityOverMax(sld, 1.2*hcrew);
			sld.name = "Eduardo";
			sld.lastname = "de Losada";
			sld.ship.name = "El Casador";
			NullCharacterGoods(sld);
			UpgradeShipParameter(sld, "SpeedRate");
			UpgradeShipParameter(sld, "HP");
			DeleteAttribute(sld, "ship.hulls");
			AddCharacterGoods(sld, GOOD_BALLS, 1500);
			AddCharacterGoods(sld, GOOD_GRAPES, 1000);
			AddCharacterGoods(sld, GOOD_KNIPPELS, 700);
			AddCharacterGoods(sld, GOOD_BOMBS, 1500);
			AddCharacterGoods(sld, GOOD_POWDER, 3000);
			AddCharacterGoods(sld, GOOD_WEAPON, 750);
			AddCharacterGoods(sld, GOOD_FOOD, 500);
			AddCharacterGoods(sld, GOOD_MEDICAMENT, 150);
			AddCharacterGoods(sld, GOOD_RUM, 50);
		}
		Group_AddCharacter("LosadaSeaGroup", "Losada_Seacap_"+i);
	}
	Group_SetGroupCommander("LosadaSeaGroup", "Losada_Seacap_1");
	Group_SetAddress("LosadaSeaGroup", "IslaDeCoche", "", "");
	Group_SetTaskAttack("LosadaSeaGroup", PLAYER_GROUP);
	Group_LockTask("LosadaSeaGroup");
	DoQuestFunctionDelay("Mtraxx_IgnasioSetSpanish", 2.0);
	pchar.questTemp.Mtraxx.LosadaEscape = "true";
	// для бравых
	pchar.quest.mtraxx_ignasio_open.win_condition.l1 = "NPC_Death";
	pchar.quest.mtraxx_ignasio_open.win_condition.l1.character = "Losada_Seacap_1";
	pchar.quest.mtraxx_ignasio_open.function = "Mtraxx_IgnasioExit";
	pchar.quest.mtraxx_ignasio_brave.win_condition.l1 = "Group_Death";
	pchar.quest.mtraxx_ignasio_brave.win_condition.l1.group = "LosadaSeaGroup";
	pchar.quest.mtraxx_ignasio_brave.function = "Mtraxx_IgnasioBrave";
}

void Mtraxx_IgnasioSetSpanish(string qName) // 
{
	Sea_LoginGroupCurrentSea("LosadaSeaGroup");
	AddQuestRecord("Roger_6", "9");
}

void Mtraxx_IgnasioExit(string qName) // 
{
	ChangeCharacterHunterScore(PChar, "spahunter", 15);
	DoQuestFunctionDelay("Mtraxx_IgnasioOpenMap", 2.0);
	AddQuestRecord("Roger_6", "12");
	AddComplexSeaExpToScill(100, 100, 100, 100, 100, 100, 0);
}

void Mtraxx_IgnasioBrave(string qName) // 
{
	DoQuestCheckDelay("sea_victory", 1.5);
	Group_DeleteGroup("LosadaSeaGroup");
	pchar.quest.mtraxx_ignasio_map.over = "yes";
	DeleteAttribute(pchar, "questTemp.Mtraxx.LosadaEscape");
	bQuestDisableMapEnter = false;
	AddQuestRecord("Roger_6", "10");
	pchar.quest.mtraxx_ignasio_clear.win_condition.l1 = "MapEnter";
	pchar.quest.mtraxx_ignasio_clear.function = "Mtraxx_IgnasioClearSeaGroup";
	QuestSetCurrentNode("Terrax", "mtraxx_48");
	ChangeCharacterHunterScore(PChar, "spahunter", 10);
	pchar.questTemp.Mtraxx.LosadaSink = "true";
	AddComplexSeaExpToScill(150, 150, 150, 150, 150, 150, 0);
}

void Mtraxx_IgnasioClearSeaGroup(string qName) // 
{
	Group_DelCharacter("IgnasioSeaGroup", "Ignasio");
	Group_DeleteGroup("IgnasioSeaGroup");
	Island_SetReloadEnableGlobal("IslaDeCoche", true); // правки релиза
}

void Mtraxx_IgnasioClearSeaGroups(string qName) // 
{
	Group_DelCharacter("IgnasioSeaGroup", "Ignasio");
	Group_DeleteGroup("IgnasioSeaGroup");
	Island_SetReloadEnableGlobal("IslaDeCoche", true); // правки релиза
	pchar.quest.mtraxx_ignasio_brave.over = "yes";
	pchar.quest.mtraxx_ignasio_open.over = "yes";
	Group_DeleteGroup("LosadaSeaGroup");
	AddQuestRecord("Roger_6", "11");
	QuestSetCurrentNode("Terrax", "mtraxx_48");
	AddCharacterExpToSkill(pchar, "Fortune", 300);
	AddCharacterExpToSkill(pchar, "Sneak", 300);
}

void Mtraxx_IgnasioOpenMap() // 
{
	bQuestDisableMapEnter = false;
	DeleteAttribute(pchar, "questTemp.Mtraxx.LosadaEscape");
	pchar.quest.mtraxx_ignasio_map.win_condition.l1 = "MapEnter";
	pchar.quest.mtraxx_ignasio_map.function = "Mtraxx_IgnasioClearSeaGroups";
}

// эпизод 7-й. Сокровища свободного ярла.
void Mtraxx_WolfreekReadLogbook() // чтение судового журнала
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	if (pchar.location == Get_My_Cabin())
	{
		if (CheckAttribute(pchar, "questTemp.Mtraxx.Logbook.CanRead"))
		{
			WaitDate("", 0, 0, 0, 3, 30);
			DeleteAttribute(pchar, "questTemp.Mtraxx.Logbook.CanRead");
			bQuestDisableMapEnter = false;//открыть карту
			DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
			if (CheckAttribute(pchar, "questTemp.Mtraxx.Logbook.Page1"))
			{
				AddQuestRecord("Roger_7", "2");
				AddQuestRecordInfo("Wolfreek_Journal", "1");
				DeleteAttribute(pchar, "questTemp.Mtraxx.Logbook.Page1");
				pchar.quest.mtraxx_wolfreek_bay.win_condition.l1 = "location";
				pchar.quest.mtraxx_wolfreek_bay.win_condition.l1.location = "PortoBello";
				pchar.quest.mtraxx_wolfreek_bay.function = "Mtraxx_WolfreekMoskitos";				
			}
			if (CheckAttribute(pchar, "questTemp.Mtraxx.Logbook.Page2"))
			{
				AddQuestRecord("Roger_7", "8");
				AddQuestRecordInfo("Wolfreek_Journal", "2");
				DeleteAttribute(pchar, "questTemp.Mtraxx.Logbook.Page2");
				pchar.questTemp.Mtraxx.Jeweller = "true";		
			}
			if (CheckAttribute(pchar, "questTemp.Mtraxx.Logbook.Page3"))
			{
				DeleteAttribute(pchar, "questTemp.Mtraxx.Logbook.Page3");
				if (CheckAttribute(pchar, "questTemp.HWIC.Jino"))
				{
					pchar.questTemp.Mtraxx.Gord = "true";
					AddQuestRecord("Roger_7", "13");
				}
				else
				{
					QuestSetCurrentNode("Terrax", "mtraxx_59");
					AddQuestRecord("Roger_7", "14");
				}
			}
			if (CheckAttribute(pchar, "questTemp.Mtraxx.Logbook.Page4"))
			{
				AddQuestRecordInfo("Wolfreek_Journal", "3");
				DeleteAttribute(pchar, "questTemp.Mtraxx.Logbook.Page4");
				int i = FindIsland("IslaMona");
				Islands[i].visible = true;
				Islands[i].reload_enable = true;
				pchar.quest.mtraxx_wolfreek_islamona.win_condition.l1 = "location";
				pchar.quest.mtraxx_wolfreek_islamona.win_condition.l1.location = "Shore75";
				pchar.quest.mtraxx_wolfreek_islamona.function = "Mtraxx_WolfreekIslaMona";
				pchar.quest.mtraxx_wolfreek_islamona1.win_condition.l1 = "location";
				pchar.quest.mtraxx_wolfreek_islamona1.win_condition.l1.location = "Shore77";
				pchar.quest.mtraxx_wolfreek_islamona1.function = "Mtraxx_WolfreekIslaMona";
				// характеристики топора викинга
				sld = ItemsFromID("topor_06");
				sld.Balance = 2.0;
				sld.Weight = 3.5;
				sld.Attack = 88.0;
			}
			if (CheckAttribute(pchar, "questTemp.Mtraxx.Ignasio.Journal"))
			{
				AddQuestRecord("Roger_8", "11");
				AddQuestRecordInfo("Ignasio_Journal", "1");
				AddQuestUserData("Ignasio_Journal", "sDay", sti(pchar.questTemp.Mtraxx.Corrida.Day));
				AddQuestUserData("Ignasio_Journal", "sMonth", XI_ConvertString("target_month_" + sti(pchar.questTemp.Mtraxx.Corrida.Month)));
				AddQuestUserData("Ignasio_Journal", "sYear", sti(pchar.questTemp.Mtraxx.Corrida.Year));
				DeleteAttribute(pchar, "questTemp.Mtraxx.Ignasio.Journal");
				pchar.questTemp.Mtraxx.Ignasio.Signal = "true";
				pchar.questTemp.Mtraxx.Ignasio.Ship = "true";
				pchar.questTemp.Mtraxx.Ignasio.Dove = "true";
			}
		}
		else PlaySound("interface\knock.wav");
	}
	else 
	{
		PlaySound("interface\knock.wav");
		log_info("Go to your cabin in order to study the ship log");
	}
}

void Mtraxx_WolfreekMoskitos(string qName) // устанавливаем прерывания на пещеры
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	pchar.quest.mtraxx_wolfreek_cave.win_condition.l1 = "location";
	pchar.quest.mtraxx_wolfreek_cave.win_condition.l1.location = "PortoBello_Cave"; // грот
	pchar.quest.mtraxx_wolfreek_cave.function = "Mtraxx_WolfreekGrot";
	pchar.quest.mtraxx_wolfreek_grot.win_condition.l1 = "location";
	pchar.quest.mtraxx_wolfreek_grot.win_condition.l1.location = "Panama_Cave";
	pchar.quest.mtraxx_wolfreek_grot.function = "Mtraxx_WolfreekCave";
	// заполним сундук в пещере Панамы
	pchar.GenQuestBox.Panama_Cave = true;
	pchar.GenQuestBox.Panama_Cave.box1.money = 5000;
	pchar.GenQuestBox.Panama_Cave.box1.items.purse2 = 1;
	pchar.GenQuestBox.Panama_Cave.box1.items.jewelry6 = 22;
	pchar.GenQuestBox.Panama_Cave.box1.items.jewelry10 = 5;
	pchar.GenQuestBox.Panama_Cave.box1.items.jewelry12 = 8;
	pchar.GenQuestBox.Panama_Cave.box1.items.jewelry21 = 6;
	pchar.GenQuestBox.Panama_Cave.box1.items.jewelry18 = 4;
}

void Mtraxx_WolfreekGrot(string qName) // в гроте - злые индеи, 6 штук
{
	chrDisableReloadToLocation = true;
	ref rItm = ItemsFromID("fire");
	rItm.shown = true;
	rItm.startLocation = "PortoBello_Cave";
	rItm.startLocator = "fire";
	CreateFireParticles("goto", "fire"); //костер
	//индеи
	for (int i=1; i<=6; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Mtr_indian_grot_"+i, "canib_"+(i+1), "man", "man", 25, PIRATE, -1, true, "native"));
		FantomMakeCoolFighter(sld, 25, 70, 70, LinkRandPhrase("blade_01","blade_02","topor_02"), "", "", 150);
		sld.name = GetIndianName(MAN);
		sld.lastname = "";
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		if (i == 1)
		{
			sld.Dialog.Filename = "Quest\Roger.c";
			sld.dialog.currentnode = "grot_canib";
			GiveItem2Character(sld, "topor_01");
			EquipCharacterbyItem(sld, "topor_01");
			GiveItem2Character(sld, "pistol3");
			EquipCharacterbyItem(sld, "pistol3");
			TakeNItems(sld, "grapeshot", 10);
			LAi_SetCharacterUseBullet(sld, "grapeshot");
			if (MOD_SKILL_ENEMY_RATE > 2)
			{
				sld.MultiFighter = 1.5;
				sld.MultiShooter = 2.0;
				sld.viper = true;
			}
		}
		if (i < 5) ChangeCharacterAddressGroup(sld, "PortoBello_Cave", "goto", "ass"+i);
		else ChangeCharacterAddressGroup(sld, "PortoBello_Cave", "monsters", "monster"+(i-3));
		LAi_SetActorType(sld);
		if (i == 1) LAi_ActorDialogDelay(sld, pchar, "", 3.0);
		else LAi_ActorAnimation(sld, "Bead", "", -1);
	}
}

void Mtraxx_WolfreekGrotFight(string qName) // битва с карибами
{
	LAi_group_Delete("EnemyFight");
	for (int i=1; i<=6; i++)
	{
		sld = CharacterFromID("Mtr_indian_grot_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Mtraxx_WolfreekGrotAfterFight");
	LAi_SetFightMode(pchar, true);
}

void Mtraxx_WolfreekGrotOpenBox() // открыли сундук в гроте
{
	chrDisableReloadToLocation = false;
	DeleteAttribute(pchar, "questTemp.Mtraxx.Grotbox");
	pchar.questTemp.Mtraxx.Grotcheck = "true";
	AddQuestRecord("Roger_7", "4");
	if (CheckAttribute(pchar, "questTemp.Mtraxx.Cavecheck")) Mtraxx_WolfreekReadLogbookSecond();
	AddCharacterExpToSkill(pchar, "Fortune", 20);
}

void Mtraxx_WolfreekCave(string qName) // 
{
	chrDisableReloadToLocation = true;
	pchar.questTemp.Mtraxx.Cavebox = "true";
}

void Mtraxx_WolfreekCaveOpenBox() // открыли сундук в шахте
{
	chrDisableReloadToLocation = false;
	DeleteAttribute(pchar, "questTemp.Mtraxx.Cavebox");
	pchar.questTemp.Mtraxx.Cavecheck = "true";
	AddQuestRecord("Roger_7", "5");
	if (CheckAttribute(pchar, "questTemp.Mtraxx.Grotcheck")) Mtraxx_WolfreekReadLogbookSecond();
	pchar.quest.mtraxx_wolfreek_caveexit.win_condition.l1 = "location";
	pchar.quest.mtraxx_wolfreek_caveexit.win_condition.l1.location = "Panama_CaveEntrance";
	pchar.quest.mtraxx_wolfreek_caveexit.function = "Mtraxx_WolfreekCaveEntrance";
	AddCharacterExpToSkill(pchar, "Fortune", 50);
}

void Mtraxx_WolfreekCaveEntrance(string qName) // у выхода из шахты
{
	chrDisableReloadToLocation = true;
	// босяки
	for (int i=5; i<=9; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Mtr_bandit_cave_"+i, "citiz_4"+i, "man", "man", 20, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, 20, 60, 60, LinkRandPhrase("blade_07","blade_08","blade_11"), "pistol1", "bullet", 120);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		if (i == 5)
		{
			sld.Dialog.Filename = "Quest\Roger.c";
			sld.dialog.currentnode = "cave_bandit";
		}
		else LAi_CharacterDisableDialog(sld);
		ChangeCharacterAddressGroup(sld, "Panama_CaveEntrance", "reload", "reload2_back");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void Mtraxx_WolfreekCaveFight(string qName) // драка с босяками
{
	LAi_group_Delete("EnemyFight");
	for (int i=5; i<=9; i++)
	{
		sld = CharacterFromID("Mtr_bandit_cave_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Mtraxx_WolfreekCaveAfterFight");
	LAi_SetFightMode(pchar, true);
}

void Mtraxx_WolfreekReadLogbookSecond() // снова идем читать журнал
{
	AddQuestRecord("Roger_7", "7");
	DeleteAttribute(pchar, "questTemp.Mtraxx.Grotcheck");
	DeleteAttribute(pchar, "questTemp.Mtraxx.Cavecheck");
	pchar.questTemp.Mtraxx.Logbook.CanRead = "true";
	pchar.questTemp.Mtraxx.Logbook.Page2 = "true";
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	ref rItm = ItemsFromID("fire");
	rItm.shown = false;
	LocatorReloadEnterDisable("Tortuga_town", "houseS3", true); // Addon 2016-1 Jason пиратская линейка 1
}

void Mtraxx_WolfreekJewellerHouse() // на Тортуге
{
	DeleteAttribute(pchar, "questTemp.Mtraxx.Jeweller");
	AddQuestRecord("Roger_7", "9");
	pchar.quest.mtraxx_wolfreek_house.win_condition.l1 = "locator";
	pchar.quest.mtraxx_wolfreek_house.win_condition.l1.location = "Tortuga_town";
	pchar.quest.mtraxx_wolfreek_house.win_condition.l1.locator_group = "reload";
	pchar.quest.mtraxx_wolfreek_house.win_condition.l1.locator = "houseS3";
	pchar.quest.mtraxx_wolfreek_house.win_condition.l2 = "Day";
	pchar.quest.mtraxx_wolfreek_house.function = "Mtraxx_WolfreekJewellerKnock";
	LocatorReloadEnterDisable("Tortuga_town", "houseS3", true);
}

void Mtraxx_WolfreekJewellerKnock(string qName) // стучимся в дверь
{
	LocatorReloadEnterDisable("Tortuga_town", "houseS3", true);
	LAi_SetActorType(pchar);
	PlaySound("interface\knock.wav");
	DoQuestFunctionDelay("Mtraxx_WolfreekJewellerKnock1", 4.0);
}

void Mtraxx_WolfreekJewellerKnock1(string qName) // тук-тук
{
	PlaySound("interface\knock.wav");
	DoQuestFunctionDelay("Mtraxx_WolfreekJewellerKnock2", 4.0);
}

void Mtraxx_WolfreekJewellerKnock2(string qName) // бах-бах
{
	PlaySound("interface\Door_Kick.wav");
	DoQuestFunctionDelay("Mtraxx_WolfreekJewellerClosed", 5.0);
}

void Mtraxx_WolfreekJewellerClosed(string qName) // наблюдаем за домом
{
	LAi_SetPlayerType(pchar);
	AddQuestRecord("Roger_7", "10");
	pchar.GenQuest.CannotWait = true;
	chrDisableReloadToLocation = true;
	pchar.quest.mtraxx_wolfreek_wait.win_condition.l1 = "locator";
	pchar.quest.mtraxx_wolfreek_wait.win_condition.l1.location = "Tortuga_town";
	pchar.quest.mtraxx_wolfreek_wait.win_condition.l1.locator_group = "reload";
	pchar.quest.mtraxx_wolfreek_wait.win_condition.l1.locator = "basement1";
	pchar.quest.mtraxx_wolfreek_wait.function = "Mtraxx_WolfreekJewellerWait";
	LocatorReloadEnterDisable("Tortuga_town", "basement1", true); // правки прогона 3
}

void Mtraxx_WolfreekJewellerWait(string qName) // ждем
{
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "reload", "houseS3");
	DoQuestCheckDelay("Mtraxx_WolfreekJewellerWait", 10.0);
}

void Mtraxx_WolfreekSetPelly(string qName) // явился Тесак
{
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "reload", "houseS3");
	sld = CharacterFromID("Pelly");
	ChangeCharacterAddressGroup(sld, "Tortuga_town", "reload", "reload10_back");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "houseS3", "none", "", "", "Mtraxx_WolfreekPelly", -1);
}

void Mtraxx_WolfreekPelly(string qName) // идем к Тесаку за разговором
{
	InterfaceStates.Buttons.Save.enable = true;
	DeleteAttribute(pchar, "GenQuest.FrameLockEsc");
	sld = CharacterFromID("Pelly");
	sld.dialog.currentnode = "Pelly_23";
	ChangeCharacterAddressGroup(sld, "Tortuga_town", "reload", "houseS3");
	LAi_SetActorType(pchar);
	LAi_ActorFollow(pchar, sld, "ActorDialog_Any2Pchar", -1);
	LAi_ActorTurnToCharacter(sld, pchar);
	SetActorDialogAny2Pchar(sld.id, "", 0.0, 0.0);
}

void Mtraxx_WolfreekReadLogbookThird() // снова читать журнал - третий раз
{
	DeleteAttribute(pchar, "GenQuest.CannotWait");
	LAi_SetPlayerType(pchar);
	chrDisableReloadToLocation = false;
	sld = CharacterFromID("Pelly");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload4_back", "none", "", "", "", 20);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	AddQuestRecord("Roger_7", "12");
	pchar.questTemp.Mtraxx.Logbook.CanRead = "true";
	pchar.questTemp.Mtraxx.Logbook.Page3 = "true";
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	AddCharacterExpToSkill(pchar, "Sneak", 100);
	LocatorReloadEnterDisable("Tortuga_town", "basement1", false); // правки прогона 3
	LAi_LocationFightDisable(&Locations[FindLocation("Tortuga_town")], false); // патч 17/1
}

void Mtraxx_WolfreekReadLogbookFourth() // читаем в четвертый раз
{
	AddQuestRecord("Roger_7", "15");
	DeleteAttribute(pchar, "questTemp.Mtraxx.Gord");
	pchar.questTemp.Mtraxx.Logbook.CanRead = "true";
	pchar.questTemp.Mtraxx.Logbook.Page4 = "true";
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
}

void Mtraxx_WolfreekTimer(string qName) // 
{
	QuestSetCurrentNode("Terrax", "mtraxx_63");
}

void Mtraxx_WolfreekIslaMona(string qName) // нашли Исла Мону
{
	pchar.quest.mtraxx_wolfreek_islamona.over = "yes";
	pchar.quest.mtraxx_wolfreek_islamona1.over = "yes";
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	AddQuestRecord("Roger_7", "16");
	pchar.quest.mtraxx_wolfreek_jungle.win_condition.l1 = "location";
	pchar.quest.mtraxx_wolfreek_jungle.win_condition.l1.location = "IslaMona_jungle_01";
	pchar.quest.mtraxx_wolfreek_jungle.function = "Mtraxx_WolfreekIslaMonaPirates";
	AddCharacterExpToSkill(pchar, "Sailing", 200);
	AddCharacterExpToSkill(pchar, "Leadership", 200);
	AddCharacterExpToSkill(pchar, "Fortune", 200);
}

void Mtraxx_WolfreekIslaMonaPirates(string qName) // пиратусы в кустах
{
	chrDisableReloadToLocation = true;
	for (int i=1; i<=9; i++) // 
	{
		if (i > 6)
		{
			sld = GetCharacter(NPC_GenerateCharacter("Islamona_pirate_"+i, "mush_ctz_"+i, "man", "mushketer", 20, PIRATE, -1, false, "quest"));
			if (i == 2) 
			{
				FantomMakeCoolFighter(sld, 20, 60, 60, "", "mushket3", "grapeshot", 120);
				LAi_SetCharacterUseBullet(sld, "grapeshot");
			}
			else 
			{
				FantomMakeCoolFighter(sld, 20, 60, 60, "", "mushket2", "cartridge", 120);
				LAi_SetCharacterUseBullet(sld, "cartridge");
			}
			SetCharacterPerk(sld, "Gunman");
			SetCharacterPerk(sld, "GunProfessional");
			if (MOD_SKILL_ENEMY_RATE > 2) sld.cirassId = Items_FindItemIdx("cirass1");
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Islamona_pirate_"+i, "citiz_4"+i, "man", "man", 18, PIRATE, -1, true, "quest"));
			FantomMakeCoolFighter(sld, 18, 50, 50, LinkRandPhrase("blade_07","blade_08","blade_11"), "pistol1", "bullet", 100);
			if (MOD_SKILL_ENEMY_RATE > 4) sld.cirassId = Items_FindItemIdx("cirass2");
		}
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
	}
	DoQuestFunctionDelay("Mtraxx_WolfreekIslaMonaShot", 3.0);
}

void Mtraxx_WolfreekIslaMonaShot(string qName) // мушкетеры стреляют
{
	LAi_group_Delete("EnemyFight");
	for (int i=7; i<=9; i++) // 
	{
		sld = CharacterFromID("Islamona_pirate_"+i);
		ChangeCharacterAddressGroup(sld, "IslaMona_jungle_01", "goto", "ass"+(i-6));
		sld.MusketerDistance = 0;
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Mtraxx_WolfreekIslaMonaAfterFight");
	DoQuestFunctionDelay("Mtraxx_WolfreekIslaMonaAttack", 3.0);
}

void Mtraxx_WolfreekIslaMonaAttack(string qName) // пиратусы выскочили
{
	PlaySound("interface\abordage_wining.wav");
	for (int i=1; i<=6; i++) // 
	{
		sld = CharacterFromID("Islamona_pirate_"+i);
		if (i < 4) ChangeCharacterAddressGroup(sld, "IslaMona_jungle_01", "goto", "goto5");
		else ChangeCharacterAddressGroup(sld, "IslaMona_jungle_01", "goto", "goto7");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
}

void Mtraxx_WolfreekCpy(string qName) // собираем штурмовую роту
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	Log_Info("Boarding party is ready!");
	PlaySound("interface\notebook.wav");
	pchar.quest.mtraxx_wolfreek_march.win_condition.l1 = "location";
	pchar.quest.mtraxx_wolfreek_march.win_condition.l1.location = "Shore75";
	pchar.quest.mtraxx_wolfreek_march.function = "Mtraxx_WolfreekMarch";
	pchar.quest.mtraxx_wolfreek_march1.win_condition.l1 = "location";
	pchar.quest.mtraxx_wolfreek_march1.win_condition.l1.location = "Shore77";
	pchar.quest.mtraxx_wolfreek_march1.function = "Mtraxx_WolfreekMarch";
	pchar.questTemp.Mtraxx.WolfreekCpy = "true";
}

void Mtraxx_WolfreekMarch(string qName) // собираем штурмовую роту
{
	pchar.quest.mtraxx_wolfreek_march.over = "yes";
	pchar.quest.mtraxx_wolfreek_march1.over = "yes";
	for (int i=1; i<=7; i++) 
	{
		if (i == 5)
		{
			sld = GetCharacter(NPC_GenerateCharacter("Islamona_cpy_"+i, "mush_ctz_"+i, "man", "mushketer", 25, PIRATE, -1, false, "quest"));
			FantomMakeCoolFighter(sld, 25, 65, 65, "", "mushket3", "grapeshot", 150);
			LAi_SetCharacterUseBullet(sld, "grapeshot");
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Islamona_cpy_"+i, "citiz_4"+i, "man", "man", 20, PIRATE, -1, true, "quest"));
			FantomMakeCoolFighter(sld, 20, 55, 55, LinkRandPhrase("blade_07","blade_08","blade_11"), "pistol1", "bullet", 120);
		}
		LAi_CharacterDisableDialog(sld);
		ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto1");
		LAi_SetActorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		LAi_ActorFollowEverywhere(sld, "", -1);
	}
	pchar.quest.mtraxx_wolfreek_cpy1.win_condition.l1 = "location";
	pchar.quest.mtraxx_wolfreek_cpy1.win_condition.l1.location = "IslaMona_fort";
	pchar.quest.mtraxx_wolfreek_cpy1.function = "Mtraxx_WolfreekCpyInFort";
}

void Mtraxx_WolfreekCpyInFort(string qName) // 
{
	chrDisableReloadToLocation = true;
	for (int i=1; i<=7; i++) 
	{
		sld = CharacterFromID("Islamona_cpy_"+i);
		LAi_SetActorType(sld);
		ChangeCharacterAddressGroup(sld, "IslaMona_fort", "reload", "reload1_back");
		LAi_ActorFollowEverywhere(sld, "", -1);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
}
}

void Mtraxx_WolfreekCannon(string qName) // в локации форта перед пушкой
{
	if (CheckAttribute(pchar, "questTemp.Mtraxx.WolfreekCpy"))
	{
		DeleteAttribute(pchar, "questTemp.Mtraxx.WolfreekCpy");
		sld = CharacterFromID("Islamona_carpenter");
		LAi_ActorDialogNow(sld, pchar, "", -1);
	}
	else
	{
		CreateLocationParticles("Bombard", "quest", "mortair", 1.0, 90, 90, "cannon_fire_2");
		CreateLocationParticles("blast_dirt", "quest", "mortair", 1.0, 90, 90, "");
		CreateLocationParticles("blast_dirt", "quest", "mortair", 1.0, 90, 90, "");
		DoQuestFunctionDelay("Mtraxx_WolfreekGameover", 0.5);
	}
}

void Mtraxx_WolfreekGameover(string qName) // сунулся без роты
{
	for (int i=1; i<=3; i++)
	{
		int idx = GetOfficersIndex(pchar, i);
		if (idx < 1) continue;
		sld = &Characters[idx];
		LAi_KillCharacter(sld);
	}
	LAi_KillCharacter(pchar);
}

void Mtraxx_WolfreekInFort(string qName) // переговоры с Родгаром окончены
{
	sld = CharacterFromID("Islamona_carpenter");
	sld.dialog.currentnode = "carpenter_17";
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	for (int i=1; i<=2; i++) // 
	{
		sld = CharacterFromID("Islamona_fort_pirate_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	int n = Findlocation("IslaMona_fort");
	DeleteAttribute(&locations[n], "models.always.mortair");
	DoQuestReloadToLocation("IslaMona_fort", "quest", "detector", "Mtraxx_WolfreekInFort");
	AddCharacterExpToSkill(pchar, "Leadership", 100);
	for (i=1; i<=7; i++) 
	{
		sld = CharacterFromID("Islamona_cpy_"+i);
		LAi_SetWarriorType(sld);
		LAi_CharacterDisableDialog(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
}

void Mtraxx_WolfreekFindTreasure() // нашли клад Вульфрика
{
	DeleteAttribute(pchar, "questTemp.Mtraxx.WolfreekBox");
	pchar.questTemp.Mtraxx.WolfreekGord = "true";
	AddQuestRecord("Roger_7", "19");
	AddCharacterExpToSkill(pchar, "Fortune", 400);
}

void Mtraxx_WolfreekComplete() // завершаем квест
{
	sld = CharacterFromID("Islamona_carpenter");
	sld.dialog.currentnode = "carpenter_17";
	DeleteAttribute(pchar, "questTemp.Mtraxx.WolfreekGord");
	AddQuestRecord("Roger_7", "20");
	if (GetSquadronGoods(pchar, GOOD_FOOD) >= 100) RemoveCharacterGoods(pchar, GOOD_FOOD, 50);
	if (GetSquadronGoods(pchar, GOOD_RUM) >= 20) RemoveCharacterGoods(pchar, GOOD_RUM, 20);
	if (GetSquadronGoods(pchar, GOOD_MEDICAMENT) >= 45) RemoveCharacterGoods(pchar, GOOD_MEDICAMENT, 15);
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	QuestSetCurrentNode("Terrax", "mtraxx_66");
	// убираем роту
	for (int i=1; i<=7; i++) 
	{
		sld = CharacterFromID("Islamona_cpy_"+i);
		sld.lifeday = 0;
		LAi_SetActorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		LAi_ActorRunToLocation(sld, "reload", "reload1_back", "none", "", "", "", 10.0);
	}
}

// Эпизод 8. Коррида.
void Mtraxx_CorridaStart(string qName) // пришли на Мартинику
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	Island_SetReloadEnableGlobal("Martinique", false);
	int iRank = 20+MOD_SKILL_ENEMY_RATE;
	int iScl = 55;
	// ставим полакр Марко и корабли пиратов Барбазона - Бродяги и Упыря
	// Марко
	Group_FindOrCreateGroup("IgnasioSeaGroup");
	sld = CharacterFromID("Ignasio");
	DeleteAttribute(sld, "ship.sails");
    DeleteAttribute(sld, "ship.blots");
    DeleteAttribute(sld, "ship.masts");
	DeleteAttribute(sld, "ship.hulls");
	sld.ship.HP = 3750; // не чинится иным путем, хз знает, где собака порылась
	SetCrewQuantityFull(sld);
	sld.Abordage.Enable = false;
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true; 
	LAi_SetImmortal(sld, true); // сплошная защита от дурака
	sld.DontDeskTalk = true;
	sld.nation = PIRATE;
	Group_AddCharacter("IgnasioSeaGroup", "Ignasio");
	// Бродяга
	sld = GetCharacter(NPC_GenerateCharacter("Mtr_Vagrant", "mercen_26", "man", "man", iRank, PIRATE, -1, true, "quest")); 
	FantomMakeSmallSailor(sld, SHIP_CORVETTE, "Cuttlefish", CANNON_TYPE_CULVERINE_LBS18, iScl, iScl, iScl, iScl, iScl);
	FantomMakeCoolFighter(sld, iRank, iScl, iScl, "blade_13", "pistol5", "bullet", iScl*2);
	sld.name = "Vagrant";
	sld.lastname = "";
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.AlwaysSandbankManeuver = true;
	sld.Ship.Mode = "pirate";
	sld.Abordage.Enable = false;
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true; 
	LAi_SetImmortal(sld, true); // сплошная защита от дурака
	sld.DontDeskTalk = true;
	Group_AddCharacter("IgnasioSeaGroup", "Mtr_Vagrant");
	// Упырь
	sld = GetCharacter(NPC_GenerateCharacter("Mtr_vampire", "mercen_25", "man", "man", iRank+5, PIRATE, -1, true, "quest")); 
	FantomMakeCoolSailor(sld, SHIP_FRIGATE, "Merciless", CANNON_TYPE_CANNON_LBS24, iScl+5, iScl+5, iScl+5);
	FantomMakeCoolFighter(sld, iRank+5, iScl+15, iScl+15, "blade_14", "pistol5", "bullet", iScl*2+100);
	sld.name = "Vampire";
	sld.lastname = "";
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "pirate";
	sld.Abordage.Enable = false;
	sld.AlwaysFriend = true;
	sld.AlwaysSandbankManeuver = true;
	sld.ShipEnemyDisable = true; 
	LAi_SetImmortal(sld, true); // сплошная защита от дурака
	sld.DontDeskTalk = true;
	Group_AddCharacter("IgnasioSeaGroup", "Mtr_vampire");
	Group_SetGroupCommander("IgnasioSeaGroup", "Ignasio");
	Group_SetAddress("IgnasioSeaGroup", "Martinique", "quest_ships", "quest_ship_5");
	Group_SetTaskNone("IgnasioSeaGroup");
	Group_LockTask("IgnasioSeaGroup");
	// информируем
	bQuestDisableMapEnter = true;//закрыть карту
	bDisableCharacterMenu = true;//лочим F2
	InterfaceStates.Buttons.Save.enable = false;//запретить сохраняться
	Log_Info("The Torero is on a raid of Le Francois!");
	PlaySound("interface\notebook.wav");
	DoQuestFunctionDelay("Mtraxx_CorridaSenPierre", 7.0);
}

void Mtraxx_CorridaSenPierre(string qName) // релоад из моря в Сен-Пьер
{
	DoQuestReloadToLocation("FortFrance_town", "reload", "reload1", "Mtraxx_CorridaSenPierre");
}

void Mtraxx_CorridaSeeMarko(string qName) // входит Игнасио в Ле Франсуа
{
	Log_Info("Ignacio Marco is entering the village!");
	PlaySound("interface\notebook.wav");
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "reload", "reload1");
	DoQuestFunctionDelay("Mtraxx_CorridaSeeMarko1", 3.0);
}

void Mtraxx_CorridaSeeMarko1(string qName) // смотрим на него
{
	sld = CharacterFromID("Ignasio");
	ChangeCharacterAddressGroup(sld, "LeFransua_town", "reload", "reload1");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload6", "none", "", "", "Mtraxx_CorridaWaitMarko", -1);
	DoQuestCheckDelay("Mtraxx_CorridaSeeMarko", 8.0);
}

void Mtraxx_CorridaContinue(string qName) // назад, в Ла Вегу
{
	Island_SetReloadEnableGlobal("Martinique", true);
	DeleteAttribute(pchar, "GenQuest.CannotWait");
	AddQuestRecord("Roger_8", "4");
	QuestSetCurrentNode("Terrax", "mtraxx_73");
	pchar.quest.mtraxx_pasq_check.win_condition.l1 = "location";
	pchar.quest.mtraxx_pasq_check.win_condition.l1.location = "LaVega_town"; // правки прогона 3
	pchar.quest.mtraxx_pasq_check.function = "Mtraxx_PasqualeGrabbingCheck";
}

void Mtraxx_CorridaLandTimer(string qName) // 1 час
{
	pchar.questTemp.Mtraxx.Corrida.Timer = "true";
}

void Mtraxx_CorridaCheckTime(string qName) // проверяем 1 час
{
	if (CheckAttribute(pchar, "questTemp.Mtraxx.Corrida.Timer")) // задержался на суше
	{
		pchar.quest.mtraxx_corrida_torero.over = "yes";
		return;
	}
	pchar.quest.mtraxx_corrida_landtimer.over = "yes";
	Island_SetReloadEnableGlobal("Hispaniola1", false);
}

void Mtraxx_CorridaToreroOnMap(string qName) // запускаем энкаунтер Марко на карте // прогона 3
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	string sGroup = "Sea_Torero1";
	Group_FindOrCreateGroup(sGroup);
	Group_SetType(sGroup, "pirate");
	sld = characterFromId("Ignasio");
	DeleteAttribute(sld, "AlwaysFriend");
	DeleteAttribute(sld, "ShipEnemyDisable");
	LAi_SetImmortal(sld, false);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Alwaysenemy = true; 
	sld.Coastal_Captain = true;
	sld.Ship.Mode = "pirate";
	Character_SetAbordageEnable(sld, true);//можно абордировать
	DeleteAttribute(sld, "ShipHideImmortal"); // можно топить
	SetCharacterGoods(sld, GOOD_BALLS, 800);
	SetCharacterGoods(sld, GOOD_GRAPES, 800);
	SetCharacterGoods(sld, GOOD_KNIPPELS, 600);
	SetCharacterGoods(sld, GOOD_BOMBS, 800);
	SetCharacterGoods(sld, GOOD_POWDER, 2000);
	SetCharacterGoods(sld, GOOD_WEAPON, 300);
	SetCharacterGoods(sld, GOOD_FOOD, 400);
	SetCharacterGoods(sld, GOOD_MEDICAMENT, 300);
	SetCharacterGoods(sld, GOOD_RUM, 50);
	SetCharacterGoods(sld, GOOD_PLANKS, 30);
	SetCharacterGoods(sld, GOOD_SAILCLOTH, 10);
	sld.Nation = SPAIN;
	sld.mapEnc.type = "war";
	sld.mapEnc.worldMapShip = "quest_ship";
	sld.mapEnc.Name = "'Torero'";
	Group_AddCharacter(sGroup, "Ignasio");
	Group_SetGroupCommander(sGroup, "Ignasio");
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
	Map_CreateTrader("Shore57", "Shore41", "Ignasio", 4);
	
	Mtraxx_CorridaToreroSquadron(); // ставим эскадру у Синт-Маартена
	ChangeItemDescribe("wolfreeks_book", "itmdescr_ignasio_book"); // журнал Игнасио
	pchar.questTemp.Mtraxx.Corrida.Logbook = "true";
	// устанавливаем дату генерации испанского конвоя
	int iDay = 7;
	int iHour = 18;
	if (MOD_SKILL_ENEMY_RATE < 5) 
	{
		iDay = 9;
		iHour = 12;
	}
	if (MOD_SKILL_ENEMY_RATE == 6) 
	{
		iDay = 8;
		iHour = 15;
	}
	// запись в СЖ
	pchar.questTemp.Mtraxx.Corrida.Day = GetAddingDataDay(0, 0, iDay);
	pchar.questTemp.Mtraxx.Corrida.Month = GetAddingDataMonth(0, 0, iDay);
	pchar.questTemp.Mtraxx.Corrida.Year = GetAddingDataYear(0, 0, iDay);
	pchar.quest.mtraxx_corrida_hispanios.win_condition.l1 = "Timer";
	pchar.quest.mtraxx_corrida_hispanios.win_condition.l1.date.hour  = iHour;
	pchar.quest.mtraxx_corrida_hispanios.win_condition.l1.date.day   = GetAddingDataDay(0, 0, iDay);
	pchar.quest.mtraxx_corrida_hispanios.win_condition.l1.date.month = GetAddingDataMonth(0, 0, iDay);
	pchar.quest.mtraxx_corrida_hispanios.win_condition.l1.date.year  = GetAddingDataYear(0, 0, iDay);
	pchar.quest.mtraxx_corrida_hispanios.function = "Mtraxx_CorridaTimeHispanios";
	pchar.quest.mtraxx_corrida_hispanios1.win_condition.l1 = "Timer";
	pchar.quest.mtraxx_corrida_hispanios1.win_condition.l1.date.hour  = 1.00;
	pchar.quest.mtraxx_corrida_hispanios1.win_condition.l1.date.day   = GetAddingDataDay(0, 0, iDay+1);
	pchar.quest.mtraxx_corrida_hispanios1.win_condition.l1.date.month = GetAddingDataMonth(0, 0, iDay+1);
	pchar.quest.mtraxx_corrida_hispanios1.win_condition.l1.date.year  = GetAddingDataYear(0, 0, iDay+1);
	pchar.quest.mtraxx_corrida_hispanios1.function = "Mtraxx_CorridaLateHispanios";
	
	pchar.quest.mtraxx_corrida_capture.win_condition.l1 = "Character_Capture";
	pchar.quest.mtraxx_corrida_capture.win_condition.l1.character = "Ignasio";
	pchar.quest.mtraxx_corrida_capture.function = "Mtraxx_CorridaIgnasioCapture";//взяли на абордаж
	pchar.quest.mtraxx_corrida_sink.win_condition.l1 = "Character_sink";
	pchar.quest.mtraxx_corrida_sink.win_condition.l1.character = "Ignasio";
	pchar.quest.mtraxx_corrida_sink.function = "Mtraxx_CorridaIgnasioSink";//потопили
}

void Mtraxx_CorridaToreroSquadron() // ставим эскадру пиратов у Синт-Маартена
{
	Island_SetReloadEnableGlobal("Hispaniola2", false); // патч 17/1
	Island_SetReloadEnableGlobal("SentMartin", false);
	Island_SetReloadEnableGlobal("Bermudes", false);
	Island_SetReloadEnableGlobal("Nevis", false);
	Island_SetReloadEnableGlobal("PuertoRico", false);
	Island_SetReloadEnableGlobal("Tortuga", false);
	Island_SetReloadEnableGlobal("Antigua", false);
	pchar.questTemp.Mtraxx.Corrida.IslandLock = "true";
	Group_FindOrCreateGroup("JokerSeaGroup");
	sld = GetCharacter(NPC_GenerateCharacter("Mtr_joker", "mercen_20", "man", "man", 35, HOLLAND, -1, true, "quest")); 
	FantomMakeCoolSailor(sld, SHIP_FRIGATE, "Eagle-Owl", CANNON_TYPE_CANNON_LBS24, 100, 100, 100);
	FantomMakeCoolFighter(sld, 100, 100, 100, "blade_13", "pistol5", "bullet", 200);
	sld.name = "Joker";
	sld.lastname = "Jim";
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "pirate";
	sld.Abordage.Enable = false;
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true; 
	LAi_SetImmortal(sld, true); // сплошная защита от дурака
	sld.DontDeskTalk = true;
	Group_AddCharacter("JokerSeaGroup", "Mtr_joker");
	sld = CharacterFromID("Mtr_Vagrant");
	sld.nation = HOLLAND;
	Group_AddCharacter("JokerSeaGroup", "Mtr_Vagrant");
	sld = CharacterFromID("Mtr_vampire");
	sld.nation = HOLLAND;
	Group_AddCharacter("JokerSeaGroup", "Mtr_vampire");
	Group_SetGroupCommander("JokerSeaGroup", "Mtr_joker");
	Group_SetAddress("JokerSeaGroup", "SentMartin", "quest_ships", "quest_ship_1");
	Group_SetTaskNone("JokerSeaGroup");
	Group_LockTask("JokerSeaGroup");
	// атрибут слежения
	pchar.questTemp.Mtraxx.Ignasio.Check = "true";
}

void Mtraxx_CorridaTimeFindTorero(string qName) // упустил Тореро на карте
{
	Mtraxx_CorridaIgnasioFail();
	AddQuestRecord("Roger_8", "24");
}

void Mtraxx_CorridaIgnasioFail() // провал перехвата Тореро, общие команды
{
	sld = CharacterFromID("Mtr_joker");
	sld.lifeday = 0;
	sld = CharacterFromID("Mtr_Vagrant");
	sld.lifeday = 0;
	sld = CharacterFromID("Mtr_vampire");
	sld.lifeday = 0;
	Island_SetReloadEnableGlobal("Hispaniola1", true);
	Island_SetReloadEnableGlobal("Hispaniola2", true); // патч 17/1
	Island_SetReloadEnableGlobal("SentMartin", true);
	Island_SetReloadEnableGlobal("Bermudes", true);
	Island_SetReloadEnableGlobal("Nevis", true);
	Island_SetReloadEnableGlobal("PuertoRico", true);
	Island_SetReloadEnableGlobal("Tortuga", true);
	Island_SetReloadEnableGlobal("Antigua", true);
	DeleteAttribute(pchar, "questTemp.Mtraxx.Corrida.IslandLock");
	DeleteAttribute(pchar, "questTemp.Mtraxx.Ignasio.Check");
	// belamour зачищаем Корриду -->
	DeleteAttribute(pchar, "questTemp.Mtraxx.Ignasio.Ship");   
	DeleteAttribute(pchar, "questTemp.Mtraxx.Ignasio.Signal"); 
	DeleteAttribute(pchar, "questTemp.Mtraxx.Ignasio.Flag");  
    // <-- belamour
	pchar.quest.mtraxx_corrida_hispanios.over = "yes";
	pchar.quest.mtraxx_corrida_hispanios1.over = "yes";

	pchar.quest.mtraxx_corrida_sink.over = "yes"; // mitrokosta снимаем уже не нужные прерывания
	pchar.quest.mtraxx_corrida_capture.over = "yes";

	QuestSetCurrentNode("Terrax", "mtraxx_87");
}

void Mtraxx_CorridaIgnasioCapture(string qName) // захватил, проверяем
{
	pchar.quest.Mtraxx_CorridaTimeFindTorero.over = "yes";
	pchar.quest.mtraxx_corrida_sink.over = "yes"; // mitrokosta если захватили, утопить не можем
	DeleteAttribute(pchar, "questTemp.Mtraxx.Corrida.Logbook");
	// наличие журнала
	if (!CheckCharacterItem(pchar, "wolfreeks_book"))
	{
		AddQuestRecord("Roger_8", "8");
		Mtraxx_CorridaIgnasioFail();
		return;
	}
	// нахождение в акватории ближе 5000 м
	if (CheckAttribute(pchar, "questTemp.Mtraxx.Ignasio.Fail"))
	{
		DeleteAttribute(pchar, "questTemp.Mtraxx.Ignasio.Fail");
		if (CheckCharacterItem(pchar, "wolfreeks_book")) RemoveItems(pchar, "wolfreeks_book", 1);
		AddQuestRecord("Roger_8", "9");
		Mtraxx_CorridaIgnasioFail();
		return;
	}
	AddQuestRecord("Roger_8", "10");
	DeleteAttribute(pchar, "questTemp.Mtraxx.Ignasio.Check");
	pchar.questTemp.Mtraxx.Logbook.CanRead = "true";
	pchar.questTemp.Mtraxx.Ignasio.Journal = "true";
	AddComplexSeaExpToScill(50, 50, 50, 300, 50, 50, 0);
	AddCharacterExpToSkill(pchar, "Fortune", 100);
}

void Mtraxx_CorridaIgnasioSink(string qName) // утопил - провал
{
	pchar.quest.Mtraxx_CorridaTimeFindTorero.over = "yes";
	DeleteAttribute(pchar, "questTemp.Mtraxx.Corrida.Logbook");
	AddQuestRecord("Roger_8", "7");
	Mtraxx_CorridaIgnasioFail();
}

void Mtraxx_CorridaCheckPolacre() // проверяем правильность корабля
{
	DeleteAttribute(pchar, "questTemp.Mtraxx.Ignasio.Ship");
	if (sti(RealShips[sti(pchar.ship.type)].basetype) != SHIP_POLACRE_QUEST || GetCompanionQuantity(pchar) > 1)
	{
		RemoveItems(pchar, "wolfreeks_book", 1);
		AddQuestRecord("Roger_8", "16");
		Mtraxx_CorridaIgnasioFail();
	}
	else log_Testinfo("Проверка на полакр пройдена");
}

void Mtraxx_CorridaIgnasioDove(string qName) // выпускаем голубя - картинка
{
	RemoveItems(pchar, "Dove", 1);
	ResetSound();
	PlayStereoSound("Weather\All_for_Sea_Storm_02.wav");
	SetLaunchFrameFormParam("", "", 0, 8);
	SetLaunchFrameFormPic("loading\Dove.tga");
	LaunchFrameForm();
	bQuestDisableMapEnter = false;
	InterfaceStates.Buttons.Save.enable = true; 
	bDisableCharacterMenu = false;
}

void Mtraxx_CorridaIgnasioFailFlag() // поднял не тот флаг
{
	RemoveItems(pchar, "wolfreeks_book", 1);
	AddQuestRecord("Roger_8", "12");
	Mtraxx_CorridaIgnasioFail();
}

void Mtraxx_CorridaIgnasioRightFlag() // 
{
	AddQuestRecord("Roger_8", "14");
	sld = CharacterFromID("Mtr_joker");
	sld.lifeday = 0;
	Ship_SetTaskRunAway(SECONDARY_TASK, sti(sld.index), sti(pchar.index));
	sld = CharacterFromID("Mtr_Vagrant");
	sld.lifeday = 0;
	Ship_SetTaskRunAway(SECONDARY_TASK, sti(sld.index), sti(pchar.index));
	sld = CharacterFromID("Mtr_vampire");
	sld.lifeday = 0;
	Ship_SetTaskRunAway(SECONDARY_TASK, sti(sld.index), sti(pchar.index));
	pchar.questTemp.Mtraxx.Corrida.Hispanios = "true"; // разрешение генерации испанского конвоя
	pchar.questTemp.Mtraxx.Corrida.Barbazon = "true"; // для диалога
}

void Mtraxx_CorridaTimeHispanios(string qName) // дата прихода конвоя
{
	log_Testinfo("Время генерации конвоя!");
	if (!CheckAttribute(pchar, "questTemp.Mtraxx.Corrida.Hispanios")) return;
	if (CheckAttribute(pchar, "questTemp.Mtraxx.Corrida.Late")) return;
	if (bSeaActive) DoQuestFunctionDelay("Mtraxx_CorridaCheckCoordinates", 0.5);
	else
	{
		pchar.quest.mtraxx_corrida_hispconvoy.win_condition.l1 = "EnterToSea";
		pchar.quest.mtraxx_corrida_hispconvoy.function = "Mtraxx_CorridaCheckCoordinates";
	}
}

void Mtraxx_CorridaCheckCoordinates(string qName) // проверяем место
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	log_Testinfo("Проверяю координаты...");
	if (!CheckAttribute(pchar, "questTemp.Mtraxx.Corrida.Hispanios")) return; // доп. проверка
	if (CheckAttribute(pchar, "questTemp.Mtraxx.Corrida.Late")) return;
	int degN, degW, minN1, minN2, minW1, minW2;
	degN = 23; // градус широты
	degW = 64; // градус долготы
	minN1 = 0; // нижний предел интервала широты
	minN2 = 30; // верхний предел интервала широты
	minW1 = 25; // нижний предел интервала долготы
	minW2 = 55; // верхний предел интервала долготы
	if (CheckAttribute(pchar, "Ship.pos.x") && !bDisableMapEnter)
	{
		if(GetSeaCoordDegreeZ(makefloat(pchar.Ship.pos.z)) == degN && GetMapCoordMinutesZ(makefloat(worldMap.playerShipZ)) >= minN1 && GetMapCoordMinutesZ(makefloat(worldMap.playerShipZ)) < minN2 && GetSeaCoordDegreeX(makefloat(pchar.Ship.pos.x)) == degW && GetMapCoordMinutesX(makefloat(worldMap.playerShipX)) >= minW1 && GetMapCoordMinutesX(makefloat(worldMap.playerShipX)) < minW2) 
		{	
			log_Testinfo("Координаты найдены!");
			pchar.questTemp.Mtraxx.Ignasio.Capellan = "true";
			Flag_PIRATE();
			bQuestDisableMapEnter = true;
			pchar.quest.mtraxx_corrida_hispanios1.over = "yes";
			DoQuestFunctionDelay("Mtraxx_CorridaCreateHispanios", 3.0);
		}
		else 
		{
			log_Testinfo("Координаты не соответствуют");
			pchar.quest.mtraxx_corrida_hispconvoy1.win_condition.l1 = "MapEnter";
			pchar.quest.mtraxx_corrida_hispconvoy1.function = "Mtraxx_CorridaTimeHispanios";
		}
	}
	else log_Testinfo("Координаты не проверяются");
}

void Mtraxx_CorridaLateHispanios(string qName) // 
{
	pchar.questTemp.Mtraxx.Corrida.Late = "true";
	SetFunctionTimerCondition("Mtraxx_CorridaLate", 0, 0, 1, false);
	Island_SetReloadEnableGlobal("SentMartin", true);
	if (CheckCharacterItem(pchar, "wolfreeks_book")) RemoveItems(pchar, "wolfreeks_book", 1); // прогона 3
}

void Mtraxx_CorridaLate(string qName) // // правки прогона 3
{
	Island_SetReloadEnableGlobal("Hispaniola1", true);
	Island_SetReloadEnableGlobal("Hispaniola2", true); // патч 17/1
	Island_SetReloadEnableGlobal("Bermudes", true);
	Island_SetReloadEnableGlobal("Nevis", true);
	Island_SetReloadEnableGlobal("PuertoRico", true);
	Island_SetReloadEnableGlobal("Tortuga", true);
	Island_SetReloadEnableGlobal("Antigua", true);
	QuestSetCurrentNode("Terrax", "mtraxx_87");
    Mtraxx_CorridaIgnasioFail(); // belamour шишку новогоднюю, а не мушкетон в подземельях
	AddQuestRecord("Roger_8", "15");
}

void Mtraxx_CorridaCreateHispanios(string qName) // ставим конвой испанцев с золотом
{
	Island_SetReloadEnableGlobal("Hispaniola1", true);
	Island_SetReloadEnableGlobal("Hispaniola2", true); // патч 17/1
	Island_SetReloadEnableGlobal("SentMartin", true);
	Island_SetReloadEnableGlobal("Bermudes", true);
	Island_SetReloadEnableGlobal("Nevis", true);
	Island_SetReloadEnableGlobal("PuertoRico", true);
	Island_SetReloadEnableGlobal("Tortuga", true);
	Island_SetReloadEnableGlobal("Antigua", true);
	DeleteAttribute(pchar, "questTemp.Mtraxx.Corrida.IslandLock");
	DeleteAttribute(pchar, "questTemp.Mtraxx.Corrida.Hispanios");
	log_info("Spanish convoy on the horizon!");
	PlaySound("interface\notebook.wav");
	PlaySound("interface\_EvEnemy0.wav");
	Group_FindOrCreateGroup("Mtr_GoldSeaGroup");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+7;
	if (iRank > 45) iRank = 45;
	int iShip, Ship1, Ship2, Ship3, iCannon, Cannon1, Cannon2, iSpace;
	
	switch (MOD_SKILL_ENEMY_RATE)
	{
		case 2:
			Ship1 = SHIP_GALEON_L;
			Ship3 = SHIP_CARACCA;
			Cannon1 = CANNON_TYPE_CANNON_LBS20;
			Cannon2 = CANNON_TYPE_CANNON_LBS16;
		break;
		
		case 4:
			Ship1 = SHIP_XebekVML;
			Ship3 = SHIP_GALEON_L;
			Cannon1 = CANNON_TYPE_CULVERINE_LBS18;
			Cannon2 = CANNON_TYPE_CANNON_LBS20;
		break;
		
		case 6:
			Ship1 = SHIP_NAVIO;
			Ship3 = SHIP_XebekVML;
			Cannon1 = CANNON_TYPE_CANNON_LBS24;
			Cannon2 = CANNON_TYPE_CULVERINE_LBS18;
		break;
		
		case 8:
			Ship1 = SHIP_GALEON_H;
			Ship3 = SHIP_NAVIO;
			Cannon1 = CANNON_TYPE_CANNON_LBS32;
			Cannon2 = CANNON_TYPE_CANNON_LBS24;
		break;
		
		case 10:
			Ship1 = SHIP_GALEON_H;
			Ship3 = SHIP_GALEON_H;
			Cannon1 = CANNON_TYPE_CANNON_LBS32;
			Cannon2 = CANNON_TYPE_CANNON_LBS24;
		break;
	}
	for (int i=1; i<=3; i++)
	{
		switch (i)
		{
			case 1:
				iShip = Ship1;
				iCannon = Cannon1;
			break;
			
			case 2:
				iShip = SHIP_GALEON_H;
				iCannon = CANNON_TYPE_CANNON_LBS24;
				if (MOD_SKILL_ENEMY_RATE < 4) iCannon = CANNON_TYPE_CULVERINE_LBS18;
			break;
			
			case 3:
				iShip = Ship3;
				iCannon = Cannon2;
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("Mtr_GoldCap_"+i, "off_spa_"+i, "man", "man", iRank, SPAIN, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, 80, 80, 80);
		FantomMakeCoolFighter(sld, iRank, 100, 100, LinkRandPhrase("blade_17","blade_20","blade_21"), "pistol5", "bullet", 250);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysEnemy = true;
		sld.Ship.Mode = "war";
		sld.ship.Crew.Morale = 60+MOD_SKILL_ENEMY_RATE*4;
		sld.Ship.Crew.Exp.Sailors = 60+MOD_SKILL_ENEMY_RATE*4;
		sld.Ship.Crew.Exp.Cannoners = 60+MOD_SKILL_ENEMY_RATE*4;
		sld.Ship.Crew.Exp.Soldiers = 60+MOD_SKILL_ENEMY_RATE*4;
		if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
		if (i == 1) 
		{
			iSpace = GetCharacterFreeSpace(sld, GOOD_PAPRIKA);
			iSpace = makeint(iSpace/2 + rand(iSpace/2));
			Fantom_SetCharacterGoods(sld, GOOD_PAPRIKA, iSpace, 1);
		}
		if (i == 2) 
		{
			sld.ship.name = "Toro de Oro";
			UpgradeShipParameter(sld, "Capacity");
			SetRandGeraldSail(sld, SPAIN);
			NullCharacterGoods(sld);
			AddCharacterGoods(sld, GOOD_BALLS, 1500);
			AddCharacterGoods(sld, GOOD_GRAPES, 1000);
			AddCharacterGoods(sld, GOOD_KNIPPELS, 800);
			AddCharacterGoods(sld, GOOD_BOMBS, 1700);
			AddCharacterGoods(sld, GOOD_POWDER, 5000);
			AddCharacterGoods(sld, GOOD_WEAPON, 700);
			AddCharacterGoods(sld, GOOD_FOOD, 1000);
			AddCharacterGoods(sld, GOOD_MEDICAMENT, 250);
			AddCharacterGoods(sld, GOOD_RUM, 100);
			AddCharacterGoods(sld, GOOD_GOLD, 1100+rand(100));
		}
		if (i == 3) 
		{
			iSpace = GetCharacterFreeSpace(sld, GOOD_TOBACCO);
			iSpace = makeint(iSpace/2 + rand(iSpace/2));
			Fantom_SetCharacterGoods(sld, GOOD_TOBACCO, iSpace, 1);
		}
		Group_AddCharacter("Mtr_GoldSeaGroup", "Mtr_GoldCap_"+i);
	}
	Group_SetGroupCommander("Mtr_GoldSeaGroup", "Mtr_GoldCap_1");
	Group_SetTaskAttack("Mtr_GoldSeaGroup", PLAYER_GROUP);
	Group_LockTask("Mtr_GoldSeaGroup");
	Sea_LoginGroupCurrentSea("Mtr_GoldSeaGroup");
	// на корабль Тиракса
	int Hour = 2;
	if (MOD_SKILL_ENEMY_RATE < 4) Hour = 1;
	if (MOD_SKILL_ENEMY_RATE > 6) Hour = 3;
	pchar.quest.mtraxx_corrida_boss.win_condition.l1 = "Timer";
	pchar.quest.mtraxx_corrida_boss.win_condition.l1.date.hour  = sti(GetTime() + Hour);
	pchar.quest.mtraxx_corrida_boss.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 0);
	pchar.quest.mtraxx_corrida_boss.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 0);
	pchar.quest.mtraxx_corrida_boss.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 0);
	pchar.quest.mtraxx_corrida_boss.function = "Mtraxx_CorridaMarkus";
	// реакции
	pchar.quest.mtraxx_corrida_goldwin.win_condition.l1 = "Character_Capture";
	pchar.quest.mtraxx_corrida_goldwin.win_condition.l1.character = "Mtr_GoldCap_2";
	pchar.quest.mtraxx_corrida_goldwin.function = "Mtraxx_CorridaGoldWin";
	pchar.quest.mtraxx_corrida_goldsink.win_condition.l1 = "Character_sink";
	pchar.quest.mtraxx_corrida_goldsink.win_condition.l1.character = "Mtr_GoldCap_2";
	pchar.quest.mtraxx_corrida_goldsink.function = "Mtraxx_CorridaGoldFail";
	pchar.quest.mtraxx_corrida_goldcheck.win_condition.l1 = "Group_Death";
	pchar.quest.mtraxx_corrida_goldcheck.win_condition.l1.group = "Mtr_GoldSeaGroup";
	pchar.quest.mtraxx_corrida_goldcheck.function = "Mtraxx_CorridaGoldCheck";
}

void Mtraxx_CorridaMarkus(string qName) // 
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	Group_FindOrCreateGroup("Terrax_SeaGroup");
	sld = CharacterFromID("Terrax");
	FantomMakeCoolSailor(sld, SHIP_LINESHIP, "Red Dragon", CANNON_TYPE_CULVERINE_LBS36, 110, 110, 110);
	FantomMakeCoolFighter(sld, 50, 110, 110, "blade_19", "pistol4", "bullet", 300);
	sld.DeckDialogNode = "mtraxx_board";
	SetCharacterPerk(sld, "BasicDefense");
	SetCharacterPerk(sld, "Gunman");
	SetCharacterPerk(sld, "GunProfessional");
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "HardHitter");
	SetCharacterPerk(sld, "SwordplayProfessional");
	SetCharacterPerk(sld, "Doctor1");
	SetCharacterPerk(sld, "Doctor2");
	SetCharacterPerk(sld, "ShipSpeedUp");
	SetCharacterPerk(sld, "ShipTurnRateUp");
	SetCharacterPerk(sld, "StormProfessional");
	SetCharacterPerk(sld, "WindCatcher");
	SetCharacterPerk(sld, "SailsMan");
	SetCharacterPerk(sld, "SailingProfessional");
	SetCharacterPerk(sld, "LongRangeShoot");
	SetCharacterPerk(sld, "FastReload");
	SetCharacterPerk(sld, "CannonProfessional");
	SetCharacterPerk(sld, "BasicBattleState");
	SetCharacterPerk(sld, "AdvancedBattleState");
	SetCharacterPerk(sld, "ShipDefenseProfessional");
	SetCharacterPerk(sld, "Carpenter");
	SetCharacterPerk(sld, "Builder");
	SetCharacterPerk(sld, "LongRangeGrappling");
	SetCharacterPerk(sld, "GrapplingProfessional");
	SetCharacterPerk(sld, "Brander");
	SetCharacterPerk(sld, "MusketsShoot");
	SetCharacterPerk(sld, "BasicCommerce");
	SetCharacterPerk(sld, "AdvancedCommerce");
        GiveItem2Character(sld, "talisman3");    //belamour некий бонус за Корриду
	EquipCharacterbyItem(sld, "talisman3");  // у протагониста орудия взрываются на раз два
        EquipCharacterbyItem(sld, "pistol4");    // без дела в инвентаре лежит
        LAi_SetCharacterUseBullet(sld, "bullet"); 
	Mtraxx_MarkusSetShipParameter();
	SetCharacterGoods(sld, GOOD_BALLS, 3500);
	SetCharacterGoods(sld, GOOD_GRAPES, 2000);
	SetCharacterGoods(sld, GOOD_KNIPPELS, 1500);
	SetCharacterGoods(sld, GOOD_BOMBS, 3500);
	SetCharacterGoods(sld, GOOD_POWDER, 10500);
	SetCharacterGoods(sld, GOOD_WEAPON, 1000);
	SetCharacterGoods(sld, GOOD_FOOD, 2000);
	SetCharacterGoods(sld, GOOD_MEDICAMENT, 700);
	SetCharacterGoods(sld, GOOD_RUM, 200);
	SetCharacterGoods(sld, GOOD_PLANKS, 100);
	SetCharacterGoods(sld, GOOD_SAILCLOTH, 50);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.AlwaysSandbankManeuver = true;
	Character_SetAbordageEnable(sld, false); // нельзя абордировать
	sld.Tasks.CanBoarding = false; // запрет идти на абордаж - дубль
	sld.Tasks.CanChangeShipAfterBoarding = false; // запрет меняться кораблями - дубль
	sld.Ship.Mode = "mercenary";
	sld.Abordage.Enable = false;
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true; 
	sld.DontDeskTalk = true;
	LAi_SetImmortal(sld, false);
	sld.ShipHideImmortal = 1000; // непотопляемый корабль
	sld.SeaBoss = 0.8; // получает на 80% меньше урона корпусу, 10% урона парусам
	Group_AddCharacter("Terrax_SeaGroup", "Terrax");
	Group_SetGroupCommander("Terrax_SeaGroup", "Terrax");
	Group_SetTaskAttack("Terrax_SeaGroup", "Mtr_GoldSeaGroup");
	Group_LockTask("Terrax_SeaGroup");
	Sea_LoginGroupCurrentSea("Terrax_SeaGroup");
	DoQuestFunctionDelay("Mtraxx_CorridaMarkusCommand", 3.0);
	pchar.quest.mtraxx_ship_fail.win_condition.l1 = "NPC_Death";
	pchar.quest.mtraxx_ship_fail.win_condition.l1.character = "Terrax";
	pchar.quest.mtraxx_ship_fail.function = "Mtraxx_MarkusGameOver"; // для шибко грамотных
}

void Mtraxx_MarkusGameOver(string qName) // прибьем корабль особо умных, чтобы не выделывались
{
	Log_Info("A huge explosion on "+pchar.ship.name+"!");
	Ship_Detonate(pchar, true, true); 
	PlaySound("Sea Battles\Vzriv_fort_001.wav");
	PlaySound("Sea Battles\vzriv_pogreb_002.wav");
	PlaySound("Sea Battles\vzriv_pogreb_002.wav");
}

void Mtraxx_MarkusSetShipParameter()
{
	sld = CharacterFromID("Terrax");
	SetSelfSkill(sld, 90, 90, 90, 90, 90);
	SetShipSkill(sld, 75, 90, 100, 100, 100, 100, 100, 100, 80);
	RealShips[sti(sld.Ship.Type)].MaxCaliber = 36;
	RealShips[sti(sld.Ship.Type)].CannonsQuantityMin = 56;
	RealShips[sti(sld.Ship.Type)].MaxCrew = 800;
	RealShips[sti(sld.Ship.Type)].SpeedRate = 13.5;
	RealShips[sti(sld.Ship.Type)].TurnRate = 29.5;
	RealShips[sti(sld.Ship.Type)].MaxCrew = 800;
	RealShips[sti(sld.Ship.Type)].HP = 8000;
	RealShips[sti(sld.Ship.Type)].WindAgainstSpeed = 0.42;
	RealShips[sti(sld.Ship.Type)].ship.upgrades.hull = 1;
    sld.ship.HP = 8000;    //belamour текущее состояние корпуса в макс.
	SetSailsColor(sld, 8);//черный парус
	UpgradeShipParameter(sld, "SpeedRate");//апгрейдить скорость
	UpgradeShipParameter(sld, "TurnRate");//маневренность
	UpgradeShipParameter(sld, "WindAgainstSpeed");//бейд
	DeleteAttribute(sld, "ship.hulls");
	int hcrew = GetMaxCrewQuantity(sld);
	SetCrewQuantity(sld, hcrew);
	sld.Ship.Crew.Morale = 100;
	sld.Ship.Crew.Exp.Sailors = 100;
	sld.Ship.Crew.Exp.Cannoners = 100;
	sld.Ship.Crew.Exp.Soldiers = 100;
}

void Mtraxx_CorridaMarkusCommand(string qName) // 
{
	ref chr = CharacterFromID("Terrax");
	sld = CharacterFromID("Mtr_GoldCap_1");
	Ship_SetTaskAttack(SECONDARY_TASK, sti(chr.index), sti(sld.index));
	SetCharacterRemovable(chr, false);
	chr.CompanionEnemyEnable = false; //всегда друзья
	SetCompanionIndex(pchar, -1, sti(chr.index));
	chr.loyality = MAX_LOYALITY;
}

void Mtraxx_CorridaGoldWin(string qName) // 
{
	pchar.questTemp.Mtraxx.Corrida.Gold = "true";
}

void Mtraxx_CorridaGoldFail(string qName) // 
{
	pchar.questTemp.Mtraxx.Corrida.Poor = "true";
}

void Mtraxx_CorridaGoldCheck(string qName) // 
{
	pchar.quest.mtraxx_ship_fail.over = "yes"; 
	Group_DeleteGroup("Mtr_GoldSeaGroup");
	pchar.GenQuest.MapClosedNoBattle = true;
	DeleteAttribute(pchar, "questTemp.Mtraxx.Ignasio.Capellan");
	sld = CharacterFromID("Terrax");
	DeleteAttribute(sld, "DontDeskTalk");
	RemoveCharacterCompanion(pchar, sld);
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true; 
	LAi_SetImmortal(sld, true);
	Group_AddCharacter("Terrax_SeaGroup", "Terrax");
	Group_SetGroupCommander("Terrax_SeaGroup", "Terrax");
	Group_SetTaskNone("Terrax_SeaGroup");
	Group_LockTask("Terrax_SeaGroup");
	AddQuestRecord("Roger_8", "17");
}

void Mtraxx_CorridaComplete(string qName) // 
{
	Group_DelCharacter("Terrax_SeaGroup", "Terrax");
	Group_DeleteGroup("Terrax_SeaGroup");
	pchar.questTemp.Mtraxx = "wait_month";
	sld = CharacterFromID("Terrax");
	sld.location = "LaVega_townhall";
	sld.location.group = "sit";
	sld.location.locator = "sit1";
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "PIRATE_CITIZENS");
	sld.dialog.currentnode = "First time";
	SetFunctionTimerCondition("Mtraxx_CartahenaTavernPrepare", 0, 0, 18, false);
	SetFunctionTimerCondition("Mtraxx_CartahenaPrepare", 0, 0, 20, false);
	SetFunctionTimerCondition("Mtraxx_CartahenaLate", 0, 0, 22, false);
	// НЗГ
	ChangeCharacterComplexReputation(pchar, "nobility", -8);
	ChangeCharacterComplexReputation(pchar, "authority", 5);
	ChangeCharacterComplexReputation(pchar, "fame", 5);
	OfficersReaction("bad");
	OfficersReaction("bad");
	ChangeCharacterHunterScore(PChar, "spahunter", 20);
}

// эпизод 9. Город кровавой жатвы.
void Mtraxx_CartahenaPrepare(string qName) // готовим 9 эпизод
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	QuestSetCurrentNode("Terrax", "mtraxx_90");
	DeleteAttribute(sld, "DontDeskTalk");
}

void Mtraxx_CartahenaTavernPrepare(string qName) // готовим таверну - запрещаем генерацию фантомов
{
	pchar.questTemp.Mtraxx.InTavern = "true";
}

void Mtraxx_CartahenaLate(string qName) // не пришли к Тираксу за 9 заданием
{
	QuestSetCurrentNode("Terrax", "First time");
	AddQuestRecord("Roger_8", "23");
	CloseQuestHeader("Roger_8");
	DeleteAttribute(pchar, "questTemp.Mtraxx.Corrida");
	DeleteAttribute(pchar, "questTemp.Mtraxx.InTavern");
	LocatorReloadEnterDisable("LaVega_town", "reload6", true); // закрыть на месяц
	SetFunctionTimerCondition("Mtraxx_CartahenaLateOpen", 0, 0, 30, false);
	Mtraxx_TerraxReset(8); // правки 4
}

void Mtraxx_CartahenaLateOpen(string qName) // 
{
	LocatorReloadEnterDisable("LaVega_town", "reload6", false);
	sld = CharacterFromID("Terrax");
	sld.location = "LaVega_townhall";
	sld.location.group = "sit";
	sld.location.locator = "sit1";
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "PIRATE_CITIZENS");
	sld.dialog.currentnode = "First time";
	// капеллан - второй шанс
	if (CheckAttribute(pchar, "questTemp.ShipCapellan") && !CheckAttribute(pchar, "questTemp.ShipCapellan.Yes"))
	{
		DeleteAttribute(pchar, "questTemp.ShipCapellan");
	}
	// правки 4
	if (GetCharacterIndex("Mirabella") != -1)
	{
		sld = characterFromId("Mirabella");
		sld.dialog.currentnode = "mirabelle_29";
	}
}

void Mtraxx_CartahenaSailOver(string qName) // опоздание к Картахене
{
	pchar.quest.mtraxx_ship_fail1.over = "yes";
	pchar.quest.mtraxx_cartahena_sail.over = "yes";
	LocatorReloadEnterDisable("LaVega_port", "reload1_back", false); // правки релиза
	LocatorReloadEnterDisable("LaVega_town", "reload6", true); // закрыть на месяц
	SetFunctionTimerCondition("Mtraxx_CartahenaLateOpen", 0, 0, 30, false);
	DeleteAttribute(pchar, "DisableChangeFlagMode");
	pchar.worldmapencountersoff = "0";
	int i = FindColony("Cartahena");
	DeleteAttribute(colonies[i], "DontSetShipInPort");
	sld = CharacterFromID("Terrax");
	LAi_SetImmortal(sld, true);
	RemoveCharacterCompanion(pchar, sld);
	sld = characterFromId("Jeffry");
	RemoveCharacterCompanion(pchar, sld);
	sld.lifeday = 0;
	sld = characterFromId("Pelly");
	RemoveCharacterCompanion(pchar, sld);
	sld.lifeday = 0;
	sld = characterFromId("Mtr_Vensan");
	RemoveCharacterCompanion(pchar, sld);
	sld.lifeday = 0;
	AddQuestRecord("Roger_9", "2");
	Mtraxx_TerraxReset(9);
}

void Mtraxx_CartahenaArrive(string qName) // прибыли в акваторию Картахены
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	Log_Info("We've arrived to Cartagena! Tyrex orders to sail to Covenas Bay");
	PlaySound("interface\notebook.wav");
	pchar.quest.Mtraxx_CartahenaSailOver.over = "yes";
	LocatorReloadEnterDisable("LaVega_port", "reload1_back", false); // правки релиза
	bQuestDisableMapEnter = true;//закрыть карту
	Island_SetReloadEnableGlobal("Cartahena", false);
	locations[FindLocation("Shore25")].DisableEncounters = true;
	locations[FindLocation("Cartahena_ExitTown")].DisableEncounters = true;
	setCharacterShipLocation(pchar, "shore25");
	setWDMPointXZ("shore25");
	// belamour восстановить форт если была осада
	sld = CharacterFromID("Cartahena Fort Commander");
	sld.Fort.Mode = FORT_NORMAL;
	// ставим испанскую эскадру
	Group_FindOrCreateGroup("Mtr_CartahenaSeaGroup");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	int iShip, Ship1, Ship2, Ship3, iCannon, Cannon1, Cannon2, iSpace;
	
	switch (MOD_SKILL_ENEMY_RATE)
	{
		case 2:
			Ship1 = SHIP_BRIG;
			Ship2 = SHIP_SCHOONER_W;
			Ship3 = SHIP_SLOOP;
			Cannon1 = CANNON_TYPE_CANNON_LBS16;
			Cannon2 = CANNON_TYPE_CULVERINE_LBS8;
		break;
		
		case 4:
			Ship1 = SHIP_GALEON_L;
			Ship2 = SHIP_BRIGANTINE;
			Ship3 = SHIP_SCHOONER_W;
			Cannon1 = CANNON_TYPE_CULVERINE_LBS18;
			Cannon2 = CANNON_TYPE_CANNON_LBS16;
		break;
		
		case 6:
			Ship1 = SHIP_POLACRE;
			Ship2 = SHIP_GALEON_L;
			Ship3 = SHIP_BRIGANTINE;
			Cannon1 = CANNON_TYPE_CULVERINE_LBS18;
			Cannon2 = CANNON_TYPE_CANNON_LBS16;
		break;
		
		case 8:
			Ship1 = SHIP_POLACRE;
			Ship2 = SHIP_XebekVML;
			Ship3 = SHIP_GALEON_L;
			Cannon1 = CANNON_TYPE_CULVERINE_LBS18;
			Cannon2 = CANNON_TYPE_CANNON_LBS20;
		break;
		
		case 10:
			Ship1 = SHIP_NAVIO;
			Ship2 = SHIP_POLACRE;
			Ship3 = SHIP_XebekVML;
			Cannon1 = CANNON_TYPE_CANNON_LBS24;
			Cannon2 = CANNON_TYPE_CULVERINE_LBS18;
		break;
	}
	for (int i=1; i<=3; i++)
	{
		switch (i)
		{
			case 1:
				iShip = Ship1;
				iCannon = Cannon1;
			break;
			
			case 2:
				iShip = Ship2;
				iCannon = Cannon1;
				if (MOD_SKILL_ENEMY_RATE == 4 || MOD_SKILL_ENEMY_RATE == 10) iCannon = Cannon2;
			break;
			
			case 3:
				iShip = Ship3;
				iCannon = Cannon2;
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("Mtr_CartahenaCap_"+i, "off_spa_"+i, "man", "man", iRank, SPAIN, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, 50, 50, 50);
		FantomMakeCoolFighter(sld, iRank, 50, 50, LinkRandPhrase("blade_13","blade_13","blade_15"), "pistol1", "bullet", 150);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysEnemy = true;
		sld.Ship.Mode = "war";
		sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*6;
		if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
		Group_AddCharacter("Mtr_CartahenaSeaGroup", "Mtr_CartahenaCap_"+i);
	}
	Group_SetGroupCommander("Mtr_CartahenaSeaGroup", "Mtr_CartahenaCap_1");
	Group_SetAddress("Mtr_CartahenaSeaGroup", "Cartahena", "quest_ships", "quest_ship_1");
	Group_SetTaskNone("Mtr_CartahenaSeaGroup");
	Group_LockTask("Mtr_CartahenaSeaGroup");
	pchar.quest.mtraxx_cartahena_squadron.win_condition.l1 = "Group_Death";
	pchar.quest.mtraxx_cartahena_squadron.win_condition.l1.group = "Mtr_CartahenaSeaGroup";
	pchar.quest.mtraxx_cartahena_squadron.function = "Mtraxx_CartahenaDestroyScuadron";
	DoQuestFunctionDelay("Mtraxx_CartahenaAbandon", 10.0);
}

void Mtraxx_CartahenaAbandon(string qName) // телепорт в бухту Ковеньяс
{
	pchar.GenQuest.Hunter2Pause = true; // прогона 3
	DoQuestReloadToLocation("Shore25", "rld", "loc10", "Mtraxx_CartahenaAbandon");
}

void Mtraxx_CartahenaSquadronAttack(string qName) // к атаке эскадры - готовы! // прогона 3
{
	sld = CharacterFromID("Terrax");
	LAi_SetActorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	LAi_ActorGoToLocation(sld, "reload", "sea", "none", "", "", "", 15.0);
	sld = characterFromId("Jeffry");
	LAi_SetActorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	LAi_ActorGoToLocation(sld, "reload", "sea", "none", "", "", "", 15.0);
	sld = characterFromId("Pelly");
	LAi_SetActorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	LAi_ActorGoToLocation(sld, "reload", "sea", "none", "", "", "", 15.0);
	sld = characterFromId("Mtr_Vensan");
	LAi_SetActorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	LAi_ActorGoToLocation(sld, "reload", "sea", "none", "", "", "", 15.0);
	sld = CharacterFromID("Lepricon");
	LAi_SetActorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	LAi_ActorRunToLocation(sld, "reload", "reload1", "none", "", "", "", 15.0);
	for (i=5; i<=10; i++) // буканьеры Леприкона
	{
		sld = CharacterFromID("Lepricons_bukaneers_"+i);
		LAi_SetActorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		LAi_ActorRunToLocation(sld, "reload", "reload1", "none", "", "", "", 15.0);
	}
	DoQuestCheckDelay("OpenTheDoors", 15.0);
	sld = CharacterFromID("Cartahena Fort Commander");
	LAi_SetImmortal(sld, true); // бессмертный форт
	Character_SetAbordageEnable(sld, false); // неабордируемый форт
	pchar.GenQuest.CannotTakeShip = true; // нельзя брать корабли призом
	AddQuestRecord("Roger_9", "3");
}

void Mtraxx_CartahenaDestroyScuadron(string qName) // потопили эскадру
{
	AddQuestRecord("Roger_9", "4");
	pchar.GenQuest.MapClosedNoBattle = true;
	DeleteAttribute(pchar, "GenQuest.CannotTakeShip");
	sld = characterFromId("Pelly");
	RemoveCharacterCompanion(pchar, sld);
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true; 
	ref chr = characterFromId("Mtr_Vensan");
	Ship_SetTaskDefend(SECONDARY_TASK, sti(sld.index), sti(chr.index));
	sld = CharacterFromID("Terrax");
	DeleteAttribute(sld, "DontDeskTalk");
	sld.DeckDialogNode = "mtraxx_101";
	AddComplexSeaExpToScill(100, 100, 100, 100, 100, 100, 0);
}

void Mtraxx_CartahenaPrepareFortBattle() // готовим атаку форта - штурм квестовый
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	DeleteAttribute(pchar, "questTemp.Mtraxx.Cartahena.Fort");
	PlaySound("MUSIC\Victory.mp3");
	Log_Info("Landing parties are ready to storm Cartagena!");
	PlaySound("interface\notebook.wav");
	PlaySound("interface\_GTTown2.wav");
	// расчет числа десанта
	int iCrew1 = GetCrewQuantity(pchar) - GetMinCrewQuantity(pchar));
	if (iCrew1 <= GetMinCrewQuantity(pchar)) iCrew1 = 0; // патч 17/1
	int iCrew2 = GetCrewQuantity(characterFromId("Terrax")) - GetMinCrewQuantity(characterFromId("Terrax"));
	if (iCrew2 <= GetMinCrewQuantity(characterFromId("Terrax"))) iCrew2 = 0; // патч 17/1
	int iCrew3 = GetCrewQuantity(characterFromId("Jeffry")) - GetMinCrewQuantity(characterFromId("Jeffry"));
	if (iCrew3 <= GetMinCrewQuantity(characterFromId("Jeffry"))) iCrew3 = 0; // патч 17/1
	int iCrew4 = GetCrewQuantity(characterFromId("Pelly")) - GetMinCrewQuantity(characterFromId("Pelly"));
	if (iCrew4 <= GetMinCrewQuantity(characterFromId("Pelly"))) iCrew4 = 0; // патч 17/1
	int iCrew = iCrew1 + iCrew2 + iCrew3 + iCrew4;
	log_info("Landing party of '"+pchar.ship.name+"' has "+iCrew1+" men");
	log_info("Landing party of Red Dragon has "+iCrew2+" men");
	log_info("Landing party of Snake has "+iCrew3+" men");
	log_info("Landing party of Moray has "+iCrew4+" men");
	pchar.questTemp.Mtraxx.Cartahena.Crew = iCrew;
	pchar.questTemp.Mtraxx.Cartahena.Crewpercent1 = makeint(100*iCrew1/iCrew); // процент команды ГГ
	pchar.questTemp.Mtraxx.Cartahena.Crewpercent2 = makeint(100*iCrew2/iCrew); // процент команды Тиракса
	pchar.questTemp.Mtraxx.Cartahena.Crewpercent3 = makeint(100*iCrew3/iCrew); // процент команды Джеффри
	pchar.questTemp.Mtraxx.Cartahena.Crewpercent4 = makeint(100*iCrew4/iCrew); // процент команды Тесака
	DoQuestFunctionDelay("Mtraxx_CartahenaFortReload", 10.0);
}

void Mtraxx_CartahenaFortReload(string qName) // перегруз в первую фортовую локацию
{
	MakeCloneFortBoarding("Cartahena_fort");
	DoQuestReloadToLocation("BOARDING_FORT", "goto", "loc14", "Mtraxx_CartahenaFortFirstBattle");
}

void Mtraxx_CartahenaFortReloadNext(string qName) // перегруз во втрорую фортовую локацию
{
	DoQuestReloadToLocation("Boarding_bastion1", "reload", "reload1", "Mtraxx_CartahenaFortSecondBattle");
}

void Mtraxx_CartahenaFortReloadEnd(string qName) // перегруз в третью фортовую локацию
{
	DoQuestReloadToLocation("Boarding_fortyard", "reload", "reload3", "Mtraxx_CartahenaFortThirdBattle");
}

void Mtraxx_CartahenaExittownReload(string qName) // перегруз в локацию выход из города
{
	DoQuestReloadToLocation("Cartahena_ExitTown", "reload", "reload3", "Mtraxx_CartahenaExittownBattle");
}

void Mtraxx_CartahenaTownReload(string qName) // перегруз в локацию города
{
	DoQuestReloadToLocation("Cartahena_Town", "quest", "quest2", "Mtraxx_CartahenaTownBattle");
}

void Mtraxx_CartahenaToResidence(string qName) // перегруз в резиденцию
{
	DoQuestReloadToLocation("Cartahena_Townhall", "reload", "reload1", "Mtraxx_CartahenaResidence");
}

void Mtraxx_CartahenaInResidence(string qName) // Тесак идет искать
{
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "reload", "reload3");
	sld = CharacterFromID("Pelly");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload3", "none", "", "", "", 10.0);
	DoQuestFunctionDelay("Mtraxx_CartahenaResidenceWomen", 12.0);
}

void Mtraxx_CartahenaResidenceWomen(string qName) // женщины губернатора
{
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "reload", "reload3");
	string sModel = "women_2";
	for (i=1; i<=3; i++)
	{
		if (i == 2) sModel = "women_6";
		if (i == 3) sModel = "women_14";
		sld = GetCharacter(NPC_GenerateCharacter("Mtr_CartahenaWomen_"+i, sModel, "woman", "towngirl", 1, SPAIN, 3, true, "quest"));
		SetFantomParamFromRank(sld, 1, true);
		RemoveAllCharacterItems(sld, true);
		ChangeCharacterAddressGroup(sld, "Cartahena_Townhall", "reload", "reload3");
		LAi_SetActorType(sld);
		LAi_ActorFollow(sld, pchar, "", 3.0);
	}
	DoQuestFunctionDelay("Mtraxx_CartahenaResidencePelly", 3.0);
	
}

void Mtraxx_CartahenaResidencePelly(string qName) // Тесак возвращается
{
	LAi_SetPlayerType(pchar);
	sld = CharacterFromID("Pelly");
	ChangeCharacterAddressGroup(sld, "Cartahena_Townhall", "reload", "reload3");
	LAi_CharacterEnableDialog(sld);
	sld.dialog.currentnode = "Pelly_28";
	LAi_SetActorType(sld);
	LAi_ActorDialogDelay(sld, pchar, "", 1.0);
	for (int i=1; i<=3; i++)
	{
		sld = CharacterFromID("Mtr_CartahenaWomen_"+i);
		LAi_SetActorType(sld);
	}
}

void Mtraxx_CartahenaToFort() // в форт
{
	// выход из резиденции
	pchar.quest.mtraxx_cartahena_tofort.win_condition.l1 = "locator";
	pchar.quest.mtraxx_cartahena_tofort.win_condition.l1.location = "Cartahena_Townhall";
	pchar.quest.mtraxx_cartahena_tofort.win_condition.l1.locator_group = "reload";
	pchar.quest.mtraxx_cartahena_tofort.win_condition.l1.locator = "reload1_back";
	pchar.quest.mtraxx_cartahena_tofort.function = "Mtraxx_CartahenaToStreet";
	// на ворота
	pchar.quest.mtraxx_cartahena_tofort1.win_condition.l1 = "locator";
	pchar.quest.mtraxx_cartahena_tofort1.win_condition.l1.location = "Cartahena_Town";
	pchar.quest.mtraxx_cartahena_tofort1.win_condition.l1.locator_group = "reload";
	pchar.quest.mtraxx_cartahena_tofort1.win_condition.l1.locator = "gate_back";
	pchar.quest.mtraxx_cartahena_tofort1.function = "Mtraxx_CartahenaToExittown";
	// на вход в форт
	pchar.quest.mtraxx_cartahena_tofort2.win_condition.l1 = "locator";
	pchar.quest.mtraxx_cartahena_tofort2.win_condition.l1.location = "Cartahena_Exittown";
	pchar.quest.mtraxx_cartahena_tofort2.win_condition.l1.locator_group = "reload";
	pchar.quest.mtraxx_cartahena_tofort2.win_condition.l1.locator = "reload3_back";
	pchar.quest.mtraxx_cartahena_tofort2.function = "Mtraxx_CartahenaGoFort";
	sld = CharacterFromID("Pelly");
	LAi_SetActorType(sld);
	LAi_ActorFollowEverywhere(sld, "", -1);
}

void Mtraxx_CartahenaToStreet(string qName) // перегруз на улицы
{
	DoQuestReloadToLocation("Cartahena_Town", "reload", "reload3", "Mtraxx_CartahenaStreet");
}

void Mtraxx_CartahenaToExittown(string qName) // перегруз за ворота
{
	DoQuestReloadToLocation("Cartahena_Exittown", "reload", "reload4", "");
}

void Mtraxx_CartahenaGoFort(string qName) // перегруз в форт
{
	DoQuestReloadToLocation("Cartahena_fort", "reload", "reload1", "Mtraxx_CartahenaTerraxInFort");
}

void Mtraxx_CartahenaFinal() // завершаем квест, грузим остатки команды кораблей
{
	pchar.ship.crew.quantity = GetMinCrewQuantity(pchar)+sti(pchar.questTemp.Mtraxx.Cartahena.AliveCrew1);
	sld = CharacterFromID("Terrax");
        RemoveCharacterEquip(sld, GUN_ITEM_TYPE); 
        RemoveCharacterEquip(sld, TALISMAN_ITEM_TYPE);
        TakeItemFromCharacter(sld, "talisman3");        // belamour уберем остатки роскоши
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload1", "none", "", "", "", 10.0);
	sld.ship.crew.quantity = GetMinCrewQuantity(characterFromId("Terrax"))+sti(pchar.questTemp.Mtraxx.Cartahena.AliveCrew2);
	sld = CharacterFromID("Jeffry");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload1", "none", "", "", "", 10.0);
	sld.ship.crew.quantity = GetMinCrewQuantity(characterFromId("Jeffry"))+sti(pchar.questTemp.Mtraxx.Cartahena.AliveCrew3);
	sld = CharacterFromID("Pelly");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload1", "none", "", "", "", 10.0);
	sld.ship.crew.quantity = GetMinCrewQuantity(characterFromId("Pelly"))+sti(pchar.questTemp.Mtraxx.Cartahena.AliveCrew4);
	sld = CharacterFromID("Mtr_Vensan");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload1", "none", "", "", "", 10.0);
	sld.ship.crew.quantity = GetCrewQuantity(sld)-30;
	sld = CharacterFromID("Lepricon");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload1", "none", "", "", "", 10.0);
	DoQuestFunctionDelay("Mtraxx_CartahenaReloadComplete", 11.0);
}

void Mtraxx_CartahenaReloadComplete(string qName) // перегруз на пирс
{
	DoQuestReloadToLocation("Cartahena_town", "quest", "quest1", "Mtraxx_CartahenaComplete");
}

void Mtraxx_CartahenaShipsGoAway(string qName) // вышли в море у Картахены // 3 прогона
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	Group_FindOrCreateGroup("Terrax_SeaGroup");
	Group_AddCharacter("Terrax_SeaGroup", "Terrax");
	Group_AddCharacter("Terrax_SeaGroup", "Jeffry");
	Group_AddCharacter("Terrax_SeaGroup", "Pelly");
	Group_AddCharacter("Terrax_SeaGroup", "Mtr_Vensan");
	Group_SetGroupCommander("Terrax_SeaGroup", "Terrax");
	Group_SetTaskRunAway("Terrax_SeaGroup", PLAYER_GROUP);
	Group_SetAddress("Terrax_SeaGroup", "Cartahena", "quest_ships", "quest_ship_6");
	Group_LockTask("Terrax_SeaGroup");
	pchar.quest.mtraxx_cartahena_clear.win_condition.l1 = "MapEnter";
	pchar.quest.mtraxx_cartahena_clear.function = "Mtraxx_CartahenaClear";
	pchar.quest.mtraxx_cartahena_tortuga.win_condition.l1 = "location";
	pchar.quest.mtraxx_cartahena_tortuga.win_condition.l1.location = "Tortuga_town";
	pchar.quest.mtraxx_cartahena_tortuga.function = "Mtraxx_RetributionStart";
	int n = sti(pchar.questTemp.Mtraxx.Cartahena.TownCrew);
	for (int i=1; i<=n; i++)
	{
		if (GetCharacterIndex("Mtr_CartahenaTownPirate_"+i) != -1)
		{
			sld = CharacterFromID("Mtr_CartahenaTownPirate_"+i);
			ChangeCharacterAddressGroup(sld, "none", "", "");
			sld.lifeday = 0;
		}
	}
	Achievment_SetStat(pchar, 58, 1);
}

void Mtraxx_CartahenaClear(string qName) // чистим все запреты
{
	log_testinfo("Картахена восстановлена");
	DeleteAttribute(pchar, "GenQuest.HunterLongPause");
	pchar.quest.mtraxx_ship_fail1.over = "yes";
	SetFunctionTimerCondition("Mtraxx_CartahenaNormal", 0, 0, 7, false); // таймер на восстановление Картахены
	Group_SetAddress("Terrax_SeaGroup", "Hispaniola1", "quest_ships", "quest_ship_4"); // 3 прогона
	Group_DeleteGroup("Terrax_SeaGroup");
	DeleteAttribute(pchar, "GenQuest.CannotWait");
	LAi_LocationDisableOfficersGen("shore25", false);
	LocatorReloadEnterDisable("shore25", "reload1_back", false);
	DeleteAttribute(pchar, "DisableChangeFlagMode");
	pchar.worldmapencountersoff = "0";
	int i = FindColony("Cartahena");
	DeleteAttribute(colonies[i], "DontSetShipInPort");
	DeleteAttribute(&locations[FindLocation("Cartahena_Town")], "QuestCapture");
	DeleteAttribute(&locations[FindLocation("Cartahena_fort")], "QuestCapture");
	for (i=3; i<=10; i++)
	{
		LocatorReloadEnterDisable("Cartahena_town", "reload"+i+"_back", false);
	}
	LocatorReloadEnterDisable("Cartahena_town", "gate_back", false);
	LocatorReloadEnterDisable("Cartahena_town", "reload_jail", false);
	LAi_LocationFightDisable(&Locations[FindLocation("Cartahena_fort")], false);
	LAi_LocationFightDisable(&Locations[FindLocation("Cartahena_town")], false);
	LAi_LocationFightDisable(&Locations[FindLocation("Cartahena_townhall")], false);
	LAi_LocationDisableOfficersGen("Cartahena_townhall", false);
	sld = CharacterFromID("Cartahena_Mayor");
	ChangeCharacterAddressGroup(sld, "Cartahena_townhall", "sit", "sit1");
	sld = CharacterFromID("Mtr_CartahenaMayorClone");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld.lifeday = 0; // патч 17/1
	// вертаем нищеброда
	sld = characterFromId("Cartahena_Poorman");
	ChangeCharacterAddressGroup(sld, "Cartahena_town", "goto", "goto5");
	// НЗГ
	ChangeCharacterComplexReputation(pchar, "nobility", -30);
	ChangeCharacterComplexReputation(pchar, "authority", 10);
	ChangeCharacterComplexReputation(pchar, "fame", 10);
	OfficersReaction("bad");
	OfficersReaction("bad");
	OfficersReaction("bad");
	ChangeCharacterHunterScore(PChar, "spahunter", 40);
	AddComplexSelfExpToScill(200, 200, 200, 200);
	AddCharacterExpToSkill(pchar, "Fortune", 300);
}

void Mtraxx_CartahenaNormal(string qName) // восстанавливаем Картахену в норму
{
	sld = CharacterFromID("Cartahena Fort Commander");
	Character_SetAbordageEnable(sld, true); 
	Island_SetReloadEnableGlobal("Cartahena", true);
}

// Эпизод 10. Длань Немезиды
void Mtraxx_RetributionStart(string qName) // прибыл на Тортугу
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	chrDisableReloadToLocation = true;
	LAi_SetActorType(pchar);
	LAi_ActorRunToLocator(pchar, "reload", "reload9_back", "Mtraxx_RetributionStart", -1);
}

void Mtraxx_RetributionInBrothel() // релоад в комнату
{
	chrDisableReloadToLocation = true;
	LAi_SetActorType(pchar);
	DoQuestReloadToLocation("Tortuga_Brothel_room", "sit", "sit1", "Mtraxx_RetributionInBrothel");
}

void Mtraxx_RetributionToTavern(string qName) // релоад в таверну
{
	DoQuestReloadToLocation("Tortuga_tavern", "reload", "reload1", "");
}

void Mtraxx_RetributionToRoom(string qName) // релоад в комнату
{
	DoQuestReloadToLocation("Tortuga_tavern_upstairs", "quest", "quest4", "Mtraxx_RetributionToRoom");
	DeleteAttribute(pchar, "GenQuest.CamShuttle");
}

void Mtraxx_RetributionOutRoom() // Камилла уходит
{
	chrDisableReloadToLocation = true; // прогон 4
	sld = characterFromId("Kamilla");
	sld.dialog.currentnode = "camilla_27";
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload1", "Tortuga_church", "goto", "goto1", "Mtraxx_RetributionKamilla", 3.0);
	LAi_SetLoginTime(sld, 10.0, 13.0);
	AddQuestRecord("Roger_10", "1");
	CloseQuestHeader("Roger_9");
	pchar.questTemp.Mtraxx.Retribution = "map";
}

void Mtraxx_RetributionCarataska(string qName) // прибыли в лагуну Каратаска // 3 прогона
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	pchar.GenQuest.HunterLongPause = true;
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	AddQuestRecord("Roger_10", "3");
	pchar.quest.mtraxx_retribution_barricade.win_condition.l1 = "locator";
	pchar.quest.mtraxx_retribution_barricade.win_condition.l1.location = "Carataska_jungle_02";
	pchar.quest.mtraxx_retribution_barricade.win_condition.l1.locator_group = "quest";
	pchar.quest.mtraxx_retribution_barricade.win_condition.l1.locator = "deadfall";
	pchar.quest.mtraxx_retribution_barricade.function = "Mtraxx_RetributionBarricade";
	Mtraxx_RetributionSetRanditems();// укладываем предметы в рандитемы подземелий
	// запрещаем офицеров
	LAi_LocationDisableOfficersGen("Shore10", true);
	LAi_LocationDisableOfficersGen("Carataska_jungle_01", true);
	LAi_LocationDisableOfficersGen("Carataska_jungle_02", true);
	LAi_LocationDisableOfficersGen("Carataska_jungle_03", true);
	LAi_LocationDisableOfficersGen("Carataska_CaveEntrance", true);
	LAi_LocationDisableOfficersGen("Carataska_Cave", true);
	LAi_LocationDisableOfficersGen("Ruins", true);
}

void Mtraxx_RetributionSetRanditems() // укладываем предметы в рандитемы подземелий
{
	pchar.GenQuestRandItem.Judgement_dungeon_01 = true;
	pchar.GenQuestRandItem.Judgement_dungeon_01.randitem1 = Mtraxx_RetributionSelectRanditem();
	pchar.GenQuestRandItem.Judgement_dungeon_03 = true;
	pchar.GenQuestRandItem.Judgement_dungeon_03.randitem1 = Mtraxx_RetributionSelectRanditem();
	pchar.GenQuestRandItem.Judgement_dungeon_03.randitem2 = Mtraxx_RetributionSelectRanditem();
	pchar.GenQuestRandItem.Judgement_dungeon_03.randitem3 = Mtraxx_RetributionSelectRanditem();
	pchar.GenQuestRandItem.Judgement_dungeon_03.randitem4 = Mtraxx_RetributionSelectRanditem();
	pchar.GenQuestRandItem.Judgement_dungeon_04 = true;
	pchar.GenQuestRandItem.Judgement_dungeon_04.randitem1 = Mtraxx_RetributionSelectRanditem();
	pchar.GenQuestRandItem.Judgement_dungeon_04.randitem2 = Mtraxx_RetributionSelectRanditem();
	pchar.GenQuestRandItem.Judgement_dungeon_04.randitem3 = Mtraxx_RetributionSelectRanditem();
	pchar.GenQuestRandItem.Judgement_dungeon_04.randitem4 = Mtraxx_RetributionSelectRanditem();
	pchar.GenQuestRandItem.Judgement_dungeon_04.randitem5 = Mtraxx_RetributionSelectRanditem();
	pchar.GenQuestRandItem.Judgement_dungeon_04.randitem6 = Mtraxx_RetributionSelectRanditem();
	pchar.GenQuestRandItem.Judgement_dungeon_05 = true;
	pchar.GenQuestRandItem.Judgement_dungeon_05.randitem1 = Mtraxx_RetributionSelectRanditem();
	pchar.GenQuestRandItem.Judgement_dungeon_06 = true;
	pchar.GenQuestRandItem.Judgement_dungeon_06.randitem1 = Mtraxx_RetributionSelectRanditem();
	pchar.GenQuestRandItem.Judgement_dungeon_06.randitem2 = Mtraxx_RetributionSelectRanditem();
	pchar.GenQuestRandItem.Judgement_dungeon_06.randitem3 = Mtraxx_RetributionSelectRanditem();
	pchar.GenQuestRandItem.Judgement_dungeon_09 = true;
	pchar.GenQuestRandItem.Judgement_dungeon_09.randitem1 = Mtraxx_RetributionSelectRanditem();
	pchar.GenQuestRandItem.Judgement_dungeon_09.randitem2 = Mtraxx_RetributionSelectRanditem();
}

void Mtraxx_RetributionBarricade(string qName) // уперлись в завал
{
	AddQuestRecord("Roger_10", "4");
	pchar.quest.mtraxx_retribution_carataska.win_condition.l1 = "location";
	pchar.quest.mtraxx_retribution_carataska.win_condition.l1.location = "shore10";
	pchar.quest.mtraxx_retribution_carataska.function = "Mtraxx_RetributionPowder";
	pchar.questTemp.Mtraxx.Retribution.Powder = "true";
}

void Mtraxx_RetributionPowder(string qName) // на корабль за порохом
{
	chrDisableReloadToLocation = true;
	DoQuestCheckDelay("TalkSelf_Quest", 3.0);
}

void Mtraxx_RetributionBarrels() // доставка бочонков
{
	SetLaunchFrameFormParam("One day later..."+ NewStr() +" Barrels with gunpowder have been delivered to the logjam.", "Mtraxx_RetributionBarrels", 0, 5);//табличка
	WaitDate("", 0, 0, 1, 2, 10); //крутим время
	LaunchFrameForm();
	RefreshLandTime();
	RecalculateJumpTable();
	Whr_UpdateWeather();
	int n = Findlocation("Carataska_jungle_02");
	string sTemp;
	for (int i=1; i<=3; i++)
	{
		sTemp = "Barrel"+i;
		locations[n].models.always.(sTemp) = "Barrel";
		Locations[n].models.always.(sTemp).locator.group = "quest";
		Locations[n].models.always.(sTemp).locator.name = "barrel"+i;
		Locations[n].models.always.(sTemp).tech = "DLightModel";
	}
	RemoveCharacterGoods(pchar, GOOD_POWDER, 300);
	pchar.questTemp.Mtraxx.Retribution = "ruins";
}

void Mtraxx_RetributionBurn() // поджечь фитиль!
{
	if (CheckCharacterItem(pchar, "Mineral10"))
	{
		DeleteAttribute(pchar, "questTemp.Mtraxx.Retribution.Fire");
		LAi_SetActorType(pchar);
		LAi_ActorAnimation(pchar, "Barman_idle", "", 4.0);
		for (int i=1; i<=3; i++)
		{
			CreateLocationParticles("smoke", "quest", "barrel"+i, 0, 0, 0, "");
		}
		DoQuestFunctionDelay("Mtraxx_RetributionRunAway", 4.5);
	}
	else
	{
		Log_Info("You need a flint to fire the fuse");
		PlaySound("interface\notebook.wav");
	}
}

void Mtraxx_RetributionRunAway(string qName) // бежим!
{
	LAi_SetActorType(pchar);
	LAi_ActorRunToLocator(pchar, "rld", "aloc21", "Mtraxx_RetributionRunAway", -1);
}

void Mtraxx_RetributionJungleBoom(string qName) // большой бабах
{
	for (int i=1; i<=3; i++)
	{
		CreateLocationParticles("large_smoke", "quest", "barrel"+i, 0, 0, 0, "");
		CreateLocationParticles("ShipExplode", "quest", "barrel"+i, 1.0, 0, 0, "boom");
		CreateLocationParticles("blast_inv", "quest", "barrel"+i, 1.0, 0, 0, "");
		CreateLocationParticles("blast_dirt", "quest", "barrel"+i, 1.0, 0, 0, "");
	}
	CreateLocationParticles("large_smoke", "quest", "deadfall", 0, 0, 0, "");
	CreateLocationParticles("ShipExplode", "quest", "deadfall", 1.0, 0, 0, "boom");
	CreateLocationParticles("blast_inv", "quest", "deadfall", 1.0, 0, 0, "");
	CreateLocationParticles("blast_dirt", "quest", "deadfall", 1.0, 0, 0, "");
	PlaySound("Sea Battles\Vzriv_fort_001.wav");
	PlaySound("Sea Battles\vzriv_pogreb_002.wav");
	PlaySound("Sea Battles\vzriv_pogreb_002.wav");
	for (i=1; i<=3; i++)
	{
		int idx = GetOfficersIndex(pchar, i);
		if (idx < 1) continue;
		sld = &Characters[idx];
		if (sld.location.locator == "detector1") LAi_KillCharacter(sld);
	}
	DoQuestFunctionDelay("Mtraxx_RetributionJungleBoomReload", 3.5);
}

void Mtraxx_RetributionJungleBoomReload(string qName) // перегруз
{
	LAi_SetPlayerType(pchar);
	DoQuestReloadToLocation("Carataska_jungle_02", "rld", "aloc21", "Mtraxx_RetributionGotoRuins");
	int n = Findlocation("Carataska_jungle_02");
	for (int i=1; i<=3; i++)
	{
		DeleteAttribute(&locations[n], "models.always.Barrel"+i);
	}
	DeleteAttribute(&locations[n], "models.always.deadfall");
	locations[n].locators_radius.reload.reload2_back = 2.0;
}

void Mtraxx_RetributionRuins(string qName) // вошли в подземелья правосудия
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	RemoveItems(pchar, "mapEnrico", 1);
	pchar.GenQuest.CannotWait = true;
	AddQuestRecord("Roger_10", "6");
	// ставим Тесака и его приспешников у клетки с сокровищами
	LAi_LocationFightDisable(&Locations[FindLocation("Judgement_dungeon_05")], true);//запретить драться
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+3;
	int iScl = 30 + 2*sti(pchar.rank);
	sld = characterFromId("Pelly");
	sld.dialog.currentnode = "Pelly_30";
	LAi_CharacterEnableDialog(sld);
	LAi_SetImmortal(sld, false);
	LAi_RemoveCheckMinHP(sld); // Addon 2016-1 Jason пиратская линейка 1
	LAi_SetCurHPMax(sld);
	ChangeCharacterAddressGroup(sld, "Judgement_dungeon_05", "quest", "pelly");
	LAi_SetGuardianType(sld);
	sld.protector = true;
	if (MOD_SKILL_ENEMY_RATE > 2)
	{
		sld.MultiFighter = 1.0+stf(MOD_SKILL_ENEMY_RATE/10);
		sld.MultiShooter = 1.0+stf(MOD_SKILL_ENEMY_RATE/10);
	}
	// предметы-призы
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	RemoveItems(sld, "potion2", GetCharacterItem(sld, "potion2"));
	RemoveItems(sld, "potion3", GetCharacterItem(sld, "potion3"));
	TakeNItems(sld, "potion2", makeint(MOD_SKILL_ENEMY_RATE/2));
	TakeNItems(sld, "potion3", 2);
	TakeNItems(sld, "totem_02", 1);
	TakeNItems(sld, "obereg_5", 1);
	TakeNItems(sld, "indian_4", 1);
	for (int i=1; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Pelly_PirateDung_"+i, "citiz_4"+i, "man", "man", iRank, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, LinkRandPhrase("blade_04","blade_06","blade_06"), "pistol1", "bullet", iScl*3);
		if (MOD_SKILL_ENEMY_RATE > 4) sld.cirassId = Items_FindItemIdx("cirass2");
		ChangeCharacterAddressGroup(sld, "Judgement_dungeon_05", "quest", "quest"+i);
		LAi_SetStayType(sld);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_CharacterDisableDialog(sld);
		if (MOD_SKILL_ENEMY_RATE > 4)
		{
			sld.MultiFighter = 1.0+stf(MOD_SKILL_ENEMY_RATE/20);
			sld.MultiShooter = 1.0+stf(MOD_SKILL_ENEMY_RATE/20);
		}
	}
}

void Mtraxx_RetributionPellyFight(string qName) // бой с Тесаком
{
	LAi_LocationFightDisable(&Locations[FindLocation("Judgement_dungeon_05")], false);
	chrDisableReloadToLocation = true;
	LAi_group_Delete("EnemyFight");
	sld = characterFromId("Pelly");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	for (int i=1; i<=4; i++)
	{
		sld = characterFromId("Pelly_PirateDung_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Mtraxx_RetributionPellyAfterFight");
}

void Mtraxx_RetributionSetJeffry(string qName) // ставим Джеффри в шахту №2
{
	LAi_LocationFightDisable(&Locations[FindLocation("Judgement_dungeon_03")], true);//запретить драться
	chrDisableReloadToLocation = true;
	// ставим Джеффри и его пиратов
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+3;
	int iScl = 30 + 2*sti(pchar.rank);
	sld = characterFromId("Jeffry");
	sld.dialog.currentnode = "Jeffry_22";
	LAi_CharacterEnableDialog(sld);
	LAi_SetImmortal(sld, false);
	LAi_RemoveCheckMinHP(sld); // Addon 2016-1 Jason пиратская линейка 1
	LAi_SetCurHPMax(sld);
	ChangeCharacterAddressGroup(sld, "Judgement_dungeon_03", "quest", "jeffry");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	if (MOD_SKILL_ENEMY_RATE > 2)
	{
		sld.MultiFighter = 1.0+stf(MOD_SKILL_ENEMY_RATE/10);
		sld.MultiShooter = 1.0+stf(MOD_SKILL_ENEMY_RATE/10);
	}
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	sld.money = 10400;
	RemoveItems(sld, "potion2", GetCharacterItem(sld, "potion2"));
	RemoveItems(sld, "potion3", GetCharacterItem(sld, "potion3"));
	TakeNItems(sld, "potion2", makeint(MOD_SKILL_ENEMY_RATE/2));
	TakeNItems(sld, "potion3", 2);
	TakeNItems(sld, "totem_12", 1);
	TakeNItems(sld, "indian_1", 1);
	TakeNItems(sld, "amulet_1", 1);
	for (int i=1; i<=4; i++)
	{
		if (i < 4)
		{
			sld = GetCharacter(NPC_GenerateCharacter("Jeffry_PirateDung_"+i, "citiz_4"+(i+4), "man", "man", iRank, PIRATE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, LinkRandPhrase("blade_04","blade_10","blade_13"), "pistol1", "bullet", iScl*2+30);
			if (MOD_SKILL_ENEMY_RATE > 4) sld.cirassId = Items_FindItemIdx("cirass2");
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Jeffry_PirateDung_"+i, "mush_ctz_9", "man", "mushketer", iRank, PIRATE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl+5, iScl+5, "", "mushket2", "cartridge", iScl*3);
			LAi_SetCharacterUseBullet(sld, "cartridge");
			sld.cirassId = Items_FindItemIdx("cirass1");
			sld.SaveItemsForDead = true;
			sld.DontClearDead = true;
		}
		ChangeCharacterAddressGroup(sld, "Judgement_dungeon_03", "quest", "quest1");
		LAi_SetStayType(sld);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_CharacterDisableDialog(sld);
		if (MOD_SKILL_ENEMY_RATE > 4)
		{
			sld.MultiFighter = 1.0+stf(MOD_SKILL_ENEMY_RATE/20);
			sld.MultiShooter = 1.0+stf(MOD_SKILL_ENEMY_RATE/20);
		}
	}
}

void Mtraxx_RetributionWithJeffry(string qName) // вместе с Джеффри к сокровищам
{
	LAi_LocationFightDisable(&Locations[FindLocation("Judgement_dungeon_03")], false);
	chrDisableReloadToLocation = false;
	sld = characterFromId("Jeffry");
	LAi_SetActorType(sld);
	LAi_ActorFollowEverywhere(sld, "", -1);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	for (int i=1; i<=4; i++)
	{
		sld = characterFromId("Jeffry_PirateDung_"+i);
		LAi_SetActorType(sld);
		LAi_ActorFollowEverywhere(sld, "", -1);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	pchar.quest.mtraxx_retribution_jeffry.win_condition.l1 = "locator";
	pchar.quest.mtraxx_retribution_jeffry.win_condition.l1.location = "Judgement_dungeon_05";
	pchar.quest.mtraxx_retribution_jeffry.win_condition.l1.locator_group = "quest";
	pchar.quest.mtraxx_retribution_jeffry.win_condition.l1.locator = "quest4";
	pchar.quest.mtraxx_retribution_jeffry.function = "Mtraxx_RetributionJeffryTreasure";
}

void Mtraxx_RetributionJeffryTreasure(string qName) // вместе с Джеффри у сокровищ
{
	InterfaceStates.Buttons.Save.enable = false; // правки релиза
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "monster", "monster3");
	sld = characterFromId("Jeffry");
	sld.dialog.currentnode = "Jeffry_32";
	LAi_SetActorType(sld);
	LAi_ActorGoToLocator(sld, "quest", "pelly", "Mtraxx_RetributionJeffryTreasure", -1);
	sld = characterFromId("Jeffry_PirateDung_4");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocator(sld, "quest", "quest2", "", 10);
	for (int i=1; i<=3; i++)
	{
		sld = characterFromId("Jeffry_PirateDung_"+i);
		LAi_SetActorType(sld);
		LAi_ActorRunToLocator(sld, "monsters", "monster"+(i+16), "", 10);
	}
}

void Mtraxx_RetributionJeffryFight(string qName) // бой с Джеффри
{
	chrDisableReloadToLocation = true;
	LAi_group_Delete("EnemyFight");
	sld = characterFromId("Jeffry");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	for (int i=1; i<=4; i++)
	{
		sld = characterFromId("Jeffry_PirateDung_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Mtraxx_RetributionJeffryAfterFight");
	LAi_SetFightMode(pchar, true);
	InterfaceStates.Buttons.Save.enable = true; // правки релиза
}

void Mtraxx_RetributionMushketers(string qName) // ставим 2 мушкетеров в шахте №3
{
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+3;
	int iScl = 30 + 2*sti(pchar.rank);
	chrDisableReloadToLocation = true;
	LAi_group_Delete("EnemyFight");
	for (int i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Mushketer1_PirateDung_"+i, "mush_ctz_"+(6+i), "man", "mushketer", iRank, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*3);
		LAi_SetCharacterUseBullet(sld, "cartridge");
		sld.MusketerDistance = 0;
		if (MOD_SKILL_ENEMY_RATE > 4) sld.cirassId = Items_FindItemIdx("cirass1");
		ChangeCharacterAddressGroup(sld, "Judgement_dungeon_04", "quest", "mushketer"+i);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Mtraxx_RetributionMushAfterFight");
}

void Mtraxx_RetributionNextMushketers(string qName) // ставим 2 мушкетеров в шахте №2
{
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+3;
	int iScl = 30 + 2*sti(pchar.rank);
	chrDisableReloadToLocation = true;
	LAi_group_Delete("EnemyFight");
	for (int i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Mushketer2_PirateDung_"+i, "mush_ctz_"+i, "man", "mushketer", iRank, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket1", "cartridge", iScl*3);
		LAi_SetCharacterUseBullet(sld, "cartridge");
		sld.MusketerDistance = 0;
		if (MOD_SKILL_ENEMY_RATE > 4) sld.cirassId = Items_FindItemIdx("cirass1");
		ChangeCharacterAddressGroup(sld, "Judgement_dungeon_03", "quest", "mushketer"+i);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Mtraxx_RetributionNextMushAfterFight");
}

void Mtraxx_RetributionLastMushketers(string qName) // ставим 2 мушкетеров в шахте №1
{
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+5;
	int iScl = 35 + 2*sti(pchar.rank);
	chrDisableReloadToLocation = true;
	LAi_group_Delete("EnemyFight");
	for (int i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Mushketer3_PirateDung_"+i, "mush_ctz_"+i, "man", "mushketer", iRank, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, "", "mushket2", "cartridge", iScl*3);
		LAi_SetCharacterUseBullet(sld, "cartridge");
		sld.MusketerDistance = 0;
		if (MOD_SKILL_ENEMY_RATE > 2) sld.cirassId = Items_FindItemIdx("cirass1");
		ChangeCharacterAddressGroup(sld, "Judgement_dungeon_02", "quest", "mushketer"+i);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Mtraxx_RetributionLastMushAfterFight");
}

void Mtraxx_RetributionSetLepricon(string qName) // ставим Леприкона // прогона 3
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	LAi_LocationFightDisable(&Locations[FindLocation("Judgement_dungeon_01")], true);//запретить драться
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+5;
	int iScl = 30 + 2*sti(pchar.rank);
	sld = characterFromId("Lepricon");
	sld.dialog.currentnode = "lepricon_13";
	LAi_CharacterEnableDialog(sld);
	LAi_SetImmortal(sld, false);
	LAi_RemoveCheckMinHP(sld); // Addon 2016-1 Jason пиратская линейка 1
	LAi_SetCurHPMax(sld);
	ChangeCharacterAddressGroup(sld, "Judgement_dungeon_01", "quest", "lepricon");
	LAi_SetGuardianType(sld);
	sld.protector = true;
	sld.protector.CheckAlways = 1;//всегда проверять
	sld.viper = true;
	if (MOD_SKILL_ENEMY_RATE > 2)
	{
		sld.MultiFighter = 1.0+stf(MOD_SKILL_ENEMY_RATE/10);
		sld.MultiShooter = 1.0+stf(MOD_SKILL_ENEMY_RATE/10);
	}
	sld.SaveItemsForDead = true;
	sld.DontClearDead = true;
	sld.money = 2900;
	RemoveItems(sld, "potion2", GetCharacterItem(sld, "potion2"));
	RemoveItems(sld, "potion3", GetCharacterItem(sld, "potion3"));
	TakeNItems(sld, "potion2", makeint(MOD_SKILL_ENEMY_RATE/2));
	TakeNItems(sld, "potion3", 2);
	if (MOD_SKILL_ENEMY_RATE > 4) TakeNItems(sld, "potion4", 2);
	TakeNItems(sld, "purse3", 1);
	TakeNItems(sld, "map_beliz", 1);
	TakeNItems(sld, "cannabis7", 3);
	TakeNItems(sld, "indian_poison", 1); // яд таино
	for (int i=5; i<=8; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Lepricon_PirateDung_"+i, "mercen_"+i, "man", "man", iRank, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, LinkRandPhrase("topor_04","blade_04","topor_02"), "pistol3", "grapeshot", iScl*3);
		if (MOD_SKILL_ENEMY_RATE > 2) sld.cirassId = Items_FindItemIdx("cirass2");
		ChangeCharacterAddressGroup(sld, "Judgement_dungeon_01", "quest", "quest"+i);
		LAi_SetStayType(sld);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		LAi_CharacterDisableDialog(sld);
		if (MOD_SKILL_ENEMY_RATE > 4)
		{
			sld.MultiFighter = 1.0+stf(MOD_SKILL_ENEMY_RATE/20);
			sld.MultiShooter = 1.0+stf(MOD_SKILL_ENEMY_RATE/20);
		}
		if (MOD_SKILL_ENEMY_RATE > 6) sld.viper = true;
	}
}

void Mtraxx_RetributionLepriconFight() // бой с Леприконом
{
	LAi_LocationFightDisable(&Locations[FindLocation("Judgement_dungeon_01")], false);
	chrDisableReloadToLocation = true;
	LAi_group_Delete("EnemyFight");
	sld = characterFromId("Lepricon");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	for (int i=5; i<=8; i++)
	{
		sld = characterFromId("Lepricon_PirateDung_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Mtraxx_RetributionLepriconAfterFight");
	LAi_SetFightMode(pchar, true);
}

void Mtraxx_RetributionExitClosed(string qName) // выход закрыт
{
	PlaySound("interface\Door_Kick.wav");
	DoQuestCheckDelay("TalkSelf_Quest", 0.5);
}

void Mtraxx_RetributionRunToEnrico() // бежим на встречу к Энрико
{
	LAi_SetActorType(pchar);
	LAi_ActorRunToLocator(pchar, "quest", "enrico", "Mtraxx_RetributionCreateEnrico", -1);
}

void Mtraxx_RetributionEnricoGo() // Энрико уходит
{
	LAi_SetActorType(pchar);
	sld = characterFromId("Zorro");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "monsters", "monster5", "none", "", "", "Mtraxx_RetributionEnricoGo", 10.0);
}

void Mtraxx_RetributionTwoHoursTime(string qName) // перемотка времени по 2 часа
{
	WaitDate("", 0, 0, 0, 2, rand(30)); //крутим время
	LaunchFrameForm();
	RefreshLandTime();
	RecalculateJumpTable();
	Whr_UpdateWeather();
}

void Mtraxx_RetributionInChurchRuins(string qName) // пришел в разрушенную церковь
{
	chrDisableReloadToLocation = true;
	DoQuestFunctionDelay("Mtraxx_RetributionChurchLock", 7.0);
}

void Mtraxx_RetributionChurchLock(string qName) // скриптовая сцена закрытых дверей
{
	LAi_SetActorType(pchar);
	LAi_ActorGoToLocator(pchar, "quest", "LLquest2", "Mtraxx_RetributionChurchLock", -1);
}

void Mtraxx_RetributionBead(string qName) // молитва 
{
	LAi_SetActorType(pchar);
	LAi_ActorGoToLocator(pchar, "quest", "LLquest9", "Mtraxx_RetributionBead", -1);
}

void Mtraxx_RetributionSleep(string qName) // заснул - снится Мерида 
{
	int n = Findlocation("Merida_town");
	locations[n].alwaysStorm = true;
	locations[n].Storm = true;
	LAi_LocationDisableOfficersGen("Merida_town", true);
	DoQuestReloadToLocation("Merida_town", "quest", "stay1", "Mtraxx_RetributionSleep");
}

void Mtraxx_RetributionSetMusic(string qName) // 
{
	ResetSound();
	SetMusic("music_lyric");
	PlaySound("ambient\church\zvon.wav");
	ChangeShowIntarface();
}

void Mtraxx_RetributionSleepSkeletons() // кошмарики
{
	sld = characterFromId("Sleep_Jeffry");
	sld.model = "skel4";
	Characters_RefreshModel(sld);
	sld = characterFromId("Sleep_Pelly");
	sld.model = "skel1";
	Characters_RefreshModel(sld);
	sld = characterFromId("Sleep_Lepricon");
	sld.model = "skel2";
	Characters_RefreshModel(sld);
}

void Mtraxx_RetributionLocatorRadius() // раздвигаем локатор 
{
	int n = Findlocation("Judgement_church");
	locations[n].locators_radius.reload.reload2_back = 2.0;
	AddQuestRecord("Roger_10", "13");
	pchar.quest.mtraxx_retribution_tohell.win_condition.l1 = "locator";
	pchar.quest.mtraxx_retribution_tohell.win_condition.l1.location = "Judgement_church";
	pchar.quest.mtraxx_retribution_tohell.win_condition.l1.locator_group = "reload";
	pchar.quest.mtraxx_retribution_tohell.win_condition.l1.locator = "reload2_back";
	pchar.quest.mtraxx_retribution_tohell.function = "Mtraxx_RetributionGotoHell";
}

void Mtraxx_RetributionGotoHell(string qName) // можно идти 
{
	RemoveItems(pchar, "key_ruins", 1);
	PlaySound("interface\key.wav");
	pchar.quest.mtraxx_retribution_hell.win_condition.l1 = "locator";
	pchar.quest.mtraxx_retribution_hell.win_condition.l1.location = "Judgement_dungeon_09";
	pchar.quest.mtraxx_retribution_hell.win_condition.l1.locator_group = "item";
	pchar.quest.mtraxx_retribution_hell.win_condition.l1.locator = "detector1";
	pchar.quest.mtraxx_retribution_hell.function = "Mtraxx_RetributionInHell";
	pchar.quest.mtraxx_retribution_incave.win_condition.l1 = "location";
	pchar.quest.mtraxx_retribution_incave.win_condition.l1.location = "Carataska_Cave";
	pchar.quest.mtraxx_retribution_incave.function = "Mtraxx_RetributionHellEscape";
}

void Mtraxx_RetributionInHell(string qName) // в адских туннелях
{
	LAi_SetActorType(pchar);
	PlaySound("ambient\land\cough_01.wav");
	LAi_ActorAnimation(pchar, "recoil", "pchar_back_to_player", 3.0);
	AddQuestRecord("Roger_10", "14");
}

void Mtraxx_RetributionHellHotWater(string qName) // горячая вода
{
	if (!CheckAttribute(pchar, "GenQuest.Hotwater")) return;
	if (pchar.location == "Judgement_dungeon_10") LAi_ApplyCharacterDamage(pchar, 4, "other");
	else LAi_ApplyCharacterDamage(pchar, 2, "other");
	LAi_CheckKillCharacter(pchar);
	DoQuestFunctionDelay("Mtraxx_RetributionHellHotWaterPause", 0.5);
}

void Mtraxx_RetributionHellHotWaterPause(string qName) // горячая вода
{
	DoQuestFunctionDelay("Mtraxx_RetributionHellHotWater", 0.5);
}

void Mtraxx_RetributionHellSplash(string qName) // гейзеры
{
	if (pchar.location != "Judgement_dungeon_09") return;
	// выбираем группу из 10 локаторов, где одновременно произойдет всплеск
	int n = rand(9)+1;
	int m = rand(9)+11;
	int k = rand(9)+21;
	int l = rand(9)+31;
	int p = rand(9)+41;
	int r = rand(9)+51;
	int s = rand(9)+61;
	int t = rand(9)+71;
	int u = rand(9)+81;
	int v = rand(9)+91;
	string locator1 = "splash"+n;
	string locator2 = "splash"+m;
	string locator3 = "splash"+k;
	string locator4 = "splash"+l;
	string locator5 = "splash"+p;
	string locator6 = "splash"+r;
	string locator7 = "splash"+s;
	string locator8 = "splash"+t;
	string locator9 = "splash"+u;
	string locator10 = "splash"+v;
	pchar.questTemp.Mtraxx.HellSplash.l1 = n;
	pchar.questTemp.Mtraxx.HellSplash.l2 = m;
	pchar.questTemp.Mtraxx.HellSplash.l3 = k;
	pchar.questTemp.Mtraxx.HellSplash.l4 = l;
	pchar.questTemp.Mtraxx.HellSplash.l5 = p;
	pchar.questTemp.Mtraxx.HellSplash.l6 = r;
	pchar.questTemp.Mtraxx.HellSplash.l7 = s;
	pchar.questTemp.Mtraxx.HellSplash.l8 = t;
	pchar.questTemp.Mtraxx.HellSplash.l9 = u;
	pchar.questTemp.Mtraxx.HellSplash.l10 = v;
	CreateLocationParticles("splash", "item", locator1, 1, 0, 0, "jump_water");
	CreateLocationParticles("splash", "item", locator2, 1, 0, 0, "jump_water");
	CreateLocationParticles("splash", "item", locator3, 1, 0, 0, "jump_water");
	CreateLocationParticles("splash", "item", locator4, 1, 0, 0, "jump_water");
	CreateLocationParticles("splash", "item", locator5, 1, 0, 0, "jump_water");
	CreateLocationParticles("splash", "item", locator6, 1, 0, 0, "jump_water");
	CreateLocationParticles("splash", "item", locator7, 1, 0, 0, "jump_water");
	CreateLocationParticles("splash", "item", locator8, 1, 0, 0, "jump_water");
	CreateLocationParticles("splash", "item", locator9, 1, 0, 0, "jump_water");
	CreateLocationParticles("splash", "item", locator10, 1, 0, 0, "jump_water");
	DoQuestFunctionDelay("Mtraxx_RetributionHellSplashPause", 1.3);
}

void Mtraxx_RetributionHellSplashPause(string qName)
{
	DeleteAttribute(pchar, "questTemp.Mtraxx.HellSplash");
	DoQuestFunctionDelay("Mtraxx_RetributionHellSplash", 0.2);
}

void Mtraxx_RetributionHellSplashReaction() // реакция на гейзер
{
	int n = 80+MOD_SKILL_ENEMY_RATE*7;
	if (pchar.location == "Judgement_dungeon_09") 
	{
		LAi_SetActorType(pchar);
		LAi_ActorAnimation(pchar, "hit_fire", "pchar_back_to_player", 1.8);
	}
	AddCharacterHealth(pchar, -3);
	PlaySound("People\hotwater2.wav");
	LAi_ApplyCharacterDamage(pchar, n, "other");
	LAi_CheckKillCharacter(pchar);
}

void Mtraxx_RetributionHellCough(string qName) // кашляет
{
	if (pchar.location != "Judgement_dungeon_09") return;
	if (!CheckAttribute(pchar, "GenQuest.Hotwater")) return;
	LAi_SetActorType(pchar);
	LAi_ActorAnimation(pchar, "recoil", "pchar_back_to_player", 3.0);
	int i = rand(3)+1;
	PlaySound("ambient\land\cough_0"+i+".wav");
	LAi_ApplyCharacterDamage(pchar, 5, "other");
	LAi_CheckKillCharacter(pchar);	
	DoQuestFunctionDelay("Mtraxx_RetributionHellCoughPause", 4);
}

void Mtraxx_RetributionHellCoughPause(string qName)
{
	int n = rand(4)+1;
	DoQuestFunctionDelay("Mtraxx_RetributionHellCough", n);
}
// гейзеры в подземелье-10, 7 шт
void Mtraxx_RetributionHellSplash1(string qName) // гейзер-1
{
	if (pchar.location != "Judgement_dungeon_10") return;
	pchar.questTemp.Mtraxx.Hell1Splash.l1 = "true";
	CreateLocationParticles("splash", "item", "splash1_2", 1.1, 0, 0, "jump_water");
	DoQuestFunctionDelay("Mtraxx_RetributionHellSplash1Pause", 1.0);
}

void Mtraxx_RetributionHellSplash1Pause(string qName) // 
{
	DeleteAttribute(pchar, "questTemp.Mtraxx.Hell1Splash.l1");
	DoQuestFunctionDelay("Mtraxx_RetributionHellSplash1", 4.0);
}

void Mtraxx_RetributionHellSplash2(string qName) // гейзер-2
{
	if (pchar.location != "Judgement_dungeon_10") return;
	pchar.questTemp.Mtraxx.Hell1Splash.l2 = "true";
	CreateLocationParticles("splash", "item", "splash2_2", 1.1, 0, 0, "jump_water");
	DoQuestFunctionDelay("Mtraxx_RetributionHellSplash2Pause", 1.0);
}

void Mtraxx_RetributionHellSplash2Pause(string qName) // 
{
	DeleteAttribute(pchar, "questTemp.Mtraxx.Hell1Splash.l2");
	DoQuestFunctionDelay("Mtraxx_RetributionHellSplash2", 3.0);
}

void Mtraxx_RetributionHellSplash3(string qName) // гейзер-3
{
	if (pchar.location != "Judgement_dungeon_10") return;
	pchar.questTemp.Mtraxx.Hell1Splash.l3 = "true";
	CreateLocationParticles("splash", "item", "splash3_2", 1.1, 0, 0, "jump_water");
	DoQuestFunctionDelay("Mtraxx_RetributionHellSplash3Pause", 1.0);
}

void Mtraxx_RetributionHellSplash3Pause(string qName) // 
{
	int n = 2 + rand(2);
	DeleteAttribute(pchar, "questTemp.Mtraxx.Hell1Splash.l3");
	DoQuestFunctionDelay("Mtraxx_RetributionHellSplash3", n);
}

void Mtraxx_RetributionHellSplash4(string qName) // гейзер-4
{
	if (pchar.location != "Judgement_dungeon_10") return;
	pchar.questTemp.Mtraxx.Hell1Splash.l4 = "true";
	CreateLocationParticles("splash", "item", "splash4_2", 1.1, 0, 0, "jump_water");
	DoQuestFunctionDelay("Mtraxx_RetributionHellSplash4Pause", 1.0);
}

void Mtraxx_RetributionHellSplash4Pause(string qName) // 
{
	int n = 3+rand(1);
	if (rand(4) == 0) n = 1;
	DeleteAttribute(pchar, "questTemp.Mtraxx.Hell1Splash.l4");
	DoQuestFunctionDelay("Mtraxx_RetributionHellSplash4", n);
}

void Mtraxx_RetributionHellSplash5(string qName) // гейзер-5
{
	if (pchar.location != "Judgement_dungeon_10") return;
	pchar.questTemp.Mtraxx.Hell1Splash.l5 = "true";
	CreateLocationParticles("splash", "item", "splash5_2", 1.1, 0, 0, "jump_water");
	DoQuestFunctionDelay("Mtraxx_RetributionHellSplash5Pause", 1.0);
}

void Mtraxx_RetributionHellSplash5Pause(string qName) // 
{
	int n = 1;
	if (rand(5) == 0) n = 5;
	DeleteAttribute(pchar, "questTemp.Mtraxx.Hell1Splash.l5");
	DoQuestFunctionDelay("Mtraxx_RetributionHellSplash5", n);
}

void Mtraxx_RetributionHellSplash6(string qName) // гейзер-6
{
	if (pchar.location != "Judgement_dungeon_10") return;
	int n = 2+rand(2);
	if (rand(3) == 0) n = 1;
	DeleteAttribute(pchar, "questTemp.Mtraxx.Hell1Splash.l7");
	pchar.questTemp.Mtraxx.Hell1Splash.l6 = "true";
	CreateLocationParticles("splash", "item", "splash6", 1.1, 0, 0, "jump_water");
	DoQuestFunctionDelay("Mtraxx_RetributionHellSplash7", n);
}

void Mtraxx_RetributionHellSplash7(string qName) // гейзер-7
{
	if (pchar.location != "Judgement_dungeon_10") return;
	int n = 2+rand(2);
	if (rand(3) == 1) n = 1;
	DeleteAttribute(pchar, "questTemp.Mtraxx.Hell1Splash.l6");
	pchar.questTemp.Mtraxx.Hell1Splash.l7 = "true";
	CreateLocationParticles("splash", "item", "splash7", 1.1, 0, 0, "jump_water");
	DoQuestFunctionDelay("Mtraxx_RetributionHellSplash6", n);
}

void Mtraxx_RetributionHellSplashStatic(string qName) // статичные гейзеры
{
	if (pchar.location != "Judgement_dungeon_10") return;
	for (int i=1; i<=8; i++) 
	{
		CreateLocationParticles("splash", "item", "fontain"+i, 1.1, 0, 0, "fountsml");
	}
	DoQuestFunctionDelay("Mtraxx_RetributionHellSplashStaticPause", 0.5);
}

void Mtraxx_RetributionHellSplashStaticPause(string qName) // статичные гейзеры
{
	if (pchar.location != "Judgement_dungeon_10") return;
	for (int i=1; i<=8; i++) 
	{
		CreateLocationParticles("splash", "item", "fontain"+i, 1.1, 0, 0, "");
	}
	DoQuestFunctionDelay("Mtraxx_RetributionHellSplashStatic", 0.5);
}

void Mtraxx_RetributionHellEscape(string qName) // выплыл в пещеру
{
	DeleteAttribute(pchar, "GenQuest.Hotwater");
	AddCharacterHealth(pchar, -5);
	AddQuestRecord("Roger_10", "15");
	pchar.quest.mtraxx_retribution_shore.win_condition.l1 = "location";
	pchar.quest.mtraxx_retribution_shore.win_condition.l1.location = "Carataska_jungle_01";
	pchar.quest.mtraxx_retribution_shore.function = "Mtraxx_RetributionJungle";
}

void Mtraxx_RetributionJungle(string qName) // в джунглях
{
	AddQuestRecord("Roger_10", "16");
	pchar.quest.mtraxx_retribution_freedom.win_condition.l1 = "location";
	pchar.quest.mtraxx_retribution_freedom.win_condition.l1.location = "shore10";
	pchar.quest.mtraxx_retribution_freedom.function = "Mtraxx_RetributionFreedom";
}

void Mtraxx_RetributionFreedom(string qName) // вернулся в бухту - свобода!
{
	if(!GetDLCenabled(DLC_APPID_3)) return;
	pchar.GenQuest.Hunter2Pause = true; // прогона 3
	DoQuestFunctionDelay("Mtraxx_RetributionSetMusic", 1.2);
	LAi_SetActorType(pchar);
	LAi_ActorGoToLocator(pchar, "goto", "goto1", "Mtraxx_RetributionFreedom", -1);
	pchar.questTemp.Mtraxx.Retribution = "freedom";
	pchar.questTemp.Mtraxx.Retribution.Freedom = "true";
}

void Mtraxx_RetributionComplete(string qName) // линейка пройдена полностью // 3 прогона
{
	DeleteAttribute(pchar, "GenQuest.HunterLongPause");
	CloseQuestHeader("Roger_10");
	pchar.questTemp.Mtraxx = "full_complete";
	AddCharacterHealth(pchar, -20);
	LAi_LocationDisableOfficersGen("Ruins", false);//офицеров пускать
	LAi_LocationDisableOfficersGen("Carataska_jungle_03", false);
	LAi_LocationDisableOfficersGen("Carataska_jungle_02", false);
	LAi_LocationDisableOfficersGen("Carataska_Cave", false);
	LAi_LocationDisableOfficersGen("Carataska_CaveEntrance", false);
	LAi_LocationDisableOfficersGen("Carataska_jungle_01", false);
	LAi_LocationDisableOfficersGen("Shore10", false);
	// Тиракса в резиденцию
	LocatorReloadEnterDisable("LaVega_town", "reload6", false);
	sld = CharacterFromID("Terrax");
	sld.location = "LaVega_townhall";
	sld.location.group = "sit";
	sld.location.locator = "sit1";
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "PIRATE_CITIZENS");
	sld.dialog.currentnode = "First time";
	sld.Ship.Type = SHIP_NOTUSED;
	LAi_SetImmortal(sld, true);
	// капеллан - второй шанс
	if (CheckAttribute(pchar, "questTemp.ShipCapellan") && !CheckAttribute(pchar, "questTemp.ShipCapellan.Yes"))
	{
		DeleteAttribute(pchar, "questTemp.ShipCapellan");
	}
}

/// Jason ----------------------------------------------------------- На службе Отечеству ------------------------------------------------------------------
// ---------------------------------------------------------- задание 1 ---------------------------------------------------------------
void Patria_SetInspector() // ставим инспектора
{
	sld = GetCharacter(NPC_GenerateCharacter("Noel", "Boss_1", "man", "man", 25, FRANCE, -1, false, "officer"));
	FantomMakeCoolFighter(sld, 25, 80, 80, "blade_17", "pistol5", "bullet", 120);
	sld.Dialog.Filename = "Quest\Patria_NPC.c";
	sld.dialog.currentnode = "noel";
	sld.name = "Noel";
	sld.lastname = "Forget";
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto4");
	LAi_SetActorType(sld);
}

void Patria_SetEcliaton() // ставим Эклятон
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	// письмо
	GiveItem2Character(pchar, "Reserve_item_01");
	ref itm = ItemsFromID("Reserve_item_01");
	itm.picIndex = 11;
	itm.picTexture = "ITEMS_34";
	itm.price = 0;
	itm.Weight = 0.1;
	// Эклятон
	sld = GetCharacter(NPC_GenerateCharacter("Ecliaton_Cap", "Off_Fra_Z", "man", "man", 40, FRANCE, -1, true, "officer"));
	sld.Ship.Type = GenerateShipHand(sld, SHIP_LSHIP_FRA, 42, 9000, 700, 9900, 250000, 14.5, 32.5, 0.4);
	sld.Ship.name = "Eclatant";
	SetBaseShipData(sld);
	sld.Ship.Cannons.Type = CANNON_TYPE_CULVERINE_LBS36;
	FantomMakeCoolFighter(sld, 40, 100, 100, "blade_17", "pistol4", "bullet", 250);
	sld.name = "Uber";
	sld.lastname = "Dassen";
	sld.Dialog.Filename = "Quest\Patria_NPC.c";
	sld.DeckDialogNode = "ecliaton_cap";
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.reputation = 80;
	sld.alignment = "good";
	SetSelfSkill(sld, 100, 90, 80, 100, 90);
	SetShipSkill(sld, 95, 100, 100, 100, 100, 100, 100, 100, 70);
	SetCharacterPerk(sld, "MusketsShoot");
	SetCharacterPerk(sld, "Troopers");
	SetCharacterPerk(sld, "LongRangeGrappling");
	SetCharacterPerk(sld, "GrapplingProfessional");
	SetCharacterPerk(sld, "HullDamageUp");
	SetCharacterPerk(sld, "SailsDamageUp");
	SetCharacterPerk(sld, "CrewDamageUp");
	SetCharacterPerk(sld, "CriticalShoot");
	SetCharacterPerk(sld, "LongRangeShoot");
	SetCharacterPerk(sld, "FastReload");
	SetCharacterPerk(sld, "CannonProfessional");
	SetCharacterPerk(sld, "BasicBattleState");
	SetCharacterPerk(sld, "AdvancedBattleState");
	SetCharacterPerk(sld, "ShipDefenseProfessional");
	SetCharacterPerk(sld, "Carpenter");
	SetCharacterPerk(sld, "Builder");
	SetCharacterPerk(sld, "ShipSpeedUp");
	SetCharacterPerk(sld, "ShipTurnRateUp");
	SetCharacterPerk(sld, "StormProfessional");
	SetCharacterPerk(sld, "WindCatcher");
	SetCharacterPerk(sld, "SailsMan");
	SetCharacterPerk(sld, "SailingProfessional");
	SetCharacterPerk(sld, "Doctor1");
	SetCharacterPerk(sld, "Doctor2");
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.AlwaysSandbankManeuver = true;
	Character_SetAbordageEnable(sld, false); // нельзя абордировать
	sld.Tasks.CanBoarding = false; // запрет идти на абордаж - дубль
	sld.Tasks.CanChangeShipAfterBoarding = false; // запрет меняться кораблями - дубль
	sld.Abordage.Enable = false;
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true; 
	sld.SeaBoss = 0.5; // получает на 50% меньше урона корпусу
	RealShips[sti(sld.Ship.Type)].ship.upgrades.hull = 1;
	UpgradeShipParameter(sld, "SpeedRate");//апгрейдить скорость
	UpgradeShipParameter(sld, "TurnRate");//маневренность
	sld.Ship.Mode = "war";
	SetCrewQuantityFull(sld);
	sld.ship.Crew.Morale = 100;
	sld.Ship.Crew.Exp.Sailors = 100;
	sld.Ship.Crew.Exp.Cannoners = 100;
	sld.Ship.Crew.Exp.Soldiers = 100;
	SetCharacterGoods(sld, GOOD_BALLS, 6000);
	SetCharacterGoods(sld, GOOD_GRAPES, 2000);
	SetCharacterGoods(sld, GOOD_KNIPPELS, 2000);
	SetCharacterGoods(sld, GOOD_BOMBS, 5000);
	SetCharacterGoods(sld, GOOD_FOOD, 4000);
	SetCharacterGoods(sld, GOOD_POWDER, 12000);
	SetCharacterGoods(sld, GOOD_WEAPON, 900);
	SetCharacterGoods(sld, GOOD_MEDICAMENT, 900);
	SetCharacterGoods(sld, GOOD_RUM, 200);
	SetCharacterGoods(sld, GOOD_PLANKS, 100);
	SetCharacterGoods(sld, GOOD_SAILCLOTH, 100);
	Group_AddCharacter("Ecliaton_group", "Ecliaton_Cap");
	Group_SetGroupCommander("Ecliaton_group", "Ecliaton_Cap");
	Group_SetAddress("Ecliaton_group", "Nevis", "quest_ships", "quest_ship_1");
	Group_SetTaskNone("Ecliaton_group");
	Group_LockTask("Ecliaton_group");
	// закрыть выход в море
	bQuestDisableMapEnter = true;
	pchar.GenQuest.MapClosedNoBattle = true; 
}

void Patria_AddEcliaton() // присоединяем Эклятон
{
	sld = characterFromId("Ecliaton_Cap");
	SetCharacterRemovable(sld, false);
	sld.CompanionEnemyEnable = false; //всегда друзья
	SetCompanionIndex(pchar, -1, sti(sld.index));
	sld.loyality = MAX_LOYALITY;
	SetFunctionTimerCondition("Patria_SanJoseOver", 0, 0, 30, false); // таймер
	AddQuestRecord("Patria", "2");
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	pchar.quest.Patria_SanJoseAttack.win_condition.l1 = "location";
	pchar.quest.Patria_SanJoseAttack.win_condition.l1.location = "Trinidad";
	pchar.quest.Patria_SanJoseAttack.function = "Patria_SanJoseAttack";
	int i = FindColony("PortSpein");
	colonies[i].DontSetShipInPort = true;
	pchar.questTemp.Patria.Ecliaton = "true";
	// прерывание на потерю Эклятона
	pchar.quest.Patria_EcliatonFail.win_condition.l1 = "NPC_Death";
	pchar.quest.Patria_EcliatonFail.win_condition.l1.character = "Ecliaton_Cap";
	pchar.quest.Patria_EcliatonFail.function = "Patria_EcliatonFail";
	// удаление группы Эклятона, иначе клон-призрак
	pchar.quest.Patria_EcliatonDelGroup.win_condition.l1 = "ExitFromSea";
	pchar.quest.Patria_EcliatonDelGroup.function = "Patria_EcliatonDelGroup";
}

void Patria_EcliatonDelGroup(string qName) // 
{
	Group_DeleteGroup("Ecliaton_group");
}

void Patria_EcliatonFail(string qName) // потеря Эклятона
{
	AddQuestRecord("Patria", "2_1");
	DeleteAttribute(pchar, "questTemp.Patria.Ecliaton");
	pchar.questTemp.Patria.Ecliaton_Fail = "true";
}

void Patria_SanJoseOver(string qName) // потратили месяц
{
	pchar.quest.Patria_SanJoseAttack.over = "yes";
	if (GetCharacterIndex("Ecliaton_Cap") != -1)
	{
		pchar.quest.Patria_EcliatonFail.over = "yes"; //снять прерывание
		sld = characterFromId("Ecliaton_Cap");
		sld.ShipHideImmortal = 1000; // непотопляемый корабль
		RemoveCharacterCompanion(pchar, sld);
		sld.DontDeskTalk = true;
		sld.lifeday = 0;
	}
	RemoveItems(pchar, "patent_fra", 1);
	ChangeCharacterComplexReputation(pchar, "nobility", -10);
	ChangeCharacterComplexReputation(pchar, "authority", -5);
	ChangeCharacterNationReputation(pchar, FRANCE, -10);
	pchar.questTemp.Patria = "fail";
	AddQuestRecord("Patria", "3");
	CloseQuestHeader("Patria");
	int i = FindColony("PortSpein");
	DeleteAttribute(colonies[i], "DontSetShipInPort");
	DeleteAttribute(pchar, "questTemp.Patria.Ecliaton");
}

void Patria_SanJoseAttack(string qName) // вышли у Тринидада
{
	pchar.quest.Patria_SanJoseOver.over = "yes"; // снять таймер
	AddQuestRecord("Patria", "4");
	bQuestDisableMapEnter = true;//закрыть карту
	Island_SetReloadEnableGlobal("Trinidad", false);//закрыть остров
	sld = CharacterFromID("PortSpein Fort Commander");
	Character_SetAbordageEnable(sld, false); // неабордируемый форт
	pchar.questTemp.Patria.SanJoseAttack = "true";
	if (pchar.nation != FRANCE) Flag_FRANCE();
	pchar.DisableChangeFlagMode = true; //закрываем Флаг
}

void Patria_SanJoseFortDestroyed() // форт Сан-Хосе разрушен
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	Log_Info("The Spanish has been given a note to send parleys to Trinidad's lighthouse to start negotiations!");
	Island_SetReloadEnableGlobal("Trinidad", true); //открыть остров
	pchar.GenQuest.MapClosedNoBattle = true;
	AddQuestRecord("Patria", "5");
	pchar.quest.Patria_SanJoseMayak.win_condition.l1 = "location";
	pchar.quest.Patria_SanJoseMayak.win_condition.l1.location = "Mayak1";
	pchar.quest.Patria_SanJoseMayak.function = "Patria_SanJoseMayak";
	pchar.GenQuest.Hunter2Pause = true;
}

void Patria_SanJoseMayak(string qName) // на маяке Тринидада
{
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation("Mayak1")], true);
	for (int i=1; i<=11; i++)
	{
		if (i > 8) // мушкетеры, 3 шт
		{
			sld = GetCharacter(NPC_GenerateCharacter("Patria_SanJoseSoldier_"+i, "mush_fra_"+(i-8), "man", "mushketer", 30, FRANCE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, 30, 80, 80, "", "mushket1", "cartridge", 150);
			LAi_SetCharacterUseBullet(sld, "cartridge");
		}
		else
		{
				sld = GetCharacter(NPC_GenerateCharacter("Patria_SanJoseSoldier_"+i, "sold_fra_"+i, "man", "man", 30, FRANCE, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, 30, 60, 60, LinkRandPhrase("blade_11","blade_12","blade_13"), "pistol1", "bullet", 150);
		}
		ChangeCharacterAddressGroup(sld, "Mayak1", "goto", "goto"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		LAi_CharacterDisableDialog(sld);
	}
	DoQuestFunctionDelay("Patria_SanJoseMayakSpanish", 5.0);
}

void Patria_SanJoseMayakSpanish() // пришли испанцы для переговоров
{
	for (int i=1; i<=4; i++)
	{
		if (i == 1) // офицер
		{
			sld = GetCharacter(NPC_GenerateCharacter("Patria_SanJoseSpanish_"+i, "off_spa_4", "man", "man", 30, SPAIN, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, 30, 60, 60, "blade_20", "pistol5", "bullet", 150);
			sld.Dialog.Filename = "Quest\Patria_NPC.c";
			sld.dialog.currentnode = "SanJoseSpanish";
		}
		else
		{
				sld = GetCharacter(NPC_GenerateCharacter("Patria_SanJoseSpanish_"+i, "sold_spa_"+i, "man", "man", 30, SPAIN, -1, false, "soldier"));
				FantomMakeCoolFighter(sld, 30, 60, 60, LinkRandPhrase("blade_11","blade_12","blade_13"), "pistol1", "bullet", 150);
				LAi_CharacterDisableDialog(sld);
		}
		LAi_SetImmortal(sld, true);
		ChangeCharacterAddressGroup(sld, "Mayak1", "reload", "reload1");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void Patria_SanJoseMayakSpanishGo() // испанцы уходят на сутки
{
	for (int i=1; i<=4; i++)
	{
		sld = CharacterFromID("Patria_SanJoseSpanish_"+i);
		LAi_SetActorType(sld);
		LAi_ActorRunToLocation(sld, "reload", "reload1", "none", "", "", "", 12.0);
	}
	DoQuestFunctionDelay("Patria_SanJoseMayakSpanishWait", 13.0);
}

void Patria_SanJoseMayakSpanishWait() // крутим сутки
{
	SetLaunchFrameFormParam("One day has passed...", "", 0, 5);
	LaunchFrameForm();
	WaitDate("", 0, 0, 1, 0, 10); //крутим время
	RecalculateJumpTable();
	StoreDayUpdate();
	RefreshWeather();
	RefreshLandTime();
	DoQuestFunctionDelay("Patria_SanJoseMayakSpanishReturn", 5.0);
	pchar.GenQuest.Hunter2Pause = true;
}

void Patria_SanJoseMayakSpanishReturn() // испанцы возвращаются
{
	LAi_Fade("", "");
	for (int i=1; i<=4; i++)
	{
		sld = CharacterFromID("Patria_SanJoseSpanish_"+i);
		ChangeCharacterAddressGroup(sld, "Mayak1", "reload", "reload1");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void Patria_SanJoseMayakSpanishFin() // получили выкуп, уходим
{
	for (int i=1; i<=4; i++)
	{
		sld = CharacterFromID("Patria_SanJoseSpanish_"+i);
		sld.lifeday = 0;
		LAi_SetActorType(sld);
		LAi_ActorRunToLocation(sld, "reload", "reload1", "none", "", "", "OpenTheDoors", 7.0);
	}
	for (i=1; i<=11; i++)
	{
		sld = CharacterFromID("Patria_SanJoseSoldier_"+i);
		sld.lifeday = 0;
	}
	AddQuestRecord("Patria", "6");
	DeleteAttribute(pchar, "DisableChangeFlagMode"); // открываем флаг
	pchar.questTemp.Patria = "epizode_1_return";
	SetFunctionTimerCondition("Patria_SanJoseReturnOver", 0, 0, 20, false); // таймер 20 дней на возврат
	SetFunctionTimerCondition("Patria_SanJoseNormal", 0, 0, 7, false); // возврат Сан-Хосе в норму
	LAi_LocationFightDisable(&Locations[FindLocation("Mayak1")], false);
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
}

void Patria_SanJoseNormal(string qName) // возврат Сан-Хосе в норму
{
	DeleteAttribute(pchar, "questTemp.Patria.SanJoseAttack");
	sld = CharacterFromID("PortSpein Fort Commander");
	Character_SetAbordageEnable(sld, true); 
	int i = FindColony("PortSpein");
	DeleteAttribute(colonies[i], "DontSetShipInPort");
}

void Patria_SanJoseReturnOver(string qName) // потратили месяц
{
	if (GetCharacterIndex("Ecliaton_Cap") != -1)
	{
		pchar.quest.Patria_EcliatonFail.over = "yes"; //снять прерывание
		sld = characterFromId("Ecliaton_Cap");
		sld.ShipHideImmortal = 1000; // непотопляемый корабль
		RemoveCharacterCompanion(pchar, sld);
		sld.DontDeskTalk = true;
		sld.lifeday = 0;
	}
	DeleteAttribute(pchar, "questTemp.Patria.Ecliaton");
	RemoveItems(pchar, "patent_fra", 1);
	ChangeCharacterComplexReputation(pchar, "nobility", -10);
	ChangeCharacterComplexReputation(pchar, "authority", -5);
	ChangeCharacterNationReputation(pchar, FRANCE, -10);
	pchar.questTemp.Patria = "fail";
	AddQuestRecord("Patria", "7");
	CloseQuestHeader("Patria");
	sld = characterFromId("Puancie");
	sld.dialog.currentnode = "First time";
}

// ---------------------------------------------------------- задание 2 ---------------------------------------------------------------
void Patria_VisiterBegin() // отсоединяем Эклятон, присоединяем инспектора
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	pchar.quest.Patria_EcliatonFail.over = "yes";
	chrDisableReloadToLocation = true;
	sld = characterFromId("Ecliaton_Cap");
	sld.ShipHideImmortal = 1000; // непотопляемый корабль
	RemoveCharacterCompanion(pchar, sld);
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true;
	Group_AddCharacter("Ecliaton_group", "Ecliaton_Cap");
	Group_SetGroupCommander("Ecliaton_group", "Ecliaton_Cap");
	Group_SetAddress("Ecliaton_group", "Nevis", "quest_ships", "quest_ship_1");
	Group_SetTaskNone("Ecliaton_group");
	Group_LockTask("Ecliaton_group");
	SetFunctionTimerCondition("Patria_EcliatonRepair", 0, 0, 5, false); // таймер на починку Эклятона
	DeleteAttribute(pchar, "questTemp.Patria.Ecliaton");
	sld = characterFromId("Noel");
	sld.dialog.currentnode = "noel_2";
	AddPassenger(pchar, sld, false);//добавить пассажира
	SetCharacterRemovable(sld, false);
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	SetFunctionTimerCondition("Patria_VisiterOver", 0, 0, 62, false); // таймер на все задание
	pchar.quest.Patria_visiter_tortuga.win_condition.l1 = "location";
	pchar.quest.Patria_visiter_tortuga.win_condition.l1.location = "Tortuga_townhall";
	pchar.quest.Patria_visiter_tortuga.function = "Patria_VisiterTortuga";
	pchar.quest.Patria_visiter_portpax.win_condition.l1 = "location";
	pchar.quest.Patria_visiter_portpax.win_condition.l1.location = "PortPax_townhall";
	pchar.quest.Patria_visiter_portpax.function = "Patria_VisiterPortPax";
}

void Patria_EcliatonRepair(string qName) // починка Эклятона
{
	sld = CharacterFromID("Ecliaton_Cap");
	DeleteAttribute(sld, "ship.sails");
    DeleteAttribute(sld, "ship.blots");
    DeleteAttribute(sld, "ship.masts");
	DeleteAttribute(sld, "ship.hulls");
	sld.ship.HP = 9900;
	SetCrewQuantityFull(sld);
	SetCharacterGoods(sld, GOOD_BALLS, 6000);
	SetCharacterGoods(sld, GOOD_GRAPES, 2000);
	SetCharacterGoods(sld, GOOD_KNIPPELS, 2000);
	SetCharacterGoods(sld, GOOD_BOMBS, 5000);
	SetCharacterGoods(sld, GOOD_FOOD, 4000);
	SetCharacterGoods(sld, GOOD_POWDER, 12000);
	SetCharacterGoods(sld, GOOD_WEAPON, 900);
	SetCharacterGoods(sld, GOOD_MEDICAMENT, 900);
	SetCharacterGoods(sld, GOOD_RUM, 200);
	SetCharacterGoods(sld, GOOD_PLANKS, 100);
	SetCharacterGoods(sld, GOOD_SAILCLOTH, 100);
	// чиним орудия
	ref shTo = &RealShips[sti(sld.Ship.Type)];
	ResetShipCannonsDamages(sld);
	shTo.Cannons = 66;
}

void Patria_VisiterOver(string qName) // провал по срокам
{
	pchar.quest.Patria_visiter_tortuga.over = "yes";
	pchar.quest.Patria_visiter_portpax.over = "yes";
	pchar.quest.Patria_visiter_delete.win_condition.l1 = "Location_Type";
	pchar.quest.Patria_visiter_delete.win_condition.l1.location_type = "town";
	pchar.quest.Patria_visiter_delete.function = "Patria_VisiterDelete";
	pchar.questTemp.Patria.Visiter_Late = "true";
}

void Patria_VisiterDelete(string qName) // провал по срокам
{
	if (pchar.location == "Charles_town" && CheckAttribute(pchar, "questTemp.Patria.Tortuga") && CheckAttribute(pchar, "questTemp.Patria.PortPax")) // если все выполнил, то прощаем
	{
		return;
	}
	sld = characterFromId("Noel");
	RemovePassenger(pchar, sld);
	Log_Info("Baron Noel Forget has left your ship!");
	RemoveItems(pchar, "patent_fra", 1);
	ChangeCharacterComplexReputation(pchar, "nobility", -5);
	ChangeCharacterComplexReputation(pchar, "authority", -5);
	ChangeCharacterNationReputation(pchar, FRANCE, -5);
	pchar.questTemp.Patria = "fail";
	AddQuestRecord("Patria", "10");
	CloseQuestHeader("Patria");
}

void Patria_VisiterTortuga(string qName) // в резиденциях
{
	pchar.quest.Patria_visiter_portpax.over = "yes";
	sld = characterFromId("Noel");
	ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocator(sld, "goto", "governor1", "", -1);
}

void Patria_VisiterTortugaBack(string qName) // 
{
	AddQuestRecord("Patria", "12");
	LocatorReloadEnterDisable("Tortuga_town", "reload3_back", false);
	sld = characterFromId("Noel");
	sld.dialog.currentnode = "noel_7";
	LAi_SetStayType(sld);
}

void Patria_VisiterTortugaSail()
{
	chrDisableReloadToLocation = true;
	sld = characterFromId("Noel");
	AddPassenger(pchar, sld, false);//добавить пассажира
	SetCharacterRemovable(sld, false);
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload1", "none", "", "", "OpenTheDoors", -1);
	pchar.questTemp.Patria.Tortuga = "true"; // посетили Тортугу
	if (!CheckAttribute(pchar, "questTemp.Patria.PortPax"))
	{
		pchar.quest.Patria_visiter_portpax.win_condition.l1 = "location";
		pchar.quest.Patria_visiter_portpax.win_condition.l1.location = "PortPax_townhall";
		pchar.quest.Patria_visiter_portpax.function = "Patria_VisiterPortPax";
	}
	if (CheckAttribute(pchar, "questTemp.Patria.Tortuga") && CheckAttribute(pchar, "questTemp.Patria.PortPax"))
	{
		AddQuestRecord("Patria", "14");
		pchar.quest.Patria_visiter_return.win_condition.l1 = "location";
		pchar.quest.Patria_visiter_return.win_condition.l1.location = "Nevis";
		pchar.quest.Patria_visiter_return.function = "Patria_VisiterSintMaarten";
	}
}

void Patria_VisiterPortPax(string qName) // в резиденциях 
{
	pchar.quest.Patria_visiter_tortuga.over = "yes";
	sld = characterFromId("Noel");
	ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocator(sld, "goto", "governor1", "", -1);
}

void Patria_VisiterPortPaxBack(string qName) // 
{
	AddQuestRecord("Patria", "12");
	LocatorReloadEnterDisable("PortPax_town", "reload3_back", false);
	sld = characterFromId("Noel");
	sld.dialog.currentnode = "noel_11";
	LAi_SetStayType(sld);
}

void Patria_VisiterPortPaxSail()
{
	chrDisableReloadToLocation = true;
	sld = characterFromId("Noel");
	AddPassenger(pchar, sld, false);//добавить пассажира
	SetCharacterRemovable(sld, false);
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload1", "none", "", "", "OpenTheDoors", -1);
	pchar.questTemp.Patria.PortPax = "true"; // посетили Эспаньолу
	if (!CheckAttribute(pchar, "questTemp.Patria.Tortuga"))
	{
		pchar.quest.Patria_visiter_tortuga.win_condition.l1 = "location";
		pchar.quest.Patria_visiter_tortuga.win_condition.l1.location = "Tortuga_townhall";
		pchar.quest.Patria_visiter_tortuga.function = "Patria_VisiterTortuga";
	}
	if (CheckAttribute(pchar, "questTemp.Patria.Tortuga") && CheckAttribute(pchar, "questTemp.Patria.PortPax"))
	{
		AddQuestRecord("Patria", "14");
		pchar.quest.Patria_visiter_return.win_condition.l1 = "location";
		pchar.quest.Patria_visiter_return.win_condition.l1.location = "Nevis";
		pchar.quest.Patria_visiter_return.function = "Patria_VisiterSintMaarten";
	}
}

void Patria_VisiterSintMaarten(string qName) // разговор на палубе
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	pchar.quest.Patria_VisiterOver.over = "yes"; // снять таймер
	bQuestDisableMapEnter = true;//закрыть карту
	Island_SetReloadEnableGlobal("Nevis", false);
	pchar.GenQuest.MapClosedNoBattle = true; 
	DoQuestFunctionDelay("Patria_VisiterToCabin", 2.0);
}

void Patria_VisiterToCabin(string qName) // в каюту
{
	Sea_CabinStartNow();
	DoQuestFunctionDelay("Patria_VisiterInCabin", 1.8);
}

void Patria_VisiterInCabin(string qName) // в каюту
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Noel");
	sld.dialog.currentnode = "noel_13";
	ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Patria_VisiterFin(string qName) // у Пуанси
{
	sld = characterFromId("Noel");
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", "goto1");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocator(sld, "goto", "goto4", "", -1);
	RemovePassenger(pchar, sld);
}

//----------------------------------------------------------- задание 3 -------------------------------------------------------------
void Patria_PortPaxBegin() // снова присоединяем Эклятон
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	sld = characterFromId("Ecliaton_Cap");
	DeleteAttribute(sld, "ShipHideImmortal");
	SetCharacterRemovable(sld, false);
	sld.CompanionEnemyEnable = false; //всегда друзья
	SetCompanionIndex(pchar, -1, sti(sld.index));
	sld.loyality = MAX_LOYALITY;
	pchar.questTemp.Patria.Ecliaton = "true";
	SetFunctionTimerCondition("Patria_PortPaxOver", 0, 0, 30, false); // таймер
	pchar.quest.Patria_PortPaxAttack.win_condition.l1 = "location";
	pchar.quest.Patria_PortPaxAttack.win_condition.l1.location = "Hispaniola2";
	pchar.quest.Patria_PortPaxAttack.function = "Patria_PortPaxAttack";
	// прерывание на потерю Эклятона
	pchar.quest.Patria_EcliatonFail.win_condition.l1 = "NPC_Death";
	pchar.quest.Patria_EcliatonFail.win_condition.l1.character = "Ecliaton_Cap";
	pchar.quest.Patria_EcliatonFail.function = "Patria_EcliatonFail";
	DoQuestFunctionDelay("Patria_EcliatonDelGroup", 1.0); // удалить группу Эклятона
}

void Patria_PortPaxOver(string qName) // опоздание по времени
{
	if (GetCharacterIndex("Ecliaton_Cap") != -1)
	{
		pchar.quest.Patria_EcliatonFail.over = "yes"; //снять прерывание
		sld = characterFromId("Ecliaton_Cap");
		sld.ShipHideImmortal = 1000; // непотопляемый корабль
		RemoveCharacterCompanion(pchar, sld);
		sld.DontDeskTalk = true;
		sld.lifeday = 0;
	}
	DeleteAttribute(pchar, "questTemp.Patria.Ecliaton");
	RemoveItems(pchar, "patent_fra", 1);
	ChangeCharacterComplexReputation(pchar, "nobility", -10);
	ChangeCharacterComplexReputation(pchar, "authority", -5);
	ChangeCharacterNationReputation(pchar, FRANCE, -10);
	pchar.questTemp.Patria = "fail";
	AddQuestRecord("Patria", "16");
	CloseQuestHeader("Patria");
}

void Patria_PortPaxAttack(string qName) // ставим испанскую эскадру
{
	// спрячем инспектора
	sld = characterFromId("Noel");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	AddQuestRecord("Patria", "17");
	Island_SetReloadEnableGlobal("Hispaniola2", false); //закрыть остров
	bQuestDisableMapEnter = true;//закрыть карту
	int iShip, iCannon, iRank, iScl;
	Group_FindOrCreateGroup("PatriaPPSeaGroup");
	for (int i=1; i<=4; i++)
	{
		switch (i)
		{
			case 1:
				iRank = 18+MOD_SKILL_ENEMY_RATE*2;
				iScl = 65;
				iShip = SHIP_LINESHIP;
				iCannon = CANNON_TYPE_CANNON_LBS32;
			break;
			
			case 2:
				iRank = 16+MOD_SKILL_ENEMY_RATE*2;
				iScl = 55;
				iShip = SHIP_GALEON_H;
				iCannon = CANNON_TYPE_CANNON_LBS24;
			break;
			
			case 3:
				iRank = 12+MOD_SKILL_ENEMY_RATE*2;
				iScl = 45;
				iShip = SHIP_CORVETTE;
				iCannon = CANNON_TYPE_CULVERINE_LBS18;
			break;
			
			case 4:
				iRank = 12+MOD_SKILL_ENEMY_RATE*2;
				iScl = 45;
				iShip = SHIP_XebekVML;
				iCannon = CANNON_TYPE_CULVERINE_LBS18;
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("PatriaPP_Seacap_"+i, "off_spa_"+(6-i), "man", "man", iRank, SPAIN, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, iScl, iScl, iScl);
		FantomMakeCoolFighter(sld, iRank, iScl, iScl, LinkRandPhrase("blade_18","blade_19","blade_20"), "pistol5", "bullet", 250);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.cirassId = Items_FindItemIdx("cirass4");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysEnemy = true;
		sld.Coastal_Captain = true;
		sld.AlwaysSandbankManeuver = true;
		sld.Ship.Mode = "war";
		sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*5;
		sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*5;
		sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*5;
		sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*5;
		if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
		if (i < 3) SetRandGeraldSail(sld, SPAIN);
		Group_AddCharacter("PatriaPPSeaGroup", "PatriaPP_Seacap_"+i);
	}
	Group_SetGroupCommander("PatriaPPSeaGroup", "PatriaPP_Seacap_1");
	Group_SetAddress("PatriaPPSeaGroup", "Hispaniola2", "quest_ships", "quest_ship_"+(rand(3)+5));
	Group_SetTaskNone("PatriaPPSeaGroup");
	//Group_LockTask("PatriaPPSeaGroup");
	pchar.quest.Patria_PortPax_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Patria_PortPax_AfterBattle.win_condition.l1.group = "PatriaPPSeaGroup";
	pchar.quest.Patria_PortPax_AfterBattle.function = "Patria_PortPaxAfterBattle";
}

void Patria_PortPaxAfterBattle(string qName) // потопили испанскую эскадру
{
	Group_DeleteGroup("PatriaPPSeaGroup");
	if (MOD_SKILL_ENEMY_RATE < 6)
	{
		bQuestDisableMapEnter = false;
		Island_SetReloadEnableGlobal("Hispaniola2", true);//на остров можно
		AddQuestRecord("Patria", "18");
		pchar.questTemp.Patria = "epizode_3_return";
		DoQuestCheckDelay("sea_victory", 1.5);
	}
    else DoQuestFunctionDelay("Patria_PortPaxNextBattle", 5.0);
}

void Patria_PortPaxNextBattle(string qName) // добавочный ТГ
{
	PlaySound("interface\notebook.wav");
	Log_Info(RandSwear()+"Another enemy ship is on us!");
	PlaySound("interface\_EvEnemy0.wav");
	Group_FindOrCreateGroup("PatriaPPSeaGroup1");
	sld = GetCharacter(NPC_GenerateCharacter("PatriaPP_Seacap_add", "off_spa_4", "man", "man", 20+MOD_SKILL_ENEMY_RATE*2, SPAIN, -1, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_GALEON_H, "", CANNON_TYPE_CANNON_LBS24, 65, 65, 65);
	FantomMakeCoolFighter(sld, 20+MOD_SKILL_ENEMY_RATE*2, 65, 65, "blade_19", "pistol5", "bullet", 100);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.cirassId = Items_FindItemIdx("cirass4");
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.AlwaysEnemy = true;
	sld.Coastal_Captain = true;
	sld.AlwaysSandbankManeuver = true;
	sld.Ship.Mode = "war";
	sld.ship.Crew.Morale = 50+MOD_SKILL_ENEMY_RATE*5;
	sld.Ship.Crew.Exp.Sailors = 50+MOD_SKILL_ENEMY_RATE*5;
	sld.Ship.Crew.Exp.Cannoners = 50+MOD_SKILL_ENEMY_RATE*5;
	sld.Ship.Crew.Exp.Soldiers = 50+MOD_SKILL_ENEMY_RATE*5;
	SetRandGeraldSail(sld, SPAIN);
	Group_AddCharacter("PatriaPPSeaGroup1", "PatriaPP_Seacap_add");
	Group_SetGroupCommander("PatriaPPSeaGroup1", "PatriaPP_Seacap_add");
	Group_SetTaskAttack("PatriaPPSeaGroup1", PLAYER_GROUP);
	Group_LockTask("PatriaPPSeaGroup1");
	DoQuestFunctionDelay("Patria_PortPaxNextBattleGo", 3.0);
	
	pchar.quest.Patria_PortPax_AfterBattle1.win_condition.l1 = "Group_Death";
	pchar.quest.Patria_PortPax_AfterBattle1.win_condition.l1.group = "PatriaPPSeaGroup1";
	pchar.quest.Patria_PortPax_AfterBattle1.function = "Patria_PortPaxAfterFinBattle";
}

void Patria_PortPaxNextBattleGo(string qName) // 
{
	Sea_LoginGroupCurrentSea("PatriaPPSeaGroup1");
}

void Patria_PortPaxAfterFinBattle(string qName) // потопили добавочный ТГ
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	Group_DeleteGroup("PatriaPPSeaGroup1");
	bQuestDisableMapEnter = false;
	Island_SetReloadEnableGlobal("Hispaniola2", true);//на остров можно
	AddQuestRecord("Patria", "18");
	pchar.questTemp.Patria = "epizode_3_return";
	DoQuestCheckDelay("sea_victory", 1.5);
}

// ---------------------------------------------------------- задание 4 ---------------------------------------------------------------
void Patria_CureerBegin() // отсоединяем Эклятон, присоединяем флейт
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	pchar.quest.Patria_EcliatonFail.over = "yes";
	sld = characterFromId("Ecliaton_Cap");
	sld.ShipHideImmortal = 1000; // непотопляемый корабль
	RemoveCharacterCompanion(pchar, sld);
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true;
	Group_AddCharacter("Ecliaton_group", "Ecliaton_Cap");
	Group_SetGroupCommander("Ecliaton_group", "Ecliaton_Cap");
	Group_SetAddress("Ecliaton_group", "Nevis", "quest_ships", "quest_ship_1");
	Group_SetTaskNone("Ecliaton_group");
	Group_LockTask("Ecliaton_group");
	SetFunctionTimerCondition("Patria_EcliatonRepair", 0, 0, 5, false); // таймер на починку Эклятона
	DeleteAttribute(pchar, "questTemp.Patria.Ecliaton");
	// флейт
	sld = GetCharacter(NPC_GenerateCharacter("Patria_FlautCap", "mercen_13", "man", "man", 20, FRANCE, -1, false, "soldier"));
	FantomMakeCoolSailor(sld, SHIP_FLEUT, "", CANNON_TYPE_CANNON_LBS16, 30, 30, 30);
	FantomMakeCoolFighter(sld, 20, 30, 30, "blade_11", "pistol1", "bullet", 50);
	SetShipSkill(sld, 30, 40, 40, 45, 35, 35, 20, 30, 50);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "trade";
	int iSpace = GetCharacterFreeSpace(sld, GOOD_EBONY);
	Fantom_SetCharacterGoods(sld, GOOD_EBONY, iSpace, 1);
	SetCharacterRemovable(sld, false);
	sld.CompanionEnemyEnable = false; //всегда друзья
	SetCompanionIndex(pchar, -1, sti(sld.index));
	sld.loyality = MAX_LOYALITY;
	// прерывание на потерю флейта
	pchar.quest.Patria_CureerFail.win_condition.l1 = "NPC_Death";
	pchar.quest.Patria_CureerFail.win_condition.l1.character = "Patria_FlautCap";
	pchar.quest.Patria_CureerFail.function = "Patria_CureerFail";
	// таймер на 3 недели и таймер на скоростных ДУ
	SetFunctionTimerCondition("Patria_CureerTimeOver", 0, 0, 15, false);
	SetFunctionTimerCondition("Patria_CureerCreatePirates", 0, 0, 3, false);
	// ставим Стайвесанта
	if (GetCharacterIndex("Stivesant") != -1)
	{
		sld = characterFromId("Stivesant");
	}
	else
	{
		sld = GetCharacter(NPC_GenerateCharacter("Stivesant", "huber_1", "man", "man_B", 35, HOLLAND, -1, false, "quest"));
		FantomMakeSmallSailor(sld, SHIP_GALEON_H, "Frederick", CANNON_TYPE_CANNON_LBS24, 100, 100, 100, 100, 100);
		FantomMakeCoolFighter(sld, 35, 90, 90, "blade_15", "pistol5", "bullet", 250);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.name = "Peter";
		sld.lastname = "Stuyvesant";
		sld.greeting = "Stivesant"; 
	}
	sld.Dialog.Filename = "Quest\HollandGambit\OtherNPC.c";
	sld.dialog.currentnode = "Stivesant_19";
	LAi_SetHuberType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_townhall", "sit", "sit1");
	LAi_group_MoveCharacter(sld, "HOLLAND_CITIZENS");
	sld = characterFromId("hol_guber");
	LAi_SetStayType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_townhall", "goto", "governor1");
}

void Patria_CureerCreatePirates(string qName)//атака ДУ
{
	CoolTraderHunterOnMap();
}

void Patria_CureerTimeOver(string qName) // опоздание по времени
{
	pchar.quest.Patria_CureerFail.over = "yes"; //снять прерывание
	if (GetCharacterIndex("Patria_FlautCap") != -1)
	{
		sld = characterFromId("Patria_FlautCap");
		sld.ShipHideImmortal = 200; // непотопляемый корабль
		RemoveCharacterCompanion(pchar, sld);
		sld.DontDeskTalk = true;
		sld.lifeday = 0;
	}
	RemoveItems(pchar, "patent_fra", 1);
	RemoveItems(pchar, "Reserve_item_01", 1);
	ChangeCharacterComplexReputation(pchar, "nobility", -10);
	ChangeCharacterComplexReputation(pchar, "authority", -5);
	ChangeCharacterNationReputation(pchar, FRANCE, -10);
	pchar.questTemp.Patria = "fail";
	AddQuestRecord("Patria", "21");
	CloseQuestHeader("Patria");
	Patria_StivesantHide();
}

void Patria_CureerFail(string qName) // потеряли флейт
{
	pchar.quest.Patria_CureerTimeOver.over = "yes"; //снять таймер
	RemoveItems(pchar, "patent_fra", 1);
	RemoveItems(pchar, "Reserve_item_01", 1);
	ChangeCharacterComplexReputation(pchar, "nobility", -10);
	ChangeCharacterComplexReputation(pchar, "authority", -7);
	ChangeCharacterNationReputation(pchar, FRANCE, -15);
	pchar.questTemp.Patria = "fail";
	AddQuestRecord("Patria", "22");
	CloseQuestHeader("Patria");
	Patria_StivesantHide();
}

void Patria_StivesantHide() // убираем Стайвесанта
{
	sld = characterFromId("Stivesant");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld = characterFromId("hol_guber");
	LAi_SetHuberType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_townhall", "sit", "sit1");
}

void Patria_StivesantWait(string qName) // Стайвесант возвращается
{
	sld = characterFromId("Stivesant");
	ChangeCharacterAddressGroup(sld, "Villemstad_townhall", "reload", "reload2");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocator(sld, "goto", "goto6", "Patria_StivesantSit", -1);
	LAi_group_MoveCharacter(sld, "HOLLAND_CITIZENS");
}

void Patria_CureerBackOver(string qName) // опоздание по времени
{
	RemoveItems(pchar, "patent_fra", 1);
	RemoveItems(pchar, "Reserve_item_01", 1);
	ChangeCharacterComplexReputation(pchar, "nobility", -10);
	ChangeCharacterComplexReputation(pchar, "authority", -5);
	ChangeCharacterNationReputation(pchar, FRANCE, -10);
	sld = characterFromId("Noel");
	sld.lifeday = 0;
	ChangeCharacterAddressGroup(sld, "none", "", "");
	pchar.questTemp.Patria = "fail";
	AddQuestRecord("Patria", "24");
	CloseQuestHeader("Patria");
}
// ---------------------------------------------------------- задание 5 ---------------------------------------------------------------
void Patria_SanMartinBaron(string qName) // вестовой Пуанси
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = GetCharacter(NPC_GenerateCharacter("Patria_FraOfficer", "off_fra_1", "man", "man", 25, FRANCE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 25, 60, 60, "blade_10", "pistol5", "bullet", 100);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.Dialog.Filename = "Quest\Patria_NPC.c";
	sld.dialog.currentnode = "fraofficer";
    ChangeCharacterAddressGroup(sld, "Charles_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Patria_SanMartinSetBaron()
{
	sld = characterFromId("Noel");
	sld.dialog.currentnode = "noel_18";
	ChangeCharacterAddressGroup(sld, "Charles_town", "reload", "reload3");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocator(sld, "reload", "reload1", "Patria_SanMartinSetBaron", -1);
}

void Patria_SanMartinBaronOver(string qName) // время вышло - взрываем корабль ГГ
{
	if (bSeaActive) DoQuestFunctionDelay("Mtraxx_MarkusGameOver", 2.0);
	else 
	{
		pchar.quest.patria_boom.win_condition.l1 = "EnterToSea";
		pchar.quest.patria_boom.function = "Patria_SanMartinBaronOverBoom";
	}
}

void Patria_SanMartinBaronOverBoom(string qName) // время вышло - взрываем корабль ГГ
{
	bQuestDisableMapEnter = true;
	DoQuestFunctionDelay("Mtraxx_MarkusGameOver", 3.0);
}

void Patria_SanMartinFortAttack()
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	DeleteAttribute(pchar, "questTemp.Patria.SanMartinFort");
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.quest.Patria_SanMartinBaronOver.over = "yes"; // снять таймер
	Island_SetReloadEnableGlobal("SentMartin", false);//закрыть Синт-Маартен лесник . сент мартин
	Island_SetReloadEnableGlobal("Curacao", false);//закрыть Кюрасао
	sld = CharacterFromID("Villemstad Fort Commander");
	Character_SetAbordageEnable(sld, false); // неабордируемый форт Кюрасао
	SetCharacterRelationBoth(sti(sld.index), GetMainCharacterIndex(), RELATION_ENEMY);
	SetNationRelation2MainCharacter(HOLLAND, RELATION_ENEMY);
	sld.AlwaysEnemy = true;
	DoQuestFunctionDelay("Patria_SanMartinSetSquadron", 5.0);
}

void Patria_SanMartinSetSquadron(string qName) // ставим эскадру голандцев
{
	AddQuestRecord("Patria", "27");
	PlaySound("interface\_EvEnemy0.wav");
	Group_FindOrCreateGroup("Patria_SanMartinSeaGroup");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+3;
	if (iRank > 45) iRank = 45;
	int iShip, Ship1, Ship2, Ship3, iCannon, Cannon1, Cannon2;
	
	switch (MOD_SKILL_ENEMY_RATE)
	{
		case 2:
			Ship1 = SHIP_BRIG;
			Ship2 = SHIP_BARKENTINE;
			Ship3 = SHIP_SLOOP;
			Cannon1 = CANNON_TYPE_CANNON_LBS16;
			Cannon2 = CANNON_TYPE_CULVERINE_LBS8;
		break;
		
		case 4:
			Ship1 = SHIP_BRIGANTINE;
			Ship2 = SHIP_SHNYAVA;
			Ship3 = SHIP_SCHOONER_W;
			Cannon1 = CANNON_TYPE_CANNON_LBS16;
			Cannon2 = CANNON_TYPE_CANNON_LBS12;
		break;
		
		case 6:
			Ship1 = SHIP_CORVETTE;
			Ship2 = SHIP_BRIG;
			Ship3 = SHIP_SCHOONER_W;
			Cannon1 = CANNON_TYPE_CULVERINE_LBS18;
			Cannon2 = CANNON_TYPE_CANNON_LBS16;
		break;
		
		case 8:
			Ship1 = SHIP_FRIGATE;
			Ship2 = SHIP_GALEON_L;
			Ship3 = SHIP_BRIG;
			Cannon1 = CANNON_TYPE_CANNON_LBS24;
			Cannon2 = CANNON_TYPE_CULVERINE_LBS18;
		break;
		
		case 10:
			Ship1 = SHIP_FRIGATE_H;
			Ship2 = SHIP_CORVETTE;
			Ship3 = SHIP_BRIGANTINE;
			Cannon1 = CANNON_TYPE_CANNON_LBS24;
			Cannon2 = CANNON_TYPE_CULVERINE_LBS18;
		break;
	}
	for (int i=1; i<=3; i++)
	{
		switch (i)
		{
			case 1:
				iShip = Ship1;
				iCannon = Cannon1;
			break;
			
			case 2:
				iShip = Ship2;
				iCannon = Cannon2;
			break;
			
			case 3:
				iShip = Ship3;
				iCannon = Cannon2;
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("Patria_SanMartinCap_"+i, "off_hol_"+i, "man", "man", iRank, HOLLAND, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, 70, 70, 70);
		FantomMakeCoolFighter(sld, iRank, 70, 70, LinkRandPhrase("blade_09","blade_12","blade_13"), "pistol1", "bullet", 150);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysEnemy = true;
		sld.Coastal_Captain = true;
		sld.Ship.Mode = "war";
		sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*6;
		if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
		Group_AddCharacter("Patria_SanMartinSeaGroup", "Patria_SanMartinCap_"+i);
	}
	Group_SetGroupCommander("Patria_SanMartinSeaGroup", "Patria_SanMartinCap_1");
	Group_SetTaskAttack("Patria_SanMartinSeaGroup", PLAYER_GROUP);
	Group_LockTask("Patria_SanMartinSeaGroup");
	Sea_LoginGroupCurrentSea("Patria_SanMartinSeaGroup");

	pchar.quest.Patria_SanMartin_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Patria_SanMartin_AfterBattle.win_condition.l1.group = "Patria_SanMartinSeaGroup";
	pchar.quest.Patria_SanMartin_AfterBattle.function = "Patria_SanMartinEscape";
}

void Patria_SanMartinEscape(string qName) // 
{
	Group_DeleteGroup("Patria_SanMartinSeaGroup");
	bQuestDisableMapEnter = false;
	AddQuestRecord("Patria", "28");
	pchar.quest.Patria_SanMartin_Sea.win_condition.l1 = "MapEnter";
	pchar.quest.Patria_SanMartin_Sea.function = "Patria_SanMartinSeaTalk";
}

void Patria_SanMartinSeaTalk(string qName) // разговор на палубе
{
	aref arOldMapPos;
	makearef(arOldMapPos, worldMap.old);
	WdmPrepareMapForAbordage(arOldMapPos);
	MakeCloneShipDeck(pchar, true);//клон палубы
	LAi_LocationFightDisable(&Locations[FindLocation("Ship_deck")], true);
	DoReloadFromWorldMapToLocation("Ship_deck", "goto", "goto1");
	LAi_LockFightMode(pchar, true);
	pchar.quest.Munity = "";//чтобы не выскочил без разговора
	sld = characterFromId("Noel");
	sld.dialog.currentnode = "noel_21";
	ChangeCharacterAddressGroup(sld, "Ship_deck", "reload", "reload1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Patria_SanMartinBack(string qName) // у Сент-Кристофера
{
	pchar.quest.Patria_SanMartinBaronOver.over = "yes"; // снять таймер
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	pchar.quest.Patria_SanMartin_Back1.win_condition.l1 = "location";
	pchar.quest.Patria_SanMartin_Back1.win_condition.l1.location = "Charles_Roomtownhall";
	pchar.quest.Patria_SanMartin_Back1.function = "Patria_SanMartinFin";
}

void Patria_SanMartinFin(string qName) // у Пуанси
{
	sld = characterFromId("Noel");
	RemovePassenger(pchar, sld);
	ChangeCharacterAddressGroup(sld, "Charles_Roomtownhall", "goto", "goto5");
	LAi_SetActorType(sld);
	LAi_ActorGoToLocator(sld, "goto", "goto4", "Patria_SanMartinBaronTurn", -1);
}

// ---------------------------------------------------------- задание 6 ---------------------------------------------------------------
void Patria_DiplomatBegin() // 
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	Island_SetReloadEnableGlobal("Curacao", true);//открыть Кюрасао
	Island_SetReloadEnableGlobal("SentMartin", true);//открыть Синт-Маартен бухты
	sld = characterFromId("Stivesant");
	sld.dialog.currentnode = "Stivesant_27";
	SetFunctionTimerCondition("Patria_DiplomatTimeOver", 0, 0, 90, false); // таймер
}

void Patria_DiplomatTimeOver(string qName) // слишком все затянули
{
	// вернуть Синт-Маартен в норму
	int n = FindIsland("SentMartin");
	Islands[n].reload.l1.radius = 600.0;
	LocatorReloadEnterDisable("Marigo_ExitTown", "reload3", false); // открыть городские ворота
	sld = CharacterFromID("Marigo Fort Commander");
	LAi_SetImmortal(sld, false);
	Character_SetAbordageEnable(sld, true);
	RemoveItems(pchar, "patent_fra", 1);
	ChangeCharacterComplexReputation(pchar, "nobility", -10);
	ChangeCharacterComplexReputation(pchar, "authority", -5);
	ChangeCharacterNationReputation(pchar, FRANCE, -10);
	sld = characterFromId("Noel");
	sld.lifeday = 0;
	ChangeCharacterAddressGroup(sld, "none", "", "");
	pchar.questTemp.Patria = "fail";
	AddQuestRecord("Patria", "24_1");
	CloseQuestHeader("Patria");
}

void Patria_DiplomatFight() // 
{
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_group_Delete("EnemyFight");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	if (iRank > 45) iRank = 45;
	for (i=1; i<=5; i++)
    {
        sld = GetCharacter(NPC_GenerateCharacter("Patria_Vlmsold_"+i, "sold_hol_"+i, "man", "man", iRank, HOLLAND, -1, true, "soldier"));
		FantomMakeCoolFighter(sld, iRank, 40, 40, LinkRandPhrase("blade_09","blade_12","blade_13"), "pistol1", "bullet", 150);       
		LAi_SetWarriorType(sld); 
        ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
		LAi_group_MoveCharacter(sld, "EnemyFight");
    }
    sld = GetCharacter(NPC_GenerateCharacter("Patria_Vlmoff", "off_hol_3", "man", "man", iRank+5, HOLLAND, -1, true, "soldier"));
	FantomMakeCoolFighter(sld, iRank, 40, 40, LinkRandPhrase("blade_09","blade_12","blade_13"), "pistol1", "bullet", 150);       
	LAi_SetWarriorType(sld); 
	ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
	LAi_group_MoveCharacter(sld, "EnemyFight");
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Patria_DiplomatAfterFight");
	LAi_SetFightMode(pchar, true);
}

void Patria_DiplomatSail(string qName) // вышли на карту
{
	LocatorReloadEnterDisable("Villemstad_town", "reload3_back", false);
	pchar.quest.Patria_DiplomatSeabattle.win_condition.l1 = "EnterToSea";
	pchar.quest.Patria_DiplomatSeabattle.function = "Patria_DiplomatSeabattle";
}

void Patria_DiplomatSeabattle(string qName) // вышли в море
{
	bQuestDisableMapEnter = true;
	pchar.questTemp.Patria.Diplomat.CurIsland = PChar.location;
	if (pchar.questTemp.Patria.Diplomat.CurIsland != "") Island_SetReloadEnableGlobal(pchar.questTemp.Patria.Diplomat.CurIsland, false);
	log_info(PChar.location);
	DoQuestFunctionDelay("Patria_DiplomatSeabattleGo", 4.0);
}

void Patria_DiplomatSeabattleGo(string qName) // ставим эскадру голандцев
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	PlaySound("interface\notebook.wav");
	PlaySound("interface\_EvEnemy0.wav");
	Group_FindOrCreateGroup("Patria_DiplomatSeaGroup");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+3;
	if (iRank > 45) iRank = 45;
	int iShip, Ship1, Ship2, Ship3, iCannon, Cannon1, Cannon2;
	
	switch (MOD_SKILL_ENEMY_RATE)
	{
		case 2:
			Ship1 = SHIP_BRIGANTINE;
			Ship2 = SHIP_BRIG;
			Ship3 = SHIP_SCHOONER_W;
			Cannon1 = CANNON_TYPE_CANNON_LBS16;
			Cannon2 = CANNON_TYPE_CANNON_LBS12;
		break;
		
		case 4:
			Ship1 = SHIP_CORVETTE;
			Ship2 = SHIP_BRIGANTINE;
			Ship3 = SHIP_SCHOONER_W;
			Cannon1 = CANNON_TYPE_CULVERINE_LBS18;
			Cannon2 = CANNON_TYPE_CANNON_LBS16;
		break;
		
		case 6:
			Ship1 = SHIP_FRIGATE;
			Ship2 = SHIP_CORVETTE;
			Ship3 = SHIP_POLACRE;
			Cannon1 = CANNON_TYPE_CANNON_LBS24;
			Cannon2 = CANNON_TYPE_CULVERINE_LBS18;
		break;
		
		case 8:
			Ship1 = SHIP_FRIGATE_H;
			Ship2 = SHIP_FRIGATE;
			Ship3 = SHIP_CORVETTE;
			Cannon1 = CANNON_TYPE_CANNON_LBS24;
			Cannon2 = CANNON_TYPE_CULVERINE_LBS18;
		break;
		
		case 10:
			Ship1 = SHIP_LINESHIP;
			Ship2 = SHIP_FRIGATE_H;
			Ship3 = SHIP_FRIGATE;
			Cannon1 = CANNON_TYPE_CANNON_LBS32;
			Cannon2 = CANNON_TYPE_CANNON_LBS24;
		break;
	}
	for (int i=1; i<=3; i++)
	{
		switch (i)
		{
			case 1:
				iShip = Ship1;
				iCannon = Cannon1;
			break;
			
			case 2:
				iShip = Ship2;
				iCannon = Cannon2;
			break;
			
			case 3:
				iShip = Ship3;
				iCannon = Cannon2;
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("Patria_DiplomatCap_"+i, "off_hol_"+i, "man", "man", iRank, HOLLAND, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, 70, 70, 70);
		FantomMakeCoolFighter(sld, iRank, 70, 70, LinkRandPhrase("blade_09","blade_12","blade_13"), "pistol1", "bullet", 150);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.Coastal_Captain = true; 
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysEnemy = true;
		sld.Ship.Mode = "war";
		sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*6;
		if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
		Group_AddCharacter("Patria_DiplomatSeaGroup", "Patria_DiplomatCap_"+i);
	}
	Group_SetGroupCommander("Patria_DiplomatSeaGroup", "Patria_DiplomatCap_1");
	Group_SetTaskAttack("Patria_DiplomatSeaGroup", PLAYER_GROUP);
	Group_LockTask("Patria_DiplomatSeaGroup");
	Sea_LoginGroupCurrentSea("Patria_DiplomatSeaGroup");

	pchar.quest.Patria_Diplomat_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Patria_Diplomat_AfterBattle.win_condition.l1.group = "Patria_DiplomatSeaGroup";
	pchar.quest.Patria_Diplomat_AfterBattle.function = "Patria_DiplomatAfterBattle";
}

void Patria_DiplomatAfterBattle(string qName) // потопили эскадру
{
	Group_DeleteGroup("Patria_DiplomatSeaGroup");
	bQuestDisableMapEnter = false;
	Island_SetReloadEnableGlobal(pchar.questTemp.Patria.Diplomat.CurIsland, true);
	DeleteAttribute(pchar, "questTemp.Patria.Diplomat.CurIsland");
	AddQuestRecord("Patria", "32");
	sld = characterFromId("Noel");
	ChangeCharacterAddressGroup(sld, "none", "", "");
}

// ---------------------------------------------------------- задание 7 ---------------------------------------------------------------
void Patria_HunterBegin() // 
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	pchar.quest.Patria_Hunter_begin.win_condition.l1 = "Timer";
	pchar.quest.Patria_Hunter_begin.win_condition.l1.date.hour  = 9.00;
	pchar.quest.Patria_Hunter_begin.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 1);
	pchar.quest.Patria_Hunter_begin.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 1);
	pchar.quest.Patria_Hunter_begin.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 1);
	pchar.quest.Patria_Hunter_begin.function = "Patria_HunterTask";
	// убираем Эклятон к Гваделупе
	Group_SetAddress("Ecliaton_group", "Guadeloupe", "quest_ships", "quest_ship_1");
	Group_SetTaskNone("Ecliaton_group");
	Group_LockTask("Ecliaton_group");
}

void Patria_HunterTask(string qName) // 
{
	sld = characterFromId("Noel");
	ChangeCharacterAddressGroup(sld, "Charles_Roomtownhall", "goto", "goto4");
	LAi_SetActorType(sld);
	pchar.questTemp.Patria = "epizode_7_go";
}

void Patria_HunterContinue() // 
{
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	sld = CharacterFromID("Villemstad Fort Commander"); // бессмертный форт
	LAi_SetImmortal(sld, true);
	// меняем отношения наций
	pchar.questTemp.Patria.War = "true";
	LaunchNationLegend();
	DeleteAttribute(pchar, "questTemp.Patria.War");
	DoQuestCheckDelay("sea_victory", 0.2);
	// генератор голландских конвоев
	pchar.questTemp.Patria.Hunter = 0 // счетчик учета сданных кораблей
	pchar.questTemp.Patria.Hunter.Capture = 0; // счетчик учета захваченных кораблей
	pchar.questTemp.Patria.Hunter.Num = 0; // нумерация конвоев
	SetFunctionTimerCondition("Patria_HunterConvoyGenerate", 0, 0, 3, false);
	pchar.quest.Patria_Hunter_BugFixer.win_condition.l1 = "EnterToSea";
	pchar.quest.Patria_Hunter_BugFixer.function = "Patria_HunterBugFixer";
}

void Patria_HunterBugFixer(string qName) // 
{
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
}

void Patria_HunterConvoyGenerate(string qName) // генерируем конвой
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	if (sti(pchar.questTemp.Patria.Hunter) > 4) return;
	pchar.questTemp.Patria.Hunter.Num = sti(pchar.questTemp.Patria.Hunter.Num)+1; // порядковый номер конвоя
	int iColony = rand(5);
	int iDay, iGoods, iSpace, iShip, iShip1, iShip2, iCannon, iCannon1, iCannon2, iCannon3;
	string sColony, sModel;
	string sCapId = "PatriaHWICCap";
    string sGroup = "Sea_" + sCapId + "1";
	int iGoodsType = rand(1);
	if (iGoodsType > 0) iGoods = GOOD_COFFEE + rand(2);
	else iGoods = GOOD_EBONY + rand(2);
	switch (iGoods)
	{
		case 11:
			iSpace = 1400+rand(100);
		break;
		
		case 12:
			iSpace = 1400+rand(100);
		break;
		
		case 13:
			iSpace = 1400+rand(100);
		break;
		
		case 17:
			iSpace = 550+rand(20);
		break;
		
		case 18:
			iSpace = 670+rand(30);
		break;
		
		case 19:
			iSpace = 1400+rand(100);
		break;
	}
	switch (iColony)
	{
		case 0:
			sColony = "Shore45";
			iDay = 5;
		break;
		
		case 1:
			sColony = "Shore44";
			iDay = 6;
		break;
		
		case 2:
			sColony = "Mayak8";
			iDay = 8;
		break;
		
		case 3:
			sColony = "Shore58";
			iDay = 10;
		break;
		
		case 4:
			sColony = "Shore2";
			iDay = 5;
		break;
		
		case 5:
			sColony = "Shore28";
			iDay = 8;
		break;
	}
	switch (MOD_SKILL_ENEMY_RATE)
	{
		case 2:
			iShip1 = SHIP_CORVETTE+rand(2);
			iShip2 = SHIP_BRIGANTINE+rand(2);
			iCannon1 = CANNON_TYPE_CANNON_LBS16;
			iCannon2 = CANNON_TYPE_CANNON_LBS16;
			iCannon3 = CANNON_TYPE_CANNON_LBS12;
		break;
		
		case 4:
			iShip1 = SHIP_CORVETTE+rand(2);
			iShip2 = SHIP_CORVETTE+rand(2);
			iCannon1 = CANNON_TYPE_CULVERINE_LBS18;
			iCannon2 = CANNON_TYPE_CANNON_LBS16;
			iCannon3 = CANNON_TYPE_CANNON_LBS16;
		break;
		
		case 6:
			iShip1 = SHIP_FRIGATE;
			iShip2 = SHIP_CORVETTE+rand(2);
			iCannon1 = CANNON_TYPE_CANNON_LBS24;
			iCannon2 = CANNON_TYPE_CULVERINE_LBS18;
			iCannon3 = CANNON_TYPE_CULVERINE_LBS18;
		break;
		
		case 8:
			iShip1 = SHIP_FRIGATE_H;
			iShip2 = SHIP_FRIGATE;
			iCannon1 = CANNON_TYPE_CANNON_LBS24;
			iCannon2 = CANNON_TYPE_CANNON_LBS24;
			iCannon3 = CANNON_TYPE_CANNON_LBS24;
		break;
		
		case 10:
			iShip1 = SHIP_LINESHIP;
			iShip2 = SHIP_FRIGATE_H;
			iCannon1 = CANNON_TYPE_CANNON_LBS32;
			iCannon2 = CANNON_TYPE_CANNON_LBS24;
			iCannon3 = CANNON_TYPE_CANNON_LBS24;
		break;
	}
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	if (iRank > 45) iRank = 45;
	for (int i = 1; i <= 3; i++)
    {
		switch (i)
		{
			case 1: 
				iShip = iShip1;
				iCannon = iCannon1;	
				sModel = "off_hol_1";
			break;
			case 2: 
				iShip = SHIP_EASTINDIAMAN; 
				iCannon = iCannon2;
				sModel = "off_hol_"+(rand(1)+4);
			break;
			case 3: 
				iShip = iShip2; 
				iCannon = iCannon3;
				sModel = "off_hol_2";
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter(sCapId + i, sModel, "man", "man", iRank, HOLLAND, iDay, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, 50, 50, 50);
		FantomMakeCoolFighter(sld, iRank, 50, 50, LinkRandPhrase("blade_09","blade_12","blade_13"), "pistol1", "bullet", 150);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.Ship.Mode = "war";
		sld.AlwaysEnemy = true; // 7-add
		sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*6;
		if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
		sld.lifeDay = iDay;
		sld.Coastal_Captain = true;
		sld.WatchFort = true; //видеть форты
		if (i == 2) SetCharacterGoods(sld, iGoods, iSpace); // груз в ост-индец
		sld.mapEnc.type = "trade";
		sld.mapEnc.worldMapShip = "quest_ship";
        sld.mapEnc.Name = "The Company's trade convoy";
        Group_AddCharacter(sGroup, sCapId + i);
	}
	Group_SetGroupCommander(sGroup, sCapId+ "1");
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
	Map_CreateTrader(sColony, "Marigo", sCapId + "1", iDay);//запуск энкаунтера
	
	pchar.quest.patria_huntership_capture.win_condition.l1 = "Character_Capture";
	pchar.quest.patria_huntership_capture.win_condition.l1.character = "PatriaHWICCap2";
	pchar.quest.patria_huntership_capture.function = "Patria_HunterCaptureCounter";
	
	SetFunctionTimerCondition("Patria_HunterNewConvoyGenerate", 0, 0, iDay+3, false);
	
	log_Testinfo("Сгенерирован конвой номер "+sti(pchar.questTemp.Patria.Hunter.Num)+". Движется из "+XI_ConvertString(sColony)+", будет через "+FindRussianDaysString(iDay)+". Товар: "+GetGoodsNameAlt(iGoods)+" в количестве "+FindRussianQtyString(iSpace)+".");
}

void Patria_HunterNewConvoyGenerate(string qName) // 
{
	DoQuestFunctionDelay("Patria_HunterConvoyGenerate", 2.0);
}

void Patria_HunterCaptureCounter(string qName) // 
{
	log_info("The Company's Ost-Indian has been captured!");
	PlaySound("interface\notebook.wav");
	pchar.questTemp.Patria.Hunter.Capture = sti(pchar.questTemp.Patria.Hunter.Capture)+1;
}

void Patria_HunterShipChecker()
{
	if (sti(pchar.questTemp.Patria.Hunter.Capture) < 1) return; // нет захваченных кораблей, чтобы не сдавал левые ост-индцы
	for(int i = 0; i < COMPANION_MAX; i++)
	{
		int iTemp = GetCompanionIndex(PChar, i);
		if(iTemp > 0)
		{
			ref sld = GetCharacter(iTemp);
			if (sti(RealShips[sti(sld.ship.type)].basetype) == SHIP_EASTINDIAMAN)
			{
				log_Testinfo("Нужный корабль есть");
				if (GetCargoGoods(sld, GOOD_COFFEE) >= 1300 || GetCargoGoods(sld, GOOD_CHOCOLATE) >= 1300 || GetCargoGoods(sld, GOOD_TOBACCO) >= 1300 || GetCargoGoods(sld, GOOD_EBONY) >= 500 || GetCargoGoods(sld, GOOD_MAHOGANY) >= 600 || GetCargoGoods(sld, GOOD_CINNAMON) >= 1300)
				{
					i = 6; // остановка цикла
					pchar.questTemp.Patria.Hunter.Capture = sti(pchar.questTemp.Patria.Hunter.Capture)-1; // уменьшаем счетчик захваченных кораблей
					pchar.questTemp.Patria.Hunter.GiveShip = "true";
					log_Testinfo("Корабль есть и нужный товар есть на корабле!");
					if (sld.index == pchar.index)
					{
						pchar.Ship.Type = SHIP_NOTUSED;
					}
					else
					{
						RemoveCharacterCompanion(PChar, sld);
						AddPassenger(PChar, sld, false);
					}
				}
			}
		}
	}
}
// ---------------------------------------------------------- задание 8 ---------------------------------------------------------------
void Patria_SiegeBegin(string qName) // вестовой Пуанси
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Patria_FraOfficer");
	sld.dialog.currentnode = "fraofficer_2";
    ChangeCharacterAddressGroup(sld, "Charles_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Patria_SiegeHovernor() // 
{
	AddQuestRecord("Patria", "37");
	pchar.questTemp.Patria = "epizode_8";
	LocatorReloadEnterDisable("Charles_town", "reload1_back", true);
	LocatorReloadEnterDisable("Charles_town", "reload2_back", true);
	LocatorReloadEnterDisable("Charles_town", "gate_back", true);//закрыть выходы из города
}

void Patria_SiegeCreateSquadron() // осада 
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	pchar.questTemp.Patria.Escape = "true";
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	LocatorReloadEnterDisable("Charles_town", "reload1_back", false);
	LocatorReloadEnterDisable("Charles_town", "reload2_back", false);
	LocatorReloadEnterDisable("Charles_town", "gate_back", false);//открыть выходы из города
	Island_SetReloadEnableGlobal("Nevis", false);//закрыть остров
	// добавляем курьерский люггер
	sld = GetCharacter(NPC_GenerateCharacter("Patria_CureerCap", "off_fra_3", "man", "man", 25, FRANCE, -1, false, "soldier"));
	FantomMakeCoolSailor(sld, SHIP_CAREERLUGGER, "", CANNON_TYPE_CULVERINE_LBS8, 100, 100, 100);
	FantomMakeCoolFighter(sld, 25, 70, 70, "blade_11", "pistol1", "bullet", 50);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Ship.Mode = "war";
	SetCharacterRemovable(sld, false);
	sld.CompanionEnemyEnable = false; //всегда друзья
	SetCompanionIndex(pchar, -1, sti(sld.index));
	sld.loyality = MAX_LOYALITY;
	// прерывание на потерю
	pchar.quest.Patria_LuggerFail.win_condition.l1 = "NPC_Death";
	pchar.quest.Patria_LuggerFail.win_condition.l1.character = "Patria_CureerCap";
	pchar.quest.Patria_LuggerFail.function = "Patria_LuggerFail";
	// ставим осаду
	// линейник + военник голландцев
	for(int i = 1; i <= 3; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Patria_SiegeCap_"+i, "off_hol_"+(7-i), "man", "man", 35, HOLLAND, -1, true, "quest"));
		if (i == 1) 
		{
			sld.Ship.Type = GenerateShipHand(sld, SHIP_LSHIP_HOL, 42, 9500, 760, 10500, 350000, 13.5, 29.5, 0.38);
			sld.Ship.name = "Oliphant";
			SetBaseShipData(sld);
			sld.Ship.Cannons.Type = CANNON_TYPE_CULVERINE_LBS36;
			sld.rank = 45;
			SetShipSkill(sld, 80, 50, 100, 100, 100, 100, 100, 100, 80);
			SetCharacterPerk(sld, "MusketsShoot");
			SetCharacterPerk(sld, "Troopers");
			SetCharacterPerk(sld, "LongRangeGrappling");
			SetCharacterPerk(sld, "GrapplingProfessional");
			SetCharacterPerk(sld, "HullDamageUp");
			SetCharacterPerk(sld, "SailsDamageUp");
			SetCharacterPerk(sld, "CrewDamageUp");
			SetCharacterPerk(sld, "CriticalShoot");
			SetCharacterPerk(sld, "LongRangeShoot");
			SetCharacterPerk(sld, "FastReload");
			SetCharacterPerk(sld, "CannonProfessional");
			SetCharacterPerk(sld, "BasicBattleState");
			SetCharacterPerk(sld, "AdvancedBattleState");
			SetCharacterPerk(sld, "ShipDefenseProfessional");
			SetCharacterPerk(sld, "Carpenter");
			SetCharacterPerk(sld, "Builder");
			SetCharacterPerk(sld, "ShipSpeedUp");
			SetCharacterPerk(sld, "ShipTurnRateUp");
			SetCharacterPerk(sld, "StormProfessional");
			SetCharacterPerk(sld, "WindCatcher");
			SetCharacterPerk(sld, "SailsMan");
			SetCharacterPerk(sld, "SailingProfessional");
			SetCharacterPerk(sld, "Doctor1");
			SetCharacterPerk(sld, "Doctor2");
			FantomMakeCoolFighter(sld, 45, 80, 80, LinkRandPhrase("blade_18","blade_19","blade_20"), "pistol5", "bullet", 250);
			RealShips[sti(sld.Ship.Type)].ship.upgrades.hull = 1;
			UpgradeShipParameter(sld, "TurnRate");//маневренность
		}
		else 
		{
			FantomMakeCoolSailor(sld, SHIP_LINESHIP, "", CANNON_TYPE_CANNON_LBS32, 70, 70, 70);
			FantomMakeCoolFighter(sld, 35, 70, 70, LinkRandPhrase("blade_18","blade_19","blade_20"), "pistol5", "bullet", 200);
		}
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.cirassId = Items_FindItemIdx("cirass4");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysEnemy = true;
		sld.Coastal_Captain = true;
		sld.AlwaysSandbankManeuver = true;
		sld.Ship.Mode = "war";
		LAi_SetImmortal(sld, true);
		Character_SetAbordageEnable(sld, false); // нельзя абордировать
		sld.Abordage.MakeDisable = true; // запрет идти на абордаж
		sld.Abordage.Enable = false;
		if (i == 1 && MOD_SKILL_ENEMY_RATE > 4) sld.SeaBoss = 0.6; // получает на 60% меньше урона корпусу
		sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*5;
		sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*5;
		sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*5;
		sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*5;
		if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
		SetRandGeraldSail(sld, HOLLAND);
		if (i < 3) Group_AddCharacter("Patria_SiegeGroup1", "Patria_SiegeCap_"+i);
		else Group_AddCharacter("Patria_SiegeGroup2", "Patria_SiegeCap_"+i);
	}
	
	Group_SetGroupCommander("Patria_SiegeGroup1", "Patria_SiegeCap_1");
	Group_SetAddress("Patria_SiegeGroup1", "Nevis", "quest_ships", "quest_ship_2");
	Group_SetGroupCommander("Patria_SiegeGroup2", "Patria_SiegeCap_3");
	Group_SetAddress("Patria_SiegeGroup2", "Nevis", "quest_ships", "quest_ship_5");
	// военники испанцев
	for(i = 4; i <= 6; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Patria_SiegeCap_"+i, "off_spa_"+(8-i), "man", "man", 35, SPAIN, -1, true, "quest"));
		if (i == 4) FantomMakeCoolSailor(sld, SHIP_LINESHIP, "", CANNON_TYPE_CANNON_LBS32, 70, 70, 70);
		else FantomMakeCoolSailor(sld, SHIP_LINESHIP, "", CANNON_TYPE_CANNON_LBS24, 65, 65, 65);
		FantomMakeCoolFighter(sld, 35, 80, 80, LinkRandPhrase("blade_18","blade_19","blade_20"), "pistol5", "bullet", 150);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.cirassId = Items_FindItemIdx("cirass4");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysEnemy = true;
		sld.Coastal_Captain = true;
		sld.AlwaysSandbankManeuver = true;
		sld.Ship.Mode = "war";
		LAi_SetImmortal(sld, true);
		Character_SetAbordageEnable(sld, false); // нельзя абордировать
		sld.Abordage.MakeDisable = true; // запрет идти на абордаж
		sld.Abordage.Enable = false;
		sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*5;
		sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*5;
		sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*5;
		sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*5;
		if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
		SetRandGeraldSail(sld, SPAIN);
		if (i == 4) Group_AddCharacter("Patria_SiegeGroup3", "Patria_SiegeCap_"+i);
		else 
		{
			if (i == 5) Group_AddCharacter("Patria_SiegeGroup4", "Patria_SiegeCap_"+i);
			else Group_AddCharacter("Patria_SiegeGroup5", "Patria_SiegeCap_"+i);
		}
	}
	Group_SetGroupCommander("Patria_SiegeGroup3", "Patria_SiegeCap_4");
	Group_SetAddress("Patria_SiegeGroup3", "Nevis", "quest_ships", "quest_ship_6");
	Group_SetGroupCommander("Patria_SiegeGroup4", "Patria_SiegeCap_5");
	Group_SetAddress("Patria_SiegeGroup4", "Nevis", "quest_ships", "quest_ship_7");
	Group_SetGroupCommander("Patria_SiegeGroup5", "Patria_SiegeCap_6");
	Group_SetAddress("Patria_SiegeGroup5", "Nevis", "quest_ships", "quest_ship_8");
	for(i = 1; i <= 5; i++)
	{
		Group_SetTaskNone("Patria_SiegeGroup"+i);
		Group_LockTask("Patria_SiegeGroup"+i);
	}
	// прерывание на выход в море
	pchar.quest.Patria_Siege_escape.win_condition.l1 = "location";
	pchar.quest.Patria_Siege_escape.win_condition.l1.location = "Nevis";
	pchar.quest.Patria_Siege_escape.function = "Patria_SiegeEscapeReady";
	// на глобалку
	pchar.quest.Patria_Siege_map.win_condition.l1 = "MapEnter";
	pchar.quest.Patria_Siege_map.function = "Patria_SiegeEscapeOnMap";
	pchar.questTemp.Patria.Escape_count = 0;
	// таймер на 20 дней, после этого Капстервиль падет и станет голландским
	SetFunctionTimerCondition("Patria_SiegeCapitulation", 0, 0, 20, false);
	// Дойли настоящего прячем
	sld = characterFromId("PortRoyal_Mayor");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld.quest.meeting = "1"; // если не было
}

void Patria_SiegeCapitulation(string qName) // Капстервиль капитулировал, полный провал
{
	AddQuestRecord("Patria", "41");
	sld = CharacterFromID("Villemstad Fort Commander"); // бессмертный форт Виллемстада
	LAi_SetImmortal(sld, false);
	// Дойли на место
	Group_DeleteGroup("Patria_EngSquadron");
	sld = characterFromId("PortRoyal_Mayor");
	LAi_SetHuberType(sld);
	ChangeCharacterAddressGroup(sld, "PortRoyal_townhall", "sit", "sit1");
	LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
	if (GetCharacterIndex("Doily") != -1)
	{
		sld.lifeday = 0;
	}
	if (GetCharacterIndex("Doily_land") != -1)
	{
		ChangeCharacterAddressGroup(sld, "none", "", "");
		sld.lifeday = 0;
	}
	// Пуанси убираем 
	sld = characterFromId("Puancie");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	// губера переделываем
	sld = characterFromId("Charles_Mayor");
	sld.model = "off_hol_6";
	Characters_RefreshModel(sld);
	sld.name 	= "Lenart";
    sld.lastname = "Klap";
	sld.nation = HOLLAND;
	LAi_group_MoveCharacter(sld, "HOLLAND_CITIZENS");
	// меняем нацию колонии
	int i = FindColony("Charles");
	colonies[i].nation = HOLLAND;
	string sColony = "Charles_town";
	worldMap.labels.(sColony).icon = HOLLAND;
        Island_SetReloadEnableGlobal("Nevis", true); // belamour
	// убираем осадную эскадру
	for(i = 1; i <= 5; i++)
	{
		Group_DeleteGroup("Patria_SiegeGroup"+i);
	}
	// убираем Эклятон
	Group_DeleteGroup("Ecliaton_group");
	// репутация и прочее
	RemoveItems(pchar, "patent_fra", 1);
	RemoveItems(pchar, "Reserve_item_01", 1);
	ChangeCharacterComplexReputation(pchar, "nobility", -20);
	ChangeCharacterComplexReputation(pchar, "authority", -10);
	ChangeCharacterNationReputation(pchar, FRANCE, -30);
	pchar.questTemp.Patria = "fail";
	CloseQuestHeader("Patria");
	// вернуть Синт-Маартен в норму
	int n = FindIsland("SentMartin");
	Islands[n].reload.l1.radius = 600.0;
	LocatorReloadEnterDisable("Marigo_ExitTown", "reload3", false); // открыть городские ворота
	sld = CharacterFromID("Marigo Fort Commander");
	LAi_SetImmortal(sld, false);
	Character_SetAbordageEnable(sld, true);
}

void Patria_LuggerFail(string qName) // потеря люггера
{
	pchar.questTemp.Patria.FailLugger = "true";
	AddQuestRecord("Patria", "39");
}

void Patria_SiegeEscapeReady(string qName) // 
{
	DoQuestFunctionDelay("Patria_SiegeEscape", 20.0);
}

void Patria_SiegeEscape(string qName) // вышли в море, начинаем подгружать три корабля противника
{
	if (pchar.location != "Nevis") return;
	pchar.questTemp.Patria.Escape_count = sti(pchar.questTemp.Patria.Escape_count)+1;
	if (sti(pchar.questTemp.Patria.Escape_count) > 3) return;
	PlaySound("interface\notebook.wav");
	PlaySound("interface\_EvEnemy0.wav");
	string sGroup = "Patria_EscapeSeaGroup_"+sti(pchar.questTemp.Patria.Escape_count);
	Group_FindOrCreateGroup(sGroup);
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE+3;
	if (iRank > 45) iRank = 45;
	int iShip, iCannon;
	
	switch (MOD_SKILL_ENEMY_RATE)
	{
		case 2:
			iShip = SHIP_CORVETTE + rand(2);
			iCannon = CANNON_TYPE_CANNON_LBS20;
		break;
		
		case 4:
			iShip = SHIP_CORVETTE + rand(2);
			iCannon = CANNON_TYPE_CULVERINE_LBS18;
		break;
		
		case 6:
			iShip = SHIP_GALEON_H + rand(1);
			iCannon = CANNON_TYPE_CANNON_LBS24;
		break;
		
		case 8:
			iShip = SHIP_GALEON_H + rand(2);
			iCannon = CANNON_TYPE_CANNON_LBS24;
		break;
		
		case 10:
			iShip = SHIP_FRIGATE_H + rand(1);
			if (iShip == SHIP_LINESHIP) iCannon = CANNON_TYPE_CANNON_LBS32;
			else iCannon = CANNON_TYPE_CANNON_LBS24;
		break;
	}
	sld = GetCharacter(NPC_GenerateCharacter(sGroup+"_Cap", "off_hol_"+(rand(2)+1), "man", "man", iRank, HOLLAND, 2, true, "quest"));
	FantomMakeCoolSailor(sld, iShip, "", iCannon, 70, 70, 70);
	FantomMakeCoolFighter(sld, iRank, 70, 70, LinkRandPhrase("blade_09","blade_12","blade_13"), "pistol1", "bullet", 150);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.AlwaysEnemy = true;
	sld.Ship.Mode = "war";
	sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*6;
	sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*6;
	sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*6;
	sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*6;
	if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
	Group_AddCharacter(sGroup, sGroup+"_Cap");
	Group_SetGroupCommander(sGroup, sGroup+"_Cap");
	Group_SetTaskAttack(sGroup, PLAYER_GROUP);
	Group_LockTask(sGroup);
	Sea_LoginGroupCurrentSea(sGroup);
	DoQuestFunctionDelay("Patria_SiegeEscapeReady", 180.0); // 3 минуты до следующего корабля
}

void Patria_SiegeEscapeOnMap(string qName) // 
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	if (!CheckAttribute(pchar, "questTemp.Patria.FailLugger"))
	{
		pchar.quest.Patria_LuggerFail.over = "yes";
		sld = characterFromId("Patria_CureerCap");
		RemoveCharacterCompanion(pchar, sld);
		sld.lifeday = 0;
		AddQuestRecord("Patria", "40");
	}
	// ставим эскадру клона Дойли у Антигуа
	int iShip, iCannon;
	sld = GetCharacter(NPC_GenerateCharacter("Doily", "huber_9", "man", "man", 45, ENGLAND, -1, true, "quest"));
	sld.name = "Edward";
    sld.lastname = "Doily";
	sld.Dialog.Filename = "Quest\Patria_NPC.c";
	sld.dialog.currentnode = "doily_10";
	FantomMakeCoolSailor(sld, SHIP_LSHIP_ENG, "Trafalgar", CANNON_TYPE_CULVERINE_LBS36, 100, 100, 100);
	FantomMakeCoolFighter(sld, 45, 100, 100, "blade_20", "pistol5", "bullet", 250);
	SetSelfSkill(sld, 90, 90, 90, 90, 90);
	SetShipSkill(sld, 90, 100, 100, 100, 100, 100, 100, 100, 70);
	sld.cirassId = Items_FindItemIdx("cirass4");
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true;
	sld.AlwaysSandbankManeuver = true;
	sld.Ship.Mode = "war";
	sld.DontDeskTalk = true; // не высылать шлюпку
	LAi_SetImmortal(sld, true); // не забыть снять
	sld.ShipHideImmortal = 1000; // непотопляемый корабль
	Character_SetAbordageEnable(sld, false); // нельзя абордировать
	sld.Tasks.CanBoarding = false; // запрет идти на абордаж - дубль
	sld.Tasks.CanChangeShipAfterBoarding = false; // запрет меняться кораблями - дубль
	sld.Abordage.Enable = false;
	sld.SeaBoss = 0.5; // получает на 50% меньше урона корпусу
	sld.ship.Crew.Morale = 100;
	sld.Ship.Crew.Exp.Sailors = 100;
	sld.Ship.Crew.Exp.Cannoners = 100;
	sld.Ship.Crew.Exp.Soldiers = 100;
	SetCharacterPerk(sld, "MusketsShoot");
	SetRandGeraldSail(sld, ENGLAND);
	Group_AddCharacter("Patria_EngSquadron", "Doily");
	for(int i = 2; i <= 4; i++)
	{
		switch (i)
		{
			case 2: 
				iShip = SHIP_LINESHIP;
				iCannon = CANNON_TYPE_CANNON_LBS32;	
			break;
			case 3: 
				iShip = SHIP_LINESHIP; 
				iCannon = CANNON_TYPE_CANNON_LBS24;
			break;
			case 4: 
				iShip = SHIP_FRIGATE_H; 
				iCannon = CANNON_TYPE_CANNON_LBS24;
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("Patria_EngSquadronCap_"+i, "off_eng_"+(6-i), "man", "man", 42-(i*3), ENGLAND, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, 100, 100, 100);
		FantomMakeCoolFighter(sld, 42-(i*3), 100, 100, LinkRandPhrase("blade_18","blade_19","blade_20"), "pistol5", "bullet", 250);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.cirassId = Items_FindItemIdx("cirass4");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysFriend = true;
		sld.ShipEnemyDisable = true;
		sld.AlwaysSandbankManeuver = true;
		sld.Ship.Mode = "war";
		LAi_SetImmortal(sld, true); // не забыть снять
		sld.ship.Crew.Morale = 90;
		sld.Ship.Crew.Exp.Sailors = 90;
		sld.Ship.Crew.Exp.Cannoners = 90;
		sld.Ship.Crew.Exp.Soldiers = 90;
		SetCharacterPerk(sld, "MusketsShoot");
		SetRandGeraldSail(sld, ENGLAND);
		Group_AddCharacter("Patria_EngSquadron", "Patria_EngSquadronCap_"+i);
	}
	Group_SetGroupCommander("Patria_EngSquadron", "Doily");
	Group_SetAddress("Patria_EngSquadron", "Antigua", "quest_ships", "quest_ship_1");
	Group_SetTaskNone("Patria_EngSquadron");
	Group_LockTask("Patria_EngSquadron");
	// в резиденцию еще один клон
	sld = GetCharacter(NPC_GenerateCharacter("Doily_land", "huber_9", "man", "man", 45, ENGLAND, -1, true, "quest"));
	sld.name = "Edward";
    sld.lastname = "Doily";
	sld.Dialog.Filename = "Quest\Patria_NPC.c";
	sld.dialog.currentnode = "doily";
	FantomMakeCoolFighter(sld, 45, 100, 100, "blade_20", "pistol5", "bullet", 250);
	SetSelfSkill(sld, 90, 90, 90, 90, 90);
	SetShipSkill(sld, 90, 100, 100, 100, 100, 100, 100, 100, 70);
	LAi_SetStayType(sld);
	ChangeCharacterAddressGroup(sld, "SentJons_Roomtownhall", "goto", "goto4");
	LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
}

void Patria_SiegeAddEngSquadron() // присоединяем эскадру Дойли
{
	pchar.quest.Patria_SiegeCapitulation.over = "yes"; //снять таймер
	// ремонтируем все осадные корабли и ставим их в две линии
	for(int i = 2; i <= 5; i++)
	{
		Group_DelCharacter("Patria_SiegeGroup"+i, "Patria_SiegeCap_"+(i+1));
	}
	Group_AddCharacter("Patria_SiegeGroup1", "Patria_SiegeCap_3"); // голландцы в одну группу
	for(i = 4; i <= 6; i++)
	{
		Group_AddCharacter("Patria_SiegeGroup2", "Patria_SiegeCap_"+i); // испанцы во вторую группу
	}
	for(i = 3; i <= 5; i++)
	{
		Group_DeleteGroup("Patria_SiegeGroup"+i); // лишнее удаляем
	}
	Group_SetAddress("Patria_SiegeGroup1", "Nevis", "quest_ships", "quest_ship_1");
	Group_SetAddress("Patria_SiegeGroup2", "Nevis", "quest_ships", "quest_ship_2");
	for(i = 1; i <= 6; i++) // чиним и пополняем боеприпасы, снимаем квестовое бессмертие
	{
		sld = characterFromId("Patria_SiegeCap_"+i);
		DeleteAttribute(sld, "ship.sails");
		DeleteAttribute(sld, "ship.blots");
		DeleteAttribute(sld, "ship.masts");
		DeleteAttribute(sld, "ship.hulls");
		AddCharacterGoods(sld, GOOD_BALLS, 1800);
		AddCharacterGoods(sld, GOOD_GRAPES, 1000);
		AddCharacterGoods(sld, GOOD_KNIPPELS, 700);
		AddCharacterGoods(sld, GOOD_BOMBS, 1500);
		AddCharacterGoods(sld, GOOD_POWDER, 5000);
		LAi_SetImmortal(sld, false);
		Character_SetAbordageEnable(sld, true); // можно абордировать
		DeleteAttribute(sld, "Abordage.MakeDisable");
		sld.Abordage.Enable = true;
	}
	// Дойли в компаньоны
	Group_DeleteGroup("Patria_EngSquadron");
	sld = characterFromId("Doily");
	SetCharacterRemovable(sld, false);
	sld.CompanionEnemyEnable = false; //всегда друзья
	SetCompanionIndex(pchar, -1, sti(sld.index));
	sld.loyality = MAX_LOYALITY;
	LAi_SetImmortal(sld, false);
	pchar.questTemp.Patria.Trafalgar = "true";
	for(i = 2; i <= 4; i++) 
	{
		sld = characterFromId("Patria_EngSquadronCap_"+i);
		SetCharacterRemovable(sld, false);
		sld.CompanionEnemyEnable = false; //всегда друзья
		SetCompanionIndex(pchar, -1, sti(sld.index));
		sld.loyality = MAX_LOYALITY;
		LAi_SetImmortal(sld, false);
	}
	SetFunctionTimerCondition("Patria_SiegeReturnToHelp", 0, 0, 7, false); // таймер 7 дней
	// прерывание на вход к Сент-Кристоферу
	pchar.quest.Patria_SiegeBattle.win_condition.l1 = "location";
	pchar.quest.Patria_SiegeBattle.win_condition.l1.location = "Nevis";
	pchar.quest.Patria_SiegeBattle.function = "Patria_SiegeSeaBattle";
}

void Patria_SiegeReturnToHelp(string qName) // не дошли за 7 дней
{
	pchar.quest.Patria_SiegeBattle.over = "yes"; 
	sld = characterFromId("Doily");
	LAi_SetImmortal(sld, true);
	RemoveCharacterCompanion(pchar, sld);
	sld.lifeday = 0;
	DeleteAttribute(pchar, "questTemp.Patria.Trafalgar");
	sld = characterFromId("PortRoyal_Mayor");
	LAi_SetHuberType(sld);
	ChangeCharacterAddressGroup(sld, "PortRoyal_townhall", "sit", "sit1");
	LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
	for(int i = 2; i <= 4; i++) 
	{
		sld = characterFromId("Patria_EngSquadronCap_"+i);
		LAi_SetImmortal(sld, true);
		RemoveCharacterCompanion(pchar, sld);
		sld.lifeday = 0;
	}
	sld = CharacterFromID("Villemstad Fort Commander"); // бессмертный форт Виллемстада
	LAi_SetImmortal(sld, false);
	// убираем осадную эскадру
	for(i = 1; i <= 2; i++)
	{
		Group_DeleteGroup("Patria_SiegeGroup"+i);
	}
	// убираем Эклятон
	Group_DeleteGroup("Ecliaton_group");
	// репутация и прочее
	RemoveItems(pchar, "patent_fra", 1);
	ChangeCharacterComplexReputation(pchar, "nobility", -15);
	ChangeCharacterComplexReputation(pchar, "authority", -15);
	ChangeCharacterNationReputation(pchar, FRANCE, -10);
	pchar.questTemp.Patria = "fail";
	AddQuestRecord("Patria", "43");
	CloseQuestHeader("Patria");
	// вернуть Синт-Маартен в норму
	int n = FindIsland("SentMartin");
	Islands[n].reload.l1.radius = 600.0;
	LocatorReloadEnterDisable("Marigo_ExitTown", "reload3", false); // открыть городские ворота
	sld = CharacterFromID("Marigo Fort Commander");
	LAi_SetImmortal(sld, false);
	Character_SetAbordageEnable(sld, true);
}

void Patria_SiegeSeaBattle(string qName) // 
{
	DoQuestFunctionDelay("Patria_SiegeSeaBattleGo", 2.0);
}

void Patria_SiegeSeaBattleGo(string qName) // бой эскадра на эскадру
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	pchar.quest.Patria_SiegeReturnToHelp.over = "yes"; 
	bQuestDisableMapEnter = true;//закрыть карту
	// выводим англичан из подчинения
	sld = characterFromId("Doily");
	RemoveCharacterCompanion(pchar, sld);
	Group_AddCharacter("Patria_EngSquadron", "Doily");
	DeleteAttribute(pchar, "questTemp.Patria.Trafalgar");
	for(int i = 2; i <= 4; i++) 
	{
		sld = characterFromId("Patria_EngSquadronCap_"+i);
		RemoveCharacterCompanion(pchar, sld);
		Group_AddCharacter("Patria_EngSquadron", "Patria_EngSquadronCap_"+i);
	}
	Group_SetGroupCommander("Patria_EngSquadron", "Doily");
	Group_SetTaskAttack("Patria_SiegeGroup1", PLAYER_GROUP);
	Group_SetTaskAttack("Patria_SiegeGroup2", PLAYER_GROUP);
	Group_SetTaskAttack("Patria_SiegeGroup1", "Patria_EngSquadron");
	Group_SetTaskAttack("Patria_SiegeGroup2", "Patria_EngSquadron");
	if (!CheckAttribute(pchar, "questTemp.Patria.FailLugger")) DoQuestFunctionDelay("Patria_SiegeSeaBattleAddEcliaton", 5.0);
	// прерывание на уничтожение врага
	pchar.quest.Patria_Siege_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Patria_Siege_AfterBattle.win_condition.l1.group = "Patria_SiegeGroup1";
	pchar.quest.Patria_Siege_AfterBattle.win_condition.l2 = "Group_Death";
	pchar.quest.Patria_Siege_AfterBattle.win_condition.l2.group = "Patria_SiegeGroup2";
	pchar.quest.Patria_Siege_AfterBattle.function = "Patria_SiegeSeaBattleFin";
}

void Patria_SiegeSeaBattleAddEcliaton(string qName) // подгружаем Эклятон
{
	Sea_LoginGroupCurrentSea("Ecliaton_group");
	sld = characterFromId("Ecliaton_Cap");
	DeleteAttribute(sld, "ShipHideImmortal");
	SetCharacterRemovable(sld, false);
	sld.CompanionEnemyEnable = false; //всегда друзья
	SetCompanionIndex(pchar, -1, sti(sld.index));
	sld.loyality = MAX_LOYALITY;
	LAi_SetImmortal(sld, false);
	pchar.questTemp.Patria.Ecliaton = "true";
	// прерывание на потерю Эклятона
	pchar.quest.Patria_EcliatonFail.win_condition.l1 = "NPC_Death";
	pchar.quest.Patria_EcliatonFail.win_condition.l1.character = "Ecliaton_Cap";
	pchar.quest.Patria_EcliatonFail.function = "Patria_SiegeEcliatonFail";
}

void Patria_SiegeEcliatonFail(string qName) // 
{
	DeleteAttribute(pchar, "questTemp.Patria.Ecliaton");
	pchar.questTemp.Patria.Ecliaton_Fail = "true";
}

void Patria_SiegeSeaBattleFin(string qName) // победили
{
	Island_SetReloadEnableGlobal("Nevis", true);//открыть остров
	pchar.GenQuest.MapClosedNoBattle = true;
	Group_DeleteGroup("Patria_SiegeGroup1");
	Group_DeleteGroup("Patria_SiegeGroup2");
	AddQuestRecord("Patria", "44");
	pchar.questTemp.Patria = "epizode_8_return";
	pchar.quest.Patria_Siege_Fin.win_condition.l1 = "location";
	pchar.quest.Patria_Siege_Fin.win_condition.l1.location = "Charles_RoomTownhall";
	pchar.quest.Patria_Siege_Fin.function = "Patria_SiegeFin";
	sld = characterFromId("Doily");
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true;
	LAi_SetImmortal(sld, true);
	Group_AddCharacter("Patria_EngSquadron", "Doily");
	for(int i = 2; i <= 4; i++) 
	{
		sld = characterFromId("Patria_EngSquadronCap_"+i);
		sld.AlwaysFriend = true;
		sld.ShipEnemyDisable = true;
		LAi_SetImmortal(sld, true);
	}
}

void Patria_SiegeFin(string qName) // у Пуанси
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Doily_land");
	ChangeCharacterAddressGroup(sld, "Charles_Roomtownhall", "goto", "goto1");
	LAi_SetActorType(sld);
	LAi_ActorFollow(sld, pchar, "", -1);
}

void Patria_SiegeEnd() //
{
	chrDisableReloadToLocation = false;
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	// отсоединяем Эклятон
	if (!CheckAttribute(pchar, "questTemp.Patria.Ecliaton_Fail"))
	{
		sld = characterFromId("Ecliaton_Cap");
		sld.ShipHideImmortal = 1000; // непотопляемый корабль
		RemoveCharacterCompanion(pchar, sld);
		sld.AlwaysFriend = true;
		sld.ShipEnemyDisable = true;
		Group_AddCharacter("Ecliaton_group", "Ecliaton_Cap");
		Group_SetGroupCommander("Ecliaton_group", "Ecliaton_Cap");
		Group_SetAddress("Ecliaton_group", "Nevis", "quest_ships", "quest_ship_1");
		Group_SetTaskNone("Ecliaton_group");
		Group_LockTask("Ecliaton_group");
		SetFunctionTimerCondition("Patria_EcliatonRepair", 0, 0, 5, false); // таймер на починку Эклятона
		DeleteAttribute(pchar, "questTemp.Patria.Ecliaton");
	}
	// Дойли и его эскадра
	sld = characterFromId("Doily");
	LAi_SetActorType(sld);
	sld.DontDeskTalk = true;
	Group_SetAddress("Patria_EngSquadron", "Nevis", "quest_ships", "quest_ship_2");
	SetFunctionTimerCondition("Patria_BastionStart", 0, 0, 7, false);
	SetFunctionTimerCondition("Patria_BastionTimeOver", 0, 0, 30, false);
	LocatorReloadEnterDisable("Charles_Townhall", "reload3", true);
}

// ---------------------------------------------------------- задание 9 ---------------------------------------------------------------
void Patria_BastionStart(string qName) // начало 9 эпизода
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	AddQuestRecord("Patria", "46");
	pchar.questTemp.Patria = "epizode_9_start";
	LocatorReloadEnterDisable("Charles_Townhall", "reload3", false);
	// Дойли на место
	sld = characterFromId("Doily_land");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	Group_DeleteGroup("Patria_EngSquadron");
	sld = characterFromId("Doily");
	Group_AddCharacter("Patria_EngSquadron", "Doily");
	Group_SetAddress("Patria_EngSquadron", "Jamaica", "quest_ships", "quest_ship_1");
	DeleteAttribute(sld, "ship.sails");
    DeleteAttribute(sld, "ship.blots");
    DeleteAttribute(sld, "ship.masts");
	DeleteAttribute(sld, "ship.hulls");
	//sld.ship.HP = 10500;
	sld = characterFromId("PortRoyal_Mayor");
	LAi_SetHuberType(sld);
	ChangeCharacterAddressGroup(sld, "PortRoyal_townhall", "sit", "sit1");
	LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
}

void Patria_BastionTimeOver(string qName) // провал по времени 9 эпизода
{
	AddQuestRecord("Patria", "47");
	RemoveItems(pchar, "patent_fra", 1);
	ChangeCharacterComplexReputation(pchar, "nobility", -10);
	ChangeCharacterComplexReputation(pchar, "authority", -5);
	ChangeCharacterNationReputation(pchar, FRANCE, -10);
	pchar.questTemp.Patria = "fail";
	CloseQuestHeader("Patria");
	// вернуть Синт-Маартен в норму
	int n = FindIsland("SentMartin");
	Islands[n].reload.l1.radius = 600.0;
	LocatorReloadEnterDisable("Marigo_ExitTown", "reload3", false); // открыть городские ворота
	sld = CharacterFromID("Marigo Fort Commander");
	LAi_SetImmortal(sld, false);
	Character_SetAbordageEnable(sld, true);
}

void Patria_BastionFrigateGlp() // присоединяем фрегат на Гваделупе
{
	sld = GetCharacter(NPC_GenerateCharacter("Patria_GlpCap", "off_fra_2", "man", "man", 30, FRANCE, -1, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_FRIGATE, "", CANNON_TYPE_CANNON_LBS24, 60, 60, 60);
	FantomMakeCoolFighter(sld, 30, 60, 60, LinkRandPhrase("blade_09","blade_12","blade_13"), "pistol5", "bullet", 150);
	sld.Ship.Mode = "war";
	sld.ship.Crew.Morale = 90;
	sld.Ship.Crew.Exp.Sailors = 80;
	sld.Ship.Crew.Exp.Cannoners = 80;
	sld.Ship.Crew.Exp.Soldiers = 90;
	sld.reputation = 70;
	sld.alignment = "good";
	SetCharacterRemovable(sld, false);
	sld.CompanionEnemyEnable = false; //всегда друзья
	SetCompanionIndex(pchar, -1, sti(sld.index));
	sld.loyality = MAX_LOYALITY;
}

void Patria_BastionFrigateMrt() // присоединяем фрегат на Мартинике
{
	sld = GetCharacter(NPC_GenerateCharacter("Patria_MrtCap", "off_fra_3", "man", "man", 33, FRANCE, -1, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_FRIGATE_H, "", CANNON_TYPE_CANNON_LBS24, 65, 65, 65);
	FantomMakeCoolFighter(sld, 33, 65, 65, LinkRandPhrase("blade_09","blade_12","blade_13"), "pistol5", "bullet", 150);
	sld.Ship.Mode = "war";
	sld.ship.Crew.Morale = 95;
	sld.Ship.Crew.Exp.Sailors = 85;
	sld.Ship.Crew.Exp.Cannoners = 85;
	sld.Ship.Crew.Exp.Soldiers = 95;
	sld.reputation = 70;
	sld.alignment = "good";
	SetCharacterRemovable(sld, false);
	sld.CompanionEnemyEnable = false; //всегда друзья
	SetCompanionIndex(pchar, -1, sti(sld.index));
	sld.loyality = MAX_LOYALITY;
}

void Patria_BastionAddEcliaton() // присоединяем Эклятон
{
	sld = characterFromId("Ecliaton_Cap");
	DeleteAttribute(sld, "ShipHideImmortal");
	SetCharacterRemovable(sld, false);
	sld.CompanionEnemyEnable = false; //всегда друзья
	SetCompanionIndex(pchar, -1, sti(sld.index));
	sld.loyality = MAX_LOYALITY;
	pchar.questTemp.Patria.Ecliaton = "true";
	// прерывание на потерю Эклятона
	pchar.quest.Patria_EcliatonFail.win_condition.l1 = "NPC_Death";
	pchar.quest.Patria_EcliatonFail.win_condition.l1.character = "Ecliaton_Cap";
	pchar.quest.Patria_EcliatonFail.function = "Patria_EcliatonFail";
	// удаление группы Эклятона, иначе клон-призрак
	pchar.quest.Patria_EcliatonDelGroup.win_condition.l1 = "ExitFromSea";
	pchar.quest.Patria_EcliatonDelGroup.function = "Patria_EcliatonDelGroup";
}

void Patria_BastionSturmTimeOver(string qName) // провал по времени взятие Филипсбурга
{
	DeleteAttribute(pchar, "TempPerks.QuestTroopers");
	if (!CheckAttribute(pchar, "questTemp.Patria.Ecliaton_Fail"))
	{
		pchar.quest.Patria_EcliatonFail.over = "yes"; //снять прерывание
		sld = characterFromId("Ecliaton_Cap");
		sld.ShipHideImmortal = 1000; // непотопляемый корабль
		sld.lifeday = 0;
		RemoveCharacterCompanion(pchar, sld);
		sld.AlwaysFriend = true;
		sld.ShipEnemyDisable = true;
		DeleteAttribute(pchar, "questTemp.Patria.Ecliaton");
	}
	if (GetCharacterIndex("Patria_GlpCap") != -1)
	{
		sld = characterFromId("Patria_GlpCap");
		sld.ShipHideImmortal = 1000; // непотопляемый корабль
		sld.lifeday = 0;
		RemoveCharacterCompanion(pchar, sld);
		sld.AlwaysFriend = true;
		sld.ShipEnemyDisable = true;
	}
	if (GetCharacterIndex("Patria_MrtCap") != -1)
	{
		sld = characterFromId("Patria_MrtCap");
		sld.ShipHideImmortal = 1000; // непотопляемый корабль
		sld.lifeday = 0;
		RemoveCharacterCompanion(pchar, sld);
		sld.AlwaysFriend = true;
		sld.ShipEnemyDisable = true;
	}
	AddQuestRecord("Patria", "49");
	RemoveItems(pchar, "patent_fra", 1);
	ChangeCharacterComplexReputation(pchar, "nobility", -10);
	ChangeCharacterComplexReputation(pchar, "authority", -5);
	ChangeCharacterNationReputation(pchar, FRANCE, -10);
	pchar.questTemp.Patria = "fail";
	CloseQuestHeader("Patria");
}

void Patria_BastionSintMartenCapture() // Филипсбург капитулировал
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	pchar.quest.Patria_BastionSturmTimeOver.over = "yes"; //снять таймер
	pchar.GenQuest.Hunter2Pause = true;
	pchar.GenQuest.CannotWait = true;
	sld = characterFromId("Marigo_Mayor");
	ChangeCharacterAddressGroup(sld, "Marigo_townhall", "goto", "governor1");
	LAi_SetStayType(sld);
	characters[GetCharacterIndex("Marigo_Mayor")].dialog.captureNode = "tomas"; //капитулянтская нода мэра
	LocatorReloadEnterDisable("Marigo_town", "gate_back", true);//закрыть выход из города
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	AddQuestRecord("Patria", "50");
	sld = characterFromId("Ecliaton_Cap");
	sld.dialog.currentnode = "ecliaton_cap_wait";
	sld.DeckDialogNode = "ecliaton_cap_wait"; // страховка от шибко грамотных
	// преобразуем локации
	// меняем локаторы бухты Гран Кейс
	int n = Findlocation("Shore40"); 
	Locations[n].models.always.locators = "shore08_locators_PTR";
	locations[n].reload.l3.name = "reload2_back";
	locations[n].reload.l3.go = "Location_reserve_01";
	locations[n].reload.l3.emerge = "reload2";
	locations[n].reload.l3.autoreload = "1";
	locations[n].reload.l3.label = "Beach";
	// локация пляжа к руднику
	n = Findlocation("Location_reserve_01"); 
	DeleteAttribute(&locations[n], "id.label");
	locations[n].id.label = "Shore40";
	locations[n].image = "loading\outside\harbor3.tga";
	locations[n].worldmap = "Shore40";
	locations[n].type = "seashore";
	locations[n].islandId = "SentMartin";
	locations[n].DisableEncounters = true;
	locations[n].Chestgennot = true; // не генерить сундуки
	locations[n].filespath.models = "locations\Outside\Shores\Shore13";
	Locations[n].models.always.jungle = "shore13";
	locations[n].models.always.jungle.sea_reflection = 1;
	Locations[n].models.always.shore13seabed = "shore13_seabed";
	Locations[n].models.always.locators = "shore13_locators_PTR";
	Locations[n].models.always.l1 = "plan1";
	Locations[n].models.always.l1.level = 9;
	Locations[n].models.always.l1.tech = "LocationModelBlend";
	Locations[n].models.always.l2 = "plan2";
	Locations[n].models.always.l2.level = 8;
	Locations[n].models.always.l2.tech = "LocationModelBlend";
	Locations[n].models.always.l3 = "plan3";
	Locations[n].models.always.l3.level = 7;
	Locations[n].models.always.l3.tech = "LocationModelBlend";	
	Locations[n].models.always.grassPatch = "shore13_grass";
	Locations[n].models.always.grassPatch.texture = "grass\grassshore.tga.tx";
	locations[n].models.day.charactersPatch = "shore13_patch";
	locations[n].models.night.charactersPatch = "shore13_patch";		
	locations[n].environment.weather = "true";
	locations[n].environment.sea = "true";	
	locations[n].reload.l1.name = "reload1_back";
	locations[n].reload.l1.go = "Location_reserve_03"; // на рудник
	locations[n].reload.l1.emerge = "reload2";
	locations[n].reload.l1.autoreload = "1";
	locations[n].reload.l1.label = "Mines";
	locations[n].locators_radius.reload.reload1_back = 8.0;
	
	locations[n].reload.l2.name = "reload2_back";
	locations[n].reload.l2.go = "Shore40";
	locations[n].reload.l2.emerge = "reload2";
	locations[n].reload.l2.autoreload = "1";
	locations[n].reload.l2.label = "Shore40";
    locations[n].locators_radius.reload2_back = 2.0;
	// локация соляного рудника
	n = Findlocation("Location_reserve_03"); 
	DeleteAttribute(&locations[n], "models.always.l1");
	DeleteAttribute(&locations[n], "models.always.l2");
	DeleteAttribute(&locations[n], "models.always.l3");
	locations[n].id.label = "Mines";
	locations[n].worldmap = "Shore40";
	locations[n].islandId = "SentMartin";
    Locations[n].image = "Loading\Mine.tga";
	locations[n].type = "questisland";
	locations[n].filespath.models = "Locations\Mine";
	locations[n].models.always.jungle = "mine";
	locations[n].models.always.barricade = "mine_barricade";
	//locations[n].models.always.mortair1 = "mine_mortar2mine";
	locations[n].models.always.mortair2 = "mine_mortar2gate";
    locations[n].models.always.locators = "minentown_locators_PTR";
    locations[n].models.always.grassPatch = "mine_grass";
	locations[n].models.day.charactersPatch = "mine_patch_storyline";
	locations[n].models.day.fonar = "mine_fd";
	locations[n].models.night.charactersPatch = "mine_patch_storyline";
	locations[n].models.night.fonar = "mine_fn";
	locations[n].environment.weather = "true";
	locations[n].environment.sea = "false";

	Locations[n].reload.l2.name = "reload2_back";
    Locations[n].reload.l2.go = "Location_reserve_01";
    Locations[n].reload.l2.emerge = "reload1";
    Locations[n].reload.l2.autoreload = "1";
    Locations[n].reload.l2.label = "Beach";
}

void Patria_BastionShore(string qName) // в бухте, ставим штурмовую роту
{
	for (int i=1; i<=15; i++)
	{
		if (i < 4) // мушкетеры, 3 шт
		{
			sld = GetCharacter(NPC_GenerateCharacter("Bastion_soldier_"+i, "mush_fra_"+i, "man", "mushketer", 30, FRANCE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, 30, 60, 60, "", "mushket2", "cartridge", 170);
			LAi_SetCharacterUseBullet(sld, "cartridge");
			sld.cirassId = Items_FindItemIdx("cirass1");
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Bastion_soldier_"+i, "sold_fra_"+(rand(7)+1), "man", "man", 30, FRANCE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, 30, 60, 60, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", 150);
			sld.cirassId = Items_FindItemIdx("cirass2");
		}
		ChangeCharacterAddressGroup(sld, "shore40", "goto", "goto1");
		LAi_SetActorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		LAi_ActorFollow(sld, pchar, "", -1);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
	}
	pchar.quest.Patria_BastionMarch.win_condition.l1 = "location";
	pchar.quest.Patria_BastionMarch.win_condition.l1.location = "Location_reserve_01";
	pchar.quest.Patria_BastionMarch.function = "Patria_BastionMarch";
}

void Patria_BastionMarch(string qName) // пляж перед рудником
{
	LocatorReloadEnterDisable("Location_reserve_01", "reload2_back", true); // закрыть выход назад
	for (int i=1; i<=15; i++)
	{
		sld = CharacterFromID("Bastion_soldier_"+i);
		ChangeCharacterAddressGroup(sld, "Location_reserve_01", "reload", "reload2_back");
		LAi_SetActorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		LAi_ActorFollow(sld, pchar, "", -1);
	}
	pchar.quest.Patria_BastionMineAttack.win_condition.l1 = "location";
	pchar.quest.Patria_BastionMineAttack.win_condition.l1.location = "Location_reserve_03";
	pchar.quest.Patria_BastionMineAttack.function = "Patria_BastionMineAttack";
}

void Patria_BastionMineAttack(string qName) // соляной рудник - бой
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	LAi_group_Delete("EnemyFight");
	chrDisableReloadToLocation = true;//закрыть локацию
	for (int i=1; i<=15; i++)
	{
		sld = CharacterFromID("Bastion_soldier_"+i);
		ChangeCharacterAddressGroup(sld, "Location_reserve_03", "reload", "reload2_back");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	int iRank = 15+MOD_SKILL_ENEMY_RATE*3;
	// ставим 6 накрученных гранатометчиков
	for (i=1; i<=6; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Bastion_spa_gunner_"+i, "mush_spa_"+i, "man", "mushketer", iRank, SPAIN, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, 80, 80, "", "grape_mushket", "grenade", 250);
		LAi_SetCharacterUseBullet(sld, "grenade");
		sld.cirassId = Items_FindItemIdx("cirass1");
		sld.MusketerDistance = 0;
		sld.LSC_clan = true;
		if (MOD_SKILL_ENEMY_RATE > 2) sld.MultiShooter = stf(MOD_SKILL_ENEMY_RATE/2);
		TakeNItems(sld, "grenade", 100);
		TakeNItems(sld, "potion2", 5);
		TakeNItems(sld, "potion3", 5);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		ChangeCharacterAddressGroup(sld, "Location_reserve_03", "quest", "gunner"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	// 10 гулящих гардов
	iRank = 10+MOD_SKILL_ENEMY_RATE*2;
	for (i=1; i<=10; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Bastion_spa_soldier_"+i, "sold_spa_"+(rand(7)+1), "man", "man", iRank, SPAIN, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, 40, 40, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", 100);
		ChangeCharacterAddressGroup(sld, "Location_reserve_03", "quest", "gunner"+i);
		sld.LSC_clan = true;
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_SetFightMode(pchar, true);
	DoQuestFunctionDelay("Patria_BastionMineAttackAdd1", 30.0); // 30 секунд до первой атаки
}

void Patria_BastionMineAttackAdd1(string qName) // соляной рудник - 1 добавочная группа
{
	int iRank = 12+MOD_SKILL_ENEMY_RATE*2;
	for (int i=1; i<=4; i++)
	{
		if (i == 1) // офицер
		{
			sld = GetCharacter(NPC_GenerateCharacter("Bastion_spanish_add1_"+i, "off_spa_1", "man", "man", iRank+5, SPAIN, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, 55, 55, LinkRandPhrase("blade_18","blade_19","blade_21"), "pistol5", "bullet", 130);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Bastion_spanish_add1_"+i, "sold_spa_"+(rand(7)+1), "man", "man", iRank, SPAIN, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, 50, 50, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", 110);
		}
		ChangeCharacterAddressGroup(sld, "Location_reserve_03", "reload", "houseH"+(rand(1)+3));
		sld.LSC_clan = true;
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	DoQuestFunctionDelay("Patria_BastionMineAttackAdd2", 30.0); // 30 секунд до второй атаки
}

void Patria_BastionMineAttackAdd2(string qName) // соляной рудник - 2 добавочная группа
{
	int iRank = 13+MOD_SKILL_ENEMY_RATE*2;
	for (int i=1; i<=4; i++)
	{
		if (i == 1) // офицер
		{
			sld = GetCharacter(NPC_GenerateCharacter("Bastion_spanish_add2_"+i, "off_spa_3", "man", "man", iRank+5, SPAIN, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, 60, 60, LinkRandPhrase("blade_18","blade_19","blade_21"), "pistol6", "bullet", 170);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Bastion_spanish_add2_"+i, "sold_spa_"+(rand(7)+1), "man", "man", iRank, SPAIN, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, 55, 55, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", 130);
		}
		ChangeCharacterAddressGroup(sld, "Location_reserve_03", "reload", "reload6_back");
		sld.LSC_clan = true;
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	DoQuestFunctionDelay("Patria_BastionMineAttackAdd3", 40.0); // 40 секунд до третьей атаки
}

void Patria_BastionMineAttackAdd3(string qName) // соляной рудник - 3 добавочная группа
{
	int iRank = 14+MOD_SKILL_ENEMY_RATE*2;
	for (int i=1; i<=4; i++)
	{
		if (i == 1) // офицер
		{
			sld = GetCharacter(NPC_GenerateCharacter("Bastion_spanish_add3_"+i, "off_spa_4", "man", "man", iRank+5, SPAIN, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, 65, 65, LinkRandPhrase("blade_18","blade_19","blade_21"), "pistol6", "bullet", 200);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Bastion_spanish_add3_"+i, "sold_spa_"+(rand(7)+1), "man", "man", iRank, SPAIN, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, 60, 60, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", 150);
		}
		ChangeCharacterAddressGroup(sld, "Location_reserve_03", "reload", "reload4_back");
		sld.LSC_clan = true;
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	DoQuestFunctionDelay("Patria_BastionMineAttackAdd4", 40.0); // 30 секунд до четвертой атаки
}

void Patria_BastionMineAttackAdd4(string qName) // соляной рудник - 4 добавочная группа
{
	int iRank = 15+MOD_SKILL_ENEMY_RATE*2;
	for (int i=1; i<=4; i++)
	{
		if (i == 1) // офицер
		{
			sld = GetCharacter(NPC_GenerateCharacter("Bastion_spanish_add4_"+i, "off_spa_5", "man", "man", iRank+5, SPAIN, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, 70, 70, LinkRandPhrase("blade_18","blade_19","blade_21"), "pistol4", "bullet", 250);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Bastion_spanish_add4_"+i, "sold_spa_1"+i, "man", "man", iRank, SPAIN, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, 65, 65, LinkRandPhrase("blade_18","blade_19","blade_21"), "pistol6", "bullet", 180);
		}
		ChangeCharacterAddressGroup(sld, "Location_reserve_03", "reload", "reload3_back");
		sld.LSC_clan = true;
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetCheck("EnemyFight", "Patria_BastionMineAttackWin");
}

void Patria_BastionNewHuber(string qName) // обновляем губера Синт-Маартена и рудник
{
	// новый губер
	sld = characterFromId("Marigo_Mayor");
	sld.model = "off_fra_5";
	Characters_RefreshModel(sld);
	sld.name 	= "Kristian";
    sld.lastname = "Beusson";
	sld.dialog.currentnode = "First time";
	sld.nation = FRANCE;
	LAi_SetHuberType(sld);
	ChangeCharacterAddressGroup(sld, "Marigo_townhall", "sit", "sit1");
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	// рудник
	int n = Findlocation("Location_reserve_03"); 
	DeleteAttribute(&locations[n], "models.always.barricade");
	DeleteAttribute(&locations[n], "models.always.mortair2");
	locations[n].models.day.charactersPatch = "mine_patch";
	locations[n].models.night.charactersPatch = "mine_patch";
	for (int i=1; i<=15; i++) // рабочие
	{
		sld = GetCharacter(NPC_GenerateCharacter("MarigoMine_worker_"+i, "prizon_"+(rand(7)+1), "man", "man_B", 10, ENGLAND, -1, true, "native"));
		SetFantomParamFromRank(sld, 10, true);
		sld.dialog.Filename = "Convict_dialog.c";
		sld.dialog.currentnode = "First time";
		sld.greeting = "convict";
		sld.city = "marigo";
		sld.CityType = "citizen";
		LAi_CharacterReincarnation(sld, true, true);
		GiveItem2Character(sld, RandPhraseSimple("slave_01","topor_05"));
		EquipCharacterbyItem(sld, RandPhraseSimple("slave_01","topor_05"));
		ChangeCharacterAddressGroup(sld, "Location_reserve_03", "goto", "goto"+i);
		LAi_SetCitizenType(sld);
		LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
	}
	for (i=1; i<=15; i++) // солдаты
	{
		sld = GetCharacter(NPC_GenerateCharacter("MarigoMine_soldier_"+i, "sold_eng_1"+(rand(7)+1), "man", "man", 25, ENGLAND, -1, false, "soldier"));
		SetFantomParamFromRank(sld, 25, true);
		sld.dialog.Filename = "Common_Soldier.c";
		sld.dialog.currentnode = "First time";
		sld.greeting = "soldier";
		sld.city = "marigo";
		sld.CityType = "soldier";
		LAi_CharacterReincarnation(sld, true, true);
		LAi_SetReincarnationRankStep(sld, MOD_SKILL_ENEMY_RATE+2);
		ChangeCharacterAddressGroup(sld, "Location_reserve_03", "patrol", "patrol"+i);
		LAi_SetPatrolType(sld);
		LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
	}
}

// ---------------------------------------------------------- задание 10 ---------------------------------------------------------------
void Patria_SlaveShipsStart() // старт эпизода с перехватом каравана рабов
{
	// отсоединяем Эклятон
	if (!CheckAttribute(pchar, "questTemp.Patria.Ecliaton_Fail"))
	{
		sld = characterFromId("Ecliaton_Cap");
		sld.ShipHideImmortal = 1000; // непотопляемый корабль
		RemoveCharacterCompanion(pchar, sld);
		sld.AlwaysFriend = true;
		sld.ShipEnemyDisable = true;
		Group_AddCharacter("Ecliaton_group", "Ecliaton_Cap");
		Group_SetGroupCommander("Ecliaton_group", "Ecliaton_Cap");
		Group_SetAddress("Ecliaton_group", "Nevis", "quest_ships", "quest_ship_1");
		Group_SetTaskNone("Ecliaton_group");
		Group_LockTask("Ecliaton_group");
		SetFunctionTimerCondition("Patria_EcliatonRepair", 0, 0, 5, false); // таймер на починку Эклятона
		DeleteAttribute(pchar, "questTemp.Patria.Ecliaton");
	}
	SetFunctionTimerCondition("Patria_SlaveShipsSail", 0, 0, 14, false); // таймер на 14 дней на запуск конвоя
	SetFunctionTimerCondition("Patria_SlaveShipsTimeOver", 0, 0, 21, false); // таймер на провал по времени
}

void Patria_SlaveShipsSail(string qName) // запускаем конвой
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	int iShip, iShip1, iShip2, iCannon, iCannon1, iCannon2, iCannon3;
	string sColony, sModel;
	string sCapId = "PatriaSlaveCap";
    string sGroup = "Sea_" + sCapId + "1";
	
	switch (MOD_SKILL_ENEMY_RATE)
	{
		case 2:
			iShip1 = SHIP_FRIGATE;
			iShip2 = SHIP_CORVETTE;
			iCannon1 = CANNON_TYPE_CANNON_LBS16;
			iCannon2 = CANNON_TYPE_CANNON_LBS16;
			iCannon3 = CANNON_TYPE_CANNON_LBS16;
		break;
		
		case 4:
			iShip1 = SHIP_FRIGATE;
			iShip2 = SHIP_CORVETTE;
			iCannon1 = CANNON_TYPE_CULVERINE_LBS18;
			iCannon2 = CANNON_TYPE_CANNON_LBS20;
			iCannon3 = CANNON_TYPE_CANNON_LBS20;
		break;
		
		case 6:
			iShip1 = SHIP_FRIGATE_H;
			iShip2 = SHIP_FRIGATE;
			iCannon1 = CANNON_TYPE_CANNON_LBS24;
			iCannon2 = CANNON_TYPE_CANNON_LBS24;
			iCannon3 = CANNON_TYPE_CULVERINE_LBS18;
		break;
		
		case 8:
			iShip1 = SHIP_FRIGATE_H;
			iShip2 = SHIP_FRIGATE_H;
			iCannon1 = CANNON_TYPE_CANNON_LBS32;
			iCannon2 = CANNON_TYPE_CANNON_LBS24;
			iCannon3 = CANNON_TYPE_CANNON_LBS24;
		break;
		
		case 10:
			iShip1 = SHIP_LINESHIP;
			iShip2 = SHIP_FRIGATE_H;
			iCannon1 = CANNON_TYPE_CANNON_LBS32;
			iCannon2 = CANNON_TYPE_CANNON_LBS24;
			iCannon3 = CANNON_TYPE_CANNON_LBS32;
		break;
	}
	Group_DeleteGroup(sGroup);
	Group_FindOrCreateGroup(sGroup);
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	if (iRank > 45) iRank = 45;
	for (int i = 1; i <= 4; i++)
    {
		SetRandomNameToCharacter(sld);
		SetRandomNameToShip(sld);
		switch (i)
		{
			case 1: 
				iShip = iShip1;
				iCannon = iCannon1;	
				sModel = "off_hol_2";
			break;
			case 2: 
				iShip = SHIP_EASTINDIAMAN; 
				iCannon = iCannon2;
				sModel = "off_hol_"+(rand(1)+4);
			break;
			case 3: 
				iShip = SHIP_EASTINDIAMAN; 
				iCannon = iCannon2;
				sModel = "off_hol_"+(rand(1)+4);
			break;
			case 4: 
				iShip = iShip2; 
				iCannon = iCannon3;
				sModel = "off_hol_1";
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter(sCapId + i, sModel, "man", "man", iRank, HOLLAND, 6, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, 65, 65, 65);
		FantomMakeCoolFighter(sld, iRank, 65, 65, LinkRandPhrase("blade_09","blade_12","blade_13"), "pistol1", "bullet", 220);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.Coastal_Captain = true;
		sld.Ship.Mode = "war";
		sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*6;
		if (MOD_SKILL_ENEMY_RATE > 4) SetCharacterPerk(sld, "MusketsShoot");
		sld.lifeDay = 6;
		sld.AnalizeShips = true;
		sld.WatchFort = true; //видеть форты
		if (i == 2 || i == 3) SetCharacterGoods(sld, GOOD_SLAVES, 1500+rand(50)); // рабов в ост-индцы
		sld.mapEnc.type = "trade";
		sld.mapEnc.worldMapShip = "quest_ship";
        sld.mapEnc.Name = "The Company's Africa convoy";
        Group_AddCharacter(sGroup, sCapId + i);
	}
	Group_SetGroupCommander(sGroup, sCapId+ "1");
    Group_SetTaskAttackInMap(sGroup, PLAYER_GROUP);
    Group_LockTask(sGroup);
	Map_CreateTrader("Mayak1", "Villemstad", sCapId + "1", 6);//запуск энкаунтера
	
	pchar.quest.patria_slaveship1_Abordage.win_condition.l1 = "Character_Capture";
	pchar.quest.patria_slaveship1_Abordage.win_condition.l1.character = "PatriaSlaveCap2";
	pchar.quest.patria_slaveship1_Abordage.function = "Patria_SlaveShipBoarding";
	
	pchar.quest.patria_slaveship2_Abordage.win_condition.l1 = "Character_Capture";
	pchar.quest.patria_slaveship2_Abordage.win_condition.l1.character = "PatriaSlaveCap3";
	pchar.quest.patria_slaveship2_Abordage.function = "Patria_SlaveShipBoarding";
	
	pchar.quest.patria_slaveship1_sink.win_condition.l1 = "Character_sink";
	pchar.quest.patria_slaveship1_sink.win_condition.l1.character = "PatriaSlaveCap2";
	pchar.quest.patria_slaveship1_sink.function = "Patria_SlaveShip1Sink";
	
	pchar.quest.patria_slaveship2_sink.win_condition.l1 = "Character_sink";
	pchar.quest.patria_slaveship2_sink.win_condition.l1.character = "PatriaSlaveCap3";
	pchar.quest.patria_slaveship2_sink.function = "Patria_SlaveShip2Sink";
	
	pchar.quest.patria_slaveship_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.patria_slaveship_AfterBattle.win_condition.l1.group = sGroup;
	pchar.quest.patria_slaveship_AfterBattle.function = "Patria_SlaveShipsAfterBattle";
}

void Patria_SlaveShipsTimeOver(string qName) // не нашли конвой или сбежали
{
	pchar.quest.patria_slaveship1_Abordage.over = "yes";
	pchar.quest.patria_slaveship2_Abordage.over = "yes";
	pchar.quest.patria_slaveship1_sink.over = "yes";
	pchar.quest.patria_slaveship2_sink.over = "yes";
	pchar.quest.patria_slaveship_AfterBattle.over = "yes";
	AddQuestRecord("Patria", "53");
	RemoveItems(pchar, "patent_fra", 1);
	ChangeCharacterComplexReputation(pchar, "nobility", -10);
	ChangeCharacterComplexReputation(pchar, "authority", -5);
	ChangeCharacterNationReputation(pchar, FRANCE, -10);
	pchar.questTemp.Patria = "fail";
	CloseQuestHeader("Patria");
}

void Patria_SlaveShip1Sink(string qName) // утоп 1 ост-индец
{
	pchar.questTemp.Patria.SlaveShips.Sink1 = "true";
	if (CheckAttribute(pchar, "questTemp.Patria.SlaveShips.Sink2"))
	{	
		pchar.questTemp.Patria.SlaveShips.SinkBoth = "true";
		AddQuestRecord("Patria", "55");
	}
	else AddQuestRecord("Patria", "54");
}

void Patria_SlaveShip2Sink(string qName) // утоп 2 ост-индец
{
	pchar.questTemp.Patria.SlaveShips.Sink2 = "true";
	if (CheckAttribute(pchar, "questTemp.Patria.SlaveShips.Sink1"))
	{	
		pchar.questTemp.Patria.SlaveShips.SinkBoth = "true";
		AddQuestRecord("Patria", "55");
	}
	else AddQuestRecord("Patria", "54");
}

void Patria_SlaveShipBoarding(string qName) // бой состоялся и был захвачен хоть 1 ост-индец
{
	pchar.questTemp.Patria.SlaveShips.Boarding = "true";
	pchar.quest.Patria_SlaveShipsTimeOver.over = "yes"; //снять таймер
	pchar.quest.patria_slaveship1_Abordage.over = "yes";
	pchar.quest.patria_slaveship2_Abordage.over = "yes";
	pchar.quest.patria_slaveship1_sink.over = "yes";
	pchar.quest.patria_slaveship2_sink.over = "yes";
}

void Patria_SlaveShipsAfterBattle(string qName) // итоги боя
{
	if (CheckAttribute(pchar, "questTemp.Patria.SlaveShips.Boarding")) // бой был и захватил хоть 1 - зачет
	{
		SetFunctionTimerCondition("Patria_SlaveShipsJamaicaTimeOver", 0, 0, 30, false); // таймер на месяц на прибытие к Дойли
		pchar.questTemp.Patria = "epizode_10_continue";
		AddQuestRecord("Patria", "56");
	}
	if (CheckAttribute(pchar, "questTemp.Patria.SlaveShips.SinkBoth")) // бой был и утопил обоих - полузачет, ищи рабов сам
	{
		pchar.quest.Patria_SlaveShipsTimeOver.over = "yes"; //снять таймер
		SetFunctionTimerCondition("Patria_SlaveShipsJamaicaTimeOver", 0, 0, 30, false); // таймер на месяц на прибытие к Дойли
		pchar.questTemp.Patria = "epizode_10_continue";
	}
	// иначе - либо упустил, либо сбежал, тогда отработает общий таймер 
}

void Patria_SlaveShipsJamaicaTimeOver(string qName) // не привезли рабов Дойли
{
	AddQuestRecord("Patria", "59");
	RemoveItems(pchar, "patent_fra", 1);
	ChangeCharacterComplexReputation(pchar, "nobility", -20);
	ChangeCharacterComplexReputation(pchar, "authority", -5);
	ChangeCharacterNationReputation(pchar, FRANCE, -30);
	pchar.questTemp.Patria = "fail";
	CloseQuestHeader("Patria");
}

// ---------------------------------------------------------- задание 11 ---------------------------------------------------------------
void Patria_CuracaoAddEcliaton() // присоединяем Эклятон
{
	sld = characterFromId("Ecliaton_Cap");
	DeleteAttribute(sld, "ShipHideImmortal");
	SetCharacterRemovable(sld, false);
	sld.CompanionEnemyEnable = false; //всегда друзья
	SetCompanionIndex(pchar, -1, sti(sld.index));
	sld.loyality = MAX_LOYALITY;
	pchar.questTemp.Patria.Ecliaton = "true";
	// прерывание на потерю Эклятона
	pchar.quest.Patria_EcliatonFail.win_condition.l1 = "NPC_Death";
	pchar.quest.Patria_EcliatonFail.win_condition.l1.character = "Ecliaton_Cap";
	pchar.quest.Patria_EcliatonFail.function = "Patria_EcliatonFail";
	// удаление группы Эклятона, иначе клон-призрак
	pchar.quest.Patria_EcliatonDelGroup.win_condition.l1 = "ExitFromSea";
	pchar.quest.Patria_EcliatonDelGroup.function = "Patria_EcliatonDelGroup";
}

void Patria_CuracaoDoilyReady(string qName) // Дойли готов к походу - эскадру на рейд
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	pchar.questTemp.Patria.Curacao.DoilyReady = "true";
	int iShip, iCannon;
	sld = characterFromId("Doily");
	sld.nation = ENGLAND;
	FantomMakeCoolSailor(sld, SHIP_LSHIP_ENG, "Trafalgar", CANNON_TYPE_CULVERINE_LBS36, 100, 100, 100);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true;
	sld.AlwaysSandbankManeuver = true;
	sld.Ship.Mode = "war";
	sld.DontDeskTalk = true; // не высылать шлюпку
	LAi_SetImmortal(sld, true); // не забыть снять
	sld.ShipHideImmortal = 1000; // непотопляемый корабль
	Character_SetAbordageEnable(sld, false); // нельзя абордировать
	sld.Tasks.CanBoarding = false; // запрет идти на абордаж - дубль
	sld.Tasks.CanChangeShipAfterBoarding = false; // запрет меняться кораблями - дубль
	sld.Abordage.Enable = false;
	sld.SeaBoss = 0.5; // получает на 50% меньше урона корпусу
	sld.ship.Crew.Morale = 100;
	sld.Ship.Crew.Exp.Sailors = 100;
	sld.Ship.Crew.Exp.Cannoners = 100;
	sld.Ship.Crew.Exp.Soldiers = 100;
	SetCharacterPerk(sld, "MusketsShoot");
	SetRandGeraldSail(sld, ENGLAND);
	Group_AddCharacter("Patria_DoilySquadron", "Doily");
	for(int i = 1; i <= 2; i++)
	{
		switch (i)
		{
			case 1: 
				iShip = SHIP_LINESHIP;
				iCannon = CANNON_TYPE_CANNON_LBS32;	
			break;
			case 2: 
				iShip = SHIP_LINESHIP; 
				iCannon = CANNON_TYPE_CANNON_LBS32;
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("Patria_DoilySquadronCap_"+i, "off_eng_"+(6-i), "man", "man", 35, ENGLAND, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, 100, 100, 100);
		FantomMakeCoolFighter(sld, 35, 100, 100, LinkRandPhrase("blade_18","blade_19","blade_20"), "pistol5", "bullet", 250);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.cirassId = Items_FindItemIdx("cirass4");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysFriend = true;
		sld.ShipEnemyDisable = true;
		sld.AlwaysSandbankManeuver = true;
		sld.Ship.Mode = "war";
		LAi_SetImmortal(sld, true); // не забыть снять
		sld.ship.Crew.Morale = 90;
		sld.Ship.Crew.Exp.Sailors = 90;
		sld.Ship.Crew.Exp.Cannoners = 90;
		sld.Ship.Crew.Exp.Soldiers = 90;
		SetCharacterPerk(sld, "MusketsShoot");
		SetRandGeraldSail(sld, ENGLAND);
		Group_AddCharacter("Patria_DoilySquadron", "Patria_DoilySquadronCap_"+i);
	}
	Group_SetGroupCommander("Patria_DoilySquadron", "Doily");
	Group_SetAddress("Patria_DoilySquadron", "Jamaica", "quest_ships", "quest_ship_1");
	Group_SetTaskNone("Patria_DoilySquadron");
	Group_LockTask("Patria_DoilySquadron");
}

void Patria_CuracaoTimeOver(string qName) // не пришли к Дойли назад за 2 месяца
{
	if (!CheckAttribute(pchar, "questTemp.Patria.Ecliaton_Fail"))
	{
		pchar.quest.Patria_EcliatonFail.over = "yes"; //снять прерывание
		sld = characterFromId("Ecliaton_Cap");
		sld.ShipHideImmortal = 1000; // непотопляемый корабль
		sld.lifeday = 0;
		RemoveCharacterCompanion(pchar, sld);
		sld.AlwaysFriend = true;
		sld.ShipEnemyDisable = true;
		DeleteAttribute(pchar, "questTemp.Patria.Ecliaton");
	}
	AddQuestRecord("Patria", "59");
	RemoveItems(pchar, "patent_fra", 1);
	ChangeCharacterComplexReputation(pchar, "nobility", -20);
	ChangeCharacterComplexReputation(pchar, "authority", -10);
	ChangeCharacterNationReputation(pchar, FRANCE, -30);
	pchar.questTemp.Patria = "fail";
	CloseQuestHeader("Patria");
}

void Patria_CuracaoSail() // формируем эскадру
{
	sld = characterFromId("Doily");
	SetCharacterRemovable(sld, false);
	sld.CompanionEnemyEnable = false; //всегда друзья
	SetCompanionIndex(pchar, -1, sti(sld.index));
	sld.loyality = MAX_LOYALITY;
	LAi_SetImmortal(sld, false);
	pchar.questTemp.Patria.Trafalgar = "true";
	for(int i = 1; i <= 2; i++) 
	{
		sld = characterFromId("Patria_DoilySquadronCap_"+i);
		SetCharacterRemovable(sld, false);
		sld.CompanionEnemyEnable = false; //всегда друзья
		SetCompanionIndex(pchar, -1, sti(sld.index));
		sld.loyality = MAX_LOYALITY;
		LAi_SetImmortal(sld, false);
	}
	// удаление группы Дойли
	pchar.quest.Patria_DoyliDelGroup.win_condition.l1 = "ExitFromLocation";
	pchar.quest.Patria_DoyliDelGroup.win_condition.l1.location = pchar.location;
	pchar.quest.Patria_DoyliDelGroup.function = "Patria_DoilyDelGroup";
	SetFunctionTimerCondition("Patria_SanMartinBaronOver", 0, 0, 20, false); // таймер на 20 дней, чтобы не занимался посторонними делами, иначе будет бабах
	
	pchar.quest.Patria_CuracaoEnter.win_condition.l1 = "location";
	pchar.quest.Patria_CuracaoEnter.win_condition.l1.location = "Curacao";
	pchar.quest.Patria_CuracaoEnter.function = "Patria_CuracaoEnter";
	// форт Виллемстада
	sld = CharacterFromID("Villemstad Fort Commander");
	LAi_SetImmortal(sld, false);
}

void Patria_DoilyDelGroup(string qName) // 
{
	Group_DeleteGroup("Patria_DoilySquadron");
}

void Patria_CuracaoEnter(string qName) // пришли к Кюрасао
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	pchar.quest.Patria_SanMartinBaronOver.over = "yes"; // снять таймер
	bQuestDisableMapEnter = true;//закрыть карту
	Island_SetReloadEnableGlobal("Curacao", true); //закрыть остров
	pchar.questTemp.Patria.CuracaoAttack = "true";
	if (pchar.nation != FRANCE) Flag_FRANCE();
	pchar.DisableChangeFlagMode = true; //закрываем Флаг
	// ставим две группы голландцев
	int iShip, iCannon;
	string sModel;
	Group_DeleteGroup("Patria_CuracaoGroup1");
	Group_FindOrCreateGroup("Patria_CuracaoGroup1");
	int iRank = sti(pchar.rank)+MOD_SKILL_ENEMY_RATE;
	if (iRank > 45) iRank = 45;
	for (int i = 1; i <= 3; i++)
    {
		switch (i)
		{
			case 1: 
				iShip = SHIP_GALEON_H;
				iCannon = CANNON_TYPE_CANNON_LBS32;	
				sModel = "off_hol_5";
			break;
			case 2: 
				iShip = SHIP_FRIGATE_H; 
				iCannon = CANNON_TYPE_CANNON_LBS32;
				sModel = "off_hol_2";
			break;
			case 3: 
				iShip = SHIP_FRIGATE; 
				iCannon = CANNON_TYPE_CANNON_LBS24;
				sModel = "off_hol_1";
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("Patria_CuracaoCap1_"+i, sModel, "man", "man", iRank, HOLLAND, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, 70, 70, 70);
		FantomMakeCoolFighter(sld, iRank, 70, 70, LinkRandPhrase("blade_17","blade_20","blade_21"), "pistol5", "bullet", 250);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysEnemy = true;
		sld.Coastal_Captain = true;
		sld.Ship.Mode = "war";
		sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*6;
		if (MOD_SKILL_ENEMY_RATE > 2) SetCharacterPerk(sld, "MusketsShoot");
		sld.AnalizeShips = true;
		sld.WatchFort = true; //видеть форты
		if (i == 1) sld.ship.name = "Frederick";
		Group_AddCharacter("Patria_CuracaoGroup1", "Patria_CuracaoCap1_"+i);
	}
	Group_SetGroupCommander("Patria_CuracaoGroup1", "Patria_CuracaoCap1_1");
	Group_SetAddress("Patria_CuracaoGroup1", "Curacao", "quest_ships", "quest_ship_2");
	Group_SetTaskAttack("Patria_CuracaoGroup1", PLAYER_GROUP);
	Group_LockTask("Patria_CuracaoGroup1");
	// вторая
	Group_DeleteGroup("Patria_CuracaoGroup2");
	Group_FindOrCreateGroup("Patria_CuracaoGroup2");
	for (i = 1; i <= 3; i++)
    {
		switch (i)
		{
			case 1: 
				iShip = SHIP_XebekVML;
				iCannon = CANNON_TYPE_CANNON_LBS20;	
				sModel = "off_hol_3";
			break;
			case 2: 
				iShip = SHIP_BRIGANTINE; 
				iCannon = CANNON_TYPE_CANNON_LBS16;
				sModel = "off_hol_2";
			break;
			case 3: 
				iShip = SHIP_SCHOONER_W; 
				iCannon = CANNON_TYPE_CANNON_LBS12;
				sModel = "off_hol_1";
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("Patria_CuracaoCap2_"+i, sModel, "man", "man", iRank, HOLLAND, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, 70, 70, 70);
		FantomMakeCoolFighter(sld, iRank, 70, 70, LinkRandPhrase("blade_09","blade_13","blade_15"), "pistol5", "bullet", 200);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.Coastal_Captain = true;
		sld.Ship.Mode = "war";
		sld.AlwaysEnemy = true;
		sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*6;
		sld.AnalizeShips = true;
		sld.WatchFort = true; //видеть форты
		Group_AddCharacter("Patria_CuracaoGroup2", "Patria_CuracaoCap2_"+i);
	}
	Group_SetGroupCommander("Patria_CuracaoGroup2", "Patria_CuracaoCap2_1");
	Group_SetAddress("Patria_CuracaoGroup2", "Curacao", "quest_ships", "quest_ship_1");
	Group_SetTaskAttack("Patria_CuracaoGroup2", PLAYER_GROUP);
	Group_LockTask("Patria_CuracaoGroup2");
	// прерывание на уничтожение эскадры
	pchar.quest.Patria_CuracaoAfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.Patria_CuracaoAfterBattle.win_condition.l1.group = "Patria_CuracaoGroup1";
	pchar.quest.Patria_CuracaoAfterBattle.win_condition.l2 = "Group_Death";
	pchar.quest.Patria_CuracaoAfterBattle.win_condition.l2.group = "Patria_CuracaoGroup2";
	pchar.quest.Patria_CuracaoAfterBattle.function = "Patria_CuracaoAfterSeaBattle";
}

void Patria_CuracaoAfterSeaBattle(string qName) // эскадры охранения уничтожены
{
	Group_DeleteGroup("Patria_CuracaoGroup1");
	Group_DeleteGroup("Patria_CuracaoGroup2");
	pchar.questTemp.Patria.Curacao.SquadronDead = "true";
	if (CheckAttribute(pchar, "questTemp.Patria.Curacao.FortDead")) Patria_CuracaoTrooper(); // форт уничтожен, на высадку
}

void Patria_CuracaoFortDestroyed() // форт Кюрасао разрушен
{
	pchar.questTemp.Patria.Curacao.FortDead = "true";
	DeleteAttribute(pchar, "questTemp.Patria.CuracaoAttack");
	if (CheckAttribute(pchar, "questTemp.Patria.Curacao.SquadronDead")) Patria_CuracaoTrooper(); // эскадра уничтожена, на высадку
	else Log_Info("We must destroy the enemy squadron!");
}

void Patria_CuracaoTrooper() // высадка
{
	Log_Info("Colonel Doily has given a signal to land in Blanca lagoon!");
	DoQuestFunctionDelay("Patria_CuracaoTrooperLand", 7.0);
}

void Patria_CuracaoTrooperLand(string qName) // высадка
{
	pchar.GenQuest.Hunter2Pause = true;
	pchar.GenQuest.CannotWait = true;
	locations[FindLocation("Shore23")].DisableEncounters = true;
	locations[FindLocation("Shore24")].DisableEncounters = true;
	locations[FindLocation("Villemstad_ExitTown")].DisableEncounters = true;
	locations[FindLocation("Curacao_jungle_01")].DisableEncounters = true;
	locations[FindLocation("Curacao_jungle_02")].DisableEncounters = true;
	locations[FindLocation("Curacao_jungle_03")].DisableEncounters = true;
	LocatorReloadEnterDisable("Villemstad_ExitTown", "reload4", true);
	LocatorReloadEnterDisable("Curacao_jungle_03", "reloadW_back", true);
	DoQuestReloadToLocation("Shore24", "reload", "sea", "Patria_CuracaoTrooperLand");
	setCharacterShipLocation(pchar, "shore24");
	setWDMPointXZ("shore24");
	// 2 пушки
	int n = Findlocation("shore24");
	locations[n].models.always.mortair1 = "mortair";
	Locations[n].models.always.mortair1.locator.group = "rld";
	Locations[n].models.always.mortair1.locator.name = "loc1";
	Locations[n].models.always.mortair1.tech = "DLightModel";
	locations[n].models.always.mortair2 = "mortair";
	Locations[n].models.always.mortair2.locator.group = "rld";
	Locations[n].models.always.mortair2.locator.name = "loc2";
	Locations[n].models.always.mortair2.tech = "DLightModel";
	// маленький сюрприз в пещере
	pchar.GenQuestBox.Curacao_Cave = true;
	pchar.GenQuestBox.Curacao_Cave.box2.money = 200000;
	pchar.GenQuestBox.Curacao_Cave.box2.items.gold_dublon = 1000;
	pchar.GenQuestBox.Curacao_Cave.box2.items.jewelry5 = 1000;
	pchar.GenQuestBox.Curacao_Cave.box2.items.jewelry6 = 2000;
}

void Patria_CuracaoGotoMarch() // 
{
	chrDisableReloadToLocation = false;
	LocatorReloadEnterDisable("shore24", "reload1_back", true);
	LocatorReloadEnterDisable("shore22", "reload1_back", true);
	LocatorReloadEnterDisable("Curacao_jungle_03", "reload2_back", true); // лесник
	for (int i=1; i<=15; i++)
	{
		sld = characterFromId("Curacao_eng_soldier_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	pchar.quest.Curacao_inShore.win_condition.l1 = "location";
	pchar.quest.Curacao_inShore.win_condition.l1.location = "Shore23";
	pchar.quest.Curacao_inShore.function = "Patria_CuracaoMarch";
	// рассоединяем эскадру
	Group_FindOrCreateGroup("Patria_DoilySquadron");
	sld = characterFromId("Doily");
	RemoveCharacterCompanion(pchar, sld);
	Group_AddCharacter("Patria_DoilySquadron", "Doily");
	sld.nation = ENGLAND;
	for(i = 1; i <= 2; i++)
	{
		if (GetCharacterIndex("Patria_DoilySquadronCap_"+i) != -1)
		{
			sld = characterFromId("Patria_DoilySquadronCap_"+i);
			RemoveCharacterCompanion(pchar, sld);
			Group_AddCharacter("Patria_DoilySquadron", "Patria_DoilySquadronCap_"+i);
			sld.nation = ENGLAND;
		}
	}
	Group_SetGroupCommander("Patria_DoilySquadron", "Doily");
	Group_SetAddress("Patria_DoilySquadron", "Curacao", "quest_ships", "quest_ship_1");
	Group_SetTaskNone("Patria_DoilySquadron");
	Group_LockTask("Patria_DoilySquadron");
	DeleteAttribute(pchar, "questTemp.Patria.Trafalgar");
}

void Patria_CuracaoMarch(string qName) // наш отряд в бухте
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	int n = Findlocation("shore24");
	DeleteAttribute(&locations[n], "models.always.mortair1");
	DeleteAttribute(&locations[n], "models.always.mortair2");
	sld = characterFromId("Doily_land");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	for (int i=1; i<=15; i++)
	{
		sld = characterFromId("Curacao_eng_soldier_"+i);
		ChangeCharacterAddressGroup(sld, "none", "", "");
	}
	// пушки
	n = Findlocation("Villemstad_ExitTown");
	locations[n].models.always.mortair1 = "mortair";
	Locations[n].models.always.mortair1.locator.group = "quest";
	Locations[n].models.always.mortair1.locator.name = "gun1";
	Locations[n].models.always.mortair1.tech = "DLightModel";
	locations[n].models.always.mortair2 = "mortair";
	Locations[n].models.always.mortair2.locator.group = "quest";
	Locations[n].models.always.mortair2.locator.name = "gun2";
	Locations[n].models.always.mortair2.tech = "DLightModel";
	// наша рота
	for (i=1; i<=15; i++)
	{
		if (i < 4) // мушкетеры, 3 шт
		{
			sld = GetCharacter(NPC_GenerateCharacter("Curacao_fra_soldier_"+i, "mush_fra_"+i, "man", "mushketer", 30, FRANCE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, 30, 60, 60, "", "mushket2", "cartridge", 170);
			LAi_SetCharacterUseBullet(sld, "cartridge");
			sld.cirassId = Items_FindItemIdx("cirass1");
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Curacao_fra_soldier_"+i, "sold_fra_"+(rand(7)+1), "man", "man", 30, FRANCE, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, 30, 60, 60, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", 150);
			sld.cirassId = Items_FindItemIdx("cirass2");
		}
		ChangeCharacterAddressGroup(sld, "shore23", "goto", "goto1");
		LAi_SetActorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		LAi_ActorFollow(sld, pchar, "", -1);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
	}
	pchar.quest.Patria_CuracaoMarchX.win_condition.l1 = "location";
	pchar.quest.Patria_CuracaoMarchX.win_condition.l1.location = "Curacao_jungle_03";
	pchar.quest.Patria_CuracaoMarchX.function = "Patria_CuracaoJungleMarch";
	pchar.quest.Patria_CuracaoMarch.win_condition.l1 = "location";
	pchar.quest.Patria_CuracaoMarch.win_condition.l1.location = "Curacao_jungle_02";
	pchar.quest.Patria_CuracaoMarch.function = "Patria_CuracaoJungleMushketer"; // первый отряд голландцев
}

void Patria_CuracaoJungleMarch(string qName) // проходим пустую локацию
{
	for (int i=1; i<=15; i++)
	{
		sld = characterFromId("Curacao_fra_soldier_"+i);
		ChangeCharacterAddressGroup(sld, "Curacao_jungle_03", "reload", "reload3_back");
		LAi_SetActorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		LAi_ActorFollow(sld, pchar, "", -1);
	}
}

void Patria_CuracaoJungleMushketer(string qName) // первая боевка
{
	chrDisableReloadToLocation = true;
	for (int i=1; i<=15; i++)
	{
		sld = characterFromId("Curacao_fra_soldier_"+i);
		ChangeCharacterAddressGroup(sld, "Curacao_jungle_02", "reload", "reload1_back");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	LAi_group_Delete("EnemyFight");
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	for (i=1; i<=9; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Curacao_hol1_soldier_"+i, "mush_hol_"+(rand(2)+4), "man", "mushketer", iRank, HOLLAND, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, iRank, 65, 65, "", "mushket2", "cartridge", 220);
		LAi_SetCharacterUseBullet(sld, "cartridge");
		sld.cirassId = Items_FindItemIdx("cirass1");
		sld.MusketerDistance = 0;
		if (i < 7) ChangeCharacterAddressGroup(sld, "Curacao_jungle_02", "rld", "aloc"+(i+4));
		if (i >= 7) ChangeCharacterAddressGroup(sld, "Curacao_jungle_02", "rld", "aloc"+(i+5));
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Patria_CuracaoAfterJungleMushketer");
}

void Patria_CuracaoJungleBattle(string qName) // вторая боевка
{
	chrDisableReloadToLocation = true;
	for (int i=1; i<=15; i++)
	{
		if (GetCharacterIndex("Curacao_fra_soldier_"+i) != -1)
		{
			sld = characterFromId("Curacao_fra_soldier_"+i);
			ChangeCharacterAddressGroup(sld, "Curacao_jungle_01", "reload", "reload1_back");
			LAi_SetWarriorType(sld);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
	LAi_group_Delete("EnemyFight");
	int iRank = 18+MOD_SKILL_ENEMY_RATE*2;
	for (i=1; i<=15; i++)
	{
		if (i == 1) // офицер
		{
			sld = GetCharacter(NPC_GenerateCharacter("Curacao_hol2_soldier_"+i, "off_hol_4", "man", "man", iRank+5, HOLLAND, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, 65, 65, LinkRandPhrase("blade_18","blade_19","blade_21"), "pistol6", "bullet", 230);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Curacao_hol2_soldier_"+i, "sold_hol_"+(rand(7)+9), "man", "man", iRank, HOLLAND, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, 60, 60, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", 180);
		}
		ChangeCharacterAddressGroup(sld, "Curacao_jungle_01", "reload", "reload3_back");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Patria_CuracaoAfterJungleBattle");
}

void Patria_CuracaoGateBattle(string qName) // в локации ворот
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	chrDisableReloadToLocation = true;
	for (int i=1; i<=15; i++)
	{
		if (GetCharacterIndex("Curacao_fra_soldier_"+i) != -1)
		{
			sld = characterFromId("Curacao_fra_soldier_"+i);
			ChangeCharacterAddressGroup(sld, "Villemstad_ExitTown", "reload", "reload1_back");
			LAi_SetActorType(sld);
			LAi_ActorFollow(sld, pchar, "", 2.0);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
	sld = characterFromId("Doily_land");
	ChangeCharacterAddressGroup(sld, "Villemstad_ExitTown", "quest", "commander");
	LAi_SetActorType(sld);
	LAi_group_MoveCharacter(sld, "TMP_FRIEND");
	for (i=1; i<=15; i++)
	{
		sld = characterFromId("Curacao_eng_soldier_"+i);
		if (i < 7) 
		{
			ChangeCharacterAddressGroup(sld, "Villemstad_ExitTown", "quest", "mush"+i);
			sld.MusketerDistance = 0;
		}
		if (i >= 7 && i < 14) 
		{
			ChangeCharacterAddressGroup(sld, "Villemstad_ExitTown", "quest", "sold"+i);
		}
		if (i >= 14) 
		{
			ChangeCharacterAddressGroup(sld, "Villemstad_ExitTown", "quest", "soldier"+(i-13));
		}
		LAi_SetActorType(sld);
		LAi_group_MoveCharacter(sld, "TMP_FRIEND");
	}
	DoQuestFunctionDelay("Patria_CuracaoGateBattle1", 2.0);
}

void Patria_CuracaoGateBattle1(string qName) // 
{
	LAi_SetActorType(pchar);
	LAi_ActorRunToLocator(pchar, "quest", "hero", "Patria_CuracaoGateBattle1", -1);
	for (int i=1; i<=15; i++)
	{
		if (GetCharacterIndex("Curacao_fra_soldier_"+i) != -1)
		{
			sld = characterFromId("Curacao_fra_soldier_"+i);
			LAi_SetActorType(sld);
		}
	}
	int n = 0;
	for(i=1; i<=3; i++)
	{
		int idx = GetOfficersIndex(pchar, i);
		if(idx < 0) continue;
		sld = &Characters[idx];
		SetCharacterTask_Stay(sld);
		sld.chr_ai.tmpl = LAI_TMPL_STAY;
		n++;
	}
}

void Patria_CuracaoGateBattle2(string qName) // выскочили голландцы из ворот
{
	pchar.questTemp.Patria.Curacao.BoomGate1 = "true";
	LAi_group_Delete("EnemyFight");
	for (int i=1; i<=7; i++)
	{
		if (i == 1) // офицер
		{
			sld = GetCharacter(NPC_GenerateCharacter("Curacao_hol3_soldier_"+i, "off_hol_1", "man", "man", 20, HOLLAND, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, 20, 65, 65, LinkRandPhrase("blade_18","blade_19","blade_21"), "pistol6", "bullet", 100);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Curacao_hol3_soldier_"+i, "sold_hol_"+(rand(7)+1), "man", "man", 15, HOLLAND, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, 20, 60, 60, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", 100);
		}
		ChangeCharacterAddressGroup(sld, "Villemstad_ExitTown", "reload", "reload4");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	DoQuestFunctionDelay("Patria_CuracaoGateBattleBoom1", 2.0);
}

void Patria_CuracaoGateBattleBoom1(string qName) // выстрел из пушки №1
{
	CreateLocationParticles("Bombard", "quest", "gun1", 1.0, -90, 0, "cannon_fire_2");
	if (CheckAttribute(pchar, "questTemp.Patria.Curacao.BoomGate3")) DoQuestFunctionDelay("Patria_CuracaoGateBattleExp3", 1.0);
	else DoQuestFunctionDelay("Patria_CuracaoGateBattleExp1", 1.0);
}

void Patria_CuracaoGateBattleBoom2(string qName) // выстрел из пушки №2
{
	CreateLocationParticles("Bombard", "quest", "gun2", 1.0, 0, -90, "cannon_fire_2");
	DoQuestFunctionDelay("Patria_CuracaoGateBattleExp2", 1.0);
}

void Patria_CuracaoGateBattleExp1(string qName) // взрыв от пушки №1
{
	CreateLocationParticles("ShipExplode", "quest", "boom1", 0, 0, 0, "boom");
	CreateLocationParticles("blast_dirt", "quest", "boom1", 0, 0, 0, "");
	CreateLocationParticles("blast_inv", "quest", "boom1", 0, 0, 0, "");
	if (CheckAttribute(pchar, "questTemp.Patria.Curacao.BoomGate1")) 
	{
		for (int i=1; i<=4; i++)
		{
			sld = characterFromId("Curacao_hol3_soldier_"+i);
			LAi_KillCharacter(sld);
		}
		DoQuestFunctionDelay("Patria_CuracaoGateBattleMush1", 0.5);
		DeleteAttribute(pchar, "questTemp.Patria.Curacao.BoomGate1");
	}
	if (CheckAttribute(pchar, "questTemp.Patria.Curacao.BoomGate2")) 
	{
		for (i=12; i<=15; i++)
		{
			sld = characterFromId("Curacao_hol7_soldier_"+i);
			LAi_KillCharacter(sld);
		}
		DoQuestFunctionDelay("Patria_CuracaoGateBattleRush", 0.5);
		DeleteAttribute(pchar, "questTemp.Patria.Curacao.BoomGate2");
	}
}

void Patria_CuracaoGateBattleExp2(string qName) // взрыв от пушки №2
{
	CreateLocationParticles("ShipExplode", "quest", "boom2", 0, 0, 0, "boom");
	CreateLocationParticles("blast_dirt", "quest", "boom2", 0, 0, 0, "");
	CreateLocationParticles("blast_inv", "quest", "boom2", 0, 0, 0, "");
	if (CheckAttribute(pchar, "questTemp.Patria.Curacao.BoomFort1")) 
	{
		for (int i=1; i<=5; i++)
		{
			sld = characterFromId("Curacao_hol4_soldier_"+i);
			LAi_KillCharacter(sld);
		}
		DoQuestFunctionDelay("Patria_CuracaoGateBattle4", 4.0);
		DeleteAttribute(pchar, "questTemp.Patria.Curacao.BoomFort1");
	}
	if (CheckAttribute(pchar, "questTemp.Patria.Curacao.BoomFort2")) 
	{
		for (i=1; i<=5; i++)
		{
			sld = characterFromId("Curacao_hol5_soldier_"+i);
			LAi_KillCharacter(sld);
		}
		DoQuestFunctionDelay("Patria_CuracaoGateBattle5", 7.0);
		DeleteAttribute(pchar, "questTemp.Patria.Curacao.BoomFort2");
	}
	if (CheckAttribute(pchar, "questTemp.Patria.Curacao.BoomFort3")) 
	{
		for (i=1; i<=5; i++)
		{
			sld = characterFromId("Curacao_hol6_soldier_"+i);
			LAi_KillCharacter(sld);
		}
		DoQuestFunctionDelay("Patria_CuracaoGateBattle6", 5.0);
		DeleteAttribute(pchar, "questTemp.Patria.Curacao.BoomFort3");
	}
}

void Patria_CuracaoGateBattleExp3(string qName) // взрыв от пушки №1 по городу
{
	PlaySound("Sea Battles_01\Swish_balls_06.wav");
	DoQuestFunctionDelay("Patria_CuracaoGateBattleExp33", 2.0);
}

void Patria_CuracaoGateBattleExp33(string qName) // взрыв от пушки №1 по городу
{
	CreateLocationParticles("", "quest", "boom1", 0, 0, 0, "boom");
	if (CheckAttribute(pchar, "questTemp.Patria.Curacao.BoomGate3")) DoQuestFunctionDelay("Patria_CuracaoGateBattleBoom1", 4.0);
	else DoQuestFunctionDelay("Patria_CuracaoTownBombingEnd", 2.5);
}

void Patria_CuracaoGateBattleMush1(string qName) // 
{
	for (int i=1; i<=3; i++)
	{
		sld = characterFromId("Curacao_eng_soldier_"+i);
		LAi_SetActorType(sld);
		LAi_ActorAnimation(sld, "shot", "Patria_CuracaoGateBattleMush1", 1.0);
	}
}

void Patria_CuracaoGateBattle3(string qName) // выскочили голландцы из форта
{
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "reload", "reload3_back");
	pchar.questTemp.Patria.Curacao.BoomFort1 = "true";
	LAi_group_Delete("EnemyFight");
	for (int i=1; i<=5; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Curacao_hol4_soldier_"+i, "sold_hol_"+(rand(7)+1), "man", "man", 15, HOLLAND, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, 20, 60, 60, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", 100);
		ChangeCharacterAddressGroup(sld, "Villemstad_ExitTown", "rld", "loc0");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	DoQuestFunctionDelay("Patria_CuracaoGateBattleBoom2", 2.0);
}

void Patria_CuracaoGateBattle4(string qName) // выскочили голландцы из форта
{
	pchar.questTemp.Patria.Curacao.BoomFort2 = "true";
	LAi_group_Delete("EnemyFight");
	for (int i=1; i<=5; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("Curacao_hol5_soldier_"+i, "sold_hol_"+(rand(7)+1), "man", "man", 15, HOLLAND, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, 20, 60, 60, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", 100);
		ChangeCharacterAddressGroup(sld, "Villemstad_ExitTown", "rld", "loc0");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	DoQuestFunctionDelay("Patria_CuracaoGateBattleBoom2", 2.0);
}

void Patria_CuracaoGateBattle5(string qName) // выскочили голландцы из форта
{
	pchar.questTemp.Patria.Curacao.BoomFort3 = "true";
	LAi_group_Delete("EnemyFight");
	for (int i=1; i<=5; i++)
	{
		if (i == 1) // офицер
		{
			sld = GetCharacter(NPC_GenerateCharacter("Curacao_hol6_soldier_"+i, "off_hol_1", "man", "man", 20, HOLLAND, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, 20, 65, 65, LinkRandPhrase("blade_18","blade_19","blade_21"), "pistol6", "bullet", 100);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Curacao_hol6_soldier_"+i, "sold_hol_"+(rand(7)+1), "man", "man", 15, HOLLAND, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, 20, 60, 60, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", 100);
		}
		ChangeCharacterAddressGroup(sld, "Villemstad_ExitTown", "rld", "loc0");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	DoQuestFunctionDelay("Patria_CuracaoGateBattleBoom2", 2.0);
}

void Patria_CuracaoGateBattle6(string qName) // выскочили голландцы из ворот
{
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "reload", "reload4");
	pchar.questTemp.Patria.Curacao.BoomGate2 = "true";
	LAi_group_Delete("EnemyFight");
	int iRank = 20+MOD_SKILL_ENEMY_RATE*2;
	for (int i=1; i<=15; i++)
	{
		if (i == 1) // офицер
		{
			sld = GetCharacter(NPC_GenerateCharacter("Curacao_hol7_soldier_"+i, "off_hol_5", "man", "man", iRank, HOLLAND, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, 70, 70, LinkRandPhrase("blade_18","blade_19","blade_21"), "pistol4", "bullet", 250);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Curacao_hol7_soldier_"+i, "sold_hol_"+(rand(7)+1), "man", "man", iRank, HOLLAND, -1, false, "soldier"));
			FantomMakeCoolFighter(sld, iRank, 65, 65, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", 200);
		}
		ChangeCharacterAddressGroup(sld, "Villemstad_ExitTown", "reload", "reload4");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	DoQuestFunctionDelay("Patria_CuracaoGateBattleBoom1", 2.0);
}

void Patria_CuracaoGateBattleRush(string qName) // ручная боевка
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	LAi_SetPlayerType(pchar);
	LAi_SetFightMode(pchar, true);
	// французы
	for (int i=1; i<=15; i++)
	{
		if (GetCharacterIndex("Curacao_fra_soldier_"+i) != -1)
		{
			sld = characterFromId("Curacao_fra_soldier_"+i);
			LAi_SetWarriorType(sld);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
	// офицеры
	int n = 0;
	for(i=1; i<=3; i++)
	{
		int idx = GetOfficersIndex(pchar, i);
		if(idx < 0) continue;
		sld = &Characters[idx];
		SetCharacterTask_FollowCharacter(sld, PChar); 
		n++;
	}
	if(GetOfficersQuantity(pchar) > 0)
	{
		pchar.OfficerAttRange = 35.0;
		OfficersFollow();
	}	
	// англичане
	for (i=1; i<=15; i++)
	{
		sld = characterFromId("Curacao_eng_soldier_"+i);
		if (i == 4 || i == 5 || i == 6 || i > 13) continue;
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	LAi_group_SetCheck("EnemyFight", "Patria_CuracaoGateBattleEnd");
}

void Patria_CuracaoTownBombing() // обстрел города
{
	LAi_SetActorType(pchar);
	LAi_ActorTurnToLocator(pchar, "reload", "reload4");
	pchar.questTemp.Patria.Curacao.BoomGate3 = "true";
	DoQuestFunctionDelay("Patria_CuracaoGateBattleBoom1", 5.0);
	DoQuestFunctionDelay("Patria_CuracaoTownBombingTime", 40.0);
	AddQuestRecord("Patria", "62");
}

void Patria_CuracaoTownBombingTime(string qName) // 
{
	DeleteAttribute(pchar, "questTemp.Patria.Curacao.BoomGate3");
}

void Patria_CuracaoTownBombingEnd(string qName) // 
{
	SetLaunchFrameFormParam("After a two hours bombardement,"+ NewStr() +"the Dutch has sent a parley party", "", 0, 5);
	LaunchFrameForm();
	WaitDate("", 0, 0, 0, 2, 10); //крутим время
	RecalculateJumpTable();
	StoreDayUpdate();
	RefreshWeather();
	RefreshLandTime();
	DoQuestFunctionDelay("Patria_CuracaoParlamenter", 5.0);
}

void Patria_CuracaoParlamenter(string qName) // парламентеры
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	for (int i=1; i<=15; i++)
	{
		if (GetCharacterIndex("Curacao_fra_soldier_"+i) != -1)
		{
			sld = characterFromId("Curacao_fra_soldier_"+i);
			LAi_SetStayType(sld);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
	for (i=1; i<=3; i++)
	{
		if (i == 1) // офицер
		{
			sld = GetCharacter(NPC_GenerateCharacter("Curacao_parlamenter_"+i, "off_hol_5", "man", "man", 20, HOLLAND, 5, false, "soldier"));
			FantomMakeCoolFighter(sld, 20, 65, 65, LinkRandPhrase("blade_18","blade_19","blade_21"), "pistol6", "bullet", 100);
			sld.Dialog.Filename = "Quest\Patria_NPC.c";
			sld.dialog.currentnode = "holoff";
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Curacao_parlamenter_"+i, "sold_hol_"+(rand(7)+9), "man", "man", 15, HOLLAND, 5, false, "soldier"));
			FantomMakeCoolFighter(sld, 20, 60, 60, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", 100);
			LAi_CharacterDisableDialog(sld);
		}
		ChangeCharacterAddressGroup(sld, "Villemstad_ExitTown", "reload", "reload4");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
	DoQuestCheckDelay("pchar_back_to_player", 4.0);
}

void Patria_CuracaoParlamenterGo() // парламентеры уходят
{
	for (int i=1; i<=3; i++)
	{
		sld = characterFromId("Curacao_parlamenter_"+i);
		LAi_SetActorType(sld);
		LAi_ActorRunToLocation(sld, "reload", "reload4", "none", "", "", "Patria_CuracaoStivesantWait", -1);
	}
}

void Patria_CuracaoStivesant(string qName) // Стайвесант
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	sld = characterFromId("Stivesant");
	sld.dialog.currentnode = "Stivesant_33";
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "Villemstad_ExitTown", "reload", "reload4");
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	for (int i=1; i<=3; i++)
	{
		sld = characterFromId("Curacao_parlamenter_"+i);
		LAi_SetActorType(sld);
		ChangeCharacterAddressGroup(sld, "Villemstad_ExitTown", "reload", "reload4");
		LAi_ActorFollow(sld, characterFromID("Stivesant"), "", -1);
	}
}

void Patria_CuracaoStivesantGo() // Стайвесант уходит
{
	sld = characterFromId("Stivesant");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "reload4", "none", "", "", "Patria_CuracaoResult", -1);
	for (int i=1; i<=3; i++)
	{
		sld = characterFromId("Curacao_parlamenter_"+i);
		LAi_SetActorType(sld);
		LAi_ActorRunToLocation(sld, "reload", "reload4", "none", "", "", "", -1);
	}
}

void Patria_CuracaoClear() // прибираемся немного
{
	chrDisableReloadToLocation = false;//открыть локацию
	pchar.GenQuest.Hunter2Pause = true;
	// меняем отношения наций
	pchar.questTemp.Patria.Neutral = "true";
	LaunchNationLegend();
	DeleteAttribute(pchar, "questTemp.Patria.Neutral");
	DoQuestCheckDelay("sea_victory", 0.2);
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], false);//разрешить драться
	LocatorReloadEnterDisable("Shore24", "reload1_back", false); // 17-add
	LocatorReloadEnterDisable("Shore22", "reload1_back", false); // 17-add
	LocatorReloadEnterDisable("Curacao_jungle_03", "reload2_back", false);// лесник
	sld = characterFromId("Doily_land");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	for (int i=1; i<=15; i++)
	{
		sld = characterFromId("Curacao_eng_soldier_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	for (i=1; i<=15; i++)
	{
		if (GetCharacterIndex("Curacao_fra_soldier_"+i) != -1)
		{
			sld = characterFromId("Curacao_fra_soldier_"+i);
			LAi_SetActorType(sld);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
			LAi_ActorFollowEverywhere(sld, "", -1);
		}
	}
	pchar.quest.Patria_CuracaoClear.win_condition.l1 = "EnterToSea";
	pchar.quest.Patria_CuracaoClear.function = "Patria_CuracaoClearLand";
}

void Patria_CuracaoClearLand(string qName) // продолжаем чистить
{
	Island_SetReloadEnableGlobal("Curacao", false);//закрыть остров
	bQuestDisableMapEnter = false;//открыть карту
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	DeleteAttribute(pchar, "GenQuest.CannotWait");
	for (int i=1; i<=15; i++)
	{
		if (GetCharacterIndex("Curacao_fra_soldier_"+i) != -1)
		{
			sld = characterFromId("Curacao_fra_soldier_"+i);
			sld.lifeday = 0;
		}
	}
	sld = characterFromId("Doily_land");
	sld.lifeday = 0;
	for (i=1; i<=15; i++)
	{
		sld = characterFromId("Curacao_eng_soldier_"+i);
		sld.lifeday = 0;
	}
	int n = Findlocation("Villemstad_ExitTown");
	DeleteAttribute(&locations[n], "models.always.mortair1");
	DeleteAttribute(&locations[n], "models.always.mortair2");
	locations[FindLocation("Shore23")].DisableEncounters = false;
	locations[FindLocation("Shore24")].DisableEncounters = false;
	locations[FindLocation("Villemstad_ExitTown")].DisableEncounters = false;
	locations[FindLocation("Curacao_jungle_01")].DisableEncounters = false;
	locations[FindLocation("Curacao_jungle_02")].DisableEncounters = false;
	locations[FindLocation("Curacao_jungle_03")].DisableEncounters = false;
	LocatorReloadEnterDisable("Curacao_jungle_03", "reloadW_back", false);
	LocatorReloadEnterDisable("Shore24", "reload1_back", false);
	LocatorReloadEnterDisable("Shore22", "reload1_back", false);
	LocatorReloadEnterDisable("Curacao_jungle_03", "reload2_back", false); // лесник вход ван-хато с джунглей
	// маленький сюрприз в пещере убираем, если не нашел
	pchar.GenQuestBox.Curacao_Cave = true;
	pchar.GenQuestBox.Curacao_Cave.box2.money = 1;
	pchar.GenQuestBox.Curacao_Cave.box2.items.Mineral26 = 1;
	pchar.quest.Patria_CuracaoClear1.win_condition.l1 = "MapEnter";
	pchar.quest.Patria_CuracaoClear1.function = "Patria_CuracaoComplete";
	DeleteAttribute(pchar, "DisableChangeFlagMode"); // 15-add
}

void Patria_CuracaoComplete(string qName) // заканчиваем чистить
{
	Group_SetAddress("Patria_DoilySquadron", "Jamaica", "quest_ships", "quest_ship_1");
	Group_DeleteGroup("Patria_DoilySquadron");
	sld = characterFromId("PortRoyal_Mayor");
	ChangeCharacterAddressGroup(sld, "PortRoyal_townhall", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
	sld = characterFromId("Noel");
	ChangeCharacterAddressGroup(sld, "none", "", ""); // прячем инспектора
	pchar.questTemp.Patria = "epizode_11_return";
	SetFunctionTimerCondition("Patria_CuracaoRebuild", 0, 0, 5, false); // таймер на возврат Кюрасао в норму
}

void Patria_CuracaoRebuild(string qName) // Кюрасао в норму
{
	Island_SetReloadEnableGlobal("Curacao", true);//открыть остров
	sld = CharacterFromID("Villemstad Fort Commander");
	Character_SetAbordageEnable(sld, true);
	LocatorReloadEnterDisable("Villemstad_ExitTown", "reload4", false);
	sld = characterFromId("Stivesant");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld = characterFromId("hol_guber");
	ChangeCharacterAddressGroup(sld, "Villemstad_townhall", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "HOLLAND_CITIZENS");
}

//--------------------------------------------------------------- 12 эпизод ----------------------------------------------------------
void Patria_CondotierStart() // 
{
	// отсоединяем Эклятон
	if (!CheckAttribute(pchar, "questTemp.Patria.Ecliaton_Fail"))
	{
		sld = characterFromId("Ecliaton_Cap");
		sld.ShipHideImmortal = 1000; // непотопляемый корабль
		RemoveCharacterCompanion(pchar, sld);
		sld.AlwaysFriend = true;
		sld.ShipEnemyDisable = true;
		Group_AddCharacter("Ecliaton_group", "Ecliaton_Cap");
		Group_SetGroupCommander("Ecliaton_group", "Ecliaton_Cap");
		Group_SetAddress("Ecliaton_group", "Nevis", "quest_ships", "quest_ship_1");
		Group_SetTaskNone("Ecliaton_group");
		Group_LockTask("Ecliaton_group");
		SetFunctionTimerCondition("Patria_EcliatonRepair", 0, 0, 5, false); // таймер на починку Эклятона
		DeleteAttribute(pchar, "questTemp.Patria.Ecliaton");
		Achievment_SetStat(pchar, 79, 1);
	}
	SetFunctionTimerCondition("Patria_CondotierToPuancie", 0, 0, 30, false); // таймер
}

void Patria_CondotierToPuancie(string qName) // месяц прошел, к Пуанси
{
	pchar.questTemp.Patria = "epizode_12_continue";
	AddQuestRecord("Patria", "66");
	Group_DeleteGroup("Ecliaton_group"); // Эклятон ушел в Европу
}

void Patria_CondotierSail() // 
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	sld = CharacterFromID("Noel");
	sld.dialog.currentnode = "noel_28";
	ChangeCharacterAddressGroup(sld, "PortPax_townhall", "goto", "governor1");
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
}

void Patria_CondotierToPirates(string qName) // 
{
	DoQuestReloadToLocation("Portpax_tavern", "tables", "stay3", "Patria_CondotierToPirates");
}

void Patria_CondotierTimeOver(string qName) // две недели прошли
{
	if (CheckAttribute(pchar, "questTemp.Patria.Condotier.Success"))
	{
		SetFunctionTimerCondition("Patria_CondotierTimeToGo", 0, 0, 9, false);
	}
	else // провалили
	{
		AddQuestRecord("Patria", "69");
		pchar.questTemp.Patria.Arest = "true";
		//pchar.questTemp.Patria = "fail";
		CloseQuestHeader("Patria");
		SetFunctionTimerCondition("Patria_Arest", 0, 0, 180, false); // арест через полгода
	}
}

void Patria_CondotierTimeToGo(string qName) // пора идти к пиратскому барону
{
	if (CheckAttribute(pchar, "questTemp.Patria.Saga.Shark") || CheckAttribute(pchar, "questTemp.Patria.Saga.Terrax")) 
	{
		AddQuestRecord("Patria", "72_1");
		LocatorReloadEnterDisable("Pirates_town", "reload3_back", false);
	}
	else
	{
		AddQuestRecord("Patria", "72_2");
		LocatorReloadEnterDisable("Lavega_town", "reload6", false);
	}
	pchar.questTemp.Patria = "epizode_12_talk";
}

void Patria_CondotierTerks(string qName) // на Терксе
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	pchar.quest.Patria_Condotier_Terks.win_condition.l1 = "location";
	pchar.quest.Patria_Condotier_Terks.win_condition.l1.location = "Shore56";
	pchar.quest.Patria_Condotier_Terks.function = "Patria_CondotierOnTerks";
	LAi_LocationDisableOfficersGen("Shore56", true);//офицеров не пускать
	if (CheckAttribute(pchar, "questTemp.Patria.Saga.Shark"))
	{
		// ставим корабль Додсона
		Group_FindOrCreateGroup("DodsonFrigate");
		sld = GetCharacter(NPC_GenerateCharacter("Dodson_sea", "Shark", "man", "man", 45, PIRATE, -1, true, "quest"));
		FantomMakeCoolSailor(sld, SHIP_FRIGATE_H, "Фортуна", CANNON_TYPE_CANNON_LBS32, 105, 105, 105);
		FantomMakeCoolFighter(sld, 45, 100, 100, "blade_21", "pistol5", "bullet", 100);
		sld.Abordage.Enable = false;
		sld.AlwaysFriend = true;
		sld.ShipEnemyDisable = true; 
		LAi_SetImmortal(sld, true); // сплошная защита от дурака
		sld.DontDeskTalk = true;
		sld.nation = PIRATE;
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		Group_AddCharacter("DodsonFrigate", "Dodson_sea");
		Group_SetGroupCommander("DodsonFrigate", "Dodson_sea");
		Group_SetTaskNone("DodsonFrigate");
		Group_SetAddress("DodsonFrigate", "Terks", "quest_ships", "quest_ship_2");
		Group_LockTask("DodsonFrigate");
	}
	else
	{
		// ставим корабль Тиракса
		Group_FindOrCreateGroup("DodsonFrigate");
		sld = GetCharacter(NPC_GenerateCharacter("Terrax_sea", "Terrax", "man", "man", 45, PIRATE, -1, true, "quest"));
		FantomMakeCoolSailor(sld, SHIP_LINESHIP, "Красный дракон", CANNON_TYPE_CULVERINE_LBS36, 110, 110, 110);
		FantomMakeCoolFighter(sld, 45, 100, 100, "blade_21", "pistol5", "bullet", 100);
		sld.Abordage.Enable = false;
		sld.AlwaysFriend = true;
		sld.ShipEnemyDisable = true; 
		LAi_SetImmortal(sld, true); // сплошная защита от дурака
		sld.DontDeskTalk = true;
		sld.nation = PIRATE;
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		RealShips[sti(sld.Ship.Type)].ship.upgrades.hull = 1;
		SetSailsColor(sld, 8);//черный парус
		Group_AddCharacter("DodsonFrigate", "Terrax_sea");
		Group_SetGroupCommander("DodsonFrigate", "Terrax_sea");
		Group_SetTaskNone("DodsonFrigate");
		Group_SetAddress("DodsonFrigate", "Terks", "quest_ships", "quest_ship_2");
		Group_LockTask("DodsonFrigate");
	}
}

void Patria_CondotierOnTerks(string qName) // на Терксе
{
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation("Shore56")], true);//запретить драться
	LAi_LocationDisableOfficersGen("Shore56", true);//офицеров не пускать
	if (CheckAttribute(pchar, "questTemp.Patria.Saga.Shark")) sld = CharacterFromID("Dodson");
	else sld = CharacterFromID("Terrax");
	sld.dialog.currentnode = "patria_15";
	ChangeCharacterAddressGroup(sld, "Shore56", "goto", "goto5");
	LAi_SetActorType(sld);
	LAi_SetActorType(pchar);
	LAi_ActorFollow(pchar, sld, "ActorDialog_Any2Pchar", -1);
	LAi_ActorTurnToCharacter(sld, pchar);
	SetActorDialogAny2Pchar(sld.id, "", 0.0, 0.0);
	//LAi_ActorDialogDelay(sld, pchar, "", 4.0);
	sld = CharacterFromID("Noel");
	ChangeCharacterAddressGroup(sld, "Shore56", "goto", "goto12");
	LAi_SetActorType(sld);
	sld = GetCharacter(NPC_GenerateCharacter("Terks_pirat", "mush_ctz_9", "man", "mushketer", 30, PIRATE, 2, false, "soldier"));
	FantomMakeCoolFighter(sld, 30, 60, 60, "", "mushket1", "cartridge", 170);
	ChangeCharacterAddressGroup(sld, "Shore56", "goto", "goto6");
	LAi_SetActorType(sld);
}

void Patria_CondotierTerksOver(string qName) // нельзя заставлять ждать
{
	pchar.quest.Patria_Condotier_Terks.over = "yes"; //снять прерывание
	Group_DeleteGroup("DodsonFrigate");
	DoQuestCheckDelay("Patria_CondotierDodsonNorm", 1.0);
	if (CheckAttribute(pchar, "questTemp.Patria.Pirate.Terrax")) DoQuestCheckDelay("Patria_CondotierTerraxNorm", 1.0); // Ла Вега
	else DoQuestCheckDelay("Patria_CondotierDodsonNorm", 1.0);
	pchar.questTemp.Patria.DodsonFail = "true";
	LAi_LocationDisableOfficersGen("Shore56", false);
}

void Patria_CondotierEnCapstervil(string qName) // пришли в Капстервиль с бароном
{
	chrDisableReloadToLocation = true;
	LocatorReloadEnterDisable("Charles_town", "reload3_back", true); // закрыть на сутки резиденцию
	sld = CharacterFromID("Noel");
	sld.dialog.currentnode = "noel_final";
	RemovePassenger(pchar, sld);
	ChangeCharacterAddressGroup(sld, "Charles_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Patria_CondotierPuancieFinal(string qName) // пора к Пуанси
{
	LocatorReloadEnterDisable("Charles_town", "reload3_back", false); 
	Island_SetReloadEnableGlobal("Bermudes", true);
}

void Patria_CondotierToCabin(string qName) // 
{
	DoQuestReloadToLocation("Portpax_tavern", "tables", "stay3", "Patria_CondotierToCabin");
}

void Patria_CondotierInCabin(string qName) // 
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = CharacterFromID("Noel");
	sld.dialog.currentnode = "noel_62";
	ChangeCharacterAddressGroup(sld, pchar.location, "rld", "aloc0");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	sld = CharacterFromID(pchar.questTemp.Patria.SpanishID);
	ChangeCharacterAddressGroup(sld, pchar.location, "rld", "aloc1");
	LAi_SetActorType(sld);
}

void Patria_CondotierInCabinTalk(string qName) // 
{
	SetLaunchFrameFormParam("Прошло два часа..."+ NewStr() +"", "", 0, 5);
	LaunchFrameForm();
	WaitDate("", 0, 0, 0, 2, 10); //крутим время
	RecalculateJumpTable();
	StoreDayUpdate();
	RefreshWeather();
	RefreshLandTime();
	DoQuestFunctionDelay("Patria_CondotierInCabinResult", 5.0);
}

void Patria_CondotierInCabinResult(string qName) // 
{
	sld = CharacterFromID("Noel");
	sld.dialog.currentnode = "noel_64";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	sld = CharacterFromID(pchar.questTemp.Patria.SpanishID);
	LAi_SetActorType(sld);
	LAi_ActorGoToLocation(sld, "reload", "reload1", "none", "", "", "", 5.0);
}

void Patria_CondotierToMine(string qName) // в бухте Гранд Кейс, идем на рудник
{
	pchar.GenQuest.Hunter2Pause = true;
	pchar.GenQuest.CannotWait = true;
	LocatorReloadEnterDisable("Shore40", "reload2_back", false);
	LocatorReloadEnterDisable("Shore40", "reload1_back", true);
	LocatorReloadEnterDisable("Shore40", "boat", true);
	sld = CharacterFromID("Noel");
	sld.dialog.currentnode = "noel_74";
	ChangeCharacterAddressGroup(sld, "Shore40", "goto", "goto8");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Patria_CondotierInMine(string qName) // на руднике
{
	chrDisableReloadToLocation = true;//закрыть локацию
	FreeSitLocator("Location_reserve_03", "patrol19");
	FreeSitLocator("Location_reserve_03", "patrol20");
	LAi_SetActorType(pchar);
	LAi_ActorRunToLocator(pchar, "goto", "goto26", "Patria_CondotierInMine", -1);
}

void Patria_CondotierBaronFail(string qName) // барон помер от избытка времени
{
	sld = CharacterFromID("Noel");
	RemovePassenger(pchar, sld);
	sld.lifeday = 0;
	log_info("Baron Noel Forget died of fever!");
	AddQuestRecord("Patria", "75_1");
	pchar.questTemp.Patria = "epizode_12_baronfail";
}

void Patria_CondotierBeachFight(string qName) // бой на пляже
{
	LAi_LocationFightDisable(&Locations[FindLocation("Location_reserve_01")], false);
	LAi_group_Delete("EnemyFight");
	sld = CharacterFromID("Noel");
	LAi_SetImmortal(sld, false);
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	for (int i=1; i<=5; i++)
	{
		sld = CharacterFromID("Marigo_eng_soldier_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "Patria_CondotierBeachAfterFight");
	LAi_SetFightMode(pchar, true);
	pchar.quest.Patria_Baron_killed.win_condition.l1 = "NPC_Death";
	pchar.quest.Patria_Baron_killed.win_condition.l1.character = "Noel";
	pchar.quest.Patria_Baron_killed.function = "Patria_CondotierBaronKilled";
}

void Patria_CondotierBaronKilled(string qName) // барон помер от сабли или пули
{
	pchar.questTemp.Patria.Condotier.BaronKilled = "true"; 
}

void Patria_CondotierInShore40(string qName) // 
{
	DeleteAttribute(pchar, "GenQuest.CannotWait");
	chrDisableReloadToLocation = true;
	sld = CharacterFromID("Noel");
	sld.dialog.currentnode = "noel_79";
	ChangeCharacterAddressGroup(sld, "Shore40", "goto", "goto2");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Patria_CondotierOnCuracao(string qName) // 
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	pchar.quest.Patria_CondotierBaronFail.over = "yes"; //снять прерывание
	LAi_LocationFightDisable(&Locations[FindLocation("shore22")], true);
	chrDisableReloadToLocation = true;
	sld = CharacterFromID(pchar.questTemp.Patria.SpanishID);
	sld.Dialog.Filename = "Quest\Patria_NPC.c";
	sld.dialog.currentnode = "miner";
	LAi_CharacterEnableDialog(sld);
	ChangeCharacterAddressGroup(sld, "Shore22", "goto", "goto1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	LocatorReloadEnterDisable("Location_reserve_01", "reload1_back", false); //14-add
}

void Patria_CondotierStivesant(string qName) // приходит Стайвесант
{
	if (pchar.location != "shore22") return; // тут глюк
	sld = CharacterFromID("Noel");
	LAi_SetActorType(sld);
	LAi_ActorTurnToLocator(sld, "reload", "reload1");
	// перекидываем пчар на инспектора
	LAi_SetActorType(pchar);
	SetMainCharacterIndex(GetCharacterIndex("Noel"));
	pchar = GetMainCharacter();			
	LAi_SetPlayerType(pchar);
	locCameraTarget(pchar);
	locCameraFollow();
	StartQuestMovie(true, true, true);
	InterfaceStates.Buttons.Save.enable = true;
	bDisableCharacterMenu = true;//лоченые интерфейсы
	sld = CharacterFromID("Stivesant");
	sld.dialog.currentnode = "Stivesant_42";
	ChangeCharacterAddressGroup(sld, "Shore22", "reload", "reload1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	for (int i=1; i<=3; i++)
	{
		if (i == 1) // офицер
		{
			sld = GetCharacter(NPC_GenerateCharacter("Stivesant_sold_"+i, "off_hol_5", "man", "man", 20, HOLLAND, 5, false, "soldier"));
			FantomMakeCoolFighter(sld, 20, 65, 65, LinkRandPhrase("blade_18","blade_19","blade_21"), "pistol6", "bullet", 100);
			LAi_CharacterDisableDialog(sld);
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("Stivesant_sold_"+i, "sold_hol_"+(rand(7)+9), "man", "man", 15, HOLLAND, 5, false, "soldier"));
			FantomMakeCoolFighter(sld, 20, 60, 60, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", 100);
			LAi_CharacterDisableDialog(sld);
		}
		ChangeCharacterAddressGroup(sld, "Shore22", "reload", "reload1_back");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void Patria_CondotierCabin(string qName) // 
{
	bQuestDisableMapEnter = true;//закрыть карту
	Island_SetReloadEnableGlobal("Curacao", false);
	pchar.GenQuest.MapClosedNoBattle = true; 
	DoQuestFunctionDelay("Patria_CondotierToCabinAgain", 1.5);
}

void Patria_CondotierToCabinAgain(string qName) // в каюту
{
	Sea_CabinStartNow();
	DoQuestFunctionDelay("Patria_CondotierInCabinAgain", 1.8);
}

void Patria_CondotierInCabinAgain(string qName) // в каюту
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Noel");
	sld.dialog.currentnode = "noel_90";
	ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Patria_CondotierBaronWin(string qName) // 
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Noel");
	sld.dialog.currentnode = "noel_96";
	RemovePassenger(pchar, sld);
	ChangeCharacterAddressGroup(sld, "Charles_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Patria_CondotierStivesantTimeOver(string qName) // просрочка таймера Стайвесанта
{
	AddQuestRecord("Patria", "88");
	RemoveItems(pchar, "patent_fra", 1);
	ChangeCharacterComplexReputation(pchar, "nobility", -60);
	ChangeCharacterComplexReputation(pchar, "authority", -20);
	ChangeCharacterNationReputation(pchar, FRANCE, -200);
	ChangeCharacterNationReputation(pchar, ENGLAND, -100);
	pchar.questTemp.Patria = "fail";
	CloseQuestHeader("Patria");
	pchar.quest.Patria_CondotierRemove_baron.win_condition.l1 = "Location_Type";
	pchar.quest.Patria_CondotierRemove_baron.win_condition.l1.location_type = "town";
	pchar.quest.Patria_CondotierRemove_baron.function = "Patria_CondotierRemoveBaron";
	LocatorReloadEnterDisable("Charles_townhall", "reload3", true); // закрыть вход к Пуанси
	sld = characterFromId("Stivesant");
	ChangeCharacterAddressGroup(sld, "none", "", "");
}

void Patria_CondotierRemoveBaron(string qName) // 
{
	sld = characterFromId("Noel");
	RemovePassenger(pchar, sld);
	sld.lifeday = 0;
	log_info("Baron Noel Forget has left your ship!");
	
}

void Patria_EuropeTime(string qName) // 
{
	pchar.quest.Patria_Europe_Time.win_condition.l1 = "Location_Type";
	pchar.quest.Patria_Europe_Time.win_condition.l1.location_type = "town";
	pchar.quest.Patria_Europe_Time.function = "Patria_EuropeCureer";
	DeleteAttribute(pchar, "questTemp.Patria.Governor"); // доходы от Пуанси прекратились
}

void Patria_EuropeCureer(string qName) // 
{
	chrDisableReloadToLocation = true;//закрыть локацию
	DoQuestFunctionDelay("Patria_EuropeSetCureer", 2.0);
}

void Patria_EuropeSetCureer(string qName) // 
{
	if(!GetDLCenabled(DLC_APPID_4)) return;
	float locx, locy, locz;
	sld = GetCharacter(NPC_GenerateCharacter("Europe_cureer", "citiz_32", "man", "man", 10, FRANCE, -1, false, "soldier"));
	FantomMakeCoolFighter(sld, 10, 20, 20, LinkRandPhrase("blade_08","blade_12","blade_14"), "pistol1", "bullet", 100);
	sld.Dialog.Filename = "Quest\Patria_NPC.c";
	sld.dialog.currentnode = "cureer";
	LAi_SetImmortal(sld, true);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Patria_EuropePrepare() // готовим всех персонажей
{
	AddQuestRecord("Patria", "89");
	// Пуанси в тюрьму
	sld = characterFromId("Puancie");
	sld.dialog.currentnode = "patria_prison";
	sld.greeting = "";
	LAi_SetStayType(sld);
	RemoveCharacterEquip(sld, BLADE_ITEM_TYPE);
	RemoveCharacterEquip(sld, GUN_ITEM_TYPE);
	RemoveCharacterEquip(sld, CIRASS_ITEM_TYPE);
	ChangeCharacterAddressGroup(sld, "Charles_prison", "goto", "goto9");
	LocatorReloadEnterDisable("Charles_town", "reload_jail", true);
	// барона в резиденцию
	sld = characterFromId("Noel");
	sld.dialog.currentnode = "noel_98";
	LAi_SetStayType(sld);
	ChangeCharacterAddressGroup(sld, "Charles_roomtownhall", "goto", "goto6");
	// заместитель министра финансов
	sld = GetCharacter(NPC_GenerateCharacter("Finansist", "off_fra_6", "man", "man", 25, FRANCE, -1, false, "officer"));
	FantomMakeCoolFighter(sld, 25, 80, 80, "blade_17", "pistol5", "bullet", 120);
	sld.Dialog.Filename = "Quest\Patria_NPC.c";
	sld.dialog.currentnode = "burden";
	sld.name = "Olivier";
	sld.lastname = "Burden";
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "Charles_roomtownhall", "goto", "goto4");
	LAi_SetActorType(sld);
}

void Patria_EuropePuancieClear(string qName) // 
{
	sld = characterFromId("Puancie");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld = characterFromId("Finansist");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld.lifeday = 0;
	// рудник
	for (int i=1; i<=15; i++) // солдаты
	{
		sld = characterFromId("MarigoMine_soldier_"+i);
		sld.model = "sold_fra_"+(rand(7)+1);
		sld.nation = FRANCE;
	}
}

void Patria_EuropeFinal(string qName) // 
{
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = characterFromId("Noel");
	sld.dialog.currentnode = "noel_103";
	ChangeCharacterAddressGroup(sld, "charles_town", "goto", "goto1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void Patria_EuropeMusic(string qName) // 7-add
{
	SetMusic("music_alcove_1");
}

/// Jason ----------------------------------------------------------- Дороже золота ------------------------------------------------------------------
void GoldenGirl_Start() // инициализация
{
	if(!GetDLCenabled(DLC_APPID_5)) return; // Captain Beltrop, не было проверки на наличие DLC, из-за чего ДиС можно было начать без покупки оного. Fix
	// запускаем слухи
	AddSimpleRumour("Did you hear about that pricey courtesan from the North Colonies who is now running the house of joy in St. Pierre? They say she throws private parties from time to time - only the best of high society is allowed to attend. Best wine, gorgeous women and unlimited gambling, everything a true noble values. Getting an invitation there is worth a killing.", FRANCE, 180, 5);
	AddSimpleRumour("The say Marquise Botot herself is now a guest of St. Pierre. The most of expensive woman of New France. Sometime she throws parties for creme de la creme only. The true nest for the most gracious vices. They say one banker gambled away his very own bank there, imagine that. Alas, without an invitation even the richest are unwelcome.", FRANCE, 180, 5);
	AddSimpleRumour("St. Pierre's brothel is now being run by an elite courtesan. The place itself didn't change much, but the private parties she throws there… Folk tell stories. That it is like in good old Paris - best wine, best wenches, best company. And most peculiar guests - like Spanish admirals and pirate barons! Unbelievable, aye?", FRANCE, 180, 5);
	
	LocatorReloadEnterDisable("FortFrance_town", "reload91", false); // fix 22-03-20 открыть боковой вход если закрыт (Captain Beltrop, 19.02.2021, правка в названии локатора)
	// меняем внутрянку гостиной борделя
	int n = Findlocation("FortFrance_SecBrRoom");
	locations[n].image = "loading\inside\BigHouseBack.tga";
	locations[n].filespath.models = "locations\inside\BigHouseBack";
	locations[n].models.always.house = "BigHouseBack";
	locations[n].models.always.house.level = 65538;
	locations[n].models.always.window = "BigHouseBack_windows";
	locations[n].models.always.window.tech = "LocationWindows";
	locations[n].models.always.window.level = 65539;
	locations[n].models.always.back = "..\inside_back";
	locations[n].models.always.back.level = 65529;
	//Day
	locations[n].models.day.charactersPatch = "BigHouseBack_patch";
	locations[n].models.day.locators = "BigHouseBack_locators";
	//Night
	locations[n].models.night.charactersPatch = "BigHouseBack_patch";
	locations[n].models.night.locators = "BigHouseBack_locators";
	locations[n].box1.QuestClosed = true;
	locations[n].box2.QuestClosed = true;
	locations[n].box3.QuestClosed = true;
	locations[n].DisableOfficers = "1";
	LAi_LocationFightDisable(&locations[n], true);
	// добавляем вход в еще одну комнату
	locations[n].reload.l3.name = "reload3";
	locations[n].reload.l3.go = "Location_reserve_02";
	locations[n].reload.l3.emerge = "reload1";
	locations[n].reload.l3.autoreload = "0";
	locations[n].reload.l3.label = "Brothel";
	LocatorReloadEnterDisable("FortFrance_SecBrRoom", "reload3", true);
	
	// добавляем еще одну комнату
	n = Findlocation("Location_reserve_02");
	locations[n].image = "loading\inside\BigHouse04.tga";
	//Always
	locations[n].filespath.models = "locations\Inside\BigHouse04";
	locations[n].models.always.room = "BigHouse04";
	locations[n].models.always.room.level = 65538;
	locations[n].models.always.windows = "BigHouse04_windows";
	locations[n].models.always.windows.tech = "LocationWindows";
	locations[n].models.always.windows.level = 65539;
	locations[n].models.always.back = "..\inside_back";
	locations[n].models.always.back.level = 65529;
	//Day
	locations[n].models.day.charactersPatch = "BigHouse04_patch";
	locations[n].models.day.locators = "BigHouse04_locators";
	//Night
	locations[n].models.night.charactersPatch = "BigHouse04_patch";
	locations[n].models.night.locators = "BigHouse04_Nlocators";
	//Environment
	locations[n].environment.weather = "true";
	locations[n].environment.sea = "false";
	//Reload map
	locations[n].reload.l1.name = "reload1";
	locations[n].reload.l1.go = "FortFrance_SecBrRoom";
	locations[n].reload.l1.emerge = "reload3";
	locations[n].reload.l1.autoreload = "0";
	locations[n].reload.l1.label = "Room";
	locations[n].DisableOfficers = "1";
	LAi_LocationFightDisable(&locations[n], true);
	
	// проверка на наличие Элен или Мэри
	if (!GoldenGirl_CheckGirls()) return;
	
	// создаем маркизу Бото
	sld = GetCharacter(NPC_GenerateCharacter("Julianna", "Marquesa", "woman", "towngirl", 1, FRANCE, -1, false, "quest"));
	sld.name = "Julianne";
	sld.lastname = "Botot";
	sld.greeting = "";
    sld.Dialog.Filename = "Quest\GoldenGirl.c";
	sld.dialog.currentnode = "Julianna";
	sld.rank = 1;
	LAi_SetHP(sld, 50, 50); 
	SetSelfSkill(sld, 1, 1, 1, 1, 50);
	SetShipSkill(sld, 90, 50, 1, 1, 1, 1, 1, 1, 50);
	SetSPECIAL(sld, 3, 8, 4, 8, 6, 4, 9);
	LAi_SetImmortal(sld, true);
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	// создаем Ангеррана Шиво
	sld = GetCharacter(NPC_GenerateCharacter("Angerran", "Angerran", "man", "man", 1, FRANCE, -1, false, "quest"));
	sld.name = "Angerran";
	sld.lastname = "de Chievous";
	sld.greeting = "";
    sld.Dialog.Filename = "Quest\GoldenGirl.c";
	sld.dialog.currentnode = "Angerran";
	sld.rank = 35;
	LAi_SetHP(sld, 600, 600); 
	SetSelfSkill(sld, 70, 95, 70, 90, 90);
	SetShipSkill(sld, 20, 70, 80, 80, 80, 70, 70, 70, 70);
	SetSPECIAL(sld, 8, 4, 8, 6, 6, 10, 6);
	SetCharacterPerk(sld, "Energaiser");
	SetCharacterPerk(sld, "BasicDefense");
	SetCharacterPerk(sld, "AdvancedDefense");
	SetCharacterPerk(sld, "CriticalHit");
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "Gunman");
	SetCharacterPerk(sld, "GunProfessional");
	SetCharacterPerk(sld, "Sliding");
	SetCharacterPerk(sld, "HardHitter");
	SetCharacterPerk(sld, "SwordplayProfessional");
	SetCharacterPerk(sld, "ShipSpeedUp");
	SetCharacterPerk(sld, "ShipTurnRateUp");
	SetCharacterPerk(sld, "StormProfessional");
	SetCharacterPerk(sld, "WindCatcher");
	SetCharacterPerk(sld, "SailsMan");
	SetCharacterPerk(sld, "Doctor1");
	SetCharacterPerk(sld, "MusketsShoot");
	SetCharacterPerk(sld, "LongRangeGrappling");
	SetCharacterPerk(sld, "HullDamageUp");
	SetCharacterPerk(sld, "HullDamageUp");
	SetCharacterPerk(sld, "SailsDamageUp");
	SetCharacterPerk(sld, "CrewDamageUp");
	SetCharacterPerk(sld, "CriticalShoot");
	SetCharacterPerk(sld, "BasicCommerce");
	SetCharacterPerk(sld, "AdvancedCommerce");
	GiveItem2Character(sld, "blade_19");
	sld.equip.blade = "blade_19";
	GiveItem2Character(sld, "pistol6");
	EquipCharacterbyItem(sld, "pistol6");
	LAi_SetCharacterUseBullet(sld, "bullet");
    TakeNItems(sld, "bullet", 50);
	AddItems(sld, "gunpowder", 50);
	TakeNItems(sld, "potion2", MOD_SKILL_ENEMY_RATE/2);
	TakeNItems(sld, "potion3", 5);
	sld.cirassId = Items_FindItemIdx("cirass1"); 
	LAi_SetImmortal(sld, true);
	sld.SuperShooter = true;
	sld.MultiFighter = 1.0 + stf(MOD_SKILL_ENEMY_RATE/10);
	sld.MultiShooter = 1.0 + stf(MOD_SKILL_ENEMY_RATE/10);
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	// создаем баронета Кортни
	sld = GetCharacter(NPC_GenerateCharacter("Cortny", "Baronet_1", "man", "man", 1, FRANCE, -1, false, "quest"));
	sld.name = "William";
	sld.lastname = "Cortney";
	sld.greeting = "";
    sld.Dialog.Filename = "Quest\GoldenGirl.c";
	sld.dialog.currentnode = "Cortny";
	sld.rank = 32;
	LAi_SetHP(sld, 400, 400); 
	SetSelfSkill(sld, 90, 70, 70, 85, 70);
	SetShipSkill(sld, 70, 65, 85, 75, 80, 85, 65, 75, 75);
	SetSPECIAL(sld, 7, 5, 8, 7, 6, 8, 7);
	SetCharacterPerk(sld, "Energaiser");
	SetCharacterPerk(sld, "BasicDefense");
	SetCharacterPerk(sld, "AdvancedDefense");
	SetCharacterPerk(sld, "CriticalHit");
	SetCharacterPerk(sld, "Tireless");
	SetCharacterPerk(sld, "Gunman");
	SetCharacterPerk(sld, "GunProfessional");
	SetCharacterPerk(sld, "Sliding");
	SetCharacterPerk(sld, "HardHitter");
	SetCharacterPerk(sld, "SwordplayProfessional");
	SetCharacterPerk(sld, "ShipSpeedUp");
	SetCharacterPerk(sld, "ShipTurnRateUp");
	SetCharacterPerk(sld, "StormProfessional");
	SetCharacterPerk(sld, "WindCatcher");
	SetCharacterPerk(sld, "SailsMan");
	SetCharacterPerk(sld, "Doctor1");
	SetCharacterPerk(sld, "MusketsShoot");
	SetCharacterPerk(sld, "LongRangeGrappling");
	SetCharacterPerk(sld, "HullDamageUp");
	SetCharacterPerk(sld, "HullDamageUp");
	SetCharacterPerk(sld, "SailsDamageUp");
	SetCharacterPerk(sld, "CrewDamageUp");
	SetCharacterPerk(sld, "CriticalShoot");
	SetCharacterPerk(sld, "BasicCommerce");
	GiveItem2Character(sld, "blade_18");
	sld.equip.blade = "blade_18";
	GiveItem2Character(sld, "pistol5");
	EquipCharacterbyItem(sld, "pistol5");
	LAi_SetCharacterUseBullet(sld, "bullet");
    TakeNItems(sld, "bullet", 50);
	AddItems(sld, "gunpowder", 50);
	TakeNItems(sld, "potion2", MOD_SKILL_ENEMY_RATE/2);
	TakeNItems(sld, "potion3", 5);
	sld.cirassId = Items_FindItemIdx("cirass1"); 
	sld.SuperShooter = true;
	sld.MultiFighter = 1.0 + stf(MOD_SKILL_ENEMY_RATE/10);
	sld.MultiShooter = 1.0 + stf(MOD_SKILL_ENEMY_RATE/10);
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	//запуск ативной части
	SetFunctionTimerCondition("GoldenGirl_FortFrance", 0, 0, 30, false); // таймер
	pchar.questTemp.GoldenGirl = "start";
}

void GoldenGirl_FortFrance(string qName) // на Сен-Пьер
{
	pchar.quest.GoldenGirl_go.win_condition.l1 = "location";
	pchar.quest.GoldenGirl_go.win_condition.l1.location = "FortFrance_town";
	pchar.quest.GoldenGirl_go.function = "GoldenGirl_Message";
}

void GoldenGirl_Message(string qName) // вестовой в Сен-Пьере
{
	// проверка на наличие Элен или Мэри
	if (!GoldenGirl_CheckGirls()) return;
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = GetCharacter(NPC_GenerateCharacter("GoldenGirl_FraOfficer", "off_fra_1", "man", "man", 25, FRANCE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 25, 60, 60, "blade_10", "pistol5", "bullet", 100);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.Dialog.Filename = "Quest\GoldenGirl.c";
	sld.dialog.currentnode = "fraofficer";
    ChangeCharacterAddressGroup(sld, "FortFrance_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void GoldenGirl_GirlAngry(string qName) // ссора с подругой
{
	chrDisableReloadToLocation = true;//закрыть локацию
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.Helena")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	sld.dialog.currentnode = "GoldenGirl";
	LAi_SetActorType(sld);
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void GoldenGirl_BrothelDoor(string qName) // закрываем центральный вход в бордель и убираем Аврору
{
	LocatorReloadEnterDisable("FortFrance_town", "reload91", false); // fix 22-03-20 открыть боковой вход если закрыт (Captain Beltrop, 19.02.2021, правка в названии локатора)
	sld = characterFromId("FortFrance_Hostess");
	ChangeCharacterAddressGroup(sld, "none", "", "");
}

void GoldenGirl_TimeOver(string qName) // не пришли на встречу с мадам Бото
{
	pchar.quest.GoldenGirl_bronca.over = "yes"; //снять прерывание
	pchar.quest.GoldenGirl_eventstart.over = "yes"; //снять прерывание
	LAi_LocationDisableOfficersGen("FortFrance_townhall", false);//офицеров пускать
	DoQuestFunctionDelay("GoldenGirl_BrothelNorm", 0.5);
	LocatorReloadEnterDisable("FortFrance_town", "reload1_back", false);
	LocatorReloadEnterDisable("FortFrance_town", "reload2_back", false);
	LocatorReloadEnterDisable("FortFrance_town", "gate_back", false);//открыть выходы из города
	pchar.questTemp.GoldenGirl = "start_fail"; // fix 22-03-20
	AddQuestRecord("GoldenGirl", "3");
	CloseQuestHeader("GoldenGirl");
}

void GoldenGirl_BrothelNorm(string qName) // 
{
	LocatorReloadEnterDisable("FortFrance_town", "reload9_back", false); // бордель - открыть, Аврору на место
	LocatorReloadEnterDisable("FortFrance_town", "reload91", false); // Captain Beltrop, 19.02.2021, правка в названии локатора
	sld = characterFromId("FortFrance_Hostess");
	ChangeCharacterAddressGroup(sld, "FortFrance_SecBrRoom", "barmen", "stay");
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.Helena"))
	{
		sld = characterFromId("Helena");
		sld.dialog.currentnode = "Helena_officer";
		DeleteAttribute(pchar, "questTemp.GoldenGirl.Helena");
	}
	else 
	{
		sld = characterFromId("Mary");
		sld.dialog.currentnode = "Mary_officer";
		DeleteAttribute(pchar, "questTemp.GoldenGirl.Mary");
	}
}

void GoldenGirl_Party(string qName) // на приеме у мадам Бото
{
	if(!GetDLCenabled(DLC_APPID_5)) return;
	pchar.quest.GoldenGirl_TimeOver.over = "yes"; //снять прерывание
	// запереть локаторы выхода из комнаты борделя
	LocatorReloadEnterDisable("FortFrance_SecBrRoom", "reload1", true);
	LocatorReloadEnterDisable("FortFrance_SecBrRoom", "reload2", true);
	LocatorReloadEnterDisable("FortFrance_SecBrRoom", "reload3", true);
	bDisableFastReload = true;//закрыть переход
	pchar.GenQuest.CannotWait = true;//запрет ожидания
	// ставим Бото, Шиво и губернатора, определить локаторы 
	sld = characterFromId("Julianna");
	ChangeCharacterAddressGroup(sld, "FortFrance_SecBrRoom", "barmen", "bar1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	sld = characterFromId("Angerran");
	ChangeCharacterAddressGroup(sld, "FortFrance_SecBrRoom", "quest", "quest2");
	sld = characterFromId("FortFrance_Mayor");
	sld.Dialog.Filename = "Quest\GoldenGirl.c";
	sld.Dialog.currentnode = "governor";
	ChangeCharacterAddressGroup(sld, "FortFrance_SecBrRoom", "quest", "quest3");
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	// добавить 5 статистов
	// 1
	sld = GetCharacter(NPC_GenerateCharacter("GG_statist1", "banker_9", "man", "man", 10, FRANCE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 10, 60, 60, "blade_10", "pistol5", "bullet", 100);
	sld.Dialog.Filename = "Quest\GoldenGirl.c";
	sld.dialog.currentnode = "statist_1";
    ChangeCharacterAddressGroup(sld, "FortFrance_SecBrRoom", "goto", "goto1");
	LAi_SetOwnerType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	// 2
	sld = GetCharacter(NPC_GenerateCharacter("GG_statist2", "huber_13", "man", "man", 10, FRANCE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 10, 60, 60, "blade_15", "pistol5", "bullet", 100);
	sld.Dialog.Filename = "Quest\GoldenGirl.c";
	sld.dialog.currentnode = "statist_2";
    ChangeCharacterAddressGroup(sld, "FortFrance_SecBrRoom", "goto", "goto4");
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	// 3
	sld = GetCharacter(NPC_GenerateCharacter("GG_statist3", "mercen_21", "man", "man", 10, FRANCE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 10, 60, 60, "blade_16", "pistol6", "bullet", 100);
	sld.Dialog.Filename = "Quest\GoldenGirl.c";
	sld.dialog.currentnode = "statist_3";
    ChangeCharacterAddressGroup(sld, "FortFrance_SecBrRoom", "goto", "goto7");
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	// 4
	sld = GetCharacter(NPC_GenerateCharacter("GG_statist4", "banker_8_1", "man", "man", 10, FRANCE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 10, 60, 60, "blade_20", "pistol5", "bullet", 100);
	sld.Dialog.Filename = "Quest\GoldenGirl.c";
	sld.dialog.currentnode = "statist_4";
    ChangeCharacterAddressGroup(sld, "FortFrance_SecBrRoom", "goto", "goto6");
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	// 5
	sld = GetCharacter(NPC_GenerateCharacter("GG_statist5", "citiz_1", "man", "man", 10, FRANCE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 10, 60, 60, "blade_19", "pistol5", "bullet", 100);
	sld.Dialog.Filename = "Quest\GoldenGirl.c";
	sld.dialog.currentnode = "statist_5";
    ChangeCharacterAddressGroup(sld, "FortFrance_SecBrRoom", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
}

void GoldenGirl_CardsFail() // проигрыш в карты
{
	sld = characterFromId("FortFrance_Mayor");
	sld.Dialog.Filename = "Common_Mayor.c";
	sld.Dialog.currentnode = "First time";
	ChangeCharacterAddressGroup(sld, "FortFrance_townhall", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	sld = characterFromId("Julianna");
	sld.lifeday = 0;
	sld = characterFromId("Angerran");
	sld.lifeday = 0;
	// тут же убрать всех статистов
	for (int i=1; i<=5; i++)
	{
		sld = characterFromId("GG_statist"+i);
		sld.lifeday = 0;
	}
	LocatorReloadEnterDisable("FortFrance_town", "reload9_back", true);
	LocatorReloadEnterDisable("FortFrance_town", "reload91", true); // Captain Beltrop, 19.02.2021, правка в названии локатора
	DoQuestReloadToLocation("FortFrance_town", "reload", "reload1", "");
	SetFunctionTimerCondition("GoldenGirl_BrothelNorm", 0, 0, 1, false); // таймер
	DeleteAttribute(pchar, "questTemp.GoldenGirl.Game");
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.Helena"))
	{
		sld = characterFromId("Helena");
		sld.dialog.currentnode = "Helena_officer";
		DeleteAttribute(pchar, "questTemp.GoldenGirl.Helena");
	}
	else 
	{
		sld = characterFromId("Mary");
		sld.dialog.currentnode = "Mary_officer";
		DeleteAttribute(pchar, "questTemp.GoldenGirl.Mary");
	}
	LocatorReloadEnterDisable("FortFrance_town", "reload1_back", false);
	LocatorReloadEnterDisable("FortFrance_town", "reload2_back", false);
	LocatorReloadEnterDisable("FortFrance_town", "gate_back", false);//открыть выходы из города
	LocatorReloadEnterDisable("FortFrance_SecBrRoom", "reload1", false);
	LocatorReloadEnterDisable("FortFrance_SecBrRoom", "reload2", false);
	LocatorReloadEnterDisable("FortFrance_SecBrRoom", "reload3", false);
	bDisableFastReload = false; // все открыть
	DeleteAttribute(pchar, "GenQuest.CannotWait");//можно мотать время
	LAi_LocationDisableOfficersGen("FortFrance_townhall", false);//офицеров пускать
	AddQuestRecord("GoldenGirl", "5");
	CloseQuestHeader("GoldenGirl");
	pchar.questTemp.GoldenGirl = "cards_fail";
}

void GoldenGirl_CreateCaptainMoreno() // ставим "капитана Морено"
{
	if(!GetDLCenabled(DLC_APPID_5)) return;
	DeleteAttribute(pchar, "questTemp.GoldenGirl.Game");
	int ch;
	if (CheckAttribute(pchar, "questTemp.Portugal")) // был квест
	{
		if (CheckAttribute(pchar, "questTemp.Portugal.GG1")) ch = 1;
		else ch = 2;
	}
	else ch = 2;
	
	if (ch == 1)
	{
		sld = GetCharacter(NPC_GenerateCharacter("GG_Moreno", "Port_B", "man", "man", 35, FRANCE, -1, true, "quest"));
		sld.name = "Барт";
		sld.lastname = "Португалец";
	}
	else
	{
		sld = GetCharacter(NPC_GenerateCharacter("GG_Moreno", "Vasces", "man", "man", 35, FRANCE, -1, true, "quest"));
		sld.name = "Эрнандо";
		sld.lastname = "Васкез";
	}
	FantomMakeCoolFighter(sld, 35, 100, 100, "blade_20", "pistol5", "bullet", 200);
	ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload2");
	sld.Dialog.Filename = "Quest\GoldenGirl.c";
	sld.dialog.currentnode = "moreno";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void GoldenGirl_SleepInBrothel() // 
{
	DeleteAttribute(pchar, "questTemp.GoldenGirl.Game");
	bDisableFastReload = false; // все открыть
	DeleteAttribute(pchar, "GenQuest.CannotWait");//можно мотать время
	// тут же убрать всех статистов
	for (int i=1; i<=5; i++)
	{
		sld = characterFromId("GG_statist"+i);
		sld.lifeday = 0;
	}
	// губера к себе в резиденцию
	sld = characterFromId("FortFrance_Mayor");
	sld.Dialog.currentnode = "governor_14";
	ChangeCharacterAddressGroup(sld, "FortFrance_townhall", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	// ориентируем на день
	int iTime, iAddTime;
	iTime = sti(environment.time);
	if (iTime >= 21) iAddTime = 24 - iTime + 12;
	if (iTime < 7) iAddTime = 12 - iTime;
	if (iTime >= 7 && iTime < 21) iAddTime = 24  + 12 - iTime;
	StoreDayUpdate();
	WaitDate("",0,0,0,iAddtime,5);
	RecalculateJumpTable();
	RefreshWeather();
	RefreshLandTime();
	DoQuestReloadToLocation("FortFrance_Brothel_room", "goto", "goto1", "GoldenGirl_AfterCardsGames");
	LocatorReloadEnterDisable("FortFrance_Brothel", "reload1_back", true); // закрыть выход на улицу
	AddQuestRecord("GoldenGirl", "6");
	pchar.questTemp.GoldenGirl = "cards_win";
}

void GoldenGirl_ToGovernor() // 
{
	sld = characterFromId("Julianna");
	sld.dialog.currentnode = "Julianna_46";
	LocatorReloadEnterDisable("FortFrance_town", "reload91", true); // закрыть вход в бордель сбоку
	LocatorReloadEnterDisable("FortFrance_town", "reload9", true); // закрыть основной вход в бордель fix 08-04-20
	DoQuestReloadToLocation("FortFrance_townhall", "reload", "reload1", "");
	chrDisableReloadToLocation = true;//закрыть локацию
}

void GoldenGirl_GovernorOut() // 
{
	sld = characterFromId("FortFrance_Mayor");
	sld.Dialog.Filename = "Common_Mayor.c";
	sld.Dialog.currentnode = "First time";
	LocatorReloadEnterDisable("FortFrance_town", "reload3_back", true); // закрыть вход в резиденцию
	DoQuestReloadToLocation("FortFrance_town", "reload", "reload3", "GoldenGirl_GirlShip");
	chrDisableReloadToLocation = false; //открыть локацию
}

void GoldenGirl_DuelPrepare(string qName) // подготовка к дуэли
{
	if(!GetDLCenabled(DLC_APPID_5)) return;
	LocatorReloadEnterDisable("FortFrance_town", "reload9", false); // открыть основной вход в бордель fix 08-04-20
	LAi_LocationFightDisable(&Locations[FindLocation("FortFrance_ExitTown")], true);//запретить драться
	LAi_LocationDisableOfficersGen("FortFrance_ExitTown", true);//офицеров не пускать
	locations[FindLocation("FortFrance_ExitTown")].DisableEncounters = true; //энкаутеры закрыть
	// создаем двух секундантов ГГ
	for (int i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("GG_SecundantGG_"+i, "off_fra_"+i, "man", "man", 30, FRANCE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, 35, 70, 70, "blade_15", "pistol5", "bullet", 180);
		if (i==1)
		{
			sld.Dialog.Filename = "Quest\GoldenGirl.c";
			sld.dialog.currentnode = "secundant";
		}
		ChangeCharacterAddressGroup(sld, "FortFrance_ExitTown", "goto", "goto"+(7+i));
		LAi_SetActorType(sld);
		sld.LSC_clan = true;
	}
	// создаем двух секундантов Шиво
	for (i=1; i<=2; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("GG_SecundantAG_"+i, "mercen_2"+i, "man", "man", 25, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, 32, 70, 70, "blade_10", "pistol5", "bullet", 150);
		ChangeCharacterAddressGroup(sld, "FortFrance_ExitTown", "goto", "goto1"+(7+i)); // найти нужные локаторы
		LAi_SetActorType(sld);
		LAi_group_MoveCharacter(sld, "TMP_FRIEND");
		sld.LSC_clan = true;
	}
	// ставим Шиво
	sld = characterFromId("Angerran");
	sld.dialog.currentnode = "Angerran_29";
	ChangeCharacterAddressGroup(sld, "FortFrance_ExitTown", "goto", "goto7"); // найти нужные локаторы
	LAi_SetActorType(sld);
	sld.LSC_clan = true;
	chrDisableReloadToLocation = true;//закрыть локацию
	DoQuestReloadToLocation("FortFrance_ExitTown", "reload", "reload3", "GoldenGirl_DuelPrepare");
}

void GoldenGirl_DuelNext() // 
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], false);//разрешить драться
	// создаем еще 3 клевретов Шиво
	for (int i=3; i<=5; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("GG_SecundantAG_"+i, "mush_ctz_"+(7+i), "man", "mushketer", 25, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, 30, 70, 70, "", "mushket1", "cartridge", 150);
		ChangeCharacterAddressGroup(sld, "FortFrance_ExitTown", "rld", "loc"+(i-3)); // найти нужные локаторы
	}
	for (i=1; i<=5; i++)
	{
		sld = characterFromId("GG_SecundantAG_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	for (i=1; i<=2; i++)
	{
		sld = characterFromId("GG_SecundantGG_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "GoldenGirl_AfterDuel");
	LAi_SetFightMode(pchar, true);
}

void GoldenGirl_ToJulianna() // 
{
	sld = characterFromId("FortFrance_Mayor");
	sld.Dialog.Filename = "Common_Mayor.c";
	sld.Dialog.currentnode = "First time";
	DoQuestReloadToLocation("FortFrance_SecBrRoom", "reload", "reload2", "GoldenGirl_ToJulianna");
}

void GoldenGirl_GirlPrisoner() // 
{
	// открываем все, кроме двух наружних дверей борделя
	chrDisableReloadToLocation = false;
	bDisableFastReload = false;
	LocatorReloadEnterDisable("FortFrance_town", "reload1_back", false);
	LocatorReloadEnterDisable("FortFrance_town", "reload2_back", false);
	LocatorReloadEnterDisable("FortFrance_town", "gate_back", false);//открыть выходы из города
	LocatorReloadEnterDisable("FortFrance_SecBrRoom", "reload1", false);
	LocatorReloadEnterDisable("FortFrance_SecBrRoom", "reload2", false);
	LocatorReloadEnterDisable("FortFrance_SecBrRoom", "reload3", false);
	LocatorReloadEnterDisable("FortFrance_Brothel", "reload1_back", false);
	LAi_LocationDisableOfficersGen("FortFrance_townhall", false);//офицеров пускать
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.Helena")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	string sTemp = sld.name;
	AddQuestRecord("GoldenGirl", "9");
	AddQuestUserData("GoldenGirl", "sName", sTemp);
	pchar.questTemp.GoldenGirl = "girl_prisoner";
	//на таймер
	pchar.quest.goldengirl_timerSP.win_condition.l1 = "Timer";
	pchar.quest.goldengirl_timerSP.win_condition.l1.date.hour  = sti(GetTime());
	pchar.quest.goldengirl_timerSP.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 1);
	pchar.quest.goldengirl_timerSP.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 1);
	pchar.quest.goldengirl_timerSP.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 1);
	pchar.quest.goldengirl_timerSP.function = "GoldenGirl_GirlPrisonerFail";
}

void GoldenGirl_GirlPrisonerFail(string qName) // просрочили
{
	pchar.quest.goldengirl_baster.over = "yes";
	LocatorReloadEnterDisable("FortFrance_town", "reload9_back", false); // бордель - открыть, Аврору на место
	LocatorReloadEnterDisable("FortFrance_town", "reload91", false);
	sld = characterFromId("FortFrance_Hostess");
	ChangeCharacterAddressGroup(sld, "FortFrance_SecBrRoom", "barmen", "stay");
	sld = characterFromId("Julianna");
	sld.lifeday = 0;
	sld = characterFromId("Angerran");
	sld.lifeday = 0;
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.Helena")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	string sTemp = sld.name;
	AddQuestRecord("GoldenGirl", "10");
	AddQuestUserData("GoldenGirl", "sName", sTemp);
	CloseQuestHeader("GoldenGirl");
	pchar.questTemp.GoldenGirl = "fail";
}

void GoldenGirl_ToBaster() // 
{
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.Vaskez")) // васкез враждебный fix 08-04-20
	{
		pchar.quest.goldengirl_vaskez_attack.win_condition.l1 = "location";
		pchar.quest.goldengirl_vaskez_attack.win_condition.l1.location = "Martinique";
		pchar.quest.goldengirl_vaskez_attack.function = "GoldenGirl_VaskezAttack";
	}
	pchar.quest.goldengirl_baster.win_condition.l1 = "location";
	pchar.quest.goldengirl_baster.win_condition.l1.location = "Guadeloupe";
	pchar.quest.goldengirl_baster.function = "GoldenGirl_BasterSetFrigate";
	pchar.quest.goldengirl_timerSP.over = "yes"; //снять таймер
	SetFunctionTimerCondition("GoldenGirl_GirlPrisonerFail", 0, 0, 10, false); // новый таймер
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.Helena")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	string sTemp = sld.name;
	AddQuestRecord("GoldenGirl", "11");
	AddQuestUserData("GoldenGirl", "sName", sTemp);
	pchar.questTemp.GoldenGirl = "baster";
}

void GoldenGirl_VaskezAttack(string qName) // 
{
	bQuestDisableMapEnter = true;//закрыть карту
	Island_SetReloadEnableGlobal("Martinique", false);
	Group_DeleteGroup("GG_MorenoGroup");
	Group_FindOrCreateGroup("GG_MorenoGroup");
	sld = characterFromId("GG_Moreno");
	FantomMakeCoolSailor(sld, SHIP_FRIGATE_H, "", CANNON_TYPE_CANNON_LBS24, 70, 70, 70);
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.AlwaysEnemy = true;
	sld.Coastal_Captain = true;
	sld.Ship.Mode = "pirate";
	sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*6;
	sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*6;
	sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*6;
	sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*6;
	if (MOD_SKILL_ENEMY_RATE > 2) SetCharacterPerk(sld, "MusketsShoot");
	sld.WatchFort = true;
	Group_AddCharacter("GG_MorenoGroup", "GG_Moreno");
	Group_SetGroupCommander("GG_MorenoGroup", "GG_Moreno");
	Group_SetAddress("GG_MorenoGroup", "Martinique", "quest_ships", "quest_ship_1");
	Group_SetTaskAttack("GG_MorenoGroup", PLAYER_GROUP);
	Group_LockTask("GG_MorenoGroup");
	pchar.quest.goldengirl_vaskez_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.goldengirl_vaskez_AfterBattle.win_condition.l1.group = "GG_MorenoGroup";
	pchar.quest.goldengirl_vaskez_AfterBattle.function = "GoldenGirl_VaskezAfterBattle";
}

void GoldenGirl_VaskezAfterBattle(string qName) // 
{
	Island_SetReloadEnableGlobal("Martinique", true);
	bQuestDisableMapEnter = false;
	DoQuestCheckDelay("sea_victory", 1.5);
}

void GoldenGirl_BasterSetFrigate(string qName) // 
{
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.Helena")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	string sTemp = sld.name;
	AddQuestRecord("GoldenGirl", "12");
	AddQuestUserData("GoldenGirl", "sName", sTemp);
	Group_DeleteGroup("GG_AngerranGroup");
	Group_FindOrCreateGroup("GG_AngerranGroup");
	sld = GetCharacter(NPC_GenerateCharacter("GG_AngerranCap", "off_fra_3", "man", "man", 35, FRANCE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 35, 70, 70, "blade_20", "pistol5", "bullet", 250);
	sld.Ship.Type = GenerateShipHand(sld, SHIP_FRIGATE, 24, 4500, 350, 5200, 70000, 15.5, 39.0, 0.4);
	sld.Ship.name = "Nayade";
	SetBaseShipData(sld);
	sld.Ship.Cannons.Type = CANNON_TYPE_CANNON_LBS24;
	RealShips[sti(sld.Ship.Type)].ship.upgrades.hull = 3;
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	sld.Coastal_Captain = true;
	sld.Ship.Mode = "war";
	sld.ship.Crew.Morale = 40+MOD_SKILL_ENEMY_RATE*6;
	sld.Ship.Crew.Exp.Sailors = 40+MOD_SKILL_ENEMY_RATE*6;
	sld.Ship.Crew.Exp.Cannoners = 40+MOD_SKILL_ENEMY_RATE*6;
	sld.Ship.Crew.Exp.Soldiers = 40+MOD_SKILL_ENEMY_RATE*6;
	if (MOD_SKILL_ENEMY_RATE > 2) SetCharacterPerk(sld, "MusketsShoot");
	sld.WatchFort = true;
	Group_AddCharacter("GG_AngerranGroup", "GG_AngerranCap");
	Group_SetGroupCommander("GG_AngerranGroup", "GG_AngerranCap");
	Group_SetAddress("GG_AngerranGroup", "Guadeloupe", "quest_ships", "quest_ship_1");
	Group_SetTaskNone("GG_AngerranGroup");
	Group_LockTask("GG_AngerranGroup");
	pchar.quest.goldengirl_AngerranCap_AfterBattle.win_condition.l1 = "Group_Death";
	pchar.quest.goldengirl_AngerranCap_AfterBattle.win_condition.l1.group = "GG_AngerranGroup";
	pchar.quest.goldengirl_AngerranCap_AfterBattle.function = "GoldenGirl_AngerranCapAfterBattle";
}

void GoldenGirl_AngerranCapAfterBattle(string qName) // 
{
	pchar.quest.GoldenGirl_GirlPrisonerFail.over = "yes"; //снять таймер
	DoQuestFunctionDelay("GoldenGirl_GirlPrisonerFail", 0.1);
}

void GoldenGirl_GirlDominicaFail(string qName) // опоздание к Доминике
{
	pchar.quest.goldengirl_dominica_cortny.over = "yes";
	pchar.quest.goldengirl_dominica_alarm.over = "yes";
	Group_DeleteGroup("GG_AngerranGroup");
	sld = characterFromId("GG_AngerranCap");
	sld.lifeday = 0;
	sld = characterFromId("Julianna");
	RemovePassenger(pchar, sld);
	sld.lifeday = 0;
	sld = characterFromId("Angerran");
	sld.lifeday = 0;
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.Helena")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	string sTemp = sld.name;
	AddQuestRecord("GoldenGirl", "10");
	AddQuestUserData("GoldenGirl", "sName", sTemp);
	CloseQuestHeader("GoldenGirl");
	pchar.questTemp.GoldenGirl = "fail";
}

void GoldenGirl_PatrolInBrothel() // 
{
	string sModel;
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	for (int i=1; i<=4; i++)
	{
		if (i == 1) sModel = "off_fra_2";
		else sModel = "sold_fra_"+i;
		sld = GetCharacter(NPC_GenerateCharacter("GG_PatrolBrl_"+i, sModel, "man", "man", 30, FRANCE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, 30, 70, 70, "blade_15", "pistol1", "bullet", 150);
		if (i==1)
		{
			sld.Dialog.Filename = "Quest\GoldenGirl.c";
			sld.dialog.currentnode = "off_brothel";
		}
		else LAi_CharacterDisableDialog(sld);
		ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1"); 
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void GoldenGirl_AlarmSP(string qName) // 
{
	sld = characterFromId("FortFrance_Hostess");
	ChangeCharacterAddressGroup(sld, "FortFrance_SecBrRoom", "barmen", "stay");
	sld = characterFromId("FortFrance_Mayor");
	LAi_group_Attack(sld, Pchar);
	Map_NationQuestHunter(FRANCE);
	// перемещаем корабль Шиво на Доминику и даем ноду его кэпу
	Group_SetAddress("GG_AngerranGroup", "Dominica", "quest_ships", "quest_ship_1");
	sld = characterFromId("GG_AngerranCap");
	sld.Dialog.Filename = "Quest\GoldenGirl.c";
	sld.dialog.currentnode = "Cap_Nayad";
	sld.DeckDialogNode = "Cap_Nayad";
	LAi_SetImmortal(sld, true);
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable  = true;
}

void GoldenGirl_JuliannaOneDay(string qName) // 
{
	pchar.quest.goldengirl_evening.win_condition.l1 = "HardHour";
	pchar.quest.goldengirl_evening.win_condition.l1.hour = 21.00;
	pchar.quest.goldengirl_evening.function = "GoldenGirl_JuliannaEvening";
	SetFunctionTimerCondition("GoldenGirl_JuliannaOneDayFail", 0, 0, 1, false);
}

void GoldenGirl_JuliannaEvening(string qName) // 
{
	sld = characterFromId("Julianna");
	sld.dialog.currentnode = "Julianna_88";
}

void GoldenGirl_JuliannaOneDayFail(string qName) // 
{
	sld = characterFromId("Julianna");
	sld.dialog.currentnode = "Julianna_109";
	LAi_SetOwnerType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.Helena")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	string sTemp = sld.name;
	AddQuestRecord("GoldenGirl", "18_1");
	AddQuestUserData("GoldenGirl", "sName", sTemp);
}

void GoldenGirl_DominicaAlarm(string qName) // на Доминике, маркиза пленница
{
	pchar.quest.GoldenGirl_GirlDominicaFail.over = "yes"; //снять прерывание
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	AddQuestRecord("GoldenGirl", "15");
}

void GoldenGirl_GirlReturn() // 
{
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.Helena")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	sld.quest.OfficerPrice = sti(pchar.rank)*500;
	sld.OfficerWantToGo.DontGo = true; //не пытаться уйти
	sld.loyality = MAX_LOYALITY;
	AddPassenger(pchar, sld, false);
	SetCharacterRemovable(sld, true);
	sld.Payment = true;
	LAi_SetOfficerType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	SaveCurrentNpcQuestDateParam(sld, "HiredDate");
	if (CheckAttribute(pchar, "questTemp.LSC.Mary_officer")) sld.CompanionDisable = true; // fix 22-03-20 блок компаньона у Мэри
}

void GoldenGirl_TimeCortnyFail(string qName) // фин 2, не пришли на встречу с Кортни
{
	sld = characterFromId("Cortny");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld = characterFromId("Julianna");
	sld.dialog.currentnode = "Julianna_109";
	LAi_SetOwnerType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.Helena")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	string sTemp = sld.name;
	AddQuestRecord("GoldenGirl", "18");
	AddQuestUserData("GoldenGirl", "sName", sTemp);
}

void GoldenGirl_TimeCortny(string qName) // фин 2 пришли на встречу с Кортни
{
	sld = characterFromId("Cortny");
	sld.dialog.currentnode = "Cortny_";
	ChangeCharacterAddressGroup(sld, "FortFrance_SecBrRoom", "goto", "goto4");
	sld = characterFromId("Julianna");
	sld.dialog.currentnode = "Julianna_110";
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
}

void GoldenGirl_CortnyBandosFight() // 
{
	chrDisableReloadToLocation = true;//закрыть локацию
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], false);//разрешить драться
	sld = characterFromId("Julianna");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocator(sld, "quest", "quest1", "", -1);
	sld = characterFromId("Cortny");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	LAi_SetFightMode(sld, true);
	LAi_group_Delete("EnemyFight");
	for (int i=1; i<=5; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("GG_Bandos_"+i, "citiz_4"+i, "man", "man", 25, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, 25, 50, 50, "blade_10", "pistol1", "bullet", 150);
		if (i < 4) ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
		else ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload2");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "GoldenGirl_BandosAfterFight");
	LAi_SetFightMode(pchar, true);
}

void GoldenGirl_CortnyMercenFight() // 
{
	sld = characterFromId("Cortny");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	LAi_SetFightMode(sld, true);
	LAi_group_Delete("EnemyFight");
	for (int i=1; i<=3; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("GG_Mercen_"+i, "killer_"+i, "man", "man", 35, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, 35, 70, 70, "blade_19", "pistol4", "bullet", 250);
		ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "GoldenGirl_MercenAfterFight");
	LAi_SetFightMode(pchar, true);
}

void GoldenGirl_DominicaCortny(string qName) // на Доминике с Кортни
{
	pchar.quest.GoldenGirl_GirlDominicaFail.over = "yes"; //снять прерывание
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
}

void GoldenGirl_CortnySetOnDeck() // 
{
	sld = characterFromId("Cortny");
	sld.dialog.currentnode = "Cortny_35";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void GoldenGirl_CortnySPFinal(string qName) // финал без посещения маркизы
{
	pchar.quest.goldengirl_cortny_sp.over = "yes"; //снять прерывание
	sld = characterFromId("FortFrance_Hostess");
	ChangeCharacterAddressGroup(sld, "FortFrance_SecBrRoom", "barmen", "stay");
	sld = characterFromId("Cortny");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	CloseQuestHeader("GoldenGirl");
	pchar.questTemp.GoldenGirl = "end";
	AddSimpleRumour("They say madam Botot disappeared and left her luxury house to her trusted manager. Imagine all the sorrow fallen upon noble youngsters!", FRANCE, 90, 5);
}

void GoldenGirl_CortnySPFinalAdd(string qName) // финал с посещением маркизы
{
	pchar.quest.GoldenGirl_CortnySPFinal.over = "yes"; //снять прерывание
	chrDisableReloadToLocation = true;
	sld = characterFromId("Cortny");
	sld.dialog.currentnode = "Cortny_38";
	ChangeCharacterAddressGroup(sld, "FortFrance_SecBrRoom", "goto", "goto1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void GoldenGirl_AntiguaArest()//арестовывающие солдаты на Антигуа
{
	chrDisableReloadToLocation = true;//закрыть локацию
	for (int i=1; i<=3; i++)
    {
        sld = GetCharacter(NPC_GenerateCharacter("GASold"+i, "sold_eng_"+i, "man", "man", 20, ENGLAND, 0, true, "soldier"));
		SetFantomParamFromRank(sld, 20, true);         
		LAi_SetWarriorType(sld); 
		LAi_warrior_DialogEnable(sld, false);
        ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
    }
    sld = GetCharacter(NPC_GenerateCharacter("GAOfficer", "off_eng_3", "man", "man", 30, ENGLAND, 0, true, "soldier"));
	SetFantomParamFromRank(sld, 30, true);
	sld.Dialog.Filename = "Quest\GoldenGirl.c";
	sld.dialog.currentnode = "antigua_officer";
	sld.greeting = "soldier_arest";
    LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
	LAi_ActorDialog(sld, pchar, "", 1.0, 0);
	pchar.questTemp.GoldenGirl = "arest";
}

void GoldenGirl_CortnyInJail(string qName)//Кортни в тюрьме
{
    sld = characterFromID("Cortny");
	LAi_SetActorType(sld);
    LAi_ActorGoToLocator(sld, "goto", "goto23", "", -1);
	DoQuestFunctionDelay("GoldenGirl_CortnyInJailGo", 3.0);
}

void GoldenGirl_CortnyInJailGo(string qName)//Кортни в тюрьме
{
    sld = characterFromID("Cortny");
	LAi_SetActorType(sld);
    LAi_ActorDialog(sld, pchar, "", 0, 0);
}

void GoldenGirl_BasterArest()//арестовывающие солдаты на Гваделупе
{
	for (int i=1; i<=3; i++)
    {
        sld = GetCharacter(NPC_GenerateCharacter("GBSold"+i, "sold_fra_"+i, "man", "man", 20, FRANCE, 0, true, "soldier"));
		SetFantomParamFromRank(sld, 20, true);         
		LAi_SetWarriorType(sld); 
		LAi_warrior_DialogEnable(sld, false);
        ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
    }
    sld = GetCharacter(NPC_GenerateCharacter("GBOfficer", "off_fra_3", "man", "man", 30, FRANCE, 0, true, "soldier"));
	SetFantomParamFromRank(sld, 30, true);
	sld.Dialog.Filename = "Quest\GoldenGirl.c";
	sld.dialog.currentnode = "baster_officer";
	sld.greeting = "soldier_arest";
    LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, pchar.location, "reload", "reload1");
	LAi_ActorDialog(sld, pchar, "", 1.0, 0);
}

void GoldenGirl_JuliannaInJail(string qName)//Джулиана в тюрьме
{
    sld = characterFromID("Julianna");
	LAi_SetActorType(sld);
    LAi_ActorGoToLocator(sld, "goto", "goto23", "", -1);
	DoQuestFunctionDelay("GoldenGirl_JuliannaInJailGo", 3.0);
}

void GoldenGirl_JuliannaInJailGo(string qName)//Джулиана в тюрьме
{
    sld = characterFromID("Julianna");
	LAi_SetActorType(sld);
    LAi_ActorDialog(sld, pchar, "", 0, 0);
}

void GoldenGirl_OnMartinique(string qName)// на Мартинике
{
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
    if(CheckAttribute(pchar, "questTemp.GoldenGirl.Julianna_Helper")) // belamour теперь Бото в резиденции 
	{
		sld = characterFromID("Julianna");
		RemovePassenger(pchar, sld);
		sld.dialog.currentnode = "Julianna_144";
		ChangeCharacterAddressGroup(sld, "FortFrance_SecBrRoom", "goto", "goto4");
		LAi_SetStayType(sld);
		LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	}
	chrDisableReloadToLocation = true;//закрыть локацию
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.Helena")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	sld.dialog.currentnode = "GoldenGirl_32";
	ChangeCharacterAddressGroup(sld, "FortFrance_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void GoldenGirl_MaryBlockDelete() // fix 22-03-20 возвращаем Мэри ее поведение
{
    DeleteAttribute(pchar, "questTemp.GoldenGirl.MaryBlock");
	pchar.quest.Mary_giveme_sex.win_condition.l1 = "Timer";
	pchar.quest.Mary_giveme_sex.win_condition.l1.date.hour  = sti(GetTime());
	pchar.quest.Mary_giveme_sex.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 14);
	pchar.quest.Mary_giveme_sex.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 14);
	pchar.quest.Mary_giveme_sex.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 14);
	pchar.quest.Mary_giveme_sex.function = "Mary_GiveMeSex";
}

/// Jason ----------------------------------------------------------- Долго и счастливо ------------------------------------------------------------------
void LongHappy_Start() // инициализация
{
	pchar.quest.longhappy_start.win_condition.l1 = "Nation_City";
	pchar.quest.longhappy_start.win_condition.l1.nation = FRANCE;
	pchar.quest.longhappy_start.function = "LongHappy_StartGo";
	pchar.questTemp.LongHappy = "init";
}

void LongHappy_StartGo(string qName) // 
{
	log_testinfo("Вестовой капитан для Долго и Счастливо запущен");
	// проверка на наличие Элен или Мэри
	if (!LongHappy_CheckGirls()) return;
	chrDisableReloadToLocation = true;//закрыть локацию
	sld = GetCharacter(NPC_GenerateCharacter("LongHappy_cureer", "mercen_11", "man", "man", 25, FRANCE, 0, true, "quest"));
	FantomMakeCoolFighter(sld, 25, 60, 60, "blade_10", "pistol5", "bullet", 100);
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.Dialog.Filename = "Quest\LongHappy.c";
	sld.dialog.currentnode = "cureer";
	LAi_SetImmortal(sld, true);
	//GetCharacterPos(pchar, &locx, &locy, &locz);
	//ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
    ChangeCharacterAddressGroup(sld, pchar.location, "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	pchar.questTemp.LongHappy = "start";
}

void LongHappy_RecibeLetter() // 
{
	AddQuestRecordInfo("Letter_France", "1");
	if (CheckAttribute(pchar, "questTemp.Saga.Helena_officer")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	LAi_SetCheckMinHP(sld, 10, true, ""); // скрытое бессмертие
	string sTemp = sld.name;
	AddQuestRecord("LongHappy", "1");
	AddQuestUserData("LongHappy", "sName", sTemp);
	pchar.questTemp.LongHappy = "letter";
	// прячем аббата Бенуа
	sld = characterFromId("Benua");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	log_info("To make a wedding decisions USE A THINKING OUT LOUD OPTION");
}

void LongHappy_GoToSantiago() // 
{
	pchar.quest.longhappy_santiago.win_condition.l1 = "location";
	pchar.quest.longhappy_santiago.win_condition.l1.location = "Santiago";
	pchar.quest.longhappy_santiago.function = "LongHappy_SantiagoArrive";
	pchar.questTemp.LongHappy.Santiago = "true";
	AddQuestRecord("LongHappy", "4");
}

void LongHappy_SantiagoArrive(string qName) // 
{
	AddQuestRecord("LongHappy", "5");
}

void LongHappy_SantiagoBenua() // 
{
	if(!GetDLCenabled(DLC_APPID_5)) return;
	DeleteAttribute(pchar, "questTemp.LongHappy.Santiago");
	sld = characterFromId("Benua");
	sld.dialog.currentnode = "LH_abbat";
	LAi_SetLoginTime(sld, 18.0, 20.0);
	ChangeCharacterAddressGroup(sld, "Santiago_church", "barmen", "bar1"); 
	AddQuestRecord("LongHappy", "6");
}

void LongHappy_SantiagoBenuaEscape() // 
{
	sld = characterFromId("Benua");
	sld.dialog.currentnode = "First time";
	LAi_RemoveLoginTime(sld);
	LAi_SetActorType(sld);
	LAi_ActorFollowEverywhere(sld, "", -1);
	pchar.quest.longhappy_santiago1.win_condition.l1 = "location";
	pchar.quest.longhappy_santiago1.win_condition.l1.location = "Santiago_town";
	pchar.quest.longhappy_santiago1.function = "LongHappy_SantiagoSoldiers";
	AddQuestRecord("LongHappy", "7");
}

void LongHappy_SantiagoSoldiers(string qName) // 
{
	chrDisableReloadToLocation = true;
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], true);//запретить драться
	// ставим испанцев
	int iRank = 25+MOD_SKILL_ENEMY_RATE*2;
	int iScl = 60;
	for (int i=1; i<=4; i++)
	{
		if (i == 1)
		{
			sld = GetCharacter(NPC_GenerateCharacter("LH_escort_"+i, "off_spa_"+i, "man", "man", iRank+5, SPAIN, 0, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank+5, iScl+5, iScl+5, "blade_16", "pistol4", "bullet", iScl*2+50);
			sld.Dialog.Filename = "Quest\LongHappy.c";
			sld.dialog.currentnode = "spa_officer";
			ChangeCharacterAddressGroup(sld, "Santiago_town", "patrol", "patrol13");
		}
		else
		{
			sld = GetCharacter(NPC_GenerateCharacter("LH_escort_"+i, "sold_spa_"+i, "man", "man", iRank, SPAIN, -1, true, "soldier"));
			FantomMakeCoolFighter(sld, iRank, iScl, iScl, RandPhraseSimple("blade_12","blade_14"), "pistol1", "bullet", iScl*2);
			ChangeCharacterAddressGroup(sld, "Santiago_town", "patrol", "patrol13"); 
			LAi_CharacterDisableDialog(sld);
		}
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void LongHappy_SantiagoSail(string qName) // 
{
	pchar.quest.longhappy_santiago2.over = "yes"; //снять прерывание
	pchar.quest.longhappy_santiago3.over = "yes"; //снять прерывание
	sld = characterFromId("Benua");
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "none", "", "");
	AddPassenger(pchar, sld, false);
	SetCharacterRemovable(sld, false);
	AddQuestRecord("LongHappy", "8");
	Island_SetReloadEnableGlobal("Cuba1", false);
	Island_SetReloadEnableGlobal("Cuba2", false);
	SetFunctionTimerCondition("LongHappy_SantiagoQuestHunter", 0, 0, 2, false);
	pchar.quest.longhappy_fortfrance.win_condition.l1 = "location";
	pchar.quest.longhappy_fortfrance.win_condition.l1.location = "FortFrance_town";
	pchar.quest.longhappy_fortfrance.function = "LongHappy_SantiagoFin";
}

void LongHappy_SantiagoQuestHunter(string qName) // 
{
	Map_NationQuestHunter(SPAIN);
}

void LongHappy_SantiagoFin(string qName) // 
{
	log_info("Abbot Benoit has come ashore!");
	sld = characterFromId("Benua");
	RemovePassenger(pchar, sld);
	LAi_SetLoginTime(sld, 6.0, 21.0);
	LAi_SetStayType(sld);
	ChangeCharacterAddressGroup(sld, "FortFrance_church", "reload", "reload2_back");
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	pchar.questTemp.LongHappy = "marry_offer"; // 28-03-20
}

void LongHappy_MarryOffer() // 
{
	chrDisableReloadToLocation = true;
	if (CheckAttribute(pchar, "questTemp.Saga.Helena_officer")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	sld.dialog.currentnode = "LongHappy";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void LongHappy_MarryToSenPierre() // 
{
	AddQuestRecord("LongHappy", "9");
	pchar.questTemp.LongHappy = "toSenPierre";
	pchar.quest.longhappy_fortfrance1.win_condition.l1 = "location";
	pchar.quest.longhappy_fortfrance1.win_condition.l1.location = "FortFrance_town";
	pchar.quest.longhappy_fortfrance1.function = "LongHappy_ToBenua";
}

void LongHappy_ToBenua(string qName) // 
{
	if(!GetDLCenabled(DLC_APPID_5)) return;
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	chrDisableReloadToLocation = true;
	if (CheckAttribute(pchar, "questTemp.Saga.Helena_officer")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	sld.dialog.currentnode = "LongHappy_7";
	ChangeCharacterAddressGroup(sld, "FortFrance_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void LongHappy_MarryGoToBenua() // 
{
	if (CheckAttribute(pchar, "questTemp.LongHappy.MarryRum")) // праздник в Сен-Пьер
	{
		AddQuestUserData("LongHappy", "sGoods", ""+sti(pchar.questTemp.LongHappy.MarryRum)+" barrels of rum and "+sti(pchar.questTemp.LongHappy.MarryMoney)+" pesos.");
	}
	else
	{
		if (CheckAttribute(pchar, "questTemp.LongHappy.SmallMarry")) AddQuestUserData("LongHappy", "sGoods", "50 barrels of rum, 20 barrels of rum и 300 000 pesos.");
		else AddQuestUserData("LongHappy", "sGoods", "100 barrels of rum, 50 barrels of rum и 500 000 pesos.");
	}
	sld = characterFromId("Benua");
	sld.dialog.currentnode = "LH_abbat_8";
	LocatorReloadEnterDisable("FortFrance_town", "reload1_back", true);
	LocatorReloadEnterDisable("FortFrance_town", "reload2_back", true);
	LocatorReloadEnterDisable("FortFrance_town", "gate_back", true);//закрыть выходы из города
}

void LongHappy_SenPierreGuests(string qName) // 
{
	pchar.quest.longhappy_fortfrance2.win_condition.l1 = "location";
	pchar.quest.longhappy_fortfrance2.win_condition.l1.location = "FortFrance_town";
	pchar.quest.longhappy_fortfrance2.function = "LongHappy_MarryBegin";
	AddQuestRecord("LongHappy", "13");
	if (!CheckAttribute(pchar, "questTemp.LongHappy.DrinkReady")) 
	{
		if (CheckAttribute(pchar, "questTemp.LongHappy.MarryRum")) AddQuestUserData("LongHappy", "sText", "But before that, I have to organize a celebration at the tavern of Saint-Pierre. Hurry up!");
		else AddQuestUserData("LongHappy", "sText", "But before that, I have to organize a celebration on Isla Tesoro. Hurry up!");
	}
}

void LongHappy_OnIslaTesoro() // 
{
	chrDisableReloadToLocation = true;
	if (CheckAttribute(pchar, "questTemp.Saga.Helena_officer")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	sld.dialog.currentnode = "LongHappy_13";
	GetCharacterPos(pchar, &locx, &locy, &locz);
	ChangeCharacterAddressGroup(sld, pchar.location, "goto", LAi_FindNearestFreeLocator("goto", locx, locy, locz));
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void LongHappy_IslaTesoroRemoveGoods() // 
{
	if (CheckAttribute(pchar, "questTemp.LongHappy.SmallMarry"))
	{
		RemoveCharacterGoods(pchar, GOOD_RUM, 50);
		RemoveCharacterGoods(pchar, GOOD_WINE, 20);
		AddMoneyToCharacter(pchar, -300000);
	}
	else
	{
		RemoveCharacterGoods(pchar, GOOD_RUM, 100);
		RemoveCharacterGoods(pchar, GOOD_WINE, 50);
		AddMoneyToCharacter(pchar, -500000);
	}
}

void LongHappy_MarryBegin(string qName) // 
{
	if (CheckAttribute(pchar, "questTemp.LongHappy.DrinkReady"))
	{
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	chrDisableReloadToLocation = true;
	if (CheckAttribute(pchar, "questTemp.Saga.Helena_officer")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	sld.dialog.currentnode = "LongHappy_17";
	ChangeCharacterAddressGroup(sld, "FortFrance_town", "quest", "quest1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	sld = characterFromId("Benua");
	sld.dialog.currentnode = "LH_abbat_19";
	LocatorReloadEnterDisable("FortFrance_town", "reload1_back", true);
	LocatorReloadEnterDisable("FortFrance_town", "reload2_back", true);
	LocatorReloadEnterDisable("FortFrance_town", "gate_back", true);//закрыть выходы из города
		pchar.questTemp.LongHappy.MarryBegin = "true";
	}
	else
	{
		if (CheckAttribute(pchar, "questTemp.LongHappy.MarryRum"))
		{
			log_info("First, you have to arrange a celebration at the tavern of Saint-Pierre!");
			pchar.quest.longhappy_recharge.win_condition.l1 = "location";
			pchar.quest.longhappy_recharge.win_condition.l1.location = "FortFrance_tavern";
			pchar.quest.longhappy_recharge.function = "LongHappy_MarrySPRecharge";
		}
		else
		{
			log_info("First, you have to arrange a celebration on Isla Tesoro!");
			pchar.quest.longhappy_recharge.win_condition.l1 = "location";
			pchar.quest.longhappy_recharge.win_condition.l1.location = "Martinique";
			pchar.quest.longhappy_recharge.function = "LongHappy_MarrySPRecharge";
		}
	}
}

void LongHappy_MarrySPRecharge(string qName) // 
{
	pchar.quest.longhappy_fortfrance2.win_condition.l1 = "location";
	pchar.quest.longhappy_fortfrance2.win_condition.l1.location = "FortFrance_town";
	pchar.quest.longhappy_fortfrance2.function = "LongHappy_MarryBegin";
}

void LongHappy_MarryMusic(string qName) // 
{
	ResetSound();
	SetMusic("music_marry");
	PlaySound("ambient\church\zvon.wav");
}

void LongHappy_MarryKiss() // 
{
	SetLaunchFrameFormParam("", "", 0, 5);
	SetLaunchFrameFormPic("loading\inside\kiss.tga");
	LaunchFrameForm();
	WaitDate("", 0, 0, 0, 0, 10); //крутим время
	RecalculateJumpTable();
	// всех не готовых - к разговору
	if (CheckAttribute(pchar, "questTemp.Saga.Helena_officer")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	sld.dialog.currentnode = "LongHappy_34";
	LAi_SetStayType(sld);
	sld = characterFromId("Benua");
	sld.dialog.currentnode = "LH_abbat_37";
	LAi_SetStayType(sld);
	DoQuestFunctionDelay("LongHappy_MarryMusic", 5.1);
}

void LongHappy_MarryComplete() // 
{
	if(!GetDLCenabled(DLC_APPID_5)) return;
	chrDisableReloadToLocation = false;
	// ориентируем на ночь
	int iTime, iAddTime;
	iTime = sti(environment.time);
	if (iTime >= 21) iAddTime = 24 - iTime + 1;
	if (iTime < 7) iAddTime = iTime + 13;
	if (iTime >= 7 && iTime < 21) iAddTime = 24 - iTime + 1;
	StoreDayUpdate();
	WaitDate("",0,0,0,iAddtime,5);
	RecalculateJumpTable();
	RefreshWeather();
	RefreshLandTime();
	pchar.quest.longhappy_marry_complete.win_condition.l1 = "ExitFromLocation";
	pchar.quest.longhappy_marry_complete.win_condition.l1.location = pchar.location;
	pchar.quest.longhappy_marry_complete.function = "LongHappy_MarryClear";
	if (!CheckAttribute(pchar, "questTemp.LongHappy.MarrySP"))
	{
	pchar.quest.longhappy_marry_complete1.win_condition.l1 = "Ship_location";
	pchar.quest.longhappy_marry_complete1.win_condition.l1.location = "Pirates_town";
	pchar.quest.longhappy_marry_complete1.function = "LongHappy_IslaTesoroArrive";
	pchar.quest.longhappy_marry_complete2.win_condition.l1 = "location";
	pchar.quest.longhappy_marry_complete2.win_condition.l1.location = "Bermudes";
	pchar.quest.longhappy_marry_complete2.function = "LongHappy_IslaTesoroSetShips";
	}
	pchar.questTemp.LongHappy = "marry_done";
	if (CheckAttribute(pchar, "questTemp.Saga.Helena_officer")) Achievment_SetStat(pchar, 81, 1);
	else Achievment_SetStat(pchar, 80, 1);
}

void LongHappy_MarryClear(string qName) // 
{
	bDisableCharacterMenu = false;
	InterfaceStates.Buttons.Save.enable = true;
	DeleteAttribute(pchar, "GenQuest.CantRun");
	CheckAndSetOverloadMode(GetMainCharacter());
	DeleteAttribute(pchar, "GenQuest.FrameLockEsc"); 
	LocatorReloadEnterDisable("FortFrance_town", "reload1_back", false);
	LocatorReloadEnterDisable("FortFrance_town", "reload2_back", false);
	LocatorReloadEnterDisable("FortFrance_town", "gate_back", false);
	DeleteAttribute(pchar, "GenQuest.CannotWait");
	sld = characterFromId("FortFrance_Priest");
	ChangeCharacterAddressGroup(sld, "FortFrance_church", "barmen", "stay");
	sld = characterFromId("Benua");
	sld.Dialog.Filename = "Quest\Sharlie\Benua.c";
	sld.dialog.currentnode = "First time";
	LAi_CharacterEnableDialog(sld);
	ChangeCharacterAddressGroup(sld, "FortFrance_church", "reload", "reload2_back");
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	sld = characterFromId("Fadey");
	sld.Dialog.Filename = "Quest\Sharlie\Fadey.c";
	sld.dialog.currentnode = "First time";
	LAi_CharacterEnableDialog(sld);
	ChangeCharacterAddressGroup(sld, "BasTer_houseSp1", "sit", "sit1");
	LAi_SetSitType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	if (CheckAttribute(pchar, "questTemp.Patria.GenGovernor")) 
	{
		sld = characterFromId("Noel");
		sld.Dialog.Filename = "Quest\Patria_NPC.c";
		sld.dialog.currentnode = "First time";
		LAi_CharacterEnableDialog(sld);
		ChangeCharacterAddressGroup(sld, "none", "", "");
	}
	else 
	{
		sld = characterFromId("Puancie");
		sld.Dialog.Filename = "Governor\Puancie.c";
		sld.dialog.currentnode = "First time";
		LAi_CharacterEnableDialog(sld);
		ChangeCharacterAddressGroup(sld, "Charles_Roomtownhall", "sit", "sit1");
		LAi_SetHuberType(sld);
		LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	}
	if (CheckAttribute(pchar, "questTemp.Saga.Helena_officer"))
	{
		sld = characterFromId("Svenson");
		LAi_CharacterEnableDialog(sld);
		ChangeCharacterAddressGroup(sld, "none", "", "");
	}
	sld = characterFromId("Gladis");
	sld.Dialog.Filename = "Quest\Saga\Gladis.c";
	sld.dialog.currentnode = "First time";
	LAi_CharacterEnableDialog(sld);
	ChangeCharacterAddressGroup(sld, "SantaCatalina_houseSp3", "goto", "goto1");
	LAi_SetOwnerType(sld);
	LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
	sld = characterFromId("FortFrance_Mayor");
	sld.Dialog.Filename = "Common_Mayor.c";
	sld.dialog.currentnode = "First time";
	LAi_CharacterEnableDialog(sld);
	ChangeCharacterAddressGroup(sld, "FortFrance_townhall", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	sld = characterFromId("BasTer_Mayor");
	sld.Dialog.Filename = "Common_Mayor.c";
	sld.dialog.currentnode = "First time";
	LAi_CharacterEnableDialog(sld);
	ChangeCharacterAddressGroup(sld, "BasTer_townhall", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	sld = characterFromId("PortPax_Mayor");
	sld.Dialog.Filename = "Common_Mayor.c";
	sld.dialog.currentnode = "First time";
	LAi_CharacterEnableDialog(sld);
	ChangeCharacterAddressGroup(sld, "PortPax_townhall", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	sld = characterFromId("Tortuga_Mayor");
	sld.Dialog.Filename = "Common_Mayor.c";
	sld.dialog.currentnode = "First time";
	LAi_CharacterEnableDialog(sld);
	ChangeCharacterAddressGroup(sld, "Tortuga_townhall", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "FRANCE_CITIZENS");
	sld = characterFromId("PortRoyal_Mayor");
	sld.Dialog.Filename = "Common_Mayor.c";
	sld.dialog.currentnode = "First time";
	LAi_CharacterEnableDialog(sld);
	ChangeCharacterAddressGroup(sld, "PortRoyal_townhall", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
	if (GetCharacterIndex("LH_Prosper") != -1)
	{
		sld = characterFromId("LH_Prosper");
		ChangeCharacterAddressGroup(sld, "none", "", "");
	}
	if (GetCharacterIndex("Tichingitu") != -1)
	{
		sld = characterFromId("Tichingitu");
		sld.Dialog.Filename = "Quest\Sharlie\Tichingitu.c";
		sld.dialog.currentnode = "Tichingitu_officer";
		LAi_CharacterEnableDialog(sld);
		LAi_SetOfficerType(sld); // fix 01-04-20
	}
	if (CheckAttribute(pchar, "questTemp.LongHappy.MarrySP")) 
	{
		chrDisableReloadToLocation = true;
		DoQuestFunctionDelay("LongHappy_ReloadToSPtavern", 1.8);
	}
}

//--> ------------------------------------ блок празднования в таверне Сен-Пьер -------------------------------------------
void LongHappy_ReloadToSPtavern(string qName)
{
	DoQuestReloadToLocation("FortFrance_tavern", "reload", "reload1", "LongHappy_InSPtavern");
}

//<-- блок празднования в таверне Сен-Пьер

void LongHappy_IslaTesoroSetShips(string qName)
{
	LAi_LocationDisableOfficersGen("Pirates_town", true);
	LAi_LocationDisableOfficersGen("Bermudes_Dungeon", true);
	pchar.questTemp.LongHappy.InTavern = "true";
	bQuestDisableMapEnter = true;//закрыть карту
	pchar.GenQuest.MapClosedNoBattle = true;
	// корвет Свенсона
	sld = GetCharacter(NPC_GenerateCharacter("LH_Svenson_sea", "Svenson", "man", "man", 45, PIRATE, -1, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_CORVETTE, "Sea Devil", CANNON_TYPE_CANNON_LBS24, 110, 110, 110);
	FantomMakeCoolFighter(sld, 45, 100, 100, "blade_21", "pistol5", "bullet", 400);
	sld.name = "Jan";
	sld.lastname = "Svensson";
	sld.Abordage.Enable = false;
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true; 
	LAi_SetImmortal(sld, true); // сплошная защита от дурака
	sld.DontDeskTalk = true;
	sld.nation = PIRATE;
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.AlwaysSandbankManeuver = true;
	sld.ship.Crew.Morale = 95;
	sld.Ship.Crew.Exp.Sailors = 95;
	sld.Ship.Crew.Exp.Cannoners = 95;
	sld.Ship.Crew.Exp.Soldiers = 95;
	SetCharacterPerk(sld, "MusketsShoot");
	RealShips[sti(sld.Ship.Type)].ship.upgrades.hull = 1;
	Group_AddCharacter("Barons_SeaGroup", "LH_Svenson_sea");
	// фрегат Тиракса
	Group_FindOrCreateGroup("Barons_SeaGroup");
	sld = GetCharacter(NPC_GenerateCharacter("LH_Terrax_sea", "Terrax", "man", "man", 45, PIRATE, -1, true, "quest"));
	FantomMakeCoolSailor(sld, SHIP_FRIGATE, "Sperm Whale", CANNON_TYPE_CANNON_LBS24, 110, 110, 110);
	FantomMakeCoolFighter(sld, 45, 100, 100, "blade_21", "pistol5", "bullet", 400);
	sld.name = "Marcus";
	sld.lastname = "Tyrax";
	sld.Abordage.Enable = false;
	sld.AlwaysFriend = true;
	sld.ShipEnemyDisable = true; 
	LAi_SetImmortal(sld, true); // сплошная защита от дурака
	sld.DontDeskTalk = true;
	sld.nation = PIRATE;
	sld.DontRansackCaptain = true;
	sld.AnalizeShips = true;
	DeleteAttribute(sld, "SaveItemsForDead");
	DeleteAttribute(sld, "DontClearDead");
	sld.AlwaysSandbankManeuver = true;
	sld.ship.Crew.Morale = 95;
	sld.Ship.Crew.Exp.Sailors = 95;
	sld.Ship.Crew.Exp.Cannoners = 95;
	sld.Ship.Crew.Exp.Soldiers = 95;
	SetCharacterPerk(sld, "MusketsShoot");
	RealShips[sti(sld.Ship.Type)].ship.upgrades.hull = 1;
	Group_AddCharacter("Barons_SeaGroup", "LH_Terrax_sea");
	// фрегат Додсона
	if (!CheckAttribute(pchar, "questTemp.Saga.DodsonDie"))
	{
		sld = GetCharacter(NPC_GenerateCharacter("LH_Dodson_sea", "Shark", "man", "man", 45, PIRATE, -1, true, "quest"));
		FantomMakeCoolSailor(sld, SHIP_FRIGATE_H, "Fortune", CANNON_TYPE_CANNON_LBS32, 105, 105, 105);
		FantomMakeCoolFighter(sld, 45, 100, 100, "blade_21", "pistol5", "bullet", 100);
		sld.name = "Steven";
		sld.lastname = "Dodson";
		sld.Abordage.Enable = false;
		sld.AlwaysFriend = true;
		sld.ShipEnemyDisable = true; 
		LAi_SetImmortal(sld, true); // сплошная защита от дурака
		sld.DontDeskTalk = true;
		sld.nation = PIRATE;
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.AlwaysSandbankManeuver = true;
		sld.ship.Crew.Morale = 95;
		sld.Ship.Crew.Exp.Sailors = 95;
		sld.Ship.Crew.Exp.Cannoners = 95;
		sld.Ship.Crew.Exp.Soldiers = 95;
		SetCharacterPerk(sld, "MusketsShoot");
		Group_AddCharacter("Barons_SeaGroup", "LH_Dodson_sea");
	}
	Group_SetGroupCommander("Barons_SeaGroup", "LH_Svenson_sea");
	Group_SetAddress("Barons_SeaGroup", "Bermudes", "quest_ships", "quest_ship_2");
	Group_SetTaskNone("Barons_SeaGroup");
}

void LongHappy_IslaTesoroArrive(string qName) // 
{
	if(!GetDLCenabled(DLC_APPID_5)) return;
	pchar.GenQuest.Hunter2Pause = true; // ОЗГи на паузу
	chrDisableReloadToLocation = true;
	// меняем внутрянку таверны и открываем ее
	int n = Findlocation("Pirates_Tavern");
	locations[n].filespath.models = "locations\inside\tavern03";
	locations[n].models.always.tavern = "tavern03";
	locations[n].models.always.tavern.level = 65538;
	locations[n].models.always.locators = "tavern03_locators";
	locations[n].models.always.window = "tavern03_window";
	locations[n].models.always.window.tech = "LocationWindows";
	locations[n].models.always.window.level = 65539;
	locations[n].models.always.back = "..\inside_back";
	locations[n].models.always.back.level = 65529;
	//Day
	locations[n].models.day.charactersPatch = "tavern03_patch";
	//Night
	locations[n].models.night.charactersPatch = "tavern03_patch";
	LocatorReloadEnterDisable("Pirates_town", "reload4_back", false);
	LAi_LocationDisableOfficersGen("Pirates_tavern", true);
	// меняем комнату в резиденции
	n = Findlocation("Pirates_townhall");
	locations[n].reload.l2.name = "reload2";
	locations[n].reload.l2.go = "Location_reserve_04";
	n = Findlocation("Location_reserve_04");
	locations[n].id.label = "Room";
	locations[n].filespath.models = "locations\inside\Doubleflour_house";
	locations[n].image = "loading\inside\mediumhouse10.tga";
	//Town sack
	locations[n].townsack = "Pirates";
	locations[n].lockWeather = "Inside";
	//Sound
	locations[n].type = "house";
	locations[n].islandId = "Bermudes";
	//Always
	locations[n].filespath.models = "locations\inside\Doubleflour_house";
	DeleteAttribute(&locations[n], "models");
	DeleteAttribute(&locations[n], "reload");
	locations[n].models.always.largehouse01 = "LH_Floor2";
	locations[n].models.always.largehouse01.level = 65538;
	locations[n].models.always.locators = "LH_Floor2_locators";
	Locations[n].models.always.largehouse01windows = "LH_Floor2_window";
	Locations[n].models.always.largehouse01windows.tech = "LocationWindows";
	locations[n].models.always.largehouse01windows.level = 65539;
	locations[n].models.always.back = "..\inside_back";
	locations[n].models.always.back.level = 65529;
	//Day
	locations[n].models.day.charactersPatch = "LH_Floor2_patch";
	//Night
	locations[n].models.night.fonar = "LH_Floor2_fn";
	locations[n].models.night.charactersPatch = "LH_Floor2_patch";
	//Environment
	locations[n].environment.weather = "true";
	locations[n].environment.sea = "false";
	//Reload map
	locations[n].reload.l1.name = "reload1";
	locations[n].reload.l1.go = "Pirates_townhall";
	locations[n].reload.l1.emerge = "reload2";
	locations[n].reload.l1.autoreload = "0";
	locations[n].reload.l1.label = "House";
	// вычистить ненужных статиков
	sld = characterFromId("Pirates_tavernkeeper");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld = characterFromId("Pirates_waitress");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	sld = characterFromId("Norman");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	// Тиракс встречает
	sld = characterFromId("Terrax");
	sld.Dialog.Filename = "Quest\LongHappy.c";
	sld.dialog.currentnode = "Terrax";
	ChangeCharacterAddressGroup(sld, "Pirates_town", "quest", "quest1"); // определить локатор
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void LongHappy_IslaTesoroToVine()
{
	pchar.questTemp.LongHappy.Continue = "true";
	SetLaunchFrameFormParam("Some time has passed..."+ NewStr() +"The party is in full swing...", "", 0.1, 5.0);
	LaunchFrameForm();
	WaitDate("", 0, 0, 0, 2, 0);
	sld = characterFromId("Svenson");
	sld.dialog.currentnode = "Svenson_12";
	if (CheckAttribute(pchar, "questTemp.Saga.Helena_officer")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "Location_reserve_04", "goto", "goto4");
	sld = characterFromId("Danielle");
	ChangeCharacterAddressGroup(sld, "Location_reserve_04", "goto", "goto2");
	if (GetCharacterIndex("Tichingitu") != -1)
	{
		sld = characterFromId("Tichingitu");
		DeleteAttribute(sld, "Payment");
		RemovePassenger(pchar, sld); // вывести из офицеров
		LAi_SetStayType(sld);
		if (CheckAttribute(pchar, "questTemp.LongHappy.Tichingitu_Rum")) ChangeCharacterAddressGroup(sld, "Shore_ship1", "randitem", "randitem2");
		else ChangeCharacterAddressGroup(sld, "Pirates_town", "quest", "quest1"); 
	}
	AddQuestRecord("LongHappy", "15");
}

void LongHappy_IslaTesoroToVineGo()
{
	sld = characterFromId("Nathaniel");
	sld.dialog.currentnode = "Nathaniel_4";
	ChangeCharacterAddressGroup(sld, "Pirates_Tavern", "tables", "stay1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	// ориентируем на ночь
	int iTime, iAddTime;
	iTime = sti(environment.time);
	if (iTime >= 21) iAddTime = 24 - iTime + 1;
	if (iTime < 7) iAddTime = iTime + 13;
	if (iTime >= 7 && iTime < 21) iAddTime = 24 - iTime + 1;
	StoreDayUpdate();
	WaitDate("",0,0,0,iAddtime,5);
	RecalculateJumpTable();
	RefreshWeather();
	RefreshLandTime();
}

void LongHappy_IslaTesoroToAlexus(string qName) // 
{
	int n = Findlocation("Pirates_town");
	DeleteAttribute(&locations[n], "reload.l5.close_for_night");
	LocatorReloadEnterDisable("Pirates_town", "reload5_back", false);
	DeleteAttribute(&locations[n], "reload.l6.close_for_night");
	LocatorReloadEnterDisable("Pirates_town", "reload1_back", true);
	LocatorReloadEnterDisable("Pirates_town", "reload3_back", true);
	LocatorReloadEnterDisable("Pirates_town", "reload6_back", true);
	LocatorReloadEnterDisable("Pirates_town", "houseH1", true);
	LocatorReloadEnterDisable("Pirates_town", "houseSp1", true);
	LocatorReloadEnterDisable("Pirates_town", "houseS1", true);
	LocatorReloadEnterDisable("Pirates_town", "houseF1", true);
	LocatorReloadEnterDisable("Bermudes_Dungeon", "reload2_back", true);
	LAi_LocationDisableOfficersGen("Pirates_town", true);
	for(int i=0; i<MAX_LOCATIONS; i++)
	{	
		sld = &characters[i];
		if (sld.location == "Pirates_town" && CheckAttribute(sld, "CityType"))
		{
			ChangeCharacterAddressGroup(sld, "none", "", "");
			sld.lifeday = 0;
		}
	}
	if (GetCharacterIndex("Tichingitu") != -1) // fix 25-03-20
	{
	if (!CheckAttribute(pchar, "questTemp.LongHappy.Tichingitu_Rum"))
	{
		chrDisableReloadToLocation = true;
		sld = characterFromId("Tichingitu");
		sld.dialog.currentnode = "Tichingitu_5";
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
	}
	sld = characterFromId("Pirates_shipyarder");
	sld.Dialog.Filename = "Quest\LongHappy.c";
	sld.dialog.currentnode = "Alexus";
}

void LongHappy_IslaTesoroDungeon(string qName) // 
{
	chrDisableReloadToLocation = true;
	sld = characterFromId("Nathaniel");
	sld.dialog.currentnode = "Nathaniel_7";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void LongHappy_SetBandosInDungeon() // 
{
	if(!GetDLCenabled(DLC_APPID_5)) return;
	LAi_group_Delete("EnemyFight");
	for (int i=1; i<=7; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("LH_DungeonPirate_"+i, "citiz_"+(40+i), "man", "man", 35, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, 35, 60, 60, "blade_10", "pistol1", "bullet", 200);
		if (i == 1)
		{
			sld.Dialog.Filename = "Quest\LongHappy.c";
			sld.dialog.currentnode = "DungeonPirate";
		}
		else LAi_CharacterDisableDialog(sld);
		ChangeCharacterAddressGroup(sld, "Bermudes_Dungeon", "reload", "reload2_back");
		LAi_SetActorType(sld);
		LAi_ActorDialog(sld, pchar, "", -1, 0);
	}
}

void LongHappy_BandosInDungeonFight() // 
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], false);//разрешить драться
	sld = characterFromId("Nathaniel");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	if (GetCharacterIndex("Tichingitu") != -1 && !CheckAttribute(pchar, "questTemp.LongHappy.Tichingitu_Rum")) // fix 25-03-20
	{
		sld = characterFromId("Tichingitu");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	for (int i=1; i<=7; i++)
	{
		sld = characterFromId("LH_DungeonPirate_"+i);
		if (i == 7)
		{
			LAi_SetImmortal(sld, true);
			sld.lifeday = 0;
			LAi_SetActorType(sld);
			LAi_ActorRunToLocation(sld, "reload", "reload2_back", "none", "", "", "", 20.0);
		}
		else
		{
			LAi_SetWarriorType(sld);
			LAi_group_MoveCharacter(sld, "EnemyFight");
		}
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "LongHappy_BandosInDungeonAfterFight");
	LAi_SetFightMode(pchar, true);
}

void LongHappy_TavernAlarm(string qName) // 
{
	chrDisableReloadToLocation = true;
	sld = characterFromId("Svenson");
	sld.dialog.currentnode = "Svenson_17";
	ChangeCharacterAddressGroup(sld, "Pirates_tavern", "goto", "goto1");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
	// фикс офицера Гамбита-абордажника и офицера-Бейкера
	if (CheckAttribute(pchar, "questTemp.LongHappy.HambitOfficer") && IsOfficer(characterFromId(pchar.questTemp.LongHappy.HambitOfficer)))
	{
		sld = characterFromId(pchar.questTemp.LongHappy.HambitOfficer);
		ChangeCharacterAddressGroup(sld, "Pirates_tavern", "tables", "stay4");
		LAi_SetOfficerType(sld);
		if (pchar.questTemp.LongHappy.HambitOfficer == "Longway") sld.Dialog.Filename = "Quest\HollandGambit\Longway.c";
		if (pchar.questTemp.LongHappy.HambitOfficer == "Knippel") sld.Dialog.Filename = "Quest\HollandGambit\Knippel.c";
		if (pchar.questTemp.LongHappy.HambitOfficer == "Tonzag") sld.Dialog.Filename = "Quest\HollandGambit\Tonzag.c";
		sld.dialog.currentnode = sld.id+"_officer";
	}
	if (CheckAttribute(pchar, "questTemp.LongHappy.BigMarry") && GetCharacterIndex("Baker") != -1) //&& IsOfficer(characterFromId("Baker"))
	{
		sld = characterFromId("Baker");
		ChangeCharacterAddressGroup(sld, "Pirates_tavern", "tables", "stay6");
		LAi_SetOfficerType(sld);
		sld.Dialog.Filename = "Quest\Saga\Baker.c";
		sld.dialog.currentnode = "Baker_officer";
	}
}

void LongHappy_TavernFight() // 
{
	if(!GetDLCenabled(DLC_APPID_5)) return;
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], false);//разрешить драться
	LAi_group_Delete("EnemyFight");
	// всех на ноги и поставить, Джино спрятать
	sld = characterFromId("Jino");
	LAi_SetStayType(sld);
	ChangeCharacterAddressGroup(sld, "Pirates_tavern_upstairs", "goto", "goto1");
	for(int i=0; i<MAX_LOCATIONS; i++)
	{	
		sld = &characters[i];
		if (sld.location == "Pirates_tavern" && sld.id != "Blaze") 
		{
			LAi_SetWarriorType(sld);
			if (sld.id != "Terrax") ChangeCharacterAddressGroup(sld, "Pirates_tavern", "tables", "stay"+(rand(7+1)));
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
	// пиратусы
	for (i=1; i<=10; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("LH_TavernPirate_"+i, "citiz_"+(40+i), "man", "man", 35, PIRATE, -1, false, "soldier"));
		FantomMakeCoolFighter(sld, 35, 70, 70, "blade_10", "pistol1", "bullet", 150);
		ChangeCharacterAddressGroup(sld, "Pirates_tavern", "reload", "reload1");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "LongHappy_TavernAfterFight");
	LAi_SetFightMode(pchar, true);
}

void LongHappy_TavernReload() // 
{
	LAi_LocationDisableOfficersGen("Pirates_town", false);
	LAi_LocationDisableOfficersGen("Bermudes_Dungeon", false);
	LocatorReloadEnterDisable("Bermudes_Dungeon", "reload2_back", false);
	for(int i=0; i<MAX_LOCATIONS; i++)
	{	
		sld = &characters[i];
		if (sld.location == "Pirates_tavern" && sld.id != "Blaze") 
		{
			ChangeCharacterAddressGroup(sld, "Pirates_town", "rld", "loc1");
			LAi_SetWarriorType(sld);
			LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
		}
	}
	DoQuestReloadToLocation("Pirates_town", "reload", "reload4", "LongHappy_IslaTesoroTownFight");
}

void LongHappy_TownRepose() // 
{
	// Свенсона, Акулу и Тиракса на корабли
	sld = characterFromId("Svenson");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "reload1_back", "none", "", "", "", 10.0);
	sld = characterFromId("Terrax");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocation(sld, "reload", "reload1_back", "none", "", "", "", 10.0);
	if (!CheckAttribute(pchar, "questTemp.Saga.DodsonDie"))
	{
		sld = characterFromId("Dodson");
		LAi_SetActorType(sld);
		LAi_ActorRunToLocation(sld, "reload", "reload1_back", "none", "", "", "", 10.0);
	}
	// если есть Венсан - в магазин
	if (CheckAttribute(pchar, "questTemp.LongHappy.BigMarry") && !CheckAttribute(pchar, "questTemp.Saga.DodsonDie"))
	{
		sld = characterFromId("Vensan");
		sld.dialog.currentnode = "Vensan_6";
		ChangeCharacterAddressGroup(sld, "Pirates_store", "goto", "goto1");
		LAi_SetActorType(sld);
	}
	sld = characterFromId("Pirates_trader");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	// Тичингиту если есть - с нами
	if (!CheckAttribute(pchar, "questTemp.LongHappy.Tichingitu_Rum") && GetCharacterIndex("Tichingitu") != -1)
	{
		sld = characterFromId("Tichingitu");
		if (LAi_GetCharacterHP(sld) > 0)
		{
			LAi_SetActorType(sld);
			LAi_ActorFollowEverywhere(sld, "", -1);
			pchar.questTemp.LongHappy.Tichingitu_Warrior = "true";
		}
	}
	// если есть Бейкер не в абордажниках - убираем
	if (CheckAttribute(pchar, "questTemp.LongHappy.BigMarry") && GetCharacterIndex("Baker") != -1 && !IsOfficer(characterFromId("Baker")))
	{
		sld = characterFromId("Baker");
		LAi_SetOfficerType(sld);
		ChangeCharacterAddressGroup(sld, "none", "", "");
	}
	// в резиденцию
	pchar.quest.longhappy_isla_residence.win_condition.l1 = "location";
	pchar.quest.longhappy_isla_residence.win_condition.l1.location = "Pirates_townhall";
	pchar.quest.longhappy_isla_residence.function = "LongHappy_IslaTesoroResidence";
}

void LongHappy_IslaTesoroResidence(string qName) // 
{
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation("Pirates_townhall")], true);
	for (int i=1; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("LH_killer_"+i, "killer_"+i, "man", "man", 35, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, 35, 70, 70, "blade_19", "pistol4", "bullet", 250);
		ChangeCharacterAddressGroup(sld, "Pirates_townhall", "goto", "goto"+i);
		LAi_SetActorType(sld);
		if (i == 4)
		{
			sld.Dialog.Filename = "Quest\LongHappy.c";
			sld.dialog.currentnode = "killer";
			LAi_ActorDialogDelay(sld, pchar, "", 2.0);
		}
	}
}

void LongHappy_ResidenceFight() // 
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], false);
	sld = characterFromId("Nathaniel");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	if (CheckAttribute(pchar, "questTemp.LongHappy.Tichingitu_Warrior"))
	{
		sld = characterFromId("Tichingitu");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	for (int i=1; i<=4; i++)
	{
		sld = characterFromId("LH_killer_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "LongHappy_ResidenceAfterFight");
	LAi_SetFightMode(pchar, true);
}

void LongHappy_IslaTesoroBedroom(string qName) // 
{
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation("Location_reserve_04")], true);
	bDisableCharacterMenu = true;//лочим F2
	InterfaceStates.Buttons.Save.enable = false;
	// жены
	sld = characterFromId("Danielle");
	RemoveCharacterEquip(sld, BLADE_ITEM_TYPE);
	RemoveCharacterEquip(sld, GUN_ITEM_TYPE);
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "Location_reserve_04", "goto", "goto2");
	LAi_SetActorType(sld);
	LAi_ActorTurnToLocator(sld, "goto", "goto8");
	if (CheckAttribute(pchar, "questTemp.Saga.Helena_officer")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	pchar.questTemp.LongHappy.GBlade = GetCharacterEquipByGroup(sld, BLADE_ITEM_TYPE);
	pchar.questTemp.LongHappy.GGun = GetCharacterEquipByGroup(sld, GUN_ITEM_TYPE);
	RemoveCharacterEquip(sld, BLADE_ITEM_TYPE);
	RemoveCharacterEquip(sld, GUN_ITEM_TYPE);
	ChangeCharacterAddressGroup(sld, "Location_reserve_04", "goto", "goto4");
	LAi_SetActorType(sld);
	LAi_ActorTurnToLocator(sld, "goto", "goto8");
	if (CheckAttribute(pchar, "questTemp.LongHappy.Tichingitu_Victim"))
	{
		sld = characterFromId("Nathaniel");
		LAi_SetActorType(sld);
		ChangeCharacterAddressGroup(sld, "Location_reserve_04", "goto", "goto3");
		LAi_ActorTurnToLocator(sld, "goto", "goto2");
		sld = characterFromId("Tichingitu");
		ChangeCharacterAddressGroup(sld, "none", "", "");
		string sModel = "maskog";
		string sName = "Tichingitu";
		string animation = "man";
	}
	else
	{
		sld = characterFromId("Nathaniel");
		ChangeCharacterAddressGroup(sld, "none", "", "");
		sModel = "Hawk_2";
		sName = "Nathaniel";
		animation = "man_B";
	}
	sld = GetCharacter(NPC_GenerateCharacter("LH_Victim", sModel, "man", animation, 20, PIRATE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 20, 50, 50, "blade_11", "", "bullet", 100);
	sld.name = sName;
	sld.lastname = "";
	sld.DontClearDead = true;
	LAi_SetActorType(sld);
	ChangeCharacterAddressGroup(sld, "Location_reserve_04", "goto", "goto5");
	LAi_ActorTurnToLocator(sld, "goto", "goto2");
	// Ангерран или Дюссак
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.Angerran")) // fix 02-04-20
	{
		sld = characterFromId("Angerran");
		sld.dialog.currentnode = "Shivo";
		LAi_SetImmortal(sld, false);
	}
	else
	{
		sld = GetCharacter(NPC_GenerateCharacter("LH_Dussak", "killer_2", "man", "man", 40, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, 40, 70, 70, "blade_20", "pistol6", "bullet", 350);
		sld.name = "Mauritz";
		sld.lastname = "Dussak";
		sld.dialog.currentnode = "Dussak";
	}
	sld.Dialog.Filename = "Quest\LongHappy.c";
	ChangeCharacterAddressGroup(sld, "Location_reserve_04", "goto", "goto1");
	LAi_SetActorType(sld);
	// ГГ
	LAi_SetActorType(pchar);
	LAi_ActorGoToLocator(pchar, "goto", "goto8", "LongHappy_IslaTesoroBedroom", -1);
}

void LongHappy_BedroomShot() // 
{
	LAi_SetActorType(pchar);
	sld = characterFromId("LH_Victim");
	LAi_SetActorType(sld);
	LAi_ActorRunToLocator(sld, "goto", "goto1", "", -1);
	DoQuestCheckDelay("LongHappy_BedroomShot", 1.0);
}

void LongHappy_BedroomFight() // 
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], false);
	LAi_SetPlayerType(pchar);
	if (CheckAttribute(pchar, "questTemp.LongHappy.Tichingitu_Victim"))
	{
		sld = characterFromId("Nathaniel");
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	}
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.Angerran")) sld = characterFromId("Angerran"); // fix 02-04-20
	else sld = characterFromId("LH_Dussak");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, "EnemyFight");
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "LongHappy_BedroomAfterFight");
	LAi_SetFightMode(pchar, true);
}

void LongHappy_OutOfBedroom() // 
{
	if (CheckAttribute(pchar, "questTemp.Saga.Helena_officer")) sld = characterFromId("Helena");
	else sld = characterFromId("Mary");
	string sTemp = sld.name;
	if (CheckAttribute(pchar, "questTemp.GoldenGirl.Angerran")) AddQuestRecord("LongHappy", "16"); // fix 02-04-20
	else AddQuestRecord("LongHappy", "16_1");
	AddQuestUserData("LongHappy", "sName", sTemp);
	if (CheckAttribute(pchar, "questTemp.LongHappy.Tichingitu_Victim")) sld = characterFromId("Tichingitu");
	else sld = characterFromId("Nathaniel");
	string sName = sld.name;
	AddQuestUserData("LongHappy", "sName1", sName);
	DoQuestReloadToLocation("Pirates_town", "reload", "reload3_back", "LongHappy_FindJinoHurry");
}

void LongHappy_KillersInStore(string qName) // 
{
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation("Pirates_store")], false);
	sld = characterFromId("Vensan");
	LAi_SetImmortal(sld, false);
	LAi_SetCheckMinHP(sld, 10, true, ""); // скрытое бессмертие
	ChangeCharacterAddressGroup(sld, "Pirates_store", "barmen", "stay");
	LAi_SetWarriorType(sld);
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	for (int i=2; i<=4; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("LH_store_killer_"+i, "killer_"+i, "man", "man", 35, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, 35, 70, 70, "blade_19", "pistol4", "bullet", 180);
		ChangeCharacterAddressGroup(sld, "Pirates_store", "goto", "goto"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "LongHappy_StoreAfterFight");
	LAi_SetFightMode(pchar, true);
}

void LongHappy_KillersInTavern(string qName) // 
{
	chrDisableReloadToLocation = true;
	LAi_LocationFightDisable(&Locations[FindLocation("Pirates_tavern")], true);
	for (int i=1; i<=3; i++)
	{
		sld = GetCharacter(NPC_GenerateCharacter("LH_tavern_killer_"+i, "killer_"+i, "man", "man", 35, PIRATE, -1, true, "quest"));
		FantomMakeCoolFighter(sld, 35, 70, 70, "blade_19", "pistol4", "bullet", 180);
		ChangeCharacterAddressGroup(sld, "Pirates_tavern", "goto", "goto"+i);
		LAi_SetActorType(sld);
		if (i == 1)
		{
			sld.Dialog.Filename = "Quest\LongHappy.c";
			sld.dialog.currentnode = "killer_1";
			LAi_ActorDialogDelay(sld, pchar, "", 1.5);
		}
	}
}

void LongHappy_TavernKillerFight() // 
{
	LAi_LocationFightDisable(&Locations[FindLocation(pchar.location)], false);
	for (int i=1; i<=3; i++)
	{
		sld = characterFromId("LH_tavern_killer_"+i);
		LAi_SetWarriorType(sld);
		LAi_group_MoveCharacter(sld, "EnemyFight");
	}
	LAi_group_SetRelation("EnemyFight", LAI_GROUP_PLAYER, LAI_GROUP_ENEMY);
	LAi_group_FightGroups("EnemyFight", LAI_GROUP_PLAYER, true);
	LAi_group_SetCheck("EnemyFight", "LongHappy_TavernKillerAfterFight");
	LAi_SetFightMode(pchar, true);
}

void LongHappy_FindJinoTavern(string qName) // 
{
	chrDisableReloadToLocation = true;
	sld = characterFromId("Jino");
	sld.dialog.currentnode = "Jino_4";
	LAi_SetActorType(sld);
	LAi_ActorDialogDelay(sld, pchar, "", 1.5);
}

void LongHappy_SeaBattle(string qName) // морская боевка
{
	if(!GetDLCenabled(DLC_APPID_5)) return;
	pchar.quest.longhappy_isla_hurry1.over = "yes"; //снять прерывание на таверну fix 26-03-20
	pchar.quest.longhappy_isla_hurry2.over = "yes"; //снять прерывание на магазин
	int iShip, iCannon, iCrew, hcrew;
	string sModel;
	Island_SetReloadEnableGlobal("Bermudes", false);//закрыть остров	
	DeleteAttribute(pchar, "GenQuest.MapClosedNoBattle");
	Group_SetAddress("Barons_SeaGroup", "Bermudes", "reload", "reload_1");
	// наша эскадра - Тиракс, Свенсон и Акула
	sld = characterFromId("LH_Terrax_sea");
	LAi_SetImmortal(sld, false);
	sld = characterFromId("LH_Svenson_sea");
	LAi_SetImmortal(sld, false);
	if (!CheckAttribute(pchar, "questTemp.Saga.DodsonDie"))
	{
		sld = characterFromId("LH_Dodson_sea");
		LAi_SetImmortal(sld, false);
	}
	if (CheckAttribute(pchar, "questTemp.LongHappy.Jino_alive"))
	{
		AddQuestRecord("LongHappy", "19");
		pchar.questTemp.LongHappy.Terrax.Prisoner = "true";
		sld = characterFromId("LH_Terrax_sea");
		LAi_KillCharacter(sld);
		sld = characterFromId("LH_Svenson_sea");
		hcrew = GetMaxCrewQuantity(sld);
		iCrew = sti((0.3+frand(0.1))*hcrew);
		SetCrewQuantityOverMax(sld, iCrew);
		sld.ship.HP = sti(sld.ship.HP)/2;
		if (!CheckAttribute(pchar, "questTemp.Saga.DodsonDie"))
		{
			sld = characterFromId("LH_Dodson_sea");
			hcrew = GetMaxCrewQuantity(sld);
			iCrew = sti((0.3+frand(0.1))*hcrew);
			SetCrewQuantityOverMax(sld, iCrew);
			sld.ship.HP = sti(sld.ship.HP)/2;
		}
	}
	else
	{
		AddQuestRecord("LongHappy", "20");
		sld = characterFromId("LH_Terrax_sea");
		hcrew = GetMaxCrewQuantity(sld);
		iCrew = sti((0.5+frand(0.1))*hcrew);
		SetCrewQuantityOverMax(sld, iCrew);
		sld.ship.HP = sti(sld.ship.HP)-makeint(sti(sld.ship.HP)/4);
		sld = characterFromId("LH_Svenson_sea");
		hcrew = GetMaxCrewQuantity(sld);
		iCrew = sti((0.5+frand(0.1))*hcrew);
		SetCrewQuantityOverMax(sld, iCrew);
		sld.ship.HP = sti(sld.ship.HP)-makeint(sti(sld.ship.HP)/4);
		if (!CheckAttribute(pchar, "questTemp.Saga.DodsonDie"))
		{
			sld = characterFromId("LH_Dodson_sea");
			hcrew = GetMaxCrewQuantity(sld);
			iCrew = sti((0.5+frand(0.1))*hcrew);
			SetCrewQuantityOverMax(sld, iCrew);
			sld.ship.HP = sti(sld.ship.HP)-makeint(sti(sld.ship.HP)/4);
		}
	}
	// эскадра ГГ fix 26-03-20 убрано
	// эскадра Барбазона. 4 корабля.
	sld = characterFromId("Barbazon");
	ChangeCharacterAddressGroup(sld, "none", "", "");
	Group_FindOrCreateGroup("LH_BarbazonSeaGroup");
	for (int i=1; i<=4; i++)
	{
		switch (i)
		{
			case 1:
				iShip = SHIP_LINESHIP;
				iCannon = CANNON_TYPE_CANNON_LBS32;
				sModel = "Barbazon";
			break;
			
			case 2:
				iShip = SHIP_FRIGATE_H;
				iCannon = CANNON_TYPE_CANNON_LBS24;
				sModel = "mercen_27";
			break;
			
			case 3:
				iShip = SHIP_FRIGATE;
				iCannon = CANNON_TYPE_CANNON_LBS24;
				sModel = "mercen_20";
			break;
			
			case 4:
				iShip = SHIP_CORVETTE;
				iCannon = CANNON_TYPE_CULVERINE_LBS18;
				sModel = "mercen_19";
			break;
		}
		sld = GetCharacter(NPC_GenerateCharacter("LH_BarbSeaCap_"+i, sModel, "man", "man", 50-i*5, PIRATE, -1, true, "quest"));
		FantomMakeCoolSailor(sld, iShip, "", iCannon, 80-i*5, 80-i*5, 80-i*5);
		FantomMakeCoolFighter(sld, 50-i*5, 80-i*5, 80-i*5, LinkRandPhrase("blade_18","blade_19","blade_21"), "pistol5", "bullet", 400-i*25);
		DeleteAttribute(sld, "SaveItemsForDead");
		DeleteAttribute(sld, "DontClearDead");
		sld.DontRansackCaptain = true;
		sld.AnalizeShips = true;
		sld.AlwaysEnemy = true;
		sld.AlwaysSandbankManeuver = true;
		sld.Ship.Mode = "war";
		sld.ship.Crew.Morale = 70+MOD_SKILL_ENEMY_RATE*3;
		sld.Ship.Crew.Exp.Sailors = 70+MOD_SKILL_ENEMY_RATE*3;
		sld.Ship.Crew.Exp.Cannoners = 70+MOD_SKILL_ENEMY_RATE*3;
		sld.Ship.Crew.Exp.Soldiers = 70+MOD_SKILL_ENEMY_RATE*3;
		if (MOD_SKILL_ENEMY_RATE > 2) SetCharacterPerk(sld, "MusketsShoot");
		if (i == 1) 
		{
			sld.name = "Jacques";
			sld.lastname = "Barbazon";
			sld.ship.name = "Black Dragon";
			sld.MultiFighter = 1.0+MOD_SKILL_ENEMY_RATE/10; // мультифайтер
			GiveItem2Character(sld, "shamshir");
			EquipCharacterbyItem(sld, "shamshir"); // fix 25-03-20
			GiveItem2Character(sld, "howdah");
			EquipCharacterbyItem(sld, "howdah");
			LAi_SetCharacterUseBullet(sld, "grapeshot");
			TakeNItems(sld, "grapeshot", 5);
			AddItems(sld, "gunpowder", 5);
			RealShips[sti(sld.Ship.Type)].ship.upgrades.hull = 3;
			SetSailsColor(sld, 8);//черный парус
			UpgradeShipParameter(sld, "SpeedRate");//апгрейдить скорость
			UpgradeShipParameter(sld, "TurnRate");//маневренность
			UpgradeShipParameter(sld, "WindAgainstSpeed");//бейд
			hcrew = GetMaxCrewQuantity(sld);
			iCrew = sti(0.9*hcrew);
			SetCrewQuantityOverMax(sld, iCrew);
			sld.ship.HP = sti(sld.ship.HP)-makeint(sti(sld.ship.HP)/10);
			sld.SaveItemsForDead = true;
			sld.DontClearDead = true;
			AddItems(sld, "potion2", 3);
			AddItems(sld, "totem_04", 1);
			AddItems(sld, "totem_11", 1);
		}
		else
		{
			hcrew = GetMaxCrewQuantity(sld);
			iCrew = sti((0.7+frand(0.2))*hcrew);
			SetCrewQuantityOverMax(sld, iCrew);
			sld.ship.HP = sti(sld.ship.HP)-makeint(sti(sld.ship.HP)/(5+rand(5)));
			if (CheckAttribute(pchar, "questTemp.HWIC.Detector"))
			{
				if (pchar.questTemp.HWIC.Detector == "eng_win" && GetCharacterIndex("Knippel") != -1) 
				{
					if (i == 2)
					{
						hcrew = GetMaxCrewQuantity(sld);
						iCrew = sti(0.5*hcrew);
						SetCrewQuantityOverMax(sld, iCrew);
						sld.ship.HP = sti(sld.ship.HP)/2;
					}
				}
			}
		}
		Group_AddCharacter("LH_BarbazonSeaGroup", "LH_BarbSeaCap_"+i);
	}
	Group_SetGroupCommander("LH_BarbazonSeaGroup", "LH_BarbSeaCap_1");
	Group_SetAddress("LH_BarbazonSeaGroup", "Bermudes", "reload", "reload_1");
	Group_SetTaskAttack("LH_BarbazonSeaGroup", "Barons_SeaGroup");
	Group_LockTask("LH_BarbazonSeaGroup");
	
	Group_SetTaskAttack("Barons_SeaGroup", "LH_BarbazonSeaGroup");
	Group_LockTask("Barons_SeaGroup");
	// на Барбазона
	pchar.quest.longhappy_destroy_barbazon.win_condition.l1 = "Group_Death";
	pchar.quest.longhappy_destroy_barbazon.win_condition.l1.group = "LH_BarbazonSeaGroup";
	pchar.quest.longhappy_destroy_barbazon.function = "LongHappy_AfterSeaBattle";
	// на Свенсона и Акулу
	pchar.quest.longhappy_destroy_svensonship.win_condition.l1 = "NPC_Death";
	pchar.quest.longhappy_destroy_svensonship.win_condition.l1.character = "LH_Svenson_sea";
	pchar.quest.longhappy_destroy_svensonship.function = "LongHappy_SvensonsShipSink";
	if (!CheckAttribute(pchar, "questTemp.Saga.DodsonDie"))
	{
		pchar.quest.longhappy_destroy_sharkship.win_condition.l1 = "NPC_Death";
		pchar.quest.longhappy_destroy_sharkship.win_condition.l1.character = "LH_Dodson_sea";
		pchar.quest.longhappy_destroy_sharkship.function = "LongHappy_SharksShipSink";
	}
	if (!CheckAttribute(pchar, "questTemp.LongHappy.Terrax.Prisoner"))
	{
		pchar.quest.longhappy_destroy_terraxship.win_condition.l1 = "NPC_Death";
		pchar.quest.longhappy_destroy_terraxship.win_condition.l1.character = "LH_Terrax_sea";
		pchar.quest.longhappy_destroy_terraxship.function = "LongHappy_TerraxShipSink";
	}
	DoQuestFunctionDelay("LongHappy_BaronsShipsCommand", 3.0);
}

void LongHappy_SvensonsShipSink(string qName) // 
{
	log_info("Jan Svensson escaped on a boat!");
	pchar.questTemp.LongHappy.SvensonsShipSink = "true";
}

void LongHappy_SharksShipSink(string qName) // 
{
	log_info("Steven Dodson escaped on a boat!");
	pchar.questTemp.LongHappy.SharksShipSink = "true";
}

void LongHappy_TerraxShipSink(string qName) // 
{
	log_info("Marcus Tyrax escaped on a boat!");
	pchar.questTemp.LongHappy.TerraxShipSink = "true";
}

void LongHappy_BaronsShipsCommand(string qName) // 
{
	ref chr = CharacterFromID("LH_BarbSeaCap_2");
	sld = CharacterFromID("LH_Svenson_sea");
	SetCharacterRemovable(sld, false);
	sld.CompanionEnemyEnable = false; //всегда друзья
	SetCompanionIndex(pchar, -1, sti(sld.index));
	sld.loyality = MAX_LOYALITY;
	Ship_SetTaskAttack(SECONDARY_TASK, sti(sld.index), sti(chr.index));
	if (!CheckAttribute(pchar, "questTemp.Saga.DodsonDie"))
	{
		sld = CharacterFromID("LH_Dodson_sea");
		SetCharacterRemovable(sld, false);
		sld.CompanionEnemyEnable = false; //всегда друзья
		SetCompanionIndex(pchar, -1, sti(sld.index));
		sld.loyality = MAX_LOYALITY;
		Ship_SetTaskAttack(SECONDARY_TASK, sti(sld.index), sti(chr.index));
	}
	if (!CheckAttribute(pchar, "questTemp.LongHappy.Terrax.Prisoner"))
	{
		sld = CharacterFromID("LH_Terrax_sea");
		SetCharacterRemovable(sld, false);
		sld.CompanionEnemyEnable = false; //всегда друзья
		SetCompanionIndex(pchar, -1, sti(sld.index));
		sld.loyality = MAX_LOYALITY;
		Ship_SetTaskAttack(SECONDARY_TASK, sti(sld.index), sti(chr.index));
	}
}

void LongHappy_AfterSeaBattle(string qName) // 
{
	pchar.quest.longhappy_destroy_svensonship.over = "yes"; 
	pchar.quest.longhappy_destroy_sharkship.over = "yes";
	pchar.quest.longhappy_destroy_terraxship.over = "yes";
	RemoveCharacterCompanion(pchar, characterFromID("LH_Svenson_sea"));
	if (!CheckAttribute(pchar, "questTemp.Saga.DodsonDie")) RemoveCharacterCompanion(pchar, characterFromID("LH_Dodson_sea"));
	if (!CheckAttribute(pchar, "questTemp.LongHappy.Terrax.Prisoner")) RemoveCharacterCompanion(pchar, characterFromID("LH_Terrax_sea"));
	pchar.GenQuest.MapClosedNoBattle = true;
	Island_SetReloadEnableGlobal("Bermudes", true);
	pchar.quest.longhappy_victoria.win_condition.l1 = "Ship_location";
	pchar.quest.longhappy_victoria.win_condition.l1.location = "Pirates_town";
	pchar.quest.longhappy_victoria.function = "LongHappy_Victory";
}

void LongHappy_Victory(string qName) // 
{
	// fix 26-03-20 убрать блокировку локации
	pchar.GenQuest.Hunter2Pause = true;
	Group_DeleteGroup("LH_BarbazonSeaGroup");
	if (CheckAttribute(pchar, "questTemp.LongHappy.Tichingitu_Victim"))
	{
		sld = characterFromId("Nathaniel");
		RemovePassenger(pchar, sld);
	}
	// стереть Джино и Венсана, если не нашли
	if (CheckAttribute(pchar, "questTemp.Saga.DodsonDie") || CheckAttribute(pchar, "questTemp.LongHappy.BigMarry"))
	{
		if (!CheckAttribute(pchar, "questTemp.LongHappy.Vensan_alive")) 
		{
			sld = characterFromId("Vensan");
			sld.lifeday = 0;
			ChangeCharacterAddressGroup(sld, "none", "", "");
		}
	}
	if (!CheckAttribute(pchar, "questTemp.LongHappy.Jino_alive"))
	{
		sld = characterFromId("Jino");
		sld.lifeday = 0; // fix 26-03-20
		ChangeCharacterAddressGroup(sld, "none", "", "");
	}
	sld = characterFromId("Svenson");
	sld.dialog.currentnode = "Svenson_22";
	ChangeCharacterAddressGroup(sld, "Pirates_town", "quest", "quest1"); // определить локатор
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void LongHappy_LogBook()
{
	AddQuestRecord("LongHappy", "21");
	if (CheckAttribute(pchar, "questTemp.Saga.DodsonDie") || CheckAttribute(pchar, "questTemp.LongHappy.BigMarry"))
	{
		if (!CheckAttribute(pchar, "questTemp.LongHappy.Vensan_alive")) AddQuestUserData("LongHappy", "sText1", "Bernard Vensan, an old comrade and associate of Marcus Tyrax, is dead, fell while clearing the town of the remnants of mercenaries rushing through the catacombs. He did not live to victory just a few hours...");
	}
	if (CheckAttribute(pchar, "questTemp.LongHappy.Terrax.Lost")) AddQuestUserData("LongHappy", "sText2", "And that's not all - Marcus Tyrax himself went missing when his ship was boarded. Jan Swanson organized the search, and I hope that the old baron was too tough for the gun balls and waves of the sea - this will be an irreparable loss for the entire Brethren of the Coast.");
	if (CheckAttribute(pchar, "questTemp.LongHappy.Jino_died") && !CheckAttribute(pchar, "questTemp.LongHappy.Tichingitu_died")) AddQuestUserData("LongHappy", "sText3", "The losses did not pass me by either. It is always difficult when a war takes away peaceful lives. Gino Gvineili - a good friend and a brilliant scientist accidentally fell victim to this treacherous attack. I will return to Antigua to bury him as it should.");
	if (CheckAttribute(pchar, "questTemp.LongHappy.Tichingitu_died") && CheckAttribute(pchar, "questTemp.LongHappy.Jino_died")) AddQuestUserData("LongHappy", "sText4", "The grave losses did not pass me by either. Tichingitu, my loyal comrade and officer, covered my wife and Dannielle Hawk from a bullet shot. The killer got what he deserved, but by what cost? And it’s like not enough. Gino Gvineili - a good friend and a brilliant scientist accidentally fell victim to this treacherous attack. I will return to Antigua to bury them as it should.");
	if (CheckAttribute(pchar, "questTemp.LongHappy.Tichingitu_Rum")) AddQuestUserData("LongHappy", "sText5", "But there is also a glimmer of hope - Tichingitu, my comrade in arms, was lost somewhere at the very beginning of the battle. I didn’t even expect to see him alive, but Jan said that he was seen with the niece of the local bartender, leaving to the side of the Sabo-Matila Cove bay before the attack. I was ready to think anything - but a drunken escape with a young lady? Is that Tichingitu?! In any case, it is necessary to find them as soon as possible, until the enraged uncle picked up a heavy club.");
}

void LongHappy_IslaTesoroClear()
{
	bDisableFastReload = false;//открыть переход 29-03-20
	// открыть локаторы всех помещений и нормализовать их
	int n = Findlocation("Pirates_town");
	LocatorReloadEnterDisable("Pirates_town", "reload3_back", false);
	LocatorReloadEnterDisable("Pirates_town", "reload4_back", false);
	LocatorReloadEnterDisable("Pirates_town", "reload5_back", false);
	locations[n].reload.l5.close_for_night = 1;
	LocatorReloadEnterDisable("Pirates_town", "reload6_back", false);
	locations[n].reload.l6.close_for_night = 1;
	LocatorReloadEnterDisable("Pirates_town", "houseH1", false);
	LocatorReloadEnterDisable("Pirates_town", "houseSp1", false);
	LocatorReloadEnterDisable("Pirates_town", "houseS1", false);
	LocatorReloadEnterDisable("Pirates_town", "houseF1", false);
	LocatorReloadEnterDisable("Pirates_townhall", "reload1_back", false);
	// вернуть всех положенных неписей Исла Тесоро на места
	sld = characterFromId("Pirates_tavernkeeper");
	ChangeCharacterAddressGroup(sld, "Pirates_Tavern", "barmen", "stay");
	sld = characterFromId("Pirates_waitress");
	ChangeCharacterAddressGroup(sld, "Pirates_Tavern", "waitress", "barmen");
	sld = characterFromId("Pirates_trader");
	ChangeCharacterAddressGroup(sld, "Pirates_Store", "barmen", "stay");
	sld = characterFromId("Pirates_shipyarder");
	sld.Dialog.Filename = "Common_Shipyard.c";
	sld.dialog.currentnode = "First time";
	ChangeCharacterAddressGroup(sld, "Pirates_Shipyard", "goto", "goto3");
	sld = characterFromId("Norman");
	ChangeCharacterAddressGroup(sld, "Pirates_town", "goto", "goto1");
	// вернуть всех гостей по домам, кроме Свенсона
	Group_DeleteGroup("Barons_SeaGroup");
	// Тиракс
	if (!CheckAttribute(pchar, "questTemp.LongHappy.Terrax.Lost"))
	{
		sld = characterFromId("Terrax");
		sld.Dialog.Filename = "Mayor\Terrax.c";
		sld.dialog.currentnode = "I_know_you_good";
		if (!CheckAttribute(pchar, "questTemp.Saga.DodsonDie")) ChangeCharacterAddressGroup(sld, "LaVega_townhall", "sit", "sit1");
		else ChangeCharacterAddressGroup(sld, "Pirates_townhall", "sit", "sit1");
		LAi_SetHuberType(sld);
		LAi_group_MoveCharacter(sld, "PIRATE_CITIZENS");
	}
	// Натаниэль и Даниэль
	sld = characterFromId("Nathaniel");
	sld.Dialog.Filename = "Quest\Saga\Nathaniel.c";
	sld.dialog.currentnode = "marun_town_4";
	ChangeCharacterAddressGroup(sld, "FortOrange_townhall", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "PIRATE_CITIZENS");
	sld = characterFromId("Danielle");
	sld.Dialog.Filename = "Quest\Saga\Danielle.c"; // fix 25-03-20
	sld.dialog.currentnode = "marun_town_3";
	ChangeCharacterAddressGroup(sld, "FortOrange_townhall", "goto", "goto1");
	LAi_SetStayType(sld);
	LAi_group_MoveCharacter(sld, "PIRATE_CITIZENS");
	// Додсон
	if (!CheckAttribute(pchar, "questTemp.Saga.DodsonDie"))
	{
		sld = characterFromId("Dodson");
		sld.Dialog.Filename = "Quest\LSC\Dodson.c";
		sld.dialog.currentnode = "First time";
		ChangeCharacterAddressGroup(sld, "Pirates_townhall", "sit", "sit1");
		LAi_SetHuberType(sld);
		LAi_group_MoveCharacter(sld, "PIRATE_CITIZENS");
	}
	// Джино
	if (!CheckAttribute(pchar, "questTemp.LongHappy.Jino_died"))
	{
		sld = characterFromId("Jino");
		sld.Dialog.Filename = "Quest\HollandGambit\Jino.c";
		sld.dialog.currentnode = "First time";
		ChangeCharacterAddressGroup(sld, "SentJons_HouseF3_Room", "goto", "goto1");
		LAi_SetCitizenType(sld);
		LAi_group_MoveCharacter(sld, "ENGLAND_CITIZENS");
	}
	// Венсан
	if (CheckAttribute(pchar, "questTemp.Saga.DodsonDie") && CheckAttribute(pchar, "questTemp.LongHappy.Vensan_alive"))
	{
		sld = characterFromId("Vensan");
		sld.dialog.FileName = "Mayor\LaVega_Mayor.c";
		sld.dialog.currentnode = "I_know_you_good";
		sld.greeting = "town_pirate";
		ChangeCharacterAddressGroup(sld, "LaVega_townhall", "sit", "sit1");
		LAi_SetHuberType(sld);
		LAi_group_MoveCharacter(sld, "PIRATE_CITIZENS");
		LAi_SetImmortal(sld, true);
	}
	// снять скрытое бессмертие
	if (GetCharacterIndex("Tichingitu") != -1)
	{
		sld = characterFromId("Tichingitu");
		LAi_RemoveCheckMinHP(sld);
		LAi_SetImmortal(sld, false);
	}
	if (GetCharacterIndex("Baker") != -1)
	{
		sld = characterFromId("Baker");
		LAi_RemoveCheckMinHP(sld);
		LAi_SetImmortal(sld, false);
	}
	// мадам де Мор belamour
	if (CheckAttribute(pchar, "questTemp.LSC.Mary_officer"))
	{
		pchar.quest.Mary_giveme_sex.win_condition.l1 = "Timer";
		pchar.quest.Mary_giveme_sex.win_condition.l1.date.hour  = sti(GetTime());
		pchar.quest.Mary_giveme_sex.win_condition.l1.date.day   = GetAddingDataDay(0, 0, 14);
		pchar.quest.Mary_giveme_sex.win_condition.l1.date.month = GetAddingDataMonth(0, 0, 14);
		pchar.quest.Mary_giveme_sex.win_condition.l1.date.year  = GetAddingDataYear(0, 0, 14);
		pchar.quest.Mary_giveme_sex.function = "Mary_GiveMeSex";
		sld = characterFromId("Mary");
	}
	else sld = characterFromId("Helena");
	LAi_RemoveCheckMinHP(sld);
	LAi_SetImmortal(sld, false);
	sld.CompanionDisable = false; //Desperado: можно назначать Элен компаньоном
	DeleteAttribute(pchar, "questTemp.LongHappy.InTavern");
	SetFunctionTimerCondition("LongHappy_SetLefransuaBoss", 0, 0, 30, false); // новый босс Ле Франсуа
}

void LongHappy_SetShoreGirl(string qName) // 
{
	chrDisableReloadToLocation = true;
	pchar.GenQuest.Hunter2Pause = true;
	sld = characterFromId("Tichingitu");
	sld.dialog.currentnode = "Tichingitu_10";
	ChangeCharacterAddressGroup(sld, "Shore_ship1", "goto", "goto6");
	LAi_SetActorType(sld);
	LAi_ActorFollow(sld, pchar, "", 10.0);
	ref chr = characterFromId("Pirates_waitress");
	sld = GetCharacter(NPC_GenerateCharacter("LH_waitress", "women_7", "woman", "woman", 5, PIRATE, -1, true, "quest"));
	sld.name = chr.name;
	sld.lastname = chr.lastname;
	sld.Dialog.Filename = "Quest\LongHappy.c";
	sld.dialog.currentnode = "waitress";
	LAi_SetImmortal(sld, true);
	ChangeCharacterAddressGroup(sld, "Shore_ship1", "goto", "goto4");
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void LongHappy_ReturnShoreGirl(string qName) // 
{
	chrDisableReloadToLocation = true;
	pchar.GenQuest.Hunter2Pause = true;
	sld = characterFromId("LH_waitress");
	sld.dialog.currentnode = "waitress_1";
	LAi_SetActorType(sld);
	LAi_ActorDialog(sld, pchar, "", -1, 0);
}

void LongHappy_SetTichingituDelay() // 
{
	sld = characterFromId("Tichingitu");
	AddPassenger(pchar, sld, false);
	SetCharacterRemovable(sld, false);
	SetFunctionTimerCondition("LongHappy_SetTichingituOfficer", 0, 0, 5, false);
}

void LongHappy_SetTichingituOfficer(string qName) // 
{
	log_info("Tichingitu has recovered and ready to begin his duties as an officer");
	sld = characterFromId("Tichingitu");
	SetCharacterRemovable(sld, true);
	LAi_SetImmortal(sld, false);
	sld.Dialog.Filename = "Quest\Sharlie\Tichingitu.c";
	sld.OfficerWantToGo.DontGo = true;
	sld.CompanionDisable = true;
	sld.loyality = MAX_LOYALITY;
	LAi_SetOfficerType(sld);
	sld.Payment = true;
	sld.DontClearDead = true;
	sld.dialog.currentnode = "Tichingitu_officer";
	LAi_group_MoveCharacter(sld, LAI_GROUP_PLAYER);
	SaveCurrentNpcQuestDateParam(sld, "HiredDate");
}

void LongHappy_SetLefransuaBoss(string qName) // 
{
	sld = GetCharacter(NPC_GenerateCharacter("JanDavid", "mercen_20", "man", "man", 30, PIRATE, -1, true, "quest"));
	FantomMakeCoolFighter(sld, 40, 70, 70, "blade_21", "pistol4", "bullet", 250);
	sld.name = "Jean";
	sld.lastname = "David";
	sld.Dialog.Filename = "Quest\LongHappy.c";
	sld.dialog.currentnode = "JanDavid";
	ChangeCharacterAddressGroup(sld, "LeFransua_townhall", "sit", "sit1");
	LAi_SetHuberType(sld);
	LAi_group_MoveCharacter(sld, "PIRATE_CITIZENS");
	LAi_SetImmortal(sld, true);
}

void LongHappy_GiveBaronPart() // 
{
	int iMoney;
	iMoney = drand(50000)+50000;
	pchar.questTemp.LongHappy.BaronMoney = sti(pchar.questTemp.LongHappy.BaronMoney)+iMoney;
}
